#INCLUDE "MATXFIS.CH"
#INCLUDE "PROTHEUS.CH"                                        
#INCLUDE "MATXDEF.CH"
//**********************************************************************************************************************
//SEMPRE QUE REALIZAR MANUTENCAO NAS REFERENCIAS DE IMPOSTOS DA MATXFIS ATUALIZAR A FUNCAO MATXFIS_V COM A DATA ATUAL
//**********************************************************************************************************************
/*/                            
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±³Programa  ³ MATXFIS  ³ Autor ³ Edson Maricate/Eduardo³ Data ³08/12/1999³±±                             
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Programa de Calculo de Impostos Fiscais e Financeiros   	  ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/

STATIC aMaster
STATIC aNFCab
STATIC aNFItem
STATIC aItemDec
STATIC aBrwLF
STATIC aStack
STATIC aRefSX3
STATIC aSaveDec
STATIC aAuxOri
STATIC cAliasPROD  := "SB1"    
STATIC aInfNat 	   := Array(18)
STATIC aTES[MAX_TS]
STATIC aItemRef
STATIC aCabRef
STATIC aResRef
STATIC aLFIS
STATIC aExistPE    // Array contendo retorno de ExistBlock dos PE chamados
STATIC aParSX6     // Array contendo conteudo dos parametros usados   
STATIC aAliIndic   // Array contendo AliasIndic das tabelas  
STATIC aFieldPos   // Array contendo FieldPos dos campos 
STATIC aUltPesq                                                        //ALEMES - FUNCAO DE IR
STATIC bFisRefresh
STATIC bLivroRefresh
STATIC cCpoSBZ     := U_CpyFieldSB(,.T.)                                //ALEMES - So utilizada na MaSBCampo
STATIC lLimInss    := .F.                                             //ALEMES - BASICAMENTE PRA SER USADA MAFISDEL
STATIC lNotRemito  := .T.                                             //ALEMES - Localizado por enquanto nao
STATIC cSX6FilAnt  := cFilAnt                                         //Inicia variavel com filial corrente
STATIC lLoadCache  := Iif((aExistPE==NIL).Or.(aParSX6==NIL).Or.(aFieldPos==NIL).Or.(aAliIndic==NIL),MaLoadCache(),.F.)
STATIC lRastItem   := .T.
STATIC lHistorico  := .F.
STATiC cAlsCab     := ""
STATiC cAlsItem    := ""
STATIC cMunForISS  := ""
STATIC cFornCE1    := ""
STATIC cLojaCE1    := ""
STATIC cRecIssCE1  := "1"

STATIC NMAXUF	   	:= 9
STATIC NMAXUFP		:= 9

/*
±±ºPrograma  ³MATXFIS_V ºAutor  ³Rodrigo Aguilar     º Data ³  21/11/11	  º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Funcao que retorna a data da ultima manutencao nas         º±±
±±º          ³ referencias de imposto do MATXFIS                          º±±
±±º          ³ O retorno desta funcao eh utilizado na execucao do UPDFIS  º±±
±±º          ³ SEMPRE atualizar com a data de inclusao da referencia      º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³                                                            º±±
*/
Static Function MATXFIS_V()
Return CtoD("10/07/13") 

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³MaLoadCache³ Autor ³ Alemes/Demetrio Rios ³ Data ³20/09/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Alimenta as variaveis STATIC para cachear as chamadas de   ³±±
±±³          ³ funcoes de uso generico para evitar processamento recursivo³±±
±±³          ³                                                            ³±± 
±±³          ³ aParSX6  - Todos os parametros Utilizados na MATXFIS       ³±± 
±±³          ³ aExistPe - Todos os Pontos de Entradas Utilizados n MATXFIS³±± 
±±³          ³ aFieldPos- Todos os FiledPos a serem executados na MATXFIS ³±±
±±³          ³ aAliIndic- Todos os AliasinDic executados na MATXFIS       ³±± 
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function MaLoadCache()

aExistPE	:= GPEMxFis()  // Pontos de entrada      
aParSX6 	:= GParMxFis() // Parametros
aAliIndic 	:= GAiMxFis()  // AliasIndic 
aFieldPos 	:= GFPMxFis()  // FieldPos         
 
Return Nil 

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ GPEMxFIS  ³ Autor ³Demetrio F.de Los Rios³ Data ³20/09/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna os Pontos de Entrada Existes                       ³±±
±±³          ³ Esta funcao foi criada apenas para NAO chamar a funcao     ³±± 
±±³          ³ ExistBlock() a todo momento. Chamando ao entrar no MATXFIS ³±± 
±±³          ³ Os PEs sao testados apartir do retorno da funcao que       ³±± 
±±³          ³ alimenta a STATIC aExistPE                                 ³±± 
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function GPEMxFis()   

Local aValidPE  := {}      
Local nX     	:= 0     
Local aPE  := { "M520SF3",;		//	 01 
				"M520SFT",;		//	 02 
				"MAAFRMM",;		//	 03 
				"MaCalcCOF",;	//	 04 
				"MaCalcCSL",;	//	 05 
				"MACALCICMS",;	//	 06 
				"MaCalcPIS",;	//	 07 
				"MaCofDif",;	//	 08 
				"MaCOFVeic",;	//	 09 
				"MaCstPiCo",;	//	 10 
				"MAFISBIR",;	//	 11
				"MAFISOBS",;	//	 12 
				"MAFISRASTRO",;	//	 13 
				"MAFISRUR",;	//	 14 
				"MaICMVeic",;	//	 15 
				"MaPISDif",;	//	 16 
				"MaPISVeic",;	//	 17 
				"MARATEIO",;	//	 18 
				"MAVLDIMP",;	//	 19 
				"MFISIMP",;		//	 20 
				"MTA920L",;		//	 21 
				"MXTOTIT",;		//	 22 
				"PAUTICMS",;	//	 23 
				"TM200ISS",;	//	 24 
				"VISUIMP",;		//	 25 
				"VLCODRET",;	//	 26 
				"XFCD2SFT",;	//	 27 
				"XFISLF",;		//	 28
				"MACALIRRF"}    //	 29	  				      

/************************************************************************************************************
  IMPORTANTE: TODA VEZ QUE CRIADO NOVO PONTO DE ENTRADA MATXFIS, DEVERA SER CRIADA A REFERENCIA NA MATXDEF
  E ADD DO PONTO DE ENTRADA NO ARRAY aParam DESTA FUNCAO OBRIGATORIAMENTE NA MESMA POSICAO(NUMERO) DO XDEF.CH
*************************************************************************************************************/                        
For nX :=1 To Len(aPE)
	aAdd(aValidPE,ExistBlock(aPE[nX]) )
Next nX

Return aValidPE           

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ GParMxFIs ³ Autor ³Demetrio F.de Los Rios³ Data ³20/09/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna os Parametros SX6 Utilizados na MATXFIS            ³±±
±±³          ³ Esta funcao foi criada apenas para NAO chamar as funcoes   ³±±
±±³          ³ GetNewPar() e SuperGetMV a todo momento.                   ³±± 
±±³          ³ A Lista dos parametros utilizados sera armazenada na STATIC³±± 
±±³          ³ aParSX6 com seu conteudo e conteudo DEFAULT qdo nao existir³±± 
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function GParMxFis()
                  
Local nX		:= 0    
Local lCritArr	:= (cPaisLoc == "BRA")
Local aAllSX6	:= {}
Local aParam 	:= {	{"MV_1DUPNAT",	""	   		} ,;	//   01
						{"MV_2DUPNAT",	"" 	   		} ,; 	//	 02
						{"MV_ACMIRPF",	"1" 		} ,;  	//	 03
						{"MV_ACMIRPJ",	"1" 		} ,;  	// 	 04 
						{"MV_ADIFECP",	"" 	   		} ,; 	//   05 
						{"MV_AGENTE",	"   " 		} ,; 	//	 06 
						{"MV_ALFECMG",	"" 			} ,; 	//	 07 
						{"MV_ALINSB1",	"" 			} ,; 	//   08
						{"MV_ALIQFRE","AC07AL07AM07AP07BA07CE07DF07ES07GO07MA07MG12MS07MT07PA07PB07PE07PI07PR12RJ12RN07RO07RR07RS12SC12SE07SP12TO07" } ,; 	//   09
						{"MV_ALIQIRF",	0 			} ,; 	//   10
						{"MV_ALIQISS",	0			} ,; 	//   11
						{"MV_ALQDFB1",	"" 			} ,; 	//   12
						{"MV_ALQIPM",	0 			} ,; 	//   13
						{"MV_ALRN944",	.F.			} ,; 	//   14
						{"MV_ARQPROD",	"SB1"		} ,; 	//   15
						{"MV_ARQPROP",	.F.			} ,; 	//   16
						{"MV_ASRN944",	0			} ,; 	//   17
						{"MV_AUTOISS",	'{"","","",""}'} ,;	//   18
						{"MV_B1CALTR", 	"" 			} ,; 	//   19
						{"MV_B1CPSST", 	"" 			} ,; 	//   20
						{"MV_BASERET", 	"" 			} ,; 	//   21
						{"MV_BICMCMP",	.T.			} ,; 	//   22
						{"MV_BX10925",	"2" 		} ,; 	//   23
						{"MV_CALCVEI",	.F.			} ,; 	//   24
						{"MV_CODREG", 	"" 			} ,; 	//   25
						{"MV_COFBRU",	"2" 		} ,; 	//   26
						{"MV_COFPAUT",	.T.			} ,; 	//   27
						{"MV_CONTSOC",	"" 			} ,; 	//   28
						{"MV_CONVCFO",	"1" 		} ,; 	//   29
						{"MV_CPCATRI",	.F. 		} ,; 	//   30
						{"MV_CRDBCOF",	"N" 		} ,;	//   31
						{"MV_CRDBPIS",	"N" 		} ,;	//   32
						{"MV_CROUTSP", 	"" 			} ,;	//   33
						{"MV_CRPRERJ",	.F. 		} ,;	//   34
						{"MV_CSLLBRU",	"2" 		} ,;	//   35
						{"MV_CTRAUTO",	.F.	   		} ,;	//   36
						{"MV_CTRLFOL",	.F.	   		} ,;	//   37
						{"MV_DBRDIF",	.T.	  		} ,;	//   38
						{"MV_DBSTCFR",	"1" 		} ,;	//   39
						{"MV_DBSTCOF",  "1" 		} ,;	//   40
						{"MV_DBSTPIS", 	"1" 		} ,;	//   41
						{"MV_DBSTPSR", 	"1" 		} ,;	//   42
						{"MV_DECALIQ",	.F.			} ,;	//   43
						{"MV_DEDBCOF",	"" 			} ,;	//   44
						{"MV_DEDBPIS",	"" 			} ,;	//   45
						{"MV_DEISSBS",	.F.			} ,;	//   46
						{"MV_DESCISS",	.F. 		} ,;	//   47
						{"MV_DESCSAI",	"" 			} ,;	//   48
						{"MV_DESCZF",	.T. 		} ,;	//   49
						{"MV_DESPICM ",	.T.			} ,;	//   50
						{"MV_DESPSD1", 	"N" 		} ,;	//   51
						{"MV_DESZFPC",	.F.			} ,;	//   52
						{"MV_DEVRET",	.F.			} ,;	//   53
						{"MV_DEVTOT", 	.T. 		} ,;	//   54
						{"MV_DPAGREG",	.F.			} ,;	//   55
						{"MV_DSZFSOL",	.F. 		} ,;	//   56
						{"MV_EASY", 	""			} ,;	//   57
						{"MV_ESTADO", 	"" 			} ,;	//   58
						{"MV_ESTICM", 	"" 			} ,;	//   59
						{"MV_FECPMT", 	"" 			} ,;	//   60
						{"MV_FRETAUT",	.T.			} ,;	//   61
						{"MV_FRETEST", 	"" 			} ,;	//   62
						{"MV_FRTBASE",	.F. 		} ,;	//   63
						{"MV_GERIMPV",	"" 			} ,;	//   64
						{"MV_ICMPAD",	0			} ,;	//   65
						{"MV_ICMPAUT",	.T.			} ,;	//   66
						{"MV_ICMPFAT", 	"" 			} ,;	//   67
						{"MV_ICPAUTA", 	"1" 		} ,;	//   68
						{"MV_IMPCSS", 	"S" 		} ,;	//   69
						{"MV_INDUPF", 	"" 			} ,;	//   70
						{"MV_INITES",	.F.			} ,;	//   71
						{"MV_INSIRF",	"2" 		} ,;	//   72
						{"MV_INSSDES", 	"" 			} ,;	//   73
						{"MV_IPIBRUT", 	"" 	  		} ,;	//   74
						{"MV_IPINOBS", 	"" 			} ,;	//   75
						{"MV_IPIPFAT ", "" 			} ,;	//   76
						{"MV_IPIZFM",	.T. 		} ,;	//   77
						{"MV_IRMP232",	"2" 		} ,;	//   78
						{"MV_IRSEMNT",	.F. 		} ,;	//   79
						{"MV_ISSPRG", 	"N" 		} ,;	//   80
						{"MV_LFAGREG",	.F.			} ,;	//   81
						{"MV_LIMINSS",	0			} ,;	//   82
						{"MV_LJLVFIS",	1			} ,;	//   83
						{"MV_MINDETR",	0 			} ,;	//   84
						{"MV_MKPICPT",	"1" 		} ,;	//   85
						{"MV_NORTE", 	"" 			} ,;	//   86
						{"MV_PCFATPC",	.F. 		} ,;	//   87
						{"MV_PERCATM",	0			} ,;	//   88
						{"MV_PEREINT",	0 			} ,;	//   89
						{"MV_PERFECP",	0			} ,;	//   90
						{"MV_PISBRU", 	"2" 		} ,;	//   91
						{"MV_PISPAUT",	.T. 		} ,;	//   92
						{"MV_PRCDEC",	.F.			} ,;	//   93
						{"MV_PRODLEI", 	"" 			} ,;	//   94
						{"MV_PUPCCST", 	"" 			} ,;	//   95
						{"MV_RASTRO", 	"N" 		} ,;	//   96
						{"MV_RATDESP",	"" 			} ,;	//   97
						{"MV_RCSTIPI", 	"" 			} ,;	//   98
						{"MV_REBICM", 	.F. 		} ,;	//   99
						{"MV_REGESIM", 	.F. 		} ,;	//  100
						{"MV_RNDANG",	.F. 		} ,;	//  101
						{"MV_RNDCF2",	.F.			} ,;	//  102
						{"MV_RNDCF3",	.F. 		} ,;	//  103
						{"MV_RNDCOF", 	.F. 		} ,;	//  104
						{"MV_RNDCSL", 	.F. 		} ,;	//  105
						{"MV_RNDDES",	lCritArr 	} ,;	//  106
						{"MV_RNDFUN", 	.F. 		} ,;	//  107
						{"MV_RNDICM", 	.F. 		} ,;	//  108
						{"MV_RNDINS", 	.F. 		} ,;	//  109
						{"MV_RNDIPI", 	.F. 		} ,;	//  110
						{"MV_RNDIRF", 	.F. 		} ,;	//  111
						{"MV_RNDISS", 	.F. 		} ,;	//  112
						{"MV_RNDPIS", 	.F. 		} ,;	//  113
						{"MV_RNDPREC", 	10 			} ,;	//  114
						{"MV_RNDPS2", 	lCritArr 	} ,;	//  115
						{"MV_RNDPS3",	.F.			} ,;	//  116
						{"MV_RNDRNE",	.T.			} ,;	//  117
						{"MV_RNDSOBR",	.T.			} ,;	//  118
						{"MV_RSATIVO",	.F.			} ,;	//  119
						{"MV_SIMPLSC",	.T.			} ,;	//  120
						{"MV_SM0CONT",	 "1" 		} ,;	//  121
						{"MV_SOLBRUT",	.F.			} ,;	//  122
						{"MV_SOMAICM",	.F.			} ,;	//  123
						{"MV_SOMAIPI",	.F.			} ,;	//  124
						{"MV_STFRETE",	.F. 		} ,;	//  125
						{"MV_STPTPER", 	"" 			} ,;	//  126
						{"MV_STREDU",	.F.			} ,;	//  127
						{"MV_TESIB",	.F.			} ,;	//  128
						{"MV_TESVEND", 	"" 			} ,;	//  129
						{"MV_TIPOB", 	"RS/SP/" 	} ,;	//  130 
						{"MV_TMSUFPG",	.F. 		} ,;	//  131
						{"MV_TMSVDEP", 	0 			} ,;	//  132
						{"MV_TPABISS",	"1"			} ,;	//  133
						{"MV_TPALCOF",	"2"			} ,;	//  134
						{"MV_TPALCSL",	"2"			} ,;	//  135
						{"MV_TPALPIS",	"2"			} ,;	//  136
						{"MV_TPNFISS",	""			} ,;	//  137
						{"MV_TPSOLCF",	""			} ,;	//  138
						{"MV_TXAFRMM",	0			} ,;	//  139
						{"MV_TXCOFIN",	0			} ,;	//  140
						{"MV_TXCSLL",	0			} ,;	//  141
						{"MV_TXPIS", 	0			} ,;	//  142
						{"MV_UFERMS",	""	  		} ,;	//  143
						{"MV_UFPST21",	""			} ,;	//  144
						{"MV_USACFPS",	.F.			} ,;	//  145
						{"MV_VALDESP",	.F.			} ,;	//  146
						{"MV_VALICM", 	.F.			} ,;	//  147
						{"MV_VISDIRF",	"1"			} ,;	//  148
						{"MV_XFCOMP",	.T. 		} ,;	//  149
                        {"MV_B1CATRI",	"" 			} ,;	//  150
                        {"MV_AERN944",	0 			} ,;  	//  151
                        {"MV_B1CCFST",	"" 			} ,;	// 	152      
                        {"MV_DESCDVI",	.T.			} ,;	// 	153      
                        {"MV_ALITPDP",	0 			} ,;	//  154 
                        {"MV_B1PTST", 	"" 			} ,;	//  155
                        {"MV_PRDDIAT",	""			} ,;	//  156
                        {"MV_ISSXMUN", .F.          } ,;   //  157 
                        {"MV_APURPIS", .F.          } ,;  	// 	158
                        {"MV_APURCOF", .F.          } ,;  	// 	159 
                        {"MV_UFPAUTA", ""           } ,; 	// 	160 
                        {"MV_ALALIME",  0           } ,;   //	161
                        {"MV_DIFALIQ",  0           } ,;   	// 	162
                        {"MV_VRETISS",  0           } ,;   	// 	163
                        {"MV_VEICICM", .F.          } ,;  	// 	164
                        {"MV_UFIRCE",  '{"",""}'    } ,;  	// 	165  
                        {"MV_ALTCFIS", "00" 		} ,;	// 	166
                        {"MV_DC5602",  "" 			} ,;	// 	167
                        {"MV_FISAUCF", .F.			} ,;	//	168
                        {"MV_DSPREIN", .F.			} ,; 	//  169
                        {"MV_PISCOFP", .F.			} ,; 	//  170
                        {"MV_FISXMVA", .F.			} ,;	//  171
						{"MV_C13906" , ""			} ,;	//  172
					    {"MV_139GNUF", ""			} ,;	//  173
					    {"MV_RNDSEST", .F.			} ,;		//  174
						{"MV_RPCBIZF", .F.			} }
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³IMPORTANTE: TODA VEZ QUE CRIADO NOVO PARAMETRO PARA MATXFIS, DEVERA SER CRIADA A REFERENCIA NA MATXDEF³
//³  E ADD O PARAMETRO NO ARRAY aParam DESTA FUNCAO OBRIGATORIAMENTE NA MESMA POSICAO(NUMERO) DO XDEF.CH ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
For nX:=1 to Len(aParam)
	aAdd(aAllSX6 , GetNewPar((aParam[nX,1]),aParam[nX,2])  )
Next nX
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Ao utilizar o Protheus com varias Filiais e possivel que em alguns processos como o de inclusao de Notas Fiscais o usuario altere  ³
//³ a filial atraves da Dialog de seleçao de filiais, com isso se faz necessario que os parametros SX6 sejam novamente carregados para ³
//³ a filial corrente refazendo o cache realizado na variavel aParSX6, esta nova carga e controlada pela variavel cSX6FilAnt           ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
cSX6FilAnt := cFilAnt  

Return aAllSX6        

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ GAIMxFIS  ³ Autor ³Demetrio F.de Los Rios³ Data ³20/09/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna os ALIAS existentes no dicionario SX3              ³±±
±±³          ³ Esta funcao foi criada apenas para NAO chamar a funcao     ³±± 
±±³          ³ ALIASINDIC() a todo momento. Chamando ao entrar no MATXFIS ³±± 
±±³          ³ Os Alias sao verificados atraves do retorno da funcao que  ³±± 
±±³          ³ alimenta a STATIC aAliIndic                                ³±± 
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function GAIMxFis()      

Local nX := 0
Local xRet  := {}         
Local aAI_  := {	"CC6",;      // 01
					"CC7",;      // 02
					"CD2",;      // 03
					"CD3",;      // 04
					"CD4",;      // 05
					"CD5",;      // 06
					"CD6",;      // 07
					"CD7",;      // 08
					"CD8",;      // 09
					"CD9",;      // 10
					"CDA",;      // 11
					"CDC",;      // 12
					"CDD",;      // 13
					"CDE",;      // 14
					"CDF",;      // 15
					"CDG",;      // 16
					"CDO",;      // 17
					"CE0",;      // 18
					"MDL",;      // 19
					"SFT",;      // 20
					"SFU",;      // 21
					"SFX",;      // 22
					"CE1",;		 // 23
					"CC2",;		 // 24
					"CFC",;		 // 25
					"SS9"}		 // 26					

/******************************************************************************************************
  IMPORTANTE: TODA VEZ QUE CHAMAR O ALIASINDIC() DE UMA NOVA TABELA, DEVERA SER CRIADA A REFERENCIA NA 
  MATXDEF E ADD O ALIAS NO ARRAY aAI_ DESTA FUNCAO OBRIGATORIAMENTE NA MESMA POSICAO(NUMERO) DO XDEF.CH
*******************************************************************************************************/ 
For nX:=1 to Len(aAI_)
	aAdd(xRet, AliasIndic(aAI_[nX]) )
Next nX

Return xRet 

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³ GAIMxFIS  ³ Autor ³Demetrio F.de Los Rios³ Data ³20/09/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna se os campos existem no dicionario SX3             ³±±
±±³          ³ Esta funcao foi criada apenas para NAO chamar a funcao     ³±± 
±±³          ³ FIELDPOS() a todo momento. Chamando ao entrar no MATXFIS   ³±± 
±±³          ³ Os Campos sao verificados atraves do retorno da funcao que ³±± 
±±³          ³ alimenta a STATIC aFieldPos                                ³±± 
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function GFPMxFis(nFPIdent)  

Local nX     := 0    
Local nPos   := 0
Local aAlias := {}
Local aRet 	 := {}
Local aFPCpo := {	{"SA1","A1_CALCIRF"},;   // 	 01   
					{"SA1","A1_CONTRIB"},;   //      02
					{"SA1","A1_PERCATM"},;   //      03  
					{"SA1","A1_PERFECP"},;   //      04
					{"SA1","A1_REGESIM"},;   //      05
					{"SA1","A1_SIMPLES"},;   //      06
					{"SA1","A1_TPESSOA"},;   //      07
					{"SA2","A2_CALCIRF"},;   //      08
					{"SA2","A2_INCLTMG"},;   //      09
					{"SA2","A2_IRPROG"},;    //      10
					{"SA2","A2_NUMDEP"},;    //      11
					{"SA2","A2_RECSEST"},;   //      12
					{"SA2","A2_REGESIM"},;   //      13
					{"SA2","A2_SIMPNAC"},;   //      14 
					{"SA2","A2_TPESSOA"},;   //      15
					{"SB1","B1_ALFECOP"},;   //      16
					{"SB1","B1_ALFECST"},;   //      17
					{"SB1","B1_ALFUMAC"},;   //      18
					{"SB1","B1_CHASSI"},;    //      19
					{"SB1","B1_CNATREC"},;   //      20
					{"SB1","B1_CRDPRES"},;   //      21
					{"SB1","B1_DTFIMNT"},;   //      22
					{"SB1","B1_FECOP"},;     //      23
					{"SB1","B1_FECPBA"},;    //      24
					{"SB1","B1_GRPNATR"},;   //      25
					{"SB1","B1_IMPORT"},;    //      26
					{"SB1","B1_PRN944I"},;   //      27
					{"SB1","B1_REGESIM"},;   //      28
					{"SB1","B1_REGRISS"},;   //      29
					{"SB1","B1_TNATREC"},;   //      30
					{"SB1","B1_VMINDET"},;   //      31
					{"SC6","C6_CNATREC"},;   //      32
					{"SC6","C6_DTFIMNT"},;   //      33
					{"SC6","C6_GRPNATR"},;   //      34
					{"SC6","C6_TNATREC"},;   //      35
					{"CC7","CC7_CLANAP"},;   //      36
					{"CC7","CC7_IFCOMP"},;   //      37
					{"CC7","CC7_TPREG"},;    //      38
					{"CD2","CD2_DESCZF"},;   //      39
					{"CD2","CD2_FORMU"},;    //      40
					{"CDA","CDA_IFCOMP"},;   //      41
					{"CDA","CDA_TPLANC"},;   //      42
					{"CDO","CDO_CODREF"},;   //      43
					{"CE0","CE0_NFALIQ"},;   //      44
					{"CE0","CE0_NFALVA"},;   //      45
					{"CE0","CE0_NFBASE"},;   //      46
					{"CE0","CE0_NFVALO"},;   //      47
					{"SD1","D1_ALIQSOL"},;   //      48
					{"SD1","D1_BASEFUN"},;   //      49
					{"SD1","D1_ICMSDIF"},;   //      50
					{"SD1","D1_ITEM"},;      //      51
					{"SD1","D1_MARGEM"},;    //      52
					{"SD1","D1_SLDDEP"},;    //      53
					{"SD2","D2_ALIQSOL"},;   //      54
					{"SD2","D2_BASEFUN"},;   //      55 
					{"SD2","D2_ICMSDIF"},;   //      56
					{"SD2","D2_MARGEM"},;    //      57
					{"DUY","DUY_ALQISS"},;   //      58
					{"SE2","E2_BASEIRF"},;   //      59
					{"SE2","E2_FORNISS"},;   //      60
					{"SE2","E2_LOJAISS"},;   //      61
					{"SE2","E2_PRETCOF"},;   //      62
					{"SE2","E2_PRETCSL"},;   //      63
					{"SE2","E2_PRETIRF"},;   //      64
					{"SE2","E2_PRETPIS"},;   //      65
					{"SE2","E2_SEQBX"},;     //      66
					{"SE2","E2_VENCISS"},;   //      67
					{"SE2","E2_VRETCOF"},;   //      68
					{"SE2","E2_VRETCSL"},;   //      69
					{"SE2","E2_VRETIRF"},;   //      70
					{"SE2","E2_VRETPIS"},;   //      71
					{"SE5","E5_BASEIRF"},;   //      72
					{"SE5","E5_PRETCOF"},;   //      73
					{"SE5","E5_PRETCSL"},;   //      74
					{"SE5","E5_PRETIRF"},;   //      75
					{"SE5","E5_PRETPIS"},;   //      76
					{"SE5","E5_VRETCOF"},;   //      77
					{"SE5","E5_VRETCSL"},;   //      78
					{"SE5","E5_VRETIRF"},;   //      79
					{"SE5","E5_VRETPIS"},;   //      80
					{"SED","ED_BASESES"},;   //      81
					{"SED","ED_PERCSES"},;   //      82
					{"SF1","F1_CAE"},;       //      83
					{"SF1","F1_CHVNFE"},;    //      84
					{"SF1","F1_CODNFE"},;    //      85
					{"SF1","F1_CREDNFE"},;   //      86
					{"SF1","F1_DESNTRB"},;   //      87
					{"SF1","F1_EMINFE"},;    //      88
					{"SF1","F1_HORNFE"},;    //      89
					{"SF1","F1_NFELETR"},;   //      90
					{"SF1","F1_NUMRPS"},;    //      91
					{"SF1","F1_TARA"},;   	 //      92
					{"SF1","F1_TPVENT"},;    //      93
					{"SF1","F1_VCTOCAE"},;   //      94
					{"SF2","F2_CAE"},;       //      95
					{"SF2","F2_CHVNFE"},;    //      96
					{"SF2","F2_CODNFE"},;    //      97
					{"SF2","F2_CREDNFE"},;   //      98
					{"SF2","F2_DESNTRB"},;   //      99
					{"SF2","F2_DTDIGIT"},;   //     100
					{"SF2","F2_EMINFE"},;    //     101
					{"SF2","F2_HORNFE"},;    //     102
					{"SF2","F2_NFAGREG"},;   //     103
					{"SF2","F2_NFELETR"},;   //     104
					{"SF2","F2_RECISS"},;    //     105
					{"SF2","F2_TARA"},;   //        106
					{"SF2","F2_TPVENT"},;   //      107
					{"SF2","F2_VCTOCAE"},;   //     108
					{"SF2","F2_VLR_FRT"},;   //     109
					{"SF3","F3_BSREIN"},;   //      110
					{"SF3","F3_CAE"},;   //         111
					{"SF3","F3_CODNFE"},;   //      112
					{"SF3","F3_CRDEST"},;   //      113
					{"SF3","F3_CREDNFE"},;   //     114
					{"SF3","F3_CREDPRE"},;   //     115
					{"SF3","F3_CRPREPE"},;   //     116
					{"SF3","F3_DESCZFR"},;   //     117
					{"SF3","F3_DS43080"},;   //     118
					{"SF3","F3_ECF"},;   //         119
					{"SF3","F3_EMINFE"},;   //      120
					{"SF3","F3_HORNFE"},;   //      121
					{"SF3","F3_MDCAT79"},;   //     122
					{"SF3","F3_NFAGREG"},;   //     123
					{"SF3","F3_NFELETR"},;   //    124
					{"SF3","F3_NUMRPS"},;   //     125
					{"SF3","F3_SIMPLES"},;   //     126
					{"SF3","F3_TPVENT"},;   //     127
					{"SF3","F3_VCTOCAE"},;   //     128
					{"SF3","F3_VFECPMG"},;   //     129
					{"SF3","F3_VFECPMT"},;   //     130
					{"SF3","F3_VFECPRN"},;   //     131
					{"SF3","F3_VFESTMG"},;   //     132
					{"SF3","F3_VFESTMT"},;   //     133
					{"SF3","F3_VFESTRN"},;   //     134
					{"SF3","F3_VL43080"},;   //     135
					{"SF3","F3_VLINCMG"},;   //     136
					{"SF3","F3_VREINT"},;   //      137
					{"SF4","F4_AFRMM"},;   //       138
					{"SF4","F4_AGRCOF"},;   //      139
					{"SF4","F4_AGRDRED"},;   //     140
					{"SF4","F4_AGREGCP"},;   //     141
					{"SF4","F4_AGRPIS"},;   //      142
					{"SF4","F4_AGRRETC"},;   //     143
					{"SF4","F4_ALSENAR"},;   //     144
					{"SF4","F4_ANTICMS"},;   //     145
					{"SF4","F4_APLIIVA"},;   //     146
					{"SF4","F4_APLIRED"},;   //     147
					{"SF4","F4_APLREDP"},;   //     148
					{"SF4","F4_APSCFST"},;   //     149
					{"SF4","F4_ATACVAR"},;   //     150
					{"SF4","F4_BASECOF"},;   //     151
					{"SF4","F4_BASEISS"},;   //     152
					{"SF4","F4_BASEPIS"},;   //     153
					{"SF4","F4_BCPCST"},;   //      154
					{"SF4","F4_BSICMST"},;   //     155
					{"SF4","F4_BSRDICM"},;   //    156
					{"SF4","F4_BSRURAL"},;   //     157
					{"SF4","F4_CALCFET"},;   //     158
					{"SF4","F4_CFABOV"},;   //      159
					{"SF4","F4_CFACS"},;   //       160
					{"SF4","F4_CFPS"},;   //        161
					{"SF4","F4_CLFDSUL"},;   //     162
					{"SF4","F4_CNATREC"},;   //     163
					{"SF4","F4_CODBCC"},;   //      164
					{"SF4","F4_COFBRUT"},;   //     165
					{"SF4","F4_COFDSZF"},;   //     166
					{"SF4","F4_COMPRED"},;   //     167
					{"SF4","F4_CONSIND"},;   //     168
					{"SF4","F4_CONTSOC"},;   //     169
					{"SF4","F4_CPPRODE"},;   //     170
					{"SF4","F4_CPRECTR"},;   //     171
					{"SF4","F4_CPRESPR"},;   //     172
					{"SF4","F4_CRDEST"},;   //      173
					{"SF4","F4_CRDPRES"},;   //     174
					{"SF4","F4_CRDTRAN"},;   //     175
					{"SF4","F4_CREDACU"},;   //     176
					{"SF4","F4_CREDPRE"},;   //     177
					{"SF4","F4_CREDST"},;   //      178
					{"SF4","F4_CROUTGO"},;   //     179
					{"SF4","F4_CROUTSP"},;   //     180
					{"SF4","F4_CRPRELE"},;   //     181
					{"SF4","F4_CRPREPE"},;   //     182
					{"SF4","F4_CRPREPR"},;   //     183
					{"SF4","F4_CRPRERO"},;   //     184
					{"SF4","F4_CRPRESP"},;   //     185
					{"SF4","F4_CRPRSIM"},;   //     186
					{"SF4","F4_CRPRST"},;   //      187
					{"SF4","F4_CSTCOF"},;   //      188
					{"SF4","F4_CSTISS"},;   //      189
					{"SF4","F4_CSTPIS"},;   //      190
					{"SF4","F4_CTIPI"},;   //       191
					{"SF4","F4_DBSTCSL"},;   //     192
					{"SF4","F4_DBSTIRR"},;   //     193
					{"SF4","F4_DESCOND"},;   //     194
					{"SF4","F4_DESPCOF"},;   //     195
					{"SF4","F4_DESPPIS"},;   //     196
					{"SF4","F4_DSPRDIC"},;   //     197
					{"SF4","F4_DTFIMNT"},;   //     198
					{"SF4","F4_DUPLIST"},;   //     199
					{"SF4","F4_ESTCRED"},;   //     200
					{"SF4","F4_GRPNATR"},;   //     201
					{"SF4","F4_ICMSST"},;   //      202
					{"SF4","F4_ICMSTMT"},;   //     203
					{"SF4","F4_INCSOL"},;   //      204
					{"SF4","F4_INDNTFR"},;   //     205
					{"SF4","F4_INTBSIC"},;   //     206
					{"SF4","F4_IPIANT"},;   //      207
					{"SF4","F4_IPIOBS"},;   //      208
					{"SF4","F4_IPIPC"},;   //       209
					{"SF4","F4_ISEFECP"},;   //     210
					{"SF4","F4_ISEFEMG"},;   //     211
					{"SF4","F4_ISEFEMT"},;   //     212
					{"SF4","F4_ISEFERN"},;   //     213
					{"SF4","F4_ISSST"},;   //       214
					{"SF4","F4_LFICMST"},;   //     215
					{"SF4","F4_LFISS"},;   //       216
					{"SF4","F4_MALQCOF"},;   //     217
					{"SF4","F4_MKPSOL"},;   //      218
					{"SF4","F4_MOTICMS"},;   //     219
					{"SF4","F4_NORESP"},;   //      220
					{"SF4","F4_OBSICM"},;   //      221
					{"SF4","F4_OBSSOL"},;   //      222
					{"SF4","F4_OPERSUC"},;   //     223
					{"SF4","F4_PAUTICM"},;   //     224
					{"SF4","F4_PICMDIF"},;   //     225
					{"SF4","F4_PISBRUT"},;   //     226
					{"SF4","F4_PISCOF"},;   //      227
					{"SF4","F4_PISCRED"},;   //     228
					{"SF4","F4_PISDSZF"},;   //     229
					{"SF4","F4_PR35701"},;   //     230
					{"SF4","F4_PSCFST"},;   //      231
					{"SF4","F4_REDANT"},;   //      232
					{"SF4","F4_REDBCCE"},;   //     233
					{"SF4","F4_RGESPST"},;   //     234
					{"SF4","F4_SITTRIB"},;   //     235
					{"SF4","F4_SOMAIPI"},;   //     236
					{"SF4","F4_STCONF"},;   //      237
					{"SF4","F4_TNATREC"},;   //     238
					{"SF4","F4_TPPRODE"},;   //     239
					{"SF4","F4_TRFICM"},;   //      240
					{"SF4","F4_VARATAC"},;   //     241
					{"SF4","F4_VDASOFT"},;   //     242
					{"SF4","F4_VENPRES"},;   //     243
					{"SF7","F7_BSICMST"},;   //     244
					{"SF7","F7_CNATREC"},;   //     245
					{"SF7","F7_DTFIMNT"},;   //     246
					{"SF7","F7_GRUPONC"},;   //     247
					{"SF7","F7_PRCUNIC"},;   //     248
					{"SF7","F7_TNATREC"},;   //     249
					{"SF7","F7_UFBUSCA"},;   //     250
					{"SFB","FB_DESGR"},;   //       251
					{"SFC","FC_PROV"},;   //        252
					{"SFP","FP_QTDITEM"},;   //     253
					{"SFP","FP_TIPOFOR"},;   //    254
					{"SFQ","FQ_SEQDES"},;   //      255
					{"SFT","FT_AGREG"},;   //       256
					{"SFT","FT_ALFECMG"},;   //     257
					{"SFT","FT_ALFECMT"},;   //     258
					{"SFT","FT_ALFECRN"},;   //    259
					{"SFT","FT_ALIQSOL"},;   //     260
					{"SFT","FT_ALIQTST"},;   //     261
					{"SFT","FT_ALQFAB"},;   //      262
					{"SFT","FT_ALQFAC"},;   //      263
					{"SFT","FT_ALQFECP"},;   //     264
					{"SFT","FT_ALQFET"},;   //      265
					{"SFT","FT_ALQFUM"},;   //      266
					{"SFT","FT_ALSENAR"},;   //     267
					{"SFT","FT_ANTICMS"},;   //     268
					{"SFT","FT_BASETST"},;   //     269
					{"SFT","FT_BSEFAB"},;   //      270
					{"SFT","FT_BSEFAC"},;   //      271
					{"SFT","FT_BSEFET"},;   //      272
					{"SFT","FT_BSREIN"},;   //      273
					{"SFT","FT_BSSENAR"},;   //     274
					{"SFT","FT_CHVNFE"},;   //      275
					{"SFT","FT_CODBCC"},;   //      276
					{"SFT","FT_CODIF"},;   //       277
					{"SFT","FT_CODNFE"},;   //      278
					{"SFT","FT_COECFST"},;   //     279
					{"SFT","FT_COEPSST"},;   //     280
					{"SFT","FT_CPPRODE"},;   //     281
					{"SFT","FT_CPRESPR"},;   //     282
					{"SFT","FT_CRDPRES"},;   //     283
					{"SFT","FT_CREDNFE"},;   //     284
					{"SFT","FT_CREDPRE"},;   //     285
					{"SFT","FT_CROUTGO"},;   //     286
					{"SFT","FT_CROUTSP"},;   //     287
					{"SFT","FT_CRPREPE"},;   //     288
					{"SFT","FT_CRPREPR"},;   //     289
					{"SFT","FT_CRPRERO"},;   //     290
					{"SFT","FT_CRPRESP"},;   //     291
					{"SFT","FT_CRPRRON"},;   //     292
					{"SFT","FT_CRPRSIM"},;   //     293
					{"SFT","FT_CSTCOF"},;   //      294
					{"SFT","FT_CSTISS"},;   //      295
					{"SFT","FT_CSTPIS"},;   //      296
					{"SFT","FT_DESCICM"},;   //     297
					{"SFT","FT_DESCZFR"},;   //     298
					{"SFT","FT_EMINFE"},;   //      299
					{"SFT","FT_HORNFE"},;   //      300
					{"SFT","FT_INDNTFR"},;   //     301
					{"SFT","FT_MALQCOF"},;   //     302
					{"SFT","FT_MARGEM"},;   //      303
					{"SFT","FT_MVALCOF"},;   //     304
					{"SFT","FT_NFELETR"},;   //     305
					{"SFT","FT_NORESP"},;   //      306
					{"SFT","FT_NUMRPS"},;   //      307
					{"SFT","FT_PAUTCOF"},;   //     308
					{"SFT","FT_PAUTIC"},;   //      309
					{"SFT","FT_PAUTIPI"},;   //     310
					{"SFT","FT_PAUTPIS"},;   //     311
					{"SFT","FT_PAUTST"},;   //      312
					{"SFT","FT_PR43080"},;   //     313
					{"SFT","FT_PRCUNIC"},;   //     314
					{"SFT","FT_PRFDSUL"},;   //     315
					{"SFT","FT_PRINCMG"},;   //     316
					{"SFT","FT_RGESPST"},;   //     317
					{"SFT","FT_TPPRODE"},;   //     318
					{"SFT","FT_UFERMS"},;   //      319
					{"SFT","FT_VALANTI"},;   //     320
					{"SFT","FT_VALFAB"},;   //      321
					{"SFT","FT_VALFAC"},;   //      322
					{"SFT","FT_VALFDS"},;   //      323
					{"SFT","FT_VALFECP"},;   //     324
					{"SFT","FT_VALFET"},;   //      325
					{"SFT","FT_VALFUM"},;   //     326
					{"SFT","FT_VALTST"},;   //      327
					{"SFT","FT_VFECPMG"},;   //     328
					{"SFT","FT_VFECPMT"},;   //     329
					{"SFT","FT_VFECPRN"},;   //     330
					{"SFT","FT_VFECPST"},;   //     331
					{"SFT","FT_VFESTMG"},;   //     332
					{"SFT","FT_VFESTMT"},;   //     333
					{"SFT","FT_VFESTRN"},;   //     334
					{"SFT","FT_VLINCMG"},;   //     335
					{"SFT","FT_VLSENAR"},;   //     336
					{"SFT","FT_VREINT"},;   //      337
					{"SN1","N1_ALIQCOF"},;   //     338
					{"SN1","N1_ALIQPIS"},;   //     339
					{"SN1","N1_CODBCC"},;   //      340
					{"SN1","N1_CSTCOFI"},;   //     341
					{"SN1","N1_CSTPIS"},;   //      342
					{"SUS","US_ALIQIR"},;   //      343
					{"SUS","US_CALCSUF"},;   //     344
					{"SUS","US_CONTRIB"},;   //     345
					{"SUS","US_GRPTRIB"},;   //     346
					{"SUS","US_INSCR"},;   //       347
					{"SUS","US_NATUREZ"},;   //     348
					{"SUS","US_RECCOFI"},;   //     349
					{"SUS","US_RECCSLL"},;   //     350
					{"SUS","US_RECINSS"},;   //     351
					{"SUS","US_RECISS"},;   //      352
					{"SUS","US_RECPIS"},;   //      353
					{"SUS","US_SUFRAMA"},;   //     354
					{"SUS","US_TPESSOA"},;   //     355
					{"SWN","WN_ITEMNF"},;   //      356
					{"SWN","WN_TES"},; 		//       357 
					{"SB1","B1_AFABOV"},; 	//       358 
					{"SA2","A2_RFABOV"},; 	//       359 
					{"SA1","A1_RFABOV"},; 	//       360
					{"SB1","B1_AFACS"},; 	//       361
					{"SA2","A2_RFACS"},; 	//       362
					{"SA1","A1_RFACS"},; 	//       363
					{"SB1","B1_AFETHAB"},;	//       364
					{"SA2","A2_RECFET"},;	//       365
					{"SA1","A1_RECFET"},; 	//       366     
					{"SF3","F3_VALTPDP"},;	// 		 367
					{"SF3","F3_TIPANUL"},;	// 		 368
					{"SF3","F3_NCF"	},;		//  	 369
					{"SA1","A1_TPDP"},;		// 		 370
					{"SB1","B1_TPDP"},;		//		 371
					{"SFT","FT_B1DIAT"},;  // 		 372
					{"SB1",aParSX6[MV_ALQDFB1]},; 	//		 373
					{"SB1",aParSX6[MV_B1PTST]},; 	//	     374  
					{"SA1","A1_CRDMA"},;	//	 	375 
					{"SA1","A1_CDRDES"},;	//		376
					{"CC2","CC2_PERMAT"},;	//		377
					{"CC2","CC2_PERSER"},;	//		378
					{"CC2","CC2_MDEDMA"},;	//		379
					{"CC2","CC2_MDEDSR"},; 	//		380    
					{"SB1","B1_ALFECRN"},; 	//		381    
					{"SD2","D2_VALADI"},; 	//		382
					{"SF4","F4_NATOPER"},;	//		383
					{"SBI","BI_COD"},;        //  384        
					{"SBI","BI_GRTRIB"},; //      385        
					{"SBI","BI_CODIF"},; //       386        
					{"SBI","BI_RSATIVO"},; //     387        
					{"SBI","BI_POSIPI"},; //      388        
					{"SBI","BI_UM"},; //          389        
					{"SBI","BI_SEGUM"},; //       390        
					{"SBI","BI_AFABOV"},; //      391        
					{"SBI","BI_AFACS"},; //       392        
					{"SBI","BI_AFETHAB"},; //     393        
					{"SBI","BI_TFETHAB"},; //     394        
					{"SBI","BI_PICM"},; //        395        
					{"SBI","BI_FECOP"},; //       396        
					{"SBI","BI_ALFECOP"},; //     397        
					{"SBI","BI_ALIQISS"},; //     398        
					{"SBI","BI_IMPZFRC"},; //     399        
					{"SBI","BI_INT_ICM"},; //     400        
					{"SBI","BI_PR43080"},; //     401        
					{"SBI","BI_PRINCMG"},; //     402        
					{"SBI","BI_ALFECST"},; //     403        
					{"SBI","BI_PICMENT"},; //     404        
					{"SBI","BI_PICMRET"},; //     405        
					{"SBI","BI_IVAAJU"},; //      406        
					{"SBI","BI_RASTRO"},; //      407        
					{"SBI","BI_VLR_ICM"},; //     408        
					{"SBI","BI_VLR_PIS"},; //     409        
					{"SBI","BI_VLR_COF"},; //     410        
					{"SBI","BI_ORIGEM"},; //      411       
					{"SBI","BI_CRDEST"},; //      412        
					{"SBI","BI_CODISS"},; //      413        
					{"SBI","BI_TNATREC"},; //     414        
					{"SBI","BI_CNATREC"},; //     415        
					{"SBI","BI_GRPNATR"},; //     416        
					{"SBI","BI_DTFIMNT"},; //     417        
					{"SBI","BI_IPI"},; //         418        
					{"SBI","BI_VLR_IPI"},; //     419        
					{"SBI","BI_CNAE"},; //        420        
					{"SBI","BI_REGRISS"},; //     421        
					{"SBI","BI_REDINSS"},; //     422        
					{"SBI","BI_INSS"},; //        423        
					{"SBI","BI_IRRF"},; //        424        
					{"SBI","BI_REDIRRF"},; //     425        
					{"SBI","BI_REDPIS"},; //      426        
					{"SBI","BI_PPIS"},; //        427        
					{"SBI","BI_PIS"},; //         428        
					{"SBI","BI_CHASSI"},; //      429        
					{"SBI","BI_RETOPER"},; //     430        
					{"SBI","BI_REDCOF"},; //      431        
					{"SBI","BI_PCOFINS"},; //     432        
					{"SBI","BI_COFINS"},; //      433        
					{"SBI","BI_PCSLL"},; //       434        
					{"SBI","BI_CONTSOC"},; //     435        
					{"SBI","BI_PRFDSUL"},; //     436        
					{"SBI","BI_FECP"},; //        437        
					{"SBI","BI_FECPBA"},; //      438        
					{"SBI","BI_ALFECRN"},; //     439        
					{"SBI","BI_ALFUMAC"},; //     440        
					{"SBI","BI_PRN944I"},; //     441        
					{"SBI","BI_REGESIM"},; //     442        
					{"SBI","BI_VLRISC"},; //      443        
					{"SBI","BI_CRDPRES"},; //     444        
					{"SBI","BI_VMINDET"},; //     445        
					{"SBI","BI_IMPORT"},; //      446        
					{"SBI","BI_TPDP"},; //        447        
					{"SBI","BI_"+Substr(aParSX6[MV_ALQDFB1],4) },; //     448 
					{"SBI","BI_"+Substr(aParSX6[MV_B1PTST] ,4) },; //     449
					{"SBI","BI_"+Substr(aParSX6[MV_PRDDIAT],4) },; //     450 
					{"SBI","BI_"+Substr(aParSX6[MV_B1CALTR],4) },; //     451 
					{"SBI","BI_"+Substr(aParSX6[MV_B1CATRI],4) },; //     452
					{"SBI","BI_"+Substr(aParSX6[MV_ICMPFAT],4) },; //     453 
					{"SBI","BI_"+Substr(aParSX6[MV_IPIPFAT],4) },; //     454 
					{"SBI","BI_"+Substr(aParSX6[MV_PUPCCST],4) },; //     455 
					{"SBI","BI_"+Substr(aParSX6[MV_B1CPSST],4) },; //     456 
					{"SBI","BI_"+Substr(aParSX6[MV_B1CCFST],4) },; //     457 
					{"SBI","BI_"+Substr(aParSX6[MV_FECPMT] ,4) },; //     458 
					{"SBI","BI_"+Substr(aParSX6[MV_ADIFECP],4) },; //     459 
					{"SBI","BI_"+Substr(aParSX6[MV_ALFECMG],4) },; //     460   
					{"SB1","B1_COD"},; //         461
					{"SB1","B1_GRTRIB"},; //      462
					{"SB1","B1_CODIF"},; //       463
					{"SB1","B1_RSATIVO"},; //     464
					{"SB1","B1_POSIPI"},; //      465
					{"SB1","B1_UM"},; //          466
					{"SB1","B1_SEGUM"},; //       467
					{"SB1","B1_TFETHAB"},; //     468
					{"SB1","B1_PICM"},; //        469
					{"SB1","B1_ALIQISS"},; //     470
					{"SB1","B1_IMPZFRC"},; //     471
					{"SB1","B1_INT_ICM"},; //     472
					{"SB1","B1_PR43080"},; //     473
					{"SB1","B1_PRINCMG"},; //     474
					{"SB1","B1_PICMENT"},; //     475
					{"SB1","B1_PICMRET"},; //     476
					{"SB1","B1_IVAAJU"},; //      477
					{"SB1","B1_RASTRO"},; //      478
					{"SB1","B1_VLR_ICM"},; //     479
					{"SB1","B1_VLR_PIS"},; //     480
					{"SB1","B1_VLR_COF"},; //     481
					{"SB1","B1_ORIGEM"},; //      482
					{"SB1","B1_CRDEST"},; //      483
					{"SB1","B1_CODISS"},; //      484
					{"SB1","B1_IPI"},; //         485
					{"SB1","B1_VLR_IPI"},; //     486
					{"SB1","B1_CNAE"},; //        487
					{"SB1","B1_REDINSS"},; //     488
					{"SB1","B1_INSS"},; //        489
					{"SB1","B1_IRRF"},; //        490
					{"SB1","B1_REDIRRF"},; //     491
					{"SB1","B1_REDPIS"},; //      492
					{"SB1","B1_PPIS"},; //        493
					{"SB1","B1_PIS"},; //         494
					{"SB1","B1_RETOPER"},; //     495
					{"SB1","B1_REDCOF"},; //      496
					{"SB1","B1_PCOFINS"},; //     497
					{"SB1","B1_COFINS"},; //      498
					{"SB1","B1_PCSLL"},; //       499
					{"SB1","B1_CONTSOC"},; //     500
					{"SB1","B1_PRFDSUL"},; //     501
					{"SB1","B1_FECP"},; //        502
					{"SB1","B1_VLRISC"},; //      503
					{"SB1","B1_"+Substr(aParSX6[MV_ALQDFB1],4) },; //     504 
					{"SB1","B1_"+Substr(aParSX6[MV_B1PTST] ,4) },; //     505
					{"SB1","B1_"+Substr(aParSX6[MV_PRDDIAT],4) },; //     506 
					{"SB1","B1_"+Substr(aParSX6[MV_B1CALTR],4) },; //     507 
					{"SB1","B1_"+Substr(aParSX6[MV_B1CATRI],4) },; //     508
					{"SB1","B1_"+Substr(aParSX6[MV_ICMPFAT],4) },; //     509 
					{"SB1","B1_"+Substr(aParSX6[MV_IPIPFAT],4) },; //     510 
					{"SB1","B1_"+Substr(aParSX6[MV_PUPCCST],4) },; //     511 
					{"SB1","B1_"+Substr(aParSX6[MV_B1CPSST],4) },; //     512 
					{"SB1","B1_"+Substr(aParSX6[MV_B1CCFST],4) },; //     513 
					{"SB1","B1_"+Substr(aParSX6[MV_FECPMT] ,4) },; //     514 
					{"SB1","B1_"+Substr(aParSX6[MV_ADIFECP],4) },; //     515 
					{"SB1","B1_"+Substr(aParSX6[MV_ALFECMG],4) },; //     516   
					{"SBZ","BZ_PICM"},; //        517
					{"SBZ","BZ_VLR_ICM"},; //     518
					{"SBZ","BZ_INT_ICM"},; //     519
					{"SBZ","BZ_PICMRET"},; //     520
					{"SBZ","BZ_PICMENT"},; //     521
					{"SBZ","BZ_IPI"},; //         522
					{"SBZ","BZ_VLR_IPI"},; //     523
					{"SBZ","BZ_REDPIS"},; //      524
					{"SBZ","BZ_REDCOF"},; //      525
					{"SBZ","BZ_IRRF"},; //        526
					{"SBZ","BZ_ORIGEM"},; //      527
					{"SBZ","BZ_GRTRIB"},; //      528
					{"SBZ","BZ_CODISS"},; //      529
					{"SBZ","BZ_FECP"},; //        530
					{"SBZ","BZ_ALIQISS"},; //     531
					{"SBZ","BZ_PIS"},; //         532
					{"SBZ","BZ_COFINS"},; //      533
					{"SBZ","BZ_PCSLL"},; //       534
					{"SBZ","BZ_ALFUMAC"},; //     535
					{"SBZ","BZ_FECPBA"},; //      536
					{"SBZ","BZ_ALFECRN"},; //     537
					{"SBZ","BZ_CNAE"},; //        538
					{"SBI","BI_CSLL"},; //        539
					{"SB1","B1_CSLL"},; //        540
					{"SBZ","BZ_CSLL"},; //        541
					{"SF4","F4_TPCPRES"},;//       542
					{"SFT","FT_IDSF4"}  ,;  //    543
					{"SFT","FT_IDSF7"}  ,;  //    544
					{"SFT","FT_IDSA1"}  ,;  //    545
					{"SFT","FT_IDSA2"}  ,;  //    546
					{"SFT","FT_IDSB1"}  ,;  //    547
					{"SFT","FT_IDSB5"}  ,;  //    548
					{"SFT","FT_IDSBZ"}  ,;  //    549
					{"SFT","FT_IDSED"}  ,;  //    550
					{"SFT","FT_IDSFB"}  ,; //     551
					{"SF4","F4_IDHIST"} ,;  //    552  
					{"SF7","F7_IDHIST"} ,;  //    553
					{"SA1","A1_IDHIST"} ,;  //    554
					{"SA2","A2_IDHIST"} ,;  //    555
					{"SB1","B1_IDHIST"} ,;  //    556
					{"SB5","B5_IDHIST"} ,;  //    557					
					{"SBZ","BZ_IDHIST"} ,;  //    558
					{"SED","ED_IDHIST"} ,;  //    559
					{"SFB","FB_IDHIST"} ,;  //    560
					{"SFC","FC_IDHIST"} ,;  //    561
					{"SF1","F1_IDSA1"}  ,;  //    562
					{"SF1","F1_IDSA2"}  ,;  //    563
					{"SF1","F1_IDSED"}  ,;  //    564					
					{"SF2","F2_IDSA1"}  ,;  //    565
					{"SF2","F2_IDSA2"}  ,;  //    566					
					{"SF2","F2_IDSED"}  ,;  //    567
					{"SD1","D1_IDSF4"}  ,;  //    568
					{"SD1","D1_IDSF7"}  ,;  //    569
					{"SD1","D1_IDSB1"}  ,;  //    570
					{"SD1","D1_IDSBZ"}  ,;  //    571
					{"SD1","D1_IDSB5"}  ,;  //    572
					{"SD2","D2_IDSF4"}  ,;  //    573																													
					{"SD2","D2_IDSF7"}  ,;  //    574
					{"SD2","D2_IDSB1"}  ,;  //    575
					{"SD2","D2_IDSBZ"}  ,;  //    576					
					{"SD2","D2_IDSB5"}  ,;  //    577
					{"SFT","FT_DS43080"},;   //    578
					{"SFT","FT_DESCTOT"},;   //    579
					{"SFT","FT_ACRESCI"},;   //    580
					{"SF4","F4_DEVPARC"},;   //    581
					{"SB5","B5_ALIMEN"} ,; 	 //    582
					{"SF4","F4_ALIMEN"} ,;	 //    583
					{"SF4","F4_PERCATM"},; 	 //    584
					{"SF4","F4_DICMFUN"},;   //    585      
					{"SF4","F4_MALQPIS"} ,;  //    586
					{"SD1","D1_VALPMAJ"},;   //    587
					{"SFT","FT_MALQPIS"},;   //    588
					{"SFT","FT_MVALPIS"},;   //    589 
					{"SF4","F4_IMPIND"} ,;   //    590
					{"SF4","F4_OPERGAR"},;   //    591
					{"SF4","F4_FRETISS"},;   //    592
					{"SBI","BI_MEPLES"},;  	 //    593
					{"SB1","B1_MEPLES"},; 	 //    594
					{"SS4","S4_CHASSI"},;	 //    595
					{"SS4","S4_VLRISC"},;	 //	   596
					{"SS4","S4_VMINDET"},;	 //    597
					{"SS4","S4_CODIF"},; 		//    598
					{"CFC","CFC_MGLQST"},;	//599
					{"CFC","CFC_ALQSTL"},;	//600
					{"SF4","F4_STLIQ"},;	//601					
					{"SS9","S9_MGLQST"},;   //602
					{"SS9","S9_ALQSTL"},;	//603
					{"SED","ED_CALCCID"},;	 //604 
					{"SED","ED_PERCCID"},;	 //605    
					{"SED","ED_BASECID"},;	 //606    
					{"SA2","A2_RECCIDE"},;	 //607
					{"SF7","F7_SITTRIB"},;	 //608
					{"SF7","F7_ORIGEM"},;	 //609
					{"SS1","S1_SITTRIB"},;	 //610
					{"SS1","S1_ORIGEM"},;	 //611
					{"CFC","CFC_MARGEM"},;	 //612
					{"SS9","S9_MARGEM"},;	 //613
					{"SA1","A1_FRETISS"},;   //614
					{"SF4","F4_CV139"},;     //615					
					{"SFT","FT_CV139"},;     //616					
					{"SF4","F4_RFETALG"},;   //617
					{"CFC","CFC_ALFCPO"},;	 //618
					{"SS9","S9_ALFCPO"},;	 //619
					{"CFC","CFC_FCPAUX"},;	 //620
					{"SS9","S9_FCPAUX"},;	 //621
					{"CFC","CFC_FCPXDA"},;	 //622
					{"SS9","S9_FCPXDA"},;	 //623
					{"CFC","CFC_FCPINT"},;	 //624
					{"SS9","S9_FCPINT"},;	 //625        
					{"SD1","D1_BASNDES"},;	 //626    
					{"SD1","D1_ICMNDES"},;  //627
					{"CFC","CFC_CODPRD"},;	 //628	
					{"SD2","D2_IDCFC"},;	 //629
					{"SD1","D1_IDCFC"},;	 //630 
					{"SF4","F4_PARTICM"},;	 //631
					{"CD2","D2_PARTICM"},;	 //632
					{"CC7","CC7_CODREF"},;	//633
					{"CFC","CFC_RDCTIM"}}//634  
					   					
                                             
//  IMPORTANTE: TODA VEZ QUE CRIADO NOVO TRATAMENTO DE FIELDPOS(), DEVERA SER CRIADA A REFERENCIA NA MATXDEF
//  E ADD NO ARRAY aFPCpo DESTA FUNCAO OBRIGATORIAMENTE NA MESMA POSICAO(NUMERO) DO XDEF.CH

For nX := 1 to Len(aFPCpo)
	nPos := aScan( aAlias , {|x| x[1] == aFPCpo[nX,01] } ) 
	If nPos == 0   
		aAdd( aAlias , { aFPCpo[nX,01] , AliasIndic(aFPCpo[nX,01]) } )
		nPos := Len(aAlias)
    EndIf
	aAdd(aRet , IIf( aAlias[nPos,02] .And. (aFPCpo[nX,01])->(FieldPos(aFPCpo[nX,02])) > 0 , .T. , .F. ) )
Next nX

Return aRet 

/*__AS PROXIMAS 26 FUNCOES ABAIXO SAO FUNCOES DE CONTROLE QUE INTERAGEM COM TODOS OS MODULOS DO PROTHEUS OU QUALQUER PROGRAMA COM MATXFIS IMPLEMENTADA */

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisFound³ Autor ³ Edson Maricate        ³ Data ³08.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Verifica se o item ja existe na relacao de itens incluidos. ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisFound(cCampo,nItem)

Local lRetorno  := .T.

If aNfItem <> Nil
	If cCampo == "IT"
		If nItem > Len(aNfItem)
			lRetorno := .F.
		EndIf
	Else
		If Empty(aNfCab)
			lRetorno := .F.
		EndIf
	EndIf
Else
	lRetorno := .F.
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Ao utilizar o Protheus com varias Filiais e possivel que em alguns processos como o de inclusao de Notas Fiscais o usuario altere  ³
//³ a filial atraves da Dialog de seleçao de filiais, com isso se faz necessario que os parametros SX6 sejam novamente carregados para ³
//³ a filial corrente refazendo o cache realizado na variavel aParSX6, esta nova carga e controlada pela variavel cSX6FilAnt           ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If cSX6FilAnt <> cFilAnt
	aParSX6 := GParMxFis()	
EndIf 

Return lRetorno

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡…o    ³MaFisSave³ Autor ³ Edson Maricate         ³ Data ³ 10.12.99 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Salva a NF atual em uma area temporaria.                    ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisSave()

If aMaster == Nil
	aMaster := {}
EndIf

aadd(aMaster,{aClone(aNfCab),;
	aClone(aSaveDec),;
	aClone(aNfItem),;
	aClone(aItemDec),;
	bFisRefresh,;
	bLivroRefresh,;
	aClone(aBrwLF),;
	aClone(aStack),;
	aClone(aAuxOri),;
	cAliasProd})

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡…o    ³MaFisRestore³ Autor ³ Edson Maricate      ³ Data ³ 10.12.99 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Carrega a NF salva em uma area temporaia.                   ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisRestore()

Local nUltimo := Len(aMaster)
aNfCab        := aClone(aMaster[nUltimo][01])
aSaveDec      := aClone(aMaster[nUltimo][02])
aNfItem       := aClone(aMaster[nUltimo][03])
aItemDec      := aClone(aMaster[nUltimo][04])
bFisRefresh   := aMaster[nUltimo][05]
bLivroRefresh := aMaster[nUltimo][06]
aBrwLF        := aClone(aMaster[nUltimo][07])
aStack        := aClone(aMaster[nUltimo][08])
aAuxOri       := aClone(aMaster[nUltimo][09])
cAliasProd    := aMaster[nUltimo][10]
aMaster       := aSize(aMaster,nUltimo-1)

If nUltimo == 1
   aMaster := Nil
EndIf

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisClear³ Autor ³ Edson Maricate        ³ Data ³09.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Limpa os itens da NF e zera as variaveis do cabecalho.      ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisClear()

If MaFisFound('NF')
	aNfItem := {}
	aItemDec:= {}
	If aSaveDec<>Nil
		aFill(aSaveDec,0)
	EndIf
	aAuxOri	:= {}
	MaIt2Cab()
EndIf

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³ MaFisEnd ³ Autor ³ Edson Maricate        ³ Data ³10.01.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Finaliza o uso das funcoes Fiscais.                        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpL1: Indica se deve reinicializar o codeblock da funcao  ³±±
±±³          ³        MaFisRodape ( bFisRefresh )                         ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisEnd(lRodape)

DEFAULT lRodape := .T.
aNfCab	:= Nil
aNfItem	:= Nil
aItemDec:= Nil
aSaveDec:= Nil
aAuxOri	:= Nil
aTes    := Array(MAX_TS)
bLivroRefresh := Nil
If lRodape
	bFisRefresh := Nil
EndIf
lNotRemito :=.T.

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisNfCab³ Autor ³Alexandre Lemes        ³ Data ³01/10/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Torna disponivel o array static aNfCab as rotinas externas  ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisNFCab()
Return aClone(aNFCab[NF_IMPOSTOS])

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisIni  ³ Autor ³Eduardo/Edson          ³ Data ³08.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Inicializa o Calculo das operacoes Fiscais                  ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/

Static Function MaFisIni(cCodCliFor,;	// 1-Codigo Cliente/Fornecedor
	cLoja,;			// 02-Loja do Cliente/Fornecedor
	cCliFor,;		// 03-C:Cliente , F:Fornecedor
	cTipoNF,;		// 04-Tipo da NF( "N","D","B","C","P","I" )
	cTpCliFor,;		// 05-Tipo do Cliente/Fornecedor
	aRelImp,;		// 06-Relacao de Impostos que suportados no arquivo
	cTpComp,;		// 07-Tipo de complemento
	lInsere,;		// 08-Permite Incluir Impostos no Rodape .T./.F.
	cAliasP,;		// 09-Alias do Cadastro de Produtos - ("SBI" P/ Front Loja)
	cRotina,;		// 10-Nome da rotina que esta utilizando a funcao
	cTipoDoc,;		// 11-Tipo de documento
	cEspecie,;		// 12-Especie do documento
    cCodProsp,;		// 13-Codigo e Loja do Prospect
    cGrpCliFor,;	// 14-Grupo Cliente
    cRecolheISS,;	// 15-Recolhe ISS
    cCliEnt,;   	// 16-Codigo do cliente de entrega na nota fiscal de saida
    cLojEnt,;   	// 17-Loja do cliente de entrega na nota fiscal de saida
    aTransp,;		// 18-Informacoes do transportador [01]-UF,[02]-TPTRANS
	lEmiteNF,;		// 19-Se esta emitindo nota fiscal ou cupom fiscal (Sigaloja)
	lCalcIPI,;      // 20-Define se calcula IPI (SIGALOJA)
	cPedido,;       // 21-Pedido de Venda
	cCliFat,;	    // 22-Cliente do faturamento ( cCodCliFor é passado como o cliente de entrega, pois é o considerado na maioria das funções fiscais, exceto ao gravar o clinte nas tabelas do livro)
	cLojCFat,;     // 23-Loja do cliente do faturamento
	nTotPed,;		// 24-Total do Pedido
	dDtEmiss,;		// 25-Data de emissão do documento inicialmente só é diferente de dDataBase nas notas de entrada (MATA103 e MATA910)
	cTpFrete)       // 26- Tipo de Frete informado no pedido

Local aArea    	:= GetArea()
Local aAreaSA1 	:= SA1->(GetArea())
Local aAreaSA2 	:= SA2->(GetArea())
Local cOperNf  	:= ""
Local cUfDest  	:= ""
Local cUfOrig  	:= ""
Local cNatureza	:= ""
Local cCodMuni  := ""
Local cRecPIS  	:= "N"
Local cRecCOFI 	:= "N"
Local cRecCSLL 	:= "N"
Local cRecISS  	:= "2"
Local cRecINSS 	:= "N"
Local cRecSEST 	:= "2"
Local cCNPJ    	:= ""
Local lInclui 	:= .T.
Local lInscrito	:= .F.
Local lSuframa 	:= .F.
Local cCalcSuf 	:= " "
Local nAliqIRF 	:= 0
Local cSerie   	:= ''
Local nMoeda   	:= 1
Local nTxMoeda 	:= 0
Local cModIRF  	:= ""
Local cOPIrrf  	:= ""
Local cRecFet  	:= "2"
Local cRecFab  	:= "2"
Local cRecFac  	:= "2"
Local cSimpNac 	:= ""  
Local nNumDep	:= 0
Local cProvEnt	:= "  "   // Provincia de entrega
Local cIRFProg  := 0
Local nPosNtz   := 0
Local cMvEstado	:= ""
Local cMvDupNat	:= ""
Local cIRMP232  := "2"
Local lA1Contrib:= .F.
Local lA1CalcIRF:= .F.
Local lA2IRPROG := .F. 
Local cFRetIss		:=	"" 

Local cRegeSim	:= ""   // A1_REGESIM / A2_REGESIM - Regime simplificado MT
Local nPercAtm	:= 0	// A1_PERCATM - Pecentual de Carga Media       
Local cPessoa	:= "" 	// A1_PESSOA - Pessoa - Fisica / Juridica                     
Local cNReduz	:= ""   // A1_NREDUZ / A2_NREDUZ - Nome Fantasia        
Local cCRDMA	:= ""	// Credito Estimulo de Manaus
Local cSimpSC	:= "" 	// A1_SIMPLES - Clie. optante SIMPLES/SC       
Local cCDRDes	:= ""   // A1_CDRDES - Regiao do Cliente      

Local cNatCliFa := ""
Local cTipoFat	:= ""
Local cGrpCliFat:= ""
Local aAreaSA1F	  := {}
Local cIDSA1     := ""
Local cIDSA2     := ""
Local lAchouHist := .F.
Local cHistSA1   := ""
Local cHistSA2   := ""
Local lPOS		 := FindFunction("STFIsPOS") .AND. STFIsPOS()
Local nRecCide	 := ""

DEFAULT aRelImp := {}
DEFAULT cTpComp := ""
DEFAULT lInsere := .F.
DEFAULT cAliasP := "SB1"
DEFAULT cTipoDoc:= ""
DEFAULT cEspecie:= ""
DEFAULT	cCodProsp:= ""	//Codigo e Loja do Prospect
DEFAULT cGrpCliFor:= CriaVar("A1_GRPTRIB",.F.)
DEFAULT cRecolheISS	:=	""
DEFAULT cCliEnt  := Space(TamSx3("F3_CLIEFOR")[1])
DEFAULT cLojEnt  := Space(TamSx3("F2_LOJA")[1])
DEFAULT aTransp  := {"",""}
DEFAULT lEmiteNF:= .T.
DEFAULT cRotina := "" 
DEFAULT lCalcIPI:= .T.
DEFAULT cPedido	:= ""
DEFAULT cCliFat		:= ""
DEFAULT cLojCFat	:= ""
DEFAULT nTotPed		:= 0
DEFAULT dDtEmiss	:= dDataBase
DEFAULT cTpFrete	:= ""
If cRotina == "LOJA701" .AND. !lPOS
	lEmiteNF:= LjNFFimVd() // Verifica se emite NF 
EndIf

cTpCliFor		 := IIf(cTpCliFor==Nil," ",cTpCliFor)
aUltPesq         := {ctod(""),"","",0,0}
lNotRemito		:= .T.

If MaFisFound("NF")

	lInclui 	:= .F.
	cCodCliFor	:= aNfCab[NF_CODCLIFOR]
	cLoja		:= aNfCab[NF_LOJA]
	cCliFor		:= aNfCab[NF_CLIFOR]
	cTipoNF		:= aNfCab[NF_TIPONF]
	cTpCliFor	:= aNfCab[NF_TPCLIFOR]
	aRelImp		:= aNfCab[NF_RELIMP]
	cNatureza	:= aNfCab[NF_NATUREZA]
	cTpComp		:= aNfCab[NF_TPCOMP]
	lInsere		:= aNfCab[NF_INSIMP]
	cRotina		:= aNfCab[NF_ROTINA]
	nAliqIRF    := aNfCab[NF_ALIQIR]
	cSerie		:= aNfCab[NF_SERIENF]
	cTipoDoc	:= aNfCab[NF_TIPODOC]
	nMoeda 		:= aNfCab[NF_MOEDA]
	nTxMoeda	:= aNfCab[NF_TXMOEDA]
	cEspecie	:= aNfCab[NF_ESPECIE]
	cCNPJ       := aNfCab[NF_CNPJ]
	cCliEnt		:= aNfCab[NF_CLIENT]
	cLojEnt		:= aNfCab[NF_LOJENT]
	cCodMuni    := aNfCab[NF_CODMUN]   

	cRegeSim 	:= aNfCab[NF_REGESIM]  
	nPercAtm	:= aNfCab[NF_PERCATM]  
	cPessoa		:= aNfCab[NF_PESSOA]
	cNReduz		:= aNfCab[NF_NREDUZ]          
	cCRDMA 		:= aNfCab[NF_A1CRDMA]    
	cSimpSC		:= aNfCab[NF_SIMPSC]    
	cCDRDes		:= aNfCab[NF_CDRDES] 
	cCliFat		:= aNfCab[NF_CLIEFAT]
	cLojCFat	:= aNfCab[NF_LOJCFAT] 
	dDtEmiss    := aNfCab[NF_DTEMISS]
	cTpFrete 	:= aNfCab[NF_TPFRETE]
	
	If cPaisLoc<> "BRA"
		lNotRemito	:=  !(IsRemito(1,"'"+aNFCab[NF_TIPODOC]+"'"))
	EndIf
	If cPaisLoc == "ARG"
		cProvEnt  := aNfCab[NF_PROVENT]
	EndIf
EndIf

cMvEstado	:= aParSX6[MV_ESTADO]
cMvDupNat	:= aParSX6[MV_1DUPNAT]
cIRMP232  	:= aParSX6[MV_IRMP232]
lA1Contrib	:= aFieldPos[FP_A1_CONTRIB]
lA1CalcIRF	:= aFieldPos[FP_A1_CALCIRF]  //SA1->(FieldPos("A1_CALCIRF"))>0
lA2IRPROG 	:= aFieldPos[FP_A2_IRPROG]

If lInclui
	aNFCab	:= {}
	aNFItem	:= {}
	aItemDec:= {}                
	cAliasPROD := cAliasP
EndIf

// Posiciona os registros necessarios                          
If ( cCliFor == "C" )
	
	If Empty(cCodProsp)                        
		dbSelectArea("SA1")
		dbSetOrder(1)
		MsSeek(xFilial("SA1")+cCodCliFor+cLoja)
		If lHistorico
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Se for reprocessamento,  e tiver habilitado para buscar os Historico Fiscais,      ³
		//³verifico se o ID do historico do Cliente e igual ao que foi gravado na Nota. Se for³
		//³igual é porque nao teve alterações no cliente após a emissão. Se for diferente,    ³
		//³é porque teve alterações no cadastro, e entao os dados são carregados da tabela de ³
		//³Historico(SS2).                                                                    ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			cHistSA1 := IIF(cTipoNF=="D", (cAlsCab)->F1_IDSA1, (cAlsCab)->F2_IDSA1) 
			If  Alltrim(SA1->A1_IDHIST)<>Alltrim(cHistSA1)			
				dbSelectArea("SS2")
				dbSetOrder(1)				
				MsSeek(xFilial("SS2")+cHistSA1+cCodCliFor+cLoja)								
				lAchouHist := .T.
			EndIf								
		EndIf			
		
		cOperNf   := IIf(cTipoNf$"DB","E","S")
		
		lInscrito := IIf(lAchouHist, IIf(Empty(SS2->S2_INSCR).Or."ISENT"$SS2->S2_INSCR.Or."RG"$SS2->S2_INSCR.Or.( lA1Contrib .And. SS2->S2_CONTRIB == "2"),.T.,.F.), IIf(Empty(SA1->A1_INSCR).Or."ISENT" $ SA1->A1_INSCR .Or. "RG" $ SA1->A1_INSCR .Or.( lA1Contrib .And. SA1->A1_CONTRIB == "2"),.T.,.F.))
		
		If SA1->A1_CONTRIB == "1" .And. SA1->A1_TPJ == "3" .And. Empty(SA1->A1_INSCR)
			lInscrito := .F.
		Endif
		
		//Tratamento para considerar como contribuinte do ICMS Produtor Rural com inscrição Rural
		If IIf(lAchouHist, !Empty(SS2->S2_INSCRUR) .And. "L" $ SS2->S2_TIPO .And. ( lA1Contrib .And. SS2->S2_CONTRIB <> "2"), !Empty(SA1->A1_INSCRUR) .And. "L" $ SA1->A1_TIPO .And. ( lA1Contrib .And. SA1->A1_CONTRIB <> "2"))
			lInscrito := .F.
		EndIf		
		cCodMuni  := IIf(lAchouHist, SS2->S2_COD_MUN, SA1->A1_COD_MUN)
		lSuframa  := IIf(lAchouHist, !Empty(SS2->S2_SUFRAMA) .And. SS2->S2_CALCSUF<>'N',  !Empty(SA1->A1_SUFRAMA) .And. SA1->A1_CALCSUF<>'N')
		cCalcSuf  := IIf(lAchouHist, SS2->S2_CALCSUF, SA1->A1_CALCSUF)
		If Empty(cGrpCliFor)
			cGrpCliFor := IIf(lAchouHist, SS2->S2_GRPTRIB, SA1->A1_GRPTRIB)
		EndIf
		If lEmiteNF
			cUfDest   := IIf(lAchouHist, IIf(cTipoNf$"DB",cMvEstado,SS2->S2_EST), IIf(cTipoNf$"DB",cMvEstado,SA1->A1_EST))
			cUfOrig   := IIf(lAchouHist, IIf(cTipoNf$"DB",SS2->S2_EST,cMvEstado), IIf(cTipoNf$"DB",SA1->A1_EST,cMvEstado))
		Else
			cUfDest   := cMvEstado
			cUfOrig   := cMvEstado
			If cPaisLoc == "ARG" // SigaLoja - para argentina inicializa a provincia do cliente
				cProvEnt  := IIf(lAchouHist, SS2->S2_EST, SA1->A1_EST)
			EndIf	
		EndIf
		cCNPJ     := IIf(lAchouHist, SS2->S2_CGC, SA1->A1_CGC)
		
		If lInclui   						                	    		                             
			cNatureza := &(cMvDupNat)			
			cTpCliFor := IIf(lAchouHist, IIf(Empty(cTpCliFor),SS2->S2_TIPO,cTpCliFor), IIf(Empty(cTpCliFor),SA1->A1_TIPO,cTpCliFor))
		Else
			cTpCliFor := IIf(lAchouHist, SS2->S2_TIPO, SA1->A1_TIPO)
		EndIf
		nAliqIRF  := IIf(lAchouHist, SS2->S2_ALIQIR, SA1->A1_ALIQIR)
		cRecPIS  := IIf(lAchouHist, SS2->S2_RECPIS, SA1->A1_RECPIS)
		cRecCOFI := IIf(lAchouHist, SS2->S2_RECCOFI, SA1->A1_RECCOFI)
		cRecCSLL := IIf(lAchouHist, SS2->S2_RECCSLL, SA1->A1_RECCSLL)
		cRecISS  := IIf(lAchouHist, IIf(SS2->S2_RECISS$"N|2| ","2","1"), IIf(SA1->A1_RECISS$"N|2| ","2","1")) 
		If !Empty(cRecolheISS)
			cRecISS  := cRecolheISS
		Endif
		cRecINSS := IIf(lAchouHist, SS2->S2_RECINSS, SA1->A1_RECINSS)

		If cPaisLoc== "BRA" .And. (aFieldPos[FP_B1_AFETHAB]  .And. aFieldPos[FP_A2_RECFET]  .And. aFieldPos[FP_A1_RECFET] .And. aFieldPos[FP_F4_CALCFET] )
			cRecFet  := IIf(lAchouHist, IIf(Empty(SS2->S2_RECFET),"2",SS2->S2_RECFET), IIf(Empty(SA1->A1_RECFET),"2",SA1->A1_RECFET))
		Endif	  
		                                                                                                           
		If cPaisLoc== "BRA" .And. (aFieldPos[FP_B1_AFABOV] .And. aFieldPos[FP_A2_RFABOV] .And. aFieldPos[FP_A1_RFABOV] .And. aFieldPos[FP_F4_CFABOV] )
			cRecFab  := IIf(lAchouHist, IIf(Empty(SS2->S2_RFABOV),"2",SS2->S2_RFABOV), IIf(Empty(SA1->A1_RFABOV),"2",SA1->A1_RFABOV))
		Endif	                                                      
		
		If cPaisLoc== "BRA" .And. (aFieldPos[FP_B1_AFACS] .And. aFieldPos[FP_A2_RFACS] .And. aFieldPos[FP_A1_RFACS]  .And. aFieldPos[FP_F4_CFACS] )
			cRecFac  := IIf(lAchouHist, IIf(Empty(SS2->S2_RFACS),"2",SS2->S2_RFACS), IIf(Empty(SA1->A1_RFACS),"2",SA1->A1_RFACS))
		Endif	

		cModIRF  	:= IIf(lAchouHist, IIf( lA1CalcIRF ,SS2->S2_CALCIRF,IIf(cIRMP232=="2","1","2")), IIf( lA1CalcIRF ,SA1->A1_CALCIRF,IIf(cIRMP232=="2","1","2")))		
		cOPIrrf  	:= IIf(lAchouHist, IIf( aFieldPos[FP_A1_TPESSOA] , SS2->S2_TPESSOA,""), IIf( aFieldPos[FP_A1_TPESSOA] , SA1->A1_TPESSOA,""))
		nNumDep		:= 0	// so verifico os dependentes para os fornecedores
		cIRFProg    := IIf(lAchouHist, IIf( lA2IRPROG , SS2->S2_IRPROG , "2" ) , IIf( lA2IRPROG , SA2->A2_IRPROG , "2" ) )
		
		cRegeSim 	:=  IIf(lAchouHist, IIf(aFieldPos[FP_A1_REGESIM], SS2->S2_REGESIM , "" ), IIf(aFieldPos[FP_A1_REGESIM], SA1->A1_REGESIM , "" ))
		nPercAtm	:=  IIf(lAchouHist, Iif(aFieldPos[FP_A1_PERCATM], SS2->S2_PERCATM , 0   ), Iif(aFieldPos[FP_A1_PERCATM], SA1->A1_PERCATM , 0   ))   
		cPessoa		:=  IIf(lAchouHist, SS2->S2_PESSOA, SA1->A1_PESSOA )
		cNReduz		:=  IIf(lAchouHist, SS2->S2_NREDUZ, SA1->A1_NREDUZ)
		cCRDMA		:=  IIf(lAchouHist, Iif(aFieldPos[FP_A1_CRDMA]	 , SS2->S2_CRDMA , "" ), Iif(aFieldPos[FP_A1_CRDMA]	 , SA1->A1_CRDMA , "" ))      
		cSimpSC   	:=  IIf(lAchouHist, Iif(aFieldPos[FP_A1_SIMPLES], SS2->S2_SIMPLES , ""), Iif(aFieldPos[FP_A1_SIMPLES], SA1->A1_SIMPLES , ""))
		cCDRDes		:=  IIf(lAchouHist, Iif(aFieldPos[FP_A1_CDRDES], SS2->S2_CDRDES , ""), Iif(aFieldPos[FP_A1_CDRDES], SA1->A1_CDRDES , ""))
		If cPaisLoc== "BRA" 
			cFRetIss	:=  Iif(lAchouHist, SS2->S2_FRETISS, SA1->A1_FRETISS)
		EndIf
		cIdSA1      := IIf(lAchouHist, IIf(aFieldPos[FP_A1_IDHIST], SS2->S2_IDHIST, ""), IIf(aFieldPos[FP_A1_IDHIST], SA1->A1_IDHIST, ""))

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ`¿
		//³Os tratamentos para PIS e COFINS irão utilizar como base o cliente de faturamento e ³
		//³não mais o cliente entrega passado pelo parâmetro cCodCliFor na função MaFisIni e   ³
		//³gravado no array aNfCab e utilizado para as regras dos outros tributos.             ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ`Ù
        If aParSX6[MV_PCFATPC] .And. cOperNf == "S"  .And. !Empty(cCliFat)
			aAreaSA1F	:=	SA1->(GetArea())
			If MsSeek(xFilial("SA1")+cCliFat+cLojCFat)
		
				If lInclui
					cNatCliFa := &(cMvDupNat)
					cTipoFat  := IIf(Empty(cTipoFat),SA1->A1_TIPO,cTipoFat)
				Else
					cTipoFat := SA1->A1_TIPO
				EndIf
				cGrpCliFat:= SA1->A1_GRPTRIB

				cRecPIS  := SA1->A1_RECPIS
				cRecCOFI := SA1->A1_RECCOFI

			EndIf
			RestArea(aAreaSA1F)  // Posicionando novamente no cliente principal utilizado na MATXFIS (Parâmetro cCodCliFor do MaFisIni() )
		EndIf
	Else
		//Inicializa as variaveis para a entidade prospect
		DbSelectArea("SUS") 
		DbSetOrder(1)
		MsSeek(xFilial("SUS")+cCodProsp)
		cOperNf   := IIf(cTipoNf$"DB","E","S")
		
		If aFieldPos[FP_US_INSCR]
			lInscrito := IIf(Empty(SUS->US_INSCR) .Or. "ISENT" $ SUS->US_INSCR .Or. "RG" $ SUS->US_INSCR .Or. ( aFieldPos[FP_US_CONTRIB] .And. SUS->US_CONTRIB == "2"),.T.,.F.)
		Endif	            
		
		If aFieldPos[FP_US_SUFRAMA]  .And. aFieldPos[FP_US_CALCSUF] 
			lSuframa  := !Empty(SUS->US_SUFRAMA) .And. SUS->US_CALCSUF<>'N' 
			cCalcSuf  := SUS->US_CALCSUF
		Endif
				
		If aFieldPos[FP_US_GRPTRIB]  .And. Empty(cGrpCliFor)
			cGrpCliFor:= SUS->US_GRPTRIB
	    Endif
	    
		cUfDest   := IIf(cTipoNf$"DB",cMvEstado,SUS->US_EST)
		cUfOrig   := IIf(cTipoNf$"DB",SUS->US_EST,cMvEstado)
		cCNPJ     := SUS->US_CGC
	
		If lInclui
			If aFieldPos[FP_US_NATUREZ] 
				cNatureza := SUS->US_NATUREZ
			Endif
			cTpCliFor := IIf(Empty(cTpCliFor),SUS->US_TIPO,cTpCliFor)
		Else
			cTpCliFor := SUS->US_TIPO
		EndIf
	
		nAliqIRF := IIf(aFieldPos[FP_US_ALIQIR],SUS->US_ALIQIR	,0)
		cRecPIS  := IIf(aFieldPos[FP_US_RECPIS],SUS->US_RECPIS	,"N")
		cRecCOFI := IIf(aFieldPos[FP_US_RECCOFI],SUS->US_RECCOFI	,"N")
		cRecCSLL := IIf(aFieldPos[FP_US_RECCSLL],SUS->US_RECCSLL	,"N")
		cRecISS  := IIf(aFieldPos[FP_US_RECISS],SUS->US_RECISS	,"2")
		cRecINSS := IIf(aFieldPos[FP_US_RECINSS],SUS->US_RECINSS	,"N")
		cModIRF  := IIf( lA1CalcIRF ,SA1->A1_CALCIRF,IIf(cIRMP232=="2","1","2"))
		cOPIrrf  := IIf(aFieldPos[FP_US_TPESSOA],SUS->US_TPESSOA	,"")
		nNumDep	 := 0	// so verifico os dependentes para os fornecedores
		cIRFProg := IIf(lA2IRPROG,SA2->A2_IRPROG,"2")
	EndIf
	
Else
	lAchouHist := .F.
	dbSelectArea("SA2")            
	dbSetOrder(1)
	MsSeek(xFilial("SA2")+cCodCliFor+cLoja)	
	If lHistorico 
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Se for reprocessamento,  e tiver habilitado para buscar os Historico Fiscais,      ³
		//³verifico se o ID do historico do Fornecedor e igual ao que foi gravado na Nota.    ³
		//³Se for igual é porque nao teve alterações no cliente após a emissão. Se for diferen³
		//³te e porque teve alterações no cadastro, e entao os dados são carregados da tabela ³
		//³de Historico(SS3).                                                                 ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		cHistSA2 := IIF(!cTipoNF$"B|D", (cAlsCab)->F1_IDSA2, (cAlsCab)->F2_IDSA2) 
		If  Alltrim(SA2->A2_IDHIST)<>Alltrim(cHistSA2)
			dbSelectArea("SS3")
			dbSetOrder(1)				
			MsSeek(xFilial("SS3")+cHistSA2+cCodCliFor+cLoja)								
			cAls2 := "SS3"				
			lAchouHist := .T.
		EndIf								
	EndIf
	cOperNf   := IIf(cTipoNf$"DB","S","E")
	If Empty(cGrpCliFor)
		cGrpCliFor:= IIf(lAchouHist, SS3->S3_GRPTRIB, SA2->A2_GRPTRIB)
	EndIf
	
	lInscrito  := IIf(Empty(SM0->M0_INSC).Or."ISENT"$SM0->M0_INSC .Or. aParSX6[MV_SM0CONT]=="2",.T.,.F.)
	
	cCodMuni  := IIf(lAchouHist, SS3->S3_COD_MUN, SA2->A2_COD_MUN)
	cUfDest   := IIf(lAchouHist, IIf(cTipoNf$"DB",SS3->S3_EST,cMvEstado), IIf(cTipoNf$"DB",SA2->A2_EST,cMvEstado))
	cUfOrig   := IIf(lAchouHist, IIf(cTipoNf$"DB",cMvEstado,SS3->S3_EST), IIf(cTipoNf$"DB",cMvEstado,SA2->A2_EST))
	cCNPJ     := IIf(lAchouHist, SS3->S3_CGC, SA2->A2_CGC)
	
	If cPaisLoc == "ARG" // Argentina inicializa a provincia do Fornecedor
		cProvEnt  := IIf(lAchouHist, SS3->S3_EST, SA2->A2_EST)
	EndIf

	If lInclui
		cNatureza := &(aParSX6[MV_2DUPNAT])
		If Empty( cTpCliFor )
			// Converte os tipos do fornecedor para os tipos validos       
			cTpCliFor := IIf(lAchouHist, IIf( SS3->S3_TIPO == "J" .Or. SS3->S3_TIPO == " " , "R" , SS3->S3_TIPO ), IIf( SA2->A2_TIPO == "J" .Or. SA2->A2_TIPO == " " , "R" , SA2->A2_TIPO ))
		EndIf
	Else
		cTpCliFor := IIf(lAchouHist, IIf( SS3->S3_TIPO == "J" .Or. SS3->S3_TIPO == " " , "R" , SS3->S33_TIPO ), IIf( SA2->A2_TIPO == "J" .Or. SA2->A2_TIPO == " " , "R" , SA2->A2_TIPO ))
	EndIf
	If cPaisLoc== "BRA"
		cRecISS  := IIf(lAchouHist, IIf(SS3->S3_RECISS<>"S","2","1"), IIf(SA2->A2_RECISS<>"S","2","1"))
		cRecINSS := IIf(lAchouHist, SS3->S3_RECINSS, SA2->A2_RECINSS)
		cRecSEST := IIf(lAchouHist, IIf(aFieldPos[FP_A2_RECSEST],SS3->S3_RECSEST,"2"), IIf(aFieldPos[FP_A2_RECSEST],SA2->A2_RECSEST,"2"))
		cRecPIS  := IIf(lAchouHist, IIf(SS3->S3_RECPIS<>"2","N","S"), IIf(SA2->A2_RECPIS<>"2","N","S"))
		cRecCOFI := IIf(lAchouHist, IIf(SS3->S3_RECCOFI<>"2","N","S"), IIf(SA2->A2_RECCOFI<>"2","N","S"))
		cRecCSLL := IIf(lAchouHist, IIf(SS3->S3_RECCSLL<>"2","N","S"), IIf(SA2->A2_RECCSLL<>"2","N","S"))

		If cPaisLoc== "BRA" .And. (aFieldPos[FP_B1_AFETHAB]  .And. aFieldPos[FP_A2_RECFET]  .And. aFieldPos[FP_A1_RECFET] .And. aFieldPos[FP_F4_CALCFET] )
			cRecFet  := IIf(lAchouHist, IIf(Empty(SS3->S3_RECFET),"2",SS3->S3_RECFET), IIf(Empty(SA2->A2_RECFET),"2",SA2->A2_RECFET))
		Endif	

		If cPaisLoc== "BRA" .And. (aFieldPos[FP_B1_AFABOV] .And. aFieldPos[FP_A2_RFABOV] .And. aFieldPos[FP_A1_RFABOV] .And. aFieldPos[FP_F4_CFABOV] )
			cRecFab  := IIf(lAchouHist, IIf(Empty(SS3->S3_RFABOV),"2",SS3->S3_RFABOV), IIf(Empty(SA2->A2_RFABOV),"2",SA2->A2_RFABOV))
		Endif	
		
		If cPaisLoc== "BRA" .And. (aFieldPos[FP_B1_AFACS] .And. aFieldPos[FP_A2_RFACS] .And. aFieldPos[FP_A1_RFACS]  .And. aFieldPos[FP_F4_CFACS] )
			cRecFac  := IIf(lAchouHist, IIf(Empty(SS3->S3_RFACS),"2",SS3->S3_RFACS), IIf(Empty(SA2->A2_RFACS),"2",SA2->A2_RFACS))
		Endif	

		cModIRF  := IIf(lAchouHist, IIf(aFieldPos[FP_A2_CALCIRF],SS3->S3_CALCIRF,"1"), IIf(aFieldPos[FP_A2_CALCIRF],SA2->A2_CALCIRF,"1"))
		cOPIrrf  := IIf(lAchouHist, Iif(aFieldPos[FP_A2_TPESSOA],SS3->S3_TPESSOA,""), Iif(aFieldPos[FP_A2_TPESSOA],SA2->A2_TPESSOA,""))
		cSimpNac := IIf(lAchouHist, Iif(aFieldPos[FP_A2_SIMPNAC],SS3->S3_SIMPNAC,""), Iif(aFieldPos[FP_A2_SIMPNAC],SA2->A2_SIMPNAC,""))
		nNumDep	:= IIf(lAchouHist, Iif(aFieldPos[FP_A2_NUMDEP],SS3->S3_NUMDEP,0), Iif(aFieldPos[FP_A2_NUMDEP],SA2->A2_NUMDEP,0))  	// so verifico os dependentes para os fornecedores
		cIRFProg := IIf(lAchouHist, IIf(lA2IRPROG,SS3->S3_IRPROG,"2"), IIf(lA2IRPROG,SA2->A2_IRPROG,"2"))    
		
		cRegeSim 	:=  IIf(lAchouHist, IIf(aFieldPos[FP_A2_REGESIM], SS3->S3_REGESIM , "" ), IIf(aFieldPos[FP_A2_REGESIM], SA2->A2_REGESIM , "" ))
		cNReduz		:=  IIf(lAchouHist, SS3->S3_NREDUZ, SA2->A2_NREDUZ)
	
		//ID do Historico da SA2
		cIdSA2  := IIf(lAchouHist, If(aFieldPos[FP_A2_IDHIST], SS3->S3_IDHIST, ""), If(aFieldPos[FP_A2_IDHIST], SA2->A2_IDHIST, ""))

        nRecCide := IIf(lAchouHist, If(aFieldPos[FP_A2_RECCIDE], SS3->S3_RECCIDE, ""), If(aFieldPos[FP_A2_RECCIDE], SA2->A2_RECCIDE, "")) 
	EndIf
EndIf

cMunForISS := cCodMuni
dbSelectArea("SED")
SED->(dbSetOrder(1))
If SED->(MsSeek(xFilial("SED")+cNatureza))
	If lHistorico 
		If ( cCliFor == "C" )
			cHistSED :=	(cAlsCab)->F2_IDSED 	
		Else	
			cHistSED :=	(cAlsCab)->F1_IDSED 	
		EndIf		
		lAchouHistrt := .F.	
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Se for reprocessamento,  e tiver habilitado para buscar os Historico Fiscais,      ³
		//³verifico se o ID do historico do Natureza e igual ao que foi gravado na Nota.      ³
		//³Se for igual é porque nao teve alterações na Natureza após a emissão. Se for dife  ³
		//³rente e porque teve alterações no cadastro, e entao os dados são carregados da     ³
		//³tabela de Historico(SS7).                                                          ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If  Alltrim(SED->ED_IDHIST)<>Alltrim(cHistSED)
			dbSelectArea("SS7")
			dbSetOrder(1)				
			MsSeek(xFilial("SS7")+cHistSED)								
			lAchouHist := .T.
		EndIf								
	EndIf
		
	aInfNat := {IIf(lAchouHist, SS7->S7_CODIGO,	 SED->ED_CODIGO),; 	// aInfNat -> 01   
					IIf(lAchouHist, SS7->S7_CALCIRF, SED->ED_CALCIRF),; 	// aInfNat -> 02 
					IIf(lAchouHist, SS7->S7_PERCIRF, SED->ED_PERCIRF),; 	// aInfNat -> 03  
					IIf(lAchouHist, SS7->S7_BASEIRF, SED->ED_BASEIRF),; 	// aInfNat -> 04 
					IIf(lAchouHist, SS7->S7_PERCINS, SED->ED_PERCINS),; 	// aInfNat -> 05 
					IIf(lAchouHist, SS7->S7_BASEINS, SED->ED_BASEINS),; 	// aInfNat -> 06 
					IIf(lAchouHist, SS7->S7_CALCINS, SED->ED_CALCINS),; 	// aInfNat -> 07 	  
					IIf(lAchouHist, SS7->S7_CALCISS, SED->ED_CALCISS),; 	// aInfNat -> 08 	
					IIf(lAchouHist, SS7->S7_CALCPIS, SED->ED_CALCPIS),; 	// aInfNat -> 09 	
					IIf(lAchouHist, SS7->S7_PERCPIS, SED->ED_PERCPIS),; 	// aInfNat -> 10 	
					IIf(lAchouHist, SS7->S7_CALCCOF, SED->ED_CALCCOF),; 	// aInfNat -> 11 	
					IIf(lAchouHist, SS7->S7_PERCCOF, SED->ED_PERCCOF),; 	// aInfNat -> 12 
					IIf(lAchouHist, SS7->S7_CALCCSL, SED->ED_CALCCSL),; 	// aInfNat -> 13 	  
					IIf(lAchouHist, SS7->S7_PERCCSL, SED->ED_PERCCSL),; 	// aInfNat -> 14 	
					IIf(lAchouHist, SS7->S7_BASESES, SED->ED_BASESES),; 	// aInfNat -> 15 			
					IIf(lAchouHist, SS7->S7_PERCSES, SED->ED_PERCSES),;  	// aInfNat -> 16 	
					IIf(lAchouHist, Iif(aFieldPos[FP_ED_IDHIST], SS7->S7_IDHIST,""), Iif(aFieldPos[FP_ED_IDHIST], SED->ED_IDHIST,"")),; // aInfNat -> 17 
					IIf(lAchouHist, SS7->S7_DEDINSS, SED->ED_DEDINSS),;	   // aInfNat -> 18
					IIf(lAchouHist, Iif(aFieldPos[FP_ED_CALCCID], SS7->S7_CALCCID,""), Iif(aFieldPos[FP_ED_CALCCID], SED->ED_CALCCID,"")),;       // aInfNat -> 19			
					IIf(lAchouHist, Iif(aFieldPos[FP_ED_PERCCID], SS7->S7_PERCCID,0), Iif(aFieldPos[FP_ED_PERCCID], SED->ED_PERCCID,0)),;       // aInfNat -> 20 				
					IIf(lAchouHist, Iif(aFieldPos[FP_ED_BASECID], SS7->S7_BASECID,0), Iif(aFieldPos[FP_ED_BASECID], SED->ED_BASECID,0))} 	    // aInfNat -> 21 				
					
Else  
	aInfNat := {	"",;		// aInfNat -> 01 - ED_CODIGO                                                                
					"",; 		// aInfNat -> 02 - ED_CALCIRF 
					0 ,; 		// aInfNat -> 03 - ED_PERCIRF  
					0 ,; 		// aInfNat -> 04 - ED_BASEIRF 
					0 ,; 		// aInfNat -> 05 - ED_PERCINS 
					0 ,;   		// aInfNat -> 06 - ED_BASEINS 
					"",; 		// aInfNat -> 07 - ED_CALCINS  	  
					"",; 		// aInfNat -> 08 - ED_CALCISS 	
					"",; 		// aInfNat -> 09 - ED_CALCPIS 	
					0 ,; 		// aInfNat -> 10 - ED_PERCPIS	
					"",; 		// aInfNat -> 11 - ED_CALCCOF 	
					0 ,; 		// aInfNat -> 12 - ED_PERCCOF 
					"",; 		// aInfNat -> 13 - ED_CALCCSL	  
					0 ,; 		// aInfNat -> 14 - ED_PERCCSL 	
					0 ,; 		// aInfNat -> 15 - ED_BASESES			
					0 ,;    	// aInfNat -> 16 - ED_PERCSES 	
					"",;		// aInfNat -> 17 - ED_IDHIST
					"",; 		// aInfNat -> 18 - ED_DEDINSS 
					"",;		// aInfNat -> 19 - ED_CALCCID
					"",;		// aInfNat -> 20 - ED_PERCCID
					""}			// aInfNat -> 21 - ED_BASECID
EndIf
             
If lInclui
	aNfCab := {	cTipoNF,;		//1
		cOperNF,;		//2
		cCliFor,;		//3
		cTpCliFor,;		//4
		lInscrito,;		//5
		cGrpCliFor,;	//6
		cUFdest,;       //7
		cUfOrig,;		//8
		0,;				//9
		0,;				//10
		0,;				//11
		0,;				//12
		0,;				//13
		0,;				//14
		{0,0,0,0,0,0,0,0,"1"},;	//15
		{0,0,0},;		//16
		0,;				//17
		0,;				//18
		0,;				//19
		cCodCliFor,;	//20
		cLoja,;			//21
		{},;			//22
		{0,0,0},;	    //23
		{0,0},;		    //24
		{0,0},;		    //25
		cNatureza,;		//26
		0,;				//27
		{},;			//28
		{},;			//29
		{{'...','  ',0,0,0,'NEW'}},;	//30
		0,;				//31
		aRelImp,;		//32
		{{'...','  ',0,0,'NEW'}},;//33
		0,;				//34
		lSuframa,;		//35
		Array(NMAXIV),;	//36
		Array(NMAXIV),;	//37
		cTpComp,;		//38
		lInsere,;		//39
		0,;				//40
		0,;				//41
		0,;				//42
		0,;				//43
		0,;				//44
		0,;				//45
		0,;				//46
		0,;				//47
		0,;				//48
		cRotina,;       //49
		0,;				//50
		nAliqIRF,;		//51
		0,;   			//52
		cRecPIS,;		//53
		cRecCOFI,;		//54
		cRecCSLL,;		//55
		cRecISS,;		//56
		cRecINSS,;		//57
		nMoeda,;		//58
		nTxMoeda,;		//59
		cSerie,;		//60
		cTipoDoc,;		//61
		Array(NMAXIV),;	//62
		0,;				//63
		0,;				//64
		cEspecie,;      //65
		cCNPJ,;         //66
		0,;             //67
		0,;             //68
		0,;             //69
		cModIRF,;       //70
		{"","","",""},;//71
		cCalcSuf,;	    //72
		0,;				//73 - Base de Calculo do AFRMM - NF
		0,;				//74 - Valor do AFRMM - NF
		0,;             //75
		0,;             //76
		cOPIrrf,;		//77		
		{0,0},;		    //78 - Array dos valores do SEST
		cRecSEST,;		//79 - Recolhe SEST
		0,;				//80 - Base de calculo do PIS Subst. Tributaria
		0,;				//81 - Valor do PIS Subst. Tributaria
		0,;				//82 - Base de calculo da COFINS Subst. Tributaria
		0,;				//83 - Valor da COFINS Subst. Tributaria
		0,;				//84 - Valor Total do Frete de Pauta
		0,;				//85 - Valor FETHAB
		cRecFet,;		//86 - Recolhe FETHAB
		cCliEnt,;   	//87 - Codigo do cliente de entrega
		cLojEnt,;		//88 - Loja do cliente de entrega
		0,;				//89 - Valor do Fundersul - Mato Grosso do Sul
		0,;				//90 - Valor do Estorno de Credito
		cSimpNac,;		//91 - Enquadra no Simples Nacional
		aTransp,;		//92 - Dados do transportador para o calculo do ICMS do frete autonomo embarcador
		0,;       		//93 - Base do ICMS de transporte Substituicao Tributaria
		0,;				//94 - Base do ICMS de transporte Substituicao Tributaria
		0,;				//95 - Credito Presumido Simples Nacional - SC
		0,;             //96 - Valor Antecipacao ICMS
		0,;				//97 - Despesas nao tributadas - Portugal
		0,;				//98 - Tara - Portugal
		nNumDep,;		//99 - Numero de dependentes - cálculo base IRRF pessoa fisica
		cProvEnt,;      //100 - Provincia de entrega  
		0,;     		//101 - Valor do FECP
		0,;				//102 - Valor do FECP ST
		0,;				//103 - Valor Crédito Presumido - SC
		cIRFProg,;      //104 - Calcula IR pela Tabela Progressiva mesmo sendo Pessoa Juridica
		0,;             //105 - Valor do imposto de Importacao		 
		.T.,;			//106 - Flag para recalculo de impostos variaveis
		0,;				//107 - Valor do credito presumido PE
		Array(NMAXIV),;	//108 - Valor do ORIGINAL DO iMPOSTO
		0,;				//109 - Valor FABOV - Mato Grosso
		cRecFab,;	    //110 - Reponsabilidade de recolhimento FABOV - Mato Grosso        
		0,;				//111 - Valor FACS - Mato Grosso
		cRecFac,; 		//112 - Reponsabilidade de recolhimento FACS - Mato Grosso
		lCalcIPI,; 		//113 - Calcula IPI (SIGALOJA)       
		0,;				//114 - Valor do FUMACOP
        0,;              //115 - Valor do Senar
        0,;             //116 - Credito Outorgado SP     
        0,;             //117 - Base do ICMS sem desconto - Decreto 43.080/02-MG
        0,;             //118 - Valor do ICMS sem desconto - Decreto 43.080/02-MG        
        0,;             //119 - Valor do Desconto - Decreto 43.080/02-MG
        0,;             //120 - Valor do ICMS sem debito de imposto - Decreto 43.080/02-MG        
        0,;				//121 - Base do FUNRURAL
        cPedido,;		//122 - Pedido de Venda       
        cCodMuni,;		//123 - Codigo do Municipio utilizado na operacao       
        {0,0},;			//124 - Valor TPDP - PB        
        0,;		        //125 - Valor incentivo prod.leite RICMS/MG
        0,;				//126 - Base de calculo do INSS Condições Especiais
        0,;            	//127 - Valor do INSS Condições Especiais      
		0,;     		//128 - Valor do FECOP-RN
		0,;				//129 - Valor do FECOP ST-RN 
		0,;				//130 - Credito Presumido
		0,;     		//131 - Valor do FECP-MG
		0,;				//132 - Valor do FECP ST-MG       
		0,;             //133 - Valor do Reintegra               
		0,;             //134 - Base de Calculo do Reintegra 
		0,;             //135 - Valor do FECP-MT
		0,;             //136 - Valor do FECP ST-MT     
		cRegeSim,;      //137 - Regime Simp. MT
		nPercAtm,;      //138 - Perc. Carga media
		cPessoa,;		//139 - Pessoa - Fisica/Juridica
		cNReduz,;		//140 - Nome Fantasia
		cCRDMA,;		//141 - Credito Estimulo de Manaus 
		cSimpSC,;       //142 - Clie. optante SIMPLES/SC
		cCDRDes,;       //143 - Regiao do Cliente   
		{cCliFat,cLojCFat,cTipoFat,cGrpCliFat,cNatCliFa},; //144 - Cliente, Loja, Tipo, Grupo e Natureza do cliente do Faturamento (utilizado para PIS e COFINS)
		0,;				//145 - Abatimentos de Materiais do ISS
		0,;				//146 - Abatimentos de Servicos do ISS
		0,;				//147 - Abatimentos de Materiais do INSS
		0,;				//148 - Abatimentos de Servicos do INSS     
		0,;	            //149 - Adiantamento    
  		nTotPed,;		//150 - Total do Pedido
		dDtEmiss,;		//151 - Emissao do documento
	    cIDSA1,;        //152 - ID Historico Cliente
		cIDSA2,;        //153 - ID Historico Fornecedor
		aInfNat[18],;   //154 - ID Historico Natureza		
		0 ,;		     //155 - Total do Desconto do Item - USO DO NOVO PDV - LOJA		
		0 ,;	         //156 - Total do Acrescimos do Item - USO DO NOVO PDV - LOJA 
		cTpFrete ,;		 //157 - Tipo de Frete definido no pedido de Venda
		cFRetIss ,;		//158 - Forma de Retencao do ISS. 1 - Considera Valor Minimo; 2 - Sempre Retem	
		cUfOrig ,;		//159 - UF da prestacao do servico do ISS onde o servico foi prestado
		Array(NMAXUF),;	//160 -  Array com conteúdo da tabela CFC
		0,;				//161 - Valor Cide
		nRecCide,;		//162 - Rec Cide
		0,;				//163 - Valor do FETAHB retido pelo cliente/fornecedor
		"",;			//164 - Modalidade CTE / SF1
		0,;          	//165 - NF_BASNDE
		0,;           	//166 -NF_ICMNDES
		0}				//167 - Total de adiantamento
		
Else
	aNfCab	:= {	cTipoNF,;		//1
		cOperNF,;		//2
		cCliFor,;		//3
		cTpCliFor,;		//4
		lInscrito,;		//5
		cGrpCliFor,;	//6
		cUFdest,;	    //7
		cUfOrig,;		//8
		0,;				//9
		0,;				//10
		0,;				//11
		0,;				//12
		0,;				//13
		0,;				//14
		{0,0,0,0,0,0,0,0,"1"},;	//15
		{0,0,0},;		//16
		0,;	 			//17
		0,;				//18
		0,;				//19
		cCodCliFor,;	//20
		cLoja,;			//21
		{},;			//22
		{0,0,0},;		//23
		{0,0},;			//24
		{0,0},;	  		//25
		cNatureza,;		//26
		0,;				//27
		{},;			//28
		{},;			//29
		{{"","",0,0,0,""}},;	//30
		0,;				//31
		aRelImp,;		//32
		{{"","",0,0,""}},;	 //33
		0,;				//34
		lSuframa,;		//35
		Array(NMAXIV),;//36
		Array(NMAXIV),; //37
		cTpComp,;		//38
		lInsere,;		//39
		0,;				//40
		0,;				//41
		0,;				//42
		0,;				//43
		0,;				//44
		0,;				//45
		0,;				//46
		0,;				//47
		0,;				//48
		cRotina,;       //49
		0,;				//50
		nAliqIRF,;    	//51
		0,;   			//52
		cRecPIS,;		//53
		cRecCOFI,;		//54
		cRecCSLL,;		//55
		cRecISS,;		//56
		cRecINSS,;		//57
		nMoeda,;		//58
		nTxMoeda,;		//59
		cSerie,;		//60
		cTipoDoc,;		//61
		Array(NMAXIV),;	//62
		0,;				//63
		0,;				//64
		cEspecie,;      //65
		cCNPJ,;         //66
		0,;             //67
		0,;             //68
		0,;             //69
		cModIRF,;       //70
		{"","","",""},;//71
		cCalcSuf,;	    //72
		0,;				//73
		0,;				//74
		0,;             //75
		0,;             //76
		cOPIrrf,;       //77
		{0,0},;		    //78 - Array dos valores do SEST
		cRecSEST,;		//79 - Recolhe SEST
		0,;				//80 - Base de calculo do PIS Subst. Tributaria
		0,;				//81 - Valor do PIS Subst. Tributaria
		0,;				//82 - Base de calculo da COFINS Subst. Tributaria
		0,;				//83 - Valor da COFINS Subst. Tributaria
		0,;				//84 - Valor Total do Frete de Pauta
		0,;				//85 - Valor FETHAB
		cRecFet,;		//86 - Recolhe FETHAB
		cCliEnt,;   	//87 - Codigo do cliente de entrega
		cLojEnt,;		//88 - Loja do cliente de entrega             
		0,;				//89 - Valor do Fundersul - Mato Grosso do Sul		
		0,;				//90 - Valor do Estorno de Credito
		cSimpNac,;		//91 - Enquadra no Simples Nacional
		aTransp,;		//92 - Dados do transportador para o calculo do ICMS do frete autonomo embarcador
		0,;       		//93 - Base do ICMS de transporte Substituicao Tributaria
		0,;				//94 - Base do ICMS de transporte Substituicao Tributaria
		0,;				//95 - Credito Presumido Simples Nacional - SC
		0,;             //96 - Valor Antecipacao ICMS		
		0,;				//97 - Despesas nao tributadas - Portugal
		0,;				//98 - Tara - Portugal
		nNumDep,;		//99 - Numero de dependentes - cálculo base IRRF pessoa fisica
		cProvEnt,;      //100 - Provincia de entrega 
		0,;     		//101 - Valor do FECP
		0,;				//102 - Valor do FECP ST
		0,;				//103 - Valor Crédito Presumido - SC
		cIRFProg,;		//104 - Calcula IR pela Tabela Progressiva mesmo sendo Pessoa Juridica
				0,;     //105 - Valor do imposto de Importacao		 
		.T.,;			//106 - Flag para recalculo de impostos variaveis
		0,;		        //107 - Valor do credito presumido PE		 
		Array(NMAXIV),;	//108 - Valor do ORIGINAL DO iMPOSTO
		0,;		   		//109 - Valor FABOV - Mato Grosso     
		cRecFab,;	    //110 - Reponsabilidade de recolhimento FABOV - Mato Grosso        
		0,;				//111 - Valor FACS - Mato Grosso
		cRecFac,; 		//112 - Reponsabilidade de recolhimento FACS - Mato Grosso        
		lCalcIPI,; 		//113 - Calcula IPI (SIGALOJA)
		0,;		 		//114 - Valor do FUMACOP
		0,;              //115 - Valor do Senar 
		0,;              //116 - Credito Outorgado SP
        0,;             //117 - Base do ICMS sem desconto - Decreto 43.080/02-MG
        0,;             //118 - Valor do ICMS sem desconto - Decreto 43.080/02-MG        
        0,;             //119 - Valor do Desconto - Decreto 43.080/02-MG
        0,;             //120 - Valor do ICMS sem debito de imposto - Decreto 43.080/02-MG        
        0,;				//121 - Base do FUNRURAL
        cPedido,;		//122 - Pedido de Venda       
        cCodMuni,;		//123 - Codigo do Municipio utilizado na operacao       
        {0,0},;			//124 - Valor TPDP - PB        
        0,;		        //125 - Valor incentivo prod.leite RICMS/MG
        0,;				//126 - Base de calculo do INSS Condições Especiais
        0,;            	//127 - Valor do INSS Condições Especiais
		0,;     		//128 - Valor do FECOP-RN
		0,;				//129 - Valor do FECOP ST-RN
		0,;				//130 - Credito Presumido                       
		0,;     		//131 - Valor do FECP-MG
		0,;				//132 - Valor do FECP ST-MG                       
		0,;             //133 - Valor do Reintegra
		0,;             //134 - Base de Calculo do Reintegra 
		0,;             //135 - Valor do FECP-MT
		0,;             //136 - Valor do FECP ST-MT 
		cRegeSim,;      //137 - Regime Simp. MT
		nPercAtm,;      //138 - Perc. Carga media
		cPessoa,;		//139 - Pessoa - Fisica/Juridica
		cNReduz,;		//140 - Nome Fantasia
		cCRDMA,;		//141 - Credito Estimulo de Manaus 
		cSimpSC,;       //142 - Clie. optante SIMPLES/SC
		cCDRDes,;       //143 - Regiao do Cliente   
		{cCliFat,cLojCFat,cTipoFat,cGrpCliFat,cNatCliFa},; //144 - Cliente, Loja, Tipo, Grupo e Natureza do cliente do Faturamento (utilizado para PIS e COFINS)
		0,;				//145 - Abatimentos de Materiais do ISS
		0,;				//146 - Abatimentos de Servicos do ISS
		0,;				//147 - Abatimentos de Materiais do INSS
		0,;				//148 - Abatimentos de Servicos do INSS     
		0,;				//149 - Adiantamento    
		nTotPed,;		//150 - Total do Pedido
		dDtEmiss,;		//151 - Emissao do documento
	    cIDSA1,;        //152 - ID Historico Cliente
		cIDSA2,;        //153 - ID Historico Fornecedor
		aInfNat[18],;    //154 - ID Historico NaturezaEndIf  
		0 ,;		     //155 - Total do Desconto do Item - USO DO NOVO PDV - LOJA		
		0 ,;		         //156 - Total do Acrescimos do Item - USO DO NOVO PDV - LOJA
		cTpFrete ,;		 //157 - Tipo de Frete definido no pedido de Venda
		cFRetIss ,;		//158 - Forma de Retencao do ISS. 1 - Considera Valor Minimo; 2 - Sempre Retem
		cUfOrig ,;		//159 - UF da prestacao do servico do ISS onde o servico foi prestado
		Array(NMAXUF),;	//160 -  Array com conteúdo da tabela CFC
		0,;				//161 -Valor Cide 
		nRecCide,;		//162 - Rec Cide				
		0,;				//163 - Valor do FETAHB retido pelo cliente/fornecedor	
		"",;			//164 - Modalidade CTE / SF1
		0,;          	//165 - NF_BASNDE
		0,;         	//166 -NF_ICMNDES		
		0}				//167 -Adiantamento (PERU)
EndIF

// -------------------------------------------------------------------------------------------------------------------------
// 									Carga das referencias vinculadas a tabela UF x UF
//  Foi necessario criar as referencias da tabela CFC no cabecalho e fazer o seek desta tabela na MaFisIni() para que nao
// seja preciso colocar o seek de UF x UF na funcao MaFisIniCpo(), evitando que sejam feitas duas consultas por item. Com
// esta mecanica, sera feito 1 seek no cabecalho com a chave UF x UF e 1 seek por item com a chave UF x UF x Produto.
//  Utilizo o PadR[TamSx3] na posicao 3 do indice (codigo do produto) para garantir que nao seja cacheado no cabecalho o 
// conteudo de um registro de item, onde o produto esteja preenchido.
// -------------------------------------------------------------------------------------------------------------------------
If aAliIndic[AI_CFC] .And. aFieldPos[FP_CFC_CODPRD] .And. CFC->( MsSeek( xFilial( "CFC" ) + cUfOrig + cUfDest + PadR( ' ' , TamSx3( 'CFC_CODPRD' )[1] ) ) )
	aNfCab[NF_UFXUF][UF_ALIQFECP]		:=	CFC->CFC_ALQFCP
	aNfCab[NF_UFXUF][UF_MARGSTLIQ]		:=	Iif( aFieldPos[FP_CFC_MGLQST] , CFC->CFC_MGLQST , 0		)
	aNfCab[NF_UFXUF][UF_ALIQSTLIQ]		:=	Iif( aFieldPos[FP_CFC_ALQSTL] , CFC->CFC_ALQSTL , 0		)
	aNfCab[NF_UFXUF][UF_MARGEM]			:=	Iif( aFieldPos[FP_CFC_MARGEM] , CFC->CFC_MARGEM , 0		)
	aNfCab[NF_UFXUF][UF_ALQFCPO]		:=	Iif( aFieldPos[FP_CFC_ALFCPO] , CFC->CFC_ALFCPO , 0		)
	aNfCab[NF_UFXUF][UF_FECPAUX]		:=	Iif( aFieldPos[FP_CFC_FCPAUX] , CFC->CFC_FCPAUX , 0		)
	aNfCab[NF_UFXUF][UF_FECPDIF]		:=	Iif( aFieldPos[FP_CFC_FCPXDA] , CFC->CFC_FCPXDA , '1'	)
	aNfCab[NF_UFXUF][UF_FECPINT]		:=	Iif( aFieldPos[FP_CFC_FCPINT] , CFC->CFC_FCPINT , '1'	)
	aNfCab[NF_UFXUF][UF_RDCTIMP]		:=  Iif( aFieldPos[FP_CFC_RDCTIM] , CFC->CFC_RDCTIM , 1)
Else
	aNfCab[NF_UFXUF][UF_ALIQFECP]		:=	0
	aNfCab[NF_UFXUF][UF_MARGSTLIQ]		:=	0
	aNfCab[NF_UFXUF][UF_ALIQSTLIQ]		:=	0
	aNfCab[NF_UFXUF][UF_MARGEM]			:=	0
	aNfCab[NF_UFXUF][UF_ALQFCPO]		:=	0
	aNfCab[NF_UFXUF][UF_FECPAUX]		:=	0
	aNfCab[NF_UFXUF][UF_FECPDIF]		:=	'1'
	aNfCab[NF_UFXUF][UF_FECPINT]		:=	'1'
	aNfCab[NF_UFXUF][UF_RDCTIMP]		:= 0
Endif	

// Inicializa arrays de impostos variaveis                    
aNfCab[NF_BASEIMP]:=Afill(aNfCab[NF_BASEIMP],0)
aNfCab[NF_VALIMP]:=Afill(aNfCab[NF_VALIMP],0)
aNfCab[NF_MINIMP]:=Afill(aNfCab[NF_MINIMP],0)
aNfCab[NF_VLRORIG]:=Afill(aNfCab[NF_VLRORIG],0)
// Cria o array de Referencias                                
If aItemRef == Nil
	MaIniRef()
EndIf
// Cria o array de arredondamentos do item                    
If aSaveDec == Nil
	aSaveDec := Array(Len(aItemRef))
	aFill(aSaveDec,0)
EndIf
If aAuxOri == Nil
	aAuxOri := {}
EndIf

RestArea(aAreaSA1)
RestArea(aAreaSA2)
RestArea(aArea)

Return(.T.)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡„o    ³MaFisIniLo³ Autor ³Edson Maricate         ³ Data ³09.12.1999 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo inicializar a variavel aNFItem ³±±
±±³          ³Rotina inicializacao do item da funcao Fiscal                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1: Item do Array ANFItem que deve ser inicializado       ³±±
±±³          ³ExpA2: Array de otimizacao de Inicializacao             (OPC)³±±
±±³          ³ExpL3: Indica se o item deve ser estornado caso exista       ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisIniLoad(nItem,aLoad,lEstorno)

DEFAULT lEstorno := .F.        

If !MaFisFound("IT",nItem)

	If aLoad == Nil
		aLoad := Array(13)
		aLoad[01] := IIf( aNfCab[NF_OPERNF] == "S" , Space(Len(SD2->D2_COD)) , Space(Len(SD1->D1_COD)))
		aLoad[02] := "   " 
		aLoad[03] := ""
		aLoad[04] := 0
		aLoad[05] := Space(Len(SD1->D1_NFORI))
		aLoad[06] := Space(Len(SD1->D1_SERIORI))
		aLoad[07] := 0
		aLoad[08] := 0
		aLoad[09] := Nil
		aLoad[10] := ""
		aLoad[11] := ""      
		aLoad[12] := Space(Len(aLoad[1])) 	// Codigo do Produto Fiscal 
		aLoad[13] := 0 						// Recno do Produto Fiscal 

	EndIf

	aadd(aNfItem,{"",;							//1 - Grupo de Tributacao
	{},;										//2 - Array contendo as excessoes Fiscais
	0,;											//3 - Aliquota de ICMS
	{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},;//4 - Valores de ICMS
	0,;											//5 - Aliquota de IPI
	{0,0,0,0,0},;								//6 - Valores de IPI
	aLoad[5],;	                                //7 - Numero da NF Original
	aLoad[6],;                                  //8 - Serie da NF Original
	aLoad[9],;	                                //9 - RecNo da NF original
	0,;											//10 - Valor do desconto do item
	0,;											//11 - Valor do Frete
	0,;											//12 - Valor da despesa
	0,;											//13 - Valor do seguro
	0,;											//14 - Valor do frete autonomo
	0,; 										//15 - Valor da Mercadoria
	aLoad[1],;                                  //16 - Codigo do produto
	aLoad[2],;                                 //17 - Codigo da TES
	0,;											//18 - Valor Total do item
	"    ",;									//19 - Codigo FIscal de Operacao
	0,;											//20 - Valor do Funrural
	0,;              							//21 - Aliquota para calculo do FunRural
	.F.,;										//22 - Flag de controle para itens deletados
	MaFisRetLF() ,;								//23 - Array Contendo o demonstrativo fiscal
	{0,0,0,aLoad[3],"","","",0,0,0},;	        //24 - Array contendo os valores de ISS
	{0,0,0,0},;									//25 - Array contendo os valores de IR
	{0,0,0,0,0},;								//26 - Array contendo os valores de INSS
	0 ,;										//27 - Valor da Embalagem
	Array(NMAXIV),;								//28
	Array(NMAXIV),;								//29
	Array(NMAXIV),;								//30
	0,;											//31
	0,;											//32
	Array(NMAXIV),;								//33
	aLoad[4],;		                         	//34
	0,;											//35
	0,;											//36
	0,;											//37
	0,;											//38
	0,;											//39
	0,;											//40
	0,;											//41
	0,;											//42
	0,;			  			  					//43
	0,;			  								//44
	0,;			  								//45
	0,;											//46
	0,;											//47
	0,;											//48
	aLoad[7],;			                        //49
	aLoad[8],;			                        //50
	0,;											//51
	aNFCAB[NF_TIPONF],;						    //52
	"",;										//53
	0,;											//54
	0,;											//55
	0,;											//56
	0,;											//57
	0,;											//58
	0,;											//59
	0,;											//60
	0,;											//61
	0,;											//62
	0,;                                 		//63
	0,;                                 		//64
	0,;                                 		//65
	0,;											//66 - AFRMM
	0,;											//67
	0,;											//68
	0,;											//69
	0,;											//70
	0,;											//71
	"",;										//72
	Iif(aNfCab[NF_OPERNF]=="S", "01", "0001"),;//73
	{0,0,0},;									//74 - Array contendo os valores do SEST
	0,;											//75 - Base de calculo do PIS Subst. Tributaria
	0,;			   								//76 - Aliquota do PIS Subst. Tributaria
	0,;											//77 - Valor do PIS Subst. Tributaria
	0,;											//78 - Bae da COFINS Subst. Tributaria
	0,;			   								//79 - Aliquota da COFINS Subst. Tributaria
	0,;			   								//80 - Valor da COFINS Subst. Tributaria
	0,;			   								//81 - Valor do Frete de Pauta
	0,;			   								//82 - Base FETHAB
	0,;			   								//83 - Aliquota FETHAB
	0,;			   								//84 - Valor FETHAB
	0,;											//85 - Abatimento do Valor do INSS em Valor - Subcontratada
	{"","","","","","",0,0,0,0,0,0,0,"",0},;  //86 - SPED
	0,;											//87 - Abatimento da base de calculo do ISS referente ao material utilizado
	"",;            							//88 - Indica se a operacao, mesmo sem calculo de ICMS ST, faz parte do Regime Especial de Substituicao Tributaria
	0,;											//89 - Percentual de UFERMS para o calculo do Fundersul - Mato Grosso do Sul
	0,;			   								//90 - Valor da UFERMS para o calculo do Fundersul - Mato Grosso do Sul
	0,;											//91 - Valor do Fundersul - Mato Grosso do Sul
	0,;											//92 - Valor do Estorno de Credito
	"",;	                 					//93 - Codigo Autorizacao CODIF - Combustiveis
	0,;											//94 - Base do ICMS de transporte Substituicao Tributaria
	0,;											//95 - Aliquota do ICMS de transporte Substituicao Tributaria
	0,;											//96 - Valor do ICMS de transporte Substituicao Tributaria
	0,;											//97 - Valor do credito presumido simples nacional - SC
	0,;											//98 - Valor Antecipacao ICMS
	0,;											//99 - Valor das despesas nao tributadas - Portugal
	0,;											//100 - Valor da Tara - Portugal
	aNFCab[NF_PROVENT],;            			//101 - Provincia de entrega
	0,;                             			//102 - Valor do FECP
	0,;                             			//103 - Valor do FECP ST
	0,;                             			//104 - Aliquota FECP
	0,;											//105 - Valor Credito Presumido - SC
	0,;											//106 - Valor do desconto total proporcionalizado
	{{"",0,0,0}},;                             //107 - Array para o calculo do IVA Ajustado
	{0,0},;										//108 - Array com os valores do Imposto de Importação
	0,;                          				//109 - Valor da Pauta do PIS
	0,;											//110 - Valor da Pauta do Cofins
	0,;                                         //111 - Aliquota de Diferencial Simples
	"   ",;										//112 - Classificacao fiscal
	0,;                                         //113 - Valor do imposto ISC (Localizado Peru) por unidade  "PER"
	0,;                                         //114 - Valor do credito presumido PE
	0,;                                         //115 - Valor Credito Presumido - MG
	0,;									   		//116 - Valor Dependente
	0,;											//117 - Credito Presumido CE
	0,;											//118 - Base FABOV - Mato Grosso
	0,; 										//119 - Aliquota FABOV - Mato Grosso
	0,;                                        	//120 - Valor FABOV - Mato Grosso
	0,;											//121 - Base FACS - Mato Grosso
	0,; 										//122 - Aliquota FACS - Mato Grosso
	0,;                                        	//123 - Valor FACS - Mato Grosso
	0,;                                        	//124 - Valor do FUMACOP
	0,;											//125 - Aliquota FUMACOP
	Space(5),;                                  //126 - Concepto de Retencao(Equador)
	"",;                                         //127 - moticms
	0,;                                        	//128 - Aliquota do Senar
	0,;                                        	//129 - Valor do Senar
	0,;											//130 - Base do Senar
	0,;						                    //131 - Valor do Credito Outorgado SP
	0,;						                    //132 - Abatimento do valor do INSS Subcontratada
	0,;						                    //133 - Base de calculo ICMS sem reducao - Decreto 43.080/02-MG
	0,;						                    //134 - Valor ICMS sem reducao - Decreto 43.080/02-MG
	0,;						                    //135 - Percentual de reducao - Decreto 43.080/02-MG
	0,;											//136 - Base do FUNRURAL
	0,;											//137 - Base Veiculo
	{0,0,0},;									//138 - Valor da Base(01)/Valor(02)/Aliquota(03) do Regime de Operacoes Simplificadas - MT
	0 ,;										//139 - Valor da Base do FUMACOP
	0, ;                                        //140 - Crédito Presumido PR
	{"","","",CToD("")},;						//141 - Array contendo as informacoes da Natureza da receita.
	{0,0,0},;                     				//142 - Array contendo as informacoes da TPDP.
	0,;                                         //143 - Valor incentivo prod.leite RICMS/MG
	0,;                             			//144 - Percentual incentivo prod.leite RICMS/MG
	{0,0,0},;                                  //145 - Array com valores do INSS Condições Especiais
	0,;                             			//146 - Valor do FECOP-RN
	0,;                             			//147 - Valor do FECOP ST-RN
	0,;                             			//148 - Aliquota FECOP-RN
	0,;											//149 - Valor do FUE - localização Austrália
	"",;										//150 - Método utilizado cálculo FUE - localização Austrália
	"2",;										//151 - NF Emitida sob norma específica
	0,;											//152 - Coeficiente de PIS por Substituição Tributária para fabricantes de cigarros
	0,;											//153 - Coeficiente de COFINS por Substituição Tributária para fabricantes de cigarros
	0,;											//154 - Credito Presumido.
	0,;											//155 - Preco Unitario utilizado para calculo da Substituição tributária para fabrixante de Cigarros
	"2",;							            //156 - Recolhimento Antecipado - Para atender necessidades do SPEDFISCAL de MG
	0,;                             			//157 - Valor do FECP-MG
	0,;                             			//158 - Valor do FECP ST-MG
	0,;                             			//159 - Aliquota FECP-MG
	0,;                             			//160 - Valor de Reintegra
	0,;                             			//161 - Base de Calculo do Reintegra
	0,; 			                            //162 - Valor da COFINS de Importacao Majorada
	0,;				                            //163 - Aliquota da COFINS de Importacao Majorada
	0,;                             			//164 - Valor do FECP-MT
	0,;                             			//165 - Valor do FECP ST-MT
	0,;                            		    	//166 - Aliquota FECP-MT
	Iif(Len(aLoad)>=10,{aLoad[10],aLoad[11]},{"",""}),; //167 - 1- Lote Produto / 2- Sub-Lote Produto
	"2",; 										//168 - DIAT - SC
	"2",;	                                    //169 - Campo de diferimento na tabela SB1 - Conteudo do parametro MV_ALQDFB1
	0,;                                         //170 - Indica o % calculo do ICMS-ST, se utiliza pauta ou margem.
	"",;        		                		// 171 - MaSBCampo("RSATIVO")
	"",;                            			// 172 - MaSBCampo("POSIPI")
	"",;        	   			                // 173 - MaSBCampo("UM")
	"",;          				                // 174 - MaSBCampo("SEGUM")
	0,;        				                    // 175 - MaSBCampo("AFABOV")
	0,;         				                // 176 - MaSBCampo("AFACS")
	0,;        				                    // 177 - MaSBCampo("AFETHAB")
	"",;        				                // 178 - MaSBCampo("TFETHAB")
	{},;    			                        // 179 - Array com a exceção fiscal do cliente do faturamento
	0,;											// 180 - Adiantamento
	"",;						            	// 181 - Codigo da Natureza da Operacao
	Array(NMAXSB) ,;	             			// 182 - Dados do cadastro de produtos SB1 ou SBi ou SBZ
	{"","",aNfCab[NF_IDSA1],aNfCab[NF_IDSA2],"","","",aNfCab[NF_IDSED],"","","", "",Array(9)},;  //183 - Array ID's Historico
	0,;                                         // 184 - DescTot - Desconto dado no Total, reteado por item - Uso do novo PDV - LOJA
	0,;            								// 185 - AcresciTot - Acrescimo dado no Total, reteado por item - Uso do novo PDV - LOJA
	0,; 			                            //186 - Valor da PIS de Importacao Majorada
	0,;				                            //187 - Aliquota da PIS de Importacao Majorada
	Iif( Len(aLoad)>11 , aLoad[12] , "" )  ,;	// 188 - Identificação do produto Fiscal  - Demetrio
	Iif( Len(aLoad)>12 , aLoad[13] , 0 )  ,;	// 189 - Recno do Produto Fiscal - Demetrio 
	"" ,;                                     	// 190 - NCM Fiscal
	Array(NMAXUFP),;							// 191 - Array com conteudo da tabela CFC
	0,;											// 192- Valor Cide
	"",;										// 193- Convênio 139/06
	0,;											//194 - VAlor do FETHAB retido pelo cliente
	0,;											// 195 - Aliquota do FECP ST
	0,;											// 196 - Aliquota do FECP Outros (Antecipacao/Diferencial de aliquotas)
	0,;   							      		//197 - NF_BASNDE
	0,; 										//198 -NF_ICMNDES	
	0})       								   	//199 -Adiantamento (PERU)

	If Len(aNfitem) > 1
		aNfitem[Len(aNfitem)][IT_ITEM] := Soma1(aNfitem[Len(aNfitem)-1][IT_ITEM])
	EndIf
	
	If !Empty( aNfItem[nItem][IT_PRODUTO] ) .And. ( aNfItem[nItem][IT_PRODUTO] <> aNfItem[nItem][IT_PRD][SB_COD] )
		MaFisIniCpo(nItem)
	ElseIf Empty( aNfItem[nItem][IT_PRODUTO] )
		MaFisIniCpo( nItem , .F.)
	EndIf

	// Inicializa arrays de impostos variaveis
	aNfItem[nItem][IT_BASEIMP]:=Afill(aNfItem[nItem][IT_BASEIMP],0)
	aNfItem[nItem][IT_ALIQIMP]:=Afill(aNfItem[nItem][IT_ALIQIMP],0)
	aNfItem[nItem][IT_VALIMP] :=Afill(aNfItem[nItem][IT_VALIMP],0)
	aNfItem[nItem][IT_DESCIV] :=Afill(aNfItem[nItem][IT_DESCIV],{"","",""})
	aadd(aItemDec,{Nil,Nil})
	aItemDec[Len(aItemDec)][1] := Array(Len(aItemRef))
	aItemDec[Len(aItemDec)][2] := Array(Len(aItemRef))
	aFill(aItemDec[Len(aItemDec)][1],0)
	aFill(aItemDec[Len(aItemDec)][2],0)
Else
	If lEstorno
		MaFisSomaIt(nItem,.F.)
	Endif
EndIf

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisAdd  ³ Autor ³ Edson Maricate        ³ Data ³09.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Inicializa o Calculo das operacoes Fiscais por item         ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisAdd(cProduto,;   	// 1-Codigo do Produto ( Obrigatorio )
cTes,;	   	// 2-Codigo do TES ( Opcional )
nQtd,;	   	// 3-Quantidade ( Obrigatorio )
nPrcUnit,;  // 4 -Preco Unitario ( Obrigatorio )
nDesconto,; // 5 -Valor do Desconto ( Opcional )
cNFOri,;	// 6 -Numero da NF Original ( Devolucao/Benef )
cSEROri,;	// 7 -Serie da NF Original ( Devolucao/Benef )
nRecOri,;	// 8 -RecNo da NF Original no arq SD1/SD2
nFrete,;	// 9 -Valor do Frete do Item ( Opcional )
nDespesa,;	// 10-Valor da Despesa do item ( Opcional )
nSeguro,;	// 11-Valor do Seguro do item ( Opcional )
nFretAut,;	// 12-Valor do Frete Autonomo ( Opcional )
nValMerc,;	// 13-Valor da Mercadoria ( Obrigatorio )
nValEmb,;	// 14-Valor da Embalagem ( Opiconal )
nRecSB1,;	// 15-RecNo do SB1
nRecSF4,;	// 16-RecNo do SF4
cNItem,;    // 17-Item
nDesNTrb,;  // 18-Despesas nao tributadas - Portugal
nTara,;		// 19-Tara - Portugal
cCfo,; 		// 20-CFO
aNfOri,;    // 21-Array para o calculo do IVA Ajustado (opcional)
cConcept,;	// 22-Concepto
nBaseVeic,;	// 23-Base Veiculo
nPLote,; 	// 24-Lote Produto
nPSubLot,;	// 25-Sub-Lote Produto
nAbatIss,;	// 26-Valor do Abatimento ISS
cCodISS,; 	// 27-Codigo ISS
cClasFis,;	// 28-Classificação Fiscal
cProdFis,;	// 29-Cod. do Produto Fiscal
nRecPrdF,;	// 30-Recno do Produto Fiscal
cNcmFiscal) // 31-NCM do produto Fiscal


Local aArea	:= GetArea()
Local nItem := 0

DEFAULT nRecSB1  := 0
DEFAULT nRecSF4  := 0
DEFAULT cNItem	 := ""
DEFAULT cCfo	 := ""
DEFAULT nDesNTrb := 0
DEFAULT nTara	 := 0
DEFAULT aNfOri	 := {}
DEFAULT cConcept := Space(5)
DEFAULT nBaseVeic:= 0
DEFAULT nAbatIss := 0
DEFAULT cCodISS	 := ""
DEFAULT cClasFis := ""       
DEFAULT cProdFis := Space(Len(cProduto))
DEFAULT nRecPrdF := 0
DEFAULT cNcmFiscal := ""


// Inicializa a TES utilizada no calculo de impostos
If cPaisLoc == "BRA"
	MaFisTes(@cTes,nRecSF4)
Endif

aadd(aNfItem,{"",;		         	        //1 - Grupo de Tributacao
{},;										//2 - Array contendo as excessoes Fiscais
0,;											//3 - Aliquota de ICMS
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},;//4 - Valores de ICMS
0,;											//5 - Aliquota de IPI
{0,0,0,0,0},;  							//6 - Valores de IPI
cNFOri,;          							//7 - Numero da NF Original
cSEROri,;									//8 - Serie da NF Original
nRecOri,;									//9 - RecNo da NF original
nDesconto,;									//10 - Valor do desconto do item
nFrete,;									//11 - Valor do Frete
nDespesa,;									//12 - Valor da despesa
nSeguro,;									//13 - Valor do seguro
nFretAut,;									//14 - Valor do frete autonomo
nValMerc,; 									//15 - Valor da Mercadoria
cProduto ,;									//16 - Codigo do produto
cTes	,;									//17 - Codigo da TES
0 ,;										//18 - Valor Total do item
cCfo,;										//19 - Codigo FIscal de Operacao
0 ,;										//20 - Valor do Funrural
0 ,;                     					//21 - Aliquota para calculo do FunRural
.F.,;										//22 - Flag de controle para itens deletados
MaFisRetLF() ,;	         					//23 - Array Contendo o demonstrativo fiscal
{0,0,0,cCodISS,"","","",0,0,0},;	        //24 - Array contendo os valores de ISS
{0,0,0,0},;							     	//25 - Array contendo os valores de IR
{0,0,0,0,0},;								//26 - Array contendo os valores de INSS
0,; 										//27 - Valor da Embalagem
Array(NMAXIV),;								//28
Array(NMAXIV),;								//29
Array(NMAXIV),;								//30
0,;											//31
0,;											//32
Array(NMAXIV),;								//33
nQtd ,;										//34
nPrcUnit,;									//35
0,;											//36
0,;											//37
0,;											//38
0,;											//39
0,;											//40
0,;											//41
0,;											//42
0,;			  			  					//43
0,;			  								//44
0,;			  								//45
0,;											//46
0,;											//47
0,;											//48
nRecSB1,;									//49
nRecSF4,;									//50
0,; 										//51
aNfCab[NF_TIPONF],;						    //52
"",;										//53
0,;											//54
0,;											//55
0,;											//56
0,;											//57
0,;											//58
0,;                                         //59
0,;     		                            //60
nAbatIss,;             		                //61
0,;                     		            //62
0,;                             		    //63
0,;      		                            //64
0,;             		                    //65
0,;											//66 - Base AFRMM - Item
0,;											//67 - Aliquota AFRMM - Item
0,;											//68 - Valor AFRMM - Item
0,;											//69
0,;											//70
0,;											//71
"",;										//72
Iif (aNfCab[NF_OPERNF]=='S', "01", "0001"),;	//73
{0,0,0},;										//74 - Array dos valores do SEST
0,;								//75 - Base de calculo do PIS Subst. Tributaria
0,;								//76 - Aliquota do PIS Subst. Tributaria
0,;								//77 - Valor do PIS Subst. Tributaria
0,;								//78 - Bae da COFINS Subst. Tributaria
0,;								//79 - Aliquota da COFINS Subst. Tributaria
0,;								//80 - Valor da COFINS Subst. Tributaria
0,;								//81 - Valor do Frete de Pauta
0,;								//82 - Base FETHAB
0,;								//83 - Aliquota FETHAB
0,;								//84 - Valor FETHAB
0,;             				//85 - Abatimento do Valor do INSS em Valor - Subcontratada
{"","","","","","",0,0,0,0,0,0,0,"",0},;
0,;             				//87 - Abatimento do Valor do ISS referente ao material utilizado})
"",;            				//88 - Indica se a operacao, mesmo sem calculo de ICMS ST, faz parte do Regime Especial de Substituicao Tributaria
0,;								//89 - Percentual de UFERMS para o calculo do Fundersul - Mato Grosso do Sul
0,;								//90 - Valor da UFERMS para o calculo do Fundersul - Mato Grosso do Sul
0,;								//91 - Valor do Fundersul - Mato Grosso do Sul
0,;								//92 - Valor do Estorno de Credito
"",;			                //93 - Codigo Autorizacao CODIF - Combustiveis
0,;  							//94 - Base do ICMS de transporte Substituicao Tributaria
0,;                            	//95 - Aliquota do ICMS de transporte Substituicao Tributaria
0,;								//96 - Valor do ICMS de transporte Substituicao Tributaria
0,;								//97 - Valor do credito presumido simples nacional - SC
0,;                             //98 - Valor Antecipacao ICMS
nDesNTrb,;						//99 - Valor das despesas nao tributadas - Portugal
nTara,;							//100 - Valor da Tara - Portugal
aNFCab[NF_PROVENT],;           //101 - Provincia de entrega
0,;                             //102 - Valor do FECP
0,;                             //103 - Valor do FECP ST
0,;                             //104 - Aliquota FECP
0,;								//105 - Valor Crédito Presumido SC
0,;								//106 - Valor do desconto total proporcionalizado
{{"",0,0,0}},;					//107 - Array para o calculo do IVA Ajustado
{0,0},;							//108 - Array com os valores do Imposto de Importação
0,;                          	//109 - Valor da Pauta do PIS
0,;								//110 - Valor da Pauta do Cofins
0,;		                        //111 -  Valor da Aliquota Dif para simples
cClasFis,;						//112 - IT_CLASFIS
0,;                             //113 - Valor do imposto ISC (Localizado Peru) por unidade "PER"
0,;	                            //114 - IT_CRPREPE Credito Presumido - Art. 6 Decreto  n28.247
0,;						   		//115 - Valor Crédito Presumido MG
0,;						   		//116 - Valor de desconto de dependente do fornecedor
0,;								//117 - Credito Presumido Ceara
0,;                             //118 - Base FABOV - Mato Grosso
0,;								//119 - Aliq FABOV - Mato Grosso
0,;                            	//120 - Valor FABOV - Mato Grosso
0,;                            	//121 - Base FACS - Mato Grosso
0,;								//122 - Aliq FACS - Mato Grosso
0,;                            	//123 - Valor FACS - Mato Grosso
0,;                            	//124 - Valor FUMACOP
0,;                            	//125 - Aliq FUMACOP
cConcept,;						//126 - Concepto Retencao(Equador)
"",;                            //127 moticms
0,;                            	//128 - Aliquota Senar
0,;                            	//129 - Valor Senar
0,;                            	//130 - Base Senar
0,;								//131 - Credito Outorgado SP
0,;                             //132- Abatimento do valor do INSS Subcontratada
0,;                             //133- Base de calculo ICMS sem reducao - Decreto 43.080/02-MG
0,;                             //134- Valor do ICMS sem reducao - Decreto 43.080/02-MG
0,;                             //135- Percentual de Reducao Decreto 43.080/02-MG
0,;								//136 - Base do FUNRURAL
nBaseVeic,;						//137 - Base Veiculo
{0,0,0},;						//138 - Valor da Base(01)/Valor(02)/Aliquota(03) do Regime de Operacoes Simplificadas - MT
0,;								//139 - Valor da Base do FUMACOP
0,; 							//140 - Valor do Créd Presumido do Paraná
{"","","",CToD("")},;	        //141 - Array Dados Natureza da opercao
{0,0,0},;  	                    //142 - Array da TPDP.
0,;                             //143 - Valor incentivo prod.leite RICMS/MG
0,;                             //144 - Percentual incentivo prod.leite RICMS/MG
{0,0,0},;                       //145 - Array com valores do INSS Condições Especiais
0,;                             //146 - Valor do FECOP-RN
0,;                             //147 - Valor do FECOP ST-RN
0,;								//148 - Aliquota FECOP-RN
0,;								//149 - Valor do FUE - localização Austrália
"",;                            //150 - Método utilizado cálculo FUE - localização Austrália
"2",;                      		//151 - NF Emitida sob norma específica
0,;								//152 - Coeficiente de PIS por Substituição Tributária para fabricantes de cigarros
0,;								//153 - Coeficiente de COFINS por Substituição Tributária para fabricantes de cigarros
0,;								//154 - Credito Presumido
0,;								//155 - Preco Unitario utilizado para calculo da Substituição tributária para fabrixante de Cigarros
"2",;                           //156 - Recolhimento Antecipado - Para atender necessidades do SPEDFISCAL de MG
0,;                             //157 - Valor do FECP-MG
0,;                             //158 - Valor do FECP ST-MG
0,;                             //159 - Aliquota FECP-MG
0,;                             //160 - Valor do Reintegra
0,;                             //161 - Base de Calculo do Reintegra
0,;                             //162 - Valor da COFINS de Importacao Majorada
0,;                            //163 - Aliquota da COFINS de Importacao Majorada
0,;                            //164 - Valor do FECP-MT
0,;                            //165 - Valor do FECP ST-MT
0,;                            //166 - Aliquota FECP-MT
{nPLote,nPSubLot},; 			//167 - 1- Lote Produto / 2- SubLoteProduto
"2",;							//168 - DIAT - SC
"2",;	                        //169 - Campo de diferimento na tabela SB1 - Conteudo do parametro MV_ALQDFB1
0,;                             //170 - Indica o % calculo do ICMS-ST, se utiliza pauta ou margem.
"",;        		                		// 171 - MaSBCampo("RSATIVO")
"",;                            			// 172 - MaSBCampo("POSIPI")
"",;        	   			                // 173 - MaSBCampo("UM")
"",;          				                // 174 - MaSBCampo("SEGUM")
0,;        				                    // 175 - MaSBCampo("AFABOV")
0,;         				                // 176 - MaSBCampo("AFACS")
0,;        				                    // 177 - MaSBCampo("AFETHAB")
"",;        				                // 178 - MaSBCampo("TFETHAB")
{},;                            //179 - Array com a exceção fiscal do cliente do faturamento
0,;								//180 - Adiantamento
"",;							//181 - Codigo da Natureza da Operacao
Array(NMAXSB) ,;	            //182 - Dados do cadastro de produtos SB1 ou SBi ou SBZ
{"","",aNfCab[NF_IDSA1],aNfCab[NF_IDSA2],"","","",aNfCab[NF_IDSED],"","","",Array(9)},; // 183 - Array ID's Historicos							
0,;                             // 184 - DescTot - Desconto dado no Total, reteado por item - Uso do novo PDV - LOJA
0,;      						// 185 - AcresciTot - Acrescimo dado no Total, reteado por item - Uso do novo PDV - LOJA
0,;                             //186 - Valor da PIS de Importacao Majorada
0,;                             //187 - Aliquota da PIS de Importacao Majorada         
cProdFis	 ,;					//188 - Identificação do produto Fiscal  - Demetrio
nRecPrdF	 ,;               	//189 - Recno do Produto Fiscal - Demetrio      
cNcmFiscal	 ,;                	//190 - NCM Fiscal
Array(NMAXUFP),;						// 191 - Array com conteudo da tabela CFC
0,;										// 192- Valor Cide
"",;                             //193- Convênio 139/06
0,;								//194 - VAlor do FETHAB retido pelo cliente
0,;										// 195 - Aliquota do FECP ST
0,;													// 196 - Aliquota do FECP Outros (Antecipacao/Diferencial de aliquotas)
0,;   							      		 //197 - NF_BASNDE
0,;								//198 -NF_ICMNDES
0})       						//199 - Adiantamento		    					

If Empty(cNItem)
	If Len(aNfitem) > 1
		aNfitem[Len(aNfitem)][IT_ITEM] := Soma1(aNfitem[Len(aNfitem)-1][IT_ITEM])
	EndIf
Else
	aNfitem[Len(aNfitem)][IT_ITEM] := cNItem
EndIf
aadd(aItemDec,{Nil,Nil})
aItemDec[Len(aItemDec)][1] := Array(Len(aItemRef))
aItemDec[Len(aItemDec)][2] := Array(Len(aItemRef))
aFill(aItemDec[Len(aItemDec)][1],0)
aFill(aItemDec[Len(aItemDec)][2],0)

nItem := Len(aNfItem)

If !Empty( aNfItem[nItem][IT_PRODUTO] ) .And. ( aNfItem[nItem][IT_PRODUTO] <> aNfItem[nItem][IT_PRD][SB_COD] )
	MaFisIniCpo(nItem)
ElseIf Empty( aNfItem[nItem][IT_PRODUTO] )
	MaFisIniCpo( nItem , .F. )
EndIf

// Inicializa arrays de impostos variaveis
aNfItem[nItem][IT_BASEIMP]:=Afill(aNfItem[nItem][IT_BASEIMP],0)
aNfItem[nItem][IT_ALIQIMP]:=Afill(aNfItem[nItem][IT_ALIQIMP],0)
aNfItem[nItem][IT_VALIMP] :=Afill(aNfItem[nItem][IT_VALIMP],0)
aNfItem[nItem][IT_DESCIV] :=Afill(aNfItem[nItem][IT_DESCIV],{"","",""})

MaFisRecal("",nItem)
MaIt2Cab()

RestArea(aArea)
Return(nItem)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisLoad ³ Autor ³ Edson Maricate        ³ Data ³09.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Carrega os valores de impostos de bases e item.             ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisLoad(cCampo,nValor,nItem)

Local cPosCpo  := MaFisScan(cCampo)

If nValor <> Nil
	// Altera o valor do campo no Array aNfCab ou aNfItem          
	If Substr(cCampo,1,2) == "IT"
		// Tratamento para os itens.                                   
		If ValType(cPosCpo) == "A"
			aNfItem[nItem][cPosCpo[1]][cPosCpo[2]] := nValor
		Else
			aNfItem[nItem][Val(cPosCpo)] := nValor
		EndIf

	    If AllTrim(cCampo) == "IT_PRODUTO" .And. !Empty( aNfItem[nItem][IT_PRODUTO] ) .And. ( aNfItem[nItem][IT_PRODUTO] <> aNfItem[nItem][IT_PRD][SB_COD] )
			MaFisIniCpo(nItem)
	    EndIf
	
	ElseIf Substr(cCampo,1,2) == "LF"
		// Tratamento para os itens do livro.                          
		If ValType(cPosCpo) == "A"
			aNfItem[nItem][IT_LIVRO][cPosCpo[1]][cPosCpo[2]] := nValor
		ElseIf ValType(cPosCpo) == "C"
			aNfItem[nItem][IT_LIVRO][Val(cPosCpo)] := nValor
		ElseIf ValType(cPosCpo) == "N"
			aNfItem[nItem][IT_LIVRO][cPosCpo] := nValor
		EndIf
	Else
		// Tratamento para o cabecalho.                                
		If ValType(cPosCpo) == "A"
			aNfCab[cPosCpo[1]][cPosCpo[2]] := nValor
		Else
			aNfCab[Val(cPosCpo)] := nValor
		EndIf
	EndIf
EndIf

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisEndLoad³ Autor ³ Edson Maricate      ³ Data ³09.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Finaliza a carga dos itens Fiscais                          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1 : Item                                                ³±±
±±³          ³ExpN2 : Tipo de atualizacao do Item :                       ³±±
±±³          ³        1-(default) Executa o recalculo de todos os itens   ³±±
±±³          ³                    para efetuar a atualizacao do cabecalho ³±±
±±³          ³        2-Executa a soma do item para atualizacao do cabeca ³±±
±±³          ³                    lho.                                    ³±±
±±³          ³        3-Nao executa a atualizacao do cabecalho.           ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisEndLoad(nItem,nTipo)

Local aArea   := GetArea()

DEFAULT nTipo := 1

MaFisTes(aNfItem[nItem][IT_TES],aNfItem[nItem][IT_RECNOSF4],nItem)
MaFisNameIV(,nItem)
MaFisVTot(nItem)
MaItArred(nItem)
MaFisLF(nItem)

Do Case
	Case nTipo == 1
		MaIt2cab()
	Case nTipo == 2
		MaFisSomaIt(nItem)
EndCase

If bFisRefresh <> Nil
	Eval(bFisRefresh)
EndIf

If bLivroRefresh <> Nil
	Eval(bLivroRefresh)
EndIf

RestArea(aArea)

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³ MaFisRet ³ Autor ³ Edson Maricate        ³ Data ³08.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna os impostos calculados pela MATXFIS.               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpN1: Valor do imposto.                                    ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisRet(nItem,cCampo)

Local nRetorno
Local cPosCpo := MaFisScan(cCampo)

Do Case
Case Substr(cCampo,1,2) == "IT"
	If ValType(cPosCpo) == "A"
		nRetorno := aNfItem[nItem][cPosCpo[1]][cPosCpo[2]]
	Else
		If nItem == Nil
			nRetorno := aNfItem[1][Val(cPosCpo)]
		Else
			nRetorno := aNfItem[nItem][Val(cPosCpo)]
		EndIf
	EndIf
Case Substr(cCampo,1,2) == "LF"
	If nItem == Nil
		nRetorno := aNfItem[nItem][NF_LIVRO][cPosCpo]
	Else
		nRetorno := aNfItem[nItem][IT_LIVRO][cPosCpo]
	EndIf
OtherWise
	If ValType(cPosCpo) == "A"
		nRetorno := aNfCab[cPosCpo[1]][cPosCpo[2]]
	Else
		nRetorno := aNfCab[Val(cPosCpo)]
	EndIf
EndCase

Return nRetorno

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡„o    ³MaColsToFi³ Autor ³Edson Maricate         ³ Data ³01.02.1999 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³Rotina carregamento da funcao fiscal com base no acols e     ³±±
±±³          ³aheader                                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpA1: Variavel com a estrutura do aHeader                   ³±±
±±³          ³ExpA2: Variavel com a estrutura do aCols                     ³±±
±±³          ³ExpN3: Item a ser carregado                             (OPC)³±±
±±³          ³ExpC4: Nome do programa                                 (OPC)³±±
±±³          ³ExpL5: Indica se o recalculo dos impostos deve ser feito(OPC)³±±
±±³          ³ExpL6: Indica se o recalculo dos impostos deve ser feito(OPC)³±±
±±³          ³ExpL7: Indica se o recalculo vai considerar as linhs apagadas³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo inicializar a variavel aNFItem ³±±
±±³          ³com base no aCols                                            ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaColsToFis(aHeader,aCols,nItem,cProg,lRecalc,lVisual,lDel,lSoItem)

Local nItemIni := IIf( nItem == Nil , 1 , nItem )
Local nItemAte := IIf( nItem == Nil , Len(aCols) , nItem )
Local nX       := 0
Local nY       := 0
Local cValid   := ""

DEFAULT lRecalc := .F.
DEFAULT lVisual	:= .F.
DEFAULT lDel    := .F.	//Indica que a linha deletada do acols nao sera considerada
DEFAULT lSoItem	:= .F.

If nItem == Nil
	MaFisClear()
EndIf

For nY := nItemIni To nItemAte
	MaFisIniLoad(nY,,.T.)
	For nX	:= 1 To Len(aHeader)
		cValid	 := AllTrim(UPPER(aHeader[nX][6]))
		cRefCols := MaFisGetRf(cValid)[1]
		If !Empty(cRefCols) .And. MaFisFound("IT",nY)
			MaFisLoad(cRefCols,aCols[nY][nX],nY)
		EndIf
	Next nX
	If lRecalc
		MaFisRecal("IT_",nY)
		For nX	:= 1 To Len(aHeader)
			cValid	 := AllTrim(UPPER(aHeader[nX][6]))
			cRefCols := MaFisGetRf(cValid)[1]
			If !Empty(cRefCols) .And. MaFisFound("IT",nY)
				aCols[nY][nX]:= MaFisRet(nY,cRefCols)
			EndIf
		Next nX
	EndIf
	MaFisEndLoad(nY,Iif(lVisual,3,If(lSoItem,2,Nil)))
	//Se a execucao da rotina considerar os itens deletados, executa a MAFISDEL
	If lDel .And. aCols[nY][Len(aHeader)+1]
		MaFisDel(nY,.T.)
	Endif
Next nY

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡…o    ³MaFisToCols³ Autor ³ Edson Maricate       ³ Data ³ 01.02.99 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Atualiza os valores do aCols com os valores da Funcao Fiscal³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisToCols(aHeader,aCols,nItem,cProg)

Local nItemIni := IIf( nItem == Nil , 1 , nItem )
Local nItemAte := IIf( nItem == Nil, Len(aCols) ,nItem )
Local nX       := 0
Local nY       := 0

For nY := nItemIni to nItemAte
	For nX := 1 to Len(aHeader)
		cValid	:= AllTrim(UPPER(aHeader[nX][6]))
		cRefCols:= MaFisGetRF(cValid)[1]
		If !Empty(cRefCols) .And. MaFisFound("IT",nY)
			aCols[nY][nX]:= MaFisRet(nY,cRefCols)
		EndIf
	Next nX
Next nY

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡„o    ³MaFisSXRef³ Autor ³ Eduardo Riera         ³ Data ³08.08.2001 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³Rotina de avalicao das referencias existentes para um deter- ³±±
±±³          ³minada tabela no dicionario de dados                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Tabela do Dicionario de dados                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpA1: Array com as referencias da funcao fiscal             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo verificar e retornar as referen³±±
±±³          ³cias da funcao fiscal com base no dicionario de dados, para  ³±±
±±³          ³recuperar os valores da funcao fiscal                        ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisSXRef(cAlias)

Local aArea    := GetArea()
Local aRefer   := {}
Local nX       := 0

DEFAULT aRefSX3 := {}

If aScan(aRefSx3,{|x| x[1] == cAlias}) == 0 // Verifica se o alias solicitado esta no cache de memoria e adiciona as referencia ao cache de memoria
	MaFisRelImp("",{cAlias})
EndIf

For nX := 1 To Len(aRefSX3) // Obtem os dados do cache
	If aRefSX3[nX][1] == cAlias
		aadd(aRefer,{aRefSX3[nX][2],aRefSX3[nX][3]})
	EndIf
Next nX

RestArea(aArea)

Return(aRefer)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡…o    ³MaFisRelImp³ Autor ³ Edson Maricate       ³ Data ³21.02.2000³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Retorna um array contendo todos os impostos suportados pelos³±±
±±³          ³arquivos passados para a funcao.                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1 : Codigo de referencia ao programa                    ³±±
±±³          ³ExpA2 : Array contendo o Alias dos arquivos                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³MATA103,MATA116,MATA119,MATA150,MATA120,MATA930             ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisRelImp(cProg,aAlias)

Local aArea		:= GetArea()
Local aAreaSX3	:= SX3->(GetArea())
Local aRet		:= {}
Local nX        := 0
Local nY        := 0

DEFAULT aRefSX3 := {}

dbSelectArea("SX3")
dbSetOrder(1)

For nX 	:= 1 to Len(aAlias) 

	If aScan(aRefSX3,{|x| x[1] == aAlias[nX]}) == 0 // Verifica se o alias solicitado esta no cache de memoria e adiciona as referencia ao cache de memoria 
		MsSeek(aAlias[nX])
		While !SX3->(Eof()) .And. SX3->X3_ARQUIVO == aAlias[nX]
			If "MAFISREF"$AllTrim(UPPER(SX3->X3_VALID))
				// Cria o Array contendo a relacao Campo x Referencia 
				// [RELIMP] : [1] - Alias                             
				//            [2] - Campo                             
				//            [3] - Referencia      
				                  
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³Tratamento para o campo F1_II que em NFs do SIGAEIC nao pode carregar o ³
				//³valid pois zera o calculo, porem em Notas de importacao feitas no SIGACOM o VALID deve existir.³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If !(AllTrim(X3_CAMPO) == "F1_II" .And. ("MAFISREF"$UPPER(X3_VALID)) .And. aParSX6[MV_EASY] == "S")
				  aadd( aRefSX3 , { aAlias[nX] , AllTrim(X3_CAMPO) , MaFisGetRF(SX3->X3_VALID)[1] } )
				EndIf
			EndIf
			dbSkip()
		EndDo
	EndIf
                 
	For nY := 1 To Len(aRefSX3) // Obtem as referencias do cache de memoria    
		If aRefSx3[nY][1] == aAlias[nX]
			aadd( aRet , { aAlias[nX] , aRefSx3[nY][2] , aRefSx3[nY][3] } )
		EndIf
	Next nY

Next nX

RestArea(aAreaSX3)
RestArea(aArea)

Return aRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisDel  ³ Autor ³ Edson Maricate        ³ Data ³21.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Marca/Desmarca o item especificado como deletado.           ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1	: Numero do Item.                                     ³±±
±±³          ³ExpL2 : .T. - Deleta o item , .F. - Ativa o item            ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisDel(nItem,lDelete)

Local nI := 0

If MaFisFound("IT",nItem)
	If lDelete
		If !aNfItem[nItem][IT_DELETED]
			
			aNfItem[nItem][IT_DELETED]	:= .T.
			
			If cPaisLoc <> "BRA"
				MaFisRecal(,nItem)
			EndIf

		Endif
	Else
		If aNfItem[nItem][IT_DELETED]
			
			aNfItem[nItem][IT_DELETED]	:= .F.
			
			If cPaisLoc <> "BRA"
				MaFisRecal("IT_VALMERC",nItem)
			Endif
			
		EndIf
	EndIf
	
	If cPaisLoc == "BRA" .And. ( lLimInss .Or. aParSX6[MV_ISSPRG] == "S" )
		For nI := 1 to Len(aNfItem)
			If lLimInss
				MaFisINSS(nI,"VLR")
			Endif
			If aParSX6[MV_ISSPRG] == "S"
				MaFisISS(nI)
				MaFisLF(nI)
			EndIf
		Next nI
	EndIf
	
	MaIt2Cab()
	
EndIf

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡…o    ³ MaFisRef ³ Autor ³ Edson Maricate        ³ Data ³ 10.12.99 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Executa o calculo dos valores do item da NF.               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpC1 = Referencia                                         ³±±
±±³          ³ ExpC2 = Identificador do arquivo                           ³±±
±±³          ³ ExpC1 = Valor da Referencia                                ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisRef(cReferencia,cProg,xValor)

Local aArea	   := GetArea()
Local lRet 	   := .T.
Local nX       := 0
Local nY       := 0
Local cValid   := ""
Local cRefCols := ""

If MaFisFound("NF")
	If SubStr(cReferencia,1,2) == "NF"
		If lRet := MaFisVldAlt(cReferencia)
			MaFisAlt(cReferencia,xValor)
			For nY := 1 to Len(aCols)
				If MaFisFound("IT",nY)
					For nX	:= 1 to Len(aHeader)
						cValid	:= AllTrim(UPPER(aHeader[nX][6]))
						If "MAFISREF"$cValid
							nPosRef := AT('MAFISREF("',cValid) + 10
							cRefCols:=Substr(cValid,nPosRef,AT('","'+cProg+'",',cValid)-nPosRef )
							aCols[nY][nX]:= MaFisRet(nY,cRefCols)
						EndIf
					Next nX
				EndIf
			Next nY
		EndIf
	Else
		If MaFisFound("IT",N)
			If aNfItem[N][IT_DELETED] .And. IIf(Len(aCols[1])==Len(aHeader)+1,!aCols[N][Len(aHeader)+1],.F.)
				MaFisDel(N,.F.)
			EndIf
			If GdFieldPos("D1_ITEM")>0
				aNfItem[N][IT_ITEM] := aCols[N][GdFieldPos("D1_ITEM")]
			EndIf
		EndIf
		MaFisIniLoad(n)
		If lRet := MaFisVldAlt(cReferencia,n)
			MaFisAlt(cReferencia,xValor,n)
			For nX	:= 1 to Len(aHeader)
				cValid	:= AllTrim(UPPER(aHeader[nX][6]))
				If "MAFISREF"$cValid
					nPosRef := AT('MAFISREF("',cValid) + 10
					cRefCols:=Substr(cValid,nPosRef,AT('","'+cProg+'",',cValid)-nPosRef )
					aCols[n][nX]:= MaFisRet(n,cRefCols)
				EndIf
			Next nX
		EndIf
	EndIf

	Eval(bRefresh)

EndIf

RestArea(aArea)

Return lRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisAlt  ³ Autor ³ Edson Maricate        ³ Data ³09.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Altera os valores de impostos e bases do item.              ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisAlt(cCampo,nValor,nItem,lNoCabec,nItemNao,lDupl,cRotina,lRecal)

Local aArea       := GetArea()
Local aRef        := {}
Local cPosCpo     := ""
Local nPos        := 0
Local nValAnt     := 0
Local nPosItDec   := 0
Local cCpoTxMoeda := IIf( cPaisLoc $ "PER" , "/NF_TXMOEDA" , "" )
Local lCDAIndic	  := aAliIndic[AI_CDA]

DEFAULT lNoCabec := .F.
DEFAULT nItemNao := 0
DEFAULT lDupl    := .F.
DEFAULT cRotina  := ""
DEFAULT lRecal   := .T.

If aParSX6[MV_RSATIVO]
	lRastItem := .T.
EndIf

If nValor <> Nil
	Do Case
		Case Substr(cCampo,1,2) == "IT"
			
			If MaFisFound("IT",nItem)
				If MaFisRet(nItem,cCampo) <> nValor
					
					If !lNocabec
						MaFisSomaIt(nItem,.F.,cCampo)
					EndIf
					
					cPosCpo	:= MaFisScan(cCampo)
					
					// Tratamento para os itens.
					If ValType(cPosCpo) == "A"
						aNfItem[nItem][cPosCpo[1]][cPosCpo[2]] := nValor
					Else
						aNfItem[nItem][Val(cPosCpo)] := nValor
					EndIf
					
					If AllTrim(cCampo) == "IT_PRODUTO" .And. !Empty( aNfItem[nItem][IT_PRODUTO] ) .And. ( aNfItem[nItem][IT_PRODUTO] <> aNfItem[nItem][IT_PRD][SB_COD] )
						MaFisIniCpo(nItem)
					EndIf
					
					// Tratamento especifico e diferenciado para cada campo.
					If lRecal
						MaFisRecal(cCampo,nItem)
					EndIf
					
					If !lNoCabec
						MaFisSomaIt(nItem)
						If bFisRefresh <> Nil
							Eval(bFisRefresh)
						EndIf
						If bLivroRefresh <> Nil
							Eval(bLivroRefresh)
						EndIf
					EndIf
					
					If cPaisLoc == "BRA" .And. lCDAIndic .And. Type("oLancApICMS") == "O"
						a103AjuICM(nItem)
					EndIf
					
				EndIf
			EndIf
			
		Case Substr(cCampo,1,2) == "NF"

			If MaFisFound("NF")

				If MaFisRet(,cCampo) <> nValor .Or. lDupl

					cPosCpo	:= MaFisScan(cCampo)

					// Tratamento para o cabecalho.
					If ValType(cPosCpo) == "A"
						nValAnt	:= aNfCab[cPosCpo[1]][cPosCpo[2]]
						aNfCab[cPosCpo[1]][cPosCpo[2]] := nValor
					Else
						nValAnt	:= aNfCab[Val(cPosCpo)]
						aNfCab[Val(cPosCpo)] := nValor
					EndIf

					// Tratamento especifico e diferenciado para cada campo.
					Do Case
						Case AllTrim(cCampo)$"NF_CODCLIFOR/NF_LOJA/NF_TIPONF/NF_OPERNF/NF_CLIFOR/NF_NATUREZA"+cCpoTxMoeda
							
							// Reinicia os valores de arredondamento dos impostos contidos no aSaveDec.
							If AllTrim(cCampo)$"NF_NATUREZA"
								aRef := {"IT_VALISS","IT_VALIRR","IT_VALINS","IT_VALCOF","IT_VALCSL","IT_VALPIS","IT_VALPS2","IT_VALCF2","IT_VALPS3","IT_VALCF3"}
								For nPos := 1 to Len(aItemRef)
									If !Empty(aScan(aRef,aItemRef[nPos,1]))
										aSaveDec[nPos] := 0
									EndIF
								Next nPos
							Else
								aSaveDec := Nil
							EndIf
							
							MaFisIni( NIL, NIL, NIL, NIL, NIL, NIL, NIL, NIL, NIL, cRotina, NIL, NIL, NIL, NIL, aNfCab[NF_RECISS] )
							
							For nItem := 1 To Len(aNfItem)

								If AllTrim(cCampo)$"NF_CODCLIFOR"
									aNfItem[nItem, IT_EXCECAO]	:=	{}
									
									// Quando estiver alterando o cliente/fornecedor, necessito a chamada da MaFisIniCpo para recarregar as referencias
									// da amarracao UF x UF x Produto (tabela CFC).
									MaFisIniCpo( nItem )
									
									//Como zero o array aSaveDec acima, preciso zerar o aItemDec tambem, para nao dar diferenca na funcao MaItArred
								ElseIf AllTrim(cCampo)$"NF_NATUREZA"
									For nPos := 1 to Len(aRef)
										nPosItDec	:=	aScan(aItemRef,{|aX| aX[1]==aRef[nPos]})
										If !Empty(nPosItDec)
											If Len(aItemDec[nItem][1])>=nPosItDec
												aItemDec[nItem][1][nPosItDec]	:=	0
											EndIf
											If Len(aItemDec[nItem][2])>=nPosItDec
												aItemDec[nItem][2][nPosItDec]	:=	0
											EndIf
										EndIf
									Next nPos
								EndIf

								MaFisRecal(cCampo,nItem)
								
								If cPaisLoc == "BRA" .And. lCDAIndic .And. Type("oLancApICMS") == "O"
									a103AjuICM(nItem)
								EndIf

							Next nItem

							If !lNoCabec
								MaIt2Cab()
							EndIf

					    Case AllTrim(cCampo)$"NF_UFDEST/NF_UFORIGEM/NF_SUFRAMA/NF_AUXACUM/NF_RECISS"+Iif(cPaisLoc <> "BRA","/NF_SERIENF/NF_PROVENT","")+Iif(cPaisLoc == "COL".Or.cPaisLoc=="BRA","/NF_CODMUN","")+"/NF_PNF_COD/NF_PNF_LOJ/NF_PNF_UF/NF_PNF_TPCLIFOR/NF_DTEMISS/NF_MODAL"

							For nItem := 1 To Len(aNfItem)
								If AllTrim(cCampo)$"NF_UFDEST"
									aNfItem[nItem, IT_EXCECAO]	:=	{}
									If cPaisLoc == "ARG"
										aTes[TS_CODIGO] := "   "
									Endif
								EndIf

								MaFisRecal(cCampo,nItem)

								If !lNoCabec .And. cPaisLoc <> "BRA"
									MaFisSomaIt(nItem)
									If bFisRefresh <> Nil
										Eval(bFisRefresh)
									EndIf
									If bLivroRefresh <> Nil
										Eval(bLivroRefresh)
									EndIf
								EndIf
							Next nItem
							
							If !lNoCabec
								MaIt2Cab()
							EndIf
							// Atualizacao/recalculo dos valores na alteracao da moeda e taxa
						Case cPaisLoc == "ARG" .And. ((nValAnt <> nValor .Or. lDupl) .And. ValType(nValor) == "N" ) .And. (AllTrim(cCampo)$"NF_MOEDA/NF_TXMOEDA/")
							For nItem := 1 To Len(aNfItem)
								MaFisRecal(Alltrim(cCampo),nItem)
							Next
							If !lNoCabec
								MaIt2Cab()
							Endif
							//	Atualizacao/recalculo dos valores na alteracao dos valores na aba de impostos
						Case cPaisLoc == "ARG" .And. 'NF_VALIV'$AllTrim(cCampo)
							MaFisRatRes("IT"+Substr(cCampo,3,Len(cCampo)-2),nValor,aNfCab[NF_IMPOSTOS][nItem][IMP_ALIQ],'IT_ALIQ'+aNfCab[NF_IMPOSTOS][nItem][IMP_NOME],'IT_BASE'+aNfCab[NF_IMPOSTOS][nItem][IMP_NOME],nItemNao)
							For nItem := 1 to Len(aNfItem)
								MaFisRecal("IT"+Substr(cCampo,3,Len(cCampo)-2),nItem)
							Next nItem
							If !lNoCabec
								MaIt2Cab(nItemNao)
							EndIf
						OtherWise
							If ((nValAnt <> nValor .Or. lDupl) .And. ValType(nValor) == "N" ) .And. !(AllTrim(cCampo)$"NF_MOEDA/NF_TXMOEDA/") .And. !'NF_MINIV'$AllTrim(cCampo) .And.!'NF_MINIMP'$AllTrim(cCampo)
								If AllTrim(cCampo)$"NF_FRETE/NF_SEGURO/NF_DESPESA/NF_DESCONTO/NF_DESCTOT/NF_ACRESCI/NF_VLR_FRT/NF_DESNTRB/NF_TARA/NF_ADIANTTOT"
									For nItem := 1 To Len(aNfItem)
										aFill(aItemDec[nItem][1],0)
										aFill(aItemDec[nItem][2],0)
									Next nItem
									aFill(aSaveDec,0)
								EndIf
								MaRateio("IT"+Substr(cCampo,3,Len(cCampo)-2),nValAnt,nValor,lDupl)
								For nItem := 1 To Len(aNfItem)
									MaFisRecal("IT"+Substr(cCampo,3,Len(cCampo)-2),nItem)
									If cPaisLoc=="BRA" .And. lCDAIndic .And. Type("oLancApICMS")=="O"
										a103AjuICM(nItem)
									EndIf
								Next nItem
								If !lNoCabec
									MaIt2Cab()
								EndIf
							EndIf
					EndCase
				EndIf
			EndIf
		Case Substr(cCampo,1,3) == "IMP"
			If cCampo == "IMP_VALRUR"
				cCampo := "IMP_FUNRURAL"
				MaFisRatRes("IT_FUNRURAL",nValor,aNfCab[NF_IMPOSTOS][nItem][IMP_ALIQ],"IT_PERFUN","",nItemNao)
			Else
				MaFisRatRes("IT"+Substr(cCampo,4,Len(cCampo)-3),nValor,aNfCab[NF_IMPOSTOS][nItem][IMP_ALIQ],'IT_ALIQ'+aNfCab[NF_IMPOSTOS][nItem][IMP_NOME],'IT_BASE'+aNfCab[NF_IMPOSTOS][nItem][IMP_NOME],nItemNao)
			EndIf
			For nItem := 1 to Len(aNfItem)
				If nItem <> nItemNao
					MaFisRecal("IT"+Substr(cCampo,4,Len(cCampo)-3),nItem)
				Endif
			Next nItem
			If !lNoCabec
				MaIt2Cab(nItemNao)
			EndIf
	EndCase
EndIF

RestArea(aArea)

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisRecal³ Autor ³  Edson Maricate       ³ Data ³20.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Recalcula os valores de impostos do item.                   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Campo que sofreu alteracao.                          ³±±
±±³          ³ExpN2: Item.                                                ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisRecal(cCampo,nItem)

DEFAULT cCampo	:=	""

If AllTrim(cCampo) == "IT_PRODUTO" .And. !Empty( aNfItem[nItem][IT_PRODUTO] ) .And. ( aNfItem[nItem][IT_PRODUTO] <> aNfItem[nItem][IT_PRD][SB_COD] )
	MaFisIniCpo(nItem)
EndIf

If aNfItem[nItem][IT_TES] <> aTes[TS_CODIGO]
	MaFisTes(aNfItem[nItem][IT_TES],aNfItem[nItem][IT_RECNOSF4],nItem)
EndIf

Do Case
	Case AllTrim(cCampo) == "IT_CF"
		If cPaisLoc == "BRA"
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisII(nItem)
				MaFisVTot(nItem)
			EndIf
		EndIf
		MaItArred(nItem)
		MaFisLF(nItem)
		MaFisTPDP(nItem)
		If cPaisLoc $ "ARG|COL"
			MaFisImpIV(nItem,cCampo)
			MaFisNameIV(,nItem)
			MaFisVTot(nItem)
		Endif
	Case AllTrim(cCampo) == "IT_VALMERC"
		aNfItem[nItem][IT_DESCZF] := 0
		If cPaisLoc == "BRA"
			MaAliqSoli(nItem)
			MaExcecao(nItem)
			MaMargem(nItem)
		Endif
		MaFisPreCalc(nItem,cCampo)
		If cPaisLoc == "BRA"
			MaFisIPI(nItem,"BSE|VLR")
			MaFisBSICM(nItem)
			MaALIQCMP(nItem)										
			MaFisVICMS(nItem)
			If !( aTes[TS_TPIPI]=="B" .Or. (aParSX6[MV_IPIBRUT]=="S" .And. aTes[TS_TPIPI] ==" ") ) .And. ( aTes[TS_AGREG]=="D" .Or. aTes[TS_AGREG]=="R" )
				MaFisIPI(nItem,"BSE|VLR")
			EndIf
			MaItArred(nItem, { "IT_BASEICM","IT_VALICM" } )
			MaFisVComp(nItem)
			MaFisVDescZF(nItem)
			MaFisBSSol(nItem)
			MaFisVSol(nItem)
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisCOFINS(nItem,"CF2")
				MaFisPIS(nItem,"PS2")
				If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
					MaFisIPI(nItem,"BSE|VLR")
					If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
						MaFisBSICM(nItem,,.T.)
						MaFisVICMS(nItem)
					ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
						MaFisBSICM(nItem,,.T.)
						MaFisVICMS(nItem) 
						MaFisVDescZF(nItem) 
						MaFisPIS(nItem,"PS2")   
						MaFisCOFINS(nItem,"CF2")
					EndIf 
					MaFisBSSol(nItem)
					MaFisVSol(nItem)
				EndIf
			EndIf
			MaFisRURAL(nItem)
			MaFisVSul(nItem)
			MaFisCOFINS(nItem,"CF3")
			MaFisVTot(nItem)
			MaFisPIS(nItem,"PS3")
			If aTes[TS_BCPCST] == "1" //Campo que indica se os valores de PIS/COFINS ST entram na base de ICMS-ST
				MaFisBSSOL(nItem)
				MaFisVSol(nItem)
			EndIf
			MaFisVTot(nItem)
			MaFisSENAR(nItem)
			MaFisAliqIV(,nItem)
			MaFisBSIV(,nItem)
			MaFisVLIV(,nItem)
			MaFisTPDP(nItem)
		Else
			MaFisImpIV(nItem,cCampo)
		Endif
		MaFisNameIV(,nItem)
		If cPaisLoc == "BRA" .And. !( aTes[TS_AGREG] $ "B|C"	)
			MaFisCOFINS(nItem,"CF2")
			MaFisPIS(nItem,"PS2")
			If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
				MaFisIPI(nItem,"BSE|VLR")
				If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
					MaFisBSICM(nItem,,.T.)
					MaFisVICMS(nItem) 
				ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
						MaFisBSICM(nItem,,.T.)
						MaFisVICMS(nItem) 
						MaFisVDescZF(nItem) 
						MaFisPIS(nItem,"PS2")   
						MaFisCOFINS(nItem,"CF2")
				EndIf 
				MaFisBSSol(nItem)
				MaFisVSol(nItem)
			EndIf
		EndIf
		If aTes[TS_OPERSUC] == "1"
			MaFisBsIcm(nItem)
			MaFisVICMS(nItem)
			MaItArred(nItem, { "IT_BASEICM","IT_VALICM" } )
		Endif	
		MaFisVTot(nItem)
		If cPaisLoc == "BRA"
			MaFisINSS(nItem,"BSE|VLR")
			MaFisIR(nItem)
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisCOFINS(nItem,"COF")
				MaFisPIS(nItem,"PIS")
			EndIF
			MaFisCSLL(nItem)
			MaFisSEST(nItem)
			MaFisCOFINS(nItem,"CF3")
			MaFisISS(nItem)
			MaFisVTot(nItem)
			MaFisPIS(nItem,"PS3")
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisII(nItem)
			EndIf
			If aTes[TS_BCPCST] == "1" //Campo que indica se os valores de PIS/COFINS ST entram na base de ICMS-ST
				MaFisBSSOL(nItem)
				MaFisVSol(nItem)
			EndIf
			MaFisVTot(nItem)
		Endif
		MaItArred(nItem)
		If cPaisLoc == "BRA"
			MaFisLF(nItem)
			MaFisAFRMM(nItem)
			MaFisFFF(nItem)
		EndIf
	Case AllTrim(cCampo) == "IT_BASEICM"
		MaAliqSoli(nItem)
		MaExcecao(nItem)
		MaMargem(nItem)
		MaFisVICMS(nItem)
		MaFisTPDP(nItem)
		If !( aTes[TS_TPIPI]=="B" .Or. (aParSX6[MV_IPIBRUT]=="S" .And. aTes[TS_TPIPI] ==" ") )	.And. ( aTes[TS_AGREG]=="D" .Or. aTes[TS_AGREG]=="R" )
			MaFisIPI(nItem,"BSE|VLR")
		EndIf
		MaItArred(nItem, { "IT_BASEICM","IT_VALICM" } )
		MaFisVComp(nItem)
		MaFisBSSol(nItem)
		MaFisVSol(nItem)
		If !( aTes[TS_AGREG] $ "B|C"	)
		   
			// Quando necessário ajuste de centavos na base de calculo do ICMS, o sistema não pode mudar os valores da base de calculo do PIS e COFINS importação.
			If !(aNFCab[NF_OPERNF] == "E" .And. aNFCab[NF_CLIFOR] =="F" .And. aNFCab[NF_TPCLIFOR] =="X" .And. Substr(aNfItem[nItem][IT_CF],1,1)=="3" .And. aTes[TS_INTBSIC]$"123") 
				MaFisCOFINS(nItem,"CF2")
				MaFisPIS(nItem,"PS2")
			Endif   
			
			If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
				MaFisIPI(nItem,"BSE|VLR")
				If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
					MaFisBSICM(nItem,,.T.)
					MaFisVICMS(nItem)
				ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
					MaFisBSICM(nItem,,.T.)
					MaFisVICMS(nItem) 
					MaFisVDescZF(nItem) 
					MaFisPIS(nItem,"PS2")   
					MaFisCOFINS(nItem,"CF2")
				EndIf 
				MaFisBSSol(nItem)
				MaFisVSol(nItem)
			EndIf
		EndIf
		MaFisVTot(nItem)
		MaFisINSS(nItem,"BSE|VLR")
		MaFisIR(nItem,"BSE|VLR")
		If !( aTes[TS_AGREG] $ "B|C"	)
			MaFisCOFINS(nItem,"COF")
			MaFisPIS(nItem,"PIS")
		EndIf
		MaFisCSLL(nItem)
		MaFisCOFINS(nItem,"CF3")
		MaFisVTot(nItem)
		MaFisPIS(nItem,"PS3")
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
		MaFisSEST(nItem)
	Case AllTrim(cCampo) == "IT_ALIQICM"
		If aTes[TS_AGREG] $ "I,A,D,R,E"  
			MaFisBsICM( nItem , , , , cCampo )
		Endif
		MaAliqSoli(nItem)
		MaFisVICMS(nItem)
		MaFisTPDP(nItem)
		If !( aTes[TS_TPIPI]=="B" .Or. (aParSX6[MV_IPIBRUT]=="S" .And. aTes[TS_TPIPI] ==" ") )	.And. ( aTes[TS_AGREG]=="D" .Or. aTes[TS_AGREG]=="R" )
			MaFisIPI(nItem,"BSE|VLR")
		EndIf
		MaItArred(nItem, { "IT_BASEICM","IT_VALICM" } )
		MaFisVComp(nItem)
		MaFisVSol(nItem)
		If !( aTes[TS_AGREG] $ "B|C"	)
			MaFisCOFINS(nItem,"CF2")
			MaFisPIS(nItem,"PS2")
			If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
				MaFisIPI(nItem,"BSE|VLR")
				If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
					MaFisBSICM(nItem,,.T.,,cCampo)
					MaFisVICMS(nItem)
				ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
					MaFisBSICM(nItem,,.T.)
					MaFisVICMS(nItem) 
					MaFisVDescZF(nItem) 
					MaFisPIS(nItem,"PS2")   
					MaFisCOFINS(nItem,"CF2")
				EndIf 
				MaFisBSSol(nItem)
				MaFisVSol(nItem)
			EndIf
		EndIf
		MaFisVTot(nItem)
		MaFisINSS(nItem,"BSE|VLR")
		MaFisIR(nItem,"BSE|VLR")
		If !( aTes[TS_AGREG] $ "B|C"	)
			MaFisCOFINS(nItem,"COF")
			MaFisPIS(nItem,"PIS")
		EndIf
		MaFisCSLL(nItem)
		MaFisCOFINS(nItem,"CF3")
		MaFisVTot(nItem)
		MaFisPIS(nItem,"PS3")
		If cPaisLoc == "BRA"
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisII(nItem, cCampo)
			EndIf
		EndIf
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
		MaFisSEST(nItem)
	Case AllTrim(cCampo) == "IT_ALIQIPI"
		MaAliqSoli(nItem)
		MaExcecao(nItem)
		MaMargem(nItem)
		MaFisTPDP(nItem)
		If aNFItem[nItem,IT_BASEIPI] == 0
			MaFisIPI(nItem,"BSE")
		Endif
		MaFisIPI(nItem,"VLR")
		If (aTes[TS_INCIDE]	== "S"  .Or. (aTes[TS_INCIDE] == "F" .And. aNFCab[NF_TPCLIFOR] =="F" .And. aNFCab[NF_CLIFOR] =="C")) .And.;
			aTes[TS_IPI] <> "R"
			MaFisBsICM(nItem)
			MaFisVICMS(nItem)
			MaItArred(nItem, { "IT_BASEICM","IT_VALICM" } )
		EndIf
		MaFisVComp(nItem)
		MaFisBSSol(nItem)
		MaFisVSol(nItem)
		If !( aTes[TS_AGREG] $ "B|C"	)
			MaFisCOFINS(nItem,"CF2")
			MaFisPIS(nItem,"PS2")
			If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
				MaFisIPI(nItem,"BSE|VLR")
				If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
					MaFisBSICM(nItem,,.T.)
					MaFisVICMS(nItem)
			    ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
					MaFisBSICM(nItem,,.T.)
					MaFisVICMS(nItem) 
					MaFisVDescZF(nItem) 
					MaFisPIS(nItem,"PS2")   
					MaFisCOFINS(nItem,"CF2")
				EndIf 
				MaFisBSSol(nItem)
				MaFisVSol(nItem)
			EndIf
		EndIf
		MaFisVTot(nItem)
		MaFisINSS(nItem,"BSE|VLR")
		MaFisIR(nItem,"BSE|VLR")
		If !( aTes[TS_AGREG] $ "B|C"	)
			MaFisCOFINS(nItem,"COF")
			MaFisPIS(nItem,"PIS")
		EndIf
		MaFisCSLL(nItem)
		MaFisCOFINS(nItem,"CF3")
		MaFisVTot(nItem)
		MaFisPIS(nItem,"PS3")
		If cPaisLoc == "BRA"
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisII(nItem)
			EndIf
		EndIf
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
		MaFisSEST(nItem)
	Case AllTrim(cCampo) == "IT_BASEIPI"
		MaAliqSoli(nItem)
		MaExcecao(nItem)
		MaMargem(nItem)
		MaFisIPI(nItem,"VLR")
		MaFisTPDP(nItem)
		If (aTes[TS_INCIDE]	== "S" .Or. (aTes[TS_INCIDE] == "F" .And. aNFCab[NF_TPCLIFOR] =="F" .And. aNFCab[NF_CLIFOR] =="C")) .And.;
			aTes[TS_IPI] <> "R"
			MaFisBsIcm(nItem)
			MaFisVICMS(nItem)
			MaItArred(nItem, { "IT_BASEICM","IT_VALICM" } )
			MaFisVComp(nItem)
			MaFisBSSol(nItem)
			MaFisVSol(nitem)
		EndIf
		If !( aTes[TS_AGREG] $ "B|C"	)
			MaFisCOFINS(nItem,"CF2")
			MaFisPIS(nItem,"PS2")
			If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
				MaFisIPI(nItem,"BSE|VLR")
				If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
					MaFisBSICM(nItem,,.T.)
					MaFisVICMS(nItem)
				ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
					MaFisBSICM(nItem,,.T.)
					MaFisVICMS(nItem) 
					MaFisVDescZF(nItem) 
					MaFisPIS(nItem,"PS2")   
					MaFisCOFINS(nItem,"CF2")
				EndIf 
				MaFisBSSol(nItem)
				MaFisVSol(nItem)
			EndIf
		EndIf
		MaFisVTot(nItem)
		MaFisINSS(nItem,"BSE|VLR")
		MaFisIR(nItem,"BSE|VLR")
		If !( aTes[TS_AGREG] $ "B|C"	)
			MaFisCOFINS(nItem,"COF")
			MaFisPIS(nItem,"PIS")
		EndIf
		MaFisCSLL(nItem)
		MaFisCOFINS(nItem,"CF3")
		MaFisVTot(nItem)
		MaFisPIS(nItem,"PS3")
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
		MaFisSEST(nItem)
	Case AllTrim(cCampo) == "IT_VALIPI"
		MaAliqSoli(nItem)
		MaExcecao(nItem)
		MaMargem(nItem)
		MaFisTPDP(nItem)
		If (aTes[TS_INCIDE]	== "S"  .Or. (aTes[TS_INCIDE] == "F" .And. aNFCab[NF_TPCLIFOR] =="F" .And. aNFCab[NF_CLIFOR] =="C")) .And.;
			aTes[TS_IPI] <> "R"
			MaFisBsIcm(nItem)
			MaFisVICMS(nItem)
			MaItArred(nItem, { "IT_BASEICM","IT_VALICM" } )
		EndIf
		MaFisVComp(nItem)
		MaFisBSSol(nItem)
		MaFisVSol(nItem)
		If !( aTes[TS_AGREG] $ "B|C"	)
			MaFisCOFINS(nItem,"CF2")
			MaFisPIS(nItem,"PS2")
			
			If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
				MaFisIPI(nItem,"BSE|VLR")
				If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
					MaFisBSICM(nItem,,.T.)
					MaFisVICMS(nItem)
				ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
					MaFisBSICM(nItem,,.T.)
					MaFisVICMS(nItem) 
					MaFisVDescZF(nItem) 
					MaFisPIS(nItem,"PS2")   
					MaFisCOFINS(nItem,"CF2")
				EndIf 
				MaFisBSSol(nItem)
				MaFisVSol(nItem)
			EndIf
		EndIf
		MaFisVTot(nItem)
		MaFisINSS(nItem,"BSE|VLR")
		MaFisIR(nItem,"BSE|VLR")
		If !( aTes[TS_AGREG] $ "B|C"	)
			MaFisCOFINS(nItem,"COF")
			MaFisPIS(nItem,"PIS")
		EndIf
		MaFisCSLL(nItem)
		MaFisCOFINS(nItem,"CF3")
		MaFisVTot(nItem)
		MaFisPIS(nItem,"PS3")
		If cPaisLoc == "BRA"
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisII(nItem)
			EndIf
		EndIf
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
		MaFisSEST(nItem)
	Case Alltrim(cCampo) == "IT_BASESOL"
		MaFisVSol(nItem)
		MaFisVTot(nItem)
		If !( aTes[TS_AGREG] $ "B|C"	)
			MaFisCOFINS(nItem,"CF2")
			MaFisPIS(nItem,"PS2")
		EndIf
		MaFisINSS(nItem,"BSE|VLR")
		MaFisIR(nItem,"BSE|VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
		MaFisSEST(nItem)
	Case AllTrim(cCampo) == "IT_ALIQSOL"
		MaFisVSol(nItem)
		MaFisVTot(nItem)
		MaFisINSS(nItem,"BSE|VLR")
		MaFisIR(nItem,"BSE|VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
		MaFisSEST(nItem)
	Case AllTrim(cCampo) == "IT_VALSOL"
		MaFisVTot(nItem)
		If !( aTes[TS_AGREG] $ "B|C"	)
			MaFisCOFINS(nItem,"CF2")
			MaFisPIS(nItem,"PS2")
		EndIf
		MaFisINSS(nItem,"BSE|VLR")
		MaFisIR(nItem,"BSE|VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
		MaFisSEST(nItem)
		MaFisCOFINS(nItem,"CF3")
		MaFisVTot(nItem)
		MaFisPIS(nItem,"PS3")
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
		MaFisTPDP(nItem)
	Case AllTrim(cCampo) == "IT_MARGEM"
		MaFisBsSol(nItem)
		MaFisVSol(nItem)
		MaFisVTot(nItem)
		MaFisCOFINS(nItem,"CF2")
		MaFisPIS(nItem,"PS2")
		MaFisINSS(nItem,"BSE|VLR")
		MaFisIR(nItem,"BSE|VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
		MaFisSEST(nItem)
		
	Case AllTrim(cCampo) == "IT_ICMFRETE"
		If cPaisLoc == "BRA"
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisBSSOL(nItem)
				MaFisVSOL(nItem)
			Endif
		Endif
		
	Case AllTrim(cCampo) == "IT_ALIQCMP"
		MaFisVComp(nItem)
		MaFisVTot(nItem)
		MaFisINSS(nItem,"BSE|VLR")
		MaFisIR(nItem,"BSE|VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
		MaFisSEST(nItem)
	Case AllTrim(cCampo) == "IT_VALCMP"
		MaFisVTot(nItem)
		MaFisINSS(nItem,"BSE|VLR")
		MaFisIR(nItem,"BSE|VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
		MaFisSEST(nItem)
	Case Alltrim(cCampo) == "IT_VALICM"
		MaFisVComp(nItem)
		MaFisVTot(nItem)
		MaFisINSS(nItem,"BSE|VLR")
		MaFisIR(nItem,"BSE|VLR")
		If !( aTes[TS_AGREG] $ "B|C"	)
			MaFisCOFINS(nItem,"COF")
			MaFisPIS(nItem,"PIS")
		EndIf
		MaFisCSLL(nItem)
		MaFisCOFINS(nItem,"CF3")
		MaFisVTot(nItem)
		MaFisPIS(nItem,"PS3")
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
		MaFisSEST(nItem)
	Case AllTrim(cCampo) == "IT_PERFUN"
		MaFisRURAL(nItem)
		MaFisVTot(nItem)
		MaFisINSS(nItem,"BSE|VLR")
		MaFisIR(nItem,"BSE|VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
		MaFisSEST(nItem)
	Case AllTrim(cCampo) == "IT_FUNRURAL"
		MaFisRURAL(nItem,"BSE|ALQ")
		MaFisVTot(nItem)
		MaFisINSS(nItem,"BSE|VLR")
		MaFisIR(nItem,"BSE|VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
		MaFisSEST(nItem)
	Case AllTrim(cCampo) == "IT_VALFDS"
		MaFisVSul(nItem)
		MaFisVTot(nItem)
		MaFisINSS(nItem,"BSE|VLR")
		MaFisIR(nItem,"BSE|VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
		MaFisSEST(nItem)
	Case AllTrim(cCampo) == "IT_VLSENAR"
		MaFisVSul(nItem)
		MaFisSENAR(nItem)
		MaFisVTot(nItem)
		MaFisINSS(nItem,"BSE|VLR")
		MaFisIR(nItem,"BSE|VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
		MaFisSEST(nItem)
	Case AllTrim(cCampo) == "IT_ESTCRED"
		MaFisLF(nItem)
	Case AllTrim(cCampo) == "IT_FRETE" .Or. AllTrim(cCampo) == "IT_VLR_FRT"
		If cPaisLoc == "BRA"
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaAliqSoli(nItem)
			Endif
			MaExcecao(nItem)
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaMargem(nItem)
				MaFisIPI(nItem,"BSE|VLR")
				MaFisBSICM(nItem)
				MaFisVICMS(nItem)
				MaItArred(nItem, { "IT_BASEICM","IT_VALICM" } )
				MaFisVDescZF(nItem)
				MaFisVComp(nItem)
				MaFisBSSOL(nItem)
				MaFisVSOL(nItem)
				If cPaisLoc == "BRA" .And. !( aTes[TS_AGREG] $ "B|C"	)
					MaFisCOFINS(nItem,"CF2")
					MaFisPIS(nItem,"PS2")
					If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
						MaFisIPI(nItem,"BSE|VLR")
						If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
							MaFisBSICM(nItem,,.T.)
							MaFisVICMS(nItem)
						ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
							MaFisBSICM(nItem,,.T.)
							MaFisVICMS(nItem) 
							MaFisVDescZF(nItem) 
							MaFisPIS(nItem,"PS2")   
							MaFisCOFINS(nItem,"CF2")
						EndIf 
						MaFisBSSol(nItem)
						MaFisVSol(nItem)
					EndIf
				EndIf
			EndIf
			MaFisAliqIV(,nItem)
			MaFisBSIV(,nItem)
			MaFisVLIV(,nItem)
			MaFisRURAL(nItem)
			MaFisTPDP(nItem)
		Else
			MaFisImpIV(nItem,cCampo)
		Endif
		If cPaisLoc == "BRA" .And. !( aTes[TS_AGREG] $ "B|C"	)
			MaFisCOFINS(nItem,"CF2")
			MaFisPIS(nItem,"PS2")
			If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
				MaFisIPI(nItem,"BSE|VLR")
				If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
					MaFisBSICM(nItem,,.T.)
					MaFisVICMS(nItem)
				ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
					MaFisBSICM(nItem,,.T.)
					MaFisVICMS(nItem) 
					MaFisVDescZF(nItem) 
					MaFisPIS(nItem,"PS2")   
					MaFisCOFINS(nItem,"CF2")
				EndIf 
				MaFisBSSol(nItem)
				MaFisVSol(nItem)
			EndIf
		EndIf
		MaFisVTot(nItem)
		If cPaisLoc == "BRA"
			MaFisINSS(nItem,"BSE|VLR")
			MaFisIR(nItem,"BSE|VLR")
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisCOFINS(nItem,"COF")
				MaFisPIS(nItem,"PIS")
			EndIf
			MaFisCSLL(nItem)
			MaFisSEST(nItem)
			MaFisCOFINS(nItem,"CF3")
			MaFisISS(nItem)
			MaFisVTot(nItem)
			MaFisPIS(nItem,"PS3")
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisII(nItem)
			EndIf
			MaFisVTot(nItem)
		Endif
		MaItArred(nItem)
		If cPaisLoc == "BRA"
			MaFisLF(nItem)
		EndIf
	Case AllTrim(cCampo) == "IT_DESPESA"
		If cPaisLoc == "BRA"
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaAliqSoli(nItem)
			Endif
			MaExcecao(nItem)
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaMargem(nItem)
				MaFisIPI(nItem,"BSE|VLR")
				MaFisBSICM(nItem)
				MaFisVICMS(nItem)
				MaItArred(nItem, { "IT_BASEICM","IT_VALICM" } )
				MaFisVDescZF(nItem)
				MaFisVComp(nItem)
				MaFisBSSOL(nItem)
				MaFisVSOL(nItem)
				If cPaisLoc == "BRA" .And. !( aTes[TS_AGREG] $ "B|C"	)
					MaFisCOFINS(nItem,"CF2")
					MaFisPIS(nItem,"PS2")
					If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
						MaFisIPI(nItem,"BSE|VLR")
						If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
							MaFisBSICM(nItem,,.T.)
							MaFisVICMS(nItem)
						ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
							MaFisBSICM(nItem,,.T.)
							MaFisVICMS(nItem) 
					   		MaFisVDescZF(nItem) 
							MaFisPIS(nItem,"PS2")   
					   		MaFisCOFINS(nItem,"CF2")
						EndIf 
						MaFisBSSol(nItem)
						MaFisVSol(nItem)
					EndIf
				EndIf
			EndIf
			MaFisAliqIV(,nItem)
			MaFisBSIV(,nItem)
			MaFisVLIV(,nItem)
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisCOFINS(nItem,"CF2")
				MaFisPIS(nItem,"PS2")
				If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
					MaFisIPI(nItem,"BSE|VLR")
					If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
						MaFisBSICM(nItem,,.T.)
						MaFisVICMS(nItem)
					ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
						MaFisBSICM(nItem,,.T.)
						MaFisVICMS(nItem) 
						MaFisVDescZF(nItem) 
						MaFisPIS(nItem,"PS2")   
						MaFisCOFINS(nItem,"CF2")
					EndIf 
					MaFisBSSol(nItem)
					MaFisVSol(nItem)
				EndIf
			EndIf
		Else
			MaFisImpIV(nItem,cCampo)
		Endif
		MaFisVTot(nItem)
		If cPaisLoc == "BRA"
			MaFisINSS(nItem,"BSE|VLR")
			MaFisIR(nItem,"BSE|VLR")
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisCOFINS(nItem,"COF")
				MaFisPIS(nItem,"PIS")
			EndIf
			MaFisCSLL(nItem)
			MaFisSEST(nItem)
			MaFisCOFINS(nItem,"CF3")
			MaFisISS(nItem)
			MaFisVTot(nItem)
			MaFisPIS(nItem,"PS3")
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisII(nItem)
			EndIf
			MaFisVTot(nItem)
			MaFisRURAL(nItem)
		Endif
		MaItArred(nItem)
		If cPaisLoc == "BRA"
			MaFisLF(nItem)
		EndIf
	Case AllTrim(cCampo) == "IT_SEGURO"
		If cPaisLoc == "BRA"
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaAliqSoli(nItem)
			Endif
			MaExcecao(nItem)
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaMargem(nItem)
				MaFisIPI(nItem,"BSE|VLR")
				MaFisBSICM(nItem)
				MaFisVICMS(nItem)
				MaItArred(nItem, { "IT_BASEICM","IT_VALICM" } )
				MaFisVDescZF(nItem)
				MaFisVComp(nItem)
				MaFisBSSOL(nItem)
				MaFisVSOL(nItem)
				If cPaisLoc == "BRA" .And. !( aTes[TS_AGREG] $ "B|C"	)
					MaFisCOFINS(nItem,"CF2")
					MaFisPIS(nItem,"PS2")
					If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
						MaFisIPI(nItem,"BSE|VLR")
						If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
							MaFisBSICM(nItem,,.T.)
							MaFisVICMS(nItem)
						ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
							MaFisBSICM(nItem,,.T.)
					   		MaFisVICMS(nItem) 
					   		MaFisVDescZF(nItem) 
					   		MaFisPIS(nItem,"PS2")   
					   		MaFisCOFINS(nItem,"CF2")
				   		EndIf 
						MaFisBSSol(nItem)
						MaFisVSol(nItem)
					EndIf
				EndIf
			Endif
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisCOFINS(nItem,"CF2")
				MaFisPIS(nItem,"PS2")
				If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
					MaFisIPI(nItem,"BSE|VLR")
					If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
						MaFisBSICM(nItem,,.T.)
						MaFisVICMS(nItem)
					ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
						MaFisBSICM(nItem,,.T.)
						MaFisVICMS(nItem) 
						MaFisVDescZF(nItem) 
						MaFisPIS(nItem,"PS2")   
						MaFisCOFINS(nItem,"CF2")
					EndIf 	
					MaFisBSSol(nItem)
					MaFisVSol(nItem)
				EndIf
			EndIf
		Else
			MaFisImpIV(nItem,cCampo)
		Endif
		MaFisVTot(nItem)
		If cPaisLoc == "BRA"
			MaFisINSS(nItem,"BSE|VLR")
			MaFisAliqIV(,nItem)
			MaFisBSIV(,nItem)
			MaFisVLIV(,nItem)
			MaFisIR(nItem,"BSE|VLR")
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisCOFINS(nItem,"COF")
				MaFisPIS(nItem,"PIS")
			EndIf
			MaFisCSLL(nItem)
			MaFisSEST(nItem)
			MaFisCOFINS(nItem,"CF3")
			MaFisISS(nItem)
			MaFisVTot(nItem)
			MaFisPIS(nItem,"PS3")
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisII(nItem)
			EndIf
			MaFisVTot(nItem)
			MaFisRURAL(nItem)
		Endif
		MaItArred(nItem)
		If cPaisLoc == "BRA"
			MaFisLF(nItem)
		EndIf
	Case AllTrim(cCampo) == "IT_REDIR"
		MaFisIR(nItem,"BSE|VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_BASEIRR"
		MaFisIR(nItem,"VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
	Case AllTrim(cCampo) == "IT_VALIRR"
		MaItArred(nItem)
		MaFisLF(nItem)
	Case AllTrim(cCampo) == "IT_ALIQIRR"
		MaFisIR(nItem,"VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_BASESES"
		MaFisSEST(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
	Case AllTrim(cCampo) == "IT_VALSES"
		MaItArred(nItem)
		MaFisLF(nItem)
	Case AllTrim(cCampo) == "IT_ALIQSES"
		MaFisSEST(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
	Case AllTrim(cCampo) == "IT_REDINSS"
		MaFisINSS(nItem,"BSE|VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_BASEINS"
		MaFisINSS(nItem,"VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_ABVLINSS"
		MaFisINSS(nItem,"BSE|VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_ABSCINS"
		MaFisINSS(nItem,"BSE|VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_ABVLISS"
		MaFisISS(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_ABMATISS"
		MaFisISS(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
	Case AllTrim(cCampo) == "IT_VALINS"
		MaItArred(nItem)
		MaFisLF(nItem)
	Case AllTrim(cCampo) == "IT_ALIQINS"
		MaFisINSS(nItem,"VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_VALISS"
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_REDISS"
		MaFisISS(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_BASEISS"
		MaFisISS(nItem,"VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_ALIQISS"
		MaFisISS(nItem,"VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
	Case AllTrim(cCampo) == "IT_CODISS"
		MaFisISS(nItem,"COD") 
		MaItArred(nItem)
		MaFisLF(nItem)
	Case AllTrim(cCampo) == "IT_CFPS"
		MaFisLF(nItem)
	Case AllTrim(cCampo) == "IT_RGESPST"
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_BASECOF"
		MaFisCOFINS(nItem,"COF|CF2","ALQ|VLR")
		MaItArred(nItem)
	Case Alltrim(cCampo) == "IT_ALIQCOF"
		MaFisCOFINS(nItem,"COF|CF2","VLR")
		MaItArred(nItem)
	Case Alltrim(cCampo) == "IT_BASEPIS"
		MaFisPIS(nItem,"PIS|PS2","ALQ|VLR")
		MaItArred(nItem)
	Case Alltrim(cCampo) == "IT_ALIQPIS"
		MaFisPIS(nItem,"PIS|PS2","VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_AVLINSS"
		MaFisINSS(nItem,"BSE|VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_BASEPS2"
		MaFisPIS(nItem,"PIS|PS2","ALQ|VLR")
		MaFisVTot(nItem)
		If !( aTes[TS_AGREG] $ "B|C"	)
			MaFisCOFINS(nItem,"COF")
			MaFisPIS(nItem,"PIS")
		EndIf
		MaFisCSLL(nItem)
		MaFisCOFINS(nItem,"CF3")
		MaFisVTot(nItem)
		MaFisPIS(nItem,"PS3")
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_BASECF2"
		MaFisCOFINS(nItem,"COF|CF2","ALQ|VLR")
		MaFisVTot(nItem)
		If !( aTes[TS_AGREG] $ "B|C"	)
			MaFisCOFINS(nItem,"COF")
			MaFisPIS(nItem,"PIS")
		EndIf
		MaFisCSLL(nItem)
		MaFisCOFINS(nItem,"CF3")
		MaFisVTot(nItem)
		MaFisPIS(nItem,"PS3")
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_ALIQPS2"
		MaFisPIS(nItem,"PIS|PS2","VLR")
		MaFisVTot(nItem)
		If !( aTes[TS_AGREG] $ "B|C"	)
			MaFisCOFINS(nItem,"COF")
			MaFisPIS(nItem,"PIS")
		EndIf
		MaFisCSLL(nItem)
		MaFisCOFINS(nItem,"CF3")
		MaFisVTot(nItem)
		MaFisPIS(nItem,"PS3")
		If cPaisLoc == "BRA"
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisII(nItem)
			EndIf
		EndIf
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_ALIQCF2"
		MaFisCOFINS(nItem,"COF|CF2","VLR")
		MaFisVTot(nItem)
		If !( aTes[TS_AGREG] $ "B|C"	)
			MaFisCOFINS(nItem,"COF")
			MaFisPIS(nItem,"PIS")
		EndIf
		MaFisCSLL(nItem)
		MaFisCOFINS(nItem,"CF3")
		MaFisVTot(nItem)
		MaFisPIS(nItem,"PS3")
		If cPaisLoc == "BRA"
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisII(nItem)
			EndIf
		EndIf
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_VALPS2"
		MaItArred(nItem)
		MaFisVTot(nItem)
	   /*	If !( aTes[TS_AGREG] $ "B|C"	)  // Chamado: TPBP20 - Retirado a chamada das funcoes para que não seja recalculado
			MaFisCOFINS(nItem,"COF")           // a Retenção ao alterar o valor da Apuração de ambos os Impostos
			MaFisPIS(nItem,"PIS")
		EndIf */
		MaFisCSLL(nItem)
		MaFisCOFINS(nItem,"CF3")
		MaFisVTot(nItem)
		MaFisPIS(nItem,"PS3")
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_VALCF2"
		MaItArred(nItem)
		MaFisVTot(nItem)
		/*	If !( aTes[TS_AGREG] $ "B|C"	)  // Chamado: TPBP20 - Retirado a chamada das funcoes para que não seja recalculado
			MaFisCOFINS(nItem,"COF")           // a Retenção ao alterar o valor da Apuração de ambos os Impostos
			MaFisPIS(nItem,"PIS")
		EndIf */
		MaFisCSLL(nItem)
		MaFisCOFINS(nItem,"CF3")
		MaFisVTot(nItem)
		MaFisPIS(nItem,"PS3")
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_BASECSL"
		MaFisCSLL(nItem,"ALQ|VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_ALIQCSL"
		MaFisCSLL(nItem,"VLR")
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_VALCSL"
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_VALCOF"
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Alltrim(cCampo) == "IT_VALPIS"
		MaItArred(nItem)
		MaFisLF(nItem)
	Case (AllTrim(cCampo) == "IT_DESCONTO")  .OR.  (AllTrim(cCampo) == "IT_DESCTOT") 
		If cPaisLoc <> "BRA"
			// Indica se o preco unitario sera arredondado em 0 casas decimais ou nao. Se .T. respeita MV_CENT (Apenas Chile).
            If (aNfCab[NF_OPERNF] =='S' .Or. (aNFitem[nItem][IT_TIPONF ]$"DB" .And. Alltrim(cFunName) == "MATA465N" .And. cPaisLoc == "PAR" .And. cCampo<>"IT_TES")) .And. aParSX6[MV_DESCSAI] == "1"
				If cPaisLoc == "CHI" .And. aParSX6[MV_PRCDEC]
					aNFitem[nItem][IT_VALMERC] := Round(aNFitem[nItem][IT_VALMERC] - (aNFitem[nItem][IT_DESCONTO]+aNFitem[nItem][IT_DESCTOT]),MsDecimais(aNFCab[NF_MOEDA]))
				Else
					aNFitem[nItem][IT_VALMERC] -= (aNFitem[nItem][IT_DESCONTO]+aNFitem[nItem][IT_DESCTOT])
				Endif
				aNFitem[nItem][IT_PRCUNI]  :=	aNFitem[nItem][IT_VALMERC] / Max( aNFitem[nItem][IT_QUANT] , 1 )
			Endif
			
			MaFisImpIV(nItem,cCampo)
		Else
			MaAliqSoli(nItem)
			MaExcecao(nItem)
			MaMargem(nItem)
			MaFisIPI(nItem,"BSE|VLR")
			MaFisBSICM(nItem)
			MaFisVICMS(nItem)
			MaFisRURAL(nItem)
			MaFisTPDP(nItem)
			If !( aTes[TS_TPIPI]=="B" .Or. (aParSX6[MV_IPIBRUT]=="S" .And. aTes[TS_TPIPI] ==" ") ) .And. ( aTes[TS_AGREG]=="D" .Or. aTes[TS_AGREG]=="R" )
				MaFisIPI(nItem,"BSE|VLR")
			EndIf
			MaItArred(nItem, { "IT_BASEICM","IT_VALICM" } )
			MaFisVComp(nItem)
			MaFisBSSOL(nItem)
			MaFisVSOL(nItem)
			MaFisAliqIV(,nItem)
			MaFisBSIV(,nItem)
			MaFisVLIV(,nItem)
		Endif
		MaFisNameIV(,nItem)
		If cPaisLoc == "BRA"
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisPIS(nItem,"PS2")
				MaFisCOFINS(nItem,"CF2")
				If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
					MaFisIPI(nItem,"BSE|VLR")
					If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
						MaFisBSICM(nItem,,.T.)
						MaFisVICMS(nItem)
					ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
						MaFisBSICM(nItem,,.T.)
						MaFisVICMS(nItem) 
						MaFisVDescZF(nItem) 
						MaFisPIS(nItem,"PS2")   
						MaFisCOFINS(nItem,"CF2")
					EndIf 	
					MaFisBSSol(nItem)
					MaFisVSol(nItem)
				EndIf
			EndIf
		Endif
		MaFisVTot(nItem)
		If cPaisLoc == "BRA"
			MaFisINSS(nItem,"BSE|VLR|RED")
			MaFisIR(nItem)
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisPIS(nItem,"PIS")
				MaFisCOFINS(nItem,"COF")
			EndIf
			MaFisCSLL(nItem)
			MaFisCOFINS(nItem,"CF3")
			MaFisISS(nItem)
			MaFisVTot(nItem)
			MaFisPIS(nItem,"PS3")
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisII(nItem)
			EndIf
			MaFisVTot(nItem)
		Endif
		MaItArred(nItem)
		If cPaisLoc == "BRA"
			MaFisLF(nItem)
		EndIf
	Case  cPaisLoc == "PER" .and. SF1->(FieldPos("F1_ADIANT")) > 0 .and. AllTrim(cCampo) == "IT_ADIANTTOT" 
		MaFisImpIV(nItem,cCampo)	
		MaFisNameIV(,nItem)
		MaFisVTot(nItem)
		MaItArred(nItem)
	Case Substr(cCampo,1,9) == "IT_BASEIV"
		MaFisVLIV(Ascan(aTes[TS_SFC],{|x| Substr(x[10],10,1) == Substr(cCampo,10,1)}),nItem)
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
	Case Substr(cCampo,1,8) == "IT_VALIV"
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
	Case AllTrim(cCampo) == "IT_AUTONOMO"
		If Empty( aNFItem[nItem,IT_ALIQICM] )
			MaAliqIcms(nItem)
		EndIf
		MaFisBSSOL(nItem)
		MaFisVSol(nItem)
		MaFisICA(nItem)
		MaFisTST(nItem)
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
	Case AllTrim(cCampo) == "IT_BASEICA"
		MaFisICA(nItem)
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
	Case AllTrim(cCampo) == "IT_VALICA"
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
	Case AllTrim(cCampo) == "IT_BASETST"
		MaFisTST(nItem,"ALQ|VLR")
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
	Case AllTrim(cCampo) == "IT_VALTST"
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
	Case AllTrim(cCampo) == "IT_ALIQTST"
		MaFisTST(nItem,"BSE|VLR")
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
	Case AllTrim(cCampo) == "IT_FUNRURAL"
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
	Case AllTrim(cCampo) == "NF_NATUREZA"
		If cPaisLoc == "BRA"
			MaFisISS(nItem,"ALQ")
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisPIS(nItem,"PS2")
				MaFisCOFINS(nItem,"CF2")
				MaFisSEST(nItem)
				If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
					MaFisIPI(nItem,"BSE|VLR")
					If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
						MaFisBSICM(nItem,,.T.)
						MaFisVICMS(nItem)
					ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
						MaFisBSICM(nItem,,.T.)
						MaFisVICMS(nItem) 
						MaFisVDescZF(nItem) 
						MaFisPIS(nItem,"PS2")   
						MaFisCOFINS(nItem,"CF2")
					EndIf 
					MaFisBSSol(nItem)
					MaFisVSol(nItem)
				EndIf
			EndIf
			MaFisVTot(nItem)
			MaFisINSS(nItem)
			MaFisIR(nItem)
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisCOFINS(nItem,"COF")
				MaFisPIS(nItem,"PIS")
			EndIf
			MaFisCSLL(nItem)
			MaFisCOFINS(nItem,"CF3")
			MaFisISS(nItem)
			MaFisVTot(nItem)
			MaFisPIS(nItem,"PS3")
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisII(nItem)
			EndIf
		EndIf
		MaFisVTot(nItem)
		MaItArred(nItem)
		If cPaisLoc == "BRA"
			MaFisLF(nItem)
		Endif
	Case AllTrim(cCampo) == "IT_TES"
		If cPaisLoc == "BRA"
			MaExcecao( nItem , cCampo )
		Endif
		MaFisPreCalc(nItem,cCampo)
		MaFisCFO(nItem)
		If cPaisLoc == "BRA"
			MaFisTPDP(nItem)
			If (aTes[TS_AGREG]$"B") .And. aParSX6[MV_ESTADO] $ aParSX6[MV_TIPOB] // FNC 000000193742010 SIGAEIC Protocolo ICMS 99, DE 14 DE DEZEMBRO DE 2007, para que as movimentações geradas pelo EIC, ao utilizar no TES o campo Agrega valor como B que calcule.o ICMS ST.
				MaMargem(nItem)
				MaFisBSSol(nItem)
				MaAliqSoli(nItem)
				MaFisVSol(nItem)
			EndIf
			If ( Empty(aNFItem[nItem,IT_ALIQICM] ) .Or. aTes[TS_ICM]=="N") .And. !( aTes[TS_AGREG] $ "B|C" )
				MaAliqIcms(nItem)	
			EndIf
			If (Empty( aNFItem[nItem,IT_ALIQIPI] ) .Or. aTes[TS_IPI]=="N") .And. !( aTes[TS_AGREG] $ "B|C" )
				MaFisIPI(nItem,"ALQ")
			EndIf
			If !( aTes[TS_AGREG] $ "B|C" ) .Or. ((!Empty(aTes[TS_ISEFECP]) .And. !Empty(aTes[TS_FECPANT]) .And. aTes[TS_ISEFECP]<>aTes[TS_FECPANT]))
				MaALIQCMP(nItem)
				MaAliqSoli(nItem)
			Endif
			MaFisISS(nItem,"ALQ")
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaMargem(nItem)
				MaFisIPI(nItem,"BSE|VLR")
				MaFisBSICM(nItem)
				MaFisVICMS(nItem)
				MaItArred(nItem, { "IT_BASEICM","IT_VALICM" } )
				MaFisVComp(nItem)
				if aParSX6[MV_SOMAICM]
					MaFisBSICM(nItem)
					MaFisVICMS(nItem)
					MaFisIPI(nItem,"BSE|VLR")
				endif
			Endif
			MaFisVDescZF(nItem)
			If !( aTes[TS_AGREG] $ "B|C" )
				MaFisBSSOL(nItem)
				MaFisVSOL(nItem)
				MaALIQCMP(nItem)
				MaFisICA(nItem)
				MaFisTST(nItem)
			EndIf
			If cPaisLoc == "BRA" .And. !( aTes[TS_AGREG] $ "B|C"	)
				MaFisCOFINS(nItem,"CF2","ALQ")
				MaFisPIS(nItem,"PS2")
				MaFisCOFINS(nItem,"CF2")
				If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
					MaFisIPI(nItem,"BSE|VLR")
					If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
						MaFisBSICM(nItem,,.T.)
						MaFisVICMS(nItem)
					ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
						MaFisBSICM(nItem,,.T.)
						MaFisVICMS(nItem) 
						MaFisVDescZF(nItem) 
						MaFisPIS(nItem,"PS2")   
						MaFisCOFINS(nItem,"CF2")
					EndIf 
					MaFisBSSol(nItem)
					MaFisVSol(nItem)
				Else
					If (aTes[TS_AGRPIS]=="P" .Or. aTes[TS_AGRCOF]=="C") .And. !aTes[TS_INTBSIC]$"123"
						MaFisBSICM(nItem)
						MaFisVICMS(nItem)
						MaFisBSSOL(nItem)
						MaFisVSOL(nItem)
					EndIf
				EndIf
			EndIf
			MaFisRURAL(nItem)
			MaFisVSul(nItem)
			MaFisSENAR(nItem)
			MaFisAliqIV(,nItem)
			MaFisBSIV(,nItem)
			MaFisVLIV(,nItem)
			MaFisFFF(nItem)
		Else
			MaFisImpIV(nItem,cCampo)
		Endif
		MaFisNameIV(,nItem)
		If cPaisLoc == "BRA" .And. !( aTes[TS_AGREG] $ "B|C"	)
			MaFisCOFINS(nItem,"CF2")
			MaFisPIS(nItem,"PS2")
			If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
				MaFisIPI(nItem,"BSE|VLR")
				If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
					MaFisBSICM(nItem,,.T.)
					MaFisVICMS(nItem)
				ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
						MaFisBSICM(nItem,,.T.)
						MaFisVICMS(nItem) 
						MaFisVDescZF(nItem) 
						MaFisPIS(nItem,"PS2")   
						MaFisCOFINS(nItem,"CF2")
				EndIf 
				MaFisBSSol(nItem)
				MaFisVSol(nItem)
			EndIf
		EndIf
		MaFisVTot(nItem)
		If cPaisLoc == "BRA"
			MaFisINSS(nItem)
			If !( aTes[TS_AGREG] $ "B|C"	) 
				MaFisIR(nItem)
				MaFisCOFINS(nItem,"COF")
				MaFisPIS(nItem,"PIS")
			EndIf
			MaFisCSLL(nItem)
			MaFisSEST(nItem)
			MaFisCOFINS(nItem,"CF3")
			MaFisISS(nItem)
			MaFisVTot(nItem)
			MaFisPIS(nItem,"PS3")
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisII(nItem)
			EndIf
			If aTes[TS_BCPCST] == "1" //Campo que indica se os valores de PIS/COFINS ST entram na base de ICMS-ST
				MaFisBSSOL(nItem)
				MaFisVSol(nItem)
			EndIf
			MaFisVTot(nItem)
			If aTes[TS_OPERSUC] == "1"
				MaFisCOFINS(nItem,"COF|CF2")
				MaFisPIS(nItem,"PIS|PS2")
				MaFisBsIcm(nItem)
				MaFisVICMS(nItem)
				MaItArred(nItem, { "IT_BASEICM","IT_VALICM" } )
			Endif
		Endif
		MaItArred(nItem)
		If cPaisLoc == "BRA"
			MaFisAFRMM(nItem)
			MaFisLF(nItem)
		EndIf
		MafisCide(nItem)
	Case AllTrim(cCampo) == "IT_VALEMB"
		If cPaisLoc == "BRA"
			MaExcecao(nItem)
		Endif
		MaFisPreCalc(nItem)
		MaFisCFO(nItem)
		If cPaisLoc == "BRA"
			If Empty( aNFItem[nItem,IT_ALIQICM] ) .Or. aTes[TS_ICM]=="N"
				MaAliqIcms(nItem)
			EndIf
			If Empty( aNFItem[nItem,IT_ALIQIPI] ) .Or. aTes[TS_IPI]=="N"
				MaFisIPI(nItem,"ALQ")
			EndIf
			MaALIQCMP(nItem)
			MaAliqSoli(nItem)
			MaMargem(nItem)
			MaFisIPI(nItem,"BSE|VLR")
			MaFisBSICM(nItem)
			MaFisVICMS(nItem)
			MaFisTPDP(nItem)
			If !( aTes[TS_TPIPI]=="B" .Or. (aParSX6[MV_IPIBRUT]=="S" .And. aTes[TS_TPIPI] ==" ") ) .And. ( aTes[TS_AGREG]=="D" .Or. aTes[TS_AGREG]=="R" )
				MaFisIPI(nItem,"BSE|VLR")
			EndIf
		Endif
		MaItArred(nItem, { "IT_BASEICM","IT_VALICM" } )
		If cPaisLoc == "BRA"
			MaFisVComp(nItem)
			MaFisVDescZF(nItem)
			MaFisBSSOL(nItem)
			MaFisVSOL(nItem)
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisCOFINS(nItem,"CF2")
				MaFisPIS(nItem,"PS2")
				If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
					MaFisIPI(nItem,"BSE|VLR")
					If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
						MaFisBSICM(nItem,,.T.)
						MaFisVICMS(nItem)
					ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
						MaFisBSICM(nItem,,.T.)
						MaFisVICMS(nItem) 
						MaFisVDescZF(nItem) 
						MaFisPIS(nItem,"PS2")   
						MaFisCOFINS(nItem,"CF2")
					EndIf 
					MaFisBSSol(nItem)
					MaFisVSol(nItem)
				EndIf
			EndIf
			MaFisICA(nItem)
			MaFisTST(nItem)
			MaFisRURAL(nItem)
			MaFisVSul(nItem)
			MaFisSENAR(nItem)
			MaFisAliqIV(,nItem)
			MaFisBSIV(,nItem)
			MaFisVLIV(,nItem)
		Else
			MaFisImpIV(nItem,cCampo)
		Endif
		MaFisNameIV(,nItem)
		If cPaisLoc == "BRA" .And. !( aTes[TS_AGREG] $ "B|C"	)
			MaFisCOFINS(nItem,"CF2")
			MaFisPIS(nItem,"PS2")
			If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
				MaFisIPI(nItem,"BSE|VLR")
				If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
					MaFisBSICM(nItem,,.T.)
					MaFisVICMS(nItem)
				ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
						MaFisBSICM(nItem,,.T.)
						MaFisVICMS(nItem) 
						MaFisVDescZF(nItem) 
						MaFisPIS(nItem,"PS2")   
						MaFisCOFINS(nItem,"CF2")
				EndIf 
				MaFisBSSol(nItem)
				MaFisVSol(nItem)
			EndIf
		EndIf
		MaFisVTot(nItem)
		If cPaisLoc == "BRA"
			MaFisINSS(nItem)
			MaFisIR(nItem)
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisCOFINS(nItem,"COF")
				MaFisPIS(nItem,"PIS")
			EndIf
			MaFisCSLL(nItem)
			MaFisCOFINS(nItem,"CF3")
			MaFisISS(nItem)
			MaFisVTot(nItem)
			MaFisPIS(nItem,"PS3")
			MaFisVTot(nItem)
		Endif
		MaItArred(nItem)
		If cPaisLoc == "BRA"
			MaFisLF(nItem)
		Endif
	Case Alltrim(cCampo) == "IT_DESCZF"
		MaFisBSSOL(nItem)
		MaFisVSOL(nItem)
		MaFisICA(nItem)
		MaFisTST(nItem)
		MaFisRURAL(nItem)
		MaFisVSul(nItem)
		MaFisSENAR(nItem)
		If cPaisLoc=="BRA"
			MaFisAliqIV(,nItem)
			MaFisBSIV(,nItem)
			MaFisVLIV(,nItem)
		Else
			MaFisImpIV(nItem,cCampo)
		Endif
		MaFisNameIV(,nItem)
		If !( aTes[TS_AGREG] $ "B|C"	)
			MaFisPIS(nItem,"PS2")
			MaFisCOFINS(nItem,"CF2")
			If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
				MaFisIPI(nItem,"BSE|VLR")
				If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
					MaFisBSICM(nItem,,.T.)
					MaFisVICMS(nItem)
				ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
					MaFisBSICM(nItem,,.T.)
					MaFisVICMS(nItem) 
					MaFisVDescZF(nItem) 
					MaFisPIS(nItem,"PS2")   
					MaFisCOFINS(nItem,"CF2")
				EndIf 
				MaFisBSSol(nItem)
				MaFisVSol(nItem)
			EndIf
		EndIf
		MaFisVTot(nItem)
		MaFisINSS(nItem,"BSE|VLR|RED")
		MaFisIR(nItem)
		If !( aTes[TS_AGREG] $ "B|C")
			MaFisPIS(nItem,"PIS")
			MaFisCOFINS(nItem,"COF")
		EndIf
		MaFisCSLL(nItem)
		MaFisCOFINS(nItem,"CF3")
		MaFisISS(nItem)
		MaFisVTot(nItem)
		MaFisPIS(nItem,"PS3")
		MaFisVTot(nItem)
		MaItArred(nItem)
		MaFisLF(nItem)
	Case AllTrim(cCampo) == "IT_BASEDUP"
		MaItArred(nItem)
	Case AllTrim(cCampo) == "IT_VALII"
		If cPaisLoc == "BRA"
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisBSICM(nItem)
				MaFisVICMS(nItem)
				MaFisII(nItem)
				MaFisVTot(nItem)
				MaItArred(nItem)
				MaFisLF(nItem)
			EndIf
		EndIf
	Case AllTrim(cCampo) == "IT_ALIQII"
		If cPaisLoc == "BRA"
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisBSICM(nItem)
				MaFisVICMS(nItem)
				MaFisII(nItem)
				MaFisVTot(nItem)
				MaItArred(nItem)
				MaFisLF(nItem)
			EndIf
		EndIf
	Case AllTrim(cCampo) == "IT_CONCEPT"
		If cPaisLoc=="EQU"
			MaFisPreCalc(nItem)
			MaFisCFO(nItem)
			MaFisImpIV(nItem,cCampo)
			MaFisNameIV(,nItem)
			MaFisVTot(nItem)
			MaItArred(nItem)
		Endif
	Case AllTrim(cCampo) == "IT_BASEPS3"
		If cPaisLoc=="BRA"
			MaFisVTot(nItem)
			MaItArred(nItem)
			MaFisLF(nItem)
		Endif
	Case AllTrim(cCampo) == "IT_VALPS3"
		If cPaisLoc=="BRA"
			MaFisVTot(nItem)
			MaItArred(nItem)
			MaFisLF(nItem)
		Endif
	Case AllTrim(cCampo) == "IT_BASECF3"
		If cPaisLoc=="BRA"
			MaFisVTot(nItem)
			MaItArred(nItem)
			MaFisLF(nItem)
		Endif
	Case AllTrim(cCampo) == "IT_VALCF3"
		If cPaisLoc=="BRA"
			MaFisVTot(nItem)
			MaItArred(nItem)
			MaFisLF(nItem)
		Endif
	Case AllTrim(cCampo) == "IT_VALCMAJ"
		If cPaisLoc == "BRA"
			If !( aTes[TS_AGREG] $ "B|C"	)				
				MaFisII(nItem, "IT_VALCMAJ")				
				MaFisVTot(nItem)
				MaItArred(nItem)
				MaFisLF(nItem)
			EndIf
		EndIf
		
	OtherWise

		If cPaisLoc == "BRA"

			MaExcecao( nItem , cCampo )
			MaFisPreCalc(nItem,cCampo)
			MaFisCFO(nItem)
			If Empty( aNFItem[nItem,IT_ALIQICM] ) .Or. aNfCab[NF_TIPONF] $ "DB" .Or. ;
				"NF_" $ Alltrim(cCampo) .Or. "IT_RECORI" $ Alltrim(cCampo) .Or.;
				"IT_PRODUTO" $ Alltrim(cCampo) .Or. "IT_GRPTRIB" $ Alltrim(cCampo) .Or. ;
				"IT_CLASFIS" $ Alltrim(cCampo)
				MaAliqIcms(nItem)
			Endif
			If Empty( aNFItem[nItem,IT_ALIQIPI] ) .Or. aNfCab[NF_TIPONF] $ "DB" .Or. ;
				"NF_" $ Alltrim(cCampo) .Or. "IT_RECORI" $ Alltrim(cCampo) .Or. ;
				"IT_PRODUTO" $ Alltrim(cCampo) .Or. "IT_GRPTRIB" $ Alltrim(cCampo)
				MaFisIPI(nItem,"ALQ")
			Endif
			MaALIQCMP(nItem)
			MaAliqSoli(nItem)
			MaFisISS(nItem,"ALQ")
			MaFisTPDP(nItem)
			MaMargem(nItem)
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisIPI(nItem,"BSE|VLR")
				MaFisBSICM(nItem)
				MaFisVICMS(nItem)
			Endif
			If !( aTes[TS_TPIPI]=="B" .Or. (aParSX6[MV_IPIBRUT]=="S" .And. aTes[TS_TPIPI] ==" ") ) .And. ( aTes[TS_AGREG]=="D" .Or. aTes[TS_AGREG]=="R")
				MaFisIPI(nItem,"BSE|VLR")
			EndIf
			MaItArred(nItem, { "IT_BASEICM","IT_VALICM" } )
			MaFisVComp(nItem)
			MaFisVDescZF(nItem)
			MaFisBSSOL(nItem)
			MaFisVSOL(nItem)
			If !( aTes[TS_AGREG] $ "B|C" )
				If !(aTes[TS_OPERSUC] == "1" .And. cCampo#"IT_RECORI")
					MaFisCOFINS(nItem,"CF2")
					MaFisPIS(nItem,"PS2")
				EndIf
				If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
					MaFisIPI(nItem,"BSE|VLR")
					If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
						MaFisBSICM(nItem,,.T.)
						MaFisVICMS(nItem)
					ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
						MaFisBSICM(nItem,,.T.)
						MaFisVICMS(nItem) 
						MaFisVDescZF(nItem) 
						MaFisPIS(nItem,"PS2")   
						MaFisCOFINS(nItem,"CF2")
					EndIf 
					MaFisBSSol(nItem)
					MaFisVSol(nItem)
				ElseIf aTes[TS_OPERSUC] == "1"
					MaFisBSICM(nItem)
					MaFisVICMS(nItem)
				EndIf
			EndIf
			MaFisICA(nItem)
			MaFisTST(nItem)
			MaFisRURAL(nItem)
			MaFisVSul(nItem)
			MaFisFFF(nItem)
			MaFisAliqIV(,nItem)
			MaFisBSIV(,nItem)
			MaFisVLIV(,nItem)
			MaFisNameIV(,nItem)
			If !( aTes[TS_AGREG] $ "B|C" )
				If !(aTes[TS_OPERSUC] == "1")
					MaFisCOFINS(nItem,"CF2")
					MaFisPIS(nItem,"PS2")
				EndIf
				If aNfItem[nItem][IT_DESCZFPIS] <> 0 .Or. aNfItem[nItem][IT_DESCZFCOF] <> 0
					MaFisIPI(nItem,"BSE|VLR")
					If aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS]+aNfItem[nItem][IT_DESCZFCOF]) == 0
						MaFisBSICM(nItem,,.T.)
						MaFisVICMS(nItem)
					ElseIf	(aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF])
						MaFisBSICM(nItem,,.T.)
						MaFisVICMS(nItem) 
						MaFisVDescZF(nItem) 
						MaFisPIS(nItem,"PS2")   
						MaFisCOFINS(nItem,"CF2")
					EndIf 
					MaFisBSSol(nItem)
					MaFisVSol(nItem)
				Else
					If (aTes[TS_AGRPIS]=="P" .Or. aTes[TS_AGRCOF]=="C") .And. !aTes[TS_INTBSIC]$"123"
						MaFisBSICM(nItem)
						MaFisVICMS(nItem)
					EndIf
				EndIf
			EndIf
			MaFisVTot(nItem)
			MaFisSENAR(nItem)
			MaFisINSS(nItem)
			MaFisIR(nItem)
			If !( aTes[TS_AGREG] $ "B|C" ) .And. !(aTes[TS_OPERSUC] == "1")
				MaFisCOFINS(nItem,"COF")
				MaFisPIS(nItem,"PIS")
			EndIf
			MaFisCSLL(nItem)
			MaFisSEST(nItem)
			MaFisBSSOL(nItem)
			MaFisVSol(nItem)
			MaFisVTot(nItem)
			MaFisCOFINS(nItem,"CF3")
			MaFisISS(nItem)
			MaFisVTot(nItem)
			MaFisPIS(nItem,"PS3")
			If aTes[TS_BCPCST] == "1" //Campo que indica se os valores de PIS/COFINS ST entram na base de ICMS-ST
				MaFisBSSOL(nItem)
				MaFisVSol(nItem)
			EndIf
			MaFisVTot(nItem)
			MaItArred(nItem)
			MaFisAFRMM(nItem)
			MaFisLF(nItem)
			If !( aTes[TS_AGREG] $ "B|C"	)
				MaFisII(nItem)
			EndIf
			MafisCide(nItem)
		Else

			MaFisPreCalc(nItem)
			If cPaisLoc <> "ARG"
				MaFisCFO(nItem)
			Endif
			MaFisImpIV(nItem,cCampo)
			MaFisNameIV(,nItem)
			MaFisVTot(nItem)
			MaItArred(nItem)

		EndIf

EndCase

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³ MaFisTes ³ Autor ³Alexandre Lemes        ³ Data ³03/01/2013³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Inicializa o codigo da TES utilizada no item.              ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisTes(cTes,nRecnoSF4,nItemTes)

Local aArea		:= {}
Local aAreaSFC	:= {}
Local aTmp	    := {}
Local cHistSF4  := ""
Local cConverte := ""
Local cDummy	:= "z"
Local cProvAnt	:= ""
Local nX 	    := 0
Local nSeq		:= 0
Local lOk       := .T.
Local lGera		:= .T.
Local lTotal	:= .F.
Local lAchouWN	:= .F.
Local lAchouSS0 := .F.

DEFAULT cTes 	   := ""
DEFAULT nRecnoSF4  := 0

If cTes <> aTes[TS_CODIGO] .Or. ( cPaisLoc == "ARG" .And. lNotRemito )
	
	aArea	 := GetArea()
	aAreaSFC := SFC->(GetArea())
	
	dbSelectArea("SF4")
	If nRecnoSF4 == 0
		dbSetOrder(1)
		MsSeek(xFilial("SF4") + cTes)
		If lHistorico .And. !Empty(cAlsItem) 
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Se for reprocessamento,  e tiver habilitado para buscar os Historico Fiscais,      ³
			//³verifico se o ID do historico da TES  eh  igual ao que foi gravado na Nota. Se for ³
			//³igual é porque nao teve alterações na TES após a emissão. Se for diferente,        ³
			//³é porque teve alterações no cadastro, e entao os dados são carregados da tabela de ³
			//³Historico(SS0).                                                                    ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			
			If( aNfCab[NF_CLIFOR]=="C" .And. aNfCab[NF_TIPONF]<>"D") .Or.( aNfCab[NF_CLIFOR]=="F" .And. aNfCab[NF_TIPONF]$"D|B")
		   		cHistSF4 := (cAlsItem)->D2_IDSF4
			Else
				cHistSF4 := (cAlsItem)->D1_IDSF4
			End 
			If  Alltrim(SF4->F4_IDHIST)<>Alltrim(cHistSF4)		
				dbSelectArea("SS0")
				dbSetOrder(1)				
				MsSeek(xFilial("SS0")+cHistSF4+cTes)								
				lAchouSS0 := .T.
			EndIf				                                                                         
		EndIf		
	Else                                                                                         
		MsGoto(nRecnoSF4)
	EndIf

	lOk := !Empty(cTes)
	aTes[TS_SFC]	 := {}
	aTes[TS_LANCFIS] := {}

	aTes[TS_CODIGO]  := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_CODIGO  , SS0->S0_CODIGO)  , CriaVar("F4_CODIGO",.F.) )
	aTes[TS_TIPO]	 := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_TIPO    , SS0->S0_TIPO)    , aNfCab[NF_OPERNF] )
	aTes[TS_ICM]	 := IIf(lOk .And. cPaisLoc == "BRA"        , IIf(!lAchouSS0, SF4->F4_ICM    , SS0->S0_ICM)     , IIf( cPaisLoc=="BRA",IIf(aParSX6[MV_INITES]==.T.,"N","S"),"N")  )
	aTes[TS_IPI]	 := IIf(lOk .And. cPaisLoc == "BRA"        , IIf(!lAchouSS0, SF4->F4_IPI    , SS0->S0_IPI)     , IIf( cPaisLoc=="BRA",IIf(aParSX6[MV_INITES]==.T.,"N","S"),"N")  )
	aTes[TS_CREDICM] := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_CREDICM, SS0->S0_CREDICM) , "S")
	aTes[TS_CREDIPI] := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_CREDIPI,SS0->S0_CREDIPI), "N")
	aTes[TS_DUPLIC]	 := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_DUPLIC , SS0->S0_DUPLIC)  , "S")
	aTes[TS_ESTOQUE] := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_ESTOQUE, SS0->S0_ESTOQUE) , "S")
	aTes[TS_CF]		 := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_CF     , SS0->S0_CF)      , IIf(aNfCab[NF_OPERNF] == "E","111","511") )
	aTes[TS_TEXTO]	 := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_TEXTO  , SS0->S0_TEXTO)   , CriaVar("F4_TEXTO",.F.) )
	aTes[TS_BASEICM] := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_BASEICM, SS0->S0_BASEICM) , 0)
	aTes[TS_BASEIPI] := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_BASEIPI, SS0->S0_BASEIPI) , 0)
	aTes[TS_PODER3]	 := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_PODER3 , SS0->S0_PODER3)  , "N")
	aTes[TS_LFICM]   := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_LFICM  , SS0->S0_LFICM )  , IIf(aParSX6[MV_INITES]==.T.,"N","T") )
	aTes[TS_LFIPI]	 := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_LFIPI  , SS0->S0_LFIPI)   , IIf(aParSX6[MV_INITES]==.T.,"N","T") )
	aTes[TS_DESTACA] := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_DESTACA, SS0->S0_DESTACA) , "N")
	aTes[TS_INCIDE]	 := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_INCIDE , SS0->S0_INCIDE)  , "N")
	aTes[TS_COMPL]	 := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_COMPL  , SS0->S0_COMPL)   , "N")
	aTes[TS_IPIFRET] := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_IPIFRET, SS0->S0_IPIFRET) , "N")
	aTes[TS_ISS]	 := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_ISS    , SS0->S0_ISS)     , " ")
	aTes[TS_LFISS]	 := IIF(lOk .And. aFieldPos[FP_F4_LFISS]   , IIf(!lAchouSS0, SF4->F4_LFISS  , SS0->S0_LFISS)   , " ")
	aTes[TS_NRLIVRO] := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_NRLIVRO, SS0->S0_NRLIVRO) , " ")
	aTes[TS_UPRC]	 := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_UPRC   , SS0->S0_UPRC)    , " ")
	aTes[TS_CONSUMO] := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_CONSUMO, SS0->S0_CONSUMO) , " ")
	aTes[TS_FORMULA] := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_FORMULA, SS0->S0_FORMULA) , " ")
	aTes[TS_AGREG]	 := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_AGREG  , SS0->S0_AGREG)   , " ")
	aTes[TS_INCSOL]	 := IIf(lOk .And. aFieldPos[FP_F4_INCSOL] , IIf(!lAchouSS0, SF4->F4_INCSOL , SS0->S0_INCSOL)   , " ")
	aTes[TS_CIAP]	 := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_CIAP   , SS0->S0_CIAP)    , " ")
	aTes[TS_DESPIPI] := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_DESPIPI, SS0->S0_DESPIPI) , "N")
	aTes[TS_ATUTEC]	 := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_ATUTEC , SS0->S0_ATUTEC)  , " ")
	aTes[TS_ATUATF]	 := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_ATUATF , SS0->S0_ATUATF)  , " ")
	aTes[TS_TPIPI]	 := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_TPIPI  , SS0->S0_TPIPI)   , "B")
	aTes[TS_LIVRO]	 := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_LIVRO  , SS0->S0_LIVRO)   , "")
	aTes[TS_STDESC]	 := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_STDESC , SS0->S0_STDESC)  , " ")
	aTes[TS_DESPICM] := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_DESPICM, SS0->S0_DESPICM) , "2")
	aTes[TS_DESPPIS] := IIf(lOk .And. aFieldPos[FP_F4_DESPPIS] , IIf(!lAchouSS0, SF4->F4_DESPPIS, SS0->S0_DESPPIS) , "1")
	aTes[TS_DESPCOF] := IIf(lOk .And. aFieldPos[FP_F4_DESPCOF] , IIf(!lAchouSS0, SF4->F4_DESPCOF, SS0->S0_DESPCOF) , "1")
	aTes[TS_BSICMST] := IIf(lOk .And. aFieldPos[FP_F4_BSICMST] , IIf(!lAchouSS0, SF4->F4_BSICMST, SS0->S0_BSICMST) , 0)
	aTes[TS_BASEISS] := IIf(lOk .And. aFieldPos[FP_F4_BASEISS] , IIf(!lAchouSS0, SF4->F4_BASEISS, SS0->S0_BASEISS) , 0)
	aTes[TS_IPILICM] := IIf(lOk                                 , IIf(!lAchouSS0, SF4->F4_IPILICM, SS0->S0_IPILICM) , "2")
	aTes[TS_ICMSDIF] := IIf(lOk                                 , IIf(!lAchouSS0, SF4->F4_ICMSDIF, SS0->S0_ICMSDIF) , "2")
	aTes[TS_QTDZERO] := IIf(lOk                                 , IIf(!lAchouSS0, SF4->F4_QTDZERO, SS0->S0_QTDZERO) , "2")
	aTes[TS_TRFICM]  := IIf(lOk .And. aFieldPos[FP_F4_TRFICM]  , IIf(!lAchouSS0, SF4->F4_TRFICM , SS0->S0_TRFICM)  , "2")
	aTes[TS_OBSICM]  := IIf(lOk .And. aFieldPos[FP_F4_OBSICM]  , IIf(!lAchouSS0, SF4->F4_OBSICM , SS0->S0_OBSICM)  , "2")
	aTes[TS_OBSSOL]  := IIf(lOk .And. aFieldPos[FP_F4_OBSSOL]  , IIf(!lAchouSS0, SF4->F4_OBSSOL , SS0->S0_OBSSOL)  , "2")
	aTES[TS_PICMDIF] := IIf(lOk .And. aFieldPos[FP_F4_PICMDIF] , IIf(!lAchouSS0, SF4->F4_PICMDIF, SS0->S0_PICMDIF) , 0)
	aTES[TS_PISCRED] := IIf(lOk .And. aFieldPos[FP_F4_PISCRED] , IIf(!lAchouSS0, SF4->F4_PISCRED, SS0->S0_PISCRED) , "3")
	aTES[TS_PISCOF]  := IIf(lOk .And. aFieldPos[FP_F4_PISCOF]  , IIf(!lAchouSS0, SF4->F4_PISCOF , SS0->S0_PISCOF)  , "4")
	aTes[TS_CREDST]  := IIf(lOk .And. aFieldPos[FP_F4_CREDST]  , IIf(!lAchouSS0, SF4->F4_CREDST , SS0->S0_CREDST)  , "2")
	aTes[TS_BASEPIS] := IIf(lOk .And. aFieldPos[FP_F4_BASEPIS] , IIf(!lAchouSS0, SF4->F4_BASEPIS, SS0->S0_BASEPIS) , 0)
	aTes[TS_BASECOF] := IIf(lOk .And. aFieldPos[FP_F4_BASECOF] , IIf(!lAchouSS0, SF4->F4_BASECOF, SS0->S0_BASECOF) , 0)
	aTes[TS_ICMSST]  := IIf(lOk .And. aFieldPos[FP_F4_ICMSST]  , IIf(!lAchouSS0, SF4->F4_ICMSST , SS0->S0_ICMSST)  , "1")
	aTes[TS_ISSST]   := IIf(lOk .And. aFieldPos[FP_F4_ISSST]   , IIf(!lAchouSS0, SF4->F4_ISSST  , SS0->S0_ISSST)   , "1")
	aTes[TS_AGRPIS]  := IIf(lOk .And. aFieldPos[FP_F4_AGRPIS]  , IIf(!lAchouSS0, SF4->F4_AGRPIS , SS0->S0_AGRPIS)  , "2")
	aTes[TS_AGRCOF]  := IIf(lOk .And. aFieldPos[FP_F4_AGRCOF]  , IIf(!lAchouSS0, SF4->F4_AGRCOF , SS0->S0_AGRCOF)  , "2")
	aTes[TS_AGRRETC] := IIf(lOk .And. aFieldPos[FP_F4_AGRRETC] , IIf(!lAchouSS0, SF4->F4_AGRRETC, SS0->S0_AGRRETC) , "2")
	aTes[TS_PISBRUT] := IIf(lOk .And. aFieldPos[FP_F4_PISBRUT] , IIf(!lAchouSS0, SF4->F4_PISBRUT, SS0->S0_PISBRUT) , "2")
	aTes[TS_COFBRUT] := IIf(lOk .And. aFieldPos[FP_F4_COFBRUT] , IIf(!lAchouSS0, SF4->F4_COFBRUT, SS0->S0_COFBRUT) , "2")
	aTes[TS_PISDSZF] := IIf(lOk .And. aFieldPos[FP_F4_PISDSZF] , IIf(!lAchouSS0, SF4->F4_PISDSZF, SS0->S0_PISDSZF) , "2")
	aTes[TS_COFDSZF] := IIf(lOk .And. aFieldPos[FP_F4_COFDSZF] , IIf(!lAchouSS0, SF4->F4_COFDSZF, SS0->S0_COFDSZF) , "2")
	aTes[TS_CRDEST]  := IIf(lOk .And. aFieldPos[FP_F4_CRDEST]  , IIf(!lAchouSS0, SF4->F4_CRDEST , SS0->S0_CRDEST)  , "1")
	aTes[TS_CRDPRES] := IIf(lOk .And. aFieldPos[FP_F4_CRDPRES] , IIf(!lAchouSS0, SF4->F4_CRDPRES, SS0->S0_CRDPRES) , 0)
	aTes[TS_AFRMM]	 := IIf(lOk .And. aFieldPos[FP_F4_AFRMM]   , IIf(!lAchouSS0, SF4->F4_AFRMM  , SS0->S0_AFRMM)   , "N")
	aTes[TS_CRDTRAN] := IIf(lOk .And. aFieldPos[FP_F4_CRDTRAN] , IIf(!lAchouSS0, SF4->F4_CRDTRAN, SS0->S0_CRDTRAN) , 0)
	aTes[TS_CALCFET] := IIf(lOk .And. aFieldPos[FP_F4_CALCFET] , IIf(!lAchouSS0, SF4->F4_CALCFET, SS0->S0_CALCFET) , "2")
	aTes[TS_DESCOND] := IIf(lOk .And. aFieldPos[FP_F4_DESCOND] , IIf(!lAchouSS0, SF4->F4_DESCOND, SS0->S0_DESCOND) , "2")
	aTes[TS_CRPREPR] := IIf(lOk .And. aFieldPos[FP_F4_CRPREPR] , IIf(!lAchouSS0, SF4->F4_CRPREPR, SS0->S0_CRPREPR) , 0)
	aTes[TS_INTBSIC] := IIf(lOk .And. aFieldPos[FP_F4_INTBSIC] , IIf(!lAchouSS0, SF4->F4_INTBSIC, SS0->S0_INTBSIC) , "0")
	aTes[TS_OPERSUC] := IIf(lOk .And. aFieldPos[FP_F4_OPERSUC] , IIf(!lAchouSS0, SF4->F4_OPERSUC, SS0->S0_OPERSUC) , "2")
	aTes[TS_CREDACU] := IIf(lOk .And. aFieldPos[FP_F4_CREDACU] , IIf(!lAchouSS0, SF4->F4_CREDACU, SS0->S0_CREDACU) , "3")
	aTes[TS_CRPRERO] := IIf(lOk .And. aFieldPos[FP_F4_CRPRERO] , IIf(!lAchouSS0, SF4->F4_CRPRERO, SS0->S0_CRPRERO) , 0)
	aTes[TS_APLIRED] := IIf(lOk .And. aFieldPos[FP_F4_APLIRED] , IIf(!lAchouSS0, SF4->F4_APLIRED, SS0->S0_APLIRED) , "2")
	aTes[TS_APLIIVA] := IIf(lOk .And. aFieldPos[FP_F4_APLIIVA] , IIf(!lAchouSS0, SF4->F4_APLIIVA, SS0->S0_APLIIVA) , "2")
	aTes[TS_APLREDP] := IIf(lOk .And. aFieldPos[FP_F4_APLREDP] , IIf(!lAchouSS0, SF4->F4_APLREDP, SS0->S0_APLREDP) , "2")
	aTes[TS_CRPREPE] := IIf(lOk .And. aFieldPos[FP_F4_CRPREPE] , IIf(!lAchouSS0, SF4->F4_CRPREPE, SS0->S0_CRPREPE) , 0)
	aTes[TS_CPRESPR] := IIf(lOk .And. aFieldPos[FP_F4_CPRESPR] , IIf(!lAchouSS0, SF4->F4_CPRESPR, SS0->S0_CPRESPR) , 0)
	aTes[TS_CALCFAB] := Iif(lOk .And. aFieldPos[FP_F4_CFABOV]  , IIf(!lAchouSS0, SF4->F4_CFABOV , SS0->S0_CFABOV)  , "2")
	aTes[TS_CALCFAC] := Iif(lOk .And. aFieldPos[FP_F4_CFACS]   , IIf(!lAchouSS0, SF4->F4_CFACS  , SS0->S0_CFACS)   , "2")
	aTes[TS_CRPRESP] := IIf(lOk .And. aFieldPos[FP_F4_CRPRESP] , IIf(!lAchouSS0, SF4->F4_CRPRESP, SS0->S0_CRPRESP) , 0)
	aTes[TS_MOTICMS] := IIf(lOk .And. aFieldPos[FP_F4_MOTICMS] , IIf(!lAchouSS0, SF4->F4_MOTICMS, SS0->S0_MOTICMS) , " ")
	aTes[TS_DUPLIST] := IIf(lOk .And. aFieldPos[FP_F4_DUPLIST] , IIf(!lAchouSS0, SF4->F4_DUPLIST, SS0->S0_DUPLIST) , "2")
	aTes[TS_PR35701] := IIf(lOk .And. aFieldPos[FP_F4_PR35701] , IIf(!lAchouSS0, SF4->F4_PR35701, SS0->S0_PR35701) , 0)
	aTes[TS_CODBCC]  := IIf(lOk .And. aFieldPos[FP_F4_CODBCC]  , IIf(!lAchouSS0, SF4->F4_CODBCC , SS0->S0_CODBCC)  , " ")
	aTes[TS_INDNTFR] := IIf(lOk .And. aFieldPos[FP_F4_INDNTFR] , IIf(!lAchouSS0, SF4->F4_INDNTFR, SS0->S0_INDNTFR) , " ")
	aTes[TS_VENPRES] := IIf(lOk .And. aFieldPos[FP_F4_VENPRES] , IIf(!lAchouSS0, SF4->F4_VENPRES, SS0->S0_VENPRES) , " ")
	aTes[TS_REDBCCE] := IIf(lOk .And. aFieldPos[FP_F4_REDBCCE] , IIf(!lAchouSS0, SF4->F4_REDBCCE, SS0->S0_REDBCCE) , 0)
	aTes[TS_VARATAC] := IIf(lOk .And. aFieldPos[FP_F4_VARATAC] , IIf(!lAchouSS0, SF4->F4_VARATAC, SS0->S0_VARATAC) , "")
		
	If cPaisLoc == "BRA"
		
		aTes[TS_FRETAUT] := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_FRETAUT , SS0->S0_FRETAUT) , "1")
		aTes[TS_MKPCMP]  := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_MKPCMP  , SS0->S0_MKPCMP)  , "2")
		aTes[TS_CFEXT]   := IIf(lOk                                , IIf(!lAchouSS0, SF4->F4_CFEXT   , SS0->S0_CFEXT)   , "")
		aTes[TS_MKPSOL]  := IIf(lOk .And. aFieldPos[FP_F4_MKPSOL]  , IIf(!lAchouSS0, SF4->F4_MKPSOL , SS0->S0_MKPSOL)  , "2")
		aTES[TS_LFICMST] := IIf(lOk .And. aFieldPos[FP_F4_LFICMST] , IIf(!lAchouSS0, SF4->F4_LFICMST, SS0->S0_LFICMST) , "N")
		aTES[TS_DESPRDIC]:= IIf(lOk .And. aFieldPos[FP_F4_DSPRDIC] , IIf(!lAchouSS0, SF4->F4_DSPRDIC, SS0->S0_DSPRDIC) , "1")
		aTes[TS_CTIPI]   := IIf(lOk .And. aFieldPos[FP_F4_CTIPI]   , IIf(!lAchouSS0, SF4->F4_CTIPI  , SS0->S0_CTIPI)   , "  ")
		aTes[TS_SITTRIB] := IIf(lOk .And. aFieldPos[FP_F4_SITTRIB] , IIf(!lAchouSS0, SF4->F4_SITTRIB, SS0->S0_SITTRIB) , "  ")
		aTes[TS_CFPS]    := IIf(lOk .And. aFieldPos[FP_F4_CFPS]    , IIf(!lAchouSS0, SF4->F4_CFPS   , SS0->S0_CFPS)    , "")
		aTes[TS_CRPRST]  := IIf(lOk .And. aFieldPos[FP_F4_CRPRST]  , IIf(!lAchouSS0, SF4->F4_CRPRST , SS0->S0_CRPRST)  , 0)
		aTes[TS_IPIOBS]  := IIf(lOk .And. aFieldPos[FP_F4_IPIOBS]  , IIf(!lAchouSS0, SF4->F4_IPIOBS , SS0->S0_IPIOBS)  , "1")
		aTes[TS_IPIPC]   := IIf(lOk .And. aFieldPos[FP_F4_IPIPC]   , IIf(!lAchouSS0, SF4->F4_IPIPC  , SS0->S0_IPIPC)   , "1")
		aTes[TS_PSCFST]	 := IIf(lOk .And. aFieldPos[FP_F4_PSCFST]  , IIf(!lAchouSS0, SF4->F4_PSCFST , SS0->S0_PSCFST)  , "2")
		aTes[TS_CRPRELE] := IIf(lOk .And. aFieldPos[FP_F4_CRPRELE] , IIf(!lAchouSS0, SF4->F4_CRPRELE, SS0->S0_CRPRELE) , 0)
		aTes[TS_CONTSOC] := IIf(lOk .And. aFieldPos[FP_F4_CONTSOC] , IIf(!lAchouSS0, SF4->F4_CONTSOC, SS0->S0_CONTSOC) , "1")
		aTes[TS_COMPRED] := IIf(lOk .And. aFieldPos[FP_F4_COMPRED] .And. !Empty(IIf(!lAchouSS0, SF4->F4_COMPRED, SS0->S0_COMPRED)), IIf(!lAchouSS0, SF4->F4_COMPRED, SS0->S0_COMPRED) , "1")
		aTES[TS_CSTPIS]	 := IIf(lOk .And. aFieldPos[FP_F4_CSTPIS]  , IIf(!lAchouSS0, SF4->F4_CSTPIS , SS0->S0_CSTPIS)  , "")
		aTES[TS_CSTCOF]	 := IIf(lOk .And. aFieldPos[FP_F4_CSTCOF]  , IIf(!lAchouSS0, SF4->F4_CSTCOF , SS0->S0_CSTCOF)  , "")
		aTes[TS_RGESPST] := IIf(lOk .And. aFieldPos[FP_F4_RGESPST] , IIf(!lAchouSS0, SF4->F4_RGESPST, SS0->S0_RGESPST) , "2")
		aTes[TS_CLFDSUL] := IIf(lOk .And. aFieldPos[FP_F4_CLFDSUL] , IIf(!lAchouSS0, SF4->F4_CLFDSUL, SS0->S0_CLFDSUL) , "2")
		aTes[TS_ALSENAR] := IIf(lOk .And. aFieldPos[FP_F4_ALSENAR] , IIf(!lAchouSS0, SF4->F4_ALSENAR, SS0->S0_ALSENAR) , 0)
		aTes[TS_ESTCRED] := IIf(lOk .And. aFieldPos[FP_F4_ESTCRED] , IIf(!lAchouSS0, SF4->F4_ESTCRED, SS0->S0_ESTCRED) , 0)
		aTes[TS_CRPRSIM] := IIf(lOk .And. aFieldPos[FP_F4_CRPRSIM] , IIf(!lAchouSS0, SF4->F4_CRPRSIM, SS0->S0_CRPRSIM) , 0)
		aTes[TS_ANTICMS] := IIf(lOk .And. aFieldPos[FP_F4_ANTICMS] , IIf(!lAchouSS0, SF4->F4_ANTICMS, SS0->S0_ANTICMS) , "2")
		aTes[TS_AGRDRED] := IIf(lOk .And. aFieldPos[FP_F4_AGRDRED] .And. !Empty(IIf(!lAchouSS0, SF4->F4_AGRDRED, SS0->S0_AGRDRED)),  IIf(!lAchouSS0, SF4->F4_AGRDRED, SS0->S0_AGRDRED) , "2")
		aTes[TS_FECPANT] := IIf(lOk                                 , aTes[TS_ISEFECP], "2")
		aTes[TS_ISEFECP] := IIf(lOk .And. aFieldPos[FP_F4_ISEFECP] , IIf(!lAchouSS0, SF4->F4_ISEFECP, SS0->S0_ISEFECP) , "1")
		aTes[TS_BCPCST]  := IIf(lOk .And. aFieldPos[FP_F4_BCPCST]  , IIf(!lAchouSS0, SF4->F4_BCPCST , SS0->S0_BCPCST)  , "1")
		aTes[TS_REDANT]  := IIf(lOk .And. aFieldPos[FP_F4_REDANT]  , IIf(!lAchouSS0, SF4->F4_REDANT , SS0->S0_REDANT)  , 0)
		aTes[TS_PAUTICM] := IIf(lOk .And. aFieldPos[FP_F4_PAUTICM] , IIf(!lAchouSS0, SF4->F4_PAUTICM, SS0->S0_PAUTICM) , "1")
		aTes[TS_ATACVAR] := IIf(lOk .And. aFieldPos[FP_F4_ATACVAR] , IIf(!lAchouSS0, SF4->F4_ATACVAR, SS0->S0_ATACVAR) , "2")
		aTes[TS_BSRURAL] := IIf(lOk .And. aFieldPos[FP_F4_BSRURAL] , IIf(!lAchouSS0, SF4->F4_BSRURAL, SS0->S0_BSRURAL) , "1")
		aTes[TS_DBSTCSL] := IIf(lOk .And. aFieldPos[FP_F4_DBSTCSL] , IIf(!lAchouSS0, SF4->F4_DBSTCSL, SS0->S0_DBSTCSL) , "2")
		aTes[TS_DBSTIRR] := IIf(lOk .And. aFieldPos[FP_F4_DBSTIRR] , IIf(!lAchouSS0, SF4->F4_DBSTIRR, SS0->S0_DBSTIRR) , "2")
		aTes[TS_CROUTGO] := IIf(lOk .And. aFieldPos[FP_F4_CROUTGO] , IIf(!lAchouSS0, SF4->F4_CROUTGO, SS0->S0_CROUTGO) , 0)
		aTes[TS_STCONF]  := IIf(lOk .And. aFieldPos[FP_F4_STCONF]  , IIf(!lAchouSS0, SF4->F4_STCONF , SS0->S0_STCONF)  , "2")
		aTes[TS_CSTISS]  := IIf(lOk .And. aFieldPos[FP_F4_CSTISS]  , IIf(!lAchouSS0, SF4->F4_CSTISS , SS0->S0_CSTISS)  , "  ")
		aTes[TS_BSRDICM] := IIf(lOk .And. aFieldPos[FP_F4_BSRDICM] , IIf(!lAchouSS0, SF4->F4_BSRDICM, SS0->S0_BSRDICM) , "1")
		aTes[TS_CROUTSP] := IIf(lOk .And. aFieldPos[FP_F4_CROUTSP] , IIf(!lAchouSS0, SF4->F4_CROUTSP, SS0->S0_CROUTSP) , 0)
		aTes[TS_ICMSTMT] := IIf(lOk .And. aFieldPos[FP_F4_ICMSTMT] .And. !Empty(IIf(!lAchouSS0, SF4->F4_ICMSTMT, SS0->S0_ICMSTMT)) , IIf(!lAchouSS0, SF4->F4_ICMSTMT, SS0->S0_ICMSTMT) , "1")
		aTes[TS_CPPRODE] := IIf(lOk .And. aFieldPos[FP_F4_CPPRODE] , IIf(!lAchouSS0, SF4->F4_CPPRODE, SS0->S0_CPPRODE) , 0)
		aTes[TS_TPPRODE] := IIf(lOk .And. aFieldPos[FP_F4_TPPRODE] , IIf(!lAchouSS0, SF4->F4_TPPRODE, SS0->S0_TPPRODE) , " ")
		aTes[TS_VDASOFT] := IIf(lOk .And. aFieldPos[FP_F4_VDASOFT] , IIf(!lAchouSS0, SF4->F4_VDASOFT, SS0->S0_VDASOFT) , "2")
		aTes[TS_ISEFERN] := IIf(lOk .And. aFieldPos[FP_F4_ISEFERN] , IIf(!lAchouSS0, SF4->F4_ISEFERN, SS0->S0_ISEFERN) , "1")
		aTes[TS_NORESPE] := IIf(lOk .And. aFieldPos[FP_F4_NORESP]  , IIf(!lAchouSS0, SF4->F4_NORESP , SS0->S0_NORESP)  , "2")
		aTes[TS_SOMAIPI] := IIf(lOk .And. aFieldPos[FP_F4_SOMAIPI] , IIf(!lAchouSS0, SF4->F4_SOMAIPI, SS0->S0_SOMAIPI) , "1")
		aTes[TS_APSCFST] := IIf(lOk .And. aFieldPos[FP_F4_APSCFST] , IIf(!lAchouSS0, SF4->F4_APSCFST, SS0->S0_APSCFST) , "1")
		aTes[TS_CPRCATR] := IIf(lOk .And. aFieldPos[FP_F4_CPRECTR] , IIf(!lAchouSS0, SF4->F4_CPRECTR, SS0->S0_CPRECTR) , "2")
		aTes[TS_CREDPRE] := IIf(lOk .And. aFieldPos[FP_F4_CREDPRE] , IIf(!lAchouSS0, SF4->F4_CREDPRE, SS0->S0_CREDPRE) , 0)
		aTes[TS_CONSIND] := IIf(lOk .And. aFieldPos[FP_F4_CONSIND] , IIf(!lAchouSS0, SF4->F4_CONSIND, SS0->S0_CONSIND) , "2")
		aTes[TS_ISEFEMG] := IIf(lOk .And. aFieldPos[FP_F4_ISEFEMG] , IIf(!lAchouSS0, SF4->F4_ISEFEMG, SS0->S0_ISEFEMG) , "1")
		aTes[TS_ALQCMAJ] := IIf(lOk .And. aFieldPos[FP_F4_MALQCOF] , IIf(!lAchouSS0, SF4->F4_MALQCOF, SS0->S0_MALQCOF) , 0)
		aTes[TS_ALQPMAJ] := IIf(lOk .And. aFieldPos[FP_F4_MALQPIS] , IIf(!lAchouSS0, SF4->F4_MALQPIS, SS0->S0_MALQPIS) , 0)
		aTes[TS_ISEFEMT] := IIf(lOk .And. aFieldPos[FP_F4_ISEFEMT] , IIf(!lAchouSS0, SF4->F4_ISEFEMT, SS0->S0_ISEFEMT) , "1")
		aTes[TS_IPIANTE] := IIf(lOk .And. aFieldPos[FP_F4_IPIANT]  , IIf(!lAchouSS0, SF4->F4_IPIANT , SS0->S0_IPIANT)  , "2")
		aTes[TS_AGREGCP] := IIf(lOk .And. aFieldPos[FP_F4_AGREGCP] , IIf(!lAchouSS0, SF4->F4_AGREGCP, SS0->S0_AGREGCP) , "1")
		aTes[TS_NATOPER] := Iif(lOk .And. aFieldPos[FP_F4_NATOPER] , IIf(!lAchouSS0, SF4->F4_NATOPER, SS0->S0_NATOPER) , "")
		aTes[TS_TPCPRES] := IIf(lOk .And. aFieldPos[FP_F4_TPCPRES] , IIf(!lAchouSS0, SF4->F4_TPCPRES, SS0->S0_TPCPRES) , "")
		aTes[TS_IDHIST]  := IIf(lOk .And. aFieldPos[FP_F4_IDHIST]  , IIf(!lAchouSS0, SF4->F4_IDHIST , SS0->S0_IDHIST ) , "")
		aTes[TS_DEVPARC] := IIf(lOk .And. aFieldPos[FP_F4_DEVPARC] , IIf(!lAchouSS0, SF4->F4_DEVPARC, SS0->S0_DEVPARC) , "1")
		aTes[TS_PERCATM] := IIf(lOk .And. aFieldPos[FP_F4_PERCATM] , IIf(!lAchouSS0, SF4->F4_PERCATM, SS0->S0_PERCATM) , 0 )
		aTes[TS_DICMFUN] := IIf(lOk .And. aFieldPos[FP_F4_DICMFUN] , IIf(!lAchouSS0, SF4->F4_DICMFUN, SS0->S0_DICMFUN) , "")
		aTes[TS_IMPIND]  := IIf(lOk .And. aFieldPos[FP_F4_IMPIND]  , IIf(!lAchouSS0, SF4->F4_IMPIND , SS0->S0_IMPIND ) , "")
		aTes[TS_OPERGAR] := IIf(lOk .And. aFieldPos[FP_F4_OPERGAR] , IIf(!lAchouSS0, SF4->F4_OPERGAR , SS0->S0_OPERGAR ), "2")
		aTes[TS_FRETISS] := IIf(lOk .And. aFieldPos[FP_F4_FRETISS] , IIf(!lAchouSS0, SF4->F4_FRETISS , SS0->S0_FRETISS ), "1")
		aTes[TS_F4_STLIQ]:= IIf(lOk .And. aFieldPos[FP_F4_STLIQ]   , IIf(!lAchouSS0, SF4->F4_STLIQ	 , SS0->S0_STLIQ	 ), "")
		aTes[TS_CV139]	 := IIf(lOk .And. aFieldPos[FP_F4_CV139]   , IIf(!lAchouSS0, SF4->F4_CV139	 , SS0->S0_CV139	 ), "2")
		aTes[TS_RFETALG] := IIf(lOk .And. aFieldPos[FP_F4_RFETALG]  , IIf(!lAchouSS0, SF4->F4_RFETALG	 , SS0->S0_RFETALG	 ), "")
		aTes[TS_PARTICM] := IIf(lOk .And. aFieldPos[FP_F4_PARTICM], IIf(!lAchouSS0, SF4->F4_PARTICM, SS0->S0_PARTICM), "")		
		
	EndIf
	
	If lOk
		// Inicializa os impostos variaveis
		dbSelectArea("SFC")
		dbSetOrder(1)

		If aParSX6[MV_GERIMPV] == "S" .And. !( IsRemito( 1 , "'" + aNFCab[NF_TIPODOC] + "'" ) )

			cTesImp  := SF4->F4_CODIGO
			lAchouWN := .F.

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Bloco Especifico solicitado pela AVERAGE -FNC 152032 continuação FNC 147106.³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If cPaisLoc <> "BRA"

				If Type("lFacImport") == "L" .And. lFacImport .And. nItemTes <> Nil
				
					If (SD1->(MsSeek(xFilial("SD1")+SF1->F1_DOC+SF1->F1_SERIE+SF1->F1_FORNECE+SF1->F1_LOJA+aNfItem[nItemTes][IT_PRODUTO]+StrZero(nItemTes,TamSX3("D1_ITEM")[1]))))

						If SD1->D1_TIPO_NF $ "5678"

							//Solicitação - Average FNC 152032 continuação FNC 147106
							//Se os campos existirem entro para verificar se estão preenchidos e buscar a referencia da TES na tabela SWN
							If aFieldPos[FP_WN_TES] .And. aFieldPos[FP_WN_ITEMNF]

								SWN->(DbSetOrder(2))
								If SWN->(MsSeek(xFilial("SWN")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA))
									While !SWN->(Eof()) .And.;
										(SWN->WN_FILIAL+SWN->WN_DOC+SWN->WN_SERIE+SWN->WN_FORNECE+SWN->WN_LOJA == xFilial("SWN")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA);
										//Se encontrar a referência do Item e a TES estiver preenchida pego a TES da SWN
										If SWN->WN_PRODUTO+SWN->WN_ITEMNF == SD1->D1_COD+SD1->D1_ITEM .And. !Empty(SWN->WN_TES)
											lAchouWN := .T.
											cTesImp  := SWN->WN_TES
										EndIf
										SWN->(DbSkip())
									EndDo
									//Senão encontrou deixo a referência que existia antes
									If !lAchouWN
										If (SYD->(MsSeek(xFilial("SYD")+SD1->D1_TEC)))
											cTesImp:=SYD->YD_TES
										Endif
									EndIf
								EndIf

							Else
								//Senão os campos não existirem deixo a referência que existia antes
								If (SYD->(MsSeek(xFilial("SYD")+SD1->D1_TEC)))
									cTesImp := SYD->YD_TES
								Endif
							EndIf

						Else

							If aParSX6[MV_DESPSD1] == "S"

								cTesImp := SD1->D1_TESDES

							Else

								//Solicitação - Average FNC 152032 continuação FNC 147106
								//Se os campos existirem entro para verificar se estão preenchidos e buscar a referencia da TES na tabela SWN
								If aFieldPos[FP_WN_TES] .And. aFieldPos[FP_WN_ITEMNF]
									SWN->(DbSetOrder(2))
									If SWN->(MsSeek(xFilial("SWN")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA))
										While !SWN->(Eof()) .And.;
											(SWN->WN_FILIAL+SWN->WN_DOC+SWN->WN_SERIE+SWN->WN_FORNECE+SWN->WN_LOJA == xFilial("SWN")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA);
											//Se encontrar a referência do Item e a TES estiver preenchida pego a TES da SWN
											If SWN->WN_PRODUTO+SWN->WN_ITEMNF == SD1->D1_COD+SD1->D1_ITEM .And. !Empty(SWN->WN_TES)
												lAchouWN:=.T.
												cTesImp:=SWN->WN_TES
												SFC->(MsSeek(xFilial("SFC")+SWN->WN_TES+aTes[TS_SFC][nY][SFC_IMPOSTO]))
											EndIf
											SWN->(DbSkip())
										End
										//Senão encontrou deixo a referência que existia antes
										If !lAchouWN
											SYD->(MsSeek(xFilial("SYD")+SD1->D1_TEC))
											cTesImp:=SYD->YD_TES
											SFC->(MsSeek(xFilial("SFC")+SYD->YD_TES+aTes[TS_SFC][nY][SFC_IMPOSTO]))
										EndIf
									EndIf
								Else
									//Senão os campos não existirem deixo a referência que existia antes
									SYD->(MsSeek(xFilial("SYD")+SD1->D1_TEC))
									cTesImp:=SYD->YD_TES
									SFC->(MsSeek(xFilial("SFC")+SYD->YD_TES+aTes[TS_SFC][nY][SFC_IMPOSTO]))
								EndIf
							Endif
						Endif
					Endif
				Endif

			Endif

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Este bloco trata Impostos Variaveis BRASIL e LOCALIZADO - Tabelas SFC e SFB.³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If MsSeek(xFilial("SFC") + cTesImp )

				If nItemTes <> Nil
					cProvAnt := AllTrim(MaFisRet(nItemTes,"IT_PROVENT"))					
				Endif

				While !Eof() .And. xFilial("SFC") + cTesImp == SFC->FC_FILIAL + SFC->FC_TES

					If cPaisLoc == "ARG" .And. aFieldPos[FP_FC_PROV] .And. aParSX6[MV_TESIB] == .T. .And. Alltrim(Substr(SFC->FC_IMPOSTO,1,2)) == "IB"

						If SFC->FC_PROV == cProvAnt .Or. cProvAnt == "99"
							lGera := .T.
						Else
							lGera := .F.
						Endif

					Else
						lGera := .T.
					Endif
					
					If lGera
						SFB->(dbSetOrder(1))
						SFB->(MsSeek(xFilial()+SFC->FC_IMPOSTO))
						If Ascan(aTes[TS_SFC],{|x| x[SFC_IMPOSTO]==SFC->FC_IMPOSTO})==0
							Aadd(aTes[TS_SFC],Array(21))
							nSeq := Len(aTes[TS_SFC])
							aTes[TS_SFC][nSeq][SFC_SEQ]			:= SFC->FC_SEQ
							aTes[TS_SFC][nSeq][SFC_IMPOSTO]		:= SFC->FC_IMPOSTO
							aTes[TS_SFC][nSeq][SFC_CALCULO]		:= SFC->FC_CALCULO
							If cPaisLoc == "ARG" .And. aFieldPos[FP_FC_PROV] .And. aParSX6[MV_TESIB] == .T.
								aTes[TS_SFC][nSeq][SFC_PROVENT]	:= SFC->FC_PROV
							Endif
							If IsAlpha(SFC->FC_INCDUPL)
								cConverte := SFC->FC_INCDUPL + SFC->FC_INCNOTA + SFC->FC_CREDITA
								aTes[TS_SFC][nSeq][SFC_INCDUPL]	:= IIf(Subs(cConverte,1,2)=="SN".Or.Subs(cConverte,1,2)=="NS","3",;
								IIf(Subs(cConverte,1,2)=="SS","1","2"))
								aTes[TS_SFC][nSeq][SFC_INCNOTA]	:= IIf(Subs(cConverte,2,1)=="S" ,"1",IIf(Subs(cConverte,2,1)=="R" ,"2","3"))
								aTes[TS_SFC][nSeq][SFC_CREDITA]	:= IIf(Subs(cConverte,2,2)=="SN","1",IIf(Subs(cConverte,2,2)=="NS","2","3"))
							Else
								aTes[TS_SFC][nSeq][SFC_INCDUPL]	:= SFC->FC_INCDUPL
								aTes[TS_SFC][nSeq][SFC_INCNOTA]	:= SFC->FC_INCNOTA
								aTes[TS_SFC][nSeq][SFC_CREDITA]	:= SFC->FC_CREDITA
							EndIf
							aTes[TS_SFC][nSeq][SFC_INCIMP]		:= SFC->FC_INCIMP
							aTes[TS_SFC][nSeq][SFC_BASE]		:= SFC->FC_BASE
							aTes[TS_SFC][nSeq][SFB_DESCR]		:= SFB->FB_DESCR
							aTes[TS_SFC][nSeq][SFB_CPOVREI]		:= "D1_VALIMP"+SFB->FB_CPOLVRO
							aTes[TS_SFC][nSeq][SFB_CPOBAEI]		:= "D1_BASIMP"+SFB->FB_CPOLVRO
							aTes[TS_SFC][nSeq][SFB_CPOVREC]		:= "F1_VALIMP"+SFB->FB_CPOLVRO
							aTes[TS_SFC][nSeq][SFB_CPOBAEC]		:= "F1_BASIMP"+SFB->FB_CPOLVRO
							aTes[TS_SFC][nSeq][SFB_CPOVRSI]		:= "D2_VALIMP"+SFB->FB_CPOLVRO
							aTes[TS_SFC][nSeq][SFB_CPOBASI]		:= "D2_BASIMP"+SFB->FB_CPOLVRO
							aTes[TS_SFC][nSeq][SFB_CPOVRSC]		:= "F2_VALIMP"+SFB->FB_CPOLVRO
							aTes[TS_SFC][nSeq][SFB_CPOBASC]		:= "F2_BASIMP"+SFB->FB_CPOLVRO
							aTes[TS_SFC][nSeq][SFB_FORMENT]		:= SFB->FB_FORMENT
							aTes[TS_SFC][nSeq][SFB_FORMSAI]		:= SFB->FB_FORMSAI
							If aFieldPos[FP_FB_DESGR]
								aTes[TS_SFC][nSeq][SFB_DESGR]	:= SFB->FB_DESGR
							EndIf
							Aadd(aTmp,Val(SFB->FB_CPOLVRO))
							If aTes[TS_SFC][nSeq][SFC_CALCULO] == "T"
								lTotal	:=	.T.
							Endif
						Endif
					Endif
					dbSkip()
				EndDo

				If cPaisLoc == "ARG" .And. lTotal

					aSort(aTmp)

					For nX := 1 To Len(aTmp)
						If aTmp[nX] <> nX
							cDummy	:=	Str(nX,1)
							Exit
						Endif
					Next nX

					If cDummy <> "z" .And. Len(aTmp) == 1
						aSize(aTes[TS_SFC],Len(aTes[TS_SFC])+1)
						aIns(aTes[TS_SFC],1)
						aTes[TS_SFC][1]	:=	aClone(aTes[TS_SFC][2])
						aTes[TS_SFC][1][SFC_SEQ]    := "00" 
						aTes[TS_SFC][1][SFC_IMPOSTO]:= "DUM"
						aTes[TS_SFC][1][SFC_CALCULO]:= "T"
						aTes[TS_SFC][1][SFB_DESCR]  := "Dummy"
						aTes[TS_SFC][1][SFB_CPOVREI]:= "D1_VALIMP"+cDummy
						aTes[TS_SFC][1][SFB_CPOBAEI]:= "D1_BASIMP"+cDummy
						aTes[TS_SFC][1][SFB_CPOVREC]:= "F1_VALIMP"+cDummy
						aTes[TS_SFC][1][SFB_CPOBAEC]:= "F1_BASIMP"+cDummy
						aTes[TS_SFC][1][SFB_CPOVRSI]:= "D2_VALIMP"+cDummy
						aTes[TS_SFC][1][SFB_CPOBASI]:= "D2_BASIMP"+cDummy
						aTes[TS_SFC][1][SFB_CPOVRSC]:= "F2_VALIMP"+cDummy
						aTes[TS_SFC][1][SFB_CPOBASC]:= "F2_BASIMP"+cDummy
						aTes[TS_SFC][1][SFB_FORMENT]:= "MaFisZero"
						aTes[TS_SFC][1][SFB_FORMSAI]:= "MaFisZero"
						MaFisZero() //Para evitar erro de compilacao
					Endif

				Endif

			Endif

		Else

			aTes[TS_SFC] := {}

		EndIf

		If aAliIndic[AI_CC7] .And. aAliIndic[AI_CC6] .And. TamSx3("CC7_CODLAN")[1] == 10 .And. aFieldPos[FP_CC7_TPREG]
			dbSelectArea("CC7")
			dbSetOrder(1)
			If CC7->(MsSeek(xFilial("CC7")+SF4->F4_CODIGO))
				While !CC7->(Eof()) .And. xFilial("CC7")+CC7->CC7_TES==xFilial("CC7")+SF4->F4_CODIGO
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³ Codigos de Ajuste de Documento Fiscal (Tabela CC6)		³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					If (!(CC7->CC7_TPREG == "NA")) .And. (CC6->(MsSeek(xFilial("CC6")+CC7->CC7_CODLAN)))
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³Somente serao considerados lançamentos da UF do contribuinte 							³
						//³Caso o lançamento nao seja de Apuração Propria, o lançamento podera ser de qualquer UF	³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						If CC6->CC6_STUF == aParSX6[MV_ESTADO]  .Or. CC6->CC6_TPAPUR <> "0"
							
							aAdd( aTes[TS_LANCFIS] ,;
									{	CC7->CC7_CODLAN ,;											// 01 - Codigo de Ajuste
										Iif( aFieldPos[FP_CC7_IFCOMP] , CC7->CC7_IFCOMP , "" ) ,;	// 02 - Codigo da Informacao Complementar
										Iif( aFieldPos[FP_CC7_CODREF] , CC7->CC7_CODREF , "" ) } )	// 03 - Codigo do Reflexo
						EndIf
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³ Codigos de Ajuste de Apuracao (Tabela CDO)				³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					ElseIf Empty( CC7->CC7_CODLAN ) .And. aFieldPos[FP_CC7_CLANAP]
						
						aAdd( aTes[TS_LANCFIS] ,;
								{	CC7->CC7_CLANAP ,;												// 01 - Codigo de Ajuste
									Iif( aFieldPos[FP_CC7_IFCOMP] , CC7->CC7_IFCOMP , "" ) ,;		// 02 - Codigo da Informacao Complementar
									Iif( aFieldPos[FP_CC7_CODREF] , CC7->CC7_CODREF , "" ) } )		// 03 - Codigo do Reflexo
					EndIf
					CC7->(dbSkip())
				EndDo
			EndIf
		EndIf

	EndIf

	RestArea(aAreaSFC)
	RestArea(aArea)

EndIf

cTes := aTes[TS_CODIGO]

If nItemTes <> Nil 
	aNfItem[nItemTes][IT_IDSF4] := 	aTes[TS_IDHIST]
EndIf

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisWrite³ Autor ³ Edson Maricate        ³ Data ³10.01.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Verifica arredondamentos para iniciar a gravacao.           ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisWrite(nOpc,cArea,nItem,lImpostos,lRemito)

Local aAcDif 	:= Array(Len(aItemRef))
Local aNotasOri := {}
Local nX       	:= 0	 
Local nY       	:= 0	 
Local lGravaCpo := .T.

DEFAULT lImpostos:= .F.
DEFAULT lRemito  := .F. //Variavel criada para indicar que impostos nao devem ser gravados (somente despesas)

aFill(aAcDif,0)
Do Case
Case nOpc == 2 // Efetua a gravacao dos campos de impostos. 
	dbSelectArea(cArea)
	For nX := 1 to Len(aNfCab[NF_RELIMP])
		If aNfCab[NF_RELIMP][nX][1] == cArea
			Do Case
			Case lImpostos .And. !(Substr(aNfCab[NF_RELIMP][nX][1],4,6) $ "BASIMP*ALQIMP*VALIMP")
				lGravaCpo := .F.
			Case lRemito .And. Substr(aNfCab[NF_RELIMP][nX][1],4,6) $ "BASIMP*ALQIMP*VALIMP"
				lGravaCpo := .F.
			Otherwise
				lGravaCpo := .T.					
			EndCase
			If lGravaCpo
				FieldPut(FieldPos(aNfCab[NF_RELIMP][nX][2]),MaFisRet(nItem,aNfCab[NF_RELIMP][nX][3]))
			Endif	
		EndIf
	Next nX
OtherWise //Inicia a gravacao e fetua a correcao dos arredondamentos.
	aNfCab[NF_LIVRO] := {}
	For nX := 1 to Len(aNfItem)
		If !aNfItem[nX][IT_DELETED]
			If cPaisLoc=="BRA"
				For nY := 1 to Len(aItemRef)
					If aItemRef[nY][4]
						If ValType(aItemRef[nY][2]) == "A"
							nAcDif := aAcDif[nY]
							nValor := aNfItem[nX][aItemRef[nY][2][1]][aItemRef[nY][2][2]]
							If nValor > 0
								aNfItem[nX][aItemRef[nY][2][1]][aItemRef[nY][2][2]] := NoRound(nValor,2,@nAcDif,10)
								aAcDif[nY] := nAcDif
								If NoRound(aAcDif[nY],2) >= 0.01
									aNfItem[nX][aItemRef[nY][2][1]][aItemRef[nY][2][2]] += 0.01
									aAcDif[nY] -= 0.01
								EndIf
							EndIf
						Else
							nAcDif := aAcDif[nY]
							nValor := aNfItem[nX][Val(aItemRef[nY][2])]
							If nValor > 0
								aNfItem[nX][Val(aItemRef[nY][2])] := NoRound(nValor,2,@nAcDif,10)
								aAcDif[nY] := nAcDif
								If NoRound(aAcDif[nY],2) >= 0.01
									aNfItem[nX][Val(aItemRef[nY][2])] += 0.01
									aAcDif[nY] -= 0.01
								EndIf
							EndIf
						EndIf
					EndIf
				Next nY
			EndIf
			If cPaisLoc == "BRA" .Or. lNotRemito
				MaFisLFToLivro(nX,@aNotasOri)
            EndIf
		EndIf
	Next nX
	If cPaisLoc == "BRA"	
		For nX := 1 To Len(aCabRef)
			If ValType(aCabRef[nX,2]) <> "A"
				nY := Val(aCabRef[nX,2])
				If ValType(aNfCab[nY]) == "N" .And. aCabRef[nX][3]
					aNfCab[nY] := NoRound(aNfCab[nY]+0.00000001,2,,10)								
				EndIf
			EndIf
		Next nX
	Endif
EndCase

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡„o    ³MaFisAtuSF3³ Autor ³ Edson Maricate       ³ Data ³21.02.2000 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo atualizar os livros fiscais com³±±
±±³          ³base em uma nota fiscal de entrada ou saida.                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1 : Tipo de Operacao                                     ³±±
±±³          ³        [1] Inclusao                                         ³±±
±±³          ³        [2] Exclusao                                         ³±±
±±³          ³ExpC2 : Tipo de Movimento                                    ³±±
±±³          ³        [E] Entrada                                          ³±±
±±³          ³        [S] Saida                                            ³±±
±±³          ³ExpN3 : RecNo do cabecalho da nota fiscal                    ³±±
±±³          ³ExpC4 : Alias do cabecalho da nota fiscal                    ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisAtuSF3(nCaso, cTpOper, nRecNF, cAlias, cPDV, cCNAE, cFunOrig, nCD2, cCodSef)

Local aArea		:= GetArea()
Local aAreaSF1	:= SF1->(GetArea())
Local aAreaSF2	:= SF2->(GetArea())
Local aLivro	:= {}
Local aFixos 	:= {}
Local aRecSF3	:= {}
Local aRecSFT   := {}
Local aSF3      := {}
Local aSFT      := {}
Local aWriteSFT := {}
Local alAreaX   := {}
Local alAreaY   := {}
Local aNFEletr	:= {"",cTod(""),"","",0,""}

Local cCtaCont	:= ""
Local cCliFor	:= ""
Local cLoja		:= ""
Local cNumNF	:= ""
Local cSerie	:= ""
Local dDEmissao	:= ""
Local cEspecie	:= ""
Local cFormul	:= ""
Local cQuery    := "" 
Local cTpVent	:= ""
Local cCAE		:= ""      
Local cChvNfe	:= ""
Local cClieForn := ""
Local cLojac    := ""
Local cSeriec   := ""
Local cNfAgreg  := ""
Local cAliasSF3 := "SF3"
Local cAliasSFT := "SFT"
Local cAliasCD2 := "CD2"

Local dEntrada	:= Ctod("")
Local dDtCAE	:= Ctod("")

Local nVlrTotal	:= 0
Local nY        := 0 
Local nX        := 0 
Local nZ        := 0 
Local nA        := 0
Local nPautaPis := 0
Local nPautaCof := 0
Local nlBsIGVSF3:= 0
Local nPosTesX  := 0 

Local lObserv	:= .F.
Local lQuery    := .F.
Local lIsenEP	:= .F.
Local lNFEletr	:= .F.
Local lNFEArg	:= .F.
Local lSped		:= cPaisLoc == "BRA" .And. aAliIndic[AI_SFU] .And. aAliIndic[AI_SFX] .And. aAliIndic[AI_CD3] .And.;
					aAliIndic[AI_CD4] .And. aAliIndic[AI_CD5] .And. aAliIndic[AI_CD6] .And. aAliIndic[AI_CD7] .And.;
					aAliIndic[AI_CD8] .And. aAliIndic[AI_CD9] .And. aAliIndic[AI_CDC] .And. aAliIndic[AI_CDD] .And.;
					aAliIndic[AI_CDE] .And. aAliIndic[AI_CDF] .And. aAliIndic[AI_CDG] 
Local lChvNfe	:= .F.
Local lNfagrSF2 := IIf(aFieldPos[FP_F2_NFAGREG] ,.T.,.F.) // Numero NF Agregada
Local lNfagrSF3 := IIf(aFieldPos[FP_F3_NFAGREG] ,.T.,.F.) // Numero NF Agregada
Local lTipFoSFP := IIf(aFieldPos[FP_FP_TIPOFOR] ,.T.,.F.) // Tipo de formulario
Local lQtdItSFP := IIf(aFieldPos[FP_FP_QTDITEM] ,.T.,.F.) // Qtde de item na Nota fiscal
Local lProcArg  := .F. // se é processo da Argentina para gerar varias faturas
Local cItemNF	:= StrZero(0,TamSx3("D2_ITEM")[1],0)			// Item da NF
Local lIcmSTTran:= .F.
Local lIndicSFT := aAliIndic[AI_SFT]
Local nFecRN 	:=0
Local nFecStRn  :=0
//
If cPaisLoc == "ARG" .And. lNfagrSF2 .And. lNfagrSF3 .And. lTipFoSFP .And. lQtdItSFP ;
	.And. AllTrim(FunName())$"MATA465N|MATA467N|MATA468N" .And. aParSX6[MV_CTRLFOL]
	lProcArg := .T. // se é processo da Argentina para gerar varias faturas
Endif
//
DEFAULT cPDV    := ""
DEFAULT cCNAE   := ""
DEFAULT cFunOrig:= ""
DEFAULT nCD2	:= 0  
DEFAULT cCodSef := ""

Do Case

Case cTpOper == "E"

	If Empty(cAlias)
		cAlias := "SF1"
		dbSelectArea("SF1")
		MsGoto(nRecNF)
	EndIf

	cCliFor	 := (cAlias)->F1_FORNECE
	cLoja	 := (cAlias)->F1_LOJA
	cNumNF	 := (cAlias)->F1_DOC
	cSerie	 := (cAlias)->F1_SERIE
	dDEmissao:= (cAlias)->F1_EMISSAO
	cEspecie := (cAlias)->F1_ESPECIE
	cFormul	 := (cAlias)->F1_FORMUL
	dEntrada := (cAlias)->F1_DTDIGIT

	If cPaisLoc <> "BRA"
		cTipo:=(cAlias)->F1_TIPO
	Endif

	//³ Verifica se a NF esta carregada nas Funcoes Fiscais.    ³
	If nCaso == 1 .And. !MaFisFound("NF")
		MaFisIniNF(1,nRecNF)
	EndIf
	//³ Gravar Livro Fiscal da NF refrente ao Despacho.         ³
	If cPaisLoc == "ARG"
		If nCaso == 1 .And. (cAlias)->F1_TIPO_NF == "9"
			MaFisF3Eic(nCaso)
		EndIf
	EndIf		
	//³Campos da Nota Fiscal Eletronica³
	lNFEletr := aFieldPos[FP_F1_NFELETR] .And.;
					aFieldPos[FP_F1_EMINFE]  .And.;
					aFieldPos[FP_F1_HORNFE]  .And.;
					aFieldPos[FP_F1_CODNFE]  .And.;
					aFieldPos[FP_F1_CREDNFE] .And.; 
					aFieldPos[FP_F3_NFELETR] .And.;
					aFieldPos[FP_F3_EMINFE]  .And.;
					aFieldPos[FP_F3_HORNFE]  .And.;
					aFieldPos[FP_F3_CODNFE]  .And.;
					aFieldPos[FP_F3_CREDNFE] 
	If lNFEletr
		aNFEletr[01] := (cAlias)->F1_NFELETR
		aNFEletr[02] := (cAlias)->F1_EMINFE
		aNFEletr[03] := (cAlias)->F1_HORNFE
		aNFEletr[04] := (cAlias)->F1_CODNFE
		aNFEletr[05] := (cAlias)->F1_CREDNFE
		If aFieldPos[FP_F1_NUMRPS]
			aNFEletr[06] := (cAlias)->F1_NUMRPS
		Endif
	Endif
	//³Campos da NFe Argentina         ³
	lNFEArg	:= 		cPaisLoc== "ARG" .And.;
					aFieldPos[FP_F1_TPVENT] .And.;
					aFieldPos[FP_F1_CAE] .And.;
					aFieldPos[FP_F1_VCTOCAE] .And.;
					aFieldPos[FP_F3_TPVENT] .And.;
					aFieldPos[FP_F3_CAE] .And.;
					aFieldPos[FP_F3_VCTOCAE]		 
	If lNFEArg
		cTPVent := 	(cAlias)->F1_TPVENT
		cCAE	:=	(cAlias)->F1_CAE
		dDtCAE	:= 	(cAlias)->F1_VCTOCAE		
	Endif
	//³Campo da NF-e SPED              ³
	lChvNfe	:= IIf( aFieldPos[FP_F1_CHVNFE] .And. aFieldPos[FP_FT_CHVNFE],.T.,.F.)   
	If lChvNfe
		cChvNfe := 	(cAlias)->F1_CHVNFE
	Endif	

OtherWise            

	If Empty(cAlias)
		cAlias := "SF2"
		dbSelectArea("SF2")
		MsGoto(nRecNF)
	EndIf
 
 	cCliFor	 := (cAlias)->F2_CLIENTE
	cLoja	 := (cAlias)->F2_LOJA
	cNumNF	 := (cAlias)->F2_DOC
	cSerie	 := (cAlias)->F2_SERIE
	dDEmissao:= (cAlias)->F2_EMISSAO
	cEspecie := (cAlias)->F2_ESPECIE
	cFormul	 := IIf(cPaisLoc == "BRA"," ",(cAlias)->F2_FORMUL)

	If cPaisLoc <> "BRA"
		dEntrada := IIf( aFieldPos[FP_F2_DTDIGIT] , (cAlias)->F2_DTDIGIT , dDataBase )
		cTipo    :=(cAlias)->F2_TIPO
	Else
		dEntrada :=(cAlias)->F2_EMISSAO
	Endif

	//³ Verifica se a NF esta carregada nas Funcoes Fiscais.( Inclusao )  ³
	If nCaso == 1 .And. !MaFisFound("NF")
		MaFisIniNF(2,nRecNF)
	EndIf
	//³Campos da Nota Fiscal Eletronica³
	lNFEletr	:= 	aFieldPos[FP_F2_NFELETR].And.;
					aFieldPos[FP_F2_EMINFE] .And.;
					aFieldPos[FP_F2_HORNFE] .And.;
					aFieldPos[FP_F2_CODNFE] .And.;
					aFieldPos[FP_F2_CREDNFE].And.;
					aFieldPos[FP_F3_NFELETR].And.;
					aFieldPos[FP_F3_EMINFE] .And.;
					aFieldPos[FP_F3_HORNFE] .And.;
					aFieldPos[FP_F3_CODNFE] .And.;
					aFieldPos[FP_F3_CREDNFE]
	If lNFEletr
		aNFEletr[01] := (cAlias)->F2_NFELETR
		aNFEletr[02] := (cAlias)->F2_EMINFE
		aNFEletr[03] := (cAlias)->F2_HORNFE
		aNFEletr[04] := (cAlias)->F2_CODNFE
		aNFEletr[05] := (cAlias)->F2_CREDNFE
	Endif
	//³Campos da NFe Argentina         ³
	lNFEArg	:= 		cPaisLoc== "ARG" .And.;
					aFieldPos[FP_F2_TPVENT] .And.;
					aFieldPos[FP_F2_CAE]    .And.;
					aFieldPos[FP_F2_VCTOCAE].And.;		 
					aFieldPos[FP_F3_TPVENT] .And.;
					aFieldPos[FP_F3_CAE]    .And.;
					aFieldPos[FP_F3_VCTOCAE]		 
	If lNFEArg
		cTPVent := 	(cAlias)->F2_TPVENT
		cCAE	:=	(cAlias)->F2_CAE
		dDtCAE	:= 	(cAlias)->F2_VCTOCAE		
	Endif
	//³Campo da NF-e SPED              ³
	lChvNfe	:= Iif( aFieldPos[FP_F2_CHVNFE]  .And. aFieldPos[FP_FT_CHVNFE],.T.,.F.)   
	If lChvNfe
		cChvNfe := 	(cAlias)->F2_CHVNFE
	Endif
EndCase

Do Case
	//³Inclusao dos movimentos fiscais - Cabecalho e Item                      ³
	Case nCaso == 1 .And. nCD2 == 0
	//Inclusao dos movimentos fiscais                                         

	//Tratamento de recuperacao de registros deletados do SF3                 
	dbSelectArea("SF3")
	dbSetOrder( IIf( cTpOper == "S" .Or. cFormul == "S" , 5 , 4 ) )
	#IFDEF TOP
		If TcSrvType()<>"AS/400"
			cAliasSF3 := "MaFisAtuSF3"
			lQuery    := .T.

			cQuery := "SELECT F3_FILIAL,F3_NFISCAL,F3_SERIE,F3_CLIEFOR,"
			cQuery += "F3_LOJA,F3_CFO,F3_FORMUL,F3_DTCANC, R_E_C_N_O_ SF3RECNO "
			cQuery += "FROM "+RetSqlName("SF3")+" SF3 "
			cQuery += "WHERE SF3.F3_FILIAL='"+xFilial("SF3")+"' AND "
			cQuery += "SF3.F3_SERIE='"+cSerie+"' AND "
			cQuery += "SF3.F3_NFISCAL='"+cNumNF+"' AND "
			If !(cTpOper=="S".Or.cFormul=="S")
				cQuery += "SF3.F3_CLIEFOR='"+cCliFor+"' AND "
				cQuery += "SF3.F3_LOJA='"+cLoja+"' AND "
			EndIf
			cQuery += "SF3.D_E_L_E_T_=' ' "
			cQuery += "ORDER BY "+SqlOrder(SF3->(IndexKey()))

			cQuery := ChangeQuery(cQuery)

			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSF3)	

			TcSetField(cAliasSF3,"F3_DTCANC","D",8,0)
		Else
	#ENDIF
		MsSeek(xFilial("SF3")+IIf(cTpOper=="S".Or.cFormul=="S",cSerie+cNumNF,cCliFor+cLoja+cNumNF+cSerie))
		#IFDEF TOP
		EndIf
		#ENDIF

	While (!Eof().And. (cAliasSF3)->F3_FILIAL == xFilial("SF3") .And.;
			(cAliasSF3)->F3_NFISCAL == cNumNF .And.;
			(cAliasSF3)->F3_SERIE == cSerie .And.;
			IIf(cTpOper=="S".Or.cFormul=="S",.T.,(cAliasSF3)->F3_CLIEFOR == cCliFor .And.;
			(cAliasSF3)->F3_LOJA == cLoja) )

		If 	( (Substr((cAliasSF3)->F3_CFO,1,1) < "5" .And. (cAliasSF3)->F3_FORMUL == "S" )  .Or.;
				Substr((cAliasSF3)->F3_CFO,1,1) > "4") .And. !Empty((cAliasSF3)->F3_DTCANC) .And. (cFormul$"S ")

			If lQuery
				aadd(aRecSF3,(cAliasSF3)->SF3RECNO)
			Else
				aadd(aRecSF3,RecNo())
			EndIf
		EndIf
		dbSelectArea(cAliasSF3)
		dbSkip()
	EndDo
	
	If lQuery
		dbSelectArea(cAliasSF3)
		dbCloseArea()
		dbSelectArea("SF3")
	EndIf

	If (cPaisLoc=="BRA" .And. lIndicSFT)
		//³Tratamento de recuperacao de registros deletados do SFT                 ³
		dbSelectArea("SFT")
		dbSetOrder(1)
		#IFDEF TOP
			If TcSrvType()<>"AS/400"
				cAliasSFT := "MaFisAtuSFT"
				lQuery    := .T.
	
				cQuery := "SELECT FT_FILIAL, FT_TIPOMOV,FT_NFISCAL,FT_SERIE,FT_CLIEFOR,FT_LOJA,"
				cQuery += "FT_CFOP,FT_FORMUL,FT_DTCANC, R_E_C_N_O_ SFTRECNO "
				cQuery += "FROM "+RetSqlName("SFT")+" SFT "
				cQuery += "WHERE SFT.FT_FILIAL='"+xFilial("SFT")+"' AND "
				cQuery += "SFT.FT_SERIE='"+cSerie+"' AND "
				cQuery += "SFT.FT_NFISCAL='"+cNumNF+"' AND "				
				If !(cTpOper=="S".Or.cFormul=="S")
					cQuery += "SFT.FT_TIPOMOV='"+cTpOper+"' AND "
					cQuery += "SFT.FT_CLIEFOR='"+cCliFor+"' AND "
					cQuery += "SFT.FT_LOJA='"+cLoja+"' AND "
				EndIf
				cQuery += "SFT.D_E_L_E_T_=' ' "
				cQuery += "ORDER BY "+SqlOrder(SFT->(IndexKey()))
	
				cQuery := ChangeQuery(cQuery)
	
				dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSFT)
	
				TcSetField(cAliasSFT,"FT_DTCANC","D",8,0)
		    Else
		#ENDIF
				MsSeek(xFilial("SFT")+cTpOper+cSerie+cNumNF+IIf(!(cTpOper=="S".Or.cFormul=="S"),cCliFor+cLoja,""))
		#IFDEF TOP
			EndIf
		#ENDIF

		While (!Eof().And. (cAliasSFT)->FT_FILIAL == xFilial("SFT") .And.;
			(cAliasSFT)->FT_NFISCAL == cNumNF .And.;
			(cAliasSFT)->FT_SERIE == cSerie .And.;
			IIf(cTpOper=="S".Or.cFormul=="S",.T.,(cAliasSFT)->FT_CLIEFOR == cCliFor .And.;
			(cAliasSFT)->FT_LOJA == cLoja) )
			
			If 	(((cAliasSFT)->FT_TIPOMOV=="E" .And. (cAliasSFT)->FT_FORMUL == "S") .Or.;
			    (cAliasSFT)->FT_TIPOMOV=="S") .And. !Empty((cAliasSFT)->FT_DTCANC)
				If lQuery
					aadd(aRecSFT,(cAliasSFT)->SFTRECNO)
				Else
					aadd(aRecSFT,RecNo())
				EndIf
			EndIf
			dbSelectArea(cAliasSFT)
			dbSkip()
		EndDo
		If lQuery
			dbSelectArea(cAliasSFT)
			dbCloseArea()
			dbSelectArea("SFT")
		EndIf
	EndIf
	If (cPaisLoc=="BRA" .And. aAliIndic[AI_CD2])
		//³Tratamento de recuperacao de registros deletados do CD2                 ³
		dbSelectArea("CD2")
		dbSetOrder(2)
		#IFDEF TOP
			If TcSrvType()<>"AS/400"
				cAliasCD2 := "MaFisAtuCD2"
				lQuery    := .T.
	
				cQuery := "SELECT CD2_FILIAL,CD2_TPMOV,CD2_DOC,CD2_SERIE,CD2_CODCLI,CD2_LOJCLI,CD2_CODFOR,CD2_LOJFOR,R_E_C_N_O_ CD2RECNO "
				cQuery += "FROM "+RetSqlName("CD2")+" CD2 "
				cQuery += "WHERE CD2.CD2_FILIAL='"+xFilial("CD2")+"' AND "
				cQuery += "CD2.CD2_SERIE='"+cSerie+"' AND "
				cQuery += "CD2.CD2_DOC='"+cNumNF+"' AND "
				cQuery += "CD2.CD2_TPMOV='"+cTpOper+"' AND "
				If (cTpOper=="E" .And. !aNfCab[NF_TIPONF]$"DB")
					If !cFormul=="S"
					cQuery += "CD2.CD2_CODFOR='"+cCliFor+"' AND "
					cQuery += "CD2.CD2_LOJFOR='"+cLoja+"' AND "
					EndIf
				EndIf
				If aFieldPos[FP_CD2_FORMU] .And. cFormul=="S"
					cQuery += "CD2.CD2_FORMU='S' AND "
				EndIf
				cQuery += "CD2.D_E_L_E_T_=' ' "
				cQuery += "ORDER BY "+SqlOrder(CD2->(IndexKey()))
	
				cQuery := ChangeQuery(cQuery)
	
				dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasCD2)
			Else
		#ENDIF
				MsSeek(xFilial("CD2")+cTpOper+cSerie+cNumNF+IIf(!(cTpOper=="S".Or.cFormul=="S"),cCliFor+cLoja,""))
		#IFDEF TOP
			EndIf
		#ENDIF
		While (!Eof() .And.;
			(cAliasCD2)->CD2_FILIAL == xFilial("CD2") .And.;
			(cAliasCD2)->CD2_TPMOV  == cTpOper	.And.;
			(cAliasCD2)->CD2_DOC    == cNumNF  .And.;
			(cAliasCD2)->CD2_SERIE  == cSerie  .And.;
			IIf(cTpOper=="S" .Or. (cTpOper=="E" .And. aNfCab[NF_TIPONF]$"DB") .Or. cFormul=="S",.T.,(cAliasCD2)->CD2_CODFOR == cCliFor .And. (cAliasCD2)->CD2_LOJFOR == cLoja))			 	

			If lQuery
				CD2->(dbGoto((cAliasCD2)->CD2RECNO))
			EndIf
			
			RecLock("CD2")
			dbdelete()
			MsUnLock()
			                             
			dbSelectArea(cAliasCD2)
			dbSkip()
		EndDo
		If lQuery
			dbSelectArea(cAliasCD2)
			dbCloseArea()
			dbSelectArea("CD2")
		EndIf
	EndIf	
	//³ Grava arquivo de Livros Fiscais (SF3)                                  ³
	aLivro := aNFCab[NF_LIVRO]
	aFixos := MatxAfixos()
	lObserv:= .F.

	If cPaisLoc=="BRA"
		AEval(aLivro,{ |x| (nVlrTotal+=IIf(x[3]+x[4]+x[5]+x[6]+x[7]+x[9]+x[10]+x[11]+x[27]>0,x[3]+x[4]+x[5]+x[6]+x[7]+x[9]+x[10]+x[11]+x[27],0)),((lObserv := IIf(!Empty(x[24]),.T.,lObserv)))})
	Else
		If Len(aLivro) > 0
			aLivro:=Adel(aLivro,1)
			aLivro:=aSize(aLivro,Len(aLivro)-1)
			nVlrTotal:=Len(aLivro)
		Endif
	Endif

	If nVlrTotal > 0.00 .Or. lObserv
		//³Exclui os registros cancelados que serao reaproveitados em outro ³
		//³documento fiscal.                                                ³
		For nZ := 1 To Len(aRecSFT)
			//Exclui as tabelas de complementos por item do Sped
			If lSped         
				M926DlSped(2,SFT->FT_NFISCAL,SFT->FT_SERIE,SFT->FT_CLIEFOR,SFT->FT_LOJA,SFT->FT_TIPOMOV,SFT->FT_ITEM,SFT->FT_PRODUTO)
			Endif
			SFT->(MsGoto(aRecSFT[nZ]))
			RecLock("SFT",.F.)
			SFT->(dbDelete())
			MsUnLock()
		Next nZ
		//³ Coloca os lancamentos fiscais em ordem de CFO e CFO Extendido          ³
		If cPaisLoc=="BRA"
			Asort(aLivro,,,{|x,y| (x[1]+x[31])<(y[1]+y[31])})
		Endif

		For nX := 1 To Len(aLivro)
			If !Empty(aLivro[nX][1]) .Or. cPaisLoc <> "BRA"
				//³ Recupera os registros cancelados                                       ³
				If nX <= Len(aRecSF3)
					SF3->(MsGoto(aRecSF3[nX]))
					RecLock("SF3",.F.)
				Else
					RecLock("SF3",.T.)
				EndIf

				For nY := 1 to Len(aFixos)

					If SF3->(FieldPos(aFixos[nY][1])) > 0 .And. aLivro[nX][nY] <> Nil
                        If cPaisLoc <> "BRA" .And. ValType(aLivro[nX][nY]) == "N" .And. Subs(aFixos[nY][1],1,6) $ "F3_VAL|F3_BAS|F3_RET|F3_DES"
							FieldPut(FieldPos(aFixos[nY][1]),Round(aLivro[nX][nY],MsDecimais(1)))
						Else
							FieldPut(FieldPos(aFixos[nY][1]),aLivro[nX][nY])
						EndIf
						//³          TRATAMENTO EXPECIFICO PARA LOCALIZADO PERU                 ³
						//³ Quando o TES for referente ao imposto do IGV, o valor do IPM, o     ³
						//³ qual é uma porcentagem do IGV,o valor da base, aliquota e valor do  ³
						//³ imposto é gravado nos campos _BASIMP3, _ALQIMP3 e VALIMP3.          ³
						//³ O valor da base é a mesma utilizada para o cálculo do IGV.          ³
						//³ O valor da alíqutoa é proveniente de um paramêtro chamado           ³
						//³ MV_ALQIPM.                                                          ³
						//³ O valor do imposto é a multiplicação da base pelo valor da aliquota ³
						//³ NO CASO ABAIXO O VALOR DA BASE REFERENTE AO CáLCULO DO IGV é RECUPE-³
						//³ RADA PARA QUE POSTERIOREMENTE SEJAM GRAVADOS NOS VAMPOS F3_BASIMP3, ³
						//³ F3_ALQIMP3 E F3_VALIMP3 OS VALORES DA BASE, ALIQUOTA E VALOR DE IM- ³
						//³ POSTO REFERENTE AO IPM.
																		
						If cPaisLoc $ "PER"  
							alAreaX := SFC->(GetArea())
							alAreaY := GetArea()
							nPosTesX := aScan(aFixos,{|x| x[1] == "F3_TES"})                    
							DbSelectArea("SFC")
							DbSetOrder(2) 
							If MsSeek(xFilial("SFC")+aLivro[nX][nPosTesX]+"IGV")
								If Alltrim(aFixos[nY][1]) $ "F3_BASIMP1" 
									nlBsIGVSF3 := aLivro[nX][nY]
								EndIf
							EndIf
							RestArea(alAreaX)   
							RestArea(alAreaY)
						EndIf
					EndIf
				Next nY
				//³          TRATAMENTO EXPECIFICO PARA LOCALIZADO PERU                 ³
				//³ Quando o TES for referente ao imposto do IGV, o valor do IPM, o     ³
				//³ qual é uma porcentagem do IGV,o valor da base, aliquota e valor do  ³
				//³ imposto é gravado nos campos _BASIMP3, _ALQIMP3 e VALIMP3.          ³
				//³ O valor da base é a mesma utilizada para o cálculo do IGV.          ³
				//³ O valor da alíqutoa é proveniente de um paramêtro chamado           ³
				//³ MV_ALQIPM.                                                          ³
				//³ O valor do imposto é a multiplicação da base pelo valor da aliquota ³
				//³ No caso abaixo os valorres da base, aliquota e valor de imposto são ³
				//³ gravados nos campos F3_BASIMP3, F3_ALQIMP3 e F3_VALIMP3 referente ao³
				//³ IPM.                                                                ³

				If cPaisLoc $ "PER" .And. nlBsIGVSF3 > 0
					alAreaX := GetArea()
					SF3->F3_BASIMP3  := nlBsIGVSF3
					SF3->F3_ALQIMP3	 := aParSX6[MV_ALQIPM]
					SF3->F3_VALIMP3	 := nlBsIGVSF3 * (aParSX6[MV_ALQIPM]/100)					
					nlBsIGVSF3 := 0
					RestArea(alAreaX)
				EndIf
				SF3->F3_FILIAL	:= xFilial("SF3")
				SF3->F3_ENTRADA	:= IIF(Empty(dEntrada),dDatabase,dEntrada)
				SF3->F3_NFISCAL	:= cNumNF
				SF3->F3_SERIE  	:= cSerie
				SF3->F3_CLIEFOR	:= cCliFor
				SF3->F3_LOJA	:= cLoja
				SF3->F3_CLIENT 	:= aNFCab[NF_CLIENT]
				SF3->F3_LOJENT	:= aNFCab[NF_LOJENT]
				SF3->F3_PDV     := cPDV
				// Antes de passar o valor para o campo, verifico se a variavel esta preenchida. Caso esteja, significa que o campo continha este valor na linha que foi 
				// deletada(D_E_L_E_T_ = *) e por isso, nesta nova linha o valor deverá ser mantido.
				If Alltrim(cCodSef) <> ""
				   SF3->F3_CODRSEF := cCodSef
				Endif					
				If Alltrim(cCNAE) <> ""
					SF3->F3_CNAE := cCNAE
				Endif
				If aParSX6[MV_TMSUFPG] .And. !Empty(aNFCab[NF_PNF_UF]) .And. ("CTR"$AllTrim(aNFCab[NF_ESPECIE]).Or."NFST"$AllTrim(aNFCab[NF_ESPECIE]).Or."CTE"$AllTrim(aNFCab[NF_ESPECIE]).Or."RPS"$AllTrim(aNFCab[NF_ESPECIE]))
					SF3->F3_ESTADO := aNFCab[NF_PNF_UF]
				Else
					SF3->F3_ESTADO := IIF( cTpOper=="E" , aNFCab[NF_UFORIGEM] , aNFCab[NF_UFDEST] )
				EndIf
				SF3->F3_EMISSAO	:= dDEmissao
				SF3->F3_FORMUL	:= IIF(cTpOper=="E".Or.cPaisLoc<>"BRA",cFormul," ")
				SF3->F3_ESPECIE	:= cEspecie
				SF3->F3_DTCANC	:= CTOD("")         

				//Executa funcao generica para o processamento do SIGALOJA
				If aParSX6[MV_LJLVFIS] == 2 .And. cTpOper == "S"
					MaFisLojSF3(1,@aLivro,nX,cFunOrig,cAlias)
				EndIf
				
				//
				If Type("l920Auto") == "L" .And. !l920Auto
					SF3->F3_DOCOR := If(lLote,c920NfFim,SF3->F3_DOCOR)
					SF3->F3_TIPO  := If(lLote,"L",SF3->F3_TIPO)
				EndIf
				//Campos da Nota Fiscal Eletronica de Sao Paulo
				If lNFEletr
					SF3->F3_NFELETR	:= aNFEletr[01]
					SF3->F3_EMINFE	:= aNFEletr[02]
					SF3->F3_HORNFE	:= aNFEletr[03]
					SF3->F3_CODNFE	:= aNFEletr[04]
					SF3->F3_CREDNFE	:= aNFEletr[05]
					If aFieldPos[FP_F3_NUMRPS] 
						SF3->F3_NUMRPS	:= aNFEletr[06]
					Endif
				Endif  

				//Campos da NFe Argentina         
				If lNFEArg
					SF3->F3_TPVENT 	:= cTPVent 
					SF3->F3_CAE 	:= cCAE
					SF3->F3_VCTOCAE	:= dDtCAE					
				Endif

				//Declaracao das variaveis para Algoritmo MD5 Cat97	
				cCNPJM5	 :=	Repl("0",TamSx3("A1_CGC")[1]-Len(Alltrim(SA1->A1_CGC)))+AllTrim(SA1->A1_CGC)
				cNumNfM5 :=	Repl("0",TamSx3("F3_NFISCAL")[1]-Len(AllTrim(SF3->F3_NFISCAL)))+AllTrim(SF3->F3_NFISCAL)
				cChaveNf :=	SF3->(DToS(F3_ENTRADA)+F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA)
				//Algoritmo MD5 Cat97				  
				cAutDig1 :=	cCNPJM5+cNumNfM5+StrTran(StrZero(SF3->F3_VALCONT, 13, 2), ".", "")
				cAutDig1 +=	StrTran(StrZero(SF3->F3_BASEICM, 13, 2), ".", "")+StrTran(StrZero(SF3->F3_VALICM, 13, 2), ".", "")
						
				If aFieldPos[FP_F3_MDCAT79] 
    				SF3->F3_MDCAT79 := Md5(cAutDig1)
				EndIf
				//Credito Presumido Art. 6 Decreto n28.247       
				If aFieldPos[FP_F3_CRPREPE] 
					SF3->F3_CRPREPE	:= aNfCab[NF_CRPREPE]
				Endif
				//Credito Presumido Art. 6 Decreto n28.247       
				If aFieldPos[FP_F3_CREDPRE]
					SF3->F3_CREDPRE	:=	aNfCab[NF_CREDPRE]
				Endif
				//Percentual e Valor do incentivo prod.leite artigo 207-B RICMS-MG 
				If aFieldPos[FP_F3_VLINCMG]
				    SF3->F3_VLINCMG	:=	aNfCab [NF_VLINCMG]                         
				EndIf

				// FECOP RN e FECP-MG - nao sao necessario pois ja ha tratamento dinamico dos campos

 	            //REINTEGRA
			    If aFieldPos[FP_F3_VREINT] 
				    SF3->F3_VREINT	:=	aNfCab[NF_VREINT]
                EndIf                           
			    If aFieldPos[FP_F3_BSREIN] 
				    SF3->F3_BSREIN	:=	aNfCab[NF_BSREIN]
                EndIf
                //FECP-MT
			    If aFieldPos[FP_F3_VFECPMT]
				    SF3->F3_VFECPMT	:=	aNfCab[NF_VFECPMT]
                EndIf                           
                If aFieldPos[FP_F3_VFESTMT]
				    SF3->F3_VFESTMT	:=	aNfCab[NF_VFESTMT]
                Endif 
				//Campo da NF-e SPED              
				If lChvNfe
					SF3->F3_CHVNFE := cChvNfe
				Endif
				//³Campo da TPDP - PB              ³
				If aFieldPos[FP_F3_VALTPDP]
					SF3->F3_VALTPDP := aNfCab[NF_VALTPDP]
				Endif
				//³ Ponto de entrada para atualizar o livro fiscal   ³
				If aExistPE[PE_MTA920L] 
					ExecBlock("MTA920L",.F.,.F.)
				EndIf
				//³ Livro de ICMS - Ajuste SINEF 03/04 - DOU 08.04.04         ³
				If cPaisLoc == "BRA"
					If !Empty(aLivro[nX][35]) .And. (aLivro[nX][LF_ISS_ISENICM] <> 0 .Or. aLivro[nX][LF_ISS_OUTRICM] <> 0)
						aSF3 := {}
					    For nY := 1 To SF3->(FCount())
					    	aadd(aSF3,SF3->(FieldGet(nY)))
					    Next nY
						RecLock("SF3",.T.)
						For nY := 1 To Len(aSF3)
							If !"_MSIDENT"$SF3->(FieldName(nY))
								FieldPut(nY,aSF3[nY])
							EndIf
						Next nY
						SF3->F3_TIPO    := "N"
						SF3->F3_ALIQICM := aLivro[nX][LF_ISS_ALIQICMS]
						SF3->F3_BASEICM := 0
						SF3->F3_VALICM  := 0
						SF3->F3_ISENICM := aLivro[nX][LF_ISS_ISENICM]
						SF3->F3_OUTRICM := aLivro[nX][LF_ISS_OUTRICM]
						SF3->F3_BASEIPI := 0
						SF3->F3_VALIPI  := 0
						SF3->F3_ISENIPI := aLivro[nX][LF_ISS_ISENIPI]
						SF3->F3_OUTRIPI := aLivro[nX][LF_ISS_OUTRIPI]
						SF3->F3_CODISS  := ""
						SF3->F3_OBSERV  := "NOTA FISCAL DE SERVICO"  
						//
						//Desconto Zona Franca de Manaus
						//
						If aFieldPos[FP_F3_DESCZFR]
					 		SF3->F3_DESCZFR := aLivro[nX][LF_DESCZFR]
				 		EndIf
						//³Nota Fiscal Eletronica de Sao Paulo³
						If lNFEletr
							SF3->F3_NFELETR	:= aNFEletr[01]
							SF3->F3_EMINFE	:= aNFEletr[02]
							SF3->F3_HORNFE	:= aNFEletr[03]
							SF3->F3_CODNFE	:= aNFEletr[04]
							SF3->F3_CREDNFE	:= aNFEletr[05]
							If aFieldPos[FP_F3_NUMRPS]
								SF3->F3_NUMRPS	:= aNFEletr[06]
							Endif
						Endif 
						//³ Ponto de entrada para atualizar o livro fiscal   ³
						If aExistPE[PE_MTA920L]  
							ExecBlock("MTA920L",.F.,.F.)
						EndIf					
					EndIf
				EndIf

				If cPaisLoc == "BRA" .And. lIndicSFT
					//³ Grava arquivo de Livros Fiscais (SFT)                                  ³
					aWriteSFT := MaFisRelImp("MT100",{"SFT"})
					//³ Recupera os registros cancelados                                       ³
					cItemNF	:= StrZero(0,TamSx3("D2_ITEM")[1],0)	// Inicializa o Item

					For nZ := 1 To Len(aNfItem)
						//³ Para o SIGALOJA a numeracao dos itens nao considera deletados	  ³
						If cFunOrig == "LOJA701"
							If !aNfItem[nZ][IT_DELETED]
								cItemNF := SomaIt(cItemNF)
							EndIf
						Else
							cItemNF := aNfItem[nZ][IT_ITEM]		
						EndIf
						//Tratamento para ICMS-ST de transporte. Não deve possuir valor fiscal além do ICMS-ST.
						If aTes[TS_LFICM]=="Z" .And. aTes[TS_OBSSOL]=="5" .And. aNfItem[nZ][IT_VALSOL] > 0
							lIcmSTTran := .T.
						Endif
								
						If aNFCab[NF_OPERNF] == "S"
							dbSelectArea("SD2")
							dbSetOrder(3)
							MsSeek(xFilial("SD2")+cNumNF+cSerie+cCliFor+cLoja+aNfItem[nZ][IT_PRODUTO]+cItemNF)
							cCtaCont := SD2->D2_CONTA
						Else
							dbSelectArea("SD1")
							dbSetOrder(1)
							MsSeek(xFilial("SD1")+cNumNF+cSerie+cCliFor+cLoja+aNfItem[nZ][IT_PRODUTO]+cItemNF)
							cCtaCont := SD1->D1_CONTA
						EndIf
						//
						dbSelectArea("SFT")
						dbSetOrder(1)
						If (aNfItem[nZ][IT_LIVRO][LF_IDENT] == aLivro[nX][LF_IDENT]) .And. !aNfItem[nZ][IT_DELETED]
							RecLock("SFT",.T.)
							SFT->FT_FILIAL	:= xFilial("SFT")
							SFT->FT_TIPOMOV := cTpOper
							SFT->FT_EMISSAO	:= dDEmissao
							SFT->FT_ENTRADA	:= IIF(Empty(dEntrada),dDatabase,dEntrada)
							SFT->FT_NFISCAL	:= cNumNF
							SFT->FT_SERIE  	:= cSerie
							SFT->FT_CLIEFOR	:= cCliFor
							SFT->FT_LOJA	:= cLoja
							SFT->FT_CLIENT 	:= aNFCab[NF_CLIENT]
							SFT->FT_LOJENT	:= aNFCab[NF_LOJENT]
							SFT->FT_PDV     := cPDV
							SFT->FT_IDENTF3	:=	aNfItem[nZ][IT_LIVRO][LF_IDENT]
							If aParSX6[MV_TMSUFPG] .And. !Empty(aNFCab[NF_PNF_UF]) .And. (AllTrim(aNFCab[NF_ESPECIE]) $ "CTR/CTE" .Or."NFST"$AllTrim(aNFCab[NF_ESPECIE]))
								SFT->FT_ESTADO	:= aNFCab[NF_PNF_UF]
							Else
								SFT->FT_ESTADO	:= IIF( cTpOper == "E" , aNFCab[NF_UFORIGEM] , aNFCab[NF_UFDEST] )
							EndIf
							SFT->FT_FORMUL	:= IIF(cTpOper=="E".Or.cPaisLoc<>"BRA",cFormul," ")
							SFT->FT_ESPECIE	:= cEspecie
							SFT->FT_DTCANC	:= CTOD("")
							SFT->FT_TIPO  	:=  aNfItem[nZ][IT_LIVRO][LF_TIPO]
							SFT->FT_POSIPI	:=	aNfItem[nZ][IT_LIVRO][LF_POSIPI]
							SFT->FT_CLASFIS	:=	aNfItem[nZ][IT_LIVRO][LF_CLASFIS]
							SFT->FT_CTIPI	:=	aNfItem[nZ][IT_LIVRO][LF_CTIPI]							
							SFT->FT_ESTOQUE	:=	aNfItem[nZ][IT_LIVRO][LF_ESTOQUE]
							SFT->FT_DESPIPI	:=	aNfItem[nZ][IT_LIVRO][LF_DESPIPI]
							SFT->FT_ISENICM	:=	aNfItem[nZ][IT_LIVRO][LF_ISENICM]-aNfItem[nZ][IT_LIVRO][LF_ISENRET]
							SFT->FT_OUTRICM	:=	aNfItem[nZ][IT_LIVRO][LF_OUTRICM]-aNfItem[nZ][IT_LIVRO][LF_OUTRRET]
							SFT->FT_ICMSRET	:=	aNfItem[nZ][IT_LIVRO][LF_ICMSRET]
							SFT->FT_ITEMORI	:=	aNfItem[nZ][IT_LIVRO][LF_ITEMORI]
							SFT->FT_ALIQIPI	:=	aNfItem[nZ][IT_LIVRO][LF_ALIQIPI]
							SFT->FT_CONTA	:= 	cCtaCont
							SFT->FT_VALINS	:=	aNfItem[nZ][IT_VALINS]
							SFT->FT_ALIQINS	:=	aNfItem[nZ][IT_ALIQINS]
							SFT->FT_BASEINS	:=	aNfItem[nZ][IT_BASEINS]
							SFT->FT_VALINS	:=	aNfItem[nZ][IT_VALINS]
							SFT->FT_ALIQIRR	:=	aNfItem[nZ][IT_ALIQIRR]
							SFT->FT_BASEIRR	:=	aNfItem[nZ][IT_BASEIRR]
							SFT->FT_SEGURO	:=	aNfItem[nZ][IT_SEGURO]
							SFT->FT_FRETE	:=	aNfItem[nZ][IT_FRETE]
							SFT->FT_PRODUTO	:=	aNfItem[nZ][IT_PRODUTO]
							SFT->FT_BASEIRR	:=	aNfItem[nZ][IT_BASEIRR]
							SFT->FT_ALIQIRR	:=	aNfItem[nZ][IT_ALIQIRR]
							SFT->FT_VALIRR	:=	aNfItem[nZ][IT_VALIRR]
							SFT->FT_BASEINS	:=	aNfItem[nZ][IT_BASEINS]
							SFT->FT_ALIQINS	:=	aNfItem[nZ][IT_ALIQINS]
							SFT->FT_VALINS	:=	aNfItem[nZ][IT_VALINS]
							SFT->FT_ITEM	:=	cItemNF
							SFT->FT_QUANT	:=	aNfItem[nZ][IT_QUANT]
							SFT->FT_PRCUNIT	:=	aNfItem[nZ][IT_PRCUNI]
						    SFT->FT_TOTAL	:=	Iif(!lIcmSTTran,aNfItem[nZ][IT_VALMERC],0)
							SFT->FT_DESCONT	:=	aNfItem[nZ][IT_DESCONTO]
							SFT->FT_NFORI	:=	aNfItem[nZ][IT_NFORI]
							SFT->FT_SERORI	:=	aNfItem[nZ][IT_SERORI]
							SFT->FT_PESO	:=	aNfItem[nZ][IT_PESO]
							//Armazenar margem
							If aFieldPos[FP_FT_MARGEM]
								SFT->FT_MARGEM := aNfItem[nZ][IT_MARGEM]
							EndIf
							//
							//PIS/PASEP Apuracao
							SFT->FT_BASEPIS := aNfItem[nZ][IT_BASEPS2]
							SFT->FT_ALIQPIS := aNfItem[nZ][IT_ALIQPS2]
							SFT->FT_VALPIS	:= aNfItem[nZ][IT_VALPS2]
							//
							//COFINS Apuracao
							SFT->FT_BASECOF	:= aNfItem[nZ][IT_BASECF2]
							SFT->FT_ALIQCOF	:= aNfItem[nZ][IT_ALIQCF2]
							SFT->FT_VALCOF	:= aNfItem[nZ][IT_VALCF2]
							//
							//CSLL Apuracao
							SFT->FT_BASECSL	:= 0
							SFT->FT_ALIQCSL	:= 0
							SFT->FT_VALCSL	:= 0
							//
							//³Nota Fiscal Eletronica de Sao Paulo³
							If lNFEletr .And. ;
								aFieldPos[FP_FT_NFELETR] .And.;
								aFieldPos[FP_FT_EMINFE]  .And.;
								aFieldPos[FP_FT_HORNFE]  .And.;
								aFieldPos[FP_FT_CODNFE]  .And.;
								aFieldPos[FP_FT_CREDNFE]
								SFT->FT_NFELETR	:= aNFEletr[01]
								SFT->FT_EMINFE	:= aNFEletr[02]
								SFT->FT_HORNFE	:= aNFEletr[03]
								SFT->FT_CODNFE	:= aNFEletr[04]
								SFT->FT_CREDNFE	:= aNFEletr[05]
								If aFieldPos[FP_FT_NUMRPS]
									SFT->FT_NUMRPS	:= aNFEletr[06]
								Endif
							Endif                         
                            //
                            If aFieldPos[FP_FT_CSTPIS]
								SFT->FT_CSTPIS := aNfItem[nZ][IT_LIVRO][LF_CSTPIS]
							EndIf
                            If aFieldPos[FP_FT_CSTCOF]
								SFT->FT_CSTCOF := aNfItem[nZ][IT_LIVRO][LF_CSTCOF]
							EndIf
							If aFieldPos[FP_FT_CODBCC]
								SFT->FT_CODBCC := aNfItem[nZ][IT_LIVRO][LF_CODBCC]
							EndIf
							If aFieldPos[FP_FT_CV139]
								SFT->FT_CV139 := aNfItem[nZ][IT_CV139]
							EndIf
							If aFieldPos[FP_FT_INDNTFR]
								SFT->FT_INDNTFR := aNfItem[nZ][IT_LIVRO][LF_INDNTFR]
							EndIf
							//Campo da NF-e SPED              
							If lChvNfe
								SFT->FT_CHVNFE := cChvNfe
							Endif
							//Regime Especial de Substituicao Tributaria - MG
							If aFieldPos[FP_FT_RGESPST]
								SFT->FT_RGESPST := aNfItem[nZ][IT_RGESPST]
							Endif
							//Fundersul - Mato Grosso do Sul
							If aFieldPos[FP_FT_VALFDS] 
								SFT->FT_VALFDS := aNfItem[nZ][IT_VALFDS]
							Endif
							If aFieldPos[FP_FT_PRFDSUL]
								SFT->FT_PRFDSUL := aNfItem[nZ][IT_PRFDSUL]
							Endif
							If aFieldPos[FP_FT_UFERMS]
								SFT->FT_UFERMS := aNfItem[nZ][IT_UFERMS]
							Endif
                            //SENAR
							If aFieldPos[FP_FT_BSSENAR] 
								SFT->FT_BSSENAR := aNfItem[nZ][IT_BSSENAR]
							Endif
							If aFieldPos[FP_FT_VLSENAR]
								SFT->FT_VLSENAR := aNfItem[nZ][IT_VLSENAR]
							Endif
							If aFieldPos[FP_FT_ALSENAR]
								SFT->FT_ALSENAR := aNfItem[nZ][IT_ALSENAR]
							Endif
							//FETHAB - Mato Grosso
							If aFieldPos[FP_FT_BSEFET]
								SFT->FT_BSEFET := aNfItem[nZ][IT_BASEFET]
							Endif
							If aFieldPos[FP_FT_ALQFET]
								SFT->FT_ALQFET := aNfItem[nZ][IT_ALIQFET]
							Endif
							If aFieldPos[FP_FT_VALFET] 
								SFT->FT_VALFET := aNfItem[nZ][IT_VALFET]
							Endif
							//FABOV - Mato Grosso 
							If aFieldPos[FP_FT_BSEFAB]
								SFT->FT_BSEFAB := aNfItem[nZ][IT_BASEFAB]
							Endif
							If aFieldPos[FP_FT_ALQFAB]
								SFT->FT_ALQFAB := aNfItem[nZ][IT_ALIQFAB]
							Endif
							If aFieldPos[FP_FT_VALFAB]
								SFT->FT_VALFAB := aNfItem[nZ][IT_VALFAB]
							Endif
							//FACS - Mato Grosso  
							If aFieldPos[FP_FT_BSEFAC] 
								SFT->FT_BSEFAC := aNfItem[nZ][IT_BASEFAC]
							Endif
							If aFieldPos[FP_FT_ALQFAC]
								SFT->FT_ALQFAC := aNfItem[nZ][IT_ALIQFAC]
							Endif
							If aFieldPos[FP_FT_VALFAC]
								SFT->FT_VALFAC := aNfItem[nZ][IT_VALFAC]
							Endif
							//CODIF - Codigo de autorizacao para operacoes com AEAC - Combustiveis
							If aFieldPos[FP_FT_CODIF]
								SFT->FT_CODIF	:=	aNfItem[nZ][IT_CODIF]
                            Endif
                            If aFieldPos[FP_FT_NORESP]
								SFT->FT_NORESP	:=	aNfItem[nZ][IT_NORESPE]
							EndIf
							//Preco Unitario utilizado para calculo da Substituição tributária para fabrixante de Cigarros
							If aFieldPos[FP_FT_PRCUNIC]
								SFT->FT_PRCUNIC	:=	aNfItem[nZ][IT_PRCUNIC]
							EndIf
							//Coeficiente que foi utilizado para cálculo da Substituição Tributária do PIS para fabricante de cigarros.
							If aFieldPos[FP_FT_COEPSST]
								SFT->FT_COEPSST	:=	aNfItem[nZ][IT_COEPSST]
							EndIf	                            
							//Coeficiente que foi utilizado para cálculo da Substituição Tributária da COFINS para fabricante de cigarros.
							If aFieldPos[FP_FT_COECFST]
								SFT->FT_COECFST	:=	aNfItem[nZ][IT_COECFST]
							EndIf
                            If aFieldPos[FP_FT_AGREG]
								SFT->FT_AGREG	:=	aTes[TS_AGREG]
							EndIf
							If aFieldPos[FP_FT_DESCICM]
								SFT->FT_DESCICM	:=	aNfItem[nZ][IT_DEDICM]
                            EndIf
							//Credito Presumido Simples Nacional - SC                             
							If aFieldPos[FP_FT_CRPRSIM]
								SFT->FT_CRPRSIM	:=	aNfItem[nZ][IT_LIVRO][LF_CRPRSIM]
                            Endif
							//Credito Presumido                                                   
							If aFieldPos[FP_FT_CRDPRES]
								SFT->FT_CRDPRES	:=	aNfItem[nZ][IT_LIVRO][LF_CRDPRES]
                            Endif
							//Credito Presumido - PR                                              
							If aFieldPos[FP_FT_CRPREPR]
								SFT->FT_CRPREPR	:=	aNfItem[nZ][IT_LIVRO][LF_CRPREPR]
                            Endif
                            //Cred. Presumido-art.631-A do RICMS/2008                             
                            If aFieldPos[FP_FT_CPRESPR]
								SFT->FT_CPRESPR	:=	aNfItem[nZ][IT_LIVRO][LF_CPRESPR]
                            Endif
                            //Cred. Presumido-Decreto 52.586 de 28.12.2007                        
                            If aFieldPos[FP_FT_CRPRESP] 
								SFT->FT_CRPRESP	:=	aNfItem[nZ][IT_LIVRO][LF_CRPRESP]
                            Endif
                            //Cred. Presumido-Decreto 52.586 de 28.12.2007                        
                            If aFieldPos[FP_FT_CREDPRE]
								SFT->FT_CREDPRE	:=	aNfItem[nZ][IT_LIVRO][LF_CREDPRE]
                            Endif 
                            //Cred. Outotgado SP -Decreto 56.018 de 16.07.2010                    
                            If aFieldPos[FP_FT_CROUTSP]
								SFT->FT_CROUTSP	:=	aNfItem[nZ][IT_LIVRO][LF_CROUTSP]
                            Endif
							//Credito Outorgado - GO Inc.III, Art 11 Anexo IX - RCTE-GO/97	  
                            If aFieldPos[FP_FT_CROUTGO] 
							  	SFT->FT_CROUTGO	:=	aNfItem[nZ][IT_LIVRO][LF_CROUTGO]
                            Endif
							//Credito Presumido - RO                                              
							If aFieldPos[FP_FT_CRPRERO]
								SFT->FT_CRPRERO	:=	aNfItem[nZ][IT_LIVRO][LF_CRDPRES]
                            Endif
							//Credito Presumido Art.39 Anexo IV- RO                               
							If aFieldPos[FP_FT_CRPRRON] 
								SFT->FT_CRPRRON	:=	aNfItem[nZ][IT_LIVRO][LF_CRPRERO]
							Endif
							//Credito Presumido - Art. 6 Decreto  n28.247                    
							If aFieldPos[FP_FT_CRPREPE] 
								SFT->FT_CRPREPE	:=	aNfItem[nZ][IT_LIVRO][LF_CRPREPE]
							Endif
							// PRODEPE
							If aFieldPos[FP_FT_CPPRODE] 
								SFT->FT_CPPRODE	:=	aNfItem[nZ][IT_LIVRO][LF_CPPRODE]
							Endif
							If aFieldPos[FP_FT_TPPRODE] 
								SFT->FT_TPPRODE	:=	aNfItem[nZ][IT_LIVRO][LF_TPPRODE]
							Endif
							//Antecipacao Tribut. ICMS                                       
							If aFieldPos[FP_FT_ANTICMS] 
								SFT->FT_ANTICMS	:=	aNfItem[nZ][IT_LIVRO][LF_ANTICMS]
                            Endif
							//Valor Antecipacao ICMS 				                          
							If aFieldPos[FP_FT_VALANTI] 
								SFT->FT_VALANTI	:=	aNfItem[nZ][IT_LIVRO][LF_VALANTI]
                            Endif
							//Valor do FECP           				                          
							If aFieldPos[FP_FT_ALQFECP] 
								SFT->FT_ALQFECP	:=	aNfItem[nZ][IT_ALIQFECP]
                            Endif
                            
							If aFieldPos[FP_FT_VALFECP]
								SFT->FT_VALFECP	:=	aNfItem[nZ][IT_VALFECP]
                        	Endif
                        	If aFieldPos[FP_FT_VFECPST]
								SFT->FT_VFECPST	:=	aNfItem[nZ][IT_VFECPST]
                        	Endif                                         
							//Valor do FECOP RN
							If aFieldPos[FP_FT_ALFECRN]
								SFT->FT_ALFECRN	:=	aNfItem[nZ][IT_ALFECRN]
                            Endif
							If aFieldPos[FP_FT_VFECPRN]
								SFT->FT_VFECPRN	:=	aNfItem[nZ][IT_VFECPRN]
                        	Endif
                        	If aFieldPos[FP_FT_VFESTRN]
								SFT->FT_VFESTRN	:=	aNfItem[nZ][IT_VFESTRN]
                        	Endif                                         							
 							//Valor do FECP-MG        				                          
							If aFieldPos[FP_FT_ALFECMG]
								SFT->FT_ALFECMG	:=	aNfItem[nZ][IT_ALFECMG]
                            Endif                            
							If aFieldPos[FP_FT_VFECPMG]
								SFT->FT_VFECPMG	:=	aNfItem[nZ][IT_VFECPMG]
                        	Endif                            
                        	If aFieldPos[FP_FT_VFESTMG]
								SFT->FT_VFESTMG	:=	aNfItem[nZ][IT_VFESTMG]
                        	Endif
                        	//Valor do FECP-MT        				                          
							If aFieldPos[FP_FT_ALFECMT]
								SFT->FT_ALFECMT	:=	aNfItem[nZ][IT_ALFECMT]
                            Endif                            
							If aFieldPos[FP_FT_VFECPMT]
								SFT->FT_VFECPMT	:=	aNfItem[nZ][IT_VFECPMT]
                        	Endif                            
                        	If aFieldPos[FP_FT_VFESTMT]
								SFT->FT_VFESTMT	:=	aNfItem[nZ][IT_VFESTMT]
                        	Endif                                                                						
 							//Valor de Reintegra        				                          
							If aFieldPos[FP_FT_VREINT]
								SFT->FT_VREINT	:=	aNfItem[nZ][IT_LIVRO][LF_VREINT]   								                     
                            Endif                            
							If aFieldPos[FP_FT_BSREIN]
								SFT->FT_BSREIN	:=	aNfItem[nZ][IT_LIVRO][LF_BSREIN]
                            Endif   
                            //DIAT-SC
                            If aFieldPos[FP_FT_B1DIAT]
								SFT->FT_B1DIAT	:= aNfItem[nZ][IT_B1DIAT]
                            Endif
                            
                            If aFieldPos[FP_FT_DESCTOT]
								SFT->FT_DESCTOT	:= aNfItem[nZ][IT_DESCTOT]
                            Endif 
                            If aFieldPos[FP_FT_ACRESCI]
								SFT->FT_ACRESCI	:= aNfItem[nZ][IT_ACRESCI]
                            Endif                             
                        	                                    
  							For nY := 1 to Len(aWriteSFT)
								If !(AllTrim (aWriteSFT[nY][2])$"FT_ISENICM/FT_OUTRICM/FT_ICMSRET/FT_FORMUL")	//SAO GRAVADOS ACIMA
									FieldPut(FieldPos(aWriteSFT[nY][2]),MaFisRet(nZ,aWriteSFT[nY][3]))
								EndIf
							Next nY

							//Valor do FUMACOP        				                          
							If aFieldPos[FP_FT_ALQFUM]
								SFT->FT_ALQFUM	:=	aNfItem[nZ][IT_ALIQFUM]
                            Endif
							If aFieldPos[FP_FT_VALFUM]
								SFT->FT_VALFUM	:=	aNfItem[nZ][IT_VALFUM]
                        	Endif
							//ICMS frete autonomo - Embarcador
							If aFieldPos[FP_FT_BASETST] .And. aFieldPos[FP_FT_ALIQTST]  .And. aFieldPos[FP_FT_VALTST] .And. aNfCab[NF_RECFAUT] <> "2"
								SFT->FT_BASETST	:= aNfItem[nZ][IT_BASETST]
								SFT->FT_ALIQTST	:= aNfItem[nZ][IT_ALIQTST]
								SFT->FT_VALTST 	:= aNfItem[nZ][IT_VALTST]
							Endif
							//Valor da aliquota de ICMS Solidario                
							If aFieldPos[FP_FT_ALIQSOL]
								SFT->FT_ALIQSOL	:=	aNfItem[nZ][IT_ALIQSOL]
                            Endif    
							//Pautas
							If aFieldPos[FP_FT_PAUTST]
								SFT->FT_PAUTST	:=	aNfItem[nZ][IT_PAUTST]
							Endif
							If aFieldPos[FP_FT_PAUTIC] 
								SFT->FT_PAUTIC	:=	aNfItem[nZ][IT_PRD][SB_VLR_ICM]
							Endif
							If aFieldPos[FP_FT_PAUTIPI]
								SFT->FT_PAUTIPI	:=	aNfItem[nZ][IT_PRD][SB_VLR_IPI]
							Endif                                
							// Verifica se existe excecao fiscal para pauta do PIS    
							If (cAliasProd)->(MsSeek(xFilial(cAliasProd)+aNfItem[nZ][IT_PRODUTO])) .And. cPaisLoc=="BRA"
								nPautaPIS := aNfItem[nZ][IT_PRD][SB_VLR_PIS]
								nPautaCOF := aNfItem[nZ][IT_PRD][SB_VLR_COF]
							Endif	
							If aFieldPos[FP_FT_PAUTPIS]
								If !Empty(aNfItem[nZ][IT_EXCECAO]) .And. !Empty(aNfItem[nZ][IT_EXCECAO][10]) 
									SFT->FT_PAUTPIS	:= aNfItem[nZ][IT_EXCECAO][10]
								Else
									SFT->FT_PAUTPIS	:=  nPautaPis
								EndIf 
							Endif   
							// Verifica se existe excecao fiscal para pauta do COFINS 
							If aFieldPos[FP_FT_PAUTCOF] 
								If !Empty(aNfItem[nZ][IT_EXCECAO]) .And. !Empty(aNfItem[nZ][IT_EXCECAO][11]) 
									SFT->FT_PAUTCOF	:= aNfItem[nZ][IT_EXCECAO][11]
								Else
									SFT->FT_PAUTCOF	:= nPautaCof
								EndIf 
							Endif
						 	If aFieldPos[FP_FT_CSTISS] 
								SFT->FT_CSTISS	:= aNfItem[nZ][IT_LIVRO][LF_CSTISS] 
							Endif
							//Percentual da reducao de base - decreto 43.080/2002 do RICMS-MG                           
						 	If aFieldPos[FP_FT_PR43080]
								SFT->FT_PR43080	:= aNfItem[nZ][IT_PR43080] 
							Endif       
							//Valor do desconto - Decreto 43.080/2002 do RICMS-MG                    
							If aFieldPos[FP_FT_DS43080]
								SFT->FT_DS43080:= aNfItem[nZ][IT_LIVRO][LF_DS43080]
							Endif
							If aFieldPos[FP_FT_DESCZFR]
								SFT->FT_DESCZFR	:= aNfItem[nZ][IT_LIVRO][LF_DESCZFR]
							Endif                             
                     		//Incentivo à produção e à industrialização do leite
							If aFieldPos[FP_FT_VLINCMG] 
								SFT->FT_VLINCMG	:=	aNfItem[nZ][IT_VLINCMG]
                     Endif
							If aFieldPos[FP_FT_PRINCMG]
								SFT->FT_PRINCMG	:=	aNfItem[nZ][IT_PRINCMG]
                    	Endif
							//Aliquota Majorada da COFINS
							If aFieldPos[FP_FT_MALQCOF] .And. aFieldPos[FP_FT_MVALCOF]
								SFT->FT_MVALCOF := aNfItem[nZ][IT_LIVRO][LF_VALCMAJ] 
								SFT->FT_MALQCOF := aNfItem[nZ][IT_LIVRO][LF_ALQCMAJ]
				   		EndIf                         	
							//Aliquota Majorada da PIS
							If aFieldPos[FP_FT_MALQPIS] .And. aFieldPos[FP_FT_MVALPIS]
								SFT->FT_MVALPIS := aNfItem[nZ][IT_LIVRO][LF_VALPMAJ] 
								SFT->FT_MALQPIS := aNfItem[nZ][IT_LIVRO][LF_ALQPMAJ]
				   		EndIf                        
							//Executa funcao generica para o processamento do SIGALOJA
							If aParSX6[MV_LJLVFIS] == 2 .And. cTpOper == "S"
								MaFisLojSF3(2,NIL,nZ,cFunOrig,cAlias)
							EndIf
						EndIf                                   
											
						If aAliIndic[AI_CD2]
							For nA := 1 To Len(aNfItem[nZ][IT_SPED])
								If (aNfItem[nZ][IT_LIVRO][LF_IDENT]==aLivro[nX][LF_IDENT]) .And. !aNfItem[nZ][IT_DELETED]
								
									//EMPRESA PÚBLICA E ISENTO
									If SA1->A1_TPESSOA$"EP" .And. aNfItem[nZ][IT_SPED][nA][SP_CST] == "40" .And. aNfItem[nZ][IT_SPED][nA][SP_IMP]$"ICM" 
										lIsenEP	:= .T.
									Endif
									
									RecLock("CD2",.T.)
									CD2->CD2_FILIAL := xFilial("CD2")
									CD2->CD2_TPMOV  := cTpOper
									CD2->CD2_SERIE  := cSerie
									CD2->CD2_DOC    := cNumNF
									If (cTpOper == "S" .And. !aNfItem[nZ][IT_LIVRO][LF_TIPO]$"DB") .Or.;
										(cTpOper == "E" .And. aNfItem[nZ][IT_LIVRO][LF_TIPO]$"DB")
										CD2->CD2_CODCLI := cCliFor
										CD2->CD2_LOJCLI := cLoja
									Else
										CD2->CD2_CODFOR := cCliFor
										CD2->CD2_LOJFOR	:= cLoja
									EndIf								
									CD2->CD2_ITEM   := aNfItem[nZ][IT_SPED][nA][SP_ITEM]
									CD2->CD2_CODPRO := aNfItem[nZ][IT_SPED][nA][SP_CODPRO]
									CD2->CD2_IMP    := aNfItem[nZ][IT_SPED][nA][SP_IMP]
									CD2->CD2_ORIGEM := aNfItem[nZ][IT_SPED][nA][SP_ORIGEM]
									CD2->CD2_CST    := aNfItem[nZ][IT_SPED][nA][SP_CST]
									CD2->CD2_MODBC  := aNfItem[nZ][IT_SPED][nA][SP_MODBC]
									CD2->CD2_MVA    := aNfItem[nZ][IT_SPED][nA][SP_MVA]
									CD2->CD2_PREDBC := aNfItem[nZ][IT_SPED][nA][SP_PREDBC]
									CD2->CD2_BC     := IIf(!lIsenEP,aNfItem[nZ][IT_SPED][nA][SP_BC],0)
									CD2->CD2_ALIQ   := IIf(!lIsenEP,aNfItem[nZ][IT_SPED][nA][SP_ALIQ],0)
									CD2->CD2_VLTRIB := IIf(!lIsenEP,aNfItem[nZ][IT_SPED][nA][SP_VLTRIB],0)
									CD2->CD2_QTRIB  := aNfItem[nZ][IT_SPED][nA][SP_QTRIB]
									CD2->CD2_PAUTA  := aNfItem[nZ][IT_SPED][nA][SP_PAUTA]
									CD2->CD2_COD_MN := aNfItem[nZ][IT_SPED][nA][SP_COD_MN]
									
									If aFieldPos[FP_CD2_PARTIC]
										CD2->CD2_PARTIC  := aNfItem[nZ][IT_SPED][nA][SP_PARTICM] 
									EndIf 
									
									If aFieldPos[FP_CD2_FORMU]
										CD2->CD2_FORMU  := cFormul
									EndIf
									If aFieldPos[FP_CD2_DESCZF]
										CD2->CD2_DESCZF  := aNfItem[nZ][IT_SPED][nA][SP_DESCZF]
									EndIf
									lIsenEP	:= .F.
									MsUnLock()
								Endif
            				Next nA
						EndIf					
						
						If (aNfItem[nZ][IT_LIVRO][LF_IDENT]==aLivro[nX][LF_IDENT]) .And. !aNfItem[nZ][IT_DELETED]									
							// Ponto de entrada para atualizar o Relac.Imp.Doc.Fiscal e/ou Livro Fiscal por Item
							If aExistPE[PE_XFCD2SFT]  
								ExecBlock("XFCD2SFT",.F.,.F.)
							EndIf
						EndIf
						
					Next nZ
				EndIf
			EndIf
		Next nX
	EndIf

	// Deleta os registros fiscais cancelados.      
	If Len(aRecSF3) > Len(aLivro)
		For nX := (Len(aLivro)+1) To Len(aRecSF3)
			//Exclui as tabelas de complementos por NF do Sped  
			If lSped         
				M926DlSped(1,SF3->F3_NFISCAL,SF3->F3_SERIE,SF3->F3_CLIEFOR,SF3->F3_LOJA,SF3->F3_CFO)
			Endif
			SF3->(MsGoto(aRecSF3[nX]))
			RecLock("SF3",.F.)
			SF3->(dbDelete())
		Next nX
	EndIf

	If (cPaisLoc=="BRA" .And. aAliIndic[AI_SFT] )
		If Len(aRecSFT) > Len(aNfItem)
			For nX := (Len(aNfItem)+1) To Len(aRecSFT)
				//Exclui as tabelas de complementos por item do Sped
				If lSped         
					M926DlSped(2,SFT->FT_NFISCAL,SFT->FT_SERIE,SFT->FT_CLIEFOR,SFT->FT_LOJA,SFT->FT_TIPOMOV,SFT->FT_ITEM,SFT->FT_PRODUTO)
				Endif
				SFT->(MsGoto(aRecSFT[nX]))
				RecLock("SFT",.F.)
				SFT->(dbDelete())
			Next nX
		EndIf	
	EndIf	
Case nCD2 == 1
	If (cPaisLoc=="BRA" .And. aAliIndic[AI_CD2])
		dbSelectArea("CD2")
		dbSetOrder(2)
		#IFDEF TOP
			If TcSrvType()<>"AS/400"
				cAliasCD2 := "MaFisAtuCD2"
				lQuery    := .T.
	
				cQuery := "SELECT CD2_FILIAL,CD2_TPMOV,CD2_DOC,CD2_SERIE,CD2_CODCLI,CD2_LOJCLI,CD2_CODFOR,CD2_LOJFOR,R_E_C_N_O_ CD2RECNO "
				cQuery += "FROM "+RetSqlName("CD2")+" CD2 "
				cQuery += "WHERE CD2.CD2_FILIAL='"+xFilial("CD2")+"' AND "
				cQuery += "CD2.CD2_SERIE='"+cSerie+"' AND "
				cQuery += "CD2.CD2_DOC='"+cNumNF+"' AND "
				cQuery += "CD2.CD2_TPMOV='"+cTpOper+"' AND "
				If (cTpOper=="E" .And. !aNfCab[NF_TIPONF]$"DB")
					If !cFormul=="S"
					cQuery += "CD2.CD2_CODFOR='"+cCliFor+"' AND "
					cQuery += "CD2.CD2_LOJFOR='"+cLoja+"' AND "
					EndIf
				EndIf
				If aFieldPos[FP_CD2_FORMU] .And. cFormul=="S"
					cQuery += "CD2.CD2_FORMU='S' AND "
				EndIf
				cQuery += "CD2.D_E_L_E_T_=' ' "
				cQuery += "ORDER BY "+SqlOrder(CD2->(IndexKey()))
	
				cQuery := ChangeQuery(cQuery)
	
				dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasCD2)
			Else
		#ENDIF
				MsSeek(xFilial("CD2")+cTpOper+cSerie+cNumNF+IIf(!(cTpOper=="S".Or.cFormul=="S"),cCliFor+cLoja,""))
		#IFDEF TOP
			EndIf
		#ENDIF
		While (!Eof() .And.;
			(cAliasCD2)->CD2_FILIAL == xFilial("CD2") .And.;
			(cAliasCD2)->CD2_TPMOV  == cTpOper	.And.;
			(cAliasCD2)->CD2_DOC    == cNumNF  .And.;
			(cAliasCD2)->CD2_SERIE  == cSerie  .And.;
			IIf(cTpOper=="S" .Or. (cTpOper=="E" .And. aNfCab[NF_TIPONF]$"DB") .Or. cFormul=="S",.T.,(cAliasCD2)->CD2_CODFOR == cCliFor .And. (cAliasCD2)->CD2_LOJFOR == cLoja))	

			If lQuery
				CD2->(dbGoto((cAliasCD2)->CD2RECNO))
			EndIf
			
			RecLock("CD2")
			dbdelete()
			MsUnLock()
			
			dbSelectArea(cAliasCD2)
			dbSkip()
		EndDo
		If lQuery
			dbSelectArea(cAliasCD2)
			dbCloseArea()
			dbSelectArea("CD2")
		EndIf
	EndIf
	For nZ := 1 To Len(aNfItem)
		If aNFCab[NF_OPERNF] == "S"
			dbSelectArea("SD2")
			dbSetOrder(3)
			MsSeek(xFilial("SD2")+cNumNF+cSerie+cCliFor+cLoja+aNfItem[nZ][IT_PRODUTO]+aNfItem[nZ][IT_ITEM])
			cCtaCont := SD2->D2_CONTA
		Else
			dbSelectArea("SD1")
			dbSetOrder(1)
			MsSeek(xFilial("SD1")+cNumNF+cSerie+cCliFor+cLoja+aNfItem[nZ][IT_PRODUTO]+aNfItem[nZ][IT_ITEM])
			cCtaCont := SD1->D1_CONTA
		EndIf
		If aAliIndic[AI_CD2]
			For nA := 1 To Len(aNfItem[nZ][IT_SPED])
				If !aNfItem[nZ][IT_DELETED]
					RecLock("CD2",.T.)
					CD2->CD2_FILIAL := xFilial("CD2")
					CD2->CD2_TPMOV  := cTpOper
					CD2->CD2_SERIE  := cSerie
					CD2->CD2_DOC    := cNumNF
					If (cTpOper == "S" .And. !aNfItem[nZ][IT_LIVRO][LF_TIPO]$"DB") .Or.;
						(cTpOper == "E" .And. aNfItem[nZ][IT_LIVRO][LF_TIPO]$"DB")
						CD2->CD2_CODCLI := cCliFor
						CD2->CD2_LOJCLI := cLoja
					Else
						CD2->CD2_CODFOR := cCliFor
						CD2->CD2_LOJFOR	:= cLoja
					EndIf								
					CD2->CD2_ITEM   := aNfItem[nZ][IT_SPED][nA][SP_ITEM]
					CD2->CD2_CODPRO := aNfItem[nZ][IT_SPED][nA][SP_CODPRO]
					CD2->CD2_IMP    := aNfItem[nZ][IT_SPED][nA][SP_IMP]
					CD2->CD2_ORIGEM := aNfItem[nZ][IT_SPED][nA][SP_ORIGEM]
					CD2->CD2_CST    := aNfItem[nZ][IT_SPED][nA][SP_CST]
					CD2->CD2_MODBC  := aNfItem[nZ][IT_SPED][nA][SP_MODBC]
					CD2->CD2_MVA    := aNfItem[nZ][IT_SPED][nA][SP_MVA]
					CD2->CD2_PREDBC := aNfItem[nZ][IT_SPED][nA][SP_PREDBC]
					CD2->CD2_BC     := aNfItem[nZ][IT_SPED][nA][SP_BC]
					CD2->CD2_ALIQ   := aNfItem[nZ][IT_SPED][nA][SP_ALIQ]
					CD2->CD2_VLTRIB := aNfItem[nZ][IT_SPED][nA][SP_VLTRIB]
					CD2->CD2_QTRIB  := aNfItem[nZ][IT_SPED][nA][SP_QTRIB]
					CD2->CD2_PAUTA  := aNfItem[nZ][IT_SPED][nA][SP_PAUTA]
					CD2->CD2_COD_MN := aNfItem[nZ][IT_SPED][nA][SP_COD_MN]
					If aFieldPos[FP_CD2_FORMU]
						CD2->CD2_FORMU  := cFormul
					EndIf
					If aFieldPos[FP_CD2_DESCZF]
						CD2->CD2_DESCZF := aNfItem[nZ][IT_SPED][nA][SP_DESCZF]
					EndIf
					MsUnLock()
				Endif
	   		Next nA
		EndIf					
	Next nZ
	// Ponto de entrada para atualizar o Relac.Imp.Doc.Fiscal e/ou Livro Fiscal por Item
	If aExistPE[PE_XFCD2SFT]  
		ExecBlock("XFCD2SFT",.F.,.F.)
	EndIf

OtherWise

	If (cPaisLoc=="BRA" .And. aAliIndic[AI_CD2])
		dbSelectArea("CD2")
		dbSetOrder(2)
		#IFDEF TOP
			If TcSrvType()<>"AS/400"
				cAliasCD2 := "MaFisAtuCD2"
				lQuery    := .T.
				cQuery := "SELECT CD2_FILIAL,CD2_TPMOV,CD2_DOC,CD2_SERIE,CD2_CODCLI,CD2_LOJCLI,CD2_CODFOR,CD2_LOJFOR,R_E_C_N_O_ CD2RECNO "
				cQuery += "FROM "+RetSqlName("CD2")+" CD2 "
				cQuery += "WHERE CD2.CD2_FILIAL='"+xFilial("CD2")+"' AND "
				cQuery += "CD2.CD2_SERIE='"+cSerie+"' AND "
				cQuery += "CD2.CD2_DOC='"+cNumNF+"' AND "
				cQuery += "CD2.CD2_TPMOV='"+cTpOper+"' AND "
				If (cTpOper=="E" .And. !aNfCab[NF_TIPONF]$"DB")
					If !cFormul=="S"
					cQuery += "CD2.CD2_CODFOR='"+cCliFor+"' AND "
					cQuery += "CD2.CD2_LOJFOR='"+cLoja+"' AND "
					EndIf
				EndIf
				If aFieldPos[FP_CD2_FORMU] .And. cFormul=="S"
					cQuery += "CD2.CD2_FORMU='S' AND "
				EndIf
				cQuery += "CD2.D_E_L_E_T_=' ' "
				cQuery += "ORDER BY "+SqlOrder(CD2->(IndexKey()))
	
				cQuery := ChangeQuery(cQuery)
	
				dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasCD2)
			Else
		#ENDIF
				MsSeek(xFilial("CD2")+cTpOper+cSerie+cNumNF+IIf(!(cTpOper=="S".Or.cFormul=="S"),cCliFor+cLoja,""))
		#IFDEF TOP
			EndIf
		#ENDIF
		While (!Eof() .And.;
			(cAliasCD2)->CD2_FILIAL == xFilial("CD2") .And.;
			(cAliasCD2)->CD2_TPMOV  == cTpOper	.And.;
			(cAliasCD2)->CD2_DOC    == cNumNF  .And.;
			(cAliasCD2)->CD2_SERIE  == cSerie  .And.;
			IIf(cTpOper=="S" .Or. (cTpOper=="E" .And. aNfCab[NF_TIPONF]$"DB") .Or. cFormul=="S",.T.,(cAliasCD2)->CD2_CODFOR == cCliFor .And. (cAliasCD2)->CD2_LOJFOR == cLoja))			 	

			If lQuery
				CD2->(dbGoto((cAliasCD2)->CD2RECNO))
			EndIf
			
			RecLock("CD2")
			dbdelete()
			MsUnLock()
			
			dbSelectArea(cAliasCD2)
			dbSkip()
		EndDo
		If lQuery
			dbSelectArea(cAliasCD2)
			dbCloseArea()
			dbSelectArea("CD2")
		EndIf
	EndIf

	// Carega o Array contendo os Registros Fiscais (SF3)      
	dbSelectArea("SF3")
	dbSetOrder(If(cTpOper == "S".Or.cFormul=="S",5,4))
	#IFDEF TOP
		If TcSrvType()<>"AS/400"
			cAliasSF3 := "MaFisAtuSF3"
			lQuery    := .T.

			cQuery := "SELECT F3_FILIAL,F3_NFISCAL,F3_SERIE,F3_CLIEFOR,"
			cQuery += "F3_LOJA,F3_CFO,F3_FORMUL,R_E_C_N_O_ SF3RECNO "
			cQuery += "FROM "+RetSqlName("SF3")+" SF3 "
			cQuery += "WHERE SF3.F3_FILIAL='"+xFilial("SF3")+"' AND "
			cQuery += "SF3.F3_SERIE='"+cSerie+"' AND "
			cQuery += "SF3.F3_NFISCAL='"+cNumNF+"' AND "
			If !(cTpOper=="S".Or.cFormul=="S")
				cQuery += "SF3.F3_CLIEFOR='"+cCliFor+"' AND "
				cQuery += "SF3.F3_LOJA='"+cLoja+"' AND "
			EndIf
			cQuery += "SF3.D_E_L_E_T_=' ' "
			cQuery += "ORDER BY "+SqlOrder(SF3->(IndexKey()))

			cQuery := ChangeQuery(cQuery)

			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSF3,.T.,.T.)	
		Else
	#ENDIF
		MsSeek(xFilial("SF3")+IIf(cTpOper=="S".Or.cFormul=="S",cSerie+cNumNF,cCliFor+cLoja+cNumNF+cSerie))
		#IFDEF TOP
		EndIf
		#ENDIF
	While (!Eof().And. (cAliasSF3)->F3_FILIAL == xFilial("SF3") .And.;
			(cAliasSF3)->F3_NFISCAL == cNumNF .And.;
			(cAliasSF3)->F3_SERIE == cSerie .And.;
			IIf(cTpOper=="S".Or.cFormul=="S",.T.,(cAliasSF3)->F3_CLIEFOR == cCliFor .And.;
			(cAliasSF3)->F3_LOJA == cLoja) )
		If ((cTpOper == "E" .And. Substr((cAliasSF3)->F3_CFO,1,1) < "5" .And. (cAliasSF3)->F3_FORMUL == cFormul) .Or.;
				(cTpOper == "S" .And. Substr((cAliasSF3)->F3_CFO,1,1) > "4")) .Or. ( (SubStr((cAliasSF3)->F3_CFO,1,3)$"999#000") )
			If lQuery
				aadd(aRecSF3,(cAliasSF3)->SF3RECNO)
			Else
				aadd(aRecSF3,RecNo())
			EndIf
		EndIf
		dbSelectArea(cAliasSF3)
		dbSkip()
	EndDo
	If lQuery
		dbSelectArea(cAliasSF3)
		dbCloseArea()
		dbSelectArea("SF3")
	EndIf
	If (cPaisLoc=="BRA" .And. aAliIndic[AI_SFT] )
		dbSelectArea("SFT")
		dbSetOrder(1)
		#IFDEF TOP
			cAliasSFT := "MaFisAtuSFT"
			lQuery    := .T.

			cQuery := "SELECT FT_FILIAL, FT_TIPOMOV, FT_NFISCAL,FT_SERIE,FT_CLIEFOR,FT_LOJA,"
			cQuery += "FT_CFOP,FT_FORMUL,FT_DTCANC, R_E_C_N_O_ SFTRECNO "
			cQuery += "FROM "+RetSqlName("SFT")+" SFT "
			cQuery += "WHERE SFT.FT_FILIAL='"+xFilial("SFT")+"' AND "
			cQuery += "SFT.FT_TIPOMOV='"+cTpOper+"' AND "
			cQuery += "SFT.FT_SERIE='"+cSerie+"' AND "
			cQuery += "SFT.FT_NFISCAL='"+cNumNF+"' AND "
			If !(cTpOper=="S".Or.cFormul=="S")
				cQuery += "SFT.FT_CLIEFOR='"+cCliFor+"' AND "
				cQuery += "SFT.FT_LOJA='"+cLoja+"' AND "
			EndIf
			cQuery += "SFT.D_E_L_E_T_=' ' "
			cQuery += "ORDER BY "+SqlOrder(SFT->(IndexKey()))

			cQuery := ChangeQuery(cQuery)

			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSFT)

			TcSetField(cAliasSFT,"FT_DTCANC","D",8,0)
		#ELSE
			MsSeek(xFilial("SFT")+cTpOper+cSerie+cNumNF+IIf(!(cTpOper=="S".Or.cFormul=="S"),cCliFor+cLoja,""))
		#ENDIF
		While (!Eof().And. (cAliasSFT)->FT_FILIAL == xFilial("SFT") .And.;
			(cAliasSFT)->FT_NFISCAL == cNumNF .And. (cAliasSFT)->FT_SERIE == cSerie .And.;
			IIf(cTpOper=="S".Or.cFormul=="S",.T.,(cAliasSFT)->FT_CLIEFOR == cCliFor .And. (cAliasSFT)->FT_LOJA == cLoja) )

			If ((cTpOper == "E" .And. Substr((cAliasSFT)->FT_CFOP,1,1) < "5" .And. (cAliasSFT)->FT_FORMUL == cFormul) .Or.;
					(cTpOper == "S" .And. Substr((cAliasSFT)->FT_CFOP,1,1) > "4")) .Or. ( (SubStr((cAliasSFT)->FT_CFOP,1,3)$"999#000") )
				If lQuery
					aadd(aRecSFT,(cAliasSFT)->SFTRECNO)
				Else
					aadd(aRecSFT,RecNo())
				EndIf
			EndIf
			dbSelectArea(cAliasSFT)
			dbSkip()
		EndDo
		If lQuery
			dbSelectArea(cAliasSFT)
			dbCloseArea()
			dbSelectArea("SFT")
		EndIf	
	EndIf	
	// Cancelamento dos Livros Fiscais.                         
	dbSelectArea('SF3')
	For nX := 1 to Len(aRecSF3)
		If cFormul == "S" .Or. cTpOper == "S"
			MsGoto(aRecSF3[nX])
			RecLock("SF3",.F.)
			If IIf(cPaisLoc<>"BRA",lAnulaSF3,.T.)			
				SF3->F3_DTCANC := dDataBase
				SF3->F3_OBSERV := Iif("DENEGADA"$SF3->F3_OBSERV,STR0008+"/"+SF3->F3_OBSERV,STR0008) //"NF CANCELADA" OU "NF CANCELADA/NF DENEGADA"
				If cPaisLoc == "DOM" 
					If aFieldPos[FP_F3_TIPANUL] .And. FindFunction("LcGetTAnu") // Tipo Anulacao Republica Dominicana
						SF3->F3_TIPANUL := LcGetTAnu() //Funcao Localizada em LocXNF
					EndIf
					If aFieldPos[FP_F3_NCF]
						SF3->F3_NCF := &((cAlias)->(PrefixoCpo(cAlias)+"_NCF"))
					EndIf
				EndIf
				// Isaac Silva 12/01/2010
				If cPaisLoc == "ARG" .And. lProcArg
					// Rotina para marcar todas as notas fiscais que o campo F3_NFISCAL = F3_NFAGREG
					cClieForn := SF3->F3_CLIEFOR
					cLojac    := SF3->F3_LOJA
					cSeriec   := SF3->F3_SERIE
					cNfAgreg  := SF3->F3_NFISCAL
					//
					While !EOF() .And. SF3->F3_FILIAL==xFilial("SF3") .And.;
						SF3->F3_CLIEFOR==cClieForn	.And. SF3->F3_LOJA==cLojac	.And.;
						SF3->F3_NFAGREG==cNfAgreg .And. SF3->F3_SERIE == cSeriec
                        //
						RecLock("SF3",.F.)
						If  SF3->F3_NFAGREG==SF3->F3_NFISCAL
							SF3->F3_OBSERV := Iif("DENEGADA"$SF3->F3_OBSERV,STR0008+"/"+SF3->F3_OBSERV,STR0008) //"NF CANCELADA" OU "NF CANCELADA/NF DENEGADA"
						Endif
						SF3->F3_DTCANC := dDataBase
						DbSkip()
						Loop
					EndDo
				Endif
			Else
				//Exclui as tabelas de complementos por NF do Sped  
				If lSped         
					M926DlSped(1,SF3->F3_NFISCAL,SF3->F3_SERIE,SF3->F3_CLIEFOR,SF3->F3_LOJA,SF3->F3_CFO)
				Endif
				// Isaac Silva 13/01/2010
				If cPaisLoc == "ARG" .And. lProcArg
					// Rotina para deletar todas as notas fiscais que o campo F3_NFISCAL = F3_NFAGREG
					cClieForn := SF3->F3_CLIEFOR
					cLojac    := SF3->F3_LOJA
					cSeriec   := SF3->F3_SERIE
					cNfAgreg  := SF3->F3_NFISCAL
					//
					While !Eof() .And. SF3->F3_FILIAL==xFilial("SF3") .And.;
						SF3->F3_CLIEFOR==cClieForn	.And. SF3->F3_LOJA==cLojac	.And.;
						SF3->F3_NFAGREG==cNfAgreg .And. SF3->F3_SERIE == cSeriec
						//
						RecLock("SF3",.F.)
     					DbDelete()
						MsUnLock()
						DbSkip()
						Loop
					EndDo
				Else
					dbDelete()
				Endif
			EndIf
			MsUnlock()
			If cTpOper == "S"
				// Pto de Entrada utilizado na Argentina                  
				If aExistPE[PE_M520SF3] 
					ExecBlock("M520SF3",.F.,.F.)
				Endif
			EndIf
		Else
			MsGoto(aRecSF3[nX])
			//Exclui as tabelas de complementos por NF do Sped  
			If lSped         
				M926DlSped(1,SF3->F3_NFISCAL,SF3->F3_SERIE,SF3->F3_CLIEFOR,SF3->F3_LOJA,SF3->F3_CFO)
			Endif
			RecLock("SF3",.F.,.T.)
			dbDelete()
		EndIf
	Next nX
	If (cPaisLoc=="BRA" .And. aAliIndic[AI_SFT])
		dbSelectArea("SFT")
		For nX := 1 to Len(aRecSFT)
			If cFormul == "S" .Or. cTpOper == "S"
				MsGoto(aRecSFT[nX])
				RecLock("SFT",.F.)
				If IIf(cPaisLoc<>"BRA",lAnulaSF3,.T.)
					SFT->FT_DTCANC := dDataBase
					SFT->FT_OBSERV := Iif("DENEGADA"$SFT->FT_OBSERV,STR0008+"/"+SFT->FT_OBSERV,STR0008) //"NF CANCELADA" OU "NF CANCELADA/NF DENEGADA"
				Else
					//Exclui as tabelas de complementos por item do Sped
					If lSped         
						M926DlSped(2,SFT->FT_NFISCAL,SFT->FT_SERIE,SFT->FT_CLIEFOR,SFT->FT_LOJA,SFT->FT_TIPOMOV,SFT->FT_ITEM,SFT->FT_PRODUTO)
					Endif
					dbDelete()
				EndIf
				MsUnlock()
				If cTpOper == "S"
					// Pto de Entrada utilizado na Argentina                   
					If aExistPE[PE_M520SFT] 
						ExecBlock("M520SFT",.F.,.F.)
					Endif
				EndIf
			Else
				MsGoto(aRecSFT[nX])
				//Exclui as tabelas de complementos por item do Sped
				If lSped         
					M926DlSped(2,SFT->FT_NFISCAL,SFT->FT_SERIE,SFT->FT_CLIEFOR,SFT->FT_LOJA,SFT->FT_TIPOMOV,SFT->FT_ITEM,SFT->FT_PRODUTO)
				Endif
				RecLock("SFT",.F.)
				dbDelete()
			EndIf
		Next nX
	EndIf
EndCase
RestArea(aAreaSF1)
RestArea(aAreaSF2)
RestArea(aArea)

Return(.T.)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisLojSF3³ Autor ³Alexandre Lemes       ³ Data ³20/09/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descricao ³Funcao do SIGALOJA para gravar campos do Livro Fiscal (SF3) ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1: Item.                                                ³±±
±±³          ³ExpX2: Parametro generico recebido                          ³±±
±±³          ³ExpN3: Item do array                                        ³±±
±±³          ³ExpC3: Funcao origem                                        ³±±
±±³          ³ExpC4: Alias                                                ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisLojSF3(nLjOpcao,xVariavel,nXItem,cFunOrig,cAlias)

Local aAreaSL1    := {}
Local cObs        := ""
Local lLegislacao := ""
Local cAliasReproc:= Iif( cFunOrig == "MATA930", cAlias , "SF2" )

If Empty((cAliasReproc)->F2_PDV) .And. !Empty((cAliasReproc)->F2_NFCUPOM)
	lLegislacao := Iif( cPaisLoc == "BRA" .And. LjAnalisaLeg(43)[1] , aAliIndic[AI_MDL] , .F. )
	aAreaSL1 := SL1->(GetArea())
	SL1->(dbSetOrder(2))
	SL1->(MsSeek(xFilial() + SubStr((cAliasReproc)->F2_NFCUPOM,1,3) + SubStr((cAliasReproc)->F2_NFCUPOM,4,6) ) )//Serie + Numero da Nota
	cObs := Iif( lLegislacao , "F - Simples Faturamento" , "CF/SERIE:" + SL1->L1_DOC + "/" + SL1->L1_SERIE +  " ECF:" + SL1->L1_PDV )
	RestArea(aAreaSL1)
EndIf

If nLjOpcao == 1 // Dados no SF3
	If Empty((cAliasReproc)->F2_PDV) .And. !Empty((cAliasReproc)->F2_NFCUPOM)
		SF3->F3_OBSERV  := cObs
		SF3->F3_ESPECIE := (cAliasReproc)->F2_ESPECIE
	Else
		If Alltrim((cAliasReproc)->F2_ESPECIE) == "CF" .Or. Alltrim((cAliasReproc)->F2_ESPECIE) == "ECF"
			If Len(xVariavel) > 0
				If xVariavel[nXItem][LF_TIPO] <> "S"
					xVariavel[nXItem][LF_TIPO] := "L"
					SF3->F3_TIPO := "L"
				Else
					SF3->F3_OBSERV := "NOTA FISCAL DE SERVICO"
				EndIf
				SF3->F3_PDV	   := (cAliasReproc)->F2_PDV
				SF3->F3_ESTADO := (cAliasReproc)->F2_EST
				If aFieldPos[FP_F3_ECF]
					SF3->F3_ECF := "1"
				Endif
			EndIf
			If LjAnalisaLeg(18)[1]
				SF3->F3_ESPECIE := "ECF"
			Endif
		EndIf
	EndIf
ElseIf nLjOpcao == 2 //Dados no SFT
	If Empty((cAliasReproc)->F2_PDV) .And. !Empty((cAliasReproc)->F2_NFCUPOM)
		SFT->FT_OBSERV  := cObs
		SFT->FT_ESPECIE := (cAliasReproc)->F2_ESPECIE
	Else
		If Alltrim((cAliasReproc)->F2_ESPECIE) == "CF" .Or. Alltrim((cAliasReproc)->F2_ESPECIE) == "ECF"
			If Len(aNfItem) > 0
				If aNfItem[nXItem][IT_LIVRO][LF_TIPO] <> "S"
					SFT->FT_TIPO := "L"
				Else
					SFT->FT_OBSERV := "NOTA FISCAL DE SERVICO"
				EndIf
			EndIf
			SFT->FT_PDV	   :=(cAliasReproc)->F2_PDV
			SFT->FT_ESTADO :=(cAliasReproc)->F2_EST
			If LjAnalisaLeg(18)[1]
				SFT->FT_ESPECIE := "ECF"
			Endif
		EndIf
	EndIf
EndIf

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡„o    ³MaFisIniNF³ Rev.  ³ Eduardo Riera         ³ Data ³08.08.2001 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³Rotina de Inicializacao da funcao fiscal com base nas Notas  ³±±
±±³          ³Fiscais                                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1: Tipo de Nota Fiscal                                   ³±±
±±³          ³       [1] Nota Fiscal de Entrada                            ³±±
±±³          ³       [2] Nota Fiscal de Saida                              ³±±
±±³          ³ExpX2: Numero do Registro do Cabecalho da Nota Fiscal, ou    ³±±
±±³          ³       o Alias da Tabela a ser considerada.                  ³±±
±±³          ³ExpA3: Array para Otimizacao ( Uso Interno deve-se apenas    ³±±
±±³          ³       assegurar que seu valor foi amazenado externamente a  ³±±
±±³          ³       esta rotina)                                          ³±±
±±³          ³ExpC4: Alias da tabela de notas fiscais de entrada      (OPC)³±±
±±³          ³ExpL5: Indica se deve ser recalculada a base dos impostos    ³±±
±±³          ³       Fiscais                                          (OPC)³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo atualizar a funcao fiscal com  ³±±
±±³          ³base em uma nota fiscal de entrada ou saida. A Funcao Fiscal ³±±
±±³          ³eh atualizada com base nas referencias do dicionario de dados³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisIniNF(nTipoNF,nRecSF,aOtimizacao,cAlias,lReprocess,cFunOrig, lHistFis, cAlsItem2)

Local aArea	   := GetArea()
Local aAreaSD1 := SD1->(GetArea())
Local aAreaSF1 := SF1->(GetArea())
Local aAreaSD2 := SD2->(GetArea())
Local aAreaSF2 := SF2->(GetArea())
Local cAlias2  := ""
Local cCliEnt  := Space(TamSx3("F3_CLIEFOR")[1])
Local cLojEnt  := Space(TamSx3("F3_LOJA")[1])
Local nX	   := 0
Local nY	   := 0
Local nValor   := 0
Local nDesc	   := 0
Local lQuery   := .F.
Local lISS	   := .F.
Local lSoICMS  := .T.
Local lCmpsSN1 := aFieldPos[FP_N1_CSTPIS] .And. aFieldPos[FP_N1_CSTCOFI] .And. aFieldPos[FP_N1_ALIQPIS] .And. aFieldPos[FP_N1_ALIQCOF] .And. aFieldPos[FP_N1_CODBCC]
#IFDEF TOP
	Local aStru := {}
	Local cQuery:= ""
#ENDIF

DEFAULT cFunOrig   := ""
DEFAULT lHistFis   := .F.
DEFAULT lReprocess := .F. 
DEFAULT cAlsItem2  := ""

If cFunOrig == "MATA930" 
	lHistorico := lHistFis
EndIf

Do Case
	Case nTipoNF == 1

		If Empty(aOtimizacao)
			aOtimizacao := {MaFisSXRef("SF1"),MaFisSxRef("SD1")}
		EndIf

		cAlias2 := "SD1"

		If Empty(cAlias)
			cAlias := "SF1"
			dbSelectArea(cAlias)
			MsGoto(nRecSF)
		EndIf
      
		If lHistorico
			cAlsCab := cAlias
		EndIf
		MaFisEnd()
		MaFisIni((cAlias)->F1_FORNECE,(cAlias)->F1_LOJA,IIF((cAlias)->F1_TIPO$'DB',"C","F"),(cAlias)->F1_TIPO,,,If((cAlias)->F1_TIPO=="C",AllTrim((cAlias)->F1_ORIGLAN),Nil))

		If (cAlias)->F1_TIPO$"DB" .And. !lReprocess
			MaFisAlt("NF_UFDEST",(cAlias)->F1_EST)
		Else
			MaFisAlt("NF_UFORIGEM",(cAlias)->F1_EST)
		EndIf

		MaFisAlt("NF_ESPECIE",(cAlias)->F1_ESPECIE)

		dbSelectArea(cAlias2)
		dbSetOrder(1)
		#IFDEF TOP
		If TcSrvType()<>"AS/400"
			aStru   := SD1->(dbStruct())
			lQuery  := .T.
			cAlias2 := "MaFisIniNF"
			cQuery  := "SELECT SD1.*,SD1.R_E_C_N_O_ SD1RECNO FROM "+RetSqlName("SD1")+" SD1 "
			cQuery  += "WHERE "
			cQuery  += "SD1.D1_FILIAL = '"+xFilial("SD1")+"' AND "
			cQuery  += "SD1.D1_DOC = '"+(cAlias)->F1_DOC+"' AND "
			cQuery  += "SD1.D1_SERIE = '"+(cAlias)->F1_SERIE+"' AND "
			cQuery  += "SD1.D1_FORNECE = '"+(cAlias)->F1_FORNECE+"' AND "
			cQuery  += "SD1.D1_LOJA = '"+(cAlias)->F1_LOJA+"' AND "
			cQuery  += "SD1.D1_TIPO= '"+(cAlias)->F1_TIPO+"' AND "
			cQuery  += "SD1.D_E_L_E_T_=' ' "
			cQuery  += "ORDER BY "+SqlOrder(IndexKey())
			
			cQuery  := ChangeQuery(cQuery)
			
			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAlias2,.T.,.T.)
			For nX := 1 To Len(aStru)
				If aStru[nX][2] <> "C"
					TcSetField(cAlias2,aStru[nX][1],aStru[nX][2],aStru[nX][3],aStru[nX][4])
				EndIf
			Next nX
		Else
		#ENDIF
			MsSeek(xFilial("SD1")+(cAlias)->F1_DOC+(cAlias)->F1_SERIE+(cAlias)->F1_FORNECE+(cAlias)->F1_LOJA)
		#IFDEF TOP
		EndIf
		#ENDIF

		dbSelectArea(cAlias2)
		While ( !Eof() .And. (cAlias2)->D1_FILIAL == xFilial("SD1") .And.;
			(cAlias2)->D1_DOC == (cAlias)->F1_DOC .And.;
			(cAlias2)->D1_SERIE == (cAlias)->F1_SERIE .And.;
			(cAlias2)->D1_FORNECE == (cAlias)->F1_FORNECE .And.;
			(cAlias2)->D1_LOJA == (cAlias)->F1_LOJA )

			If (cAlias2)->D1_TIPO == (cAlias)->F1_TIPO

				nY++

				If lHistorico
					cAlsItem  := cAlias2
					cAlsItem2 := cAlias2
				EndIf
				MaFisIniLoad(nY)
				
				If lReprocess
					MaFisAlt ("IT_ITEM", (cAlias2)->D1_ITEM, nY)
				EndIf

				(cAliasProd)->(dbSetOrder(1))
				If (cAliasProd)->(MsSeek(xFilial(cAliasProd)+(cAlias2)->D1_COD))
					aNFitem[nY][IT_CODISS]	:=	aNfItem[nY][IT_PRD][SB_CODISS]
				Endif
				
				For nX := 1 To Len(aOtimizacao[2])
					MaFisLoad(aOtimizacao[2][nX][2],(cAlias2)->(FieldGet(FieldPos(aOtimizacao[2][nX][1]))),nY)
				Next nX

				// Rotina usada apanas para retornar o valor do ICMS ISENTO no Relatorio DUB-ICMS
				If cFunOrig == "FISR001"  .And. (cAlias2)->D1_CLASFIS $(" 40/ 41/040/041/140/141")
					MaFisTes(aNfItem[nY][IT_TES],aNfItem[nY][IT_RECNOSF4],nY)
					aTes[TS_ICM] := "S"
					MaAliqIcms(nY)
					MaFisBSICM(nY)
					MaFisVICMS(nY)
					MaItArred(nY,{"IT_VALICM"})
				EndIf
				
				MaFisEndLoad(nY,2)
			
				If lReprocess
					If cPaisLoc == "BRA"
						
						MaFisIPI(nY,"BSE",.T.) // Calcula a Base de IPI Original
				 		MaExcecao(nY)
						MaFisPreCalc(nY)
						MaFisBSICM(nY,.T.)	// Calcula a Base de ICMS Original
						MaFisVICMS(nY,.T.) 	// Calcula o Valor do ICMS / Diferido
						If (cAlias2)->D1_TIPO $ "ND"
							MaALIQCMP(nY)
							MaMargem(nY)
							MaFisVComp(nY)
						EndIf
						If aTes[TS_ATUATF] == "S" .And. lCmpsSN1//Atualiza Ativo Fixo
							DbSelectArea("SN1")
							DbSetOrder(1)
							If SN1->(MsSeek(xFilial("SN1")+Substr((cAlias2)->D1_CBASEAF,1,10)+Substr((cAlias2)->D1_CBASEAF,11,4)))
								RecLock("SN1",.F.)
								SN1->N1_CSTPIS	:=	aNfItem[nY][IT_LIVRO][LF_CSTPIS]
								SN1->N1_CSTCOFI	:=	aNfItem[nY][IT_LIVRO][LF_CSTCOF]
								SN1->N1_ALIQPIS	:=	aNfItem[nY][IT_ALIQPS2]
								SN1->N1_ALIQCOF	:=	aNfItem[nY][IT_ALIQCF2]
								SN1->N1_CODBCC	:=	aTes[TS_CODBCC]
								SN1->(FkCommit())
								MsUnLock()
							Endif
						Endif
						//Grava valor Credito Presumido Substituicao Tributaria retido pelo contratante do servico de transporte - Decreto 44.147/2005 (MG)
						If aTes[TS_CRPRST]<>0
							MaAliqSoli(nY)
							MaMargem(nY)
							MaFisVSol(nY)
							MaFisVTot(nY)
						EndIf
					EndIf
					MaItArred(nY,{"IT_VALCMP"})
					MaFisLF(nY)
					MaFisLoad("LF_ITEMORI",(cAlias2)->D1_ITEMORI,nY) //Refaz o Item Original
				EndIf
			EndIf

			If (cAlias2)->D1_ORIGLAN<>(cAlias)->F1_ORIGLAN
				If lQuery
					SD1->(MsGoto((cAlias2)->SD1RECNO))
				EndIf
				RecLock("SD1",.F.)
				SD1->D1_ORIGLAN := (cAlias)->F1_ORIGLAN
				MsUnlock()
			EndIf

			dbSelectArea(cAlias2)
			dbSkip()

		EndDo

		If lQuery .and.(!lReprocess .Or. !lHistorico)
			dbSelectArea(cAlias2)
			dbCloseArea()
			dbSelectArea("SD1")
		EndIf
		
		If (cAlias)->F1_IMPORT <> "S"
			MaFisAlt("NF_FRETE"  ,(cAlias)->F1_FRETE)
			MaFisAlt("NF_SEGURO" ,(cAlias)->F1_SEGURO)
			MaFisAlt("NF_DESPESA",(cAlias)->F1_DESPESA)
			If aFieldPos[FP_F1_DESNTRB]
				MaFisAlt("NF_DESNTRB",(cAlias)->F1_DESPNTRB)
			Endif
			If aFieldPos[FP_F1_TARA]
				MaFisAlt("NF_TARA"   ,(cAlias)->F1_TARA)
			Endif
		EndIf
		
		// Fundo Social - Sera recalculado para apresentar nas observacoes do documento
		MaFisAlt("NF_FUNRURAL" ,(cAlias)->F1_CONTSOC,)
		
	Case nTipoNF == 2 // Processa NF de saida
		If Empty(aOtimizacao) //Verifica se o Array de otimizacao esta disponivel
			aOtimizacao := {MaFisSXRef("SF2"),MaFisSxRef("SD2")}
		EndIf
		cAlias2 := "SD2"
		If Empty(cAlias)
			cAlias := "SF2"
			dbSelectArea(cAlias)
			MsGoto(nRecSF)
		EndIf
		If lHistorico
			cAlsCab := cAlias
		EndIf		
		MaFisEnd()
		MaFisIni((cAlias)->F2_CLIENTE,(cAlias)->F2_LOJA,IIF((cAlias)->F2_TIPO$'DB',"F","C"),(cAlias)->F2_TIPO,(cAlias)->F2_TIPOCLI,{},,,,,,,,,Iif( aFieldPos[FP_F2_RECISS] ,(cAlias)->F2_RECISS,""),(cAlias)->F2_CLIENT, (cAlias)->F2_LOJENT,,,,,,,,,IIF(cPaisLoc=="BRA",(cAlias)->F2_TPFRETE,NIL)) 
	
		If (cAlias)->F2_TIPO$"DB" .And. !lReprocess
			MaFisAlt("NF_UFORIGEM",(cAlias)->F2_EST)
		Else
			MaFisAlt("NF_UFDEST",(cAlias)->F2_EST)
		EndIf
		MaFisAlt("NF_ESPECIE",(cAlias)->F2_ESPECIE)

		//-- Tratamento para o ambiente Gestao de Transporte (SIGATMS)
		If (AllTrim(aNFCab[NF_ESPECIE]) $ "CTR/CTE" .Or. "NFST" $ AllTrim((cAlias)->F2_ESPECIE))
			MaFisAlt("NF_PNF_COD" ,(cAlias)->F2_CLIENTE,)
			MaFisAlt("NF_PNF_LOJ" ,(cAlias)->F2_LOJA,)
			MaFisAlt("NF_PNF_UF"  ,(cAlias)->F2_EST,)
			// Quando existe um valor de ICMS Retido o Tipo do Cliente deve ser o do Cliente Devedor do Frete
			If (cAlias)->F2_ICMSRET > 0
				MaFisAlt("NF_PNF_TPCLIFOR",Posicione("SA1",1,xFilial("SA1")+(cAlias)->F2_CLIENTE+(cAlias)->F2_LOJA,"A1_TIPO"))
			Else
				MaFisAlt("NF_PNF_TPCLIFOR",(cAlias)->F2_TIPOCLI,)
			EndIf
			If IntTms() .And. lReprocess
				DT6->(dbSetOrder(1))
				If DT6->(MsSeek(IIf(FWModeAccess("DT6",3) == "E" , (cAlias)->F2_FILIAL,xFilial("DT6"))+(cAlias)->F2_FILIAL+(cAlias)->F2_DOC+(cAlias)->F2_SERIE))
					MaFisAlt("NF_UFORIGEM",Posicione("DUY",1,xFilial("DUY")+DT6->DT6_CDRORI,"DUY_EST"))
					MaFisAlt("NF_UFDEST"  ,Posicione("DUY",1,xFilial("DUY")+DT6->DT6_CDRCAL,"DUY_EST"))
					If aParSX6[MV_TMSUFPG] //--Com o MV_TMSUFPG True, gravar o Estado do Pagador do Frete
						MaFisAlt("NF_PNF_UF",Posicione("SA1",1,xFilial("SA1")+DT6->DT6_CLIDEV+DT6->DT6_LOJDEV,"A1_EST"),)
					EndIf
				EndIf
			EndIf
		EndIf
		
		cCliEnt	:=	aNFCab[NF_CLIENT]
		cLojEnt	:=	aNFCab[NF_LOJENT]
		
		dbSelectArea("SD2")
		dbSetOrder(3)
 
		#IFDEF TOP
		If TcSrvType()<>"AS/400"
			aStru   := SD2->(dbStruct())
			lQuery  := .T.
			cAlias2 := "MaFisIniNF"
			cQuery  := "SELECT SD2.*,SD2.R_E_C_N_O_ SD2RECNO FROM "+RetSqlName("SD2")+" SD2 "
			cQuery  += "WHERE "
			cQuery  += "SD2.D2_FILIAL = '"+xFilial("SD2")+"' AND "
			cQuery  += "SD2.D2_DOC = '"+(cAlias)->F2_DOC+"' AND "
			cQuery  += "SD2.D2_SERIE = '"+(cAlias)->F2_SERIE+"' AND "
			cQuery  += "SD2.D2_CLIENTE = '"+(cAlias)->F2_CLIENTE+"' AND "
			cQuery  += "SD2.D2_LOJA = '"+(cAlias)->F2_LOJA+"' AND "
			cQuery  += "SD2.D_E_L_E_T_=' ' "
			cQuery  += "ORDER BY "+SqlOrder(SD2->(IndexKey()))
			
			cQuery := ChangeQuery(cQuery)
			
			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAlias2,.T.,.T.)
			
			For nX := 1 To Len(aStru)
				If aStru[nX][2]<>"C"
					TcSetField(cAlias2,aStru[nX][1],aStru[nX][2],aStru[nX][3],aStru[nX][4])
				EndIf
			Next nX
		Else
		#ENDIF
			MsSeek(xFilial("SD2")+(cAlias)->F2_DOC+(cAlias)->F2_SERIE+(cAlias)->F2_CLIENTE+(cAlias)->F2_LOJA)
		#IFDEF TOP
		EndIf
		#ENDIF
		dbSelectArea(cAlias)
		While !Eof().And. (cAlias2)->D2_FILIAL == xFilial("SD2") .And.;
			(cAlias2)->D2_DOC == (cAlias)->F2_DOC .And.;
			(cAlias2)->D2_SERIE == (cAlias)->F2_SERIE .And.;
			(cAlias2)->D2_CLIENTE == (cAlias)->F2_CLIENTE .And.;
			(cAlias2)->D2_LOJA == (cAlias)->F2_LOJA
			lISS := .F.
			If Empty(cCliEnt) .And. Empty(cLojEnt)
				SC5->(dbSetOrder(1))
				If SC5->(MsSeek(xFilial("SC5")+(cAlias2)->D2_PEDIDO))
					
					cCliEnt	:=	SC5->C5_CLIENT
					cLojEnt	:=	SC5->C5_LOJAENT
					
					MaFisAlt("NF_CLIENT", SC5->C5_CLIENT)
					MaFisAlt("NF_LOJENT", SC5->C5_LOJAENT)
					
					DbSelectArea("SF2")
					SF2->(DbSetOrder(1))
					
					If cAlias <> "SF2"
						SF2->(dbSetOrder(1))
						If SF2->(MsSeek(xFilial("SF2")+(cAlias)->F2_DOC+(cAlias)->F2_SERIE+(cAlias)->F2_CLIENTE+(cAlias)->F2_LOJA))
							RecLock("SF2",.F.)
							SF2->F2_CLIENT	:=	aNFCab[NF_CLIENT]
							SF2->F2_LOJENT	:=	aNFCab[NF_LOJENT]
							MsUnLock()
						EndIf
					Else
						SF2->(dbSetOrder(1))
						If SF2->(MsSeek(xFilial("SF2")+(cAlias)->F2_DOC+(cAlias)->F2_SERIE+(cAlias)->F2_CLIENTE+(cAlias)->F2_LOJA))
							RecLock(cAlias,.F.)
							(cAlias)->F2_CLIENT	:=	aNFCab[NF_CLIENT]
							(cAlias)->F2_LOJENT	:=	aNFCab[NF_LOJENT]
							MsUnLock()
						EndIf
					EndIf
				EndIf
			EndIf

			nY++

			If lHistorico
				cAlsItem  := cAlias2 
				cAlsItem2 := cAlias2
			EndIf
			MaFisIniLoad(nY) 

			If lReprocess
				MaFisAlt ("IT_ITEM", (cAlias2)->D2_ITEM, nY)
			EndIf

			If !Empty((cAlias2)->D2_CODISS) .Or. (cAlias2)->D2_VALISS > 0
				lISS 	:= 	.T.
				lSoICMS	:=	.F.
				If !Empty((cAlias2)->D2_CODISS)
					aNFItem[nY][IT_RATEIOISS] := "S"
				EndIf
			EndIf
			
			If lReprocess .Or. (cAlias2)->D2_ORIGLAN $ "LO/VD"
			    nDesc := LjxPesqDesc(cAlias2)
				MaFisAlt("IT_DESCPRO",nDesc,nY) 
				If aTes[TS_DESCOND] == "2"  .And. nDesc > 0
					aNfItem[nY][IT_BICMORI] += aNfItem[nY][IT_DESCPRO]
					aNfItem[nY][IT_DESCPRO] := 0	
				EndIf		 				
			Else
				nDesc := 0
			EndIf
			
			For nX := 1 To Len(aOtimizacao[2])
				Do Case
					Case aOtimizacao[2][nX][2] == "IT_VALMERC"
						If cPaisLoc <> "BRA" .And. aParSX6[MV_DESCSAI] == "1"
							nValor := (cAlias2)->D2_TOTAL
						Else
							nValor := (cAlias2)->D2_TOTAL + (cAlias2)->D2_DESCON + nDesc
						Endif
					Case aOtimizacao[2][nX][2] == "IT_VALISS"
						nValor := IIF(lISS .And. Empty((cAlias2)->D2_VALISS) ,(cAlias2)->D2_VALICM,(cAlias2)->D2_VALISS)
					Case aOtimizacao[2][nX][2] == "IT_BASEISS"
						nValor := IIF(lISS .And. Empty((cAlias2)->D2_BASEISS),(cAlias2)->D2_BASEICM,(cAlias2)->D2_BASEISS)
					Case aOtimizacao[2][nX][2] == "IT_ALIQISS"
						nValor := IIF(lISS .And. Empty((cAlias2)->D2_ALIQISS),(cAlias2)->D2_PICM,(cAlias2)->D2_ALIQISS)
					OtherWise
						nValor := (cAlias2)->(FieldGet(FieldPos(aOtimizacao[2][nX][1])))
				EndCase
				MaFisLoad(aOtimizacao[2][nX][2],nValor,nY)
			Next nX

			MaFisTes(aNfItem[nY][IT_TES],aNfItem[nY][IT_RECNOSF4],nY)		
			
			If aTes[TS_AGREG] == "R"
				MaFisLoad("IT_VALMERC",(cAlias2)->D2_TOTAL + (cAlias2)->D2_DESCICM , nY)
				MaFisLoad("IT_PRCUNI", aNFitem[nY][IT_VALMERC] / aNFitem[nY][IT_QUANT] , nY)
     		EndIf

			MaFisLoad("IT_DESCZF",(cAlias2)->D2_DESCZFR,nY)

			If lReprocess .And. (cAlias2)->D2_ORIGLAN $ "LO/VD"
				nDesc := LjxPesqDesc(cAlias2)
				MaFisAlt("IT_DESCPRO",nDesc,nY)
				// Reprocessamento da venda.
				//    No loja nao é gravado o desconto total no d2_descon, por isso busca o nDesc(L2_DESCPRO)
				//    No D2_DESCON é gravado o desconto no item do orçamento e qdo há desconto no total e no item,
				//    tem que somar o dois valores no IT_DESCONTO
				If cFunOrig == "MATA930" .And. ((cAlias2)->D2_DESCON > 0 .Or. nDesc>0)
					MaFisAlt("IT_DESCONTO",nDesc + (cAlias2)->D2_DESCON,nY)
					MaFisAlt("IT_DESCPRO",0,nY)
				EndIf
			EndIf
			
			// Rotina usada apenas para retornar o valor do ICMS ISENTO no Relatorio DUB-ICMS
			If cFunOrig == "FISR001" .And. (cAlias2)->D2_CLASFIS $(" 40/ 41/040/041/140/141")
				aTes[TS_ICM] := "S"
				MaAliqIcms(nY)
				MaFisBSICM(nY)
				MaFisVICMS(nY)
				MaItArred(nY,{"IT_VALICM"})
			EndIf

			MaFisEndLoad(nY,2)
			If lReprocess
				If cPaisLoc=="BRA"
					MaFisIPI(nY,"BSE",.T.) // Calcula a Base de IPI Original
					MaExcecao(nY)					
					MaFisPreCalc(nY)
					MaFisBSICM(nY,.T.)	// Calcula a Base de ICMS Original
					MaFisVICMS(nY,.T.) 	// Calcula o Valor do ICMS / Diferido
					If (cAlias2)->D2_TIPO $ "ND"
						MaALIQCMP(nY)
						MaMargem(nY)
						MaFisVComp(nY)
					EndIf
					
					MaFisAlt("NF_VALPIS" ,(cAlias)->F2_VALPIS)
					MaFisAlt("NF_VALCOF" ,(cAlias)->F2_VALCOFI)
					MaFisAlt("NF_VALCSL" ,(cAlias)->F2_VALCSLL)  
					   
		   			MaFisCSLL(nY)
					MaFisCOFINS(nY,"CF")
		   			MaFisPIS(nY,"PS") 										
					
					//Grava valor Credito Presumido Substituicao Tributaria retido pelo contratante do servico de transporte - Decreto 44.147/2005 (MG)
					If aTes[TS_CRPRST]<>0
						MaAliqSoli(nY)
						MaMargem(nY)
						MaFisVSol(nY)
						MaFisVTot(nY)
					EndIf
				EndIf
				MaItArred(nY,{"IT_VALCMP"})
				MaFisLF(nY)
				MaFisLoad("LF_ITEMORI",(cAlias2)->D2_ITEMORI,nY) //Refaz o Item Original
			EndIf
			dbSelectArea(cAlias2)
			dbSkip()

		EndDo

        If lQuery .and.(!lReprocess .Or. !lHistorico)
			dbSelectArea(cAlias2)
			dbCloseArea()
			dbSelectArea("SD2")
		EndIf

		MaFisAlt("NF_FRETE",(cAlias)->F2_FRETE)

		If aFieldPos[FP_F2_VLR_FRT]
			MaFisAlt("NF_VLR_FRT",(cAlias)->F2_VLR_FRT)
		EndIf

		MaFisAlt("NF_SEGURO" ,(cAlias)->F2_SEGURO)
		MaFisAlt("NF_DESPESA",(cAlias)->F2_DESPESA)

		If aFieldPos[FP_F2_DESNTRB]
			MaFisAlt("NF_DESNTRB",(cAlias)->F2_DESNTRB)
		Endif

		If aFieldPos[FP_F2_TARA]
			MaFisAlt("NF_TARA",(cAlias)->F2_TARA)
		Endif

		MaFisLoad("NF_AUTONOMO",(cAlias)->F2_FRETAUT)
		
		If lSoICMS .And. cFunOrig <> "FISR001"	//Nao retirar - So devo processar este bloco se o documento fiscal conter SOMENTE ICMS.
			MaFisAlt("NF_BASEICM",(cAlias)->F2_BASEICM,)
			MaFisAlt("NF_VALICM" ,(cAlias)->F2_VALICM,)
			MaFisAlt("NF_BASEIPI",(cAlias)->F2_BASEIPI,)
			MaFisAlt("NF_VALIPI" ,(cAlias)->F2_VALIPI,)
		EndIf

		MaFisAlt("NF_VALICA"  ,(cAlias)->F2_ICMAUTO,)
		MaFisAlt("NF_FUNRURAL",(cAlias)->F2_CONTSOC,)
		
		If !lReprocess  .And. cFunOrig <> "FISR001"
			For nX := 1 To Len(aOtimizacao[1])
				If Empty(MaFisRet(,aOtimizacao[1][nX][2]))
					nValor := (cAlias)->(FieldGet(FieldPos(aOtimizacao[1][nX][1])))
					MaFisAlt(aOtimizacao[1][nX][2],nValor)
				ElseIf !lReprocess
					nValor := (cAlias)->(FieldGet(FieldPos(aOtimizacao[1][nX][1])))
					MaFisLoad(aOtimizacao[1][nX][2],nValor)
				EndIf
			Next nX
		EndIf
		
EndCase

RestArea(aAreaSD2)
RestArea(aAreaSF2)
RestArea(aAreaSD1)
RestArea(aAreaSF1)
RestArea(aArea)

Return .T.

/*__________________________________________ FUNCOES DE CONTROLE DOS FOLDERS - LIVRO FISCAL E IMPOSTOS ____________________________________________*/

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡„o    ³MaFisBrwLF³ Autor ³Edson Maricate         ³ Data ³13.12.1999 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ objeto Browse demonstrativo dos livros fiscais              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpO1: Objeto ListBox a ser montado                          ³±±
±±³          ³ExpA2: Array com as coordenadas do Objeto                    ³±±
±±³          ³ExpL3: Flag de edicao livro .F. - Editavel .T. - Nao Editavel³±±
±±³          ³ExpA4: Array contendo os registros do Livro Fiscal           ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisBrwLivro(oWnd,aPosWnd,lVisual,aRecSF3,lOpcVisual)

Local aFixos	:= MatXAFixos()
Local aArea		:= GetArea()
Local aAreaSX3	:= SX3->(GetArea())
Local aItensLF	:= {}
Local aHeadLF	:= {}
Local aTamHead	:= {}
Local nX        := 0
Local nY        := 0
Local oLivro

DEFAULT lOpcVisual := .F.

//³ Inicializa os campos fixos do Livro Fiscal
If aBrwLF == Nil
	aBrwLF := {}
	SX3->(DbSetOrder(2))
	For nX := 1 To Len(aFixos)
		If SX3->(MsSeek(aFixos[nX][1]))
			aadd( aBrwLF ,{ aFixos[nX][1] , CriaVar(aFixos[nX][1],.F.) , PesqPict("SF3",aFixos[nX][1]) , X3Titulo() , SX3->X3_TAMANHO } )
		EndIf
	Next nX
EndIf
//³ Monta o cabecalho com os titulos do SF3.
For nX	:= 1 To Len(aBrwLF)
	aadd(aHeadLF,aBrwLF[nX][4])
	If aBrwLF[nX][5] > Len(aBrwLF[nX][4])
		aadd(aTamHead,aBrwLF[nX][5]*3)
	Else
		aadd(aTamHead,Len(aBrwLF[nX][4])*3)
	EndIf
Next nX
//³ Monta os itens de visualizacao da ListBox.
Do Case
	Case !Empty(aRecSF3)
		For nX	:= 1 To Len(aRecSF3)
			dbSelectArea("SF3")
			MsGoto(aRecSF3[nX])
			aadd(aItensLF,Array(Len(aBrwLF)))
			For nY := 1 to Len(aBrwLF)
				aItensLF[nX][nY] := &(aBrwLF[nY][1])
			Next nY
		Next nX
	Case !Empty(aNFCab)
		aItensLF := aClone(aNFCab[NF_LIVRO])
		If cPaisLoc<>"BRA"
			If !Empty(aItensLF)
				aItensLF:=Adel(aItensLF,1)
				aItensLF:=aSize(aItensLF,Len(aItensLF)-1)
			Endif
		EndIf
EndCase
If Empty(aItensLF)
	aadd(aItensLF,Array(Len(aBrwLF)))
	For nX	:= 1 To Len(aBrwLF)
		aItensLF[1][nX] := aBrwLF[nX][2]
	Next nX
EndIf
 
bLivroRefresh   := {|| MaFisLFNew(oLivro)}
oLivro:= TWBrowse():New( aPosWnd[1],aPosWnd[2],aPosWnd[3],aPosWnd[4],,aHeadLF,aTamHead,oWnd,,,,,,,,,,,,.F.,,.T.,,.F.,,,)
oLivro:SetArray(aItensLF)
If Len(aItensLF) > 0
	oLivro:bLine := {||MaFisLFLine(oLivro,aItensLF)}
EndIf
oLivro:lAutoEdit := !lVisual
//³ O aHeader contido no aHeadLF e montado apartir do aBrwLF criado pela MatXaFixos e diverge do conteudo do aNFCab[NF_LIVRO]³
//³ O Refresh a seguir alinha o aHeadLF com o aItensLF                                                                       ³
If bLivroRefresh <> Nil .And. Empty(aRecSF3) .And. !lOpcVisual
	Eval(bLivroRefresh)
EndIf

RestArea(aAreaSX3)
RestArea(aArea)

Return ( oLivro )

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡„o    ³MaFisLFNew³ Autor ³Edson Maricate         ³ Data ³13.12.1999 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo atualizar o array com o demons ³±±
±±³          ³trativo fiscal.                                              ³±±
±±³          ³Browse demonstrativo dos livros fiscais                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpO1: Objeto ListBox dos livros fiscais                     ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisLFNew(oLivro)

Local aTemp      := {}
Local aFixos     := MatXAFixos()
Local aLinha     := {}
Local nMaxBrw    := Len(aBrwLF)
Local nX         := 0 
Local nY         := 0 
Local nZ         := 0
Local nMax1      := 0
Local nMax2      := 0

If Empty(aNFCab)
	aadd(aLinha,Array(nMaxBrw))
	For nX := 1 To nMaxBrw
		aLinha[1][nX] := aBrwLF[nX][2]
	Next nX
Else
	aTemp := aClone(aNFCab[NF_LIVRO])
	If cPaisLoc<>"BRA"
		If !Empty(aTemp)
			aTemp:=Adel(aTemp,1)
			aTemp:=aSize(aTemp,Len(aTemp)-1)
		Endif
	Endif
	nMax1 := Len(aTemp)
	For nX := 1 To nMax1
		nMax2 := Min(Len(aTemp[nX]),Len(aFixos))
		aadd(aLinha,Array(nMaxBrw))
		For nY := 1 To nMax2
			nZ := aScan(aBrwLF,{|x| x[1]==aFixos[nY][1]})
			If nZ <> 0
				aLinha[nX][nZ]:= aTemp[nX][nY]
			EndIf
		Next nY
	Next nX
EndIf
                          
If ValType(oLivro)<>"U"
	oLivro:SetArray(aLinha)
	oLivro:bLine := {|| MaFisLFLine(oLivro,aLinha) }
	oLivro:Refresh()
EndIf
	
Return(.T.)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡„o    ³MaFisLFLin³ Autor ³Edson Maricate         ³ Data ³13.12.1999 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo preparar a montagem da linha a ³±±
±±³          ³ser exibida no browse do demonstrativo fiscal                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpO1: Objeto ListBox do Livro Fiscal                        ³±±
±±³          ³ExpA2: Array com os itens do listbox                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpA1: Array com a linha do demonstrativo fiscal             ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/                                              	
Static Function MaFisLFLine(oLivro,aItensLF)

Local aLinha := aItensLF[oLivro:nAt]
Local aFixos := MatXAFixos()
Local nX     := 0 
Local nY     := 0
Local nMax   := Len(aFixos)

For nX := 1 To nMax
	nY := aScan(aBrwLF,{|x| x[1]==aFixos[nX][1]})
	If nY <> 0 .And. ValType(aLinha[nY]) == "N"	
		If cPaisLoc == "BRA"
			If SUBS(aBrwLF[nY][1],1,10) $ "F3_VALANTI"
				aLinha[nY] := Round(aLinha[nY],MsDecimais(1))
    	    Else
				aLinha[nY]:= TransForm(aLinha[nY],aBrwLF[nY][3])
			EndIf	
		Else
			If SUBS(aBrwLF[nY][1],1,6) $ "F3_VAL|F3_BAS|F3_RET|F3_DES"
    	    	aLinha[nY] := Round(aLinha[nY],MsDecimais(1))
 	       	EndIf
			aLinha[nY]:= TransForm(aLinha[nY],aBrwLF[nY][3])
		EndIf			
	EndIf
Next nX

Return( aLinha )

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisRodape³ Autor ³ Edson Maricate       ³ Data ³13.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Atualiza o Array de Resumos da NF.                          ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/

Static Function MaFisRodape(nTipo,;		// Quebra : 1 Imposto+Aliquota,  2-Imposto
	oJanela,;		// Janela onde sera montado
	aImpostos,;	// Relacao de Impostos que deverao aparecer ( Codigo )
	aPos,;			// Array contendo Posicao e Tamanho
	bValidPrg,;	// Validacao executada na Edicao dop Campo
	lVisual,; // So para visualizacao
	cFornIss,; //Fornecedor do ISS
	cLojaIss,; //Loja do Fornecedor do ISS
	aRecSE2,;
	cDirf,;
	cCodRet,;
	oCodRet,;
	nCombo,;
	oCombo,;
	dVencIss,; 	//Vencimento ISS
	aCodR,;
	cRecIss,;	//Informa se recolhe o ISS ou nao
	oRecIss,;
	lEditImp) //Edicao de impostos dos Docs.Fiscais operacao de Inclusao, MV_EDITIMP ativado, Form.Proprio N e Especie NF/NCP/NDP/NDE/NCE (LOCALIZADO)

Local oList
Local aTemp                                              
Local aOpcoes := {"Sim","Nao"}
Local oFornIss
Local oLojaIss                     
Local oVencIss
Local oDescri 
Local oBtn081 := Nil
Local oBtn084 := Nil
                                                                  
Local cDescri  := ""
Local aAreaSE2 := {}
Local aAreaSA2 := {}
Local lFornIss := .F.
Local lVisuimp := .F.
Local nPosDum  := 0
Local aAUTOISS := {}
Local aMaPCCI  := {}
Local nI       := 0
Local nPosCodR := 0
Local aOpcIss  := {"1="+STR0024,"2="+STR0025}
Local nPosImp  := 0

Local nTamForn := (TamSx3("E2_FORNISS")[1]*4)
Local nTamLoja := (TamSx3("E2_LOJAISS")[1]*4)
Local lTamForn := TamSx3("E2_FORNISS")[1]>6
Local lTamLoja := TamSx3("E2_LOJAISS")[1]>2 
Local lRotina  := FunName()$"MATA103/MATA119/PMSA300/MATA116"

DEFAULT oCodRet := Nil
DEFAULT oCombo  := Nil
DEFAULT nCombo  := 2
DEFAULT dVencIss:= CtoD("")
DEFAULT aCodR	:= {}
DEFAULT oRecIss := Nil
DEFAULT cRecIss := "1"
Default lEditImp := .F.

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Ao utilizar o Protheus com varias Filiais e possivel que em alguns processos como o de inclusao de Notas Fiscais o usuario altere  ³
//³ a filial atraves da Dialog de seleçao de filiais, com isso se faz necessario que os parametros SX6 sejam novamente carregados para ³
//³ a filial corrente refazendo o cache realizado na variavel aParSX6, esta nova carga e controlada pela variavel cSX6FilAnt           ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If cSX6FilAnt <> cFilAnt
	aParSX6 := GParMxFis()	
EndIf 

aAUTOISS := &(aParSX6[MV_AUTOISS])

If nTipo == 1
	If Empty(aNfCab) .Or. Empty(aNfCab[NF_IMPOSTOS])
		aTemp	:= {{"","",0,0,0,""}}
	Else           
	    If lVisual      
	        For nPosImp := 1 to Len(aNFCab[NF_IMPOSTOS])
                If Alltrim(aNFCab[NF_IMPOSTOS][nPosImp][1]) == "IRR" .And. aNFCab[NF_IMPOSTOS][nPosImp][4] == 0
                    MaFisIR(1,"ALQ",,lVisual)             
                    aNFCab[NF_IMPOSTOS][nPosImp][4] := aNfItem[1][IT_ALIQIRR]
                EndIf	        
	        Next nPosImp            
	    EndIf
		aTemp	:= aNFCab[NF_IMPOSTOS]
	EndIf
Else
	If Empty(aNfCab) .Or. Empty(aNfCab[NF_IMPOSTOS2])
		aTemp	:= {{"","",0,0}}

	Else
		aTemp	:= aNFCab[NF_IMPOSTOS2]
	EndIf
EndIf

bFisRefresh	:= {|| MaFisRRefresh(oList,nTipo,oFornISS,@cFornISS,oLojaISS,@cLojaISS,oRecISS,@cRecISS)}

If aFieldPos[FP_E2_FORNISS] .And. aFieldPos[FP_E2_LOJAISS] 
	If cFornIss <> NIL .And. cLojaIss <> NIL

		lFornIss := .T.
			
	  	aPos[2] := 85 
	   	aPos[3] -= 80
	   	@ 03,02 TO 58, (Iif (lTamForn, nTamForn+52,84 )+ Iif (lTamLoja,9,0)) LABEL '' OF oJanela PIXEL
		@ 06,10 SAY STR0023 Of oJanela PIXEL SIZE 80,09 //"Dados de Cobrança do ISS"
		@ 19,04 SAY RetTitle("E2_FORNISS") Of oJanela PIXEL SIZE 30,09

		If aFieldPos[FP_E2_VENCISS]
			@ 46,04 SAY RetTitle("E2_VENCISS")Of oJanela PIXEL SIZE 30,09
		EndIf
		
		If lVisual 
		    
		    If Len(aRecSE2) > 0
		    	aAreaSE2 := SE2->(GetArea())
			    aAreaSA2 := SA2->(GetArea())
		    
			    SE2->(dbGoTo(aRecSE2[1]))
			    cFornIss := SE2->E2_FORNISS 
		    	cLojaIss := SE2->E2_LOJAISS
			    If SA2->(MsSeek(xFilial("SA2")+cFornIss+cLojaIss))
					cDescri := SA2->A2_NREDUZ
				Endif	
				If aFieldPos[FP_E2_VENCISS]
			    	dVencIss := SE2->E2_VENCISS
			 	EndIf
			 	
				If cPaisLoc=="BRA"
					If !Empty( SE2->E2_CODRPIS )
						aAdd( aMaPCCI , {"PIS",SE2->E2_CODRPIS} )
					EndIf
					If !Empty( SE2->E2_CODRCOF )	
						aAdd( aMaPCCI , {"COF",SE2->E2_CODRCOF} )
					EndIf
					If !Empty( SE2->E2_CODRCSL )
						aAdd( aMaPCCI , {"CSL",SE2->E2_CODRCSL} )
					EndIf
					If !Empty( SE2->E2_CODRET )
						aAdd( aMaPCCI , {"IRR",SE2->E2_CODRET} )
					EndIf
				Endif

			 	For nI := 1 To Len( aTemp )
				 	If (nTipo==1)
						If (nPosCodR := aScan(aMaPCCI, {|aX|aX[1]==aTemp[nI][6]}))>0
							aAdd( aCodR, {nI, aMaPCCI[nPosCodR][2], 1, aTemp[nI][6]} )
						EndIf
					Else
						If (nPosCodR := aScan(aMaPCCI, {|aX|aX[1]==aTemp[nI][5]}))>0
							aAdd( aCodR, {nI, aMaPCCI[nPosCodR][2], 1, aTemp[nI][5]} )
						EndIf
					EndIf
				Next
				
				RestArea(aAreaSE2)
				RestArea(aAreaSA2)
		    Endif
			
			@ 18,31 MSGET oFornIss VAR cFornIss PICTURE PesqPict('SE2','E2_FORNISS') OF oJanela PIXEL SIZE IIf(lTamForn, nTamForn,35),09 READONLY
			@ 18,Iif(lTamForn, nTamForn+35,67) MSGET oLojaIss VAR cLojaIss PICTURE PesqPict('SE2','E2_LOJAISS') OF oJanela PIXEL SIZE IIf(lTamLoja, nTamLoja,15),09 READONLY

			If aFieldPos[FP_E2_VENCISS]
				@ 44,38 MSGET oVencIss VAR dVencIss OF oJanela PIXEL READONLY
			EndIf

		Else
		
			// Para montar a descricao quando o fornecedor+loja vem preenchido pelo parametro MV_AUTOISS (Mata103)
			If !Empty(cFornISS) .And. !Empty(cLojaISS)
			    If SA2->(MsSeek(xFilial("SA2")+cFornIss+cLojaIss))
					cDescri := SA2->A2_NREDUZ
				Endif	
			Endif

		  	@ 18,31 MSGET oFornIss VAR cFornIss PICTURE PesqPict('SE2','E2_FORNISS') OF oJanela PIXEL SIZE IIf(lTamForn, nTamForn,35),09 F3 CpoRetF3('E2_FORNISS') ;
			VALID MaVldForn(@cFornIss,@cLojaIss,@oDescri,@cDescri,@oLojaISS,@oFornIss,1)			                         
			@ 18,IIf(lTamForn, nTamForn+35,67) MSGET oLojaIss VAR cLojaIss PICTURE PesqPict('SE2','E2_LOJAISS') OF oJanela PIXEL SIZE Iif(lTamLoja, nTamLoja,15),09 F3 CpoRetF3('E2_LOJAISS') ;
			VALID MaVldForn(@cFornIss,@cLojaIss,@oDescri,@cDescri,@oLojaISS,@oFornIss,2) 
			If aFieldPos[FP_E2_VENCISS]
		    @ 44,31 MSGET oVencIss VAR dVencIss OF oJanela PIXEL
			EndIf
				
		EndIf 	
			
		@ 31,04 MSGET oDescri VAR cDescri OF oJanela PIXEL SIZE 78,09 WHEN .F. 

	Endif
Endif

If aParSX6[MV_VISDIRF] == "1"

	If cDirf <> NIL .And. cCodRet <> NIL
	
	   If lVisual
		   cCodRet 	:= Space(TamSx3("E2_CODRET")[1])
	       cDirf   	:= "2"
	   Else	
			cDirf 	:= CriaVar("E2_DIRF",.T.)
			cCodRet := CriaVar("E2_CODRET")
			// Verifica se ha a configuracao para preenchimento automatico dos dados de cobranca do ISS
			If aAutoISS<>Nil .And. Len(aAutoISS)==4 .And. !Empty(aAutoISS[03])
				cDirf 	:= aAutoISS[03]
				cCodRet	:= aAutoISS[04]
			EndIf			
		Endif	

	    nCombo	:= aOpcoes[VAL(Iif((cDirf$"1|2"),cDirf,"2"))]
	    nTamForn := IIf(lTamForn, nTamForn,0)                                                                                                
	   	If lFornIss 		    
			aPos[2] := 170                                                         
			aPos[3] -= 74
		   	@ 03,(Iif (lTamForn, nTamForn+53,85) +Iif (lTamLoja,10,0)) TO 42,(Iif (lTamForn, nTamForn+136,169)+Iif (lTamLoja,8,0))  LABEL '' OF oJanela PIXEL
		  	@ 06,(Iif (lTamForn, nTamForn+90,120)+Iif (lTamLoja,10,0)) SAY "DIRF" Of oJanela PIXEL SIZE 80,Iif (lTamForn, nTamForn+09,09) //"Dados de Cobrança do ISS"		
		   	@ 16,(Iif (lTamForn, nTamForn+57,89) +Iif (lTamLoja,10,0)) SAY RetTitle("E2_DIRF") Of oJanela PIXEL SIZE 30,Iif (lTamForn, nTamForn+09,09)
		   	@ 16,(Iif (lTamForn, nTamForn+93,125)+Iif (lTamLoja,10,0)) MSCOMBOBOX oCombo VAR nCombo ITEMS aOpcoes ON CHANGE (cDirf := StrZero(oCombo:nAt,1)) VALID MaGrvCdR(@cCodRet,oCombo,oList,@aCodR,@oCodRet,.F.) WHEN !lVisual SIZE 40,50 OF oJanela PIXEL	
		   	@ 27,(Iif (lTamForn, nTamForn+57,89) +Iif (lTamLoja,10,0)) SAY RetTitle("E2_CODRET") Of oJanela PIXEL SIZE 50,Iif (lTamForn, nTamForn+09,09)
		   	@ 27,(Iif (lTamForn, nTamForn+93,125)+Iif (lTamLoja,10,0)) MSGET oCodRet VAR cCodRet F3 "37" VALID MaGrvCdR(@cCodRet,oCombo,oList,@aCodR,@oCodRet,.T.) WHEN !lVisual OF oJanela PIXEL SIZE 40,09 
		   	@ 42,(Iif (lTamForn, nTamForn+53,85) +Iif (lTamLoja,10,0)) TO 58,(Iif (lTamForn, nTamForn+136,169)+Iif (lTamLoja,8,0))  LABEL '' OF oJanela PIXEL
		   	@ 47,(Iif (lTamForn, nTamForn+57,89) +Iif (lTamLoja,10,0))  SAY RetTitle("A2_RECISS") Of oJanela PIXEL SIZE 50,Iif (lTamForn, nTamForn+09,09)
		   	@ 46,(Iif (lTamForn, nTamForn+93,125)+Iif (lTamLoja,10,0)) MSCOMBOBOX oRecIss VAR cRecIss ITEMS aOpcIss VALID MaFisAlt( "NF_RECISS", cRecIss) WHEN !lVisual SIZE 40,50 OF oJanela PIXEL	
			aPos[2] -= 41
		Else
			aPos[2] := 129 
			aPos[3] -= 74
		  	@ 03,(Iif (lTamForn, nTamForn+53,85) +Iif (lTamLoja,10,0))TO 42,(Iif (lTamForn, nTamForn+136,169)+Iif (lTamLoja,8,0)) LABEL '' OF oJanela PIXEL
		  	@ 06,(Iif (lTamForn, nTamForn+90,120)+Iif (lTamLoja,10,0)) SAY "DIRF" Of oJanela PIXEL SIZE 80,Iif (lTamForn, nTamForn+09,09) //"Dados de Cobrança do ISS"		
		    @ 16,(Iif (lTamForn, nTamForn+57,89) +Iif (lTamLoja,10,0))SAY RetTitle("E2_DIRF") Of oJanela PIXEL SIZE 30,Iif (lTamForn, nTamForn+09,09)
		   	@ 16,(Iif (lTamForn, nTamForn+93,125)+Iif (lTamLoja,10,0)) MSCOMBOBOX oCombo VAR nCombo ITEMS aOpcoes ON CHANGE (cDirf := StrZero(oCombo:nAt,1)) VALID MaGrvCdR(@cCodRet,oCombo,oList,@aCodR,@oCodRet,.F.) WHEN !lVisual SIZE 40,50 OF oJanela PIXEL		
		    @ 27,(Iif (lTamForn, nTamForn+57,89) +Iif (lTamLoja,10,0))SAY RetTitle("E2_CODRET") Of oJanela PIXEL SIZE 50,Iif (lTamForn, nTamForn+09,09)
		    @ 27,(Iif (lTamForn, nTamForn+93,125)+Iif (lTamLoja,10,0))MSGET oCodRet VAR cCodRet F3 "37" VALID MaGrvCdR(@cCodRet,oCombo,oList,@aCodR,@oCodRet,.T.) WHEN !lVisual OF oJanela PIXEL SIZE 40,09 
		   	@ 42,(Iif (lTamForn, nTamForn+53,85) +Iif (lTamLoja,10,0))TO 58,(Iif (lTamForn, nTamForn+136,169)+Iif (lTamLoja,8,0))  LABEL '' OF oJanela PIXEL
		  	@ 47,(Iif (lTamForn, nTamForn+57,89) +Iif (lTamLoja,10,0))SAY RetTitle("A2_RECISS") Of oJanela PIXEL SIZE 50,Iif (lTamForn, nTamForn+09,09)
		    @ 46,(Iif (lTamForn, nTamForn+93,125)+Iif (lTamLoja,10,0))MSCOMBOBOX oRecIss VAR cRecIss ITEMS aOpcIss VALID MaFisAlt( "NF_RECISS", cRecIss) WHEN !lVisual SIZE 40,50 OF oJanela PIXEL
		Endif 	
	Endif
Endif	

If cPaisLoc <> "BRA" .and. lEditImp .and. FindFunction( "FISA081" ) .and. FindFunction( "FISA084" )
	aPos[2] := 85
	aPos[3] -= 80
	@ 03,02 To 58,( Iif( lTamForn, nTamForn + 52, 84 ) + Iif( lTamLoja, 9, 0 ) ) LABEL "Editar imposto" Of oJanela Pixel //
	@ 13,12 Button oBtn081 Prompt "Por Item" Action FISA081( oList ) Size 60,10 Of oJanela Pixel //
	@ 38,12 Button oBtn084 Prompt "Por Imposto" Action FISA084( oList ) Size 60,10 Of oJanela Pixel //
EndIf
If nTipo == 1
	oList := TWBrowse():New( aPos[1]-2,Iif(lTamForn .And. lRotina, aPos[2]+(nTamForn+nTamLoja),Iif(aParSX6[MV_VISDIRF] == "1" .And. lRotina,aPos[2]+41,aPos[2])),Iif(lTamForn .And. lRotina, aPos[3]+32-(nTamForn+nTamLoja),Iif(aParSX6[MV_VISDIRF] == "1" .And. lRotina,aPos[3]-10,aPos[3])),aPos[4]+2,,{STR0003,STR0004,STR0005,STR0006,STR0007},{30,90,50,30,50},oJanela,,,,,,,,,,,,.F.,,.T.,,.F.,,, ) //"Cod."###"Descricao"###"Base Imposto"###"Aliquota"###"Vlr. Imposto"
Else
	oList := TWBrowse():New( aPos[1]-2,Iif(lTamForn .And. lRotina, aPos[2]+(nTamForn+nTamLoja),Iif(aParSX6[MV_VISDIRF] == "1" .And. lRotina,aPos[2]+41,aPos[2])),Iif(lTamForn .And. lRotina, aPos[3]+32-(nTamForn+nTamLoja),Iif(aParSX6[MV_VISDIRF] == "1" .And. lRotina,aPos[3]-10,aPos[3])),aPos[4]+2,,{STR0003,STR0004,STR0005,STR0007},{30,90,50,50},oJanela,,,,,,,,,,,,.F.,,.T.,,.F.,,, ) //"Cod."###"Descricao"###"Base Imposto"###"Vlr. Imposto"
EndIf

If cPaisLoc == "ARG"
	nPosDum	:=	Ascan(aTemp,{|x| x[1] == "DUM"})
	If nPosDum > 0
		aDel(aTemp,nPosDum)
		aSize(aTemp,Len(aTemp)-1)
	Endif
Endif	
oList:SetArray(aTemp)

If aExistPE[PE_VISUIMP] 
	lVisuimp := ExecBlock("VISUIMP",.F.,.F.,{lVisuimp})
Endif
If !lVisual .And. !lVisuimp
	oList:bLDblClick 	:= {|| MaFisVRodape(oList,bValidPrg,nTipo,oList:nColPos) .And. MaFisInsereImp(oList,bValidPrg,nTipo)}
EndIf
oList:bChange 		:= {|| MaAtuCdR(@cCodRet,aCodR,oList,oCodRet,oCombo,@nCombo,aOpcoes)}
oList:bLine 		:= {|| MaFisLine(oList,aTemp,nTipo) }
oList:lAutoEdit	:= !lVisual .And. !lVisuimp

Return oList

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisVRoda³ Autor ³ Edson Maricate        ³ Data ³13.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Atualiza o Array de Resumos da NF.                          ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisVRodape(oList,bValidPrg,nTipo,nCol)

Local cIniCpo   := ""
Local nPos      := oList:nAT
Local nBaseAnt  := 0
Local nBase     := 0
Local nVal      := 0
Local nLiv	    := 0
Local lEditaVal := .F.
Local lEditaBas	:= .F.
Local nDec		:= IIf( MaFisFound("NF") , MsDecimais(Max(aNFCab[NF_MOEDA],1)) , 2 )
Local cPictGet	:= '@E 999,999,999' + IIf( nDec > 0 , "." + Replicate("9",nDec) , "" )

Private nValBck	:= 0
Private nValAnt := 0
Private cImposto:= ""

DEFAULT nCol := 0

If MaFisFound("NF") .And. Len( aNFCab[NF_IMPOSTOS] ) > 0 .And. IIf(nTipo==1,MaFisVldAlt(MaFisRet(,'NF_IMPOSTOS')[nPos][6]),MaFisVldAlt(MaFisRet(,'NF_IMPOSTOS')[nPos][5]))
	
	nBaseAnt := IIf(nTipo==1,aNFCab[NF_IMPOSTOS][nPos][3],aNFCab[NF_IMPOSTOS2][nPos][3])
	nBase    := nBaseAnt
	
	lEditaVal:= IIf(aScan(aNfCab[NF_RELIMP],{|x|x[3]==AllTrim('IT_VAL'+IIf(nTipo==1,MaFisRet(,'NF_IMPOSTOS')[nPos][6],MaFisRet(,'NF_IMPOSTOS2')[nPos][5]))})>0 ;
	.Or.  aScan(aNfCab[NF_RELIMP],{|x|x[3]==AllTrim('NF_VAL'+IIf(nTipo==1,MaFisRet(,'NF_IMPOSTOS')[nPos][6],MaFisRet(,'NF_IMPOSTOS2')[nPos][5]))})>0 ,.T.,.F.) ;
	.Or. MaFisRet(,'NF_IMPOSTOS')[nPos][6]=="RUR"
	If cPaisLoc <> "BRA"
		lEditaBas := .F.
	Else
		lEditaBas:= IIf(aScan(aNfCab[NF_RELIMP],{|x|x[3]==AllTrim('IT_BASE'+IIf(nTipo=1,MaFisRet(,'NF_IMPOSTOS')[nPos][6],MaFisRet(,'NF_IMPOSTOS2')[nPos][5]))})>0 ;
		.Or.  aScan(aNfCab[NF_RELIMP],{|x|x[3]==AllTrim('NF_BASE'+IIf(nTipo=1,MaFisRet(,'NF_IMPOSTOS')[nPos][6],MaFisRet(,'NF_IMPOSTOS2')[nPos][5]))})>0 ,.T.,.F.)
	Endif
	
	// Monta a Edicao da Base do imposto
	If lEditaBas .And. ( nCol == 0 .Or. nCol == 3)
		MaFisEditCell(@nBase,oList,cPictGet,3,'Positivo()')
		If nBaseAnt <> nBase
			If nTipo == 1
				cIniCpo	:= 'IMP_BASE'
				MaFisAlt('IMP_BASE'+MaFisRet(,'NF_IMPOSTOS')[nPos][6],nBase,nPos)
				If Len(aNFCab[NF_IMPOSTOS]) >= nPos
					If nBase > 0
						aNFCab[NF_IMPOSTOS][nPos][3] := nBase
					EndIf
				Else
					lEditaVal := .F.
				EndIf
			Else
				cIniCpo	:= 'NF_BASE'
				MaFisAlt('NF_BASE'+MaFisRet(,'NF_IMPOSTOS2')[nPos][5],nBase,nPos)
				If Len(aNFCab[NF_IMPOSTOS2]) >= nPos
					aNFCab[NF_IMPOSTOS2][nPos][3] := nBase
				Else
					lEditaVal := .F.
				EndIf
			EndIf
			Eval(bValidPrg)
			MaFisRRefresh(oList,nTipo)
		EndIf
	EndIf
	
	If lEditaVal
		
		nLiv:=NumCpoImpVar(Subs(IIf(nTipo==1,aNFCab[NF_IMPOSTOS][nPos][6],aNFCab[NF_IMPOSTOS2][nPos][5]),3,1))
		nValBck := aNFCab[NF_VLRORIG][nLiv]
		
		nValAnt	:= IIf(nTipo==1,aNFCab[NF_IMPOSTOS][nPos][5],aNFCab[NF_IMPOSTOS2][nPos][4])
		nVal	:= nValAnt
		
		If cPaisLoc=="BRA"
			MaFisEditCell(@nVal,oList,cPictGet,IIf(nTipo==1,5,4),'Positivo()')
		Else
			cImposto:= IIf(nTipo==1,aNFCab[NF_IMPOSTOS][nPos][1],aNFCab[NF_IMPOSTOS2][nPos][1])
			MaFisEditCell(@nVal,oList,cPictGet,IIf(nTipo==1,5,4),'LocxValImp(ReadVar(),nValBck,cImposto)')
		Endif
		If nValAnt<>nVal
			If nTipo == 1
				MaFisAlt('IMP_VAL'+MaFisRet(,'NF_IMPOSTOS')[nPos][6],nVal,nPos)
				If Len(aNFCab[NF_IMPOSTOS]) >= nPos
					aNFCab[NF_IMPOSTOS][nPos][5] := nVal
				Endif
			Else
				MaFisAlt('NF_VAL'+MaFisRet(,'NF_IMPOSTOS2')[nPos][5],nVal,nPos)
				If Len(aNFCab[NF_IMPOSTOS2]) >= nPos
					aNFCab[NF_IMPOSTOS2][nPos][4] := nVal
				Endif
			EndIf
			Eval(bValidPrg)
			MaFisRRefresh(oList,nTipo)
			aNFCab[NF_VLRORIG][nLiv]:=nValBck
		EndIf
	EndIf
EndIf

Return .T.

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±ºPrograma  ³MaVldForn     º Nereu H. Jr. ³Microsiga º Data ³  12/09/03  º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Valida fornecedor no momento da transferencia de fornecedorº±±
±±º          ³ na implantacao do titulo de ISS                            º±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Static Function MaVldForn(cFornIss,cLojaIss,oDescri,cDescri,oLojaISS,oFornIss,nTipo)

Local lRet := .F.

If Empty(cFornIss)
	cLojaISS:= Space(Len(cLojaIss))
	lRet    := .T. 	
	cDescri := ""
	oDescri:Refresh()
Else
	dbSelectArea("SA2")
	dbSetOrder(1)
	If MsSeek(xFilial("SA2")+cFornIss+cLojaIss)
		cDescri:= SA2->A2_NREDUZ
		lRet   := .T.
		oDescri:Refresh()
	Else
		If nTipo == 1
			lRet := .T.
		Else
			lRet := .F.
		Endif	
		cDescri := ""
	Endif	
EndIf

If nTipo == 2 .And. Empty(cLojaIss) .And. !Empty(cFornIss)
	cFornISS := Space(Len(cFornIss))
	lRet     := .T. 	
	cDescri  := ""
	oDescri:Refresh()
	oFornIss:Refresh()
Endif

IF lRet .And. !RegistroOk("SA2")
	lRet     := .F. 
EndIf 

Return(lRet)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisVldAlt³ Autor ³ Edson Maricate       ³ Data ³02.02.2000³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Verifica a referencia e se a mesma pode ser alterada.       ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisVldAlt(cReferencia,nItem)

Local lRet := .T.

If cPaisLoc == "BRA"
	Do Case
		Case aNfCab[NF_TIPONF] == "I" .And. Alltrim(cReferencia)$"IT_BASEICM#NF_BASEICM#IT_VALICM#NF_VALICM#IT_QUANT"
			Help("   ",1,"COMPICM")
			lRet := .F.
		Case aNfCab[NF_TIPONF] == "P" .And. AllTrim(cReferencia)$"IT_BASEIPI#NF_BASEIPI#IT_VALIPI#NF_VALIPI#IT_QUANT"
			Help("   ",1,"COMPIPI")
			lRet := .F.
		Case aNfCab[NF_TIPONF] == "C" .And. AllTrim(cReferencia)$"IT_QUANT"
			Help("   ",1,"COMPPRC")
			lRet := .F.
	EndCase
Else
	If nItem <> NIL .And. !Empty(aNfItem[nItem][IT_REMITO]) .And. Alltrim(cReferencia)$"IT_PRODUTO"
		Help("   ",1,"LOCXNF0003")
		lRet := .F.
	Endif
Endif

Return lRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisLine³ Autor ³ Edson Maricate         ³ Data ³13.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Retorna a linha de exibicao do ListBox atualizado.          ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisLine(oList,aTemp,nTipo)

Local aRet,nDec
Local cPictAliq	:= IIf( cPaisLoc="BRA","@E 999.99",PesqPict("SFB","FB_ALIQ"))
Local cPictVal	:=	""

If aParSX6[MV_DECALIQ]
	cPictAliq	:= IIf( cPaisLoc="BRA",PesqPict("SB1","B1_PPIS"),PesqPict("SFB","FB_ALIQ"))
EndIf
If cPaisLoc<>"BRA"
	If FunName()=="MATA121" .And. Type("nMoedaPed")=="N"
		nDec:=MsDecimais(nMoedaPed)
	ELSEIf FunName()=="MATA123" .And. Type("nMoedaPed")=="N"
		nDec:=MsDecimais(nMoedaPed)
	ElseIf FunName()=="MATA150" .And. Type("nMoedaCot")=="N"
		nDec:=MsDecimais(nMoedaCot)
	ElseIf FunName()=="MATA410"
		nDec:=MsDecimais(M->C5_MOEDA)
	Else
		nDec:=MsDecimais(IIf(Type("nMoedaNF")=="N",nMoedaNF,IIf(Type("nMoedaCor")=="N",nMoedaCor,1)))
	Endif
Else
	nDec:=2
Endif
cPictVal := "@E 999,999,999,999"+IIf(nDec>0,"."+Replicate("9",nDec),"")
If Len(aTemp)>0
	If nTipo == 1
		aRet:= {aTemp[oList:nAt][1],;
		aTemp[oList:nAt][2],;
		IIf(ValType(aTemp[oList:nAt][3])=="N",TransForm(aTemp[oList:nAt][3],cPictVal),aTemp[oList:nAt][3]),;
		TransForm(aTemp[oList:nAt][4],cPictAliq),;
		IIf(valType(aTemp[oList:nAt][5])=="N",TransForm(aTemp[oList:nAt][5],cPictVal),aTemp[oList:nAt][5]) }
	Else
		aRet:= {aTemp[oList:nAt][1],;
		aTemp[oList:nAt][2],;
		IIf(ValType(aTemp[oList:nAt][3])=="N",TransForm(aTemp[oList:nAt][3],cPictVal),aTemp[oList:nAt][3]),;
		IIf(ValType(aTemp[oList:nAt][4])=="N",TransForm(aTemp[oList:nAt][4],cPictVal),aTemp[oList:nAt][4]) }
	EndIf
Else
	aRet:={}
Endif

Return aRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisInser³ Autor ³ Edson Maricate        ³ Data ³13.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Insere um novo Imposto na NF.                               ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisInsereImp(oList,bValidPrg,nTipo)

Local oDlg
Local oCombo
Local lOk		:= .F.
Local nPos		:= oList:nAT
Local lInsere	:= .F.
Local aImpostos	:= { 'IRRF Imposto de Renda','ISS Imp. Serviço','I.C.M.S','IPI','ICMS Retido','INSS','PIS - Via Apuração','COFINS - Via Apuração','PIS - Via Retençao','COFINS - Via Retençao','CSLL - Via Retençao','ICMS Complementar','PIS - Subst. Tributaria','COFINS - Subst. Tributaria','SEST/SENAT','FETHAB','FABOV','FACS'}
Local aImpCod	:= { 'IRR','ISS','ICM','IPI','SOL','INS','PS2','CF2','PIS','COF','CSL','CMP','PS3','CF3','SES','FET','FAB','FAC'}
Local nBase		:= 0
Local nValor	:= 0
Local cImposto	:= aImpostos[1]

lInsere := If( MaFisFound("NF"), AllTrim(IIf(nTipo==1,Len(MaFisRet(,'NF_IMPOSTOS'))>0 .And. MaFisRet(,'NF_IMPOSTOS')[nPos][6],Len(MaFisRet(,'NF_IMPOSTOS2'))>0 .And. MaFisRet(,'NF_IMPOSTOS2')[nPos][5]))=="NEW", .F. )

If lInsere .And. cPaisLoc=="BRA"
	DEFINE MSDIALOG oDlg FROM 119,147 TO 320,580 TITLE "Impostos" Of oMainWnd PIXEL
	@ 22 ,09  SAY "Imposto" Of oDlg PIXEL SIZE 41,09
	@ 21 ,34  MSCOMBOBOX oCombo VAR cImposto ITEMS aImpostos SIZE 106,50 OF oDlg PIXEL
	@ 43 ,09  SAY "Base" Of oDlg PIXEL SIZE 28 ,9
	@ 59 ,09  SAY "Valor" Of oDlg PIXEL SIZE 42 ,9
	@ 42 ,34  MSGET nBase  Picture "@E 999,999,999,999.99" Valid Positivo(nBase)  OF oDlg PIXEL SIZE 75,09
	@ 60 ,34  MSGET nValor Picture "@E 999,999,999,999.99" Valid Positivo(nValor) OF oDlg PIXEL SIZE 75,09
	ACTIVATE MSDIALOG oDlg ON INIT EnchoiceBar(oDlg,{||lOk:=.T.,oDlg:End()},{||oDlg:End()}) CENTERED
EndIf

If lOk
	If aExistPE[PE_MFISIMP] 
		Execblock("MFISIMP",.F.,.F.,{nValor,aImpCod})
	Endif
	If !Empty(MaFisScan("NF_BASE"+aImpCod[aScan(aImpostos,cImposto)],.F.)) .And. (nBase > 0 .Or. aImpCod[aScan(aImpostos,cImposto)] $ "PIS,COF,CSL,IRR")
		MaFisAlt("NF_BASE"+aImpCod[aScan(aImpostos,cImposto)],nBase,)
	EndIf
	If !Empty(MaFisScan("NF_VAL"+aImpCod[aScan(aImpostos,cImposto)],.F.)) .And. (nValor > 0 .Or. aImpCod[aScan(aImpostos,cImposto)] $ "PIS,COF,CSL,IRR")
		MaFisAlt("NF_VAL"+aImpCod[aScan(aImpostos,cImposto)],nValor,)
	EndIf
	If nBase + nValor > 0
		MaFisRRefresh(oList,nTipo)
		Eval(bValidPrg)
	EndIf
EndIf

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisEditCellLine³ Autor ³ Edson Maricate ³ Data ³13.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Cria um Get para edicao do Imposta no ListBox.              ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisEditCell(nValor,oBrowse,cPict,nCol,cValidCpo)

Local oDlg
Local oRect
Local oGet1
Local oBtn
Local cMacro   := ''
Local nRow     := oBrowse:nAt
Local oOwner   := oBrowse:oWnd
Local lMaVldImp:= aExistPE[PE_MAVLDIMP] 
Local cValid   := IIf( cValidCpo == Nil , '.T.' , cValidCpo ) + ' .And. Eval(bChange)'
Local cCelula  := Iif( nCol == 3 , "BASE" , "VALOR" )  

bChange:= { || nValor := &cMacro,oBrowse:aArray[nRow,nCol] := &cMacro }
oRect  := tRect():New(0,0,0,0)    // obtem as coordenadas da celula (lugar onde
oBrowse:GetCellRect(nCol,,oRect)  // a janela de edicao deve ficar)
aDim   := {oRect:nTop,oRect:nLeft,oRect:nBottom,oRect:nRight}

DEFINE MSDIALOG oDlg OF oOwner FROM 0,0 TO 0,0 STYLE nOR( WS_VISIBLE, WS_POPUP ) PIXEL

cMacro := "M->CELL"
&cMacro:= nValor
cPict  := cPict
 
@ 0,0 MSGET oGet1 VAR &(cMacro) SIZE 0,0 OF oDlg FONT oOwner:oFont PICTURE cPict PIXEL HASBUTTON ;
VALID IIf( lMaVldImp , ExecBlock("MAVLDIMP", .F., .F. , { oBrowse:aArray[nRow,1] , oBrowse:aArray[nRow,3] , oBrowse:aArray[nRow,5] , cCelula , &(cMacro) } ) , .T. ) .And. &cValid 

oGet1:Move(-2,-2, (aDim[ 4 ] - aDim[ 2 ]) + 4, aDim[ 3 ] - aDim[ 1 ] + 4 )

@ 0,0 BUTTON oBtn PROMPT "ze" SIZE 0,0 OF oDlg
oBtn:bGotFocus := {|| oDlg:nLastKey := VK_RETURN, oDlg:End(0)}

oGet1:cReadVar  := cMacro

ACTIVATE MSDIALOG oDlg ON INIT oDlg:Move(aDim[1],aDim[2],aDim[4]-aDim[2], aDim[3]-aDim[1])

oBrowse:nAt := nRow
SetFocus(oBrowse:hWnd)
oBrowse:Refresh()

Return Nil

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisRRefresh³ Autor ³ Edson Maricate     ³ Data ³13.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Executa o Refresh no ListBox.                               ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisRRefresh(oList,nTipo,oFornISS,cFornISS,oLojaISS,cLojaISS,oRecISS,cRecISS)

Local aTemp
Local nPosDum := 0

If nTipo == 1
	aTemp := IIf(!Empty(aNfCab),aNfCab[NF_IMPOSTOS],{{"","",0,0,0}})
Else
	aTemp := IIf(!Empty(aNfCab),aNfCab[NF_IMPOSTOS2],{{"","",0,0}})
EndIf

If cPaisLoc == "ARG"
	nPosDum	:= Ascan(aTemp,{|x| x[1] == "DUM"})
	If nPosDum > 0
		aDel(aTemp,nPosDum)
		aSize(aTemp,Len(aTemp)-1)
	Endif
Endif

If aParSX6[MV_ISSXMUN]
	If ValType(oFornISS)<>"U"
		cFornISS := cFornCE1
		oFornISS:Refresh()
	EndIf
	
	If ValType(oLojaISS)<>"U"
		cLojaISS := cLojaCE1
		oLojaISS:Refresh()
	EndIf
	
	If ValType(oRecISS)<>"U"
		cRecISS := cRecISSCE1
		oRecISS:Refresh()
	EndIf
EndIf
If ValType(oList)<>"U"
	oList:SetArray(aTemp)
	oList:bLine := {|| MaFisLine(oList,aTemp,nTipo) }
	oList:Refresh()
EndIf

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡„o    ³MaGrvCdR  ³ Autor ³Gustavo G. Rueda       ³ Data ³15.12.2006 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Funcao de amarracao do Codigo de receita a devida retencao   º±±
±±º          ³ da aba impostos. Somente para PIS/COF/CSL/IRR.              º±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Variavel cCodRet que recebe o codigo atualizado.      ³±±
±±³          ³ExpO2: Objeto oCombo para refresh.                           ³±±
±±³          ³ExpO3: Objeto oList para refresh.                            ³±±
±±³          ³ExpA4: Variavel aCodR que contem todos os codigos d retencoes³±±
±±³          ³ relacionados na nota.                                       ³±±
±±³          ³ExpO5: Objeto oCodRet para refresh.                          ³±±
±±³          ³ExpL6: Flag para identificar se a chamada estah sendo d valid³±±
±±³          ³ do campo E2_CODRET                                          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³lRet -> Flag de retorno para o VALID                         ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaGrvCdR(cCodRet,oCombo,oList,aCodR,oCodRet,lCodRet)

Local lRet    := .T.
Local nPosCodR:= aScan(aCodR, {|x|x[4]==oList:AARRAY[oList:nAt][1]})

DEFAULT lCodRet := .F.

//Quando o combo for 2(Nao) nao deve ter o codigo de receita, por isso atribuo 2 e branco.
If oCombo:nAt==2
	cCodRet := Iif(cPaisLoc=="BRA", Space(TamSx3("E2_CODRET")[1]), Space(4))
	oCodRet:Refresh()
	
	If nPosCodR!=0
		aCodR[nPosCodR][2]:= cCodRet
		aCodR[nPosCodR][3]:= oCombo:nAt
	Else
		aAdd( aCodR, {oList:nAt, cCodRet, oCombo:nAt, oList:AARRAY[oList:nAt][1]} )
	EndIf
Else
	oCodRet:Refresh()
	If lCodRet .And. !CheckSx3("E2_CODRET", cCodRet)
		lRet := .F.
	Else
		If lCodRet .And. aExistPE[PE_VLCODRET] //  para validar o codigo de Retencao
			lRet := ExecBlock( "VLCODRET",.F.,.F.,{ oList:AARRAY[oList:nAt][1] , cCodRet })
			If ValType(lRet) <> "L"
				lRet :=  .T.
			EndIf
		EndIf
		
		If lRet
			If nPosCodR!=0
				aCodR[nPosCodR][2]:= cCodRet
				aCodR[nPosCodR][3]:= oCombo:nAt
			Else
				aAdd( aCodR, {oList:nAt, cCodRet, oCombo:nAt, oList:AARRAY[oList:nAt][1]} )
			EndIf
		EndIf
	EndIf
EndIf

Return lRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡„o    ³MaAtuCdR  ³ Autor ³Gustavo G. Rueda       ³ Data ³15.12.2006 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Rotina de atualizacao do codigo de receita exibido na aba    ³±±
±±³          ³ impostos a medida que seleciono a retencao no browse ao lado³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Variavel cCodRet que recebe o codigo atualizado.      ³±±
±±³          ³ExpA2: Variavel aCodR que contem todos   codigos de retencoes³±±
±±³          ³ relacionados na nota.                                       ³±±
±±³          ³ExpO3: Objeto oList para refresh.                            ³±±
±±³          ³ExpO4: Objeto oCodRet para refresh.                          ³±±
±±³          ³ExpO5: Objeto oCombo para refresh.                           ³±±
±±³          ³ExpO6: Variavel nCombo que recebe a opcao selecionada.       ³±±
±±³          ³ExpO7: Variavel aOpcoes que contem as opcoes para selecao.   ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaAtuCdR(cCodRet,aCodR,oList,oCodRet,oCombo,nCombo,aOpcoes)

Local nPosCodR := 0
Local nX       := 0

If oList <> Nil
	//Este tratamento se deve para o codigo de receita do IR caso venha preenchido atraves do MV_AUTOISS ou do PE MT103DRF.                                                        
	If Len(aCodR) == 1 .And. aCodR[1][1] == 99
		For nX := 1 To Len(oList:aArray)
			If oList:aArray[nX][1]=="IRR"
				aCodR[1][1]	:= nX
			EndIf
		Next nX
	EndIf
	
	If (nPosCodR:= aScan(aCodR, {|x|x[4] == oList:aArray[oList:nAt][1]})) > 0
		cCodRet	:= aCodR[nPosCodR,2]
		nCombo	:= aOpcoes[aCodR[nPosCodR,3]]
	Else
		cCodRet	:= Iif(cPaisLoc=="BRA", Space(TamSx3("E2_CODRET")[1]), Space(4))
		nCombo	:= aOpcoes[2]
	EndIf
EndIf
If oCodRet <> Nil
	oCodRet:Refresh()
EndIf
If oCombo <> Nil
	oCombo:Refresh()
EndIf
                                                                                       

Return .T.

/*_________________________________FUNCOES SECUNDARIAS AS FUNCOES PRINCIPAIS - FUNCOES DE APOIO __________________________________________________*/

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisIniCpo³ Autor ³Alexandre Lemes        ³ Data ³08/12/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³                                                             ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisIniCpo(nItem,lSeek)

Local lSBI       := cAliasPROD == "SBI" 
Local lArqProp   := aParSX6[MV_ARQPROP]
Local lAchouSS4  := .F.
Local lAchouSS6  := .F.
Local cHistSB1   := ""
Local cHistCFC   := ""
Local cHistSBZ   := ""

DEFAULT lSeek    := .T.

If lSeek
	If aNfItem[nItem][IT_RECNOSB1] <> 0 .And. cAliasPROD == "SB1"
		(cAliasPROD)->(MsGoto(aNfItem[nItem][IT_RECNOSB1]))
	Else
		If cAliasPROD == "SBI"
			SBI->(dbSetOrder(1))
			SBI->(MsSeek(xFilial("SBI")+aNfItem[nItem][IT_PRODUTO]))
		EndIf
		SB1->(dbSetOrder(1))
		SB1->(MsSeek(xFilial("SB1")+aNfItem[nItem][IT_PRODUTO]))
		If lHistorico
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Se for reprocessamento,  e tiver habilitado para buscar os Historico Fiscais,      ³
		//³verifico se o ID do historico do Cliente e igual ao que foi gravado na Nota. Se for³
		//³igual é porque nao teve alterações no cliente após a emissão. Se for diferente,    ³
		//³é porque teve alterações no cadastro, e entao os dados são carregados da tabela de ³
		//³Historico(SS2).                                                                    ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		
			
			If( aNfCab[NF_CLIFOR]=="C" .And. aNfCab[NF_TIPONF]<>"D") .Or.( aNfCab[NF_CLIFOR]=="F" .And. aNfCab[NF_TIPONF]$"D|B")
				cHistSB1 :=  (cAlsItem)->D2_IDSB1
			Else
				cHistSB1 :=   (cAlsItem)->D1_IDSB1
			End				
			
			If  Alltrim(SB1->B1_IDHIST)<>Alltrim(cHistSB1)
				SS4->(dbSetOrder(1))	
				SS4->(MsSeek(xFilial("SS4")+cHistSB1))
				lAchouSS4 := .T.
			EndIf								                                                                 
			
		EndIf
		
	EndIf
EndIf

aNfItem[nItem][IT_PRD][SB_COD]    := IIf( lSBI .And. aFieldPos[FP_BI_COD]    , SBI->BI_COD    , IIf( aFieldPos[FP_B1_COD]    .And. lSeek , IIf(lAchouSS4, SS4->S4_COD    , SB1->B1_COD    ), " " ) )
aNfItem[nItem][IT_PRD][SB_GRTRIB] := IIf( lSBI .And. aFieldPos[FP_BI_GRTRIB] , SBI->BI_GRTRIB , IIf( aFieldPos[FP_B1_GRTRIB] .And. lSeek , IIf(lAchouSS4, SS4->S4_GRTRIB , SB1->B1_GRTRIB ), " " ) )
aNfItem[nItem][IT_PRD][SB_CODIF]  := IIf( lSBI .And. aFieldPos[FP_BI_CODIF]  , SBI->BI_CODIF  , IIf( aFieldPos[FP_B1_CODIF]  .And. lSeek , IIf(lAchouSS4 .And. aFieldPos[FP_S4_CODIF] , SS4->S4_CODIF  , SB1->B1_CODIF  ), " " ) )
aNfItem[nItem][IT_PRD][SB_RSATIVO]:= IIf( lSBI .And. aFieldPos[FP_BI_RSATIVO], SBI->BI_RSATIVO, IIf( aFieldPos[FP_B1_RSATIVO].And. lSeek , IIf(lAchouSS4, SS4->S4_RSATIVO, SB1->B1_RSATIVO), " " ) )
aNfItem[nItem][IT_PRD][SB_POSIPI] := IIf( lSBI .And. aFieldPos[FP_BI_POSIPI] , SBI->BI_POSIPI , IIf( aFieldPos[FP_B1_POSIPI] .And. lSeek , IIf(lAchouSS4, SS4->S4_POSIPI , SB1->B1_POSIPI ), " " ) )
aNfItem[nItem][IT_PRD][SB_UM]     := IIf( lSBI .And. aFieldPos[FP_BI_UM]     , SBI->BI_UM     , IIf( aFieldPos[FP_B1_UM]     .And. lSeek , IIf(lAchouSS4, SS4->S4_UM     , SB1->B1_UM     ), " " ) )
aNfItem[nItem][IT_PRD][SB_SEGUM]  := IIf( lSBI .And. aFieldPos[FP_BI_SEGUM]  , SBI->BI_SEGUM  , IIf( aFieldPos[FP_B1_SEGUM]  .And. lSeek , IIf(lAchouSS4, SS4->S4_SEGUM  , SB1->B1_SEGUM  ), " " ) )
aNfItem[nItem][IT_PRD][SB_AFABOV] := IIf( lSBI .And. aFieldPos[FP_BI_AFABOV] , SBI->BI_AFABOV , IIf( aFieldPos[FP_B1_AFABOV] .And. lSeek , IIf(lAchouSS4, SS4->S4_AFABOV , SB1->B1_AFABOV ), 0   ) )
aNfItem[nItem][IT_PRD][SB_AFACS]  := IIf( lSBI .And. aFieldPos[FP_BI_AFACS]  , SBI->BI_AFACS  , IIf( aFieldPos[FP_B1_AFACS]  .And. lSeek , IIf(lAchouSS4, SS4->S4_AFACS  , SB1->B1_AFACS  ), 0   ) )
aNfItem[nItem][IT_PRD][SB_AFETHAB]:= IIf( lSBI .And. aFieldPos[FP_BI_AFETHAB], SBI->BI_AFETHAB, IIf( aFieldPos[FP_B1_AFETHAB].And. lSeek , IIf(lAchouSS4, SS4->S4_AFETHAB, SB1->B1_AFETHAB), 0   ) )
aNfItem[nItem][IT_PRD][SB_TFETHAB]:= IIf( lSBI .And. aFieldPos[FP_BI_TFETHAB], SBI->BI_TFETHAB, IIf( aFieldPos[FP_B1_TFETHAB].And. lSeek , IIf(lAchouSS4, SS4->S4_TFETHAB, SB1->B1_TFETHAB), " " ) )
aNfItem[nItem][IT_PRD][SB_PICM]   := IIf( lSBI .And. aFieldPos[FP_BI_PICM]   , SBI->BI_PICM   , IIf( aFieldPos[FP_B1_PICM]   .And. lSeek , IIf(lAchouSS4, SS4->S4_PICM   , SB1->B1_PICM   ), 0   ) )
aNfItem[nItem][IT_PRD][SB_FECOP]  := IIf( lSBI .And. aFieldPos[FP_BI_FECOP]  , SBI->BI_FECOP  , IIf( aFieldPos[FP_B1_FECOP]  .And. lSeek , IIf(lAchouSS4, SS4->S4_FECOP  , SB1->B1_FECOP  ), " " ) )
aNfItem[nItem][IT_PRD][SB_ALFECOP]:= IIf( lSBI .And. aFieldPos[FP_BI_ALFECOP], SBI->BI_ALFECOP, IIf( aFieldPos[FP_B1_ALFECOP].And. lSeek , IIf(lAchouSS4, SS4->S4_ALFECOP, SB1->B1_ALFECOP), 0   ) )
aNfItem[nItem][IT_PRD][SB_ALIQISS]:= IIf( lSBI .And. aFieldPos[FP_BI_ALIQISS], SBI->BI_ALIQISS, IIf( aFieldPos[FP_B1_ALIQISS].And. lSeek , IIf(lAchouSS4, SS4->S4_ALIQISS, SB1->B1_ALIQISS), 0   ) )
aNfItem[nItem][IT_PRD][SB_IMPZFRC]:= IIf( lSBI .And. aFieldPos[FP_BI_IMPZFRC], SBI->BI_IMPZFRC, IIf( aFieldPos[FP_B1_IMPZFRC].And. lSeek , IIf(lAchouSS4, SS4->S4_IMPZFRC, SB1->B1_IMPZFRC), " " ) )
aNfItem[nItem][IT_PRD][SB_INT_ICM]:= IIf( lSBI .And. aFieldPos[FP_BI_INT_ICM], SBI->BI_INT_ICM, IIf( aFieldPos[FP_B1_INT_ICM].And. lSeek , IIf(lAchouSS4, SS4->S4_INT_ICM, SB1->B1_INT_ICM), 0   ) )
aNfItem[nItem][IT_PRD][SB_PR43080]:= IIf( lSBI .And. aFieldPos[FP_BI_PR43080], SBI->BI_PR43080, IIf( aFieldPos[FP_B1_PR43080].And. lSeek , IIf(lAchouSS4, SS4->S4_PR43080, SB1->B1_PR43080), 0   ) )
aNfItem[nItem][IT_PRD][SB_PRINCMG]:= IIf( lSBI .And. aFieldPos[FP_BI_PRINCMG], SBI->BI_PRINCMG, IIf( aFieldPos[FP_B1_PRINCMG].And. lSeek , IIf(lAchouSS4, SS4->S4_PRINCMG, SB1->B1_PRINCMG), 0   ) )
aNfItem[nItem][IT_PRD][SB_ALFECST]:= IIf( lSBI .And. aFieldPos[FP_BI_ALFECST], SBI->BI_ALFECST, IIf( aFieldPos[FP_B1_ALFECST].And. lSeek , IIf(lAchouSS4, SS4->S4_ALFECST, SB1->B1_ALFECST), 0   ) )
aNfItem[nItem][IT_PRD][SB_PICMENT]:= IIf( lSBI .And. aFieldPos[FP_BI_PICMENT], SBI->BI_PICMENT, IIf( aFieldPos[FP_B1_PICMENT].And. lSeek , IIf(lAchouSS4, SS4->S4_PICMENT, SB1->B1_PICMENT), 0   ) )
aNfItem[nItem][IT_PRD][SB_PICMRET]:= IIf( lSBI .And. aFieldPos[FP_BI_PICMRET], SBI->BI_PICMRET, IIf( aFieldPos[FP_B1_PICMRET].And. lSeek , IIf(lAchouSS4, SS4->S4_PICMRET, SB1->B1_PICMRET), 0   ) )
aNfItem[nItem][IT_PRD][SB_IVAAJU] := IIf( lSBI .And. aFieldPos[FP_BI_IVAAJU] , SBI->BI_IVAAJU , IIf( aFieldPos[FP_B1_IVAAJU] .And. lSeek , IIf(lAchouSS4, SS4->S4_IVAAJU , SB1->B1_IVAAJU ), " " ) )
aNfItem[nItem][IT_PRD][SB_RASTRO] := IIf( lSBI .And. aFieldPos[FP_BI_RASTRO] , SBI->BI_RASTRO , IIf( aFieldPos[FP_B1_RASTRO] .And. lSeek , IIf(lAchouSS4, SS4->S4_RASTRO , SB1->B1_RASTRO ), " " ) )
aNfItem[nItem][IT_PRD][SB_VLR_ICM]:= IIf( lSBI .And. aFieldPos[FP_BI_VLR_ICM], SBI->BI_VLR_ICM, IIf( aFieldPos[FP_B1_VLR_ICM].And. lSeek , IIf(lAchouSS4, SS4->S4_VLR_ICM, SB1->B1_VLR_ICM), 0   ) )
aNfItem[nItem][IT_PRD][SB_VLR_PIS]:= IIf( lSBI .And. aFieldPos[FP_BI_VLR_PIS], SBI->BI_VLR_PIS, IIf( aFieldPos[FP_B1_VLR_PIS].And. lSeek , IIf(lAchouSS4, SS4->S4_VLR_PIS, SB1->B1_VLR_PIS), 0   ) )
aNfItem[nItem][IT_PRD][SB_VLR_COF]:= IIf( lSBI .And. aFieldPos[FP_BI_VLR_COF], SBI->BI_VLR_COF, IIf( aFieldPos[FP_B1_VLR_COF].And. lSeek , IIf(lAchouSS4, SS4->S4_VLR_COF, SB1->B1_VLR_COF), 0   ) )
aNfItem[nItem][IT_PRD][SB_ORIGEM] := IIf( lSBI .And. aFieldPos[FP_BI_ORIGEM] , SBI->BI_ORIGEM , IIf( aFieldPos[FP_B1_ORIGEM] .And. lSeek , IIf(lAchouSS4, SS4->S4_ORIGEM , SB1->B1_ORIGEM ), " " ) )
aNfItem[nItem][IT_PRD][SB_CRDEST] := IIf( lSBI .And. aFieldPos[FP_BI_CRDEST] , SBI->BI_CRDEST , IIf( aFieldPos[FP_B1_CRDEST] .And. lSeek , IIf(lAchouSS4, SS4->S4_CRDEST , SB1->B1_CRDEST ), 0   ) )
aNfItem[nItem][IT_PRD][SB_CODISS] := IIf( lSBI .And. aFieldPos[FP_BI_CODISS] , SBI->BI_CODISS , IIf( aFieldPos[FP_B1_CODISS] .And. lSeek , IIf(lAchouSS4, SS4->S4_CODISS , SB1->B1_CODISS ), " " ) )
aNfItem[nItem][IT_PRD][SB_TNATREC]:= IIf( lSBI .And. aFieldPos[FP_BI_TNATREC], SBI->BI_TNATREC, IIf( aFieldPos[FP_B1_TNATREC].And. lSeek , IIf(lAchouSS4, SS4->S4_TNATREC, SB1->B1_TNATREC), " " ) )
aNfItem[nItem][IT_PRD][SB_CNATREC]:= IIf( lSBI .And. aFieldPos[FP_BI_CNATREC], SBI->BI_CNATREC, IIf( aFieldPos[FP_B1_CNATREC].And. lSeek , IIf(lAchouSS4, SS4->S4_CNATREC, SB1->B1_CNATREC), " " ) )
aNfItem[nItem][IT_PRD][SB_GRPNATR]:= IIf( lSBI .And. aFieldPos[FP_BI_GRPNATR], SBI->BI_GRPNATR, IIf( aFieldPos[FP_B1_GRPNATR].And. lSeek , IIf(lAchouSS4, SS4->S4_GRPNATR, SB1->B1_GRPNATR), " " ) )
aNfItem[nItem][IT_PRD][SB_DTFIMNT]:= IIf( lSBI .And. aFieldPos[FP_BI_DTFIMNT], SBI->BI_DTFIMNT, IIf( aFieldPos[FP_B1_DTFIMNT].And. lSeek , IIf(lAchouSS4, SS4->S4_DTFIMNT, SB1->B1_DTFIMNT), CtoD("") ) )
aNfItem[nItem][IT_PRD][SB_IPI]    := IIf( lSBI .And. aFieldPos[FP_BI_IPI]    , SBI->BI_IPI    , IIf( aFieldPos[FP_B1_IPI]    .And. lSeek , IIf(lAchouSS4, SS4->S4_IPI    , SB1->B1_IPI    ), 0   ) )
aNfItem[nItem][IT_PRD][SB_VLR_IPI]:= IIf( lSBI .And. aFieldPos[FP_BI_VLR_IPI], SBI->BI_VLR_IPI, IIf( aFieldPos[FP_B1_VLR_IPI].And. lSeek , IIf(lAchouSS4, SS4->S4_VLR_IPI, SB1->B1_VLR_IPI), 0   ) )
aNfItem[nItem][IT_PRD][SB_CNAE]   := IIf( lSBI .And. aFieldPos[FP_BI_CNAE]   , SBI->BI_CNAE   , IIf( aFieldPos[FP_B1_CNAE]   .And. lSeek , IIf(lAchouSS4, SS4->S4_CNAE   , SB1->B1_CNAE   ), " " ) )
aNfItem[nItem][IT_PRD][SB_REGRISS]:= IIf( lSBI .And. aFieldPos[FP_BI_REGRISS], SBI->BI_REGRISS, IIf( aFieldPos[FP_B1_REGRISS].And. lSeek , IIf(lAchouSS4, SS4->S4_REGRISS, SB1->B1_REGRISS), " " ) )
aNfItem[nItem][IT_PRD][SB_REDINSS]:= IIf( lSBI .And. aFieldPos[FP_BI_REDINSS], SBI->BI_REDINSS, IIf( aFieldPos[FP_B1_REDINSS].And. lSeek , IIf(lAchouSS4, SS4->S4_REDINSS, SB1->B1_REDINSS), 0   ) )
aNfItem[nItem][IT_PRD][SB_INSS]   := IIf( lSBI .And. aFieldPos[FP_BI_INSS]   , SBI->BI_INSS   , IIf( aFieldPos[FP_B1_INSS]   .And. lSeek , IIf(lAchouSS4, SS4->S4_INSS   , SB1->B1_INSS   ), " " ) )
aNfItem[nItem][IT_PRD][SB_IRRF]   := IIf( lSBI .And. aFieldPos[FP_BI_IRRF]   , SBI->BI_IRRF   , IIf( aFieldPos[FP_B1_IRRF]   .And. lSeek , IIf(lAchouSS4, SS4->S4_IRRF   , SB1->B1_IRRF   ), " " ) )
aNfItem[nItem][IT_PRD][SB_REDIRRF]:= IIf( lSBI .And. aFieldPos[FP_BI_REDIRRF], SBI->BI_REDIRRF, IIf( aFieldPos[FP_B1_REDIRRF].And. lSeek , IIf(lAchouSS4, SS4->S4_REDIRRF, SB1->B1_REDIRRF), 0   ) )
aNfItem[nItem][IT_PRD][SB_REDPIS] := IIf( lSBI .And. aFieldPos[FP_BI_REDPIS] , SBI->BI_REDPIS , IIf( aFieldPos[FP_B1_REDPIS] .And. lSeek , IIf(lAchouSS4, SS4->S4_REDPIS , SB1->B1_REDPIS ), 0   ) )
aNfItem[nItem][IT_PRD][SB_PPIS]   := IIf( lSBI .And. aFieldPos[FP_BI_PPIS]   , SBI->BI_PPIS   , IIf( aFieldPos[FP_B1_PPIS]   .And. lSeek , IIf(lAchouSS4, SS4->S4_PPIS   , SB1->B1_PPIS   ), 0   ) )
aNfItem[nItem][IT_PRD][SB_PIS]    := IIf( lSBI .And. aFieldPos[FP_BI_PIS]    , SBI->BI_PIS    , IIf( aFieldPos[FP_B1_PIS]    .And. lSeek , IIf(lAchouSS4, SS4->S4_PIS    , SB1->B1_PIS    ), " " ) )
aNfItem[nItem][IT_PRD][SB_CHASSI] := IIf( lSBI .And. aFieldPos[FP_BI_CHASSI] , SBI->BI_CHASSI , IIf( aFieldPos[FP_B1_CHASSI] .And. lSeek , IIf(lAchouSS4  .And. aFieldPos[FP_S4_CHASSI], SS4->S4_CHASSI , SB1->B1_CHASSI ), " " ) )
aNfItem[nItem][IT_PRD][SB_RETOPER]:= IIf( lSBI .And. aFieldPos[FP_BI_RETOPER], SBI->BI_RETOPER, IIf( aFieldPos[FP_B1_RETOPER].And. lSeek , IIf(lAchouSS4, SS4->S4_RETOPER, SB1->B1_RETOPER), " " ) )
aNfItem[nItem][IT_PRD][SB_REDCOF] := IIf( lSBI .And. aFieldPos[FP_BI_REDCOF] , SBI->BI_REDCOF , IIf( aFieldPos[FP_B1_REDCOF] .And. lSeek , IIf(lAchouSS4, SS4->S4_REDCOF , SB1->B1_REDCOF ), 0   ) )
aNfItem[nItem][IT_PRD][SB_PCOFINS]:= IIf( lSBI .And. aFieldPos[FP_BI_PCOFINS], SBI->BI_PCOFINS, IIf( aFieldPos[FP_B1_PCOFINS].And. lSeek , IIf(lAchouSS4, SS4->S4_PCOFINS, SB1->B1_PCOFINS), 0   ) )
aNfItem[nItem][IT_PRD][SB_COFINS] := IIf( lSBI .And. aFieldPos[FP_BI_COFINS] , SBI->BI_COFINS , IIf( aFieldPos[FP_B1_COFINS] .And. lSeek , IIf(lAchouSS4, SS4->S4_COFINS , SB1->B1_COFINS ), " " ) )
aNfItem[nItem][IT_PRD][SB_PCSLL]  := IIf( lSBI .And. aFieldPos[FP_BI_PCSLL]  , SBI->BI_PCSLL  , IIf( aFieldPos[FP_B1_PCSLL]  .And. lSeek , IIf(lAchouSS4, SS4->S4_PCSLL  , SB1->B1_PCSLL  ), 0   ) )
aNfItem[nItem][IT_PRD][SB_CONTSOC]:= IIf( lSBI .And. aFieldPos[FP_BI_CONTSOC], SBI->BI_CONTSOC, IIf( aFieldPos[FP_B1_CONTSOC].And. lSeek , IIf(lAchouSS4, SS4->S4_CONTSOC, SB1->B1_CONTSOC), " " ) )
aNfItem[nItem][IT_PRD][SB_PRFDSUL]:= IIf( lSBI .And. aFieldPos[FP_BI_PRFDSUL], SBI->BI_PRFDSUL, IIf( aFieldPos[FP_B1_PRFDSUL].And. lSeek , IIf(lAchouSS4, SS4->S4_PRFDSUL, SB1->B1_PRFDSUL), 0   ) )
aNfItem[nItem][IT_PRD][SB_FECP]   := IIf( lSBI .And. aFieldPos[FP_BI_FECP]   , SBI->BI_FECP   , IIf( aFieldPos[FP_B1_FECP]   .And. lSeek , IIf(lAchouSS4, SS4->S4_FECP   , SB1->B1_FECP   ), 0   ) )
aNfItem[nItem][IT_PRD][SB_FECPBA] := IIf( lSBI .And. aFieldPos[FP_BI_FECPBA] , SBI->BI_FECPBA , IIf( aFieldPos[FP_B1_FECPBA] .And. lSeek , IIf(lAchouSS4, SS4->S4_FECPBA , SB1->B1_FECPBA ), 0   ) )
aNfItem[nItem][IT_PRD][SB_ALFECRN]:= IIf( lSBI .And. aFieldPos[FP_BI_ALFECRN], SBI->BI_ALFECRN, IIf( aFieldPos[FP_B1_ALFECRN].And. lSeek , IIf(lAchouSS4, SS4->S4_ALFECRN, SB1->B1_ALFECRN), 0   ) )
aNfItem[nItem][IT_PRD][SB_ALFUMAC]:= IIf( lSBI .And. aFieldPos[FP_BI_ALFUMAC], SBI->BI_ALFUMAC, IIf( aFieldPos[FP_B1_ALFUMAC].And. lSeek , IIf(lAchouSS4, SS4->S4_ALFUMAC, SB1->B1_ALFUMAC), 0   ) )
aNfItem[nItem][IT_PRD][SB_PRN944I]:= IIf( lSBI .And. aFieldPos[FP_BI_PRN944I], SBI->BI_PRN944I, IIf( aFieldPos[FP_B1_PRN944I].And. lSeek , IIf(lAchouSS4, SS4->S4_PRN944I, SB1->B1_PRN944I), " " ) )
aNfItem[nItem][IT_PRD][SB_REGESIM]:= IIf( lSBI .And. aFieldPos[FP_BI_REGESIM], SBI->BI_REGESIM, IIf( aFieldPos[FP_B1_REGESIM].And. lSeek , IIf(lAchouSS4, SS4->S4_REGESIM, SB1->B1_REGESIM), " " ) )
aNfItem[nItem][IT_PRD][SB_VLRISC] := IIf( lSBI .And. aFieldPos[FP_BI_VLRISC] , SBI->BI_VLRISC , IIf( aFieldPos[FP_B1_VLRISC] .And. lSeek , IIf(lAchouSS4 .And. aFieldPos[FP_S4_VLRISC], SS4->S4_VLRISC , SB1->B1_VLRISC ), 0   ) )
aNfItem[nItem][IT_PRD][SB_CRDPRES]:= IIf( lSBI .And. aFieldPos[FP_BI_CRDPRES], SBI->BI_CRDPRES, IIf( aFieldPos[FP_B1_CRDPRES].And. lSeek , IIf(lAchouSS4, SS4->S4_CRDPRES, SB1->B1_CRDPRES), 0   ) )
aNfItem[nItem][IT_PRD][SB_VMINDET]:= IIf( lSBI .And. aFieldPos[FP_BI_VMINDET], SBI->BI_VMINDET, IIf( aFieldPos[FP_B1_VMINDET].And. lSeek , IIf(lAchouSS4 .And. aFieldPos[FP_S4_VMINDET], SS4->S4_VMINDET, SB1->B1_VMINDET), 0   ) )
aNfItem[nItem][IT_PRD][SB_IMPORT] := IIf( lSBI .And. aFieldPos[FP_BI_IMPORT] , SBI->BI_IMPORT , IIf( aFieldPos[FP_B1_IMPORT] .And. lSeek , IIf(lAchouSS4, SS4->S4_IMPORT , SB1->B1_IMPORT ), " " ) )
aNfItem[nItem][IT_PRD][SB_TPDP]   := IIf( lSBI .And. aFieldPos[FP_BI_TPDP]   , SBI->BI_TPDP   , IIf( aFieldPos[FP_B1_TPDP]   .And. lSeek , IIf(lAchouSS4, SS4->S4_TPDP   , SB1->B1_TPDP   ), " " ) )
aNfItem[nItem][IT_PRD][SB_CSLL]   := IIf( lSBI .And. aFieldPos[FP_BI_CSLL]   , SBI->BI_CSLL   , IIf( aFieldPos[FP_B1_CSLL]   .And. lSeek , IIf(lAchouSS4, SS4->S4_CSLL   , SB1->B1_CSLL   ), " " ) )
aNfItem[nItem][IT_PRD][SB_IDHIST] := IIf( lSBI                                , ""             , IIf( aFieldPos[FP_B1_IDHIST] .And. lSeek , IIf(lAchouSS4, SS4->S4_IDHIST , SB1->B1_IDHIST ), " " ) )
aNfItem[nItem][IT_PRD][SB_MEPLES] := IIf( lSBI .And. aFieldPos[FP_BI_MEPLES] , SBI->BI_MEPLES , IIf( aFieldPos[FP_B1_MEPLES] .And. lSeek , IIf(lAchouSS4, SS4->S4_MEPLES , SB1->B1_MEPLES ), " " ) )

aNfItem[nItem][IT_IDSB1]          := IIf( aFieldPos[FP_B1_IDHIST]   .And. lSeek , IIf(lAchouSS4, SS4->S4_IDHIST, SB1->B1_IDHIST)   , ""   )

aNfItem[nItem][IT_PRD][SB_ALQDFB1]:= IIf( lSBI .And. aFieldPos[FP_BI_ALQDFB1], SBI->&("BI_"+Substr(aParSX6[MV_ALQDFB1],4)), IIf( aFieldPos[FP_B1_ALQDFB1], SB1->&("B1_"+Substr(aParSX6[MV_ALQDFB1],4)) , "2" ) ) 
aNfItem[nItem][IT_PRD][SB_B1PTST] := IIf( lSBI .And. aFieldPos[FP_BI_B1PTST] , SBI->&("BI_"+Substr(aParSX6[MV_B1PTST] ,4)), IIf( aFieldPos[FP_B1_B1PTST] , SB1->&("B1_"+Substr(aParSX6[MV_B1PTST] ,4)) , 0   ) ) 
aNfItem[nItem][IT_PRD][SB_PRDDIAT]:= IIf( lSBI .And. aFieldPos[FP_BI_PRDDIAT], SBI->&("BI_"+Substr(aParSX6[MV_PRDDIAT],4)), IIf( aFieldPos[FP_B1_PRDDIAT], SB1->&("B1_"+Substr(aParSX6[MV_PRDDIAT],4)) , " " ) ) 
aNfItem[nItem][IT_PRD][SB_B1CALTR]:= IIf( lSBI .And. aFieldPos[FP_BI_B1CALTR], SBI->&("BI_"+Substr(aParSX6[MV_B1CALTR],4)), IIf( aFieldPos[FP_B1_B1CALTR], SB1->&("B1_"+Substr(aParSX6[MV_B1CALTR],4)) , " " ) ) 
aNfItem[nItem][IT_PRD][SB_B1CATRI]:= IIf( lSBI .And. aFieldPos[FP_BI_B1CATRI], SBI->&("BI_"+Substr(aParSX6[MV_B1CATRI],4)), IIf( aFieldPos[FP_B1_B1CATRI], SB1->&("B1_"+Substr(aParSX6[MV_B1CATRI],4)) , 0   ) ) 
aNfItem[nItem][IT_PRD][SB_ICMPFAT]:= IIf( lSBI .And. aFieldPos[FP_BI_ICMPFAT], SBI->&("BI_"+Substr(aParSX6[MV_ICMPFAT],4)), IIf( aFieldPos[FP_B1_ICMPFAT], SB1->&("B1_"+Substr(aParSX6[MV_ICMPFAT],4)) , 0   ) ) 
aNfItem[nItem][IT_PRD][SB_IPIPFAT]:= IIf( lSBI .And. aFieldPos[FP_BI_IPIPFAT], SBI->&("BI_"+Substr(aParSX6[MV_IPIPFAT],4)), IIf( aFieldPos[FP_B1_IPIPFAT], SB1->&("B1_"+Substr(aParSX6[MV_IPIPFAT],4)) , 0   ) ) 
aNfItem[nItem][IT_PRD][SB_PUPCCST]:= IIf( lSBI .And. aFieldPos[FP_BI_PUPCCST], SBI->&("BI_"+Substr(aParSX6[MV_PUPCCST],4)), IIf( aFieldPos[FP_B1_PUPCCST], SB1->&("B1_"+Substr(aParSX6[MV_PUPCCST],4)) , 0   ) ) 
aNfItem[nItem][IT_PRD][SB_B1CPSST]:= IIf( lSBI .And. aFieldPos[FP_BI_B1CPSST], SBI->&("BI_"+Substr(aParSX6[MV_B1CPSST],4)), IIf( aFieldPos[FP_B1_B1CPSST], SB1->&("B1_"+Substr(aParSX6[MV_B1CPSST],4)) , 0   ) ) 
aNfItem[nItem][IT_PRD][SB_B1CCFST]:= IIf( lSBI .And. aFieldPos[FP_BI_B1CCFST], SBI->&("BI_"+Substr(aParSX6[MV_B1CCFST],4)), IIf( aFieldPos[FP_B1_B1CCFST], SB1->&("B1_"+Substr(aParSX6[MV_B1CCFST],4)) , 0   ) ) 
aNfItem[nItem][IT_PRD][SB_FECPMT] := IIf( lSBI .And. aFieldPos[FP_BI_FECPMT] , SBI->&("BI_"+Substr(aParSX6[MV_FECPMT] ,4)), IIf( aFieldPos[FP_B1_FECPMT] , SB1->&("B1_"+Substr(aParSX6[MV_FECPMT] ,4)) , 0   ) ) 
aNfItem[nItem][IT_PRD][SB_ADIFECP]:= IIf( lSBI .And. aFieldPos[FP_BI_ADIFECP], SBI->&("BI_"+Substr(aParSX6[MV_ADIFECP],4)), IIf( aFieldPos[FP_B1_ADIFECP], SB1->&("B1_"+Substr(aParSX6[MV_ADIFECP],4)) , 0   ) ) 
aNfItem[nItem][IT_PRD][SB_ALFECMG]:= IIf( lSBI .And. aFieldPos[FP_BI_ALFECMG], SBI->&("BI_"+Substr(aParSX6[MV_ALFECMG],4)), IIf( aFieldPos[FP_B1_ALFECMG], SB1->&("B1_"+Substr(aParSX6[MV_ALFECMG],4)) , 0   ) ) 

SBZ->(dbSetOrder(1))
If lSeek .And. cAliasPROD == "SB1" .And. aParSX6[MV_ARQPROD] == "SBZ" .And. SBZ->( MsSeek( xFilial("SBZ") + SB1->B1_COD ) )

	If lHistorico 
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Se for reprocessamento,  e tiver habilitado para buscar os Historico Fiscais,      ³
	//³verifico se o ID do historico do Ind.Prod.e igual aoque foi gravado na Nota. Se for³
	//³igual é porque nao teve alterações no Ind.Prod.   na emissão. Se for diferente,    ³
	//³é porque teve alterações no cadastro, e entao os dados são carregados da tabela de ³
	//³Historico(SS2).                                                                    ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If( aNfCab[NF_CLIFOR]=="C" .And. aNfCab[NF_TIPONF]<>"D") .Or.( aNfCab[NF_CLIFOR]=="F" .And. aNfCab[NF_TIPONF]$"D|B")
				cHistSBZ :=  (cAlsItem)->D2_IDSBZ 
		Else
				cHistSBZ := (cAlsItem)->D1_IDSBZ 
		End 
		
		If Alltrim(SBZ->BZ_IDHIST) <> Alltrim(cHistSBZ)
			SS6->(dbSetOrder(1))				
			SS6->(MsSeek(xFilial("SS6")+cHistSBZ))
			lAchouSS6 := .T.
		EndIf								                                                                 
	EndIf

  If "PICM"    $ cCpoSBZ .And. aFieldPos[FP_BZ_PICM]    .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_PICM   ), !Empty(SBZ->BZ_PICM    )), .T. ) ; aNfItem[nItem][IT_PRD][SB_PICM]   := IIf(lAchouSS6, SS6->S6_PICM    , SBZ->BZ_PICM    );EndIf
  If "VLR_ICM" $ cCpoSBZ .And. aFieldPos[FP_BZ_VLR_ICM] .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_VLR_ICM), !Empty(SBZ->BZ_VLR_ICM )), .T. ) ; aNfItem[nItem][IT_PRD][SB_VLR_ICM]:= IIf(lAchouSS6, SS6->S6_VLR_ICM , SBZ->BZ_VLR_ICM );EndIf
  If "INT_ICM" $ cCpoSBZ .And. aFieldPos[FP_BZ_INT_ICM] .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_INT_ICM), !Empty(SBZ->BZ_INT_ICM )), .T. ) ; aNfItem[nItem][IT_PRD][SB_INT_ICM]:= IIf(lAchouSS6, SS6->S6_INT_ICM , SBZ->BZ_INT_ICM );EndIf
  If "PICMRET" $ cCpoSBZ .And. aFieldPos[FP_BZ_PICMRET] .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_PICMRET), !Empty(SBZ->BZ_PICMRET )), .T. ) ; aNfItem[nItem][IT_PRD][SB_PICMRET]:= IIf(lAchouSS6, SS6->S6_PICMRET , SBZ->BZ_PICMRET );EndIf
  If "PICMENT" $ cCpoSBZ .And. aFieldPos[FP_BZ_PICMENT] .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_PICMENT), !Empty(SBZ->BZ_PICMENT )), .T. ) ; aNfItem[nItem][IT_PRD][SB_PICMENT]:= IIf(lAchouSS6, SS6->S6_PICMENT , SBZ->BZ_PICMENT );EndIf
  If "IPI"     $ cCpoSBZ .And. aFieldPos[FP_BZ_IPI]     .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_IPI    ), !Empty(SBZ->BZ_IPI     )), .T. ) ; aNfItem[nItem][IT_PRD][SB_IPI]    := IIf(lAchouSS6, SS6->S6_IPI     , SBZ->BZ_IPI     );EndIf
  If "VLR_IPI" $ cCpoSBZ .And. aFieldPos[FP_BZ_VLR_IPI] .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_VLR_IPI), !Empty(SBZ->BZ_VLR_IPI )), .T. ) ; aNfItem[nItem][IT_PRD][SB_VLR_IPI]:= IIf(lAchouSS6, SS6->S6_VLR_IPI , SBZ->BZ_VLR_IPI );EndIf
  If "REDPIS"  $ cCpoSBZ .And. aFieldPos[FP_BZ_REDPIS]  .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_REDPIS ), !Empty(SBZ->BZ_REDPIS  )), .T. ) ; aNfItem[nItem][IT_PRD][SB_REDPIS] := IIf(lAchouSS6, SS6->S6_REDPIS  , SBZ->BZ_REDPIS  );EndIf
  If "REDCOF"  $ cCpoSBZ .And. aFieldPos[FP_BZ_REDCOF]  .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_REDCOF ), !Empty(SBZ->BZ_REDCOF  )), .T. ) ; aNfItem[nItem][IT_PRD][SB_REDCOF] := IIf(lAchouSS6, SS6->S6_REDCOF  , SBZ->BZ_REDCOF  );EndIf
  If "IRRF"    $ cCpoSBZ .And. aFieldPos[FP_BZ_IRRF]    .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_IRRF   ), !Empty(SBZ->BZ_IRRF    )), .T. ) ; aNfItem[nItem][IT_PRD][SB_IRRF]   := IIf(lAchouSS6, SS6->S6_IRRF    , SBZ->BZ_IRRF    );EndIf
  If "ORIGEM"  $ cCpoSBZ .And. aFieldPos[FP_BZ_ORIGEM]  .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_ORIGEM ), !Empty(SBZ->BZ_ORIGEM  )), .T. ) ; aNfItem[nItem][IT_PRD][SB_ORIGEM] := IIf(lAchouSS6, SS6->S6_ORIGEM  , SBZ->BZ_ORIGEM  );EndIf
  If "GRTRIB"  $ cCpoSBZ .And. aFieldPos[FP_BZ_GRTRIB]  .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_GRTRIB ), !Empty(SBZ->BZ_GRTRIB  )), .T. ) ; aNfItem[nItem][IT_PRD][SB_GRTRIB] := IIf(lAchouSS6, SS6->S6_GRTRIB  , SBZ->BZ_GRTRIB  );EndIf
  If "CODISS"  $ cCpoSBZ .And. aFieldPos[FP_BZ_CODISS]  .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_CODISS ), !Empty(SBZ->BZ_CODISS  )), .T. ) ; aNfItem[nItem][IT_PRD][SB_CODISS] := IIf(lAchouSS6, SS6->S6_CODISS  , SBZ->BZ_CODISS  );EndIf
  If "FECP"    $ cCpoSBZ .And. aFieldPos[FP_BZ_FECP]    .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_FECP   ), !Empty(SBZ->BZ_FECP    )), .T. ) ; aNfItem[nItem][IT_PRD][SB_FECP]   := IIf(lAchouSS6, SS6->S6_FECP    , SBZ->BZ_FECP    );EndIf
  If "ALIQISS" $ cCpoSBZ .And. aFieldPos[FP_BZ_ALIQISS] .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_ALIQISS), !Empty(SBZ->BZ_ALIQISS )), .T. ) ; aNfItem[nItem][IT_PRD][SB_ALIQISS]:= IIf(lAchouSS6, SS6->S6_ALIQISS , SBZ->BZ_ALIQISS );EndIf
  If "PIS"     $ cCpoSBZ .And. aFieldPos[FP_BZ_PIS]     .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_PIS    ), !Empty(SBZ->BZ_PIS     )), .T. ) ; aNfItem[nItem][IT_PRD][SB_PIS]    := IIf(lAchouSS6, SS6->S6_PIS     , SBZ->BZ_PIS     );EndIf
  If "COFINS"  $ cCpoSBZ .And. aFieldPos[FP_BZ_COFINS]  .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_COFINS ), !Empty(SBZ->BZ_COFINS  )), .T. ) ; aNfItem[nItem][IT_PRD][SB_COFINS] := IIf(lAchouSS6, SS6->S6_COFINS  , SBZ->BZ_COFINS  );EndIf
  If "PCSLL"   $ cCpoSBZ .And. aFieldPos[FP_BZ_PCSLL]   .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_PCSLL  ), !Empty(SBZ->BZ_PCSLL   )), .T. ) ; aNfItem[nItem][IT_PRD][SB_PCSLL]  := IIf(lAchouSS6, SS6->S6_PCSLL   , SBZ->BZ_PCSLL   );EndIf
  If "ALFUMAC" $ cCpoSBZ .And. aFieldPos[FP_BZ_ALFUMAC] .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_ALFUMAC), !Empty(SBZ->BZ_ALFUMAC )), .T. ) ; aNfItem[nItem][IT_PRD][SB_ALFUMAC]:= IIf(lAchouSS6, SS6->S6_ALFUMAC , SBZ->BZ_ALFUMAC );EndIf
  If "FECPBA"  $ cCpoSBZ .And. aFieldPos[FP_BZ_FECPBA]  .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_FECPBA ), !Empty(SBZ->BZ_FECPBA  )), .T. ) ; aNfItem[nItem][IT_PRD][SB_FECPBA] := IIf(lAchouSS6, SS6->S6_FECPBA  , SBZ->BZ_FECPBA  );EndIf
  If "ALFECRN" $ cCpoSBZ .And. aFieldPos[FP_BZ_ALFECRN] .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_ALFECRN), !Empty(SBZ->BZ_ALFECRN )), .T. ) ; aNfItem[nItem][IT_PRD][SB_ALFECRN]:= IIf(lAchouSS6, SS6->S6_ALFECRN , SBZ->BZ_ALFECRN );EndIf
  If "CNAE"    $ cCpoSBZ .And. aFieldPos[FP_BZ_CNAE]    .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_CNAE   ), !Empty(SBZ->BZ_CNAE    )), .T. ) ; aNfItem[nItem][IT_PRD][SB_CNAE]   := IIf(lAchouSS6, SS6->S6_CNAE    , SBZ->BZ_CNAE    );EndIf
  If "CSLL"    $ cCpoSBZ .And. aFieldPos[FP_BZ_CSLL]    .And. IIf( lArqProp , IIf(lAchouSS6, !Empty(SS6->S6_CSLL   ), !Empty(SBZ->BZ_CSLL    )), .T. ) ; aNfItem[nItem][IT_PRD][SB_CSLL]   := IIf(lAchouSS6, SS6->S6_CSLL    , SBZ->BZ_CSLL    );EndIf

If !lSBI
	aNfItem[nItem][IT_IDSBZ] := IIf( aFieldPos[FP_BZ_IDHIST] .And. lSeek , IIf(lAchouSS6, SS6->S6_IDHIST, SBZ->BZ_IDHIST), "" )
Else
	aNfItem[nItem][IT_IDSBZ] := ""
EndIf
	
EndIf

aNfItem[nItem][IT_GRPTRIB] := aNfItem[nItem][IT_PRD][SB_GRTRIB]
aNfItem[nItem][IT_RSATIVO] := aNfItem[nItem][IT_PRD][SB_RSATIVO]
aNfItem[nItem][IT_POSIPI]  := aNfItem[nItem][IT_PRD][SB_POSIPI]
aNfItem[nItem][IT_B1UM]    := aNfItem[nItem][IT_PRD][SB_UM]
aNfItem[nItem][IT_B1SEGUM] := aNfItem[nItem][IT_PRD][SB_SEGUM]
aNfItem[nItem][IT_AFABOV]  := aNfItem[nItem][IT_PRD][SB_AFABOV]
aNfItem[nItem][IT_AFACS]   := aNfItem[nItem][IT_PRD][SB_AFACS]
aNfItem[nItem][IT_AFETHAB] := aNfItem[nItem][IT_PRD][SB_AFETHAB]
aNfItem[nItem][IT_TFETHAB] := aNfItem[nItem][IT_PRD][SB_TFETHAB]
aNfItem[nItem][IT_CPDIFST] := aNfItem[nItem][IT_PRD][SB_ALQDFB1]
aNfItem[nItem][IT_CPPERST] := aNfItem[nItem][IT_PRD][SB_B1PTST]
aNfItem[nItem][IT_CODIF]   := aNfItem[nItem][IT_PRD][SB_CODIF]
aNfItem[nItem][IT_IDSB1]   := aNfItem[nItem][IT_PRD][SB_IDHIST]

// ----------------------------------------------------
// Carga das referencias vinculadas a tabela UF x UF
// ----------------------------------------------------
//Alimento a referência com os dados do cabecalho primeiramente, caso não encontre na CFC ou SS9 
//já estará preenchida com informação do cabecalho
aNfItem[nItem][IT_UFXPROD][UFP_ALIQFECP]	:=	aNfCab[NF_UFXUF][UF_ALIQFECP]
aNfItem[nItem][IT_UFXPROD][UFP_MARGSTLIQ]	:=	aNfCab[NF_UFXUF][UF_MARGSTLIQ]
aNfItem[nItem][IT_UFXPROD][UFP_ALIQSTLIQ]	:=	aNfCab[NF_UFXUF][UF_ALIQSTLIQ]
aNfItem[nItem][IT_UFXPROD][UFP_MARGEM]		:=	aNfCab[NF_UFXUF][UF_MARGEM]
aNfItem[nItem][IT_UFXPROD][UFP_ALQFCPO]		:=	aNfCab[NF_UFXUF][UF_ALQFCPO]
aNfItem[nItem][IT_UFXPROD][UFP_FECPAUX]		:=	aNfCab[NF_UFXUF][UF_FECPAUX]
aNfItem[nItem][IT_UFXPROD][UFP_FECPDIF]		:=	aNfCab[NF_UFXUF][UF_FECPDIF]
aNfItem[nItem][IT_UFXPROD][UFP_FECPINT]		:=	aNfCab[NF_UFXUF][UF_FECPINT]
aNfItem[nItem][IT_UFXPROD][UFP_RDCTIMP]		:=  aNfCab[NF_UFXUF][UF_RDCTIMP]    

//Faz busca na CFC considerando a uf origem, uf destino e código do produto.
If aAliIndic[AI_CFC] .And. CFC->( MsSeek( xFilial( "CFC" ) + aNFCab[NF_UFORIGEM] + aNFCab[NF_UFDEST] + aNfItem[nItem][IT_PRD][SB_COD] ) )
	aNfItem[nItem][IT_UFXPROD][UFP_ALIQFECP]	:=	CFC->CFC_ALQFCP
	aNfItem[nItem][IT_UFXPROD][UFP_MARGSTLIQ]	:=	Iif( aFieldPos[FP_CFC_MGLQST] , CFC->CFC_MGLQST , 0   )
	aNfItem[nItem][IT_UFXPROD][UFP_ALIQSTLIQ]	:=	Iif( aFieldPos[FP_CFC_ALQSTL] , CFC->CFC_ALQSTL , 0   )
	aNfItem[nItem][IT_UFXPROD][UFP_MARGEM]		:=	Iif( aFieldPos[FP_CFC_MARGEM] , CFC->CFC_MARGEM , 0   )
	aNfItem[nItem][IT_UFXPROD][UFP_ALQFCPO]		:=	Iif( aFieldPos[FP_CFC_ALFCPO] , CFC->CFC_ALFCPO , 0   )
	aNfItem[nItem][IT_UFXPROD][UFP_FECPAUX]		:=	Iif( aFieldPos[FP_CFC_FCPAUX] , CFC->CFC_FCPAUX , 0   )
	aNfItem[nItem][IT_UFXPROD][UFP_FECPDIF]		:=	Iif( aFieldPos[FP_CFC_FCPXDA] , CFC->CFC_FCPXDA , '1' )
	aNfItem[nItem][IT_UFXPROD][UFP_FECPINT]		:=	Iif( aFieldPos[FP_CFC_FCPINT] , CFC->CFC_FCPINT , '1' )
	aNfItem[nItem][IT_UFXPROD][UFP_RDCTIMP]		:=	Iif( aFieldPos[FP_CFC_RDCTIM] , CFC->CFC_RDCTIM , 1 )
	aNfItem[nItem][IT_IDCFC]					:= 	CFC->CFC_IDHIST
EndIF

//Trecho para caso de reprocessamento, irá buscar na tabela espelho SS9 considerando id gravado na D1/D2.
If lHistorico .AND. !Empty(cAlsItem) .AND. aAliIndic[AI_CFC]
	If( aNfCab[NF_CLIFOR]=="C" .And. aNfCab[NF_TIPONF]<>"D") .Or.( aNfCab[NF_CLIFOR]=="F" .And. aNfCab[NF_TIPONF]$"D|B")
		cHistCFC :=  Iif( aFieldPos[FP_D2_IDCFC], (cAlsItem)->D2_IDCFC, "" )
	Else
		cHistCFC :=  Iif( aFieldPos[FP_D1_IDCFC], (cAlsItem)->D1_IDCFC,"" )
	EndiF	
	If !Empty(cHistCFC) .AND.  Alltrim(CFC->CFC_IDHIST)<>Alltrim(cHistCFC)
		SS9->(dbSetOrder(1))
		SS9->(MsSeek(xFilial("SS9")+cHistCFC))
		aNfItem[nItem][IT_UFXPROD][UFP_ALIQFECP]	:=	SS9->S9_ALQFCP
		aNfItem[nItem][IT_UFXPROD][UFP_MARGSTLIQ]	:=	Iif( aFieldPos[FP_S9_MGLQST] , SS9->S9_MGLQST , 0	)
		aNfItem[nItem][IT_UFXPROD][UFP_ALIQSTLIQ]	:=	Iif( aFieldPos[FP_S9_ALQSTL] , SS9->S9_ALQSTL , 0	)
		aNfItem[nItem][IT_UFXPROD][UFP_MARGEM]		:=	Iif( aFieldPos[FP_S9_MARGEM] , SS9->S9_MARGEM , 0	)
		aNfItem[nItem][IT_UFXPROD][UFP_ALQFCPO]		:=	Iif( aFieldPos[FP_S9_ALFCPO] , SS9->S9_ALFCPO , 0	)
		aNfItem[nItem][IT_UFXPROD][UFP_FECPAUX]		:=	Iif( aFieldPos[FP_S9_FCPAUX] , SS9->S9_FCPAUX , 0	)
		aNfItem[nItem][IT_UFXPROD][UFP_FECPDIF]		:=	Iif( aFieldPos[FP_S9_FCPXDA] , SS9->S9_FCPXDA , '1'	)
		aNfItem[nItem][IT_UFXPROD][UFP_FECPINT]		:=	Iif( aFieldPos[FP_S9_FCPINT] , SS9->S9_FCPINT , '1'	)
		aNfItem[nItem][IT_UFXPROD][UFP_RDCTIMP]	:=	Iif( aFieldPos[FP_S9_RDCTIM] , SS9->S9_RDCTIM , 1	)
		aNfItem[nItem][IT_IDCFC]					    := 	SS9->S9_IDHIST
	EndIf
EndIf

Return                    

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisRetLF³ Autor ³ Edson Maricate        ³ Data ³03.01.2000³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna um array com a estrutura inicial do aLivro.        ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisRetLF()
//       1  2  3  4  5   6  7  8  9  10 11 12 13 14  15  16  17 18 19  20  21 22  23  24  25 26 27 28 29 30  31  32  33  34 35          36 37 38 39 40 41  42 43  44  45  46  47  48  49 50  51  52  53 54  55 56 57 58 59 60 61 62  63 64 65 66 67 68 69  70  71 72 73 74  75 76 77 78 79 80  81 82  83 84 85 86 87 88, 89, 90, 91, 92 , 93, 94, 95, 96 
Return {"", 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,"", 0, 0, "", "", 0, "", 0, "", 0, 0, "", "", 0, 0, 0, 0, 0, 0, "", "", "", 0,{0,0,0,0,0},"",0, 0, 0, 0, 0, "","", "", "", "", "", "", 0, 0, "", "", 0, 0,  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, "", 0, 0, 0, 0 ,"","",0, 0, 0, 0 ,"", 0, 0, 0, 0, 0, 0, "", 0, 0, 0, 0 , 0 , "","","", "","","",CtoD(""),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0} 

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisScan ³ Autor ³Eduardo/Edson          ³ Data ³02.04.2002³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Func de procura da posicao da referencia nos arrays internos³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisScan(cCampo,lErro)

Local cPosCpo := 0
Local nScan   := 0

DEFAULT lErro := .T.

If aItemRef == Nil
	MaIniRef()
EndIf

If Substr(cCampo,1,2) == "IT"
	nScan	:= aScan(aItemRef,{|x|x[1]==cCampo})
	If nScan > 0
		cPosCpo	:= aItemRef[nScan][2]
	Else
		If lErro
			MsgAlert(STR0001 + cCampo ) //"ERRO MATXFIS - Referencia de imposto invalida : "
			MsgAlert(STR0029+STR0030+CHR(13)+CHR(10)+CHR(13)+CHR(10)+ STR0031)
			Final(STR0002) //"ERRO MATXFIS - Referencia de imposto invalida "
		EndIf
	EndIf
ElseIf Substr(cCampo,1,2) == "NF"
	nScan	:= aScan(aCabRef,{|x|x[1]==cCampo})
	If nScan > 0
		cPosCpo	:= aCabRef[nScan][2]
	Else
		If lErro
			MsgAlert(STR0001 + cCampo ) //"ERRO MATXFIS - Referencia de imposto invalida : "
			MsgAlert(STR0029+STR0030+CHR(13)+CHR(10)+CHR(13)+CHR(10)+ STR0031)
			Final(STR0002) //"ERRO MATXFIS - Referencia de imposto invalida "
		EndIf
	EndIf
ElseIf Substr(cCampo,1,2) == "LF"
	nScan	:= aScan(aLFis,{|x|x[1]==cCampo})
	If nScan > 0
		cPosCpo	:= aLFis[nScan][2]
	Else
		If lErro
			MsgAlert(STR0001 + cCampo ) //"ERRO MATXFIS - Referencia de imposto invalida : "
			MsgAlert(STR0029+STR0030+CHR(13)+CHR(10)+CHR(13)+CHR(10)+ STR0031)
			Final(STR0002) //"ERRO MATXFIS - Referencia de imposto invalida "
		EndIf
	EndIf
ElseIf Substr(cCampo,1,3) == "IMP"
	nScan 	:= aScan(aResRef,{|x|x[1]==cCampo})
	If nScan > 0
		cPosCpo	:= aResRef[nScan][2]
	Else
		If lErro
			MsgAlert(STR0001 + cCampo ) //"ERRO MATXFIS - Referencia de imposto invalida : "
			MsgAlert(STR0029+STR0030+CHR(13)+CHR(10)+CHR(13)+CHR(10)+ STR0031)
			Final(STR0002) //"ERRO MATXFIS - Referencia de imposto invalida "
		EndIf
	EndIf
EndIf

Return(cPosCpo)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡„o    ³MaFisGetRf³ Autor ³ Eduardo Riera         ³ Data ³08.08.2001 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³Rotina de avalicao das referencias existentes em uma         ³±±
±±³          ³expressao string.                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Expressao contendo as referencias.                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpA1: Array com a seguinte estrutura                        ³±±
±±³          ³       [1] Codigo da Referencia                              ³±±
±±³          ³       [2] Nome do programa vinculado a referencia           ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo verificar e retornar as referen³±±
±±³          ³cias da funcao fiscal com base numa expressao string.        ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisGetRF(cValid)

Local nPRefer := 0
Local cRefer  := ""
Local cProg   := ""

cValid	:= Upper(StrTran(cValid," ",""))

Do Case
Case ( "MAFISREF"$cValid )
	nPRefer := AT('MAFISREF("',cValid) + 10
	cValid  := SubStr(cValid,nPRefer)
	cRefer  := SubStr(cValid,1,AT(',',cValid)-2)
	cValid  := SubStr(cValid,AT(',',cValid)+1)
	cProg   := SubStr(cValid,2,AT(',',cValid)-3)
Case ( "MAFISGET"$cValid )
	nPRefer := AT('MAFISGET("',cValid) + 10
	cValid  := SubStr(cValid,nPRefer)
	cRefer  := SubStr(cValid,1,AT(')',cValid)-2)
EndCase

Return({cRefer,cProg})

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡…o    ³MaIniRef³ Autor ³ Edson Maricate          ³ Data ³ 10.12.99 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Inicializa as variaveis utilizadas no Retorno Fiscal       ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaIniRef()

Local nG
Local lArredBra	:= (cPaisLoc == "BRA")
Local lCritArr	:= (cPaisLoc == "BRA")
Local lArredChi	:= (cPaisLoc <> "CHI")
Local lArredMex	:= (cPaisLoc == "MEX")
Local lArredPtg	:= (cPaisLoc == "PTG")
Local lArredArg	:= (cPaisLoc == "ARG")
Local lCritPer	:= (cPaisLoc == "PER")

aItemRef	:= {}
aCabRef		:= {}
aLFIs		:= {}
aResRef		:= {}

aadd(aCabRef,{"NF_TIPONF","1",.F.})
aadd(aCabRef,{"NF_OPERNF","2",.F.})
aadd(aCabRef,{"NF_CLIFOR","3",.F.})
aadd(aCabRef,{"NF_TPCLIFOR","4",.F.})
aadd(aCabRef,{"NF_LINSCR","5",.F.})
aadd(aCabRef,{"NF_GRPCLI","6",.F.})
aadd(aCabRef,{"NF_UFDEST","7",.F.})
aadd(aCabRef,{"NF_UFORIGEM","8",.F.})
aadd(aCabRef,{"NF_DESCONTO","10",.T.})
aadd(aCabRef,{"NF_FRETE","11",.T.})
aadd(aCabRef,{"NF_DESPESA","12",.T.})
aadd(aCabRef,{"NF_SEGURO","13",.T.})
aadd(aCabRef,{"NF_AUTONOMO","14",.T.})
aadd(aCabRef,{"NF_ICMS","15",.F.})
aadd(aCabRef,{"NF_BASEICM",{15,1},.T.})
aadd(aCabRef,{"NF_VALICM",{15,2},.T.})
aadd(aCabRef,{"NF_BASESOL",{15,3},.T.})
aadd(aCabRef,{"NF_VALSOL",{15,4},.T.})
aadd(aCabRef,{"NF_BICMORI",{15,5},.T.})
aadd(aCabRef,{"NF_VALCMP",{15,6},.T.})
aadd(aCabRef,{"NF_BASEICA",{15,7},.T.})
aadd(aCabRef,{"NF_VALICA",{15,8},.T.})
aadd(aCabRef,{"NF_RECFAUT",{15,9},.T.})
aadd(aCabRef,{"NF_IPI","16",.F.})
aadd(aCabRef,{"NF_BASEIPI",{16,1},.T.})
aadd(aCabRef,{"NF_VALIPI",{16,2},.T.})
aadd(aCabRef,{"NF_BIPIORI",{16,3},.T.})
aadd(aCabRef,{"NF_TOTAL","17",.T.})
aadd(aCabRef,{"NF_VALMERC","18",.T.})
aadd(aCabRef,{"NF_FUNRURAL","19",.T.})
aadd(aCabRef,{"NF_CODCLIFOR","20",.F.})
aadd(aCabRef,{"NF_LOJA","21",.F.})
aadd(aCabRef,{"NF_LIVRO","22",.F.})
aadd(aCabRef,{"NF_ISS","23",.F.})
aadd(aCabRef,{"NF_BASEISS",{23,1},.T.})
aadd(aCabRef,{"NF_VALISS",{23,2},.T.})
aadd(aCabRef,{"NF_DESCISS",{23,3},.T.})
aadd(aCabRef,{"NF_IR","24",.F.})
aadd(aCabRef,{"NF_BASEIRR",{24,1},.T.})
aadd(aCabRef,{"NF_VALIRR",{24,2},.T.})
aadd(aCabRef,{"NF_INSS","25",.F.})
aadd(aCabRef,{"NF_BASEINS",{25,1},.T.})
aadd(aCabRef,{"NF_VALINS",{25,2},.T.})
aadd(aCabRef,{"NF_NATUREZA","26",.F.})
aadd(aCabRef,{"NF_VALEMB","27",.T.})
aadd(aCabRef,{"NF_IMPOSTOS","30",.T.})
aadd(aCabRef,{"NF_BASEDUP","31",.T.})
aadd(aCabRef,{"NF_RELIMP","32",.F.})
aadd(aCabRef,{"NF_IMPOSTOS2","33",.T.})
aadd(aCabRef,{"NF_DESCZF","34",.T.})
aadd(aCabRef,{"NF_SUFRAMA","35",.T.})
aadd(aCabRef,{"NF_BASEIMP","36",.F.})
For nG := 1 To NMAXIV
	aadd(aCabRef,{"NF_BASEIV"+NumCpoImpVar(nG),{36,nG},.T.})
Next nG
aadd(aCabRef,{"NF_VALIMP","37",.F.})
For nG := 1 To NMAXIV
	aadd(aCabRef,{"NF_VALIV"+NumCpoImpVar(nG),{37,nG},.T.})
Next nG
aadd(aCabRef,{"NF_TPCOMP","38",.F.})
aadd(aCabRef,{"NF_INSIMP","39",.F.})
aadd(aCabRef,{"NF_PESO","40",.T.})
aadd(aCabRef,{"NF_ICMFRETE","41",.T.})
aadd(aCabRef,{"NF_BSFRETE","42",.T.})
aadd(aCabRef,{"NF_BASECOF","43",.T.})
aadd(aCabRef,{"NF_VALCOF","44",.T.})
aadd(aCabRef,{"NF_BASECSL","45",.T.})
aadd(aCabRef,{"NF_VALCSL","46",.T.})
aadd(aCabRef,{"NF_BASEPIS","47",.T.})
aadd(aCabRef,{"NF_VALPIS","48",.T.})
aadd(aCabRef,{"NF_AUXACUM","50",.T.})
aadd(aCabRef,{"NF_ALIQIR","51",.T.})
aadd(aCabRef,{"NF_VNAGREG","52",.T.})
aadd(aCabRef,{"NF_RECISS","56"})
aadd(aCabRef,{"NF_MOEDA","58",.T.})
aadd(aCabRef,{"NF_TXMOEDA","59",.F.})
aadd(aCabRef,{"NF_SERIENF","60",.F.})
aadd(aCabRef,{"NF_TIPODOC","61",.F.})
aadd(aCabRef,{"NF_MINIMP","62",.F.})
For nG := 1 To NMAXIV
	aadd(aCabRef,{"NF_MINIV"+NumCpoImpVar(nG),{62,nG},.T.})
Next
aadd(aCabRef,{"NF_BASEPS2","63",.T.})
aadd(aCabRef,{"NF_VALPS2","64",.T.})
aadd(aCabRef,{"NF_ESPECIE","65",.F.})
aadd(aCabRef,{"NF_CNPJ","66",.F.})
aadd(aCabRef,{"NF_BASECF2","67",.T.})
aadd(aCabRef,{"NF_VALCF2","68",.T.})
aadd(aCabRef,{"NF_ICMSDIF","69",.T.})
aadd(aCabRef,{"NF_MODIRF","70",.T.})
aadd(aCabRef,{"NF_PNF_COD",{71,01},.T.})
aadd(aCabRef,{"NF_PNF_LOJ",{71,02},.T.})
aadd(aCabRef,{"NF_PNF_UF" ,{71,03},.T.})
aadd(aCabRef,{"NF_PNF_TPCLIFOR",{71,04},.T.})
aadd(aCabRef,{"NF_BASEAFRMM","73",.T.})
aadd(aCabRef,{"NF_VALAFRMM","74",.T.})
aadd(aCabRef,{"NF_PIS252","75",.T.})
aadd(aCabRef,{"NF_COF252","76",.T.})
aadd(aCabRef,{"NF_BASESES",{78,1},.T.})
aadd(aCabRef,{"NF_VALSES",{78,2},.T.})
aadd(aCabRef,{"NF_RECSEST","79",.T.})
aadd(aCabRef,{"NF_BASEPS3","80",.T.})
aadd(aCabRef,{"NF_VALPS3","81",.T.})
aadd(aCabRef,{"NF_BASECF3","82",.T.})
aadd(aCabRef,{"NF_VALCF3","83",.T.})
aadd(aCabRef,{"NF_VLR_FRT","84",.T.})
aadd(aCabRef,{"NF_VALFET","85",.T.})
aadd(aCabRef,{"NF_RECFET","86",.T.})
aadd(aCabRef,{"NF_CLIENT","87",.F.})
aadd(aCabRef,{"NF_LOJENT","88",.F.})
aadd(aCabRef,{"NF_VALFDS","89",.T.})
aadd(aCabRef,{"NF_ESTCRED","90",.T.})
aadd(aCabRef,{"NF_SIMPNAC","91",.T.})
aadd(aCabRef,{"NF_TRANSUF",{92,01},.T.})
aadd(aCabRef,{"NF_TRANSIN",{92,01},.T.})
aadd(aCabRef,{"NF_BASETST","93",.T.})
aadd(aCabRef,{"NF_VALTST","94",.T.})
aadd(aCabRef,{"NF_CRPRSIM","95",.T.})
aadd(aCabRef,{"NF_VALANTI","96",.T.})
aadd(aCabRef,{"NF_DESNTRB","97",.T.})
aadd(aCabRef,{"NF_TARA","98",.T.})
aadd(aCabRef,{"NF_NUMDEP","99",.T.})
aadd(aCabRef,{"NF_PROVENT","100",.T.})
aadd(aCabRef,{"NF_VALFECP","101",.T.})
aadd(aCabRef,{"NF_VFECPST","102",.T.})
aadd(aCabRef,{"NF_CRDPRES","103",.T.})
aadd(aCabRef,{"NF_IRPROG","104",.T.})
aadd(aCabRef,{"NF_VALII","105",.T.})
aadd(aCabRef,{"NF_RECIV","106",lCritPer})
aadd(aCabRef,{"NF_CRPREPE","107",.T.})
aadd(aCabRef,{"NF_VLRORIG","108",.T.})
aadd(aCabRef,{"NF_VALFAB","109",.T.})
aadd(aCabRef,{"NF_RECFAB","110",.T.})
aadd(aCabRef,{"NF_VALFAC","111",.T.})
aadd(aCabRef,{"NF_RECFAC","112",.T.})
aadd(aCabRef,{"NF_LJCIPI","113",.T.})
aadd(aCabRef,{"NF_VALFUM","114",.T.})
For nG := 1 To NMAXIV
	aadd(aCabRef,{"NF_VLRORI"+NumCpoImpVar(nG),{108,nG},.T.})
Next nG
aadd(aCabRef,{"NF_VLSENAR","115",.T.})
aadd(aCabRef,{"NF_CROUTSP","116",.T.})
aadd(aCabRef,{"NF_BSSEMDS","117",,.T.})
aadd(aCabRef,{"NF_ICSEMDS","118",,.T.})
aadd(aCabRef,{"NF_DS43080","119",,.T.})
aadd(aCabRef,{"NF_VL43080","120",,.T.})
aadd(aCabRef,{"NF_BASEFUN","121",.T.})
aadd(aCabRef,{"NF_PEDIDO","122",.T.})
aadd(aCabRef,{"NF_CODMUN","123",.T.})
aadd(aCabRef,{"NF_VALTPDP","124,01",.T.})
aadd(aCabRef,{"NF_BASTPDP","124,02",.T.})
aadd(aCabRef,{"NF_VLINCMG","125",.T.})
aadd(aCabRef,{"NF_BASEINA","126",.T.})
aadd(aCabRef,{"NF_VALINA","127",.T.})
aadd(aCabRef,{"NF_VFECPRN","128",.T.})
aadd(aCabRef,{"NF_VFESTRN","129",.T.})
aadd(aCabRef,{"NF_CREDPRE","130",.T.})
aadd(aCabRef,{"NF_VFECPMG","131",.T.})
aadd(aCabRef,{"NF_VFESTMG","132",.T.})
aadd(aCabRef,{"NF_VREINT","133",.T.})
aadd(aCabRef,{"NF_BSREIN","134",.T.})
aadd(aCabRef,{"NF_VFECPMT","135",.T.})
aadd(aCabRef,{"NF_VFESTMT","136",.T.})
aadd(aCabRef,{"NF_CLIEFAT",{144,01},.T.})
aadd(aCabRef,{"NF_LOJCFAT",{144,02},.T.})
aadd(aCabRef,{"NF_TIPOFAT",{144,03},.T.})
aadd(aCabRef,{"NF_GRPFAT" ,{144,04},.T.})
aadd(aCabRef,{"NF_NATUFAT",{144,05},.T.})
aadd(aCabRef,{"NF_ISSABMT","145",.T.})
aadd(aCabRef,{"NF_ISSABSR","146",.T.})
aadd(aCabRef,{"NF_INSABMT","147",.T.})
aadd(aCabRef,{"NF_INSABSR","148",.T.})
aadd(aCabRef,{"NF_ADIANT","149",.T.})
aadd(aCabRef,{"NF_VTOTPED","150",.T.})
aadd(aCabRef,{"NF_DTEMISS","151",.T.})
aadd(aCabRef,{"NF_IDSA1","152",.T.})
aadd(aCabRef,{"NF_IDSA2","153",.T.})
aadd(aCabRef,{"NF_IDSED","154",.T.}) 
aadd(aCabRef,{"NF_DESCTOT","155",.T.}) 		//155 - Valor Desc. dado no TOTAL (LOJA)        
aadd(aCabRef,{"NF_ACRESCI","156",.T.}) 	    //156 - Valor Acrescimo dado no TOTAL (LOJA) 
aadd(aCabRef,{"NF_UFPREISS","159",.T.}) 
aadd(aCabRef,{"NF_VALCIDE","161",.T.})  
aadd(aCabRef,{"NF_RECCIDE","162",.T.})
aadd(aCabRef,{"NF_VALFETR","163",.T.}) 
aadd(aCabRef,{"NF_MODAL","164",.T.})   
If cPaisLoc == "PER" .and. SF1->(FieldPos("F1_ADIANT")) > 0 
	aadd(aCabRef,{"NF_ADIANTTOT","167",.T.}) 
EndIf

aadd(aItemRef,{"IT_GRPTRIB","1",15,.F.,.F.})
aadd(aItemRef,{"IT_EXCECAO","2",,.F.,.F.})
aadd(aItemRef,{"IT_ALIQICM","3",40,.F.,.F.})
aadd(aItemRef,{"IT_ICMS","4",,.F.,.F.})
aadd(aItemRef,{"IT_BASEICM",{4,1},70,lArredBra, aParSX6[MV_RNDICM] })
aadd(aItemRef,{"IT_VALICM",{4,2},80,lArredBra,aParSX6[MV_RNDICM]})
aadd(aItemRef,{"IT_BASESOL",{4,3},100,lArredBra,aParSX6[MV_RNDICM]})
aadd(aItemRef,{"IT_ALIQSOL",{4,4},40,.F.,.F.})
aadd(aItemRef,{"IT_VALSOL",{4,5},110,lArredBra,aParSX6[MV_RNDICM]})
aadd(aItemRef,{"IT_MARGEM",{4,6},90,.F.,.F.})
aadd(aItemRef,{"IT_BICMORI",{4,7},,lArredBra,lCritArr})
aadd(aItemRef,{"IT_ALIQCMP",{4,8},40,.F.,.F.})
aadd(aItemRef,{"IT_VALCMP",{4,9},80,lArredBra,aParSX6[MV_RNDICM]})
aadd(aItemRef,{"IT_BASEICA",{4,10},71,lArredBra,lCritArr})
aadd(aItemRef,{"IT_VALICA",{4,11},81,lArredBra,lCritArr})
aadd(aItemRef,{"IT_DEDICM",{4,12},80,lArredBra,lCritArr})
aadd(aItemRef,{"IT_VLCSOL" ,{4,13},100,lArredBra,aParSX6[MV_RNDICM]})
aadd(aItemRef,{"IT_PREDIC",{4,16},90,.F.,.F.})
aadd(aItemRef,{"IT_ALIQIPI","5",40,.F.,.F.})
aadd(aItemRef,{"IT_IPI","6",,.F.,lCritArr})
aadd(aItemRef,{"IT_BASEIPI",{6,1},50,lArredBra,lCritArr})
aadd(aItemRef,{"IT_VALIPI",{6,2},60,lArredBra,aParSX6[MV_RNDIPI] })
aadd(aItemRef,{"IT_BIPIORI",{6,3},,lArredBra,lCritArr})
aadd(aItemRef,{"IT_NFORI","7",20,.F.,.F.})
aadd(aItemRef,{"IT_SERORI","8",20,.F.,.F.})
aadd(aItemRef,{"IT_RECORI","9",20,.F.,.F.})
aadd(aItemRef,{"IT_DESCONTO","10",20,.T., aParSX6[MV_RNDDES] })
aadd(aItemRef,{"IT_FRETE","11",20,.T.,lCritArr})
aadd(aItemRef,{"IT_DESPESA","12",20,.T.,lCritArr})
aadd(aItemRef,{"IT_SEGURO","13",20,.T.,lCritArr})
aadd(aItemRef,{"IT_AUTONOMO","14",20,.T.,lCritArr})
aadd(aItemRef,{"IT_VALMERC","15",,lArredChi,lCritArr})
aadd(aItemRef,{"IT_PRODUTO","16",10,.F.,.F.})
aadd(aItemRef,{"IT_TES","17",20,.F.,.F.})
aadd(aItemRef,{"IT_TOTAL","18",,lArredChi,lCritArr})
aadd(aItemRef,{"IT_CF","19",30,.F.,.F.})
aadd(aItemRef,{"IT_FUNRURAL","20",,lArredBra, aParSX6[MV_RNDFUN] })
aadd(aItemRef,{"IT_PERFUN","21",,.F.,.F.})
aadd(aItemRef,{"IT_DELETED","22",,.F.,.F.})
aadd(aItemRef,{"IT_LIVRO","23",,.F.,.F.})
aadd(aItemRef,{"IT_ISS","24",,.F.,.F.})
aadd(aItemRef,{"IT_ALIQISS",{24,1},40,.F.,.F.})
aadd(aItemRef,{"IT_BASEISS",{24,2},,lArredBra,lCritArr})
aadd(aItemRef,{"IT_VALISS",{24,3},,.T., aParSX6[MV_RNDISS] })
aadd(aItemRef,{"IT_CODISS",{24,4},,.F.,.F.})
aadd(aItemRef,{"IT_CFPS",{24,7},,.F.,.F.})
aadd(aItemRef,{"IT_PREDISS",{24,8},,.F.,.F.})
aadd(aItemRef,{"IT_VALISORI",{24,9},,.F.,.F.})
aadd(aItemRef,{"IT_ALISSOR",{24,10},,.F.,.F.})
aadd(aItemRef,{"IT_IR","25",,.F.,.F.})
aadd(aItemRef,{"IT_BASEIRR",{25,1},,.T.,lCritArr})
aadd(aItemRef,{"IT_REDIR",{25,2},,.F.,.F.})
aadd(aItemRef,{"IT_ALIQIRR",{25,3},40,.F.,.F.})
aadd(aItemRef,{"IT_VALIRR",{25,4},,lArredBra, aParSX6[MV_RNDIRF] })
aadd(aItemRef,{"IT_INSS","26",,.F.,.F.})
aadd(aItemRef,{"IT_BASEINS",{26,1},,lArredBra,lCritArr})
aadd(aItemRef,{"IT_REDINSS",{26,2},,.F.,.F.})
aadd(aItemRef,{"IT_ALIQINS",{26,3},,.F.,.F.})
aadd(aItemRef,{"IT_VALINS",{26,4},,lArredBra, aParSX6[MV_RNDINS] })
aadd(aItemRef,{"IT_VALEMB","27",,.T.,lCritArr})
aadd(aItemRef,{"IT_BASEIMP","28",,.F.,lCritArr})
For nG := 1 To NMAXIV
	aadd(aItemRef,{"IT_BASEIV"+NumCpoImpVar(nG),{28,nG},,lArredBra,lCritArr})
Next nG
aadd(aItemRef,{"IT_ALIQIMP","29",,.F.,.F.})
For nG := 1 To NMAXIV
	aadd(aItemRef,{"IT_ALIQIV"+NumCpoImpVar(nG),{29,nG},,.F.,.F.})
Next nG
aadd(aItemRef,{"IT_VALIMP","30",,.F.,.F.})
For nG := 1 To NMAXIV
	aadd(aItemRef,{"IT_VALIV"+NumCpoImpVar(nG),{30,nG},,(lArredMex .Or. lArredPtg .Or. lArredArg),lCritArr})
Next nG
aadd(aItemRef,{"IT_BASEDUP","31",,lArredChi,lCritArr})
aadd(aItemRef,{"IT_DESCZF","32",,lArredBra,lCritArr})
aadd(aItemRef,{"IT_DESCIV","33",,.F.,.F.})
aadd(aItemRef,{"IT_QUANT","34",,.F.,.F.})
aadd(aItemRef,{"IT_PRCUNI","35",,.F.,lCritArr})
aadd(aItemRef,{"IT_VIPIBICM","36",,lArredBra,lCritArr})
aadd(aItemRef,{"IT_PESO","37",,.F.,.F.})
aadd(aItemRef,{"IT_ICMFRETE","38",82,lArredBra,lCritArr})
aadd(aItemRef,{"IT_BSFRETE","39",72,lArredBra,lCritArr})
aadd(aItemRef,{"IT_BASECOF","40",,lArredBra,lCritArr})
aadd(aItemRef,{"IT_ALIQCOF","41",40, IIf( aParSX6[MV_DECALIQ] , .F. , lArredBra ) , .F. })
aadd(aItemRef,{"IT_VALCOF","42",,lArredBra, aParSX6[MV_RNDCOF] })
aadd(aItemRef,{"IT_BASECSL","43",,lArredBra,lCritArr})
aadd(aItemRef,{"IT_ALIQCSL","44",40,lArredBra,.F.})
aadd(aItemRef,{"IT_VALCSL","45",,lArredBra, aParSX6[MV_RNDCSL] })
aadd(aItemRef,{"IT_BASEPIS","46",,lArredBra,lCritArr})
aadd(aItemRef,{"IT_ALIQPIS","47",40, IIf( aParSX6[MV_DECALIQ] , .F. , lArredBra ) , .F. })
aadd(aItemRef,{"IT_VALPIS","48",,lArredBra, aParSX6[MV_RNDPIS] })
aadd(aItemRef,{"IT_RECNOSB1","49",,.T.,.F.})
aadd(aItemRef,{"IT_RECNOSF4","50",,.T.,.F.})
aadd(aItemRef,{"IT_VNAGREG","51",,.T.,lCritArr})
aadd(aItemRef,{"IT_REMITO","53",,.F.,.F.})
aadd(aItemRef,{"IT_BASEPS2","54",,lArredBra,lCritArr})
aadd(aItemRef,{"IT_ALIQPS2","55",40, IIf( aParSX6[MV_DECALIQ] , .F. , lArredBra ) , .F. })
aadd(aItemRef,{"IT_VALPS2","56",,.T., aParSX6[MV_RNDPS2] })
aadd(aItemRef,{"IT_BASECF2","57",,lArredBra,lCritArr})
aadd(aItemRef,{"IT_ALIQCF2","58",40, IIf( aParSX6[MV_DECALIQ] , .F. , lArredBra ) , .F.})
aadd(aItemRef,{"IT_VALCF2","59",,.T., aParSX6[MV_RNDCF2] })
aadd(aItemRef,{"IT_ABVLINSS","60",,.F.,lCritArr})
aadd(aItemRef,{"IT_ABVLISS","61",,.F.,lCritArr})
aadd(aItemRef,{"IT_REDISS","62",,.F.,.F.})
aadd(aItemRef,{"IT_ICMSDIF","63",,lArredBra,aParSX6[MV_RNDICM]})
aadd(aItemRef,{"IT_DESCZFPIS","64",,.T., aParSX6[MV_RNDPS2] })
aadd(aItemRef,{"IT_DESCZFCOF","65",,.T.,aParSX6[MV_RNDCF2] })
aadd(aItemRef,{"IT_BASEAFRMM","66",,lArredBra,lCritArr})
aadd(aItemRef,{"IT_ALIQAFRMM","67",,lArredBra,.F.})
aadd(aItemRef,{"IT_VALAFRMM","68",,lArredBra,lCritArr})
aadd(aItemRef,{"IT_PIS252","69",,.F.,lCritArr})
aadd(aItemRef,{"IT_COF252","70",,.F.,lCritArr})
aadd(aItemRef,{"IT_CRDZFM","71",,.F.,lCritArr})
aadd(aItemRef,{"IT_CNAE","72",,.F.,.F.})
aadd(aItemRef,{"IT_ITEM","73",,.F.,.F.})
aadd(aItemRef,{"IT_SEST","74",,.F.,.F.})
aadd(aItemRef,{"IT_BASESES",{74,1},,lArredBra,lCritArr})
aadd(aItemRef,{"IT_ALIQSES",{74,2},,.F.,.F.})
aadd(aItemRef,{"IT_VALSES",{74,3},,lArredBra,lCritArr})
aadd(aItemRef,{"IT_BASEPS3","75",,lArredBra,lCritArr})
aadd(aItemRef,{"IT_ALIQPS3","76",40,lArredBra,.F.})
aadd(aItemRef,{"IT_VALPS3","77",,.T., aParSX6[MV_RNDPS3] })
aadd(aItemRef,{"IT_BASECF3","78",,lArredBra,lCritArr})
aadd(aItemRef,{"IT_ALIQCF3","79",40,lArredBra,.F.})
aadd(aItemRef,{"IT_VALCF3","80",,.T., aParSX6[MV_RNDCF3]  })
aadd(aItemRef,{"IT_VLR_FRT","81",,.T.,lCritArr})
aadd(aItemRef,{"IT_BASEFET","82",,.T.,lCritArr})
aadd(aItemRef,{"IT_ALIQFET","83",,.T.,.F.})
aadd(aItemRef,{"IT_VALFET","84",,.T.,lCritArr})
aadd(aItemRef,{"IT_ABSCINS","85",,.F.,lCritArr})
aadd(aItemRef,{"IT_ABMATISS","87",,.F.,lCritArr})
aadd(aItemRef,{"IT_RGESPST","88",,.F.,.F.})
aadd(aItemRef,{"IT_PRFDSUL","89",,.F.,lCritArr})
aadd(aItemRef,{"IT_UFERMS","90",,.F.,lCritArr})
aadd(aItemRef,{"IT_VALFDS","91",,.F.,lCritArr})
aadd(aItemRef,{"IT_ESTCRED","92",,.F.,lCritArr})
aadd(aItemRef,{"IT_CODIF","93",,.F.,lCritArr})
aadd(aItemRef,{"IT_BASETST","94",,.F.,lCritArr})
aadd(aItemRef,{"IT_ALIQTST","95",,.F.,lCritArr})
aadd(aItemRef,{"IT_VALTST","96",,.F.,lCritArr})
aadd(aItemRef,{"IT_CRPRSIM","97",,.F.,lCritArr})
aadd(aItemRef,{"IT_VALANTI","98",,.F.,lCritArr})
aadd(aItemRef,{"IT_DESNTRB","99",,.F.,lCritArr})
aadd(aItemRef,{"IT_TARA","100",,.F.,lCritArr})
aadd(aItemRef,{"IT_PROVENT","101",,.F.,lCritArr})
aadd(aItemRef,{"IT_VALFECP","102",80,lArredBra,aParSX6[MV_RNDICM]})
aadd(aItemRef,{"IT_VFECPST","103",80,lArredBra,aParSX6[MV_RNDICM]})
aadd(aItemRef,{"IT_ALIQFECP","104",,.F.,lCritArr})
aadd(aItemRef,{"IT_CRPRESC","105",,lArredBra,lCritArr})
aadd(aItemRef,{"IT_DESCPRO","106",,.F.,lCritArr})
aadd(aItemRef,{"IT_ANFORI2","107",  ,.F.,.F.})
aadd(aItemRef,{"IT_UFORI",{107,1},,.F.,lCritArr})
aadd(aItemRef,{"IT_ALQORI",{107,2},,.F.,lCritArr})
aadd(aItemRef,{"IT_PROPOR",{107,3},,.F.,lCritArr})
aadd(aItemRef,{"IT_ALQPROR",{107,4},,.F.,lCritArr})
aadd(aItemRef,{"IT_ALIQII",{108,1},,.F.,lCritArr})
aadd(aItemRef,{"IT_VALII",{108,2},,.F.,lCritArr})
aadd(aItemRef,{"IT_CLASFIS","112",,.F.,lCritArr})
aadd(aItemRef,{"IT_VLRISC","113",,.F.,lCritPer})
aadd(aItemRef,{"IT_CRPREPE","114",,.F.,lCritArr})
aadd(aItemRef,{"IT_CRPREMG","115",,.F.,lCritArr})
aadd(aItemRef,{"IT_SLDDEP","116",,.F.,lCritArr})
aadd(aItemRef,{"IT_CRPRECE","117",,.F.,lCritArr})
aadd(aItemRef,{"IT_BASEFAB","118",,.T.,lCritArr})
aadd(aItemRef,{"IT_ALIQFAB","119",,.T.,.F.})
aadd(aItemRef,{"IT_VALFAB","120",,.T.,lCritArr})
aadd(aItemRef,{"IT_BASEFAC","121",,.T.,lCritArr})
aadd(aItemRef,{"IT_ALIQFAC","122",,.T.,.F.})
aadd(aItemRef,{"IT_VALFAC","123",,.T.,lCritArr})
aadd(aItemRef,{"IT_VALFUM","124",,.F.,lCritArr})
aadd(aItemRef,{"IT_ALIQFUM","125",,.F.,lCritArr})
If cPaisLoc=="EQU"
	aadd(aItemRef,{"IT_CONCEPT","126",5,.F.,.F.})
Endif
aadd(aItemRef,{"IT_MOTICMS","127",,.F.,lCritArr})
aadd(aItemRef,{"IT_ALSENAR","128",,.F.,lCritArr})
aadd(aItemRef,{"IT_VLSENAR","129",,.F.,lCritArr})
aadd(aItemRef,{"IT_BSSENAR","130",,.F.,lCritArr})
aadd(aItemRef,{"IT_CROUTSP","131",,.F.,lCritArr})
aadd(aItemRef,{"IT_AVLINSS","132",,.F.,lCritArr})
aadd(aItemRef,{"IT_BSSEMDS","133",,.F.,lCritArr})
aadd(aItemRef,{"IT_ICSEMDS","134",,.F.,lCritArr})
aadd(aItemRef,{"IT_PR43080","135",,.F.,lCritArr})
aadd(aItemRef,{"IT_BASEFUN","136",,.F.,lCritArr})
aadd(aItemRef,{"IT_BASVEIC","137",,.F.,lCritArr})
aadd(aItemRef,{"IT_BASRESI",{138,1},,lArredBra,aParSX6[MV_RNDICM]})
aadd(aItemRef,{"IT_VALRESI",{138,2},,lArredBra,aParSX6[MV_RNDICM]})
aadd(aItemRef,{"IT_CRPREPR","140",,.F.,lCritArr})
aadd(aItemRef,{"IT_TABNTRE",{141,1},,.F.,lCritArr})
aadd(aItemRef,{"IT_CODNTRE",{141,2},,.F.,lCritArr})
aadd(aItemRef,{"IT_GRPNTRE",{141,3},,.F.,lCritArr})
aadd(aItemRef,{"IT_DATNTRE",{141,4},,.F.,lCritArr})
aadd(aItemRef,{"IT_ALITPDP",{142,1},,.F.,lCritArr})
aadd(aItemRef,{"IT_BASTPDP",{142,2},,.F.,lCritArr})
aadd(aItemRef,{"IT_VALTPDP",{142,3},,.F.,lCritArr})
aadd(aItemRef,{"IT_VLINCMG","143",,.F.,lCritArr})
aadd(aItemRef,{"IT_PRINCMG","144",,.F.,lCritArr})
aadd(aItemRef,{"IT_BASEINA",{145,1},,.F.,lCritArr})
aadd(aItemRef,{"IT_ALIQINA",{145,2},,.F.,lCritArr})
aadd(aItemRef,{"IT_VALINA",{145,3},,.F.,lCritArr})
aadd(aItemRef,{"IT_VFECPRN","146",,.F.,lCritArr})
aadd(aItemRef,{"IT_VFESTRN","147",,.F.,lCritArr})
aadd(aItemRef,{"IT_ALFECRN","148",,.F.,lCritArr})
aadd(aItemRef,{"IT_VLRFUE","149",,.F.,lCritArr})
aadd(aItemRef,{"IT_METODO","150",,.F.,lCritArr})
aadd(aItemRef,{"IT_NORESPE","151",,.F.,lCritArr})
aadd(aItemRef,{"IT_COEPSST","152",,.F.,lCritArr})
aadd(aItemRef,{"IT_COECFST","153",,.F.,lCritArr})
aadd(aItemRef,{"IT_CREDPRE","154",,.F.,lCritArr})
aadd(aItemRef,{"IT_PRCUNIC","155",,.F.,lCritArr})
aadd(aItemRef,{"IT_RANTSPD","156",,.F.,lCritArr})
aadd(aItemRef,{"IT_VFECPMG","157",,.F.,lCritArr})
aadd(aItemRef,{"IT_VFESTMG","158",,.F.,lCritArr})
aadd(aItemRef,{"IT_ALFECMG","159",,.F.,lCritArr})
aadd(aItemRef,{"IT_VREINT","160",,.F.,lCritArr})
aadd(aItemRef,{"IT_BSREIN","161",,.F.,lCritArr})
aadd(aItemRef,{"IT_VALCMAJ","162",,.F.,lCritArr})
aadd(aItemRef,{"IT_ALQCMAJ","163",,.F.,lCritArr})
aadd(aItemRef,{"IT_VFECPMT","164",,.F.,lCritArr})
aadd(aItemRef,{"IT_VFESTMT","165",,.F.,lCritArr})
aadd(aItemRef,{"IT_ALFECMT","166",,.F.,lCritArr})
aadd(aItemRef,{"IT_B1DIAT","168",,.F.,lCritArr})
aadd(aItemRef,{"IT_POSIPI","172",172,.F.,.F.})
aadd(aItemRef,{"IT_ADIANT","180",,.F.,lCritArr})
aadd(aItemRef,{"IT_NATOPER","181",,.F.,lCritArr})
aadd(aItemRef,{"IT_ADIANT","180",,.F.,lCritArr})
aadd(aItemRef,{"IT_IDSF4" ,{183,1},,.F.,lCritArr})
aadd(aItemRef,{"IT_IDSF7" ,{183,2},,.F.,lCritArr})
aadd(aItemRef,{"IT_IDSA1" ,{183,3},,.F.,lCritArr})
aadd(aItemRef,{"IT_IDSA2" ,{183,4},,.F.,lCritArr})
aadd(aItemRef,{"IT_IDSB1" ,{183,5},,.F.,lCritArr})
aadd(aItemRef,{"IT_IDSB5" ,{183,6},,.F.,lCritArr})
aadd(aItemRef,{"IT_IDSBZ" ,{183,7},,.F.,lCritArr})
aadd(aItemRef,{"IT_IDSED" ,{183,8},,.F.,lCritArr})
aadd(aItemRef,{"IT_IDSFB" ,{183,9},,.F.,lCritArr})
aadd(aItemRef,{"IT_IDSFC" ,{183,10},,.F.,lCritArr})     
aadd(aItemRef,{"IT_IDCFC" ,{183,11},,.F.,lCritArr})     
aadd(aItemRef,{"IT_UFXPROD" ,{183,12},,.F.,lCritArr})     
                                                                  
aadd(aItemRef,{"IT_DESCTOT","184",20,.T., aParSX6[MV_RNDDES] })
aadd(aItemRef,{"IT_ACRESCI","185",20,.T., aParSX6[MV_RNDDES] })

aadd(aItemRef,{"IT_VALPMAJ","186",,.F.,lCritArr})
aadd(aItemRef,{"IT_ALQPMAJ","187",,.F.,lCritArr})  

aadd(aItemRef,{"IT_PRDFIS","188",,.F.,lCritArr})    
aadd(aItemRef,{"IT_NCMFIS","190",,.F.,lCritArr})
aadd(aItemRef,{"IT_VALCIDE","192",,.F.,lCritArr})
aadd(aItemRef,{"IT_PREDST",{04,17},,.F.,lCritArr})
aadd(aItemRef,{"IT_PREDIPI",{06,04},,.F.,lCritArr})
aadd(aItemRef,{"IT_VALFETR","194",,.F.,lCritArr})           
aadd(aItemRef,{"IT_BASNDES","197",,.F.,lCritArr})
aadd(aItemRef,{"IT_ICMNDES","198",,.F.,lCritArr})

If cPaisLoc == "PER" .and. SF1->(FieldPos("F1_ADIANT")) > 0
	aadd(aItemRef,{"IT_ADIANTTOT" ,"199",,.F.,lCritArr})
EndIf

aadd(aResRef,{"IMP_COD",1})
aadd(aResRef,{"IMP_DESC",2})
aadd(aResRef,{"IMP_BASE",3})
aadd(aResRef,{"IMP_ALIQ",4})
aadd(aResRef,{"IMP_VAL",5})
aadd(aResRef,{"IMP_NOME",6})


aadd(aLFis,{"LF_CFO",1})
aadd(aLFis,{"LF_ALIQICMS",2})
aadd(aLFis,{"LF_VALCONT",3})
aadd(aLFis,{"LF_BASEICM",4})
aadd(aLFis,{"LF_VALICM",5})
aadd(aLFis,{"LF_ISENICM",6})
aadd(aLFis,{"LF_OUTRICM",7})
aadd(aLFis,{"LF_BASEIPI",8})
aadd(aLFis,{"LF_VALIPI",9})
aadd(aLFis,{"LF_ISENIPI",10})
aadd(aLFis,{"LF_OUTRIPI",11})
aadd(aLFis,{"LF_OBSERV",12})
aadd(aLFis,{"LF_VALOBSE",13})
aadd(aLFis,{"LF_ICMSRET",14})
aadd(aLFis,{"LF_LANCAM",15})
aadd(aLFis,{"LF_TIPO",16})
aadd(aLFis,{"LF_ICMSCOMP",17})
aadd(aLFis,{"LF_CODISS",18})
aadd(aLFis,{"LF_IPIOBS",19})
aadd(aLFis,{"LF_NFLIVRO",20})
aadd(aLFis,{"LF_ICMAUTO",21})
aadd(aLFis,{"LF_BASERET",22})
aadd(aLFis,{"LF_FORMUL",23})
aadd(aLFis,{"LF_FORMULA",24})
aadd(aLFis,{"LF_DESPESA",25})
aadd(aLFis,{"LF_ICMSDIF",26})
aadd(aLFis,{"LF_TRFICM",27})
aadd(aLFis,{"LF_OBSICM",28})
aadd(aLFis,{"LF_OBSSOL",29})
aadd(aLFis,{"LF_SOLTRIB",30})
aadd(aLFis,{"LF_CFOEXT",31})
aadd(aLFis,{"LF_ISSST",32})
aadd(aLFis,{"LF_RECISS",33})
aadd(aLFis,{"LF_ISSSUB",34})
aadd(aLFis,{"LF_CREDST",36})
aadd(aLFis,{"LF_CRDEST",37})
aadd(aLFis,{"LF_CRDPRES",38})
aadd(aLFis,{"LF_SIMPLES",39})
aadd(aLFis,{"LF_CRDTRAN",40})
aadd(aLFis,{"LF_CFOEXT",31})
aadd(aLFis,{"LF_CRDZFM",41})
aadd(aLFis,{"LF_CNAE",42})
aadd(aLFis,{"LF_IDENT",43})
aadd(aLFis,{"LF_CLASFIS",44})
aadd(aLFis,{"LF_CTIPI",45})
aadd(aLFis,{"LF_ESTOQUE",46})
aadd(aLFis,{"LF_DESPIPI",47})
aadd(aLFis,{"LF_POSIPI",48})
aadd(aLFis,{"LF_OUTRRET",49})
aadd(aLFis,{"LF_ISENRET",50})
aadd(aLFis,{"LF_ITEMORI",51})
aadd(aLFis,{"LF_CFPS",52})
aadd(aLFis,{"LF_ALIQIPI",53})
aadd(aLFis,{"LF_CRPRST",54})
aadd(aLFis,{"LF_TRIBRET",55})
aadd(aLFis,{"LF_DESCZFR",56})
aadd(aLFis,{"LF_BASEPS3",57})
aadd(aLFis,{"LF_ALIQPS3",58})
aadd(aLFis,{"LF_VALPS3",59})
aadd(aLFis,{"LF_BASECF3",60})
aadd(aLFis,{"LF_ALIQCF3",61})
aadd(aLFis,{"LF_VALCF3",62})
aadd(aLFis,{"LF_CRPRELE",63})
aadd(aLFis,{"LF_ISSMAT",64})
aadd(aLFis,{"LF_VALFDS",65})
aadd(aLFis,{"LF_ESTCRED",66})
aadd(aLFis,{"LF_CRPRSIM",67})
aadd(aLFis,{"LF_BASETST",68})
aadd(aLFis,{"LF_VALTST",69})
aadd(aLFis,{"LF_ANTICMS",70})
aadd(aLFis,{"LF_VALANTI",71})
aadd(aLFis,{"LF_CRPREPR",72})
aadd(aLFis,{"LF_VALFECP",73})
aadd(aLFis,{"LF_VFECPST",74})
aadd(aLFis,{"LF_CSTPIS",75})
aadd(aLFis,{"LF_CSTCOF",76})
aadd(aLFis,{"LF_CREDACU",77})
aadd(aLFis,{"LF_CRPRERO",78})
aadd(aLFis,{"LF_VALII",79})
aadd(aLFis,{"LF_CRPRERE",80})
aadd(aLFis,{"LF_CSTISS",81})
aadd(aLFis,{"LF_CPRESPR",82})
aadd(aLFis,{"LF_VALFET",83})
aadd(aLFis,{"LF_VALFAB",84})
aadd(aLFis,{"LF_VALFAC",85})
aadd(aLFis,{"LF_CRPRESP",86})
aadd(aLFis,{"LF_VALFUM",87})
aadd(aLFis,{"LF_MOTICMS",88})
aadd(aLFis,{"LF_VLSENAR",89})
aadd(aLFis,{"LF_CROUTSP",90})
aadd(aLFis,{"LF_DS43080",91})
aadd(aLFis,{"LF_VL43080",92})
aadd(aLFis,{"LF_CPPRODE",93})
aadd(aLFis,{"LF_TPPRODE",94})
aadd(aLFis,{"LF_CODBCC",95})
aadd(aLFis,{"LF_INDNTFR",96})
aadd(aLFis,{"LF_TABNTRE",97})
aadd(aLFis,{"LF_CODNTRE",98})
aadd(aLFis,{"LF_GRPNTRE",99})
aadd(aLFis,{"LF_DATNTRE",100})
aadd(aLFis,{"LF_VALTPDP",101})
aadd(aLFis,{"LF_VFECPRN",102})
aadd(aLFis,{"LF_VFESTRN",103})
aadd(aLFis,{"LF_CROUTGO",104})
aadd(aLFis,{"LF_CRDPCTR",105})
aadd(aLFis,{"LF_CREDPRE",106})
aadd(aLFis,{"LF_VFECPMG",107})
aadd(aLFis,{"LF_VFESTMG",108})
aadd(aLFis,{"LF_VREINT",109})
aadd(aLFis,{"LF_BSREIN",110})
aadd(aLFis,{"LF_VALCMAJ",111})
aadd(aLFis,{"LF_ALQCMAJ",112})
aadd(aLFis,{"LF_VFECPMT",113})
aadd(aLFis,{"LF_VFESTMT",114})
aadd(aLFis,{"LF_VALPMAJ",115})
aadd(aLFis,{"LF_ALQPMAJ",116})

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaItArred³ Autor ³ Edson Maricate         ³ Data ³12.04.2001³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Executa a correcao dos arredondamentos do item             ³±±
±±³          ³ Utiliza o Array aSaveDec para armazenar os centesimos      ³±±
±±³          ³ que foram truncados. ( aSaveDec deve estar inicializado    ³±±
±±³          ³ obrigatoriamente pela MaFisIni() )                         ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaItArred(nX,aRefs)

Local nY        := 0
Local nZ        := 0
Local nDifItDel := 0
Local nAbatISS	:= 0
Local nDif      := 0
Local nValor 	:= 0
Local nDifItem	:= 0
Local nDec      := 2
Local nRndPrec  := IIf( aParSX6[MV_RNDPREC] < 3 , 10 , aParSX6[MV_RNDPREC] ) // Precisao para o arredondamento
Local lSobra 	:= aParSX6[MV_RNDSOBR] // Parametro para considerar, ou nao, as sobras quando o parametro de arredondamento estiver como .F., ou seja, para truncar.
Local lRndrne   := aParSX6[MV_RNDRNE]

If aItemRef == Nil
	MaIniRef()
EndIf

//³ Executa a correcao nos arredondamentos.                    ³
For nY := 1 to Len(aItemRef)
	If aRefs == Nil .Or. aScan( aRefs, aItemRef[nY][1] ) <> 0
		If aItemRef[nY][4]
			nDifItem	:= 0
			nDifItDel   := 0
			If cPaisLoc<>"BRA"
				If FunName()=="MATA121" .And. Type("nMoedaPed")=="N"
					nDec:=MsDecimais(nMoedaPed)
				ElseIf FunName()=="MATA123" .And. Type("nMoedaPed")=="N"
					nDec:=MsDecimais(nMoedaPed)
				ElseIf FunName()=="MATA150" .And. Type("nMoedaCot")=="N"
					nDec:=MsDecimais(nMoedaCot)
				ElseIf FunName()=="MATA160" .And. Type("nMoedaAval")=="N"
					nDec:=MsDecimais(nMoedaAval)
				ElseIf Type("nMoedaNF")=="N"
					nDec:=MsDecimais(nMoedaNF)
				ElseIf Type("nMoedaCor")=="N"
					nDec:=MsDecimais(nMoedaCor)
				ElseIf Type("M->F1_MOEDA")=="N"
					nDec:=MsDecimais(M->F1_MOEDA)
				ElseIf Type("M->F2_MOEDA")=="N"
					nDec:=MsDecimais(M->F2_MOEDA)
				ElseIf Type("M->C5_MOEDA")=="N"
					nDec:=MsDecimais(M->C5_MOEDA)
				ElseIf FunName()=="MATA143" .And. Type("nMoedaDes")=="N"
					nDec:=MsDecimais(nMoedaDes)
				Else
					nDec:=MsDecimais(1)
				Endif
				nDif:=10**(-nDec)
			Endif
			
			For nZ := 1 To Len(aNfItem) // For para desconsiderar os itens deletados nos arrays de acumulos da sobras qdo o parametro MV_RNDSOBR = .T.
				If aNfItem[nZ][IT_DELETED] .And. lSobra
					If aItemDec[nZ][1][nY] > 0
						nDifItDel += aItemDec[nZ][1][nY]
						nDifItDel -= (1/10**nDec)
					Else
						nDifItDel += aItemDec[nZ][2][nY]
					EndIf
				EndIf
			Next nZ
			
			If ValType(aItemRef[nY][2]) == "A"
				nValor := aNfItem[nX][aItemRef[nY][2][1]][aItemRef[nY][2][2]]
				If nValor <> 0
					While Int(nValor) <> Int(NoRound(NoRound(nValor,nRndPrec),nDec,nDifItem,10)) .And. nRndPrec > 2
						nRndPrec -= 1
					Enddo
					aNfItem[nX][aItemRef[nY][2][1]][aItemRef[nY][2][2]] := NoRound(NoRound(nValor,nRndPrec),nDec,@nDifItem,10)
					If nDifItem <> 0
						aSaveDec[nY] += aItemDec[nX][1][nY]
						aItemDec[nX][1][nY] := 0
						If !aItemRef[nY][5]
							aSaveDec[nY] -= aItemDec[nX][2][nY]
							aItemDec[nX][2][nY]	:= nDifItem
							aSaveDec[nY] += nDifItem
							If lSobra
								//TRATAMENTO SAO PAULO COM ITENS QUE TENHAM ABATIMENTO.
								If lRndrne .And. aItemRef[nY][1] == "IT_VALISS" .And. aNfItem[nX,IT_ABVLISS] > 0
									If ( (NoRound(aSaveDec[nY],nDec) - nDifItDel ) >= 1/10**nDec)
										aItemDec[nX][1][nY]	:= (1/10**nDec) - nDifItem
										aItemDec[nX][2][nY]	:= 0
										aSaveDec[nY] -= (1/10**nDec)
										aNfItem[nX][aItemRef[nY][2][1]][aItemRef[nY][2][2]] += (1/10**nDec)
										nAbatISS += aNfItem[nX,IT_ABVLISS]
									EndIf
									//TRATAMENTO SAO PAULO COM ITENS QUE NAO TENHAM ABATIMENTO ANTERIORES.
								ElseIf lRndrne .And. aItemRef[nY][1] == "IT_VALISS" .And. nAbatISS == 0
									If ( (NoRound(aSaveDec[nY],nDec) - nDifItDel ) >= 1/10**nDec)
										aItemDec[nX][1][nY]	:= (1/10**nDec) - nDifItem
										aItemDec[nX][2][nY]	:= 0
										aSaveDec[nY] -= (1/10**nDec)
										aNfItem[nX][aItemRef[nY][2][1]][aItemRef[nY][2][2]] += (1/10**nDec)
									EndIf
								Else
									If ( aSaveDec[nY] - nDifItDel )  >= (50/(10**(nDec + 2)))
										aItemDec[nX][1][nY]	:= (1/10**nDec) - nDifItem
										aItemDec[nX][2][nY]	:= 0
										aSaveDec[nY] -= (1/10**nDec)
										aNfItem[nX][aItemRef[nY][2][1]][aItemRef[nY][2][2]] += (1/10**nDec)
									EndIf
								EndIf
							EndIf
						ElseIf nDifItem > 0 .And. aNfItem[nX][aItemRef[nY][2][1]][aItemRef[nY][2][2]] > 0
							aSaveDec[nY] -= aItemDec[nX][2][nY]
							aItemDec[nX][2][nY]	:= nDifItem
							aSaveDec[nY] += nDifItem
							
							If ( aSaveDec[nY] - nDifItDel ) >= (50/(10**(nDec + 2)))
								If lSobra
									aItemDec[nX][1][nY]	:= (1/10**nDec) - nDifItem
									aItemDec[nX][2][nY]	:= 0
									aSaveDec[nY] -= (1/10**nDec)
								EndIf
								aNfItem[nX][aItemRef[nY][2][1]][aItemRef[nY][2][2]] += (1/10**nDec)
							EndIf
							
						EndIf
						If !lSobra
							aItemDec[nX][1][nY]	:= 0
							aItemDec[nX][2][nY]	:= 0
							aSaveDec[nY] := 0
						Endif
					EndIf
				EndIf
			Else
				nValor := aNfItem[nX][Val(aItemRef[nY][2])]
				If nValor <> 0
					While Int(nValor) <> Int(NoRound(NoRound(nValor,nRndPrec),nDec,nDifItem,10)) .And. nRndPrec > 2
						nRndPrec -= 1
					Enddo
					aNfItem[nX][Val(aItemRef[nY][2])] := NoRound(NoRound(nValor,nRndPrec),nDec,@nDifItem,10)
					If nDifItem <> 0
						aSaveDec[nY] += aItemDec[nX][1][nY]
						aItemDec[nX][1][nY] := 0
						If !aItemRef[nY][5]
							aSaveDec[nY] -= aItemDec[nX][2][nY]
							aItemDec[nX][2][nY]	:= nDifItem
							aSaveDec[nY] += nDifItem
							
							//TRATAMENTO SAO PAULO COM ITENS QUE TENHAM ABATIMENTO.
							If  lRndRne .And. aItemRef[nY][1] == "IT_VALISS" .And. aNfItem[nX,IT_ABVLISS] > 0
								If ( NoRound(aSaveDec[nY],nDec) - nDifItDel ) >= 1/10**nDec
									aItemDec[nX][1][nY]	:= (1/10**nDec) - nDifItem
									aItemDec[nX][2][nY]	:= 0
									aSaveDec[nY] -= (1/10**nDec)
									aNfItem[nX][Val(aItemRef[nY][2])] += (1/10**nDec)
									nAbatISS += aNfItem[nX,IT_ABVLISS]
								EndIf
								//TRATAMENTO SAO PAULO COM ITENS QUE NAO TENHAM ABATIMENTO ANTERIORES.
							ElseIf lRndRne .And. aItemRef[nY][1] == "IT_VALISS" .And. nAbatISS == 0
								If ( NoRound(aSaveDec[nY],nDec) - nDifItDel ) >= 1/10**nDec
									aItemDec[nX][1][nY]	:= (1/10**nDec) - nDifItem
									aItemDec[nX][2][nY]	:= 0
									aSaveDec[nY] -= (1/10**nDec)
									aNfItem[nX][Val(aItemRef[nY][2])] += (1/10**nDec)
									
								EndIf
							Else
								If lSobra .And. ( aSaveDec[nY] - nDifItDel ) >= (50/(10**(nDec + 2)))
									aItemDec[nX][1][nY]	:= (1/10**nDec) - nDifItem
									aItemDec[nX][2][nY]	:= 0
									aSaveDec[nY] -= (1/10**nDec)
									aNfItem[nX][Val(aItemRef[nY][2])] += (1/10**nDec)
								EndIf
							EndIf
							
						ElseIf nDifItem > 0 .And. aNfItem[nX][Val(aItemRef[nY][2])] > 0
							aSaveDec[nY] -= aItemDec[nX][2][nY]
							aItemDec[nX][2][nY] := nDifItem
							aSaveDec[nY] += nDifItem
							If ( aSaveDec[nY] - nDifItDel ) >= (50/(10**(nDec + 2)))
								aItemDec[nX][1][nY] := (1/10**nDec) - nDifItem
								aItemDec[nX][2][nY] := 0
								aSaveDec[nY] -= (1/10**nDec)
								aNfItem[nX][Val(aItemRef[nY][2])] += (1/10**nDec)
							EndIf
						EndIf
						If !lSobra
							aItemDec[nX][1][nY]	:= 0
							aItemDec[nX][2][nY]	:= 0
							aSaveDec[nY] 		:= 0
						Endif
					EndIf
				EndIf
			EndIf
		EndIf
	EndIf
Next nY

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³ MaIt2Cab ³ Autor ³ Edson Maricate        ³ Data ³13.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Atualiza os valores totais do cabecalho da NF              ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaIt2Cab(nItemNao)

Local nX := 0
Local nY := 0

DEFAULT nItemNao := 0

aAuxOri := {}

aNfCab[NF_DESCONTO]	:= 0

aNfCab[NF_DESCTOT]	:= 0   
aNfCab[NF_ACRESCI]	:= 0  

aNfCab[NF_FRETE]	:= 0
aNfCab[NF_DESPESA]	:= 0
aNfCab[NF_SEGURO]	:= 0
aNfCab[NF_VALEMB]	:= 0
aNfCab[NF_AUTONOMO]	:= 0
aNfCab[NF_ICMS]		:= {0,0,0,0,0,0,0,0,"1"}
aNfCab[NF_IPI]		:= {0,0,0}
aNfCab[NF_TOTAL]	:= 0
aNfCab[NF_VALMERC]	:= 0
aNfCab[NF_VNAGREG]  := 0
aNfCab[NF_FUNRURAL]	:= 0
aNfCab[NF_LIVRO]	:= {}
aNfCab[NF_BASEIRR]	:= 0
aNfCab[NF_VALIRR]	:= 0
aNfCab[NF_BASEINS]  := 0
aNfCab[NF_VALINS]	:= 0
aNfCab[NF_BASEISS] 	:= 0
aNfCab[NF_VALISS]	:= 0
aNfCab[NF_DESCISS]  := 0
aNfCab[NF_IMPOSTOS]	:= {}
aNfCab[NF_IMPOSTOS2]:= {}
aNfCab[NF_BASEDUP]	:= 0
aNfCab[NF_DESCZF]	:= 0
aNfCab[NF_BASEIMP]	:= Array(NMAXIV)
aNfCab[NF_BASEIMP]	:= Afill(aNfCab[NF_BASEIMP],0)
aNfCab[NF_VALIMP]	:= Array(NMAXIV)
aNfCab[NF_VALIMP]	:= Afill(aNfCab[NF_VALIMP],0)
aNfCab[NF_PESO]		:= 0
aNfCab[NF_ICMFRETE]	:= 0
aNfCab[NF_BSFRETE]	:= 0
aNfCab[NF_BASEICA]	:= 0
aNfCab[NF_VALICA]	:= 0
aNfCab[NF_BASECOF]	:= 0
aNfCab[NF_VALCOF]	:= 0
aNfCab[NF_BASECSL]	:= 0
aNfCab[NF_VALCSL]	:= 0
aNfCab[NF_BASEPIS]	:= 0
aNfCab[NF_VALPIS]	:= 0
aNfCab[NF_BASEPS2]	:= 0
aNfCab[NF_VALPS2]	:= 0
aNfCab[NF_BASECF2]	:= 0
aNfCab[NF_VALCF2]	:= 0
aNfCab[NF_MINIMP]	:=Array(NMAXIV)
aNfCab[NF_MINIMP]	:=Afill(aNfCab[NF_MINIMP],0)
aNfCab[NF_BASEAFRMM]:= 0
aNfCab[NF_PIS252]   := 0
aNfCab[NF_COF252]   := 0
aNfCab[NF_BASESES]  := 0
aNfCab[NF_VALSES]	:= 0
aNfCab[NF_BASEPS3]  := 0
aNfCab[NF_VALPS3]   := 0
aNfCab[NF_BASECF3]  := 0
aNfCab[NF_VALCF3]   := 0
aNfCab[NF_VLR_FRT]  := 0
aNfCab[NF_VALFET]   := 0
aNfCab[NF_VALFETR]  := 0
aNfCab[NF_VALFDS]   := 0
aNfCab[NF_VLSENAR]  := 0
aNfCab[NF_ESTCRED]  := 0
aNfCab[NF_BASETST]  := 0
aNfCab[NF_VALTST]   := 0
aNfCab[NF_CRPRSIM]  := 0
aNfCab[NF_VALANTI]  := 0
aNfCab[NF_DESNTRB]  := 0
aNfCab[NF_TARA]   	:= 0
aNfCab[NF_CRDPRES]	:= 0
aNfCab[NF_CRPREPE]	:= 0
aNfCab[NF_VALFAC]	:= 0
aNfCab[NF_VALFET]	:= 0
aNfCab[NF_VALFETR]	:= 0
aNfCab[NF_VALFAB]	:= 0
aNfCab[NF_CROUTSP]  := 0
aNfCab[NF_BSSEMDS]  := 0
aNfCab[NF_ICSEMDS]  := 0
aNfCab[NF_DS43080]  := 0
aNfCab[NF_VL43080]  := 0
aNfCab[NF_VLRORIG]	:= Array(NMAXIV)
aNfCab[NF_VLRORIG]	:= Afill(aNfCab[NF_VLRORIG],0)
aNfCab[NF_ICMSDIF]  := 0
aNfCab[NF_BASEFUN]  := 0
aNfCab[NF_VALII]    := 0
aNfCab[NF_VLINCMG]  := 0
aNfCab[NF_BASEINA]	:= 0
aNFCab[NF_VALINA]	:= 0
aNfCab[NF_VFECPRN]  := 0
aNfCab[NF_VFESTRN]  := 0
aNfCab[NF_CREDPRE]	:= 0
aNfCab[NF_VFECPMG]  := 0
aNfCab[NF_VFESTMG]  := 0
aNfCab[NF_VREINT]   := 0
aNfCab[NF_BSREIN]   := 0
aNfCab[NF_VFECPMT]  := 0
aNfCab[NF_VFESTMT]  := 0
aNfCab[NF_ISSABMT]  := 0
aNfCab[NF_ISSABSR]  := 0
aNfCab[NF_INSABMT]  := 0
aNfCab[NF_INSABSR]  := 0
aNfCab[NF_ADIANT]   := 0
aNfCab[NF_VALTPDP]  := 0
aNfCab[NF_BASTPDP]  := 0
aNfCab[NF_VALAFRMM] := 0
aNfCab[NF_VALFECP]  := 0
aNfCab[NF_VFECPST]  := 0
aNfCab[NF_VALFUM]   := 0   
aNfCab[NF_VALCIDE]  := 0  


IF cPaisLoc == "PER" .and. SF1->(FieldPos("F1_ADIANT")) > 0
	aNfCab[NF_ADIANTTOT] := 0
EndIf

For nX := 1 to Len(aNfItem)
	If nItemNao <> nX
		MaFisSomaIt(nX)
	Endif
Next nX

If cPaisLoc == "BRA" // Executa a correcao nos arredondamentos no Cabecalho e Livros Fiscais
	For nX := 1 To Len(aCabRef)
		If ValType(aCabRef[nX,2]) <> "A"
			nY := Val(aCabRef[nX,2])
			If ValType(aNfCab[nY]) == "N" .And. aCabRef[nX][3]
				aNfCab[nY] := NoRound(aNfCab[nY],2,,10)
			EndIf
		EndIf
	Next nX
Endif

If bFisRefresh <> Nil
	Eval(bFisRefresh)
EndIf

If bLivroRefresh <> Nil
	Eval(bLivroRefresh)
EndIf

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡„o    ³MaFisSomaIt³ Autor ³Edson Maricate        ³ Data ³13.12.1999 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo atualizar a variavel aNfCab com³±±
±±³          ³base nos itens da funcao fiscal                              ³±±
±±³          ³Rotina atualizacao dos dados do Cabecalho da funcao fiscal   ³±±
±±³          ³aNfCab com base em um item da funcao fiscal aNfItem          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1: Item do Array ANFItem que deve ser inicializado       ³±±
±±³          ³ExpL2: Indica se eh inclusao (.T.)ou estorno(.F.)       (OPC)³±±
±±³          ³ExpC3: Campo a ser atualizado                           (OPC)³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisSomaIt(nX,lSoma,cCampo)

Local nY := 0
Local nG := 0

DEFAULT lSoma := .T.

If !aNfItem[nX][IT_DELETED]
	If lSoma
		// Atualiza os campos totalizadores.
		aNfCab[NF_DESCONTO]+= aNfItem[nX][IT_DESCONTO]
		aNfCab[NF_FRETE]   += aNfItem[nX][IT_FRETE]
		aNfCab[NF_DESPESA] += aNfItem[nX][IT_DESPESA]
		aNfCab[NF_SEGURO]  += aNfItem[nX][IT_SEGURO]
		aNfCab[NF_VALEMB]  += aNfItem[nX][IT_VALEMB]
		aNfCab[NF_AUTONOMO]+= aNfItem[nX][IT_AUTONOMO]
		aNfCab[NF_BASEICM] += aNfItem[nX][IT_BASEICM]
		aNfCab[NF_VALICM]  += aNfItem[nX][IT_VALICM]
		aNfCab[NF_BASESOL] += aNfItem[nX][IT_BASESOL]
		aNfCab[NF_VALSOL]  += aNfItem[nX][IT_VALSOL]
		aNfCab[NF_BICMORI] += aNfItem[nX][IT_BICMORI]
		aNfCab[NF_VALCMP]  += aNfItem[nX][IT_VALCMP]
		aNfCab[NF_BASEIPI] += aNfItem[nX][IT_BASEIPI]
		aNfCab[NF_BIPIORI] += aNfitem[nX][IT_BIPIORI]
		aNfCab[NF_VALIPI]  += aNfItem[nX][IT_VALIPI]
		aNfCab[NF_TOTAL]   += aNfItem[nX][IT_TOTAL]
		aNfCab[NF_VALMERC] += aNfItem[nX][IT_VALMERC]-aNfItem[nX][IT_VNAGREG]
		aNfCab[NF_VNAGREG] += aNfItem[nX][IT_VNAGREG]
		aNfCab[NF_FUNRURAL]+= aNfItem[nX][IT_FUNRURAL]
		aNfCab[NF_BASEIRR] += aNfItem[nX][IT_BASEIRR]
		aNfCab[NF_VALIRR]  += aNfItem[nX][IT_VALIRR]
		aNfCab[NF_BASEINS] += aNfItem[nX][IT_BASEINS]
		aNfCab[NF_VALINS]  += aNfItem[nX][IT_VALINS]
		aNfCab[NF_BASEISS] += aNfItem[nX][IT_BASEISS]
		aNfCab[NF_VALISS]  += aNfItem[nX][IT_VALISS]
		aNfCab[NF_BASEDUP] += aNfItem[nX][IT_BASEDUP]
		aNfCab[NF_DESCZF]  += aNfItem[nX][IT_DESCZF]
		aNfCab[NF_PESO]	   += aNfItem[nX][IT_PESO]
		aNfCab[NF_ICMFRETE]+= aNfItem[nX][IT_ICMFRETE]
		aNfCab[NF_BSFRETE] += aNfItem[nX][IT_BSFRETE]
		aNfCab[NF_BASEICA] += aNfItem[nX][IT_BASEICA]
		aNfCab[NF_VALICA]  += aNfItem[nX][IT_VALICA]
		aNfCab[NF_BASECOF] += aNfItem[nX][IT_BASECOF]
		aNfCab[NF_VALCOF]  += aNfItem[nX][IT_VALCOF]
		aNfCab[NF_BASEPIS] += aNfItem[nX][IT_BASEPIS]
		aNfCab[NF_VALPIS]  += aNfItem[nX][IT_VALPIS]
		aNfCab[NF_BASEPS2] += aNfItem[nX][IT_BASEPS2]
		aNfCab[NF_VALPS2]  += aNfItem[nX][IT_VALPS2]
		aNfCab[NF_BASECF2] += aNfItem[nX][IT_BASECF2]
		aNfCab[NF_VALCF2]  += aNfItem[nX][IT_VALCF2]
		aNfCab[NF_BASECSL] += aNfItem[nX][IT_BASECSL]
		aNfCab[NF_VALCSL]  += aNfItem[nX][IT_VALCSL]
		aNfCab[NF_BASEFUN] += aNfItem[nX][IT_BASEFUN]
		aNfCab[NF_ADIANT]  += aNfItem[nX][IT_ADIANT]  
		If cPaisLoc == "PER" .and. SF1->(FieldPos("F1_ADIANT")) > 0   
			aNfCab[NF_ADIANTTOT]+= aNfItem[nX][IT_ADIANTTOT]
		EndIf 
		
		aNfCab[NF_DESCTOT] += aNfItem[nX][IT_DESCTOT]
		aNfCab[NF_ACRESCI] += aNfItem[nX][IT_ACRESCI]  
		aNfCab[NF_VALCIDE] += aNfItem[nX][IT_VALCIDE] 
		
		If cPaisLoc == "BRA" .Or. lNotRemito
			For nG := 1 To NMAXIV  
			  If cPaisLoc <> "BRA" .And. lNotRemito
	             aNfItem[nX][IT_BASEIMP][nG] := IIf(ValType(aNfItem[nX][IT_BASEIMP][nG])<>"N",0,aNfItem[nX][IT_BASEIMP][nG])		
			  Else
			     aNfCab[NF_BASEIMP][nG]+= aNfItem[nX][IT_BASEIMP][nG]
			  EndIf
				aNfCab[NF_VALIMP][nG] += aNfItem[nX][IT_VALIMP][nG]
				aNfCab[NF_VLRORIG][nG]+= aNfItem[nX][IT_VALIMP][nG]
			Next nG			
			aNfCab[NF_ICMSDIF]	+= aNfItem[nX][IT_ICMSDIF]
			aNfCab[NF_BASEAFRMM]+= aNfItem[nX][IT_BASEAFRMM]
			aNfCab[NF_VALAFRMM] += aNfItem[nX][IT_VALAFRMM]
			aNfCab[NF_PIS252]	+= aNfItem[nX][IT_PIS252]
			aNfCab[NF_COF252]	+= aNfItem[nX][IT_COF252]
			aNfCab[NF_BASESES]	+= aNfItem[nX][IT_BASESES]
			aNfCab[NF_VALSES]	+= aNfItem[nX][IT_VALSES]
			aNfCab[NF_BASEPS3]	+= aNfItem[nX][IT_BASEPS3]
			aNfCab[NF_VALPS3]	+= aNfItem[nX][IT_VALPS3]
			aNfCab[NF_BASECF3]	+= aNfItem[nX][IT_BASECF3]
			aNfCab[NF_VALCF3]	+= aNfItem[nX][IT_VALCF3]
			aNfCab[NF_VLR_FRT]	+= aNfItem[nX][IT_VLR_FRT]
			aNfCab[NF_VALFET]	+= aNfItem[nX][IT_VALFET]
			aNfCab[NF_VALFETR]	+= aNfItem[nX][IT_VALFETR]
			aNfCab[NF_VALFDS]	+= aNfItem[nX][IT_VALFDS]
			aNfCab[NF_ESTCRED]	+= aNfItem[nX][IT_ESTCRED]
			aNfCab[NF_BASETST]	+= aNfItem[nX][IT_BASETST]
			aNfCab[NF_VALTST]	+= aNfItem[nX][IT_VALTST]
			aNfCab[NF_CRPRSIM]	+= aNfItem[nX][IT_CRPRSIM]
			aNfCab[NF_VALANTI]	+= aNfItem[nX][IT_VALANTI]
			aNfCab[NF_DESNTRB]	+= aNfItem[nX][IT_DESNTRB]
			aNfCab[NF_TARA]		+= aNfItem[nX][IT_TARA]
			aNfCab[NF_VALFECP]	+= aNfItem[nX][IT_VALFECP]
			aNfCab[NF_VFECPST]	+= aNfItem[nX][IT_VFECPST]
			aNfCab[NF_CRDPRES]	+= aNfItem[nX][IT_CRPRESC]
			aNfCab[NF_CRDPRES]	+= aNfItem[nX][IT_CRPREMG]
			aNfCab[NF_CRDPRES]	+= aNfItem[nX][IT_CRPRECE]
			aNfCab[NF_VALII]	+= aNfItem[nX][IT_VALII]
			aNfCab[NF_CRPREPE]	+= aNfItem[nX][IT_CRPREPE]
			aNfCab[NF_VALFAB]	+= aNfItem[nX][IT_VALFAB]
			aNfCab[NF_VALFAC]	+= aNfItem[nX][IT_VALFAC]
			aNfCab[NF_VALFUM]	+= aNfItem[nX][IT_VALFUM]
			aNfCab[NF_VLSENAR]	+= aNfItem[nX][IT_VLSENAR]
			aNfCab[NF_CROUTSP]	+= aNfItem[nX][IT_CROUTSP]
			aNfCab[NF_BSSEMDS]	+= aNfItem[nX][IT_BSSEMDS]
			aNfCab[NF_ICSEMDS]	+= aNfItem[nX][IT_ICSEMDS]
			aNfCab[NF_VLINCMG]	+= aNfItem[nX][IT_VLINCMG]
			aNfCab[NF_TOTAL]	+= aNfItem[nX][IT_VLINCMG]
			aNfCab[NF_BASEINA]	+= aNfItem[nX][IT_BASEINA]
			aNFCab[NF_VALINA]	+= aNfItem[nX][IT_VALINA]
			aNfCab[NF_VFECPRN]	+= aNfItem[nX][IT_VFECPRN]
			aNfCab[NF_VFESTRN]	+= aNfItem[nX][IT_VFESTRN]
			aNfCab[NF_CREDPRE]	+= aNfItem[nX][IT_CREDPRE]
			aNfCab[NF_VFECPMG]	+= aNfItem[nX][IT_VFECPMG]
			aNfCab[NF_VFESTMG]	+= aNfItem[nX][IT_VFESTMG]
			aNfCab[NF_VREINT]	+= aNfItem[nX][IT_VREINT]
			aNfCab[NF_BSREIN]	+= aNfItem[nX][IT_BSREIN]
			aNfCab[NF_VFECPMT]	+= aNfItem[nX][IT_VFECPMT]
			aNfCab[NF_VFESTMT]	+= aNfItem[nX][IT_VFESTMT]
			aNfCab[NF_ISSABMT] 	+= aNfItem[nX][IT_ABMATISS]
			aNfCab[NF_ISSABSR]	+= aNfItem[nX][IT_ABVLISS]
			aNfCab[NF_INSABMT]	+= aNfItem[nX][IT_AVLINSS]
			aNfCab[NF_INSABSR]	+= aNfItem[nX][IT_ABVLINSS]
			aNfCab[NF_VALTPDP]  += aNfItem[nX][IT_VALTPDP]
			aNfCab[NF_BASTPDP]  += aNfItem[nX][IT_BASTPDP]
		EndIf
	Else
		// Atualiza os campos totalizadores.
		aNfCab[NF_DESCONTO]	-= aNfItem[nX][IT_DESCONTO]
		aNfCab[NF_FRETE]	-= aNfItem[nX][IT_FRETE]
		aNfCab[NF_DESPESA]	-= aNfItem[nX][IT_DESPESA]
		aNfCab[NF_SEGURO]	-= aNfItem[nX][IT_SEGURO]
		aNfCab[NF_VALEMB]	-= aNfItem[nX][IT_VALEMB]
		aNfCab[NF_AUTONOMO]	-= aNfItem[nX][IT_AUTONOMO]
		aNfCab[NF_BASEICM]	-= aNfItem[nX][IT_BASEICM]
		aNfCab[NF_VALICM]	-= aNfItem[nX][IT_VALICM]
		aNfCab[NF_BASESOL]	-= aNfItem[nX][IT_BASESOL]
		aNfCab[NF_VALSOL]	-= aNfItem[nX][IT_VALSOL]
		aNfCab[NF_BICMORI]	-= aNfItem[nX][IT_BICMORI]
		aNfCab[NF_VALCMP]	-= aNfItem[nX][IT_VALCMP]
		aNfCab[NF_BASEIPI]	-= aNfItem[nX][IT_BASEIPI]
		aNfCab[NF_BIPIORI]	-= aNfitem[nX][IT_BIPIORI]
		aNfCab[NF_VALIPI]	-= aNfItem[nX][IT_VALIPI]
		aNfCab[NF_TOTAL]	-= aNfItem[nX][IT_TOTAL]
		aNfCab[NF_VALMERC]	-= aNfItem[nX][IT_VALMERC]-aNfItem[nX][IT_VNAGREG]
		aNfCab[NF_VNAGREG] 	-= aNfItem[nX][IT_VNAGREG]
		aNfCab[NF_FUNRURAL]	-= aNfItem[nX][IT_FUNRURAL]
		aNfCab[NF_BASEIRR]	-= aNfItem[nX][IT_BASEIRR]
		aNfCab[NF_VALIRR]	-= aNfItem[nX][IT_VALIRR]
		aNfCab[NF_BASEINS]	-= aNfItem[nX][IT_BASEINS]
		aNfCab[NF_VALINS]	-= aNfItem[nX][IT_VALINS]
		aNfCab[NF_BASEISS]	-= aNfItem[nX][IT_BASEISS]
		aNfCab[NF_VALISS]	-= aNfItem[nX][IT_VALISS]
		aNfCab[NF_BASEDUP]	-= aNfItem[nX][IT_BASEDUP]
		aNfCab[NF_DESCZF]	-= aNfItem[nX][IT_DESCZF]
		aNfCab[NF_PESO]		-= aNfItem[nX][IT_PESO]
		aNfCab[NF_ICMFRETE]	-= aNfItem[nX][IT_ICMFRETE]
		aNfCab[NF_BSFRETE]	-= aNfItem[nX][IT_BSFRETE]
		aNfCab[NF_BASEICA]	-= aNfItem[nX][IT_BASEICA]
		aNfCab[NF_VALICA]	-= aNfItem[nX][IT_VALICA]
		aNfCab[NF_BASECOF]	-= aNfItem[nX][IT_BASECOF]
		aNfCab[NF_VALCOF]	-= aNfItem[nX][IT_VALCOF]
		aNfCab[NF_BASEPIS]	-= aNfItem[nX][IT_BASEPIS]
		aNfCab[NF_VALPIS]	-= aNfItem[nX][IT_VALPIS]
		aNfCab[NF_BASEPS2]  -= aNfItem[nX][IT_BASEPS2]
		aNfCab[NF_VALPS2]   -= aNfItem[nX][IT_VALPS2]
		aNfCab[NF_BASECF2]  -= aNfItem[nX][IT_BASECF2]
		aNfCab[NF_VALCF2]   -= aNfItem[nX][IT_VALCF2]
		aNfCab[NF_BASECSL]	-= aNfItem[nX][IT_BASECSL]
		aNfCab[NF_VALCSL]	-= aNfItem[nX][IT_VALCSL]
		aNfCab[NF_BASEINA]	-= aNfItem[nX][IT_BASEINA]
		aNFCab[NF_VALINA]	-= aNfItem[nX][IT_VALINA]
		aNFCab[NF_ADIANT]	-= aNfItem[nX][IT_ADIANT]      
		aNfCab[NF_DESCTOT]  -= aNfItem[nX][IT_DESCTOT]  
		aNfCab[NF_ACRESCI]	-= aNfItem[nX][IT_ACRESCI]
		aNfCab[NF_VALCIDE] -= aNfItem[nX][IT_VALCIDE] 
		
		If cPaisLoc == "PER" .and. SF1->(FieldPos("F1_ADIANT")) > 0
			aNfCab[NF_ADIANTTOT]-= aNfItem[nX][IT_ADIANTTOT]
		EndIf
		
		If cPaisLoc == "BRA" .Or. lNotRemito
			For nG := 1 To NMAXIV
				aNfCab[NF_BASEIMP][nG] -= aNfItem[nX][IT_BASEIMP][nG]
				aNfCab[NF_VALIMP][nG]  -= aNfItem[nX][IT_VALIMP][nG]
				aNfCab[NF_VLRORIG][nG] -= aNfItem[nX][IT_VALIMP][nG]
			Next nG
		EndIf
		If cPaisLoc <> "BRA" .And. (cCampo=="IT_DESCONTO" .OR. cCampo=="IT_DESCTOT") .And. aNfCab[NF_OPERNF] =='S' .And. aParSX6[MV_DESCSAI]=='1'
			aNFitem[nX][IT_VALMERC] += (aNFitem[nX][IT_DESCONTO]+aNFitem[nX][IT_DESCTOT])
			aNFitem[nX][IT_PRCUNI]  := aNFitem[nX][IT_VALMERC]/Max(aNFitem[nX][IT_QUANT],1)
		EndIf
		aNfCab[NF_ICMSDIF]	-= aNfItem[nX][IT_ICMSDIF]
		aNfCab[NF_BASEAFRMM]-= aNfItem[nX][IT_BASEAFRMM]
		aNfCab[NF_VALAFRMM] -= aNfItem[nX][IT_VALAFRMM]
		aNfCab[NF_PIS252]	-= aNfItem[nX][IT_PIS252]
		aNfCab[NF_COF252]	-= aNfItem[nX][IT_COF252]
		aNfCab[NF_BASESES]	-= aNfItem[nX][IT_BASESES]
		aNfCab[NF_VALSES]	-= aNfItem[nX][IT_VALSES]
		aNfCab[NF_BASEPS3]	-= aNfItem[nX][IT_BASEPS3]
		aNfCab[NF_VALPS3]	-= aNfItem[nX][IT_VALPS3]
		aNfCab[NF_BASECF3]	-= aNfItem[nX][IT_BASECF3]
		aNfCab[NF_VALCF3]	-= aNfItem[nX][IT_VALCF3]
		aNfCab[NF_VLR_FRT]	-= aNfItem[nX][IT_VLR_FRT]
		aNfCab[NF_VALFET]	-= aNfItem[nX][IT_VALFET]
		aNfCab[NF_VALFETR]	-= aNfItem[nX][IT_VALFETR]
		aNfCab[NF_VALFDS]	-= aNfItem[nX][IT_VALFDS]
		aNfCab[NF_ESTCRED]	-= aNfItem[nX][IT_ESTCRED]
		aNfCab[NF_BASETST]	-= aNfItem[nX][IT_BASETST]
		aNfCab[NF_VALTST]	-= aNfItem[nX][IT_VALTST]
		aNfCab[NF_CRPRSIM]	-= aNfItem[nX][IT_CRPRSIM]
		aNfCab[NF_VALANTI]	-= aNfItem[nX][IT_VALANTI]
		aNfCab[NF_DESNTRB]	-= aNfItem[nX][IT_DESNTRB]
		aNfCab[NF_TARA]		-= aNfItem[nX][IT_TARA]
		aNfCab[NF_VALFECP]	-= aNfItem[nX][IT_VALFECP]
		aNfCab[NF_VFECPST]	-= aNfItem[nX][IT_VFECPST]
		aNfCab[NF_CRDPRES]	-= aNfItem[nX][IT_CRPRESC]
		aNfCab[NF_CRDPRES]	-= aNfItem[nX][IT_CRPREMG]
		aNfCab[NF_CRDPRES]	-= aNfItem[nX][IT_CRPRECE]
		aNfCab[NF_VALII]	-= aNfItem[nX][IT_VALII]
		aNfCab[NF_CRPREPE]	-= aNfItem[nX][IT_CRPREPE]
		aNfCab[NF_VALFAB] 	-= aNfItem[nX][IT_VALFAB]
		aNfCab[NF_VALFAC] 	-= aNfItem[nX][IT_VALFAC]
		aNfCab[NF_VALFUM]	-= aNfItem[nX][IT_VALFUM]
		aNfCab[NF_VLSENAR]	-= aNfItem[nX][IT_VLSENAR]
		aNfCab[NF_CROUTSP]	-= aNfItem[nX][IT_CROUTSP]
		aNfCab[NF_BSSEMDS]	-= aNfItem[nX][IT_BSSEMDS]
		aNfCab[NF_ICSEMDS]	-= aNfItem[nX][IT_ICSEMDS]
		aNfCab[NF_BASEFUN]	-= aNfItem[nX][IT_BASEFUN]
		aNfCab[NF_VLINCMG]	-= aNfItem[nX][IT_VLINCMG]
		aNfCab[NF_TOTAL]	-= aNfItem[nX][IT_VLINCMG]
		aNfCab[NF_VFECPRN]	-= aNfItem[nX][IT_VFECPRN]
		aNfCab[NF_VFESTRN]	-= aNfItem[nX][IT_VFESTRN]
		aNfCab[NF_CREDPRE]	-= aNfItem[nX][IT_CREDPRE]
		aNfCab[NF_VFECPMG]	-= aNfItem[nX][IT_VFECPMG]
		aNfCab[NF_VFESTMG]	-= aNfItem[nX][IT_VFESTMG]
		aNfCab[NF_VREINT]	-= aNfItem[nX][IT_VREINT]
		aNfCab[NF_BSREIN]	-= aNfItem[nX][IT_BSREIN]
		aNfCab[NF_VFECPMT]	-= aNfItem[nX][IT_VFECPMT]
		aNfCab[NF_VFESTMT]	-= aNfItem[nX][IT_VFESTMT]
		aNfCab[NF_ISSABMT] 	-= aNfItem[nX][IT_ABMATISS]
		aNfCab[NF_ISSABSR]	-= aNfItem[nX][IT_ABVLISS]
		aNfCab[NF_INSABMT]	-= aNfItem[nX][IT_AVLINSS]
		aNfCab[NF_INSABSR]	-= aNfItem[nX][IT_ABVLINSS]
		aNfCab[NF_VALTPDP]  -= aNfItem[nX][IT_VALTPDP]
		aNfCab[NF_BASTPDP]  -= aNfItem[nX][IT_BASTPDP]
	EndIf
	//Inclui a linha para inclusao de Impostos.
	If aNfCab[NF_INSIMP]
		If aScan(aNfCab[NF_IMPOSTOS],{|x| x[6] == "NEW"  }) == 0
			aadd(aNfCab[NF_IMPOSTOS],{'...','  ',0,0,0,'NEW'})
		EndIf
		If aScan(aNfCab[NF_IMPOSTOS2],{|x| x[5] == "NEW"  }) == 0
			aadd(aNfCab[NF_IMPOSTOS2],{'...','  ',0,0,'NEW'})
		EndIf
	EndIf
	// Montagem do array NF_IMPOSTOS contando o rodape e todos os impostos calculados
	// ICMS,IPI,INSS,ICMS RETIDO,ICMS COMP,ISS,IR    Impostos Argentina,Chile,Etc
	If cPaisLoc == "BRA"
		
		MaFisTes(aNfItem[nX][IT_TES],aNfItem[nX][IT_RECNOSF4],nX)
		
		If (aNfItem[nX][IT_BASEICM]<>0 .Or. aNfItem[nX][IT_VALICM]<>0) .And. aNfItem[nX][IT_VALISS] == 0;
			.And. !((aNFCab[NF_SIMPNAC] =="1" .And. aTes[TS_COMPL] == "S" .And. aTes[TS_CIAP] == "S"))
			MaFisResumo(aNfItem[nX][IT_BASEICM],aNfItem[nX][IT_ALIQICM],aNfItem[nX][IT_VALICM],'ICM','ICMS','ICM',,,lSoma)
		EndIf
		If (aNfItem[nX][IT_BASEIPI]<>0 .Or. aNfItem[nX][IT_VALIPI]<>0) 
			MaFisResumo(aNfItem[nX][IT_BASEIPI],aNfItem[nX][IT_ALIQIPI],aNfItem[nX][IT_VALIPI],'IPI','IPI ','IPI',,,lSoma)
		EndIf
		If aNfItem[nX][IT_BASEICA]<>0 .Or. aNfItem[nX][IT_VALICA]<>0
			MaFisResumo(aNfItem[nX][IT_BASEICA],aNfItem[nX][IT_ALIQICM],aNfItem[nX][IT_VALICA],'ICA','ICMS ref. Frete Autonomo','ICA',,,lSoma)
		EndIf
		If aNfItem[nX][IT_BASETST]<>0 .Or. aNfItem[nX][IT_VALTST]<>0
			MaFisResumo(aNfItem[nX][IT_BASETST],aNfItem[nX][IT_ALIQTST],aNfItem[nX][IT_VALTST],'TST','ICMS ref. Frete Autonomo - ST','TST',,,lSoma)
		EndIf
		If aNfItem[nX][IT_BASESOL]<>0 .Or. aNfItem[nX][IT_VALSOL]<>0
			MaFisResumo(aNfItem[nX][IT_BASESOL],aNfItem[nX][IT_ALIQSOL],aNfItem[nX][IT_VALSOL],'ICR','ICMS Retido ','SOL',,,lSoma)
		EndIf
		If aNfItem[nX][IT_VALCMP]<>0
			MaFisResumo(aNfItem[nX][IT_BASEICM],aNfItem[nX][IT_ALIQCMP],aNfItem[nX][IT_VALCMP],'ICC','ICMS Complementar ','CMP',,,lSoma)
		EndIf
		If aNfItem[nX][IT_BASEISS]<>0 .Or. aNfItem[nX][IT_VALISS]<>0
			MaFisResumo(aNfItem[nX][IT_BASEISS],aNfItem[nX][IT_ALIQISS],aNfItem[nX][IT_VALISS],'ISS','ISS Imposto sobre servico ','ISS',,,lSoma)
		EndIf
		If aNfItem[nX][IT_BASEIRR]<>0 .Or. aNfItem[nX][IT_VALIRR]<>0
			MaFisResumo(aNfItem[nX][IT_BASEIRR],aNfItem[nX][IT_ALIQIRR],aNfItem[nX][IT_VALIRR],'IRR','IRRF Imposto de renda ','IRR',,,lSoma)
		EndIf
		If aNfItem[nX][IT_BASEINS]<>0 .Or. aNfItem[nX][IT_VALINS]<>0
			MaFisResumo(aNfItem[nX][IT_BASEINS],aNfItem[nX][IT_ALIQINS],aNfItem[nX][IT_VALINS],'INS','INSS ','INS',,,lSoma)
		Endif
		If aNfItem[nX][IT_BASEINA]<>0 .Or. aNfItem[nX][IT_VALINA]<>0
			MaFisResumo(aNfItem[nX][IT_BASEINA],aNfItem[nX][IT_ALIQINA],aNfItem[nX][IT_VALINA],'INA','INSS Condições Especiais ','INA',,,lSoma)
		EndIf
		If aNfItem[nX][IT_BASEPIS]<>0 .Or. aNfItem[nX][IT_VALPIS]<>0
			MaFisResumo(aNfItem[nX][IT_BASEPIS],aNfItem[nX][IT_ALIQPIS],aNfItem[nX][IT_VALPIS],'PIS','PIS - Via Retençao','PIS',.T.,.T.,lSoma)
		EndIf
		If aNfItem[nX][IT_BASECOF]<>0 .Or. aNfItem[nX][IT_VALCOF]<>0
			MaFisResumo(aNfItem[nX][IT_BASECOF],aNfItem[nX][IT_ALIQCOF],aNfItem[nX][IT_VALCOF],'COF','COFINS - Via Retenção','COF',.T.,.T.,lSoma)
		EndIf
		If aNfItem[nX][IT_BASECSL]<>0 .Or. aNfItem[nX][IT_VALCSL]<>0
			MaFisResumo(aNfItem[nX][IT_BASECSL],aNfItem[nX][IT_ALIQCSL],aNfItem[nX][IT_VALCSL],'CSL','CSLL - Via Retenção','CSL',.T.,.T.,lSoma)
		EndIf
		If aNfItem[nX][IT_BASEFUN]<>0 .Or. aNfItem[nX][IT_FUNRURAL]<>0
			MaFisResumo(aNfItem[nX][IT_BASEFUN],aNfItem[nX][IT_PERFUN],aNfItem[nX][IT_FUNRURAL],'FRU','FUNRURAL ','RUR',.T.,.T.,lSoma)
		EndIf
		If (aNfItem[nX,IT_BASEPS2]<>0 .Or. aNfItem[nX,IT_VALPS2]<>0) .And. (aNFCab[NF_CLIFOR] =="F" .And. aNFCab[NF_TPCLIFOR] =="X" .And. Substr(aNfItem[nX,IT_CF],1,1)=="3" .And. aTes[TS_INTBSIC]$"123")
			MaFisResumo(aNfItem[nX,IT_BASEPS2],aNfItem[nX,IT_ALIQPS2],aNfItem[nX,IT_VALPS2],'PS2',Iif(aTes[TS_ALQPMAJ]>0,'PIS - Importacao + Majorada','PIS - Importacao'),'PS2',,,lSoma)
		ElseIf (aNfItem[nX,IT_BASEPS2]<>0 .Or. aNfItem[nX,IT_VALPS2]<>0) .And.;
			((aNFCab[NF_OPERNF] == "E" .And. aNFCab[NF_CLIFOR] =="F" .And. aNFCab[NF_TPCLIFOR] =="X" .And. Substr(aNfItem[nX,IT_CF],1,1)=="3" .And. aTes[TS_INTBSIC]$"123") .Or.;
			(aNFCab[NF_OPERNF] == "S" .And. aNFCab[NF_CLIFOR] =="F" .And. aNFCab[NF_TPCLIFOR] =="X" .And. Substr(aNfItem[nX,IT_CF],1,1)=="7" .And. aTes[TS_INTBSIC]$"123"))
			MaFisResumo(aNfItem[nX,IT_BASEPS2],aNfItem[nX,IT_ALIQPS2],aNfItem[nX,IT_VALPS2],'PS2','PIS/Pasep - Importacao','PS2',,,lSoma)
		Elseif Len(aNFItem[nX,IT_EXCECAO]) > 0 .And. !Empty(aNFItem[nX,IT_EXCECAO,10])
			MaFisResumo(aNfItem[nX,IT_BASEPS2],aNFItem[nX,IT_EXCECAO,10],aNfItem[nX,IT_VALPS2],'PS2','PIS/Pasep - Via apuracao','PS2',,,lSoma)
		Elseif aNfItem[nX][IT_PRD][SB_VLR_PIS] <> 0 .And. aNfItem[nX,IT_VALPS2]<>0
			MaFisResumo(aNfItem[nX,IT_BASEPS2],aNfItem[nX][IT_PRD][SB_VLR_PIS],aNfItem[nX,IT_VALPS2],'PS2','PIS/Pasep - Via apuracao','PS2',,,lSoma)
		ElseIf aNfItem[nX,IT_BASEPS2]<>0 .Or. aNfItem[nX,IT_VALPS2]<>0
			MaFisResumo(aNfItem[nX,IT_BASEPS2],aNfItem[nX,IT_ALIQPS2],aNfItem[nX,IT_VALPS2],'PS2','PIS/Pasep - Via apuracao','PS2',,,lSoma)
		EndIf
		If (aNfItem[nX,IT_BASECF2]<>0 .Or. aNfItem[nX,IT_VALCF2]<>0) .And. (aNFCab[NF_CLIFOR] =="F" .And. aNFCab[NF_TPCLIFOR] =="X" .And. Substr(aNfItem[nX,IT_CF],1,1)=="3" .And. aTes[TS_INTBSIC]$"123")
			MaFisResumo(aNfItem[nX,IT_BASECF2],aNfItem[nX,IT_ALIQCF2],aNfItem[nX,IT_VALCF2],'CF2',Iif(aTes[TS_ALQCMAJ]>0,'COFINS - Importacao + Majorada','COFINS - Importacao'),'CF2',,,lSoma)
		Elseif Len(aNFItem[nX,IT_EXCECAO]) > 0 .And. !Empty(aNFItem[nX,IT_EXCECAO,11])
			MaFisResumo(aNfItem[nX,IT_BASECF2],aNFItem[nX,IT_EXCECAO,11],aNfItem[nX,IT_VALCF2],'CF2','COFINS - Via apuracao','CF2',,,lSoma)
		Elseif aNfItem[nX][IT_PRD][SB_VLR_COF] <> 0 .And. aNfItem[nX,IT_VALCF2]<>0
			MaFisResumo(aNfItem[nX,IT_BASECF2],aNfItem[nX][IT_PRD][SB_VLR_COF],aNfItem[nX,IT_VALCF2],'CF2','COFINS - Via apuracao','CF2',,,lSoma)
		ElseIf aNfItem[nX,IT_BASECF2]<>0 .Or. aNfItem[nX,IT_VALCF2]<>0
			MaFisResumo(aNfItem[nX,IT_BASECF2],aNfItem[nX,IT_ALIQCF2],aNfItem[nX,IT_VALCF2],'CF2','COFINS - Via apuracao','CF2',,,lSoma)
		EndIf
		If aNfItem[nx][IT_BASEAFRMM]<>0 .Or. aNfItem[nx][IT_VALAFRMM]<>0
			MaFisResumo(aNfItem[nx][IT_BASEAFRMM],aNfItem[nx][IT_ALIQAFRMM],aNfItem[nx][IT_VALAFRMM],'AFRMM','AFRMM','AFRMM',,,lSoma)
		EndIf
		If aNfItem[nX][IT_BASESES]<>0 .Or. aNfItem[nX][IT_VALSES]<>0
			MaFisResumo(aNfItem[nX][IT_BASESES],aNfItem[nX][IT_ALIQSES],aNfItem[nX][IT_VALSES],'SES','SEST/SENAT','SES',,,lSoma)
		EndIf
		If aNfItem[nx][IT_BASEPS3]<>0 .Or. aNfItem[nx][IT_VALPS3]<>0
			MaFisResumo(aNfItem[nx][IT_BASEPS3],aNfItem[nx][IT_ALIQPS3],aNfItem[nx][IT_VALPS3],'PS3','PIS/Pasep - Subst. Tributaria','PS3',,,lSoma)
		EndIf
		If aNfItem[nx][IT_BASECF3]<>0 .Or. aNfItem[nx][IT_VALCF3]<>0
			MaFisResumo(aNfItem[nx][IT_BASECF3],aNfItem[nx][IT_ALIQCF3],aNfItem[nx][IT_VALCF3],'CF3','COFINS - Subst. Tributaria','CF3',,,lSoma)
		EndIf
		If aFieldPos[FP_B1_AFETHAB] .And. aFieldPos[FP_A2_RECFET] .And. aFieldPos[FP_A1_RECFET] .And. aFieldPos[FP_F4_CALCFET]
			If aNfItem[nx][IT_BASEFET]<>0 .Or. aNfItem[nx][IT_VALFET]<>0
				MaFisResumo(aNfItem[nx][IT_BASEFET],aNfItem[nx][IT_ALIQFET],aNfItem[nx][IT_VALFET],'FET','FETHAB','FET',.T.,.T.,lSoma)
			Endif
		EndIf
		If aFieldPos[FP_B1_AFABOV] .And. aFieldPos[FP_A2_RFABOV] .And. aFieldPos[FP_A1_RFABOV] .And. aFieldPos[FP_F4_CFABOV] 
			If aNfItem[nx][IT_BASEFAB]<>0 .Or. aNfItem[nx][IT_VALFAB]<>0
				MaFisResumo(aNfItem[nx][IT_BASEFAB],aNfItem[nx][IT_ALIQFAB],aNfItem[nx][IT_VALFAB],'FAB','FABOV','FAB',.T.,.T.,lSoma)
			Endif
		EndIf
		If aFieldPos[FP_B1_ALFUMAC]
			If aNfItem[nx][IT_BASEFUM]<>0 .And. aNfItem[nx][IT_VALFUM]<>0
				MaFisResumo(aNfItem[nx][IT_BASEFUM],aNfItem[nx][IT_ALIQFUM],aNfItem[nx][IT_VALFUM],'FUM','FUMACOP','FUM',.T.,.T.,lSoma)
			Endif
		EndIf
		If aFieldPos[FP_B1_AFACS] .And. aFieldPos[FP_A2_RFACS] .And. aFieldPos[FP_A1_RFACS] .And. aFieldPos[FP_F4_CFACS] 
			If aNfItem[nx][IT_BASEFAC]<>0 .Or. aNfItem[nx][IT_VALFAC]<>0
				MaFisResumo(aNfItem[nx][IT_BASEFAC],aNfItem[nx][IT_ALIQFAC],aNfItem[nx][IT_VALFAC],'FAC','FACS','FAC',.T.,.T.,lSoma)
			Endif
		EndIf
		If aNfItem[nX][IT_VALFDS] > 0
			MaFisResumo(0,0,aNfItem[nX][IT_VALFDS],'FDS','FUNDERSUL','FDS',.T.,.T.,lSoma)
		EndIf
		If aNfItem[nX][IT_BSSENAR]<>0 .Or. aNfItem[nX][IT_VLSENAR]<>0
			MaFisResumo(aNfItem[nX][IT_BSSENAR],aNfItem[nX][IT_ALSENAR],aNfItem[nX][IT_VLSENAR],'SENAR','SENAR','SENAR',.T.,.T.,lSoma)
		Endif
		If aParSX6[MV_ALITPDP] > 0 .And. aNfCab[NF_BASTPDP] >= 100
			If aNfItem[nX][IT_BASTPDP] <> 0 .And. aNfItem[nX][IT_VALTPDP] <> 0 .And. nX == Len(aNfItem)
				MaFisResumo(aNfCab[NF_BASTPDP],aNfItem[nX][IT_ALITPDP],aNfCab[NF_VALTPDP],'TPD','TPDP-PB','TPDP',.T.,.T.,lSoma)
			Endif
		EndIf
	Endif

	If cPaisLoc == "BRA" .Or. lNotRemito
		For nG := 1 To NMAXIV
			If aNfItem[nX][IT_BASEIMP][nG]<>0 .Or. aNfItem[nX][IT_VALIMP][nG]<>0
				MaFisResumo(aNfItem[nX][IT_BASEIMP][nG],aNfItem[nX][IT_ALIQIMP][nG],aNfItem[nX][IT_VALIMP][nG],aNfItem[nX][IT_DESCIV][nG][1],aNfItem[nX][IT_DESCIV][nG][2],"IV"+NumCpoImpVar(nG),,,lSoma)
			EndIf
		Next nG
		
		MaFisLFToLivro(nX,@aAuxOri,lSoma)
	EndIf
	
	If !lSoma // Executa a correcao nos arredondamentos.
		For nY := 1 to Len(aItemRef)
			If aItemRef[nY][4]
				If !aItemRef[nY][5]
					If ValType(aItemRef[nY][2]) == "A"
						aNfItem[nX][aItemRef[nY][2][1]][aItemRef[nY][2][2]] += aItemDec[nX][2][nY]
						aNfItem[nX][aItemRef[nY][2][1]][aItemRef[nY][2][2]] -= aItemDec[nX][1][nY]
					Else
						aNfItem[nX][Val(aItemRef[nY][2])] += aItemDec[nX][2][nY]
						aNfItem[nX][Val(aItemRef[nY][2])] -= aItemDec[nX][1][nY]
					EndIf
					aSaveDec[nY] += aItemDec[nX][1][nY]
					aSaveDec[nY] -= aItemDec[nX][2][nY]
				Else
					If ValType(aItemRef[nY][2]) == "A"
						aNfItem[nX][aItemRef[nY][2][1]][aItemRef[nY][2][2]] -= aItemDec[nX][2][nY]
						aNfItem[nX][aItemRef[nY][2][1]][aItemRef[nY][2][2]] += aItemDec[nX][1][nY]
					Else
						aNfItem[nX][Val(aItemRef[nY][2])] -= aItemDec[nX][2][nY]
						aNfItem[nX][Val(aItemRef[nY][2])] += aItemDec[nX][1][nY]
					EndIf
					If !(!Empty(cCampo) .And. cCampo == aItemRef[nY][1])
						aSaveDec[nY] += aItemDec[nX][1][nY]
						aSaveDec[nY] -= aItemDec[nX][2][nY]
					EndIf
				EndIf
				aItemDec[nX][1][nY]:= 0
				aItemDec[nX][2][nY]:= 0
			EndIf
		Next nY
	EndIf
		
	If aExistPE[PE_MXTOTIT]
		// PE para manipulação dos valores das referencias (em uso na importação TSF)
		// nesse ponto passa 0 para aplicar regra somente para o cabecalho
		ExecBlock("MXTOTIT",.F.,.F.,{0})
	EndIf
	
EndIf

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisResum³ Autor ³ Edson Maricate        ³ Data ³13.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Atualiza o Array de Resumos da NF.                          ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisResumo(nValBase,nAliquota,nValor,cCodImp,cDescImp,cNomeRef,lForceVlr,lForceBs,lSoma)

Local nRS  := 0
Local nRS2 := 0

DEFAULT lForceVlr := .F.
DEFAULT lForceBs  := .F.
DEFAULT lSoma	  := .T.

If Empty(cCodImp)
	Return	.F.
Endif

If !Empty(aNfCab[NF_IMPOSTOS]) .And. aNfCab[NF_IMPOSTOS][1][1] == ""
	aNfCab[NF_IMPOSTOS] := {}
	aNfCab[NF_IMPOSTOS2]:= {}
Else
	nRS	:= aScan(aNfCab[NF_IMPOSTOS] ,{|x| x[IMP_COD] == cCodImp .And. x[IMP_ALIQ] == nAliquota })
	nRS2:= aScan(aNfCab[NF_IMPOSTOS2],{|x| x[IMP_COD] == cCodImp })
EndIf

If aNfCab[NF_RELIMP] <> Nil .And. !Empty(aNfCab[NF_RELIMP])
	nValBase := IIf( aScan(aNfCab[NF_RELIMP] , {|x|"BASE" + cNomeRef $ x[3] } ) > 0 .Or. lForceBs  , nValBase , 0 )
	nValor	 := IIf( aScan(aNfCab[NF_RELIMP] , {|x|"VAL"  + cNomeRef $ x[3] } ) > 0 .Or. lForceVlr , nValor   , 0 )
EndIf

If cPaisLoc == "CHI" .And. aParSX6[MV_PRCDEC]
	aNfCab[NF_TOTAL]   := Round(aNfCab[NF_TOTAL]   , MsDecimais(aNFCab[NF_MOEDA]))
	aNfCab[NF_VALMERC] := Round(aNfCab[NF_VALMERC] , MsDecimais(aNFCab[NF_MOEDA]))
	aNfCab[NF_BASEDUP] := Round(aNfCab[NF_BASEDUP] , MsDecimais(aNFCab[NF_MOEDA]))
	nValor   		   := Round(nValor             , MsDecimais(aNFCab[NF_MOEDA]))
ElseIf cPaisLoc == "ANG" .And. aParSX6[MV_RNDANG] //Arredondamento do valor total da nota de acordo com MV_RNDANG para localizado Angola
	aNfCab[NF_TOTAL]   := int(aNfCab[NF_TOTAL]  ) + IIf( aNfCab[NF_TOTAL]   - int(aNfCab[NF_TOTAL]  )  >= 0.01 , 1.0 , 0.0 )
	aNfCab[NF_BASEDUP] := int(aNfCab[NF_BASEDUP]) + IIf( aNfCab[NF_BASEDUP] - int(aNfCab[NF_BASEDUP])  >= 0.01 , 1.0 , 0.0 )
EndIf

If lSoma

	If nRS > 0
		aNfCab[NF_IMPOSTOS][nRS][IMP_BASE] 	+= nValBase
		aNfCab[NF_IMPOSTOS][nRS][IMP_VAL]  	+= nValor
	Else
		aadd(aNfCab[NF_IMPOSTOS],{cCodImp,cDescImp,nValBase,nAliquota,nValor,cNomeRef})
	EndIf
	
	If nRS2 > 0
		If cPaisLoc $ "CHI" .And. aParSX6[MV_PRCDEC]
			aNfCab[NF_IMPOSTOS2][nRS2][3] 	+= Round(nValBase,MsDecimais(aNFCab[NF_MOEDA]))
			aNfCab[NF_IMPOSTOS2][nRS2][4] 	+= Round(nValor,MsDecimais(aNFCab[NF_MOEDA]))
		Else
			aNfCab[NF_IMPOSTOS2][nRS2][3] 	+= nValBase
			aNfCab[NF_IMPOSTOS2][nRS2][4] 	+= nValor
		EndIf
	Else
		If cPaisLoc == "CHI" .And. aParSX6[MV_PRCDEC]
			aadd(aNfCab[NF_IMPOSTOS2],{cCodImp,cDescImp,Round(nValBase,MsDecimais(aNFCab[NF_MOEDA])),Round(nValor,MsDecimais(aNFCab[NF_MOEDA])),cNomeRef})
		Else
			aadd(aNfCab[NF_IMPOSTOS2],{cCodImp,cDescImp,nValBase,nValor,cNomeRef})
		EndIf
	EndIf

Else

	If nRS > 0
		aNfCab[NF_IMPOSTOS][nRS][IMP_BASE] 	-= nValBase
		aNfCab[NF_IMPOSTOS][nRS][IMP_VAL]  	-= nValor
		If  aNfCab[NF_IMPOSTOS][nRS][IMP_BASE] <= 0 .And. aNfCab[NF_IMPOSTOS][nRS][IMP_VAL] <= 0
			aDel(aNfCab[NF_IMPOSTOS],nRS)
			aSize(aNfCab[NF_IMPOSTOS],Len(aNfCab[NF_IMPOSTOS])-1)
		EndIf
	EndIf
	
	If nRS2 > 0
		aNfCab[NF_IMPOSTOS2][nRS2][3] 	-= nValBase
		aNfCab[NF_IMPOSTOS2][nRS2][4] 	-= nValor
		If  aNfCab[NF_IMPOSTOS2][nRS2][3] <= 0 .And. aNfCab[NF_IMPOSTOS2][nRS2][4] <= 0
			aDel(aNfCab[NF_IMPOSTOS2],nRS2)
			aSize(aNfCab[NF_IMPOSTOS2],Len(aNfCab[NF_IMPOSTOS2])-1)
		EndIf
	EndIf

EndIf

Return .T.

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡…o    ³MaFisLFToLivro³ Autor ³ Edson Maricate    ³ Data ³07.03.2000³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Adiciona o item nos livros fiscais                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATXFIS                                                    ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Static Function MaFisLFToLivro(nItem,aNotasOri,lSoma)

Local alAreaX  := {}
Local aGetBook := {}
Local aSFB     := {}
Local aSFC     := {}
Local aSF4     := {}

Local cAux     := ""
Local cIdent   := ""
Local cNFOri   := ""
Local cObs     := ""

Local nLF      := 0
Local nY       := 0
Local nX       := 0
Local nS	   := 0

Local dDataEmi := dDataBase

Local lImport  := Type("lFacImport") == "L" .And. lFacImport
Local lFildPSWN:= aFieldPos[FP_WN_TES] .And. aFieldPos[FP_WN_ITEMNF]
Local lAchouWN := .F.

DEFAULT lSoma  := .T.

If aNfItem[nItem][IT_TES] <> aTes[TS_CODIGO]
	MaFisTes(aNfItem[nItem,IT_TES],aNfItem[nItem,IT_RECNOSF4],nItem)
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Montagem dos Livros Fiscals ( aLivro )³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If cPaisLoc == "BRA"
	If 	aNfItem[nItem][IT_LIVRO][3] +;
		aNfItem[nItem][IT_LIVRO][4] +;
		aNfItem[nItem][IT_LIVRO][5] +;
		aNfItem[nItem][IT_LIVRO][6] +;
		aNfItem[nItem][IT_LIVRO][7] +;
		aNfItem[nItem][IT_LIVRO][9] +;
		aNfItem[nItem][IT_LIVRO][10]+;
		aNfItem[nItem][IT_LIVRO][11]+;
		aNfItem[nItem][IT_LIVRO][27] <> 0 .Or. !Empty(aNfItem[nItem][IT_LIVRO][24])
		
		If aNfItem[nItem][IT_CALCISS] == "S"
			nLF	:= aScan(aNfCab[NF_LIVRO],{|x|x[LF_CFO] == aNfItem[nItem][IT_LIVRO][LF_CFO] .And. ;
			x[LF_CODISS]  == aNfItem[nItem][IT_LIVRO][LF_CODISS]  .And. ;
			x[LF_ALIQICMS]== aNfItem[nItem][IT_LIVRO][LF_ALIQICMS].And. ;
			x[LF_NFLIVRO] == aNfItem[nItem][IT_LIVRO][LF_NFLIVRO] .And. ;
			x[LF_FORMULA] == aNfItem[nItem][IT_LIVRO][LF_FORMULA] .And. ;
			x[LF_ANTICMS] == aNfItem[nItem][IT_LIVRO][LF_ANTICMS] .And. ;
			x[LF_CFPS]    == aNfItem[nItem][IT_LIVRO][LF_CFPS]})
		Else
			nLF	:= aScan(aNfCab[NF_LIVRO],{|x|x[LF_CFO] == aNfItem[nItem][IT_LIVRO][LF_CFO] .And. ;
			x[LF_CFOEXT]  == aNfItem[nItem][IT_LIVRO][LF_CFOEXT]  .And. ;
			x[LF_ALIQICMS]== aNfItem[nItem][IT_LIVRO][LF_ALIQICMS].And. ;
			x[LF_NFLIVRO] == aNfItem[nItem][IT_LIVRO][LF_NFLIVRO] .And. ;
			x[LF_FORMULA] == aNfItem[nItem][IT_LIVRO][LF_FORMULA] .And. ;
			x[LF_CODISS]  == aNfItem[nItem][IT_LIVRO][LF_CODISS]  .And. ;
			x[LF_ANTICMS] == aNfItem[nItem][IT_LIVRO][LF_ANTICMS] .And. ;
			x[LF_CREDACU] == aNfItem[nItem][IT_LIVRO][LF_CREDACU] .And. ;
			x[LF_CFPS]    == aNfItem[nItem][IT_LIVRO][LF_CFPS]})
		EndIf

		cIdent := StrZero(nLF,6)

		If nLF == 0

			aNotasOri := {}
			aadd( aNfCab[NF_LIVRO] , MaFisRetLF() )
			nLF	:= Len(aNfCab[NF_LIVRO])

			aNfCab[NF_LIVRO][nLF][LF_CFO]     := aNfItem[nItem][IT_LIVRO][LF_CFO]
			aNfCab[NF_LIVRO][nLF][LF_CFOEXT]  := aNfItem[nItem][IT_LIVRO][LF_CFOEXT]
			aNfCab[NF_LIVRO][nLF][LF_ALIQICMS]:= aNfItem[nItem][IT_LIVRO][LF_ALIQICMS]
			aNfCab[NF_LIVRO][nLF][LF_NFLIVRO] := aNfItem[nItem][IT_LIVRO][LF_NFLIVRO]
			aNfCab[NF_LIVRO][nLF][LF_FORMULA] := aNfItem[nItem][IT_LIVRO][LF_FORMULA]
			aNfCab[NF_LIVRO][nLF][LF_TIPO]    := aNfItem[nItem][IT_LIVRO][LF_TIPO]
			aNfCab[NF_LIVRO][nLF][LF_CODISS]  := aNfItem[nItem][IT_LIVRO][LF_CODISS]
			aNfCab[NF_LIVRO][nLF][LF_FORMUL]  := aNfItem[nItem][IT_LIVRO][LF_FORMUL]
			aNfCab[NF_LIVRO][nLF][LF_ISSST]   := aNfItem[nItem][IT_LIVRO][LF_ISSST]
			aNfCab[NF_LIVRO][nLF][LF_RECISS]  := aNfItem[nItem][IT_LIVRO][LF_RECISS]
			aNfcab[NF_LIVRO][nLF][LF_CREDST]  := aNfItem[nItem][IT_LIVRO][LF_CREDST]
			aNfcab[NF_LIVRO][nLF][LF_CNAE]    := aNfItem[nItem][IT_LIVRO][LF_CNAE]
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³  Inconsistencia descoberta no SIGALOJA quanto utiliza-se                             ³
			//³  MAFISALT depois de carregar todos os itens do cupom, onde necessita-se              ³
			//³  alterar centavos para manter o calculo da impressora igual ao do sistema.           ³
			//³  Esta condicao determina que o codigo indentificador de relacionamento ??_IDENT      ³
			//³  seja reutilizado do IT_ para o NF_ depois de ter passado pelo aDEL abaixo, onde     ³
			//³  exclui o indice do array que possui os valores zerados, porem nao exluir do aNFITEM ³
			//³  O retorno do codigo identificador foi implementado pelo For/Next de nX abaixo       ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If IsInCallStack("LJXCONFICM") .And. aScan(aNfcab[NF_LIVRO] , {|x| Alltrim(x[LF_IDENT]) == StrZero(nLF,6)}) > 0 //SIGALOJA
				For nX := 1 To Len(aNfcab[NF_LIVRO]) + 1
					If aScan(aNfcab[NF_LIVRO], {|x| x[LF_IDENT] == StrZero(nX,6)}) == 0
						Exit
					EndIf
				Next nX
				aNfcab[NF_LIVRO][nLF][LF_IDENT]:= StrZero(nX,6)
			Else
				aNfcab[NF_LIVRO][nLF][LF_IDENT]:= StrZero(nLF,6)
			EndIf
			cIdent := aNfcab[NF_LIVRO][nLF][LF_IDENT]
			
			aNfCab[NF_LIVRO][nLF][LF_CFPS]   := aNfItem[nItem][IT_LIVRO][LF_CFPS]
			aNfCab[NF_LIVRO][nLF][LF_ALIQIPI]:= aNfItem[nItem][IT_LIVRO][LF_ALIQIPI]
			aNfCab[NF_LIVRO][nLF][LF_ALIQCF3]:= aNfItem[nItem][IT_LIVRO][LF_ALIQCF3]
			aNfCab[NF_LIVRO][nLF][LF_ALIQPS3]:= aNfItem[nItem][IT_LIVRO][LF_ALIQPS3]
			aNfCab[NF_LIVRO][nLF][LF_ANTICMS]:= aNfItem[nItem][IT_LIVRO][LF_ANTICMS]
			aNfCab[NF_LIVRO][nLF][LF_CREDACU]:= aNfItem[nItem][IT_LIVRO][LF_CREDACU]
			aNfCab[NF_LIVRO][nLF][LF_CSTISS] := aNfItem[nItem][IT_LIVRO][LF_CSTISS]
			aNfCab[NF_LIVRO][nLF][LF_MOTICMS]:= aNfItem[nItem][IT_LIVRO][LF_MOTICMS]
			aNfCab[NF_LIVRO][nLF][LF_TPPRODE]:= aNfItem[nItem][IT_LIVRO][LF_TPPRODE]
			aNfCab[NF_LIVRO][nLF][LF_VFECPMG]:= aNfItem[nItem][IT_LIVRO][LF_VFECPMG]
			aNfCab[NF_LIVRO][nLF][LF_VFESTMG]:= aNfItem[nItem][IT_LIVRO][LF_VFESTMG]
			aNfCab[NF_LIVRO][nLF][LF_VREINT] := aNfItem[nItem][IT_LIVRO][LF_VREINT]
			aNfCab[NF_LIVRO][nLF][LF_BSREIN] := aNfItem[nItem][IT_LIVRO][LF_BSREIN]
			aNfCab[NF_LIVRO][nLF][LF_VFECPMT]:= aNfItem[nItem][IT_LIVRO][LF_VFECPMT]
			aNfCab[NF_LIVRO][nLF][LF_VFESTMT]:= aNfItem[nItem][IT_LIVRO][LF_VFESTMT]
//			-> REMOVIDO TRATAMENTO DE CAMPOS DO FECOP RN NO CHAMADO THIBOA, NAO DEVE SER COLOCADO AQUI POIS O TRATAMENTO EH DINAMICO.
		EndIf

		For nY	:= 1 to Len(aNfCab[NF_LIVRO][nLf])
			If !AllTrim(StrZero(nY,3))$"001#002#012#015#016#018#020#023#024#031#032#033#036#042#043#044#045#046#047#048#051#052#053#058#061#070#075#076#077#081#088#094#095#096#097#098#099#100#103#107#108#109#110#113#114"
				If lSoma
					If Valtype(aNfItem[nItem][IT_LIVRO][nY])<>"A"
						aNfCab[NF_LIVRO][nLF][nY] += aNfItem[nItem][IT_LIVRO][nY]
					Else
						For nS := 1 To Len(aNfCab[NF_LIVRO][nLF][nY])
							aNfCab[NF_LIVRO][nLF][nY][nS] += aNfItem[nItem][IT_LIVRO][nY][nS]
						Next nS
					EndIf
				Else
					If Valtype(aNfItem[nItem][IT_LIVRO][nY])<>"A"
						aNfCab[NF_LIVRO][nLF][nY] -= aNfItem[nItem][IT_LIVRO][nY]
					Else
						For nS := 1 To Len(aNfCab[NF_LIVRO][nLF][nY])
							aNfCab[NF_LIVRO][nLF][nY][nS] += aNfItem[nItem][IT_LIVRO][nY][nS]
						Next nS
					EndIf
				EndIf
			EndIf
		Next nY

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Preenche a Observacao dos livros Fiscais³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		cNFOri := IIf(!Empty(aNfItem[nItem][IT_NFORI]),aNfItem[nItem][IT_NFORI]+"/"+aNfItem[nItem][IT_SERORI],"")
		If !Empty(cNFOri) .And. aScan(aNotasOri,cNFOri) == 0
			aadd(aNotasOri,cNFOri)
		EndIf
		cNFOri := IIf(Len(aNotasOri)>1,STR0009,cNFOri) //"DIVERSAS"
		
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Ponto de entrada para alteracao da mensagem quanto a devolucao³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If !Empty( aNotasOri )
			If aExistPE[PE_MAFISOBS]
				cNFOri := ExecBlock( "MAFISOBS", .F., .F., { cNfOri, AClone( aNotasOri ) } )
			EndIf
		EndIf
		
		Do Case
			Case aNfCab[NF_TIPONF]=="D"
				cObs := IIf( !Empty(cNFOri) , STR0011 + cNFOri , "" )      // "DEVOLUCAO N.F.:"
			Case aNfCab[NF_TIPONF]=="C" .And. aNfCab[NF_TPCOMP] == "F"
				cObs := STR0012                                             // "CONHEC. FRETE"
			Case aNfCab[NF_TIPONF]=="C" .And. aNfCab[NF_TPCOMP] == "D"
				cObs := STR0013                                             // "NF DESPESA"
			Case aNfCab[NF_TIPONF]=="C"
				If !Empty(aNfCab[NF_ESPECIE])
					cObs := STR0014 + "(" + aNfCab[NF_ESPECIE] + ")"+cNFOri // "COMPL.N.F.: "
				Else
					cObs := STR0014 + cNFOri                                 // "COMPL.N.F.: "
				EndIf
			Case aNfCab[NF_TIPONF] == "B".And. aTes[TS_PODER3] <> "R"
				cObs := IIf( !Empty(cNFOri) , STR0015 + cNFOri , "" )       // "N.F.ORIG.: "
			Case aNfCab[NF_TIPONF] == "P"
				cObs := STR0016 + cNFOri                                     // "COMPL.IPI N.F.: "
			Case aNfCab[NF_TIPONF] == "I"
				If "CIAP" $ Upper(cNFORi)
					cObs := ""                                               // ""
				Else
					cObs := IIf( aTes[TS_ISS]<>"N",STR0022,STR0017)+cNFOri  // "COMPL.ICMS N.F.: " OU "COMPL.ISS N.F.: "
				EndIf
			Case aNfCab[NF_TPCLIFOR] == "X" .And. aNfCab[NF_OPERNF] == "S"
				cObs := ""
				If !Empty(cNFOri)
					cObs := STR0018 + cNFOri                                // "EXPORTACAO-GE No.: "
				Endif
			Case aTes[TS_IPI]=="R"
				cObs := STR0019                                             // "AQUIS.COMERC.NAO-CONTRIB.IPI"
			Case aNfCab[NF_TIPONF] == "N" .And. aTes[TS_PODER3] == "D" .And. aTes[TS_CONSIND] <> "1"
				cObs := Iif( !Empty(cNfOri) , (STR0020+cNFOri) , "" )      // "Dev. Benef. N.F.ORIG.: "
			Case aNfCab[NF_FUNRURAL] > 0
				If aParSX6[MV_IMPCSS] == "S"                               // Imprime Contribuicao Seguridade Social
					cObs := STR0021 + Alltrim(Transform(aNfCab[NF_FUNRURAL],"@E 999,999,999.99")) //"CONT.SEG.SOCIAL: "
				Endif
			Case aTes[TS_OBSSOL] == "3"
				cObs := " ICMS GARANTIDO "
			Case aTes[TS_OBSSOL] == "4"
				cObs := " ICMS GARANTIDO INTEGRAL "
			Case aNfCab[NF_CREDPRE] > 0
				cObs := " CREDITO PRESUMIDO R$ " + Alltrim(Transform(aNfCab[NF_CREDPRE],"@E 999,999,999.99"))
			Case aNfCab[NF_TIPONF] == "N" .And. aTes[TS_PODER3] == "D" .And. aTes[TS_CONSIND] == "1"
				If !Empty(cNfOri)
					cObs := "CONSIG INDUS,NF " + cNFOri + "DE " + DtoC(SD2->D2_EMISSAO)
				EndIf
		EndCase
		
		aNfCab[NF_LIVRO][nLF][LF_OBSERV]   := cObs
		aNfItem[nItem][IT_LIVRO][LF_OBSERV]:= cObs
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Zera a coluna outras caso esteja menor que zero³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		aNfCab[NF_LIVRO,nLF,LF_OUTRICM] := Max(aNfCab[NF_LIVRO,nLF,LF_OUTRICM],0)
		aNfCab[NF_LIVRO,nLF,LF_OUTRIPI] := Max(aNfCab[NF_LIVRO,nLF,LF_OUTRIPI],0)
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Vinculo do item do livro com o cabecalho³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		aNfcab[NF_LIVRO][nLF][LF_IDENT]   := cIdent
		aNfItem[nItem][IT_LIVRO][LF_IDENT]:= cIdent

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Exclusao dos itens sem valor³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If 	aNfCab[NF_LIVRO][nLF][3]+;
			aNfCab[NF_LIVRO][nLF][4]+;
			aNfCab[NF_LIVRO][nLF][5]+;
			aNfCab[NF_LIVRO][nLF][6]+;
			aNfCab[NF_LIVRO][nLF][7]+;
			aNfCab[NF_LIVRO][nLF][9]+;
			aNfCab[NF_LIVRO][nLF][10]+; 
			aNfCab[NF_LIVRO][nLF][11]+;
			aNfCab[NF_LIVRO][nLF][27] == 0 .And. Empty(aNfCab[NF_LIVRO][nLF][LF_FORMULA])
			aDel(aNfCab[NF_LIVRO],nLF)
			aSize(aNfCab[NF_LIVRO],Len(aNfCab[NF_LIVRO])-1)
		EndIf
	EndIf
Else
	aSF4:=SF4->(GetArea())
	aSFB:=SFB->(GetArea())
	aSFC:=SFC->(GetArea())
	SFC->(DbSetOrder(2))
	SFB->(DbSetOrder(1))
	SF4->(DbSetOrder(1))
	SF4->(MsSeek(xFilial("SF4")+aNfItem[nItem][IT_TES]))
	If cPaisLoc $ "COL|URU|EQU"
		aImpVar:=Array(10)
	Else
		aImpVar:=Array(8)
	EndIf
	aImpVar[1] := aNfItem[nItem][IT_QUANT]
	If aNFCab[NF_OPERNF] == 'E' .Or. aParSX6[MV_DESCSAI]=='2'
		aImpVar[2] := (aNfItem[nItem][IT_VALMERC]-(aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT]) )/Max(aNfItem[nItem][IT_QUANT],1)
		aImpVar[3] := aNfItem[nItem][IT_VALMERC]-(aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT])
	Else
		aImpVar[2] := aNfItem[nItem][IT_PRCUNI]
		aImpVar[3] := aNfItem[nItem][IT_VALMERC]
	Endif
	If cPaisLoc == "MEX" 
		aImpVar[3] -= aNfItem[nItem][IT_ADIANT]
	EndIf 	
	aImpVar[4] := aNfItem[nItem][IT_FRETE]
	aImpVar[5] := aNfItem[nItem][IT_DESPESA] + aNfItem[nItem][IT_SEGURO] + Iif(cPaisLoc=="PTG",aNfItem[nItem][IT_DESNTRB]+aNfItem[nItem][IT_TARA],0)
	aImpVar[6] := {}
	aImpVar[7] := ""
	If cPaisLoc $ "COL"
		aImpVar[9] := aNfItem[nItem][IT_SEGURO]
	EndIf
	If cPaisLoc $ "URU|EQU|COL"
		aImpVar[8] := nItem
	Endif        
	
	If cPaisLoc $ "BOL | ARG"
    	aImpVar[8] := aNfItem[nItem][IT_CF]	
	EndIf  
	If cPaisLoc $ "COL"
    	aImpVar[10] := aNfItem[nItem][IT_CF]	
	EndIf	
	
	If aNfItem[nItem][IT_TES] <> aTes[TS_CODIGO]
		MaFisTes(aNfItem[nItem][IT_TES],aNfItem[nItem][IT_RECNOSF4],nItem)
	EndIf
	For nY := 1 to Len(aTes[TS_SFC])
		If (cPaisLoc <> "ARG".Or. aTes[TS_SFC][nY][SFC_IMPOSTO]<> "DUM") //Ignmorar o DUMMY
			lAchouWN:=.F.
			nImp:=NumCpoImpVar(RIGHT(Alltrim(aTes[TS_SFC][nY][SFB_CPOVREI]),1))
			aadd(aImpVar[6],Array(18))
			nX:=Len(aImpVar[6])
			//³ No caso abaixo o código do imposto (ISC,IGV,PIV,DIG) é gravado ³
			//³ na primeira posição do array aImpVar[6][nX], pois o mesmo é    ³
			//³ utilizado nas funções de formação dos livros fiscais GetBook,  ³
			//³ M460LIVR  e M100LIVR.										   ³
			//³ OBS. No caso do não localizado o valor do código do produto é  ³
			//³ é passado como parâmetro, porém não é utilizado.               ³
			
			If cPaisLoc $ "PER" .Or. cPaisLoc $ "COL"
				aImpVar[6][nX][1] := aTes[TS_SFC][nY][SFC_IMPOSTO]
			Else
				aImpVar[6][nX][1] :=aNfItem[nItem][IT_PRODUTO]
			EndIf
			aImpVar[6][nX][2] :=aNfItem[nItem][IT_ALIQIMP][nImp]
			aImpVar[6][nX][3] :=aNfItem[nItem][IT_BASEIMP][nImp]
			aImpVar[6][nX][4] :=aNfItem[nItem][IT_VALIMP][nImp]
			If (lImport)
				SD1->(MsSeek(xFilial("SD1")+SF1->F1_DOC+SF1->F1_SERIE+SF1->F1_FORNECE+SF1->F1_LOJA+aNfItem[nItem][IT_PRODUTO]))
				If SF1->F1_TIPO_NF$"5678"
					//Solicitação - Average FNC 152032 continuação FNC 147106
					//Se os campos existirem entro para verificar se estão preenchidos e buscar a referencia da TES na tabela SWN
					If lFildPSWN
						SWN->(DbSetOrder(2))
						If SWN->(MsSeek(xFilial("SWN")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA))
							While !SWN->(Eof()) .And.;
								(SWN->WN_FILIAL+SWN->WN_DOC+SWN->WN_SERIE+SWN->WN_FORNECE+SWN->WN_LOJA == xFilial("SWN")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA);
								//Se encontrar a referência do Item e a TES estiver preenchida pego a TES da SWN
								If SWN->WN_PRODUTO+SWN->WN_ITEMNF == SD1->D1_COD+SD1->D1_ITEM .And. !Empty(SWN->WN_TES)
									lAchouWN:=.T.
									SFC->(MsSeek(xFilial("SFC")+SWN->WN_TES+aTes[TS_SFC][nY][SFC_IMPOSTO]))
								EndIf
								SWN->(DbSkip())
							End
							//Senão encontrou deixo a referência que existia antes
							If !lAchouWN
								SYD->(MsSeek(xFilial("SYD")+SD1->D1_TEC))
								SFC->(MsSeek(xFilial("SFC")+SYD->YD_TES+aTes[TS_SFC][nY][SFC_IMPOSTO]))
							EndIf
						EndIf
					Else
						//Senão os campos não existirem deixo a referência que existia antes
						SYD->(MsSeek(xFilial("SYD")+SD1->D1_TEC))
						SFC->(MsSeek(xFilial("SFC")+SYD->YD_TES+aTes[TS_SFC][nY][SFC_IMPOSTO]))
					EndIf
				Else
					If aParSX6[MV_DESPSD1]=="S"
						SFC->(MsSeek(xFilial("SFC")+SD1->D1_TESDES+aTes[TS_SFC][nY][SFC_IMPOSTO]))
					Else
						//Solicitação - Average FNC 152032 continuação FNC 147106
						//Se os campos existirem entro para verificar se estão preenchidos e buscar a referencia da TES na tabela SWN
						If lFildPSWN
							SWN->(DbSetOrder(2))
							If SWN->(MsSeek(xFilial("SWN")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA))
								While !SWN->(Eof()) .And.;
									(SWN->WN_FILIAL+SWN->WN_DOC+SWN->WN_SERIE+SWN->WN_FORNECE+SWN->WN_LOJA == xFilial("SWN")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA);
									//Se encontrar a referência do Item e a TES estiver preenchida pego a TES da SWN
									If SWN->WN_PRODUTO+SWN->WN_ITEMNF == SD1->D1_COD+SD1->D1_ITEM .And. !Empty(SWN->WN_TES)
										lAchouWN:=.T.
										SFC->(MsSeek(xFilial("SFC")+SWN->WN_TES+aTes[TS_SFC][nY][SFC_IMPOSTO]))
									EndIf
									SWN->(DbSkip())
								End
								//Senão encontrou deixo a referência que existia antes
								If !lAchouWN
									SYD->(MsSeek(xFilial("SYD")+SD1->D1_TEC))
									SFC->(MsSeek(xFilial("SFC")+SYD->YD_TES+aTes[TS_SFC][nY][SFC_IMPOSTO]))
								EndIf
							EndIf
						Else
							//Senão os campos não existirem deixo a referência que existia antes
							SYD->(MsSeek(xFilial("SYD")+SD1->D1_TEC))
							SFC->(MsSeek(xFilial("SFC")+SYD->YD_TES+aTes[TS_SFC][nY][SFC_IMPOSTO]))
						EndIf
					Endif
				Endif
				SFB->(MsSeek(xFilial("SFB")+aTes[TS_SFC][nY][SFC_IMPOSTO]))
				cAux:=SFC->FC_INCDUPL+SFC->FC_INCNOTA+SFC->FC_CREDITA
				If IsAlpha(SFC->FC_INCDUPL)
					aImpVar[6][nX][5]:=IIf(Subs(cAux,1,2)=="SN".Or.Subs(cAux,1,2)=="NS","3",;
					IIf(Subs(cAux,1,2)=="SS","1","2"))
					aImpVar[6][nX][5]+=IIf(Subs(cAux,2,1)=="S" ,"1",IIf(Subs(cAux,2,1)=="R" ,"2","3"))
					aImpVar[6][nX][5]+=IIf(Subs(cAux,2,2)=="SN","1",IIf(Subs(cAux,2,2)=="NS","2","3"))
				Else
					aImpVar[6][nX][5]:=cAux
				EndIf
				aImpVar[6][nX][17]:=SFB->FB_CPOLVRO
			Else
				aImpVar[6][nX][5]:=	aTes[TS_SFC][nY][SFC_INCDUPL]+	aTes[TS_SFC][nY][SFC_INCNOTA]+	aTes[TS_SFC][nY][SFC_CREDITA]
				aImpVar[6][nX][17]:=Right(aTes[TS_SFC][nY][SFB_CPOVREI],1)
				aImpVar[6][nX][18]:= aTes[TS_SFC][nY][SFB_DESGR]
			Endif
		Endif
	Next nY
	If Type('dDEmissao') == "D" .And. !Empty(dDEmissao)
		dDataEmi	:=	dDEmissao
	Endif
	//³          TRATAMENTO EXPECIFICO PARA LOCALIZADO PERU                 ³
	//³ Quando o TES for referente ao imposto do IGV, o valor do IPM, o     ³
	//³ qual é uma porcentagem do IGV,o valor da base, aliquota e valor do  ³
	//³ imposto é gravado nos campos _BASIMP3, _ALQIMP3 e VALIMP3.          ³
	//³ O valor da base é a mesma utilizada para o cálculo do IGV.          ³
	//³ O valor da alíqutoa é proveniente de um paramêtro chamado           ³
	//³ MV_ALQIPM.                                                          ³
	//³ O valor do imposto é a multiplicação da base pelo valor da aliquota ³
	//³ NO CASO ABAIXO FOI INCLUIDA UMA CONDIçãO PARA O FLUXO POSSIBILITAR  ³
	//³ QUE O VALOR DOS CAMPOS _BASIMP3, _ALQIMP3 E _VALIMP3 SEJAM PREENCHI-³
	//³ DOS.																³
	
	If cPaisLoc == "PER" .And. ValType(aNfItem[nItem][IT_ALIQIMP][3]) == "N"
		alAreaX := GetArea()
		
		nImp:=3
		aadd(aImpVar[6],Array(17))
		nX:=Len(aImpVar[6])
		aImpVar[6][nX][1] := "IGV"
		aImpVar[6][nX][2] :=aNfItem[nItem][IT_ALIQIMP][nImp]
		aImpVar[6][nX][3] :=aNfItem[nItem][IT_BASEIMP][nImp]
		aImpVar[6][nX][4] :=aNfItem[nItem][IT_VALIMP][nImp]
		
		aImpVar[6][nX][5] := "333"
		aImpVar[6][nX][17]:= "3"
		
		RestArea(alAreaX)
	EndIf
	aNfCab[NF_LIVRO]:=GetBook(@aGetBook,aImpVar,If(aNfCab[NF_CLIFOR]=="C","V","C"),If(Type("nTaxa")=="N",nTaxa,If(Type("nTXMoeda")=="N",nTXMoeda,1)),aNfCab[NF_LIVRO],aNfCab[NF_OPERNF],lSoma,,,,,,dDataEmi)
	RestArea(aSF4)
	RestArea(aSFB)
	RestArea(aSFC)
EndIf

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³ MaFisLF  ³ Autor ³  Edson Maricate       ³ Data ³20.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Atualiza os livros fiscais para o item.                    ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisLF(nItem,lRecPreSt)

Local lConsumo		:= aTes[TS_CONSUMO] == "S"
Local lConsFinal    := IIf( aNfCab[NF_OPERNF] == "S" , aNfCab[NF_TPCLIFOR] == "F" , SM0->M0_PRODRUR == "F" .Or. SM0->M0_PRODRUR == "1" )
Local nRetVCtb		:= IIF(!aTes[TS_INCSOL]$"A,N,D",aNfItem[nItem][IT_VALSOL],0)
Local nDescIpi		:= IIf(aTes[TS_TPIPI]=="B" .Or. (aParSX6[MV_IPIBRUT]=="S" .And. aTes[TS_TPIPI] ==" "),(aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT])+IIf(aNfCab[NF_OPERNF] == "S",aNfItem[nItem][IT_DESCZF],-1*aNfItem[nItem][IT_DESCZF]),0)
Local cIPINaOBS     := aParSX6[MV_IPINOBS]  	//Primeiro S - IPI nao tributado //Segundo  S - IPI na Base do ICMS
Local lLFAgreg      := aParSX6[MV_LFAGREG] .And. aTes[TS_AGREG]=="N" .And. aTes[TS_TRFICM]=="2" //Indica se deve ser feita escrituracao, mesmo nao agregando valor ao total da nota.
Local nBICMOri      := aNfItem[nItem][IT_TOTAL]+;
IIf(aTes[TS_DESCOND] == "1" ,(aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT]), 0)+;
IIf(aTes[TS_AGREG]   == "N" .And. aTes[TS_TRFICM]=="2",aNfItem[nItem][IT_VALMERC],0)-;
IIf(aTes[TS_IPILICM] <> "1" .And. aTes[TS_IPI]<>"R"   ,aNfItem[nItem][IT_VALIPI] ,0)-;
IIf(aTes[TS_AGRRETC] == "1",0,nRetVCtb)-;
IIf(aTES[TS_DESPICM] == "2",aNfItem[nItem][IT_DESPESA],0)-;
IIf(aTES[TS_PSCFST] == "1" .And. aTES[TS_APSCFST] == "1",(aNfItem[nItem][IT_VALPS3]+aNfItem[nItem][IT_VALCF3]),0)

Local nBIPIOri      := aNfItem[nItem][IT_TOTAL]+IIf(aTes[TS_AGREG]=="N" .And. aTes[TS_TRFICM]=="2",aNfItem[nItem][IT_VALMERC],0)-;
IIf(aTes[TS_IPI]<>"R",aNfItem[nItem][IT_VALIPI],0) - nRetVCtb + nDescIPI - Iif(aTes[TS_AGREG]$"I|B" .And. aTes[TS_INCIDE] == "S",aNfItem[nItem][IT_VALICM],0)-If(aTes[TS_AGRPIS]=="1" .And. aTes[TS_PSCFST]<>"1",aNfItem[nItem,IT_VALPS2],0)-If(aTes[TS_AGRCOF]=="1" .And. aTes[TS_PSCFST]<>"1",aNfItem[nItem,IT_VALCF2],0)-;
IIf(aTES[TS_DESPIPI]=="N",aNfItem[nItem][IT_DESPESA],0)-;
IIf(aTES[TS_PSCFST] == "1" .And. aTES[TS_APSCFST] == "1",aNfItem[nItem][IT_VALPS3] + aNfItem[nItem][IT_VALCF3],0)-;
IIf(aTes[TS_AGRPIS]=="P" .And. aTes[TS_INTBSIC]$"123",aNfItem[nItem,IT_VALPS2],0)-If(aTes[TS_AGRCOF]=="C" .And. aTes[TS_INTBSIC]$"123",aNfItem[nItem,IT_VALCF2],0)+;
IIf(aNFCab[NF_TIPONF] $ "D" .And. aTes[TS_TPIPI]=="B",	aNfItem[nItem,IT_DESCZF],0)

Local nReduzICMS := aTes[TS_BASEICM]
Local nReduzIPI  := aTes[TS_BASEIPI]
Local cMvEstado  := aParSX6[MV_ESTADO]
Local lStfrete   :=aParSX6[MV_STFRETE] //Cod.Situação Tributaria para notas de conhecimento de frete
Local aRegra	 := {}
Local cMCSTIPI	 := aParSX6[MV_RCSTIPI] //Controle de Rastro IPI

Local cLeiteIn 	 := aParSX6[MV_PRODLEI]
Local cProdLeite := IIf((cAliasPROD)->(FieldPos(cLeiteIn)) > 0 , (cAliasPROD)->&(cLeiteIn) , "" )

Local aMaCstPiCo := {}

Local aImp       := {"","","","","","",0,0,0,0,0,0,0,"",0,0}
Local nImp       := 0
Local lLvrICM    := .F.
Local lLvrSol    := .F.
Local nBseISS    := 0
Local nCrdPresMG := Iif( aFieldPos[FP_B1_CRDPRES] .And. !Empty(aNfItem[nItem][IT_PRD][SB_CRDPRES]) , aNfItem[nItem][IT_PRD][SB_CRDPRES] , aTes[TS_CRDPRES] )
Local nDespesas  := 0

Default lRecPreSt:= .F. //-- Recalcula valor crédito presumido de substituicao tributária


If aTes[TS_CONSUMO] == " " // Garante se o produto na operacao eh material de consumo mesmo que na TES nao tenha sido informado
	If (aTes[TS_INCIDE] == "S" .Or. (aTes[TS_INCIDE] == "F" .And. aNFCab[NF_TPCLIFOR] == "F" .And. aNFCab[NF_CLIFOR] == "C" )) .And.;
		( Substr(aNfItem[nItem][IT_CF],2,3)$"91 /92 /97 " .Or. (Substr(aNfItem[nItem][IT_CF],2,2) $ "55" .And. Substr(aNfItem[nItem][IT_CF],4,1)<>" ")) .And. aTes[TS_IPI] <> "R"
		lConsumo := .T.
	Endif
EndIf

//Garanto a verificacao da Excecao Fiscal
If Empty(aNFitem[nItem][IT_EXCECAO] )
	MaExcecao(nItem)
Endif

If !Empty(aNFitem[nItem][IT_EXCECAO] )
	//Carrega a reducao da base do ICMS
	If aNfItem[nItem,IT_EXCECAO,14] > 0
		nReduzICMS := aNfItem[nItem,IT_EXCECAO,14]
	EndIf
	
	//Carrega a reducao da base do IPI
	If aNfItem[nItem,IT_EXCECAO,15] > 0
		nReduzIPI := aNfItem[nItem,IT_EXCECAO,15]
	EndIf
	
EndIf

aNfItem[nItem][IT_LIVRO] := aClone(MaFisRetLF())

If aTes[TS_LFICM] <> "N" .Or. aTes[TS_LFIPI] <> "N" .Or. aTes[TS_LFISS] $"TIO"
	If cPaisLoc == "BRA"
		If len(Alltrim(aNfitem[nItem][IT_CLASFIS])) < 3 
            If Empty(aNfitem[nItem][IT_CLASFIS]) .Or.;
					Empty(Substr(aNfitem[nItem][IT_CLASFIS],2,2)) .Or.;
					aNfitem[nItem][IT_CLASFIS] == aNfItem[nItem][IT_PRD][SB_ORIGEM] + aTes[TS_SITTRIB] .Or.;
					aNfitem[nItem][IT_CLASFIS] == "0" + aTes[TS_SITTRIB]
		
				If aParSX6[MV_STFRETE] .And. (AllTrim(aNFCab[NF_ESPECIE]) $ "CTR/CTE/CTA/CTF" .Or. "NFST"$AllTrim(aNFCab[NF_ESPECIE]))
					aNfitem[nItem][IT_CLASFIS] := "0" + aTes[TS_SITTRIB] // Comforme parecer da Consultoria Tributaria emitido no chamado SCSFW2
				Else
					aNfitem[nItem][IT_CLASFIS] := aNfItem[nItem][IT_PRD][SB_ORIGEM] + aTes[TS_SITTRIB]
				EndIf
			Endif	
		EndIf
		aNfItem[nItem][IT_LIVRO][LF_RECISS]   	:= aNfCab[NF_RECISS]
		aNfItem[nItem][IT_LIVRO][LF_ISSST]   	:= aTes[TS_ISSST]
		aNfItem[nItem][IT_LIVRO][LF_CFO] 		:= aNfItem[nItem][IT_CF]
		aNfItem[nItem][IT_LIVRO][LF_CFOEXT]    := aTes[TS_CFEXT]
		aNfItem[nItem][IT_LIVRO][LF_NFLIVRO]	:= aTes[TS_NRLIVRO]
		aNfItem[nItem][IT_LIVRO][LF_FORMULA]	:= aTes[TS_FORMULA]
		//
		aNfItem[nItem][IT_LIVRO][LF_CLASFIS]	:=	aNfItem[nItem][IT_CLASFIS]
		aNfItem[nItem][IT_LIVRO][LF_POSIPI]		:= 	aNfItem[nItem][IT_POSIPI] 
		//Troca CST no Rastro de IPI.
		If aNfItem[nItem][IT_BASEIPI] > 0 .Or. Empty(cMCSTIPI)
			aNfItem[nItem][IT_LIVRO][LF_CTIPI]	:= 	aTes[TS_CTIPI]
		Else
			aNfItem[nItem][IT_LIVRO][LF_CTIPI]:= cMCSTIPI
		EndIf
		aNfItem[nItem][IT_LIVRO][LF_CSTPIS]	:= 	aTes[TS_CSTPIS]
		aNfItem[nItem][IT_LIVRO][LF_CSTCOF]	:= 	aTes[TS_CSTCOF]
		
		If aExistPE[PE_MACSTPICO]
			aMaCstPiCo := ExecBlock("MaCstPiCo",.f.,.f.,{nItem,aNfItem[nItem][IT_PRODUTO],aNfItem[nItem][IT_TES],aNfCab[NF_CLIFOR],aNfCab[NF_CODCLIFOR],aNfCab[NF_LOJA],aNfCab[NF_OPERNF]})
			aNfItem[nItem][IT_LIVRO][LF_CSTPIS]	:= 	aMaCstPiCo[1]
			aNfItem[nItem][IT_LIVRO][LF_CSTCOF]	:= 	aMaCstPiCo[2]
		EndIf
		
		//Se atender condição do decreto 5602 o CST de PIS e da COFINS deverão ser de alíquota zero - 06
		If aNfItem[nItem][IT_TABNTRE] == "4313" .AND. Decret5602((aNfItem[nItem][IT_VALMERC]/ aNfItem[nItem][IT_QUANT]),aNfItem[nItem][IT_POSIPI],aNfItem[nItem][IT_CODNTRE])
			aNfItem[nItem][IT_LIVRO][LF_CSTPIS]	:= 	"06"
			aNfItem[nItem][IT_LIVRO][LF_CSTCOF]	:= 	"06"
		EndIF
		
		aNfItem[nItem][IT_LIVRO][LF_ESTOQUE]	:=	aTes[TS_ESTOQUE]
		aNfItem[nItem][IT_LIVRO][LF_DESPIPI]	:=	aTes[TS_DESPIPI]
		aNfItem[nItem][IT_LIVRO][LF_CFPS]	    :=	aNfItem[nItem][IT_CFPS]
		aNfItem[nItem][IT_RGESPST]				:=	aTes[TS_RGESPST]
		aNfItem[nItem][IT_LIVRO][LF_ANTICMS]	:=	aTes[TS_ANTICMS]
		aNfItem[nItem][IT_LIVRO][LF_CREDACU]	:=	aTes[TS_CREDACU]
		aNfItem[nItem][IT_LIVRO][LF_CSTISS]		:=  aTes[TS_CSTISS]
		aNfItem[nItem][IT_LIVRO][LF_MOTICMS]	:=	aTes[TS_MOTICMS]
		aNfItem[nItem][IT_LIVRO][LF_CODBCC]		:= 	aTes[TS_CODBCC]
		aNfItem[nItem][IT_LIVRO][LF_INDNTFR]	:= 	aTes[TS_INDNTFR]
		aNfItem[nItem][IT_LIVRO][LF_TABNTRE] 	:= aNfItem[nItem][IT_TABNTRE]
		aNfItem[nItem][IT_LIVRO][LF_CODNTRE] 	:= aNfItem[nItem][IT_CODNTRE]
		aNfItem[nItem][IT_LIVRO][LF_GRPNTRE] 	:= aNfItem[nItem][IT_GRPNTRE]
		aNfItem[nItem][IT_LIVRO][LF_DATNTRE] 	:= aNfItem[nItem][IT_DATNTRE]
		//Pegando o item da NF Original
		If aNFCab[NF_TIPONF] $ "DBC"
			If !Empty(aNFItem[nItem][IT_RECORI])
				If ( aNFCab[NF_CLIFOR] == "C" )
					dbSelectArea("SD2")
					MsGoto( aNFItem[nItem][IT_RECORI] )
					aNfItem[nItem][IT_LIVRO][LF_ITEMORI] 	:= SD2->D2_ITEM
					
					dbSelectArea("CD2")
					dbSetOrder(1)
					//A referencia IT_PREDIC diz respeito apenas aos registro de ICMS na tabela CD2, portanto devo procurar apenas os registros
					//de ICMS para buscar a reducao correta na origem.
					If MsSeek(xFilial("CD2")+"S"+SD2->(D2_SERIE+D2_DOC+D2_CLIENTE+D2_LOJA+PadR(D2_ITEM,TamSX3("CD2_ITEM")[1])+D2_COD)+PadR("ICM",TamSX3("CD2_IMP")[1]))
						aNfItem[nItem][IT_PREDIC] := CD2->CD2_PREDBC 
					EndIf
					
				Else
					dbSelectArea("SD1")
					MsGoto( aNFItem[nItem][IT_RECORI] )
					aNfItem[nItem][IT_LIVRO][LF_ITEMORI] 	:= SD1->D1_ITEM
					dbSelectArea("CD2")
					dbSetOrder(2)
					//A referencia IT_PREDIC diz respeito apenas aos registro de ICMS na tabela CD2, portanto devo procurar apenas os registros
					//de ICMS para buscar a reducao correta na origem.
				   	If MsSeek(xFilial("CD2")+"E"+SD1->(D1_SERIE+D1_DOC+D1_FORNECE+D1_LOJA+PadR(D1_ITEM,TamSX3("CD2_ITEM")[1])+D1_COD)+PadR("ICM",TamSX3("CD2_IMP")[1]))
						aNfItem[nItem][IT_PREDIC] := CD2->CD2_PREDBC 
					EndIf
				EndIf
			EndIf
		Else
			If !Empty(aNFItem[nItem][IT_RECORI])
				If ( aNFCab[NF_CLIFOR] == "C" )
					dbSelectArea("SD1")
					MsGoto( aNFItem[nItem][IT_RECORI] )
					aNfItem[nItem][IT_LIVRO][LF_ITEMORI] 	:= SD1->D1_ITEM
				Else
					dbSelectArea("SD2")
					MsGoto( aNFItem[nItem][IT_RECORI] )
					aNfItem[nItem][IT_LIVRO][LF_ITEMORI] 	:= SD2->D2_ITEM
				EndIf
			EndIf
		EndIf
		//Abatimento na base de calculo do ISS referente a subempreitada
		aNfItem[nItem][IT_LIVRO][LF_ISSSUB]	:= aNfItem[nItem][IT_ABVLISS]
		//Abatimento na base de calculo do ISS referente ao material aplicado
		aNfItem[nItem][IT_LIVRO][LF_ISSMAT]	:= aNfItem[nItem][IT_ABMATISS]
		//Grava o Valor dos Descontos na Observacao.
		aNfItem[nItem][IT_LIVRO][LF_VALOBSE]	:= (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT])+IIf(aNfCab[NF_OPERNF] == "S",aNfItem[nItem][IT_DESCZF],0);
		+IIf((Len(aNfItem[nItem]) > 105 .And. aNfItem[nItem][IT_DESCPRO] > 0 ),aNfItem[nItem][IT_DESCPRO],0)
		//Grava o Valor dos Descontos - Zona Franca de Manaus
		aNfItem[nItem][IT_LIVRO][LF_DESCZFR] := aNfItem[nItem][IT_DESCZF]
		//Valor do desconto e Valor do ICMS sem debito de imposto-Decreto 43.080/2002 do RICMS-MG
		If aNfItem[nItem][IT_ICSEMDS] > 0
			aNfItem[nItem][IT_LIVRO][LF_DS43080] := aNfItem[nItem][IT_ICSEMDS] - aNfItem[nItem][IT_VALICM]
			aNfItem[nItem][IT_LIVRO][LF_VL43080] := aNfItem[nItem][IT_TOTAL] - aNfItem[nItem][IT_BASEICM]
		Endif
		//ICMS Diferido
		If aTes[TS_ICMSDIF] $ "1,3"
			aNfItem[nItem][IT_LIVRO][LF_ICMSDIF]	:= aNfItem[nItem][IT_ICMSDIF]
		EndIf
		//Grava o Valor de PIS/COFINS Subst. Tributaria
		aNfItem[nItem][IT_LIVRO][LF_BASEPS3] 	:= aNfItem[nItem][IT_BASEPS3]
		aNfItem[nItem][IT_LIVRO][LF_ALIQPS3] 	:= aNfItem[nItem][IT_ALIQPS3]
		aNfItem[nItem][IT_LIVRO][LF_VALPS3]		:= aNfItem[nItem][IT_VALPS3]
		aNfItem[nItem][IT_LIVRO][LF_BASECF3]	:= aNfItem[nItem][IT_BASECF3]
		aNfItem[nItem][IT_LIVRO][LF_ALIQCF3] 	:= aNfItem[nItem][IT_ALIQCF3]
		aNfItem[nItem][IT_LIVRO][LF_VALCF3] 	:= aNfItem[nItem][IT_VALCF3]
		//Grava o valor do Fundersul - Mato Grosso do Sul
		aNfItem[nItem][IT_LIVRO][LF_VALFDS] 	:= aNfItem[nItem][IT_VALFDS]
		
		aNfItem[nItem][IT_LIVRO][LF_VLSENAR] 	:= aNfItem[nItem][IT_VLSENAR]
		//Grava o valor do FETHAB - Mato Grosso
		aNfItem[nItem][IT_LIVRO][LF_VALFET] 	:= aNfItem[nItem][IT_VALFET]
		//Grava o valor do FACS - Mato Grosso
		aNfItem[nItem][IT_LIVRO][LF_VALFAC] 	:= aNfItem[nItem][IT_VALFAC]
		//Grava o valor do FABOV - Mato Grosso
		aNfItem[nItem][IT_LIVRO][LF_VALFAB] 	:= aNfItem[nItem][IT_VALFAB]
		//Grava o Valor Contabil.
		If aNFitem[nItem][IT_TIPONF] <> "I" .Or. aNfItem[nItem][IT_VALSOL] <> 0
			If aTes[TS_ICMSDIF] $ "3"
				aNfItem[nItem][IT_LIVRO][LF_VALCONT] := aNfItem[nItem][IT_TOTAL]+IIf(lLfAgreg,aNfItem[nItem][IT_VALMERC],0)-If(aTes[TS_LFIPI]=="N".And.aTes[TS_AGREG]=="N",aNfItem[nItem][IT_VALIPI],0)
				If aTes[TS_LFICM]=="B"
					aNfItem[nItem][IT_LIVRO][LF_VALOBSE] := aNfItem[nItem][IT_LIVRO][LF_VALCONT]
					aNfItem[nItem][IT_LIVRO][LF_VALCONT] := 0
				EndIf
			Else
				//Incentivo à produção e à industrialização do leite
				If aFieldPos[FP_FT_VLINCMG] .And. aNfItem[nItem][IT_VLINCMG] > 0
					aNfItem[nItem][IT_LIVRO][LF_VALCONT]	:= aNfItem[nItem][IT_TOTAL]+IIf(lLfAgreg,aNfItem[nItem][IT_VALMERC],0)-aNfItem[nItem][IT_LIVRO][LF_ICMSDIF]-If(aTes[TS_LFIPI]=="N".AND.aTes[TS_AGREG]=="N",aNfItem[nItem][IT_VALIPI],0) + aNfItem[nItem][IT_VLINCMG]
	         	Else
		       		aNfItem[nItem][IT_LIVRO][LF_VALCONT]	:= aNfItem[nItem][IT_TOTAL]+Iif(lLfAgreg,aNfItem[nItem][IT_VALMERC],0)-Iif(aTes[TS_LFIPI]=="N".AND.aTes[TS_AGREG]=="N",aNfItem[nItem][IT_VALIPI],0) 
	        	Endif
	          	//Tratamento Original - Foi retirado a Subtracao do ICMS DIFERIDO - CHAMADO: TDMSJ9.
	          	//aNfItem[nItem][IT_LIVRO][LF_VALCONT]	:= aNfItem[nItem][IT_TOTAL]+IIf(lLfAgreg,aNfItem[nItem][IT_VALMERC],0)-aNfItem[nItem][IT_LIVRO][LF_ICMSDIF]-If(aTes[TS_LFIPI]=="N".AND.aTes[TS_AGREG]=="N",aNfItem[nItem][IT_VALIPI],0)				
				If aTes[TS_LFICM]=="B"
					aNfItem[nItem][IT_LIVRO][LF_VALOBSE]	:= 	aNfItem[nItem][IT_LIVRO][LF_VALCONT]
					aNfItem[nItem][IT_LIVRO][LF_VALCONT]	:=0
				EndIf
			EndIf
		EndIf
		//Operacoes com Sucata
		If aTes[TS_OPERSUC] == "1"
			aNfItem[nItem][IT_LIVRO][LF_VALCONT]:=aNfItem[nItem][IT_TOTAL]+aNfCab[NF_VALICM]
			aNfItem[nItem][IT_LIVRO][LF_OUTRICM]:=aNfCab[NF_VALICM]
		Endif
		
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³                                                             ATENCAO !!!                                                            ³
		//³                                                                                                                                    ³
		//³------------------------------------------- CREDITO PRESUMIDO / OUTORGADO / ESTIMULO -----------------------------------------------³
		//³                                                                                                                                    ³
		//³Existem varios nomes de campos e referencias diferentes para calculo do Credito Presumido e os mesmos NAO podem mais ser alterados, ³
		//³contudo ficou definido (Liz) que NOVOS creditos presumidos que forem criados obedecam a nomeclatura NF_CRDPRES para o cabecalho,    ³
		//³IT_CRPRE?? onde ?? = UF do ESTADO para o item, Exemplo: IT_CRPRESP, TS_CRDPRES para TES SF4 e LF_CRDPRES para o LIVRO SF3           ³
		//³                                                                                                                                    ³
		//³                                         NAO CRIAR FUNCAO PARA CALULAR O CREDITO PRESUMIDO                                          ³
		//³ Colocar e alimentar a referencia IT_CRPRE?? nesta sessao, pois varias regras para o calculo dependem do VALOR CONTABIL que e       ³
		//³ definido nesta funcao (MaFisLF). Siga e observe os exemplos abaixo.                                                                ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Executa calculo do valor de Reintegra - Per/Dcomp - REINTEGRA³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		aNfItem[nItem][IT_BSREIN]	:= 0
		aNfItem[nItem][IT_VREINT]	:= 0
		
		// Somando frete + seguro + despesas p/ agregar (ou não) na base de calculo do reintegra.
		nDespesas := aNfItem[nItem][IT_FRETE] + aNfItem[nItem][IT_DESPESA] + aNfItem[nItem][IT_SEGURO] 
		
		If aParSX6[MV_PEREINT] > 0 .And. aNfItem[nItem][IT_VALMERC] > 0 .And. aNfItem[nItem][IT_PRD][SB_ORIGEM] == "0"
			If Alltrim(aNfItem[nItem][IT_CF])$"7101/7102/7105/7106/7127/7251/7301/7358/7551/7651/7654/7667" .And. aNfCab[NF_TPCLIFOR] == "X" .And. aNfCab[NF_UFDEST] == "EX"
				aNfItem[nItem][IT_BSREIN] :=(aNfItem[nItem][IT_VALMERC] - (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT])) + Iif(aParSX6[MV_DSPREIN], nDespesas, 0)
			ElseIf Alltrim(aNfItem[nItem][IT_CF])$"5501/5502/6501/6502"
				aNfItem[nItem][IT_BSREIN] :=aNfItem[nItem][IT_VALMERC]+aNfItem[nItem][IT_DESPESA]
			EndIf
			aNfItem[nItem][IT_VREINT] := aNfItem[nItem][IT_BSREIN]*( aParSX6[MV_PEREINT] / 100)
		EndIf
		
		aNfItem[nItem][IT_LIVRO][LF_VREINT]	:= aNfItem[nItem][IT_VREINT]
		aNfItem[nItem][IT_LIVRO][LF_BSREIN]:= aNfItem[nItem][IT_BSREIN]
		
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ CREDITO ESTIMULO MANAUS - TS_CRDEST = 1 - Nao Calcula | 2 - Produtos Eletronicos | 3 - Contrucao Civil |4 - Pelo NCM³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If aTes[TS_CRDEST]$"23" .And. aFieldPos[FP_B1_CRDEST] .And. aFieldPos[FP_F3_CRDEST]
			aNfItem[nItem][IT_LIVRO][LF_CRDEST]	:= NoRound(aNfItem[nItem][IT_VALICM] * aNfItem[nItem][IT_PRD][SB_CRDEST] /100,2)
		ElseIf aTes[TS_CRDEST]$"4" //Deve ser feito para entradas e saidas (calculo: Créditos - Débitos * %de estímulo)
			If FindFunction("M953CRDM")
				aRegra := M953CRDM()     // Lembre-se de refazer esta funcao para melhorar a performance
			EndIf
			If Len(aRegra)>0 .And.;
				(nX := AScanX(aRegra, {|x| x[1]== Alltrim(aNfItem[nItem][IT_LIVRO][LF_POSIPI]) .And. x[2]== aNfCab[NF_A1CRDMA] } )) > 0 .Or.;
				(nX := AScanX(aRegra, {|x| x[1]== Alltrim(aNfItem[nItem][IT_LIVRO][LF_POSIPI]) .And. x[2]=="4" } )) > 0
				aNfItem[nItem][IT_LIVRO][LF_CRDEST]	:= NoRound(aNfItem[nItem][IT_VALICM] * aRegra[nX,3]/100, 2 )
			EndIf
		EndIf
		
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³CREDITO PRESUMIDO referente a Zona Franca de Manaus³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		aNfItem[nItem][IT_LIVRO][LF_CRDZFM] := aNfItem[nItem][IT_CRDZFM]
		
		If aTes[TS_CRDPRES] > 0 .And. !Empty(aTes[TS_TPCPRES])
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Se o percentual do Crédito Presumido TS_CRDPRES estiver preenchido e o Tipo de Crédito Presumido TS_TPCPRES                       ³
			//³também estiver preenchido, então o crédito presumido será calculado seguindo esta nova regra. Caso somente o percentual TS_CRDPRES³
			//³estivere preenchido, então irá seguir as regras que já existiam antes desta implementação, mantendo assim o legado.               ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			Do Case
				Case aTes[TS_TPCPRES] == "C"
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³Base de cálculo para crédito presumido será o valor contábil³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					aNfItem[nItem][IT_LIVRO][LF_CRDPRES] := NoRound((aNfItem[nItem][IT_LIVRO][LF_VALCONT] * aTes[TS_CRDPRES]) / 100,2)
					
				Case aTes[TS_TPCPRES] == "R"
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³Base de cálculo para crédito presumido será a base do ICMS, e irá reduzir o valor do crédito presumido do total do documento.³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					aNfItem[nItem][IT_LIVRO][LF_CRDPRES] := NoRound((aNfItem[nItem][IT_BASEICM] * aTes[TS_CRDPRES]) / 100,2)
					aNfItem[nItem][IT_LIVRO][LF_VALCONT] -= aNfItem[nItem][IT_LIVRO][LF_CRDPRES]
				Case aTes[TS_TPCPRES] == "F" // Opcao limita total operacao por frete 
					If aNfItem[nItem][IT_FRETE]>0 					
						aNfItem[nItem][IT_LIVRO][LF_CRDPRES] := NoRound((aNfItem[nItem][IT_LIVRO][LF_VALCONT] * aTes[TS_CRDPRES]) / 100,2)
						// Limita ao valor do Frete              
						If aNfItem[nItem][IT_LIVRO][LF_CRDPRES] > aNfItem[nItem][IT_FRETE]  
							aNfItem[nItem][IT_LIVRO][LF_CRDPRES] := aNfItem[nItem][IT_FRETE]
						EndIf				       
						// Para SC sera baseado no frete so' e somente se, este nao ultrapassa valor de pauta. 
						// Sendo assim, limita ao valor da pauta
						If (cMvEstado$"SC") .AND. (aNfItem[nItem][IT_PAUTIC]>0) .AND. (aNfItem[nItem][IT_LIVRO][LF_CRDPRES]>aNfItem[nItem][IT_PAUTIC]) 
							aNfItem[nItem][IT_LIVRO][LF_CRDPRES] := aNfItem[nItem][IT_PAUTIC]
						EndIf
					EndIf  					
		  		Case aTes[TS_TPCPRES] == "M"   
					aNfItem[nItem][IT_LIVRO][LF_CRDPRES] := NoRound((aNfItem[nItem][IT_VALMERC] * aTes[TS_CRDPRES]) / 100,2)
				Case aTes[TS_TPCPRES] == "B"
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³Base de cálculo para crédito presumido será a base do ICMS³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					aNfItem[nItem][IT_LIVRO][LF_CRDPRES] := NoRound((aNfItem[nItem][IT_BASEICM] * aTes[TS_CRDPRES]) / 100,2)											
		  		Case aTes[TS_TPCPRES] == "N" //Base calculo valor do ICMS
					aNfItem[nItem][IT_LIVRO][LF_CRDPRES] := NoRound((aNfItem[nItem][IT_VALICM] * aTes[TS_CRDPRES]) / 100,2)					
			EndCase
			
		ElseIf aTes[TS_CRDPRES] > 0 .Or. aNfItem[nItem][IT_B1DIAT] == "1" .Or. nCrdPresMG > 0 .Or. aTes[TS_CRPRSIM] > 0 .Or. aTes[TS_CRPRERO] > 0 .Or. ;
			aTes[TS_CRPRESP] > 0 .Or. aTes[TS_CROUTSP] > 0 .Or. aTes[TS_CRPREPR] > 0 .Or. aTes[TS_CPRESPR] > 0 .Or. aTes[TS_CRPREPE] > 0 .Or. aTes[TS_CPPRODE] > 0
			
			If cMvEstado == "RJ" .Or. cMvEstado == "SC" .Or. cMvEstado == "PR" .Or. cMvEstado == "SP" .Or. cMvEstado == "MT" .Or. cMvEstado == "PE";
				.Or. cMvEstado == "RO" .Or. cMvEstado == "MG" .Or. cMvEstado == "CE" .Or. (cMvEstado == "RS" .And. (aTes[TS_CREDPRE] > 0 .Or. cProdLeite == "1" ))
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³CREDITO PRESUMIDO - MG - RICMS/02 - Inciso X, artigo 75 do estado de MG³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If cMvEstado == "MG" .And. nCrdPresMG > 0
					aNfItem[nItem][IT_CRPREMG]	:= 0
					If aParSX6[MV_RNDICM]
						aNfItem[nItem][IT_CRPREMG]	:= Round((aNfItem[nItem][IT_VALMERC] + Iif( aTes[TS_AGREG] == "I" , aNfItem[nItem][IT_VALICM] , 0 ) ) * (nCrdPresMG / 100) , 2 )
					Else
						aNfItem[nItem][IT_CRPREMG]	:= NoRound((aNfItem[nItem][IT_VALMERC] + Iif( aTes[TS_AGREG] == "I" , aNfItem[nItem][IT_VALICM] , 0 ) ) * (nCrdPresMG / 100) )
					EndIf
					
					If aNFCab[NF_OPERNF]=="S" .And. !aTes[TS_AGREG] == "I" .And. aParSX6[MV_VALICM]
						If aParSX6[MV_RNDICM]
							aNfItem[nItem][IT_CRPREMG]	:= Round((aNfItem[nItem][IT_VALICM] * nCrdPresMG) / 100,2)
						Else
							aNfItem[nItem][IT_CRPREMG]	:= NoRound((aNfItem[nItem][IT_VALICM] * nCrdPresMG) / 100,2)
						EndIf
					EndIf
					
					If aTes[TS_AGREGCP]=="1" // Agrega o credito presumido ao valor total e duplicata
						aNfItem[nItem][IT_TOTAL] += NoRound(aNfItem[nItem][IT_CRPREMG])
						If aTes[TS_DUPLIC] <> "N"
							aNfItem[nItem][IT_BASEDUP] += NoRound(aNfItem[nItem][IT_CRPREMG])
						EndIf
					EndIf
					
					aNfItem[nItem][IT_LIVRO][LF_CRDPRES] := aNfItem[nItem][IT_CRPREMG]
				EndIf
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³CREDITO PRESUMIDO - RJ - Rio de Janeiro³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If cMvEstado == "RJ"
					If aParSX6[MV_CRPRERJ]
						aNfItem[nItem][IT_LIVRO][LF_CRDPRES] := NoRound((aNfItem[nItem][IT_BASEICM] * aTes[TS_CRDPRES]) / 100,2)
					Else
						aNfItem[nItem][IT_LIVRO][LF_CRDPRES] := NoRound((aNfItem[nItem][IT_LIVRO][LF_VALCONT] * aTes[TS_CRDPRES]) / 100,2)
					Endif
				Endif
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³CREDITO PRESUMIDO - SP - Lei 6.374,de 01.03.1989 nos art.38,6§ e 112 regulamentada pelo Dec. 52.381 de 19.11.2007 DOE PR de 22.11.2007³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If cMvEstado == "SP"
					aNfItem[nItem][IT_LIVRO][LF_CRDPRES] := NoRound((aNfItem[nItem][IT_LIVRO][LF_VALCONT] * aTes[TS_CRDPRES]) / 100,2)
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³CREDITO PRESUMIDO - SP - Conforme o Decreto 52.586 de 28.12.2007, relativo a aquisicao de Leite Cru³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					If aTes[TS_CRPRESP] > 0 .And. aNFCab[NF_OPERNF] == "E"
						aNfItem[nItem][IT_LIVRO][LF_CRPRESP] := NoRound((aNfItem[nItem][IT_LIVRO][LF_VALCONT] * aTes[TS_CRPRESP]) / 100,2)
					Endif
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³CREDITO OUTORGADO - SP                                                ³
					//³Conforme Decreto 56.018 de 16.07.2010 - Art. 31 do Anexo III do RICMS,³
					//³relativo a entrada de carnes e demais produtos comestiveis.           ³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					aNfItem[nItem][IT_CROUTSP]:= 0
					If Substr(aNfItem[nItem][IT_POSIPI],1,4) $ aParSX6[MV_CROUTSP] .And. aNFCab[NF_UFDEST]=="SP" .And. aNFCab[NF_UFORIGEM]=="SP" .And. aTes[TS_CROUTSP] > 0
						aNfItem[nItem][IT_CROUTSP]:= NoRound((aNfItem[nItem][IT_LIVRO][LF_VALCONT] * aTes[TS_CROUTSP]) / 100,2)
					Endif
					aNfItem[nItem][IT_LIVRO][LF_CROUTSP] := aNfItem[nItem][IT_CROUTSP]
				Endif
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³CREDITO PRESUMIDO - RS de Acordo com o RICMS - Livro I, titulo V, Atr. 32, Inciso XIX.³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If cMvEstado == "RS"
					If aTes[TS_CREDPRE] > 0 .And. aNFCab[NF_OPERNF] == "E"
						aNfItem[nItem][IT_LIVRO][LF_CREDPRE] := NoRound((aNfItem[nItem][IT_QUANT] * aTes[TS_CREDPRE]) , 2 )
					EndIf
					
					If cProdLeite == "1" .And. aNFCab[NF_OPERNF] == "S"
						aNfItem[nItem][IT_LIVRO][LF_CRDPRES] := NoRound((aNfItem[nItem][IT_VALICM]*(aTes[TS_CRDPRES]/100)),2)
					Endif
				Endif
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³CREDITO PRESUMIDO - SC RICMS - Anexo 02 - Benefícios Fiscais - Capitulo III (Art. 18) e  Art 142 ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If cMvEstado == "SC"
					aNfItem[nItem][IT_CRPRESC]	:= 0
					
					If 	aNfItem[nItem][IT_B1DIAT] == "1" .And. aNfItem[nItem][IT_PREDIC] == 0 .And. aTes[TS_CRDPRES] == 0  ;
						.And. ( aNFCab[NF_OPERNF] == "S" .Or. (aNFCab[NF_OPERNF] == "E" .And. aNFCab[NF_TIPONF]$"DB") )
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³Conforme Art. 15, IX do Anexo 2 - RICMS - DO CREDITO PRESUMIDO SC         ³
						//³De acordo com o Regime Especial DIAT-SC o percentual do credito presumido ³
						//³e' definido conforme aliquota do ICMS DIAT - SC                           ³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						If aNfItem[nItem][IT_ALIQICM] == 7
							aNfItem[nItem][IT_CRPRESC]:= ((aNfItem[nItem][IT_VALICM] * 42.86 ) / 100)
						ElseIf aNfItem[nItem][IT_ALIQICM] == 12
							aNfItem[nItem][IT_CRPRESC]:= ((aNfItem[nItem][IT_VALICM] * 66.66 ) / 100)
						ElseIf aNfItem[nItem][IT_ALIQICM] == 17
							aNfItem[nItem][IT_CRPRESC]:= ((aNfItem[nItem][IT_VALICM] * 76.47 ) / 100)
						ElseIf aNfItem[nItem][IT_ALIQICM] == 25
							aNfItem[nItem][IT_CRPRESC]:= ((aNfItem[nItem][IT_VALICM] * 84.00 ) / 100)
						EndIf
						MaItArred(nItem,{"IT_CRPRESC"})
						
					ElseIf aTes[TS_CRDPRES] > 0 .And. aNFCab[NF_OPERNF] == "E" .And. !Empty(aNfItem[nItem][IT_FRETE])
						If aNfItem[nItem][IT_FRETE] > NoRound((aNfItem[nItem][IT_VALMERC] * aTes[TS_CRDPRES]) / 100,2)
							aNfItem[nItem][IT_CRPRESC]	:= NoRound((aNfItem[nItem][IT_VALMERC] * aTes[TS_CRDPRES]) / 100,2)
						Else
							aNfItem[nItem][IT_CRPRESC]	:= aNfItem[nItem][IT_FRETE]
						EndIf
					Elseif aNFCab[NF_OPERNF] == "S"
						aNfItem[nItem][IT_CRPRESC]	:= NoRound((aNfItem[nItem][IT_BASEICM] * aTes[TS_CRDPRES]) / 100,2)
					EndIf
					aNfItem[nItem][IT_LIVRO][LF_CRDPRES]	:= aNfItem[nItem][IT_CRPRESC]
					
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³CREDITO PRESUMIDO - SC - Simples Nacional                                            ³
					//³Lei 14.264/07 - Decreto 1036 de 28/01/08  RICMS/SC Art. 29, Parag 5                  ³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					aNfItem[nItem][IT_CRPRSIM]	:= 0
					If aNFCab[NF_SIMPNAC]=="1" .And. aTes[TS_CRPRSIM] > 0 .And. !(aNfItem[nItem][IT_VALSOL] > 0) .And. Substr(aNfItem[nItem][IT_LIVRO][LF_CFO],1,1)$"12"
						aNfItem[nItem][IT_CRPRSIM]	:= aNfItem[nItem][IT_VALMERC] * aTes[TS_CRPRSIM] / 100
					EndIf
					aNfItem[nItem][IT_LIVRO][LF_CRPRSIM] := aNfItem[nItem][IT_CRPRSIM]
				EndIf
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³CREDITO PRESUMIDO - CE - Artigo 64 Inciso VII                      ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				if cMvEstado=="CE" .And. (aTes[TS_CRDPRES]>0) .And. aNFCab[NF_OPERNF]=='E'
				  	If aNfItem[nItem][IT_FRETE] > NoRound((aNfItem[nItem][IT_VALMERC] * aTes[TS_CRDPRES]) / 100,2)
					 	aNfItem[nItem][IT_CRPRECE]	:= NoRound((aNfItem[nItem][IT_VALMERC] * aTes[TS_CRDPRES]) / 100,2)
				   	Else
						aNfItem[nItem][IT_CRPRECE]	:= aNfItem[nItem][IT_FRETE]    
				    EndIf  
				    
				  aNfItem[nItem][IT_LIVRO][LF_CRDPRES] :=  aNfItem[nItem][IT_CRPRECE] 
		    	EndIF	
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³CREDITO PRESUMIDO - PR  Lei 14.985 de 06.01.2006 Decreto 6.144 - 22.02.2006 - DOE PR³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If cMvEstado == "PR"
					If aTes[TS_AGREG]$"BC"
						aNfItem[nItem][IT_LIVRO][LF_CRDPRES] := NoRound((IIF(aNfItem[nItem][IT_BASEICM]==0,aNfItem[nItem][IT_LIVRO][LF_VALCONT]/(1-(aNfItem[nItem][IT_ALIQICM]/100)),aNfItem[nItem][IT_BASEICM])*(aTes[TS_CRDPRES]/100)),2)
					Else
						aNfItem[nItem][IT_LIVRO][LF_CRDPRES] := NoRound((IIF(aNfItem[nItem][IT_BASEICM]==0,nBICMOri,aNfItem[nItem][IT_BASEICM])*(aTes[TS_CRDPRES]/100)),2)
					EndIf
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³CREDITO PRESUMIDO - PR  RICMS - Art. 4 Anexo III - Credito Presumido - PR Decreto n. 1.980        ³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					aNfItem[nItem][IT_CRPREPR]	:= 0
					If aTes[TS_CRPREPR] > 0 // .And. aNFCab[NF_OPERNF] == "E"
						aNfItem[nItem][IT_CRPREPR] := NoRound((aNfItem[nItem][IT_LIVRO][LF_VALCONT] * aTes[TS_CRPREPR]) / 100,2)
					Endif
					aNfItem[nItem][IT_LIVRO][LF_CRPREPR] := aNfItem[nItem][IT_CRPREPR]
					
					If aTes[TS_CPRESPR] > 0 .And. aNFCab[NF_OPERNF] == "S" // CREDITO PRESUMIDO - PR - Art.631-A do RICMS/2008
						aNfItem[nItem][IT_LIVRO][LF_CPRESPR] := NoRound((aNfItem[nItem][IT_VALICM]*(aTes[TS_CPRESPR]/100)),2)
					Endif
				Endif
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³CREDITO PRESUMIDO - MT - Mato Grosso Comunicado PRODEIC 067/2005 Resolucao 36/2005 Lei 7.958/2003 Decreto 1.432/2003³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If cMvEstado == "MT"
					aNfItem[nItem][IT_LIVRO][LF_CRDPRES] := NoRound((aNfItem[nItem][IT_VALICM]*(aTes[TS_CRDPRES]/100)),2)
				Endif
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³CREDITO PRESUMIDO - RO - Rondonia Lei 1.473/2005 - Artigo 1 Operacoes Interestaduais com produtos importados³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If cMvEstado == "RO"
					If SubStr(aNfItem[nItem][IT_LIVRO][LF_CFO],1,1) $ "6" .And. aNfItem[nItem][IT_PRD][SB_ORIGEM] == "1"
						aNfItem[nItem][IT_LIVRO][LF_CRDPRES] := NoRound((aNfItem[nItem][IT_VALICM]*(aTes[TS_CRDPRES]/100)),2)
					EndIf
					
					If aTes[TS_CRPRERO] > 0 //CREDITO PRESUMIDO - RO - RICMS - (Art. 39) Anexo IV
						aNfItem[nItem][IT_LIVRO][LF_CRPRERO] := NoRound((aNfItem[nItem][IT_VALICM]*(aTes[TS_CRPRERO]/100)),2)
					EndIf
				Endif
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³CREDITO PRESUMIDO - PE - Art.6 Decreto  n28.247 ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If cMvEstado == "PE"
					aNfItem[nItem][IT_CRPREPE]:= 0
					If aTes[TS_CRPREPE] > 0
						aNfItem[nItem][IT_CRPREPE]:= NoRound( ( aNfItem[nItem][IT_VALICM] * (aTes[TS_CRPREPE]/100) ) , 2 )
					EndIf
					aNfItem[nItem][IT_LIVRO][LF_CRPREPE] := aNfItem[nItem][IT_CRPREPE]
					
					If aTes[TS_TPPRODE] <> ""
						aNfItem[nItem][IT_LIVRO][LF_TPPRODE] := aTes[TS_TPPRODE]
					EndIf
					If aTes[TS_CPPRODE] > 0
						aNfItem[nItem][IT_LIVRO][LF_CPPRODE] := NoRound((aNfItem[nItem][IT_VALICM]*(aTes[TS_CPPRODE]/100)),2)
						If 	aNfItem[nItem][IT_LIVRO][LF_TPPRODE] $ "3#4" .And. aNfItem[nItem][IT_LIVRO][LF_CPPRODE] > aNfItem[nItem][IT_FRETE]
							aNfItem[nItem][IT_LIVRO][LF_CPPRODE] := aNfItem[nItem][IT_FRETE]
						EndIf
					EndIf
				EndIf
				
			Else
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³Calculo do Credito Presumido para todos os outros estados que nao possuem uma regra definida                   ³
				//³Caso a regra do calculo seja essa mesma, somente sera preciso alterar o P9AUTOTEXT para apresentar na apuracao.³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				aNfItem[nItem][IT_LIVRO][LF_CRDPRES] := NoRound((aNfItem[nItem][IT_LIVRO][LF_VALCONT] * aTes[TS_CRDPRES]) / 100,2)
			EndIf
		EndIf
		
		aNfItem[nItem][IT_CREDPRE] := 0 //Credito Presumido - Art. 6 Decreto  n28.247 ???
		If aNFCab[NF_OPERNF]=="E" .And. aTes[TS_CREDPRE] > 0
			aNfItem[nItem][IT_CREDPRE]	:= NoRound( (aNfItem[nItem][IT_QUANT] * aTes[TS_CREDPRE]) , 2 )
		EndIf
		aNfItem[nItem][IT_LIVRO][LF_CREDPRE] := aNfItem[nItem][IT_CREDPRE]
		
		
		//Calculo do crédito referente à Antecipação Tributária - Art.786.(SE) / Art.947.(RN)
		If ( cMvEstado $ "SE|RN|SP" .Or.  aNfItem[nItem][IT_MARGEM] > 0 ) .And. aTes[TS_ANTICMS] == "1"
			If cMvEstado $ "SP"
				If aTes[TS_VARATAC] == "1" .And. aNfItem[nItem][IT_VALANTI] > 0 //Varejista
					aNfItem[nItem][IT_VALANTI]:= aNfItem[nItem][IT_VALSOL]
				EndIf
			Else
				aNfItem[nItem][IT_VALANTI]:= aNfItem[nItem][IT_VALSOL]
			EndIf
		Endif
		
		// Grava o valor do ICMS do Frete Autonomo no Livro Fiscal
		aNfItem[nItem][IT_LIVRO][LF_ICMAUTO] := IIF(aNfCab[NF_RECFAUT]<>"2",aNfItem[nItem][IT_VALICA],0)
		
		//Grava o valor do ICMS do Frete Autonomo no Livro Fiscal - Embarcador
		//Somente efetua gravacao se o pedido indicar que o responsavel pelo recolhimento
		//e o emissor do documento fiscal e nao o transportador.
		If aNfCab[NF_RECFAUT] <> "2"
			aNfItem[nItem][IT_LIVRO][LF_BASETST]:= aNfItem[nItem][IT_BASETST]
			aNfItem[nItem][IT_LIVRO][LF_VALTST] := aNfItem[nItem][IT_VALTST]
		Endif
		
		If aNfCab[NF_TIPONF] $ "DBCIP"
			aNfItem[nItem][IT_LIVRO][LF_TIPO]:= aNfCab[NF_TIPONF]
		EndIf
		
		//Livro de ICMS                                                           ³
		IF !(aTes[TS_LFICM]$'NZ') .And. aTes[TS_ISS]<>"S"
			//Base do ICMS                                                            ³
			If aNfItem[nItem][IT_TIPONF] <> "I"
				If nReduzICMS > 0 .And. nReduzICMS<>100
					If !lConsumo
						If aTes[TS_CONSUMO] == "O"
							If aTes[TS_LFICM] == "I"
								aNfItem[nItem][IT_LIVRO][LF_ISENICM] := (aNfItem[nItem][IT_BASEICM]-aNfItem[nItem][IT_VIPIBICM])+(nBICMOri-aNfItem[nItem][IT_BASEICM]+aNfItem[nItem][IT_VIPIBICM])
							Else
								aNfItem[nItem][IT_LIVRO][LF_OUTRICM] := (aNfItem[nItem][IT_BASEICM]-aNfItem[nItem][IT_VIPIBICM])+Max(nBICMOri-aNfItem[nItem][IT_BASEICM]+aNfItem[nItem][IT_VIPIBICM],0)
							EndIf
						Else
							aNfItem[nItem][IT_LIVRO][LF_BASEICM] := aNfItem[nItem][IT_BASEICM]
						Endif
					Else
						If aTes[TS_LFICM] == "I"
							aNfItem[nItem][IT_LIVRO][LF_ISENICM] := aNfItem[nItem][IT_BASEICM] - aNfItem[nItem][IT_VIPIBICM]
							aNfItem[nItem][IT_LIVRO][LF_OUTRICM] := nBICMOri-aNfItem[nItem][IT_BASEICM]+aNfItem[nItem][IT_VIPIBICM]
						Else
							aNfItem[nItem][IT_LIVRO][LF_ISENICM] := Max( nBICMOri-aNfItem[nItem][IT_BASEICM]+aNfItem[nItem][IT_VIPIBICM], 0 )
							aNfItem[nItem][IT_LIVRO][LF_OUTRICM] := aNfItem[nItem][IT_BASEICM]-aNfItem[nItem][IT_VIPIBICM]
						EndIf
					EndIf
				Else
					If aTes[TS_LFICM] == "T" .Or. (aTes[TS_LFICM] == "I" .And. aTes[TS_DESPICM]=="5")
						aNfItem[nItem][IT_LIVRO][LF_BASEICM] := aNfItem[nItem][IT_BASEICM]
					EndIf
				EndIf
			EndIf
			//Valor do ICMS Tributado
			If (aTes[TS_LFICM] =="T" .Or. (nReduzICMS<>100 .And. (nReduzICMS<>0.And.!lConsumo) .And. (nReduzICMS<>0 .And. !aTes[TS_CONSUMO]=="O")) .Or. (aTes[TS_LFICM] == "I" .And. aTes[TS_DESPICM]=="5"))
				aNfItem[nItem][IT_LIVRO][LF_VALICM] := aNfItem[nItem][IT_VALICM]
			EndIf
			//Tratamento para os casos do Art. 1. DECRETO 4.316 de 19 de Junho de 1995. art. 87 do RICMS/BA
			//O percentual informado no cadastro de TES deverah estar de acordo com o Art. 7. deste decreto.
			If (aTes[TS_CRPRELE]<>0)
				aNfItem[nItem][IT_LIVRO][LF_CRPRELE] := Round( aNfItem[nItem][IT_VALICM]*(aTes[TS_CRPRELE]/100), 2)
			EndIf
			
			// Grava o Valor do Credito Presumido - RJ - Prestacoes de Servicos de Transporte
			If aTes[TS_CRDTRAN]<>0
				aNfItem[nItem][IT_LIVRO][LF_CRDTRAN] := ( aNfItem[nItem][IT_VALICM] * aTes[TS_CRDTRAN]) / 100
			Endif
			
			//Valor da Coluna Isentas e Nao Tributadas
			If aTes[TS_LFICM] =="I"
				//Tanto reducao de 100% quanto a configuracao de consumo devem gravar a
				//  base como ZERO e o livro em OUTROS/ISENTO. Ex: VLr 1000, Reduca:100%,
				//  Lvr: Isento, fica = vlr contabil: 1000, Base: 0, Isento: 1000
				If nReduzICMS > 0 .And. nReduzICMS <> 100
					If !lConsumo .And. !aTes[TS_CONSUMO]=="O"
						aNfItem[nItem][IT_LIVRO][LF_ISENICM] := nBICMOri-aNfItem[nItem][IT_BASEICM]+aNfItem[nItem][IT_VIPIBICM]
					EndIf
				Else
					If aTES[TS_DESPICM]<> "5"
						aNfItem[nItem][IT_LIVRO][LF_ISENICM] := nBICMOri
					Else
						aNfItem[nItem][IT_LIVRO][LF_ISENICM] := (nBICMOri-aNfItem[nItem][IT_BASEICM])
					EndIf
				EndIf
			EndIf
			//Valor da Coluna Outras
			If aTes[TS_LFICM]=="O"
				If nReduzICMS > 0 .And. nReduzICMS <> 100
					If !lConsumo .And. !aTes[TS_CONSUMO]=="O"
						aNfItem[nItem][IT_LIVRO][LF_OUTRICM] := nBICMOri-aNfItem[nItem][IT_BASEICM]+aNfItem[nItem][IT_VIPIBICM]
					EndIf
				Else
					aNfItem[nItem][IT_LIVRO][LF_OUTRICM] := nBICMOri
				EndIf
			EndIf
		EndIf
		
		// Grava o Valor do Credito Presumido - MG - Prestacoes de Servicos de Transporte
		If aTes[TS_LFICM]=="Z" .And. aTes[TS_OBSSOL]=="5" .And. aNfItem[nItem][IT_BASESOL] > 0 .And. aNfItem[nItem][IT_BASEICM] == 0 .And. aTes[TS_CRDTRAN]<>0
			aNfItem[nItem][IT_LIVRO][LF_CRDTRAN] := (aNfItem[nItem][IT_VALSOL] * aTes[TS_CRDTRAN]) / 100
		Endif
		
		// ICMS Complementar
		aNfItem[nItem][IT_LIVRO][LF_ICMSCOMP]:= aNfItem[nItem][IT_VALCMP]
		
		// Antecipacao ICMS
		aNfItem[nItem][IT_LIVRO][LF_VALANTI] := aNfItem[nItem][IT_VALANTI]
		
		// Valor FECP
		aNfItem[nItem][IT_LIVRO][LF_VALFECP] := aNfItem[nItem][IT_VALFECP]
		aNfItem[nItem][IT_LIVRO][LF_VFECPST] := aNfItem[nItem][IT_VFECPST]
		// Valor FECOP RN
		aNfItem[nItem][IT_LIVRO][LF_VFECPRN] := aNfItem[nItem][IT_VFECPRN]
		aNfItem[nItem][IT_LIVRO][LF_VFESTRN] := aNfItem[nItem][IT_VFESTRN]
		// Valor FECP-MG
		aNfItem[nItem][IT_LIVRO][LF_VFECPMG] := aNfItem[nItem][IT_VFECPMG]
		aNfItem[nItem][IT_LIVRO][LF_VFESTMG] := aNfItem[nItem][IT_VFESTMG]
		// Valor FECP-MT
		aNfItem[nItem][IT_LIVRO][LF_VFECPMT] := aNfItem[nItem][IT_VFECPMT]
		aNfItem[nItem][IT_LIVRO][LF_VFESTMT] := aNfItem[nItem][IT_VFESTMT]
		
		//Credito Outorgado - GO Inc.III, Art 11 Anexo IX - RCTE-GO/97
		If cMvEstado$"GO" .And. aNFCab[NF_OPERNF]=='S' .And. SubStr(aNfItem[nItem][IT_LIVRO][LF_CFO],1,1) $ "6" .And.;
			aTes[TS_CONSUMO]$"N" .And. !(aNfItem[nItem][IT_VALSOL] > 0) .And. aTes[TS_CROUTGO]>0
			If aParSX6[MV_RNDICM]
				aNfItem[nItem][IT_LIVRO][LF_CROUTGO]:= Round((aNfItem[nItem][IT_VALMERC] * aTes[TS_CROUTGO]) / 100,2)
			Else
				aNfItem[nItem][IT_LIVRO][LF_CROUTGO]:= NoRound((aNfItem[nItem][IT_VALMERC] * aTes[TS_CROUTGO]) / 100,2)
			EndIf
		Endif
		// Valor FUMACOP
		aNfItem[nItem][IT_LIVRO][LF_VALFUM]	 := aNfItem[nItem][IT_VALFUM]
		// Valor TPDP-PB
		aNfItem[nItem][IT_LIVRO][LF_VALTPDP]:= aNfItem[nItem][IT_VALTPDP]
		// Transferencia de Debito e Credito
		If aTes[TS_TRFICM]=="1"
			aNfItem[nItem][IT_LIVRO][LF_TRFICM]	 := aNfItem[nItem][IT_VALMERC]
		EndIf
		//Grava valor Credito Presumido Substituicao Tributaria retido pelo contratante do servico de transporte - Decreto 44.147/2005 (MG)
		If aTes[TS_CRPRST]<>0
			aNfItem[nItem][IT_LIVRO][LF_CRPRST]	 := aNfItem[nItem][IT_VLCSOL] - aNfItem[nItem][IT_VALSOL]
			If lRecPreSt
				MaAliqSoli(nItem)
				MaExcecao(nItem)
				MaMargem(nItem)
				MaFisVSol(nItem)
				MaFisVTot(nItem)
			EndIf
		EndIf
		// ICMS Solidario.
		aNfItem[nItem][IT_LIVRO][LF_ICMSRET]:= aNfItem[nItem][IT_VALSOL]
		aNfItem[nItem][IT_LIVRO][LF_BASERET]:= aNfItem[nItem][IT_BASESOL]
		If aTes[TS_OBSICM] == "1"
			aNfItem[nItem][IT_LIVRO][LF_OBSICM] := aNfItem[nItem][IT_VALICM]
		Endif
		If aTes[TS_OBSSOL] == "1"
			aNfItem[nItem][IT_LIVRO][LF_OBSSOL] := aNfItem[nItem][IT_VALSOL]
		elseif aTes[TS_OBSSOL] == "3"   //icms garantido MT
			aNfItem[nItem][IT_LIVRO][LF_OBSERV] := " ICMS Garantido "
		elseif aTes[TS_OBSSOL] == "4"   //icms garantido integral MT
			aNfItem[nItem][IT_LIVRO][LF_OBSERV] := " ICMS Garantido Integral"
		EndIf
		
		If aTes[TS_CREDST] $ "1#3#4"
			If aTes[TS_CREDST] <> "4"
				aNfItem[nItem][IT_LIVRO][LF_SOLTRIB] := aNfItem[nItem][IT_VALSOL]
			Endif
			aNfItem[nItem][IT_LIVRO][LF_CREDST ] := aTes[TS_CREDST]
		EndIf
		// ICMS Aliquota
		If aNfItem[nItem][IT_LIVRO][LF_BASEICM]==0
			aNfItem[nItem][IT_LIVRO][LF_ALIQICMS] := 0
		Else
			aNfItem[nItem][IT_LIVRO][LF_ALIQICMS] := aNfItem[nItem][IT_ALIQICM]
		EndIf
		//Quando o IPI estiver na base do ICMS preencher o valor do IPI na Observ.
		If aNfItem[nItem][IT_VIPIBICM]>0 .And. SubStr(cIPInaObs,2,1)=="S" .And. aTes[TS_IPIOBS] $ " 1"
			aNfItem[nItem][IT_LIVRO][LF_IPIOBS]   := aNfItem[nItem][IT_VIPIBICM]
		Else
			aNfItem[nItem][IT_LIVRO][LF_IPIOBS]   := 0
		EndIf
		//Livro de ICMS-ST
		IF (aTes[TS_LFICMST]$'IOT')
			//Valor da Coluna Isentas e Nao Tributadas
			If aTes[TS_LFICMST] =="I"
				aNfItem[nItem][IT_LIVRO][LF_ISENICM] += aNfItem[nItem][IT_VALSOL]
				aNfItem[nItem][IT_LIVRO][LF_ISENRET] += aNfItem[nItem][IT_VALSOL]
			EndIf
			//Valor da Coluna Outras
			If aTes[TS_LFICMST]=="O"
				aNfItem[nItem][IT_LIVRO][LF_OUTRICM] += aNfItem[nItem][IT_VALSOL]
				aNfItem[nItem][IT_LIVRO][LF_OUTRRET] += aNfItem[nItem][IT_VALSOL]
			EndIf
			//Valor da Coluna Tributadas
			If aTes[TS_LFICMST]=="T"
				aNfItem[nItem][IT_LIVRO][LF_BASEICM] += aNfItem[nItem][IT_BASESOL]
				//O credito deverah ser o valor integral, ou seja, o ICMS/ST + CRED PRES ST, pois quando houver valor neste campo vai se referir a 20% do valor retido que foi subtraido
				aNfItem[nItem][IT_LIVRO][LF_VALICM]  += aNfItem[nItem][IT_VALSOL]+aNfItem[nItem][IT_LIVRO][LF_CRPRST]
				aNfItem[nItem][IT_LIVRO][LF_ALIQICMS]:= aNfItem[nItem][IT_ALIQICM]
				//O credito deverah ser o valor integral, ou seja, o ICMS/ST + CRED PRES ST, pois quando houver valor neste campo vai se referir a 20% do valor retido que foi subtraido
				aNfItem[nItem][IT_LIVRO][LF_TRIBRET] += aNfItem[nItem][IT_VALSOL]+aNfItem[nItem][IT_LIVRO][LF_CRPRST]
			EndIf
		EndIf
		
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³  CREDITO PRESUMIDO PELA CARGA TRIBUTÁRIA                         ³
		//³  Exemplo: DECRETO N.º 42.649 DE 05 DE OUTUBRO DE 2010  /RJ       ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If aTes[TS_CPRCATR] == "1" .And. aNfItem[nItem][IT_PRD][SB_B1CALTR] == "1"
			If aNFCab[NF_OPERNF] == "S" .And. (Substr(aNfItem[nItem][IT_LIVRO][LF_CFO],1,1)$"6" .Or. aNfItem[nItem][IT_PRD][SB_ORIGEM] <> "0" .Or. aParSX6[MV_CPCATRI])
				aNfItem[nItem][IT_LIVRO][LF_CRDPCTR] := aNfItem[nItem][IT_LIVRO][LF_VALICM] - aNfItem[nItem][IT_LIVRO][LF_VALFECP] - ( aNfItem[nItem][IT_LIVRO][LF_BASEICM] * ( aNfItem[nItem][IT_PRD][SB_B1CATRI] / 100 )  )
			ElseIf aNFCab[NF_OPERNF] == "E" .And. aNFCab[NF_TIPONF] $ "DB"
				aNfItem[nItem][IT_LIVRO][LF_CRDPCTR] := aNfItem[nItem][IT_LIVRO][LF_VALICM] - aNfItem[nItem][IT_LIVRO][LF_VALFECP] - ( aNfItem[nItem][IT_LIVRO][LF_BASEICM] * ( aNfItem[nItem][IT_PRD][SB_B1CATRI] / 100)  )
			EndIf
		EndIf
		
		//Livro de IPI
		If !aTes[TS_LFIPI]$"NZ" .And. aTes[TS_ISS]<>"S" .And. aNfItem[nItem][IT_TIPONF] <> "I"
			If nReduzIPI == 0 .And. aTes[TS_IPI] <> "R"
				Do Case
					Case aTes[TS_LFIPI] == "T"                                          
						aNfItem[nItem][IT_LIVRO][LF_BASEIPI] := aNfItem[nItem][IT_BASEIPI]
						aNfItem[nItem][IT_LIVRO][LF_VALIPI]  := aNfItem[nItem][IT_VALIPI]
					Case aTes[TS_LFIPI] == "I"
						aNfItem[nItem][IT_LIVRO][LF_ISENIPI] := nBIPIOri
					Case aTes[TS_LFIPI] == "O"
						If aTes[TS_AGREG]$"B" .And. aNfItem[nItem][IT_TIPONF]$"N"
							aNfItem[nItem][IT_LIVRO][LF_OUTRIPI] := aNfItem[nItem][IT_BASEIPI]
						Else
							aNfItem[nItem][IT_LIVRO][LF_OUTRIPI] := nBIPIOri
						ENdIf
					Case aTes[TS_LFIPI] == "P"
						aNfItem[nItem][IT_LIVRO][LF_OUTRICM] := aNfItem[nItem][IT_VALIPI]
				EndCase
			Else
				If !lConsumo
					If aTes[TS_CONSUMO] == "O"
						If aTes[TS_LFIPI] == "I"
							aNfItem[nItem][IT_LIVRO][LF_ISENIPI] := (aNfItem[nItem][IT_BASEIPI])+(nBIPIOri-aNfItem[nItem][IT_BASEIPI])
						Else
							aNfItem[nItem][IT_LIVRO][LF_OUTRIPI] := (aNfItem[nItem][IT_BASEIPI])+Max(nBIPIOri-aNfItem[nItem][IT_BASEIPI],0)
						EndIf
					Else
						aNfItem[nItem][IT_LIVRO][LF_BASEIPI] := aNfItem[nItem][IT_BASEIPI]
						aNfItem[nItem][IT_LIVRO][LF_VALIPI]  := aNfItem[nItem][IT_VALIPI]
						aNfItem[nItem][IT_LIVRO][IIf(aTes[TS_LFIPI]=="I",LF_ISENIPI,LF_OUTRIPI)] := nBIPIOri-aNfItem[nItem][IT_BASEIPI]
					Endif
				Else
					If aTes[TS_LFIPI]=="I"
						aNfItem[nItem][IT_LIVRO][LF_ISENIPI] := aNfItem[nItem][IT_BASEIPI]
						aNfItem[nItem][IT_LIVRO][LF_OUTRIPI] := nBIPIOri-aNfItem[nItem][IT_BASEIPI]
					Else
						aNfItem[nItem][IT_LIVRO][LF_ISENIPI] := nBIPIOri-aNfItem[nItem][IT_BASEIPI]
						aNfItem[nItem][IT_LIVRO][LF_OUTRIPI] := aNfItem[nItem][IT_BASEIPI]
					EndIf
				EndIf
			EndIf
		ElseIf aTes[TS_LFIPI] == "N" .And. aTes[TS_ISS] <> "S" .And. SubStr(cIPInaObs,1,1)=="S" .And. aTes[TS_IPI] <> 'R' .And. aTes[TS_IPIOBS] $ " 1"
			aNfItem[nItem][IT_LIVRO][LF_IPIOBS]	:= aNfItem[nItem][IT_VALIPI]
		EndIf

	    //Para entradas irá verificar se considera o valor de frete e despesas acessórias na coluna outros do IPI.
	    IF aNFCab[NF_OPERNF] == "E"
	        IF aTes[TS_DESPIPI] == "O"
				aNfItem[nItem][IT_LIVRO][LF_OUTRIPI]+=aNfItem[nItem][IT_DESPESA]+aNfItem[nItem][IT_SEGURO]
			EndIF
			
			IF aTes[TS_IPIFRET] == "O"
				aNfItem[nItem][IT_LIVRO][LF_OUTRIPI]+=aNfItem[nItem][IT_FRETE]
			EndIF
		EndIF
		// IPI Aliquota
		If aNfItem[nItem][IT_LIVRO][LF_BASEIPI]==0
			aNfItem[nItem][IT_LIVRO][LF_ALIQIPI] := 0
		Else
			aNfItem[nItem][IT_LIVRO][LF_ALIQIPI] := aNfItem[nItem][IT_ALIQIPI]
		EndIf
		//Quando o IPI possuir uma parte nao tributada, preencher o IPI na Observ.
		If !lConsFinal .Or. (lConsFinal .And. aNFCab[NF_OPERNF]=='E')
			If nBIPIOri<>aNfItem[nItem][IT_LIVRO][LF_BASEIPI] .And. aNfItem[nItem][IT_LIVRO][LF_VALIPI]<>0
				If SubStr(cIPInaObs,1,1)=="S" .And. aTes[TS_IPI] <> 'R' .And. aTes[TS_IPIOBS] $ " 1"
					aNfItem[nItem][IT_LIVRO][LF_IPIOBS]   += NoRound((nBIPIOri-aNfItem[nItem][IT_LIVRO][LF_BASEIPI])*aNfItem[nItem][IT_LIVRO][LF_VALIPI]/aNfItem[nItem][IT_LIVRO][LF_BASEIPI],2)
				Endif
			Else
				If aTes[TS_LFIPI]$"IO" .And. aNfItem[nItem][IT_LIVRO][LF_VALIPI]==0
					If SubStr(cIPInaObs,1,1)=="S" .And. aTes[TS_IPI] <> 'R' .And. aTes[TS_IPIOBS] $ " 1"
						aNfItem[nItem][IT_LIVRO][LF_IPIOBS]   := aNfItem[nItem][IT_VALIPI]
					Endif
				EndIf
			EndIf
		EndIf
		// Zera a coluna Obs IPI caso esteja menor que zero
		aNfItem[nItem][IT_LIVRO][LF_IPIOBS] := Max(aNfItem[nItem][IT_LIVRO][LF_IPIOBS],0)
		//Livro de ISS
		If aTes[TS_ISS] == "S"
			Do Case
				Case aTes[TS_LFISS] == "T"
					aNfItem[nItem][IT_LIVRO][LF_BASEICM] := IIF(aNfCab[NF_TIPONF]=="I",0,aNfItem[nItem][IT_BASEISS])
					aNfItem[nItem][IT_LIVRO][LF_VALICM]  := IIF(aNfCab[NF_TIPONF]=="I",aNfItem[nItem][IT_BASEISS],aNfItem[nItem][IT_VALISS])
				Case aTes[TS_LFISS] == "I"
					aNfItem[nItem][IT_LIVRO][LF_ISENICM] := aNfItem[nItem][IT_BASEISS]
				Case aTes[TS_LFISS] == "O"
					aNfItem[nItem][IT_LIVRO][LF_OUTRICM] := aNfItem[nItem][IT_BASEISS]
			EndCase
			aNfItem[nItem][IT_LIVRO][LF_TIPO] := "S"
			aNfItem[nItem][IT_LIVRO][LF_CODISS] := aNfItem[nItem][IT_CODISS]
			aNfItem[nItem][IT_LIVRO][LF_CNAE]   := aNfItem[nItem][IT_CNAE]
			// ISS Aliquota
			If aNfItem[nItem][IT_LIVRO][LF_BASEICM]==0 .And. (aNfItem[nItem,IT_ABVLISS]==aNfItem[nItem][IT_LIVRO][LF_VALCONT] .Or. aNfItem[nItem,IT_ABMATISS]==aNfItem[nItem][IT_LIVRO][LF_VALCONT])
				aNfItem[nItem][IT_LIVRO][LF_ALIQICMS] := aNfItem[nItem][IT_ALIQISS]
			elseif aNfItem[nItem][IT_LIVRO][LF_BASEICM]==0
				aNfItem[nItem][IT_LIVRO][LF_ALIQICMS] := 0
			Else
				aNfItem[nItem][IT_LIVRO][LF_ALIQICMS] := aNfItem[nItem][IT_ALIQISS]
			EndIf
			// Livro de ICMS - Ajuste SINEF 03/04 - DOU 08.04.04
			aNfItem[nItem][IT_LIVRO][LF_ISS_ALIQICMS] := 0
			Do Case
				Case aTes[TS_LFICM] == "I"
					aNfItem[nItem][IT_LIVRO][LF_ISS_ISENICM] := aNfItem[nItem][IT_LIVRO][LF_VALCONT]
				Case aTes[TS_LFICM] == "O"
					aNfItem[nItem][IT_LIVRO][LF_ISS_OUTRICM] := aNfItem[nItem][IT_LIVRO][LF_VALCONT]
			EndCase
			Do Case
				Case aTes[TS_LFIPI] == "I"
					aNfItem[nItem][IT_LIVRO][LF_ISS_ISENIPI] := aNfItem[nItem][IT_LIVRO][LF_VALCONT]
				Case aTes[TS_LFIPI] == "O"
					aNfItem[nItem][IT_LIVRO][LF_ISS_OUTRIPI] := aNfItem[nItem][IT_LIVRO][LF_VALCONT]
			EndCase
			
		ElseIf ( (aTes[TS_LFISS] == "I" .Or. aTes[TS_LFISS] == "O") .And. !Empty( aNfItem[nItem][IT_PRD][SB_CODISS] ) )
			// Caso o livro de ISS esteja como isento, e exista o Codigo de ISS
			// O F3_TIPO deve ser S, mesmo que a TES esteja como calcula ISS = N
			aNfItem[nItem][IT_CFPS]				:= aTes[TS_CFPS]
			aNfItem[nItem][IT_CODISS]			:= aNfItem[nItem][IT_PRD][SB_CODISS]
			aNfItem[nItem][IT_LIVRO][LF_TIPO] 	:= "S"
			aNfItem[nItem][IT_LIVRO][LF_CODISS]:= aNfItem[nItem][IT_PRD][SB_CODISS]
			aNfItem[nItem][IT_LIVRO][LF_CNAE]  := aNfItem[nItem][IT_CNAE]
			
			nBseISS := aNfItem[nItem][IT_VALMERC] - IIf( aTes[TS_DESCOND] == "2" , aNfItem[nItem][IT_DESCONTO] , 0 )
			nBseISS := IIf( aTes[TS_BASEISS] > 0 , ( nBseISS * aTes[TS_BASEISS] ) / 100 , nBseISS )
			nBseISS := Iif( aNfItem[nItem,IT_REDISS] > 0 , ( nBseISS * aNfItem[nItem,IT_REDISS] ) / 100 , nBseISS )
			nBseISS -= aNfItem[nItem,IT_ABVLISS]
			nBseISS -= aNfItem[nItem,IT_ABMATISS]
			
			aNfItem[nItem][IT_LIVRO][LF_ISENICM] := nBseISS
			
		EndIf
	Endif
	
	// Grava os Valores de Despesas
	aNfItem[nItem][IT_LIVRO][LF_DESPESA] := aNfItem[nItem][IT_DESPESA]+aNfItem[nItem][IT_FRETE]+aNfItem[nItem][IT_SEGURO]
	//SIMPLES SC
	//Sera gravado o valor do ICMS calculado na nota fiscal.
	//Contribuintes do SIMPLES/SC devem destacar o ICMS nos documentos fiscais com
	//destino a optantes do SIMPLES, mas o valor do ICMS nao deve ser apresentado na apuracao.
	
	If SubStr(aNfItem[nItem][IT_LIVRO][LF_CFO],1,1) $ "56" .And. aNfItem[nItem][IT_LIVRO][LF_TIPO] <> "S"
		If aFieldPos[FP_A1_SIMPLES] .And. aFieldPos[FP_F3_SIMPLES]
			If aNfCab[NF_SIMPSC] <> "1" .And. cMvEstado=="SC" .And. aParSX6[MV_SIMPLSC]
				aNfItem[nItem][IT_LIVRO][LF_SIMPLES] := aNfItem[nItem][IT_LIVRO][LF_VALICM]
			Endif
		Endif
	Endif
	
	aNfItem[nItem][IT_LIVRO][LF_ESTCRED] := aNfItem[nItem][IT_ESTCRED]
	aNfItem[nItem][IT_LIVRO][LF_VALCMAJ] := aNfItem[nItem][IT_VALCMAJ]
	aNfItem[nItem][IT_LIVRO][LF_ALQCMAJ] := aTes[TS_ALQCMAJ]
	aNfItem[nItem][IT_LIVRO][LF_VALPMAJ] := aNfItem[nItem][IT_VALPMAJ]
	aNfItem[nItem][IT_LIVRO][LF_ALQPMAJ] := aTes[TS_ALQPMAJ]
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³P.E. para gravacao dos campos por item - 18/01/10³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If aExistPE[PE_XFISLF]
	ExecBlock( "XFISLF", .F., .F.,{nItem})
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Verifica se o TES possui RdMake para geracao/complemento dos Livros Fiscais  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If !Empty(aTes[TS_LIVRO]) .And. cPaisLoc == "BRA"
	aNfItem[nItem][IT_LIVRO] := ExecBlock(aTes[TS_LIVRO],.F.,.F.,{aNfItem[nItem][IT_LIVRO],nItem})
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³PE para manipulação dos valores dos itens (em uso na importação TSF)³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If aExistPE[PE_MXTOTIT]
	ExecBlock("MXTOTIT",.F.,.F.,{nItem})
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Atualiza as referencias do IT_SPED para o Item³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If cPaisLoc == "BRA"
	
	aNfItem[nItem][IT_SPED]	:= {}
	
	If ( aTes[TS_ICM] == "N" .And. aTes[TS_LFICM]$'IO' .And. aNfItem[nItem][IT_VALICM] == 0 .And. aNfItem[nItem][IT_BASEICM] == 0 )
		lLvrICM := .T.
	EndIf
	
	If ( aTes[TS_ICM] == "N" .And. aTes[TS_LFICMST]$'IO' .And. aNfItem[nItem][IT_VALSOL] == 0 .And. aNfItem[nItem][IT_BASESOL] == 0 )
		lLvrSol := .T.
	Elseif ( aTes[TS_ICM] == "N" .And. aTes[TS_LFICM]$'Z' .And. aNfItem[nItem][IT_VALSOL] > 0 .And. aNfItem[nItem][IT_BASESOL] > 0 .And. aTes[TS_OBSSOL]=="5")
		lLvrSol := .T.
	EndIf
	
	//Verifica o ICMS
	If aNfItem[nItem][IT_VALICM] > 0 .Or. aNfItem[nItem][IT_BASEICM] > 0 .Or. lLvrICM
		
		aadd(aNfItem[nItem][IT_SPED],aClone(aImp))
		nImp++
		aNfItem[nItem][IT_SPED][nImp][SP_ITEM]   := aNfItem[nItem][IT_ITEM]
		aNfItem[nItem][IT_SPED][nImp][SP_CODPRO] := aNfItem[nItem][IT_PRODUTO]
		aNfItem[nItem][IT_SPED][nImp][SP_IMP]    := "ICM"
		aNfItem[nItem][IT_SPED][nImp][SP_ORIGEM] := substr(aNfItem[nItem][IT_CLASFIS],1,1)
		aNfItem[nItem][IT_SPED][nImp][SP_CST]    := substr(aNfItem[nItem][IT_CLASFIS],2,2)
		
		// Percentual de reducao de base - se a nota vier do SIGAEIC, pegar o % da TES. 
		// A base ja vem reduzida mas sem o percentual, pois nao tem este dado no item.
		aNfItem[nItem][IT_SPED][nImp][SP_PREDBC] := IIf(aTes[TS_AGREG] $ "B|C", aTes[TS_BASEICM], aNfItem[nItem][IT_PREDIC]) 
		
		aNfItem[nItem][IT_SPED][nImp][SP_BC]     := aNfItem[nItem][IT_BASEICM]
		aNfItem[nItem][IT_SPED][nImp][SP_ALIQ]   := aNfItem[nItem][IT_ALIQICM]
		aNfItem[nItem][IT_SPED][nImp][SP_VLTRIB] := aNfItem[nItem][IT_VALICM]
		If aNfItem[nItem][IT_PAUTIC] > 0
			aNfItem[nItem][IT_SPED][nImp][SP_QTRIB]  := aNfItem[nItem][IT_QUANT]*IIF(!Empty(aParSX6[MV_ICMPFAT]) , aNfItem[nItem][IT_PRD][SB_ICMPFAT] , 1 )
			aNfItem[nItem][IT_SPED][nImp][SP_PAUTA]  := aNfItem[nItem][IT_PAUTIC]
			If aNfItem[nItem][IT_SPED][nImp][SP_PAUTA] > 0 .And. aTes[TS_PAUTICM]=="2"
				aNfItem[nItem][IT_SPED][nImp][SP_MODBC]  := "1"
			Else
				aNfItem[nItem][IT_SPED][nImp][SP_MODBC]  := "2"
			EndIf
		Else
			aNfItem[nItem][IT_SPED][nImp][SP_MODBC]  := 	"3"
		EndIf
		aNfItem[nItem][IT_SPED][nImp][SP_COD_MN] := ""    
		aNfItem[nItem][IT_SPED][nImp][SP_PARTICM] := IIF(!Empty(aTes[TS_PARTICM]), aTes[TS_PARTICM], "1") 
	EndIf
	
	//Verifica o ICMS / ST
	If aNfItem[nItem][IT_VALSOL] > 0 .Or. aNfItem[nItem][IT_BASESOL] > 0 .Or. lLvrSol
		
		aadd(aNfItem[nItem][IT_SPED],aClone(aImp))
		nImp++
		aNfItem[nItem][IT_SPED][nImp][SP_ITEM]   := aNfItem[nItem][IT_ITEM]
		aNfItem[nItem][IT_SPED][nImp][SP_CODPRO] := aNfItem[nItem][IT_PRODUTO]
		aNfItem[nItem][IT_SPED][nImp][SP_IMP]    := "SOL"
		aNfItem[nItem][IT_SPED][nImp][SP_ORIGEM] := substr(aNfItem[nItem][IT_CLASFIS],1,1)
		aNfItem[nItem][IT_SPED][nImp][SP_CST]    := substr(aNfItem[nItem][IT_CLASFIS],2,2)
		aNfItem[nItem][IT_SPED][nImp][SP_PREDBC] := aNfItem[nItem][IT_PREDST]
		aNfItem[nItem][IT_SPED][nImp][SP_BC]     := aNfItem[nItem][IT_BASESOL]
		aNfItem[nItem][IT_SPED][nImp][SP_ALIQ]   := aNfItem[nItem][IT_ALIQSOL]
		aNfItem[nItem][IT_SPED][nImp][SP_VLTRIB] := aNfItem[nItem][IT_VALSOL]
		If aNfItem[nItem][IT_PAUTST] > 0
			aNfItem[nItem][IT_SPED][nImp][SP_QTRIB]  := aNfItem[nItem][IT_QUANT]*IIF(!Empty(aParSX6[MV_ICMPFAT]) , aNfItem[nItem][IT_PRD][SB_ICMPFAT] , 1 )
			aNfItem[nItem][IT_SPED][nImp][SP_PAUTA]  := aNfItem[nItem][IT_PAUTST]
			If aNfItem[nItem][IT_SPED][nImp][SP_PAUTA] > 0 .And. aTes[TS_PAUTICM]=="2"
				aNfItem[nItem][IT_SPED][nImp][SP_MODBC]  := "1"
			Else
				aNfItem[nItem][IT_SPED][nImp][SP_MODBC]  := "2"
			EndIf
		Else
			aNfItem[nItem][IT_SPED][nImp][SP_MVA]    := IIf(aTes[TS_MKPSOL] <> "1" , aNfItem[nItem][IT_MARGEM] , 0 )
			aNfItem[nItem][IT_SPED][nImp][SP_MODBC]  := "0"
		EndIf
		aNfItem[nItem][IT_SPED][nImp][SP_COD_MN] := ""
		aNfItem[nItem][IT_SPED][nImp][SP_PARTICM] := IIF(!Empty(aTes[TS_PARTICM]), aTes[TS_PARTICM], "1") 		
	EndIf
	
	If aNfItem[nItem][IT_VALCMP] > 0
		aadd(aNfItem[nItem][IT_SPED],aClone(aImp))
		nImp++
		aNfItem[nItem][IT_SPED][nImp][SP_ITEM]   := aNfItem[nItem][IT_ITEM]
		aNfItem[nItem][IT_SPED][nImp][SP_CODPRO] := aNfItem[nItem][IT_PRODUTO]
		aNfItem[nItem][IT_SPED][nImp][SP_IMP]    := "CMP"
		aNfItem[nItem][IT_SPED][nImp][SP_ORIGEM] := substr(aNfItem[nItem][IT_CLASFIS],1,1)
		aNfItem[nItem][IT_SPED][nImp][SP_MVA]    := aNfItem[nItem][IT_MVACMP]
		aNfItem[nItem][IT_SPED][nImp][SP_PREDBC] := aNfItem[nItem][IT_PREDCMP]
		aNfItem[nItem][IT_SPED][nImp][SP_BC]     := IIF(aNfItem[nItem][IT_PREDCMP]==0,aNfItem[nItem][IT_BASEICM],aNfItem[nItem][IT_BICMORI])
		aNfItem[nItem][IT_SPED][nImp][SP_ALIQ]   := aNfItem[nItem][IT_ALIQCMP]
		aNfItem[nItem][IT_SPED][nImp][SP_VLTRIB] := aNfItem[nItem][IT_VALCMP]
		aNfItem[nItem][IT_SPED][nImp][SP_COD_MN] := ""
		aNfItem[nItem][IT_SPED][nImp][SP_PARTICM] := IIF(!Empty(aTes[TS_PARTICM]), aTes[TS_PARTICM], "1") 
	EndIf
	
	If aNfItem[nItem][IT_VALIPI] > 0 .Or. aNfItem[nItem][IT_BASEIPI] > 0
		aadd(aNfItem[nItem][IT_SPED],aClone(aImp))
		nImp++
		aNfItem[nItem][IT_SPED][nImp][SP_ITEM]   := aNfItem[nItem][IT_ITEM]
		aNfItem[nItem][IT_SPED][nImp][SP_CODPRO] := aNfItem[nItem][IT_PRODUTO]
		aNfItem[nItem][IT_SPED][nImp][SP_IMP]    := "IPI"
		aNfItem[nItem][IT_SPED][nImp][SP_ORIGEM] := substr(aNfItem[nItem][IT_CLASFIS],1,1)
		aNfItem[nItem][IT_SPED][nImp][SP_CST]	  := IIf( Empty(aParSX6[MV_RCSTIPI]) , aTes[TS_CTIPI] , aParSX6[MV_RCSTIPI] ) //Tratamento de Rastro de ATIVO para IPI.
		aNfItem[nItem][IT_SPED][nImp][SP_PREDBC] := aNfItem[nItem][IT_PREDIPI]
		aNfItem[nItem][IT_SPED][nImp][SP_BC]     := aNfItem[nItem][IT_BASEIPI]
		aNfItem[nItem][IT_SPED][nImp][SP_ALIQ]   := aNfItem[nItem][IT_ALIQIPI]
		aNfItem[nItem][IT_SPED][nImp][SP_VLTRIB] := aNfItem[nItem][IT_VALIPI]
		aNfItem[nItem][IT_SPED][nImp][SP_QTRIB]  := aNfItem[nItem][IT_QUANT]*IIF(!Empty(aParSX6[MV_IPIPFAT]) , aNfItem[nItem][IT_PRD][SB_IPIPFAT] , 1 )
		aNfItem[nItem][IT_SPED][nImp][SP_PAUTA]  := aNfItem[nItem][IT_PAUTIPI]
		aNfItem[nItem][IT_SPED][nImp][SP_COD_MN] := ""
		aNfItem[nItem][IT_SPED][nImp][SP_PARTICM] := IIF(!Empty(aTes[TS_PARTICM]), aTes[TS_PARTICM], "1") 
	EndIf
	
	If aTes[TS_ISS] == "S" .And. (aNfItem[nItem][IT_VALISS] > 0 .Or. aNfItem[nItem][IT_BASEISS] > 0)
		aadd(aNfItem[nItem][IT_SPED],aClone(aImp))
		nImp++
		aNfItem[nItem][IT_SPED][nImp][SP_ITEM]   := aNfItem[nItem][IT_ITEM]
		aNfItem[nItem][IT_SPED][nImp][SP_CODPRO] := aNfItem[nItem][IT_PRODUTO]
		aNfItem[nItem][IT_SPED][nImp][SP_IMP]    := "ISS"
		aNfItem[nItem][IT_SPED][nImp][SP_ORIGEM] := aNfItem[nItem][IT_PRD][SB_ORIGEM]
		aNfItem[nItem][IT_SPED][nImp][SP_CST]    := ""
		aNfItem[nItem][IT_SPED][nImp][SP_PREDBC] := aNfItem[nItem][IT_PREDISS]
		aNfItem[nItem][IT_SPED][nImp][SP_BC]     := aNfItem[nItem][IT_BASEISS]
		aNfItem[nItem][IT_SPED][nImp][SP_ALIQ]   := aNfItem[nItem][IT_ALIQISS]
		aNfItem[nItem][IT_SPED][nImp][SP_VLTRIB] := aNfItem[nItem][IT_VALISS]
		aNfItem[nItem][IT_SPED][nImp][SP_QTRIB]  := 0
		aNfItem[nItem][IT_SPED][nImp][SP_PAUTA]  := 0
		aNfItem[nItem][IT_SPED][nImp][SP_COD_MN] := SM0->M0_CODMUN
		aNfItem[nItem][IT_SPED][nImp][SP_PARTICM] := IIF(!Empty(aTes[TS_PARTICM]), aTes[TS_PARTICM], "1") 
	EndIf
	If aNfItem[nItem][IT_VALPS2] > 0 .Or. aNfItem[nItem][IT_BASEPS2] > 0
		aadd(aNfItem[nItem][IT_SPED],aClone(aImp))
		nImp++
		aNfItem[nItem][IT_SPED][nImp][SP_ITEM]   := aNfItem[nItem][IT_ITEM]
		aNfItem[nItem][IT_SPED][nImp][SP_CODPRO] := aNfItem[nItem][IT_PRODUTO]
		aNfItem[nItem][IT_SPED][nImp][SP_IMP]    := "PS2"
		aNfItem[nItem][IT_SPED][nImp][SP_ORIGEM] := substr(aNfItem[nItem][IT_CLASFIS],1,1)
		aNfItem[nItem][IT_SPED][nImp][SP_CST]    := aTES[TS_CSTPIS]
		aNfItem[nItem][IT_SPED][nImp][SP_MODBC]  := ""
		aNfItem[nItem][IT_SPED][nImp][SP_MVA]    := 0
		aNfItem[nItem][IT_SPED][nImp][SP_PREDBC] := 0
		aNfItem[nItem][IT_SPED][nImp][SP_BC]     := aNfItem[nItem][IT_BASEPS2]
		aNfItem[nItem][IT_SPED][nImp][SP_ALIQ]   := aNfItem[nItem][IT_ALIQPS2]
		aNfItem[nItem][IT_SPED][nImp][SP_VLTRIB] := aNfItem[nItem][IT_VALPS2]
		aNfItem[nItem][IT_SPED][nImp][SP_QTRIB]  := aNfItem[nItem,IT_QUANT]
		aNfItem[nItem][IT_SPED][nImp][SP_PAUTA]  := IIF((Empty(aNFitem[nItem,IT_EXCECAO]).Or.Empty(aNFItem[nItem,IT_EXCECAO,10]).Or.aNfItem[nItem,IT_QUANT]==0.Or. aParSX6[MV_PISPAUT] ),aNfItem[nItem][IT_PRD][SB_VLR_PIS],aNFItem[nItem,IT_EXCECAO,10])
		aNfItem[nItem][IT_SPED][nImp][SP_COD_MN] := ""
		aNfItem[nItem][IT_SPED][nImp][SP_PARTICM] := IIF(!Empty(aTes[TS_PARTICM]), aTes[TS_PARTICM], "1") 
	EndIf
	
	If aNfItem[nItem][IT_VALCF2] > 0 .Or. aNfItem[nItem][IT_BASECF2] > 0
		aadd(aNfItem[nItem][IT_SPED],aClone(aImp))
		nImp++
		aNfItem[nItem][IT_SPED][nImp][SP_ITEM]   := aNfItem[nItem][IT_ITEM]
		aNfItem[nItem][IT_SPED][nImp][SP_CODPRO] := aNfItem[nItem][IT_PRODUTO]
		aNfItem[nItem][IT_SPED][nImp][SP_IMP]    := "CF2"
		aNfItem[nItem][IT_SPED][nImp][SP_ORIGEM] := substr(aNfItem[nItem][IT_CLASFIS],1,1)
		aNfItem[nItem][IT_SPED][nImp][SP_CST]    := aTES[TS_CSTCOF]
		aNfItem[nItem][IT_SPED][nImp][SP_MODBC]  := ""
		aNfItem[nItem][IT_SPED][nImp][SP_MVA]    := 0
		aNfItem[nItem][IT_SPED][nImp][SP_PREDBC] := 0
		aNfItem[nItem][IT_SPED][nImp][SP_BC]     := aNfItem[nItem][IT_BASECF2]
		aNfItem[nItem][IT_SPED][nImp][SP_ALIQ]   := aNfItem[nItem][IT_ALIQCF2]
		aNfItem[nItem][IT_SPED][nImp][SP_VLTRIB] := aNfItem[nItem][IT_VALCF2]
		aNfItem[nItem][IT_SPED][nImp][SP_QTRIB]  := aNfItem[nItem,IT_QUANT]
		aNfItem[nItem][IT_SPED][nImp][SP_PAUTA]  := IIF((Empty(aNFitem[nItem,IT_EXCECAO]).Or.Empty(aNFItem[nItem,IT_EXCECAO,11]).Or.aNfItem[nItem,IT_QUANT]==0.Or. aParSX6[MV_COFPAUT]),aNfItem[nItem][IT_PRD][SB_VLR_COF],aNFItem[nItem,IT_EXCECAO,11])
		aNfItem[nItem][IT_SPED][nImp][SP_COD_MN] := ""
		aNfItem[nItem][IT_SPED][nImp][SP_PARTICM] := IIF(!Empty(aTes[TS_PARTICM]), aTes[TS_PARTICM], "1") 
	EndIf
	
	If aNfItem[nItem][IT_VALPS3] > 0 .Or. aNfItem[nItem][IT_BASEPS3] > 0
		aadd(aNfItem[nItem][IT_SPED],aClone(aImp))
		nImp++
		aNfItem[nItem][IT_SPED][nImp][SP_ITEM]   := aNfItem[nItem][IT_ITEM]
		aNfItem[nItem][IT_SPED][nImp][SP_CODPRO] := aNfItem[nItem][IT_PRODUTO]
		aNfItem[nItem][IT_SPED][nImp][SP_IMP]    := "PS3"
		aNfItem[nItem][IT_SPED][nImp][SP_ORIGEM] := substr(aNfItem[nItem][IT_CLASFIS],1,1)
		aNfItem[nItem][IT_SPED][nImp][SP_CST]    := aTES[TS_CSTPIS]
		aNfItem[nItem][IT_SPED][nImp][SP_MODBC]  := ""
		aNfItem[nItem][IT_SPED][nImp][SP_MVA]    := 0
		aNfItem[nItem][IT_SPED][nImp][SP_PREDBC] := 0
		aNfItem[nItem][IT_SPED][nImp][SP_BC]     := aNfItem[nItem][IT_BASEPS3]
		aNfItem[nItem][IT_SPED][nImp][SP_ALIQ]   := aNfItem[nItem][IT_ALIQPS3]
		aNfItem[nItem][IT_SPED][nImp][SP_VLTRIB] := aNfItem[nItem][IT_VALPS3]
		aNfItem[nItem][IT_SPED][nImp][SP_QTRIB]  := 0
		aNfItem[nItem][IT_SPED][nImp][SP_PAUTA]  := 0
		aNfItem[nItem][IT_SPED][nImp][SP_COD_MN] := ""
		aNfItem[nItem][IT_SPED][nImp][SP_PARTICM] := IIF(!Empty(aTes[TS_PARTICM]), aTes[TS_PARTICM], "1") 
	EndIf
	
	If aNfItem[nItem][IT_VALCF3] > 0 .Or. aNfItem[nItem][IT_BASECF3] > 0
		aadd(aNfItem[nItem][IT_SPED],aClone(aImp))
		nImp++
		aNfItem[nItem][IT_SPED][nImp][SP_ITEM]   := aNfItem[nItem][IT_ITEM]
		aNfItem[nItem][IT_SPED][nImp][SP_CODPRO] := aNfItem[nItem][IT_PRODUTO]
		aNfItem[nItem][IT_SPED][nImp][SP_IMP]    := "CF3"
		aNfItem[nItem][IT_SPED][nImp][SP_ORIGEM] := substr(aNfItem[nItem][IT_CLASFIS],1,1)
		aNfItem[nItem][IT_SPED][nImp][SP_CST]    := aTES[TS_CSTCOF]
		aNfItem[nItem][IT_SPED][nImp][SP_MODBC]  := ""
		aNfItem[nItem][IT_SPED][nImp][SP_MVA]    := 0
		aNfItem[nItem][IT_SPED][nImp][SP_PREDBC] := 0
		aNfItem[nItem][IT_SPED][nImp][SP_BC]     := aNfItem[nItem][IT_BASECF3]
		aNfItem[nItem][IT_SPED][nImp][SP_ALIQ]   := aNfItem[nItem][IT_ALIQCF3]
		aNfItem[nItem][IT_SPED][nImp][SP_VLTRIB] := aNfItem[nItem][IT_VALCF3]
		aNfItem[nItem][IT_SPED][nImp][SP_QTRIB]  := 0
		aNfItem[nItem][IT_SPED][nImp][SP_PAUTA]  := 0
		aNfItem[nItem][IT_SPED][nImp][SP_COD_MN] := ""
		aNfItem[nItem][IT_SPED][nImp][SP_PARTICM] := IIF(!Empty(aTes[TS_PARTICM]), aTes[TS_PARTICM], "1") 
	EndIf
	
	If aNfItem[nItem][IT_VALTST] > 0 .Or. aNfItem[nItem][IT_BASETST] > 0
		aadd(aNfItem[nItem][IT_SPED],aClone(aImp))
		nImp++
		aNfItem[nItem][IT_SPED][nImp][SP_ITEM]   := aNfItem[nItem][IT_ITEM]
		aNfItem[nItem][IT_SPED][nImp][SP_CODPRO] := aNfItem[nItem][IT_PRODUTO]
		aNfItem[nItem][IT_SPED][nImp][SP_IMP]    := "TST"
		aNfItem[nItem][IT_SPED][nImp][SP_ORIGEM] := aNfItem[nItem][IT_PRD][SB_ORIGEM]
		aNfItem[nItem][IT_SPED][nImp][SP_CST]    := aTES[TS_CSTCOF]
		aNfItem[nItem][IT_SPED][nImp][SP_MODBC]  := ""
		aNfItem[nItem][IT_SPED][nImp][SP_MVA]    := 0
		aNfItem[nItem][IT_SPED][nImp][SP_PREDBC] := 0
		aNfItem[nItem][IT_SPED][nImp][SP_BC]     := aNfItem[nItem][IT_BASETST]
		aNfItem[nItem][IT_SPED][nImp][SP_ALIQ]   := aNfItem[nItem][IT_ALIQTST]
		aNfItem[nItem][IT_SPED][nImp][SP_VLTRIB] := aNfItem[nItem][IT_VALTST]
		aNfItem[nItem][IT_SPED][nImp][SP_QTRIB]  := 0
		aNfItem[nItem][IT_SPED][nImp][SP_PAUTA]  := 0
		aNfItem[nItem][IT_SPED][nImp][SP_COD_MN] := ""
		aNfItem[nItem][IT_SPED][nImp][SP_PARTICM] := IIF(!Empty(aTes[TS_PARTICM]), aTes[TS_PARTICM], "1") 
	EndIf
	
	If aNfItem[nItem][IT_DESCZF]>0 .And. aFieldPos[FP_CD2_DESCZF]
		aadd(aNfItem[nItem][IT_SPED],aClone(aImp))
		nImp++
		aNfItem[nItem][IT_SPED][nImp][SP_ITEM]   := aNfItem[nItem][IT_ITEM]
		aNfItem[nItem][IT_SPED][nImp][SP_CODPRO] := aNfItem[nItem][IT_PRODUTO]
		aNfItem[nItem][IT_SPED][nImp][SP_IMP]    := "ZFM"
		aNfItem[nItem][IT_SPED][nImp][SP_ORIGEM] := substr(aNfItem[nItem][IT_CLASFIS],1,1)
		aNfItem[nItem][IT_SPED][nImp][SP_CST]    := aTES[TS_CSTCOF]
		aNfItem[nItem][IT_SPED][nImp][SP_MODBC]  := ""
		aNfItem[nItem][IT_SPED][nImp][SP_MVA]    := 0
		aNfItem[nItem][IT_SPED][nImp][SP_PREDBC] := 0
		aNfItem[nItem][IT_SPED][nImp][SP_BC]     := 0
		aNfItem[nItem][IT_SPED][nImp][SP_ALIQ]   := 0
		aNfItem[nItem][IT_SPED][nImp][SP_VLTRIB] := 0
		aNfItem[nItem][IT_SPED][nImp][SP_QTRIB]  := 0
		aNfItem[nItem][IT_SPED][nImp][SP_PAUTA]  := 0
		aNfItem[nItem][IT_SPED][nImp][SP_COD_MN] := ""
		aNfItem[nItem][IT_SPED][nImp][SP_DESCZF] := aNfItem[nItem][IT_DESCZF]
		aNfItem[nItem][IT_SPED][nImp][SP_PARTICM] := IIF(!Empty(aTes[TS_PARTICM]), aTes[TS_PARTICM], "1") 
	EndIf
	
EndIf

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡„o    ³MaRateio  ³ Autor ³Edson Maricate         ³ Data ³20.12.2000 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo efetuar o rateio das despesas  ³±±
±±³          ³acessorias sobre todos os itens da nota fiscal, exceto os    ³±±
±±³          ³que possuirem a referencia ISS.                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Nome da Referencia da despesas acessoria              ³±±
±±³          ³ExpN2: Valor atual da despesa acessoria                      ³±±
±±³          ³ExpN3: Novo valor da despesa acessoria                       ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaRateio(cReferencia,nAnterior,nAtual,lDupl)

Local aRateio    := {}
Local nX		 := 0
Local nDiferenca := 0
Local nY		 := 0
Local nSoma 	 := 0
Local nValMISS   := 0
Local nValDISS   := 0
Local nPesoMISS  := 0
Local nDec       := 2
Local nItValMerc := 0
Local nBseRateio := 0
Local aPosCpo	 := MaFisScan(cReferencia)      
Local cMvRatDesp := aParSX6[MV_RATDESP]
Local cTpRatDesp := Substr(cMvRatDesp,AT("DESP=",cMvRatDesp)+5,1)
Local cTpRatFrete:= Substr(cMvRatDesp,AT("FR=",cMvRatDesp)+3,1)
Local cTpRatSeg	 := Substr(cMvRatDesp,AT("SEG=",cMvRatDesp)+4,1)
Local cTpRatNTr	 := Substr(cMvRatDesp,AT("NTRB=",cMvRatDesp)+5,1)
Local cTpRatTara := Substr(cMvRatDesp,AT("TARA=",cMvRatDesp)+5,1)
Local lRatDesc	 :=	( (cReferencia == "IT_DESCONTO" .OR. cReferencia == "IT_DESCTOT" ) .And. cPaisLoc <> "BRA" .And. aNfCab[NF_OPERNF] == "S" .And. aParSX6[MV_DESCSAI] == "1" )
Local lRateiaIt  := .T.

DEFAULT lDupl := .F.

If cPaisLoc<>"BRA"
	If FunName()=="MATA121" .And. Type("nMoedaPed")=="N"
		nDec:=MsDecimais(nMoedaPed)
	ElseIf FunName()=="MATA123" .And. Type("nMoedaPed")=="N"
		nDec:=MsDecimais(nMoedaPed)
	ElseIf FunName()=="MATA150" .And. Type("nMoedaCot")=="N"
		nDec:=MsDecimais(nMoedaCot)
	ElseIf FunName()=="MATA160" .And. Type("nMoedaAval")=="N"
		nDec:=MsDecimais(nMoedaAval)					
	ElseIf Type("nMoedaNF")=="N"
		nDec:=MsDecimais(nMoedaNF)
	ElseIf Type("nMoedaCor")=="N"
		nDec:=MsDecimais(nMoedaCor)
	ElseIf Type("M->F1_MOEDA")=="N"
		nDec:=MsDecimais(M->F1_MOEDA)
	ElseIf Type("M->F2_MOEDA")=="N"
		nDec:=MsDecimais(M->F2_MOEDA)
	Else
		nDec:=MsDecimais(1)
	Endif
Endif

If aExistPE[PE_MARATEIO]
	aRateio := ExecBlock("MARATEIO",.F.,.F.,{cTpRatDesp,cTpRatFrete,cTpRatSeg,cTpRatNTr,cTpRatTara})
	cTpRatDesp  := aRateio[1]
	cTpRatFrete := aRateio[2]
	cTpRatSeg   := aRateio[3]
	cTpRatNTr	:= Iif(Len(aRateio) > 3 , aRateio[4] , "" )
	cTpRatTara	:= Iif(Len(aRateio) > 4 , aRateio[5] , "" )
EndIf

If ( "FRETE"$cReferencia .Or. "SEGURO"$cReferencia .Or. "DESPESA"$cReferencia .Or. "VLR_FRT"$cReferencia .Or. "DESNTRB"$cReferencia .Or."TARA"$cReferencia)
	If aNfCab[NF_PESO] <> 0 .And. ((cReferencia == "IT_FRETE" .And. cTpRatFrete == "2" ) .Or. ;
			(cReferencia == "IT_DESPESA" .And. cTpRatDesp == "2" ).Or.;
			(cReferencia == "IT_SEGURO"  .And. cTpRatSeg  == "2" ).Or.;
			(cReferencia == "IT_VLR_FRT" .And. cTpRatFrete== "2" ).Or.;
			(cReferencia == "IT_DESNTRB" .And. cTpRatNTr  == "2" ).Or.;
			(cReferencia == "IT_TARA"    .And. cTpRatTara == "2" ))
		aEval(aNfItem,{|x| nPesoMISS+= If(!x[IT_DELETED] .And. x[IT_RATEIOISS]=="S" .And. (!lDupl .Or. x[IT_BASEDUP]>0),x[IT_PESO],0)})
	Else		
		aEval(aNfItem,{|x| nValMISS += If(!x[IT_DELETED] .And. x[IT_RATEIOISS]=="S" .And. (!lDupl .Or. x[IT_BASEDUP]>0),(x[IT_VALMERC]+x[IT_VNAGREG]),0)})
		aEval(aNfItem,{|x| nValDISS += If(!x[IT_DELETED] .And. x[IT_RATEIOISS]=="S" .And. (!lDupl .Or. x[IT_BASEDUP]>0),((x[IT_VALMERC]-(x[IT_DESCONTO]+x[IT_DESCTOT]))+x[IT_VNAGREG]),0)})
	EndIf
EndIf

//³ O MV_VALDESP = T impede que as despesas sejam rateadas no item com F4_ICMS = N para que o valor total das despesas sejam rateadas entre os itens F4_ICMS=S para que o frete integral faca parte da base do ICMS   ³

// OBSERVACAO - INFORMACOES DA TES PODERIA ESTAR NO ITEM 
If aParSX6[MV_VALDESP]
	For nX	:= 1 to Len(aNfItem)
		SF4->(dbSetOrder(1))
		SF4->(MsSeek(xFilial("SF4")+aNfItem[nX][IT_TES] ))
		If SF4->F4_ICM == "N" .And. !aNfItem[nX][IT_DELETED]
			nItValMerc += aNfItem[nX][IT_VALMERC]
		EndIf
	Next nX
EndIf

If nAnterior > 0
	nDiferenca := (nAtual-nAnterior) / nAnterior
	For nX	:= 1 to Len(aNfItem)
        
        lRateiaIt := .T.
		SF4->(dbSetOrder(1))
		SF4->(MsSeek(xFilial("SF4")+aNfItem[nX][IT_TES] ))
		If aParSX6[MV_VALDESP] .And. SF4->F4_ICM == "N"
			If ValType(aPosCpo) == "A"
				aNfItem[nX][aPosCpo[1]][aPosCpo[2]] := 0				
            Else
				aNfItem[nX][Val(aPosCpo)] := 0
            EndIf
            lRateiaIt := .F. //Impede que o item participe do rateio das depesas
        EndIf
        
		If lRateiaIt .And. !aNfItem[nX][IT_DELETED] .And.;
			!( aNfItem[nX][IT_RATEIOISS]=="S" .And. ("FRETE"$cReferencia .Or. "SEGURO"$cReferencia .Or. "DESPESA"$cReferencia .Or. "VLR_FRT"$cReferencia .Or. "DESNTRB"$cReferencia .Or."TARA"$cReferencia) ) .And.;
			(!lDupl .Or. aNfItem[nX][IT_BASEDUP]>0)
			
			If ValType(aPosCpo) == "A"
				aNfItem[nX][aPosCpo[1]][aPosCpo[2]] := NoRound((1+nDiferenca)*aNfItem[nX][aPosCpo[1]][aPosCpo[2]],nDec)   
				IF cPaisLoc=="COL" .And. (NoRound((1+nDiferenca)*aNfItem[nX][aPosCpo[1]][aPosCpo[2]],nDec) == 0)  
					Loop
				Else  
					nY := nX
			    EndIf
				nSoma += aNfItem[nX][aPosCpo[1]][aPosCpo[2]]  
			Else 
			   IF cPaisLoc=="COL" .And. (NoRound((1+nDiferenca)*aNfItem[nX][Val(aPosCpo)],nDec) == 0) .And. (NoRound((1+nDiferenca)*aNfItem[nX][Val(aPosCpo)],nDec)==0)
					Loop
				Else  
					nY := nX
			    EndIf
				If lRatDesc			
					aNFitem[nX][IT_VALMERC]   += aNfItem[nX][Val(aPosCpo)]
					aNfItem[nX][Val(aPosCpo)] := NoRound((1+nDiferenca)*aNfItem[nX][Val(aPosCpo)],nDec)
					nSoma += aNfItem[nX][Val(aPosCpo)]
				Else
					aNfItem[nX][Val(aPosCpo)] := NoRound((1+nDiferenca)*aNfItem[nX][Val(aPosCpo)],nDec)
					nSoma += aNfItem[nX][Val(aPosCpo)]
				Endif
			EndIf
		EndIf

	Next nX
	//³ Efetua a correcao da dizima no primeiro item.          ³
	If nY <> 0
		If ValType(aPosCpo) == "A"
			aNfItem[nY][aPosCpo[1]][aPosCpo[2]] += nAtual - nSoma
		Else
			aNfItem[nY][Val(aPosCpo)] += nAtual - nSoma
		EndIf
	EndIf
Else
	For nX	:= 1 to Len(aNfItem)

        lRateiaIt := .T.
		SF4->(dbSetOrder(1))
		SF4->(MsSeek(xFilial("SF4") + aNfItem[nX][IT_TES] ))
		If aParSX6[MV_VALDESP] .And. SF4->F4_ICM == "N"
			If ValType(aPosCpo) == "A"
				aNfItem[nX][aPosCpo[1]][aPosCpo[2]] := 0				
            Else
				aNfItem[nX][Val(aPosCpo)] := 0
            EndIf
           lRateiaIt := .F. //Impede que o item participe do rateio das depesas
        EndIf

		If lRateiaIt .And. !aNfItem[nX][IT_DELETED] .And.;
			!( aNfItem[nX][IT_RATEIOISS]=="S" .And. ("FRETE"$cReferencia .Or. "SEGURO"$cReferencia .Or. "DESPESA"$cReferencia .Or. "VLR_FRT"$cReferencia .Or. "DESNTRB"$cReferencia .Or."TARA"$cReferencia) ).And.;
			(!lDupl .Or. aNfItem[nX][IT_BASEDUP]>0)
			nY := nX
			//³ Efetua o rateio do valor informado nos itens da NF     ³
			//³ O rateio das despesas ( frete/seguro/despesas ) podera ³
			//³ ser efetuado por valor ou peso, de acordo com a config.³
			//³ do parametro MV_RATDESP.                               ³
			If aNfCab[NF_PESO] <> 0 .And. (( cReferencia == "IT_FRETE" .And. cTpRatFrete == "2" ) .Or. ;
					(cReferencia=="IT_DESPESA" .And. cTpRatDesp == "2") .Or. ;
					(cReferencia=="IT_SEGURO"  .And. cTpRatSeg  == "2") .Or. ;
					(cReferencia=="IT_VLR_FRT" .And. cTpRatFrete== "2") .Or. ;
					(cReferencia=="IT_DESNTRB" .And. cTpRatNTr  == "2") .Or. ;
					(cReferencia=="IT_TARA"    .And. cTpRatTara == "2"))
				//³ Rateio por Peso.    ³
				If ValType(aPosCpo) == "A"
					aNfItem[nX][aPosCpo[1]][aPosCpo[2]] += NoRound((nAtual-nAnterior)*(aNfItem[nX][IT_PESO]/(aNfCab[NF_PESO]-nPesoMISS)),nDec)
					nSoma += aNfItem[nX][aPosCpo[1]][aPosCpo[2]]
				Else
					aNfItem[nX][Val(aPosCpo)] += NoRound((nAtual-nAnterior)*(aNfItem[nX][IT_PESO]/(aNfCab[NF_PESO]-nPesoMISS)),nDec)
					nSoma += aNfItem[nX][Val(aPosCpo)]
				EndIf
			Else
				//³ Rateio por Valor.   ³
				If ValType(aPosCpo) == "A"
					aNfItem[nX][aPosCpo[1]][aPosCpo[2]] += NoRound((nAtual-nAnterior)*(aNfItem[nX][IT_VALMERC]/((aNfCab[NF_VALMERC]+aNfCab[NF_VNAGREG] - nItValMerc )-nValMISS)),nDec)
					nSoma += aNfItem[nX][aPosCpo[1]][aPosCpo[2]]
				Else
					If lRatDesc
						aNFitem[nX][IT_VALMERC]  += NoRound(aNfItem[nX][Val(aPosCpo)],nDec)
						aNfItem[nX][Val(aPosCpo)]+= NoRound((nAtual-nAnterior)*(aNfItem[nX][IT_VALMERC]/((aNfCab[NF_VALMERC]+aNfCab[NF_VNAGREG]- nItValMerc )-nValMISS)),nDec)
						nSoma += aNfItem[nX][Val(aPosCpo)]
					Else
						If aNfCab[NF_ROTINA] == "MATA461"   
							nBseRateio := Iif(("FRETE"$cReferencia .Or. "SEGURO"$cReferencia .Or. "DESPESA"$cReferencia) .And. aNfItem[nX][IT_DESCONTO] > 0 , aNfCab[NF_TOTAL] - aNfCab[NF_VALIPI], aNfCab[NF_VALMERC] )
							//Realizada correcao para que o rateio por valor seja realizado corretamente quando existir abatimento C5_DESCONT no pedido de venda.                                                                       ³
							aNfItem[nX][Val(aPosCpo)]+= Round((nAtual-nAnterior)*((aNfItem[nX][IT_VALMERC]-(aNfItem[nX][IT_DESCONTO]+aNfItem[nX][IT_DESCTOT]))/((( nBseRateio - nItValMerc)+aNfCab[NF_VNAGREG])-nValDISS)),MsDecimais(aNfCab[NF_MOEDA]))
						Else                             
							aNfItem[nX][Val(aPosCpo)]+= Round((nAtual-nAnterior)*(aNfItem[nX][IT_VALMERC]/((aNfCab[NF_VALMERC] - nItValMerc +aNfCab[NF_VNAGREG])-nValMISS)),MsDecimais(aNfCab[NF_MOEDA]))
						EndIf						
						nSoma += aNfItem[nX][Val(aPosCpo)]
					Endif
				EndIf
			EndIf
		EndIf
	Next nX

	//³ Efetua a correcao da dizima no primeiro item.          ³
	If nY <> 0
		If ValType(aPosCpo) == "A"
			If aNfItem[nY][aPosCpo[1]][aPosCpo[2]] + ( nAtual-nSoma ) >= 0
				aNfItem[nY][aPosCpo[1]][aPosCpo[2]] += nAtual-nSoma
            Else
                For nY :=1 to Len(aNfItem)
					If aNfItem[nY][aPosCpo[1]][aPosCpo[2]] + ( nAtual-nSoma ) >= 0
 						aNfItem[nY][aPosCpo[1]][aPosCpo[2]] += nAtual-nSoma
                        Exit
                    EndIf
                Next nY
            EndIf
		Else
            If aNfItem[nY][Val(aPosCpo)] + ( nAtual-nSoma ) >= 0 
				aNfItem[nY][Val(aPosCpo)] += nAtual-nSoma
            Else
                For nY :=1 to Len(aNfItem)
                	If aNfItem[nY][Val(aPosCpo)] + ( nAtual-nSoma ) >= 0 
						aNfItem[nY][Val(aPosCpo)] += nAtual-nSoma
                        Exit
                    EndIf
                Next nY
            EndIf
		EndIf
	EndIf  
	
	

EndIf

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡„o    ³MaFisRatRe³ Autor ³Edson Maricate         ³ Data ³20.12.1999 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo distribuir o valor da referenci³±±
±±³          ³a alterada, entre os itens de mesma referencia.              ³±±
±±³          ³Rateio do resumo de impostos                                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Nome da Referencia do imposto                         ³±±
±±³          ³ExpN2: Valor atual da referencia                             ³±±
±±³          ³ExpN3: Aliquota da referencia alterada                       ³±±
±±³          ³ExpN4: Nome da Referencia Aliquota para este imposto         ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisRatRes(cReferencia,nAtual,nAliquota,cCpoAliq,cCpoBase,nItemNao)

Local aPosCpo 	:= MaFisScan(cReferencia)
Local nCpoAliq	:= MaFisScan(cCpoAliq)
Local nCpoBase	:= MaFisScan(cCpoBase,.F.)
Local nX        := 0
Local nTotAcum	:= 0
Local nAuxItem	:= 0
Local nAliqItem	:= 0
Local nBaseTot	:= 0
Local nVlrTot   := 0
Local nFator    := 0       
Local nPosItRef := 0
Local nDecimais	:= 0 
Local lAuxItem	:= .T.

nAtual := Round(nAtual,MsDecimais( aNFCab[NF_MOEDA] ))

DEFAULT nItemNao	:=	0

For nX := 1 To Len(aNFItem)
	If !Empty(nCpoBase) // so se existir a base, no caso de Dif. de Aliquota nao existe
		//Soh somar as bases da mesma aliquota, porque o rateio eh soh para os itens da mesma aliquota
		If (MaFisRet(nX,cCpoAliq)==nAliquota ) 
			nBaseTot+=IIf(!aNfItem[nX][IT_DELETED],MaFisRet(nX,cCpoBase),0)
		EndIf
	Else
		If nBaseTot <= 0
			nVlrTot+=IIf(!aNfItem[nX][IT_DELETED],MaFisRet(nX,cReferencia),0)
		EndIf
	EndIf
Next nX

If cPaisLoc $"ARG/PER"
	nDecimais := MsDecimais( aNFCab[NF_MOEDA] )
Endif

For nX := 1 to Len(aNfItem)
	If !aNfItem[nX][IT_DELETED]
		If nAtual <> 0 .And. nAtual == nTotAcum .And. cPaisLoc == "BRA"
			Exit
		Endif	
		If !Empty(nCpoBase) // so se existir a base, no caso de Dif. de Aliquota nao existe
			//O rateio de impostos eh feito com base na base calculada para cada item
			nFator := MaFisRet(nX,cCpoBase)/nBaseTot
        Else
			If nBaseTot <= 0
				nFator := MaFisRet(nX,cReferencia)/nVlrTot
         	EndIf 
		EndIf
		If ValType(nCpoAliq) == "A"
			nAliqItem := aNfItem[nX][nCpoAliq[1]][nCpoAliq[2]]
		Else
			nAliqItem := aNfItem[nX][Val(nCpoAliq)]
		EndIf

		If nAliqItem == nAliquota

			If nX <> nItemNao			
				MaFisSomaIt(nX,.F.)
			Endif

			If lAuxItem
				nAuxItem := nX
				lAuxItem := .F.
			EndIf
			
			nPosItRef := Ascan(aItemRef,{|x| x[1] == cReferencia})

			If nPosItRef > 0			
				If aItemRef[nPosItRef][4] .And. aItemRef[nPosItRef][5]
					If ValType(aPosCpo) == "A"
						nTotAcum += aNfItem[nX][aPosCpo[1]][aPosCpo[2]]:= NoRound(nFator*nAtual,2)
					Else
						nTotAcum += aNfItem[nX][Val(aPosCpo)]:= NoRound(nFator*nAtual,2)
					EndIf
				Else
					If ValType(aPosCpo) == "A"
						nTotAcum += aNfItem[nX][aPosCpo[1]][aPosCpo[2]]:= IIf(cPaisLoc$"PAR/PER" , NoRound(nFator*nAtual,nDecimais) , nFator*nAtual )
					Else
						nTotAcum += aNfItem[nX][Val(aPosCpo)] := IIf(cPaisLoc$"PAR/PER" , NoRound(nFator*nAtual,nDecimais) , nFator*nAtual )
					EndIf
				EndIf
			Else
				If ValType(aPosCpo) == "A"
					nTotAcum += aNfItem[nX][aPosCpo[1]][aPosCpo[2]]:= IIf(cPaisLoc$"PAR/PER" , NoRound(nFator*nAtual,nDecimais) , nFator*nAtual )
				Else
					nTotAcum += aNfItem[nX][Val(aPosCpo)] := IIf(cPaisLoc$"PAR/PER" , NoRound(nFator*nAtual,nDecimais) , nFator*nAtual )
				EndIf
			Endif	
		EndIf
	EndIf
Next nX

If !lAuxItem .And. nAtual <> nTotAcum
	If ValType(aPosCpo) == "A"
		aNfItem[nAuxItem][aPosCpo[1]][aPosCpo[2]] += (nAtual-nTotAcum)
	Else
		aNfItem[nAuxItem][Val(aPosCpo)] += (nAtual-nTotAcum)
	EndIf
EndIf

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisPreCalc³ Autor ³Alexandre Lemes      ³ Data ³28/12/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Utilizar esta funcao para alimentar todos dados necessarios ³±±
±±³          ³no array aNFItem ANTES do calculo dos impostos pelas funcoes³±±
±±³          ³de impostos, esta e uma funcao PRE-CALCULO, esta funcao deve³±±
±±³          ³ser utilizada para alimentar qualquer posicao do aNFItem com³±±
±±³          ³essa caracteristica                                         ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisPreCalc(nItem,cCampo)
DEFAULT cCampo	:= ""

If cPaisLoc == "BRA"
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Grava o conteudo do campo Codigo de Autorização - CODIF - DIAT-SC³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	aNfItem[nItem][IT_CODIF] := aNfItem[nItem][IT_PRD][SB_CODIF]
	aNFitem[nItem][IT_B1DIAT]:= aNfItem[nItem][IT_PRD][SB_PRDDIAT]

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Atualiza a classificacao fiscal de ICMS³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
    If !isInCallStack("TSFGRVNF") 
		If  cCampo$"IT_PRODUTO/IT_TES"  .Or. Len(Alltrim(aNfitem[nItem][IT_CLASFIS]))<3
	
			If aParSX6[MV_STFRETE] .And. (AllTrim(aNFCab[NF_ESPECIE]) $ "CTR/CTE/CTA/CTF" .Or. "NFST"$AllTrim(aNFCab[NF_ESPECIE]))
				aNfitem[nItem][IT_CLASFIS] := "0" + aTes[TS_SITTRIB] // Comforme parecer da Consultoria Tributaria emitido no chamado SCSFW2
			Else
				aNfitem[nItem][IT_CLASFIS] := aNfItem[nItem][IT_PRD][SB_ORIGEM] + aTes[TS_SITTRIB]
			EndIf
	
		Endif
		
		aNfItem[nItem][IT_LIVRO][LF_CLASFIS] := aNfItem[nItem][IT_CLASFIS]
	EndIF
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Atualiza Natureza da Operacao/Prestacao.³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	aNfItem[nItem][IT_NATOPER] := IIf( aFieldPos[FP_F4_NATOPER] , aTes[TS_NATOPER] , "" )
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Atualiza Natureza da Receita³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	//Por se tratar de Natureza da RECEITA, faco as validacoes apenas para notas fiscais de saida
	
	If aNFCab[NF_OPERNF] == "S"
		
		//O valor da Tabela e Codigo da Receita da Natureza deverão ser atualizados quando trocar TES ou produto.
		//If Empty(aNfItem[nItem][IT_TABNTRE])
		
		// Se nao pegou da excecao busca SC6
   		If ((aFieldPos[FP_C6_TNATREC]).And.(aFieldPos[FP_C6_CNATREC]).And.(aFieldPos[FP_C6_GRPNATR]).And.(aFieldPos[FP_C6_DTFIMNT])) .And. aNfCab[NF_ROTINA] == "MATA461" .And. !Empty(SC6->C6_TNATREC) 
			aNfItem[nItem][IT_TABNTRE] := SC6->C6_TNATREC
			aNfItem[nItem][IT_CODNTRE] := SC6->C6_CNATREC
			aNfItem[nItem][IT_GRPNTRE] := SC6->C6_GRPNATR
			aNfItem[nItem][IT_DATNTRE] := SC6->C6_DTFIMNT
		// Se nao pegou da SC6 busca SF4
		Elseif ((aFieldPos[FP_F4_TNATREC]).And.(aFieldPos[FP_F4_CNATREC]).And.(aFieldPos[FP_F4_GRPNATR]).And.(aFieldPos[FP_F4_DTFIMNT])) .And. !Empty(SF4->F4_TNATREC)
			aNfItem[nItem][IT_TABNTRE] := SF4->F4_TNATREC
			aNfItem[nItem][IT_CODNTRE] := SF4->F4_CNATREC
			aNfItem[nItem][IT_GRPNTRE] := SF4->F4_GRPNATR
			aNfItem[nItem][IT_DATNTRE] := SF4->F4_DTFIMNT
		// Se nao pegou SF4 busca do SB1
		Elseif ((aFieldPos[FP_B1_TNATREC]).And.(aFieldPos[FP_B1_CNATREC]).And.(aFieldPos[FP_B1_GRPNATR]).And.(aFieldPos[FP_B1_DTFIMNT]))
			aNfItem[nItem][IT_TABNTRE] := aNfItem[nItem][IT_PRD][SB_TNATREC]
			aNfItem[nItem][IT_CODNTRE] := aNfItem[nItem][IT_PRD][SB_CNATREC]
			aNfItem[nItem][IT_GRPNTRE] := aNfItem[nItem][IT_PRD][SB_GRPNATR]
			aNfItem[nItem][IT_DATNTRE] := aNfItem[nItem][IT_PRD][SB_DTFIMNT]
		EndIf
		
		//Prioridade absoluta de preenchimento (SF7)
		If !Empty(aNFitem[nItem][IT_EXCECAO]) .And. !Empty(aNfItem[nItem][IT_EXCECAO][21]) .And. !Empty(aNfItem[nItem][IT_EXCECAO][22])//Busca pela Excecao
			aNfItem[nItem][IT_TABNTRE] := aNfItem[nItem][IT_EXCECAO][21]
			aNfItem[nItem][IT_CODNTRE] := aNfItem[nItem][IT_EXCECAO][22]
			aNfItem[nItem][IT_GRPNTRE] := aNfItem[nItem][IT_EXCECAO][23]
			aNfItem[nItem][IT_DATNTRE] := aNfItem[nItem][IT_EXCECAO][24]
		EndIf
	// Tratamento para devolucoes de venda - Alimentar referencias com as informacoes da NF original.
	ElseIf ( aNFCab[NF_TIPONF] $ "DB" .Or. aTes[TS_PODER3] =="D" ) .And. !Empty(aNFItem[nItem][IT_RECORI])
		If aNFCab[NF_TIPONF] $ "DB"
			If ( aNFCab[NF_CLIFOR] == "C")
				dbSelectArea("SD2")
				MsGoto(aNFItem[nItem][IT_RECORI])
				
				aNfItem[nItem][IT_TABNTRE] := SD2->D2_TNATREC
				aNfItem[nItem][IT_CODNTRE] := SD2->D2_CNATREC
				aNfItem[nItem][IT_GRPNTRE] := SD2->D2_GRUPONC
				aNfItem[nItem][IT_DATNTRE] := SD2->D2_DTFIMNT
			EndIf
		EndIf
	EndIf	
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Atualiza o preco unitario do item.³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If aNFitem[nItem][IT_TIPONF ]$"PIC" .And. (cPaisLoc == "BRA" .Or. aTES[TS_QTDZERO] == "1")
	aNfItem[nItem][IT_PRCUNI]  := aNfItem[nItem][IT_VALMERC]
Elseif aNFitem[nItem][IT_TIPONF ]$"DB" .And. cPaisLoc == "PAR" .And. aParSX6[MV_DESCSAI]=='1' .And. Alltrim(cFunName) == "MATA465N" .And. ( aNFitem[nItem][IT_DESCONTO] > 0 .OR.  aNFitem[nItem][IT_DESCTOT] > 0 ) .And. cCampo<>"IT_TES"
	aNFitem[nItem][IT_VALMERC] -= (aNFitem[nItem][IT_DESCONTO]+aNFitem[nItem][IT_DESCTOT])
	aNFitem[nItem][IT_PRCUNI]  := aNFitem[nItem][IT_VALMERC]/Max(aNFitem[nItem][IT_QUANT],1)
EndIf

Return Nil

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisVDescZF³ Autor ³ Edson Maricate      ³ Data ³08.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Executa o calculo do Valor do Desconto da ZF.               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpN1: Item.                                                ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisVDescZF(nItem)

Local nOldVlr  := aNfItem[nItem][IT_DESCZF]
Local nDifZFAmapa:= 0  
Local lConsumo := aTes[TS_CONSUMO] == "S"
Local lExecuta := .T.

If aNFCab[NF_TIPONF] $ "DB" .Or. aTes[TS_PODER3] == "D"
	If !Empty(aNFItem[nItem][IT_RECORI])
		If aNFCab[NF_TIPONF] $ "DB"
			If aNFCab[NF_CLIFOR] == "C"
				dbSelectArea("SD2")
				MsGoto(aNFItem[nItem][IT_RECORI])
				If SD2->D2_DESCZFR > 0
					aNfItem[nItem][IT_DESCZF]:=(((aNfItem[nItem][IT_BASEICM] / (1-(SD2->D2_PICM/100)) ) * SD2->D2_PICM ) / 100 )
				EndIf
				lExecuta := .F.
			EndIf
		EndIf
	EndIf
EndIf

If lExecuta
	
	If aTes[TS_CONSUMO] == " " // Garante se o produto na operacao eh material de consumo mesmo que na TES nao tenha sido informado
		If (aTes[TS_INCIDE] == "S" .Or. (aTes[TS_INCIDE] == "F" .And. aNFCab[NF_TPCLIFOR] == "F" .And. aNFCab[NF_CLIFOR] == "C" )) .And.;
			( Substr(aNfItem[nItem][IT_CF],2,3)$"91 /92 /97 " .Or. (Substr(aNfItem[nItem][IT_CF],2,2) $ "55" .And. Substr(aNfItem[nItem][IT_CF],4,1)<>" ")) .And. aTes[TS_IPI] <> "R"
			lConsumo := .T.
		Endif
	EndIf
	
	If aNfCab[NF_CLIFOR] == "C" .And. aNfCab[NF_SUFRAMA] .And. !aNFitem[nItem][IT_TIPONF ] $ "BD" .And. !aNfCab[NF_LINSCR] .And. ;
		aNfItem[nItem][IT_PRD][SB_IMPZFRC] $ " N" .And. aTes[TS_ISS] <> "S" .And. aTes[TS_ICM] == "S" .And. !lConsumo .And. aParSX6[MV_DESCZF] .And.;
		( aNfCab[NF_OPERNF] == "S" .And. aNfCab[NF_TPCLIFOR] <> "F" ) .And. aNfCab[NF_CNPJ] <> SM0->M0_CGC		
		aNfItem[nItem][IT_DESCZF]  := NoRound(aNfItem[nItem][IT_VALICM],2) 
		If aNfCab[NF_UFDEST] == "AP" .And. aTes[TS_BASEICM] > 0
		  nDifZFAmapa := ( aNfItem[nItem][IT_BICMORI] * ( aNfItem[nItem][IT_ALIQICM] / 100 ) ) - aNfItem[nItem][IT_DESCZF]
	    EndIf 		
		MaItArred(nItem,{"IT_DESCZF"})
		aNfItem[nItem][IT_BASEICM] := 0
		aNfItem[nItem][IT_VALICM]  := 0
	
		If aNfCab[NF_ROTINA] == "MATA461" .Or. FunName() == "MATA920"
			aNfItem[nItem][IT_VALMERC] -= ( aNfItem[nItem][IT_DESCZF] + nDifZFAmapa) -  nOldVlr 
			If aNfCab[NF_TIPONF] $ "CPI" .And. FunName() == "MATA920"
				aNfItem[nItem][IT_PRCUNI]:= ( aNfItem[nItem][IT_VALMERC] - (aNfItem[nItem][IT_DESCONTO]+ aNfItem[nItem][IT_DESCTOT]) )
			Else
				aNfItem[nItem][IT_PRCUNI]:= ( aNfItem[nItem][IT_VALMERC] - (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT]) ) / aNfItem[nItem][IT_QUANT]
			EndIf
		EndIf
	
	Else

		aNfItem[nItem][IT_DESCZF] := 0        

	EndIf

	aNfItem[nItem][IT_DESCZFPIS] := 0
	aNfItem[nItem][IT_DESCZFCOF] := 0

EndIf

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³ MaFisVTot³ Autor ³ Edson Maricate        ³ Data ³13.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Atualiza os valores totais do item                         ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisVTot(nItem)

Local alAreaX   := {}
Local alAreaY   := {}
Local nImp      := 0
Local nValImp   := 0
Local nImposto  := 0
Local lDescInc  := (cPaisLoc<>"BRA".And.aNfCab[NF_OPERNF]=="S".And. aParSX6[MV_DESCSAI]=='1')
Local nAgrPisPas:= IIf( aTes[TS_AGRPIS] == "1" .And. aTes[TS_PSCFST]  <> "1" , aNfItem[nItem,IT_VALPS2] , 0 ) + IIf( aTes[TS_AGRCOF] == "1" .And. aTes[TS_PSCFST] <> "1" , aNfItem[nItem,IT_VALCF2] , 0 )
Local nPisCofST := IIf( aTes[TS_PSCFST] == "1" .And. aTes[TS_APSCFST] == "1" , aNfItem[nItem,IT_VALPS3] + aNfItem[nItem,IT_VALCF3] , 0 ) // Pis/Cofins ST - sera somado ao total do documento
Local nFretAut  := IIf( !aParSX6[MV_FRETAUT] , 0 , aNfItem[nItem][IT_VALICA] )

If cPaisLoc == "MEX"
	cFunName := Iif(Type("cFunName")=="U",Upper(AllTrim(FunName())),cFunName)
	If Alltrim(cFunName) == "MATA465N" .And. aParSX6[MV_DESCDVI] == .F. .And. aParSX6[MV_DESCSAI] == "1"
		lDescInc:=.T.
	EndIf
EndIf

Do Case
Case aNFitem[nItem][IT_TIPONF ] == "P"
	aNfItem[nItem][IT_TOTAL]	:= aNfItem[nItem][IT_FRETE] + IIf(aTes[TS_DESPICM] == "3",0,aNfItem[nItem][IT_DESPESA]) + IIf(aTes[TS_DESPICM] == "3",0,aNfItem[nItem][IT_SEGURO])+;
		aNfItem[nItem][IT_VALIPI]+IIf(aTes[TS_INCSOL]$"A,N,D",0,aNfItem[nItem][IT_VALSOL])+;
		aNfItem[nItem][IT_VALEMB]+nFretAut+nAgrPisPas+nPisCofST+;
		aNfItem[nItem][IT_DESNTRB]+aNfItem[nItem][IT_TARA]
OtherWise
	Do Case
	Case aTes[TS_AGREG] == "N"
		aNfItem[nItem][IT_TOTAL]	:= aNfItem[nItem][IT_FRETE] + IIf(aTes[TS_DESPICM] == "3",0,aNfItem[nItem][IT_DESPESA]) + IIf(aTes[TS_DESPICM] == "3",0,aNfItem[nItem][IT_SEGURO])+;
			IIf(aTes[TS_IPI] == 'R',0,aNfItem[nItem][IT_VALIPI]) + IIf(aTes[TS_INCSOL]$"A,N,D",0,aNfItem[nItem][IT_VALSOL])+;
			aNfItem[nItem][IT_VALEMB]+nAgrPisPas+nPisCofST+;
			aNfItem[nItem][IT_DESNTRB]+aNfItem[nItem][IT_TARA]
		aNfItem[nItem][IT_VNAGREG] := aNfItem[nItem][IT_VALMERC]-(aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT])
	Case aTes[TS_AGREG] == "I" .Or. aTes[TS_AGREG] == "B"
		aNfItem[nItem][IT_TOTAL]	:= aNfItem[nItem][IT_VALMERC] + aNfItem[nItem][IT_FRETE] + IIf(aTes[TS_DESPICM] == "3",0,aNfItem[nItem][IT_DESPESA]) + IIf(aTes[TS_DESPICM] == "3",0,aNfItem[nItem][IT_SEGURO])+;
			IIf(aTes[TS_IPI] == 'R',0,aNfItem[nItem][IT_VALIPI])+ IIf(aTes[TS_INCSOL]$"A,N,D".And.aTes[TS_ICM]<>"N",0,aNfItem[nItem][IT_VALSOL]) - IIf(lDescInc,0,(aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT]))+;
			If(aNFitem[nItem][IT_TIPONF ]<>"I",aNfItem[nItem][IT_VALICM],0) + aNfItem[nItem][IT_VALEMB]+nFretAut+nAgrPisPas+nPisCofST+;
			aNfItem[nItem][IT_DESNTRB]+aNfItem[nItem][IT_TARA]
			aNfItem[nItem][IT_VNAGREG] := 0
			If	(AllTrim(aNFCab[NF_ESPECIE]) $ "CTR/CTE" .Or. "NFST"$AllTrim(aNFCab[NF_ESPECIE]))
				If aTes[TS_CRPRST] <> 0  .And. !(aTes[TS_INCSOL] $ "A,N,D" .And. aTes[TS_ICM] <> "N")
					aNfItem[nItem][IT_TOTAL] += 	(aNfItem[nItem][IT_VLCSOL] - aNfItem[nItem][IT_VALSOL])
				EndIf
			EndIf

	OtherWise
			aNfItem[nItem][IT_TOTAL]	:= aNfItem[nItem][IT_VALMERC] + aNfItem[nItem][IT_FRETE] + ;
			IIf(aTes[TS_DESPICM] == "3" .Or. aTes[TS_DESPICM] == "4" , 0 , aNfItem[nItem][IT_DESPESA] ) + ;
			IIf(aTes[TS_DESPICM] == "3", 0 , aNfItem[nItem][IT_SEGURO] ) +;
			IIf(aTes[TS_IPI] == 'R', 0 , aNfItem[nItem][IT_VALIPI]) + ;
			IIf(aTes[TS_INCSOL]$"A,N,D" , 0 ,aNfItem[nItem][IT_VALSOL] ) + ;
			IIf((aNFitem[nItem][IT_TIPONF ]$"DB" .And. cPaisLoc =="PAR" .And. aParSX6[MV_DESCSAI] == "1" ), (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT]) , 0 ) - ;
			IIf(lDescInc , 0 , (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT]))+;
			aNfItem[nItem][IT_VALEMB]+nFretAut + nAgrPisPas + nPisCofST+;
			aNfItem[nItem][IT_DESNTRB]+aNfItem[nItem][IT_TARA]
			
			//Indica se o valor da deducao sera agregado ao Total da NF ou nao, em conj TS_AGREG = D
			//Conforme Anexo IV, item 8 letra B e item B5 do RICMS MG           					 
			//TS_AGRDRED = "1" - Agrega o valor da deducao 					 					 
			//TS_AGRDRED = "2" - Abate o valor da deducao, como ja era feito antes da implementacao 
			If aTes[TS_AGREG]$"DR" .And. aTes[TS_AGRDRED]=="1"
				aNfItem[nItem][IT_TOTAL]	+= IIf(Empty(aNfItem[nItem][IT_RECORI]) .Or. aTes[TS_AGREG]$"D" , aNfItem[nItem][IT_DEDICM] , 0 )
			ElseIf aTes[TS_AGREG]$"DR" .And. (aTes[TS_AGRDRED]=="2" .Or. Empty(aTes[TS_AGRDRED]))
				aNfItem[nItem][IT_TOTAL]	-= IIf(Empty(aNfItem[nItem][IT_RECORI]) .Or. aTes[TS_AGREG]$"D" , aNfItem[nItem][IT_DEDICM] , 0 )
			EndIf

			aNfItem[nItem][IT_VNAGREG] := 0
	EndCase
EndCase

//Adiantamento - Mexico
If cPaisLoc == "MEX" .And. aFieldPos[FP_D2_VALADI]
	aNfItem[nItem][IT_TOTAL] -= aNfItem[nItem][IT_ADIANT]
EndIf

//Adiantamento - Peru
If cPaisLoc == "PER" .and. SF1->(FieldPos("F1_ADIANT")) > 0
	aNfItem[nItem][IT_TOTAL] -= aNfItem[nItem][IT_ADIANTTOT]
EndIf


aNfItem[nItem][IT_TOTAL] += Iif(aTes[TS_AGRPIS] == "P" , aNFitem[nItem][IT_VALPS2] , 0 ) + Iif(aTes[TS_AGRCOF]=="C",aNFitem[nItem][IT_VALCF2],0)
aNfItem[nItem][IT_TOTAL] -= Iif(aTes[TS_AGRPIS] == "D" , aNFitem[nItem][IT_VALPS2] , 0 ) + Iif(aTes[TS_AGRCOF]=="D",aNFitem[nItem][IT_VALCF2],0)

If aTes[TS_AGRPIS]=="P" .And. aTes[TS_AGRCOF]=="C" .And. (aTes[TS_AGREG]=="I" .Or. aTes[TS_AGREG]=="A") .And. !aTes[TS_INTBSIC]$"123"
	If Abs( NoRound(aNfItem[nItem][IT_BASEICM],2) - NoRound(aNfItem[nItem][IT_TOTAL],2) ) == 0.01
		aNfItem[nItem][IT_TOTAL] := aNfItem[nItem][IT_BASEICM]
	EndIf
EndIf
//ICMS Diferido Incentivo abate de gado - o valor diferido sera somado ao total da NF e a duplicata
If aTES[TS_PICMDIF]<>0 .And. aTes[TS_ICMSDIF]=="4"
	aNfItem[nItem][IT_TOTAL] += aNfItem[nItem][IT_ICMSDIF]
EndIf

//Decreto nro 43.080/02	
If aNfItem[nItem][IT_BSSEMDS] > 0
   	aNfItem[nItem][IT_TOTAL] -= ( aNfItem[nItem][IT_ICSEMDS] - aNfItem[nItem][IT_VALICM] )
EndIf

aNfItem[nItem][IT_BASEDUP] := 0

If aTes[TS_DUPLIC] <>"N"
	aNfItem[nItem][IT_BASEDUP] := aNfItem[nItem][IT_TOTAL]
	If aParSX6[MV_DPAGREG] .And. aTes[TS_AGREG] == "N"
		aNfItem[nItem][IT_BASEDUP] += aNfItem[nItem][IT_VALMERC]
	EndIf
	If aTes[TS_AGREG]=="G"
		aNfItem[nItem][IT_BASEDUP] += aNfItem[nItem][IT_VALICM] - aNfItem[nItem][IT_BASEDUP]
		If aTes[TS_OPERSUC]=="1" .And. nAgrPisPas > 0
			aNfItem[nItem][IT_BASEDUP] -= ((nAgrPisPas * aNfItem[nItem][IT_ALIQICM]) /100)
			aNfItem[nItem][IT_BASEDUP] += nAgrPisPas
		Endif
	EndIf
	If aTes[TS_AGREG]=="H"
		aNfItem[nItem][IT_BASEDUP] += (aNfItem[nItem][IT_VALSOL]+aNfItem[nItem][IT_VALIPI]) - aNfItem[nItem][IT_BASEDUP]
	EndIf
	If aTes[TS_AGREG]=="F"
		aNfItem[nItem][IT_BASEDUP] -= aNfItem[nItem][IT_VALMERC]
	EndIf
	If aNFitem[nItem][IT_TIPONF ]=='I'
		aNfItem[nItem][IT_BASEDUP]	-= aNfItem[nItem][IT_VALICM]
	EndIf
	If aTES[TS_PICMDIF]<>0 .And. aTes[TS_ICMSDIF]$" ,1,2" .And. aTES[TS_ICM] == "S"
		MaItArred(nItem, { "IT_ICMSDIF" } )
		aNfItem[nItem][IT_BASEDUP]	-= aNfItem[nItem][IT_ICMSDIF]
	EndIf
	If (aNfCab[NF_RECISS]=="1".And. aParSX6[MV_DESCISS] .And. aNfCab[NF_OPERNF]=="S".And. aParSX6[MV_TPABISS]=="1")
	   	If (aNfItem[nItem][IT_VALISS] > aParSX6[MV_VRETISS]) .OR.;
		   aTes[TS_FRETISS] == "2" .And. IIF(aFieldPos[FP_A1_FRETISS],IIF(aNfCab[NF_FRETISS] == "2",.T.,.F.),.F.)	
		aNfItem[nItem][IT_BASEDUP]	-= aNfItem[nItem][IT_VALISS]
	  	EndIf    
	EndIf
	If aTes[TS_INCSOL]=="D"
		aNfItem[nItem][IT_BASEDUP]	-= aNfItem[nItem][IT_VALSOL]
	EndIf
	If aTes[TS_AGREG]=="E"
		aNfItem[nItem][IT_BASEDUP]	-= aNfItem[nItem][IT_DEDICM]
	EndIf
	
	//Fundersul - sera reduzido do total da duplicata
	If cPaisLoc =="BRA" .And.  aTes[TS_CLFDSUL] == "1"
		aNfItem[nItem][IT_BASEDUP]	-= aNfItem[nItem][IT_VALFDS]
	Endif
	
	//³Tratamento efetuado atraves da FNC 00000002498/2012                                                  ³
	//³Pois o sistema subtraia o valor do SENAR do titulo principal, e ao processar a apuração de ICMS      ³
	//³eh possível verificar que ele novamente aparece e com Gera Guia/Gera titulo = Sim, eh gerado o valor ³
	//³para pagamento no contas a pagar.                                                                    ³
	//³Foi realizado tratamento para a FNC 00000011912/2012 onde o abatimento do SENAR deve ser feito apenas³
	//³quando se tratar de uma venda de Produtor Rural para Industria, onde o imposto sera pago pelo cliente³
	//³e atraves da Apuracao de ICMS sera gerado um titulo no contas a pagar do SENAR para o produtor Rural ³
	
	If (cPaisLoc =="BRA" .And. aTes[TS_ALSENAR] > 0 .And. SM0->M0_PRODRUR$"FLJ123") .And. (!(aNfCab[NF_TPCLIFOR]$"FX"))
		aNfItem[nItem][IT_BASEDUP]	-= aNfItem[nItem][IT_VLSENAR]
	Endif
	
	If cPaisLoc =="BRA" .And.  aNfItem[nItem][IT_VLINCMG] > 0
		aNfItem[nItem][IT_BASEDUP]	+= aNfItem[nItem][IT_VLINCMG]
	Endif
	
Else
	//O F4_DUPLIST e utilizado para gerar um titulo somente com o valor
	//do ICMS-ST e foi implementado no MATA461 para NF de Remessa na
	//saida, aqui foi implemntado para notas fiscais de entrada respeitan
	//do o mesmo conceito utilizado na saida de gerar o titulo somente se
	//Gera Duplicatas F4_DUPLIC estiver = NAO
	If aNfCab[NF_OPERNF] == "E" .And. aTes[TS_DUPLIST] == "1"
		aNfItem[nItem][IT_BASEDUP] += aNfItem[nItem][IT_VALSOL]
	EndIf
EndIf
// Verifica se a TES possui tratamento para Impostos Variaveis
If !Empty(aTes[TS_SFC])
	For nImposto := 1 to Len(aTes[TS_SFC])
		nImp := NumCpoImpVar(RIGHT(Alltrim(aTes[TS_SFC][nImposto][SFB_CPOVREI]),1))
		If  aTes[TS_DUPLIC] <> "N" .And. aNFitem[nItem][IT_TIPONF ]<>'B'
			Do Case
				Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="1"
					nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
				Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="2"
					nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
				Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="3"
					nValImp:=0
			EndCase
			aNfItem[nItem][IT_BASEDUP] += nValImp
		Endif
		
		Do Case
			Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="1"
				nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
			Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="2"
				nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
			Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="3"
				nValImp:=0
		EndCase
		aNfItem[nItem][IT_TOTAL] += nValImp
	Next nImposto
EndIf

//          TRATAMENTO EXPECIFICO PARA LOCALIZADO PERU
// Quando o cálculo do ISC for por unidade, ou seja, se houver
// alguma exceção fiscal,  o valor do campo especifico FF_VLRISC > 0
// é gravado no campo customizado D1_VLRISC ou D2_VLRISC.
// Se não houver nenhuma exceção fiscal, mas no produto o valor do
// campo especíco B1_VLRISC  > 0 então no campo especifico D1_VLRISC
// ou D2_VLRISC é gravado o seu valor.
// Caso não seja nenhuma das opções anteriores o valor do campo é ze-
// rado.

If cPaisLoc $ "PER"
	alAreaX := SFC->(GetArea())
	alAreaY := SFF->(GetArea())
	aNfItem[nItem][IT_VLRISC] := 0
	SFC->(DbSetOrder(2))
	If SFC->(MsSeek(xFilial("SFC")+aNfItem[nItem][IT_TES]+"ISC"))
		SFF->(DbSetOrder(3))
		If SFF->(MsSeek(xFilial("SFF")+SFC->FC_IMPOSTO)) .And. SFF->FF_VLRISC > 0
			aNfItem[nItem][IT_VLRISC] := SFF->FF_VLRISC
		EndIf
		If aNfItem[nItem][IT_VLRISC] = 0 .And. aNfItem[nItem][IT_PRD][SB_VLRISC] > 0
			aNfItem[nItem][IT_VLRISC] := aNfItem[nItem][IT_PRD][SB_VLRISC]
		EndIf
	EndIf
	RestArea(alAreaX)
	RestArea(alAreaY)
EndIf

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³ MaFisCFO ³ Autor ³ Edson Maricate        ³ Data ³13.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Processa o Codigo Fiscal do item especificado               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ExpC1 := MaFisCFO(ExpN1,ExpC2,[ExpA1])                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1: Item                                                 ³±±
±±³          ³ExpC2: Codigo Fiscal Original ( Opcional )                  ³±±
±±³          ³ExpA1: Array de parametros opcional a ser enviado quando    ³±±
±±³          ³a funcao e chamada de fora da matxfis. Estrutura:           ³±±
±±³          ³  1 - Identificador do parametro ( mnemonico )              ³±±
±±³          ³  2 - Conteudo                                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpC1: Codigo Fiscal de Operacao                            ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisCFO(nItem,cAuxCF,aDados)

Local cCfo	    := IIf( cAuxCF == Nil , aTes[TS_CF] , cAuxCF )
Local cRetCF    := ""
Local cOperNf   := ""
Local cTpCliFor := ""
Local cMVEstado	:= ""
Local cUfOrigem := ""
Local cUfDest   := ""
Local cTpComp   := ""
Local cInscri   := ""
Local cRestoCfo := ""
Local cContr	:= ""
Local cConvCfo	:= ""
Local lInscrito := .T.
Local lUsaCfps	:= .F.
Local nX        := 0
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Ao utilizar o Protheus com varias Filiais e possivel que em alguns processos como o de inclusao de Notas Fiscais o usuario altere  ³
//³ a filial atraves da Dialog de seleçao de filiais, com isso se faz necessario que os parametros SX6 sejam novamente carregados para ³
//³ a filial corrente refazendo o cache realizado na variavel aParSX6, esta nova carga e controlada pela variavel cSX6FilAnt           ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If cSX6FilAnt <> cFilAnt
	aParSX6 := GParMxFis()
EndIf

cMVEstado := aParSX6[MV_ESTADO]
cUfOrigem := cMVEstado
lUsaCfps  := aParSX6[MV_USACFPS]
cConvCfo  := aParSX6[MV_CONVCFO]

If cCfo == "99943" //-- CFOP TMS
	cCodCli := aNfCab[NF_CODCLIFOR]
	cLojCli := aNfCab[NF_LOJA]
	cSegCli := Posicione("SA1",1,xFilial("SA1")+cCodCli+cLojCli,"A1_SATIV1")
	If !Empty(cSegCli)
		cCfo := Posicione("DY5",2,xFilial("DY5")+cSegCli,"DY5_CF")
	EndIf
EndIf

If ValType( aDados ) == "A"
	cUfOrigem := cMVEstado
	cUfDest   := cMVEstado 
 	
	For nX := 1 To Len(aDados)
		Do Case
			Case aDados[nX, 1] == "OPERNF"
				cOperNF   := aDados[nX, 2]
			Case aDados[nX, 1] == "TPCLIFOR"
				cTpCliFor := aDados[nX, 2]
			Case aDados[nX, 1] == "UFORIGEM"
				cUfOrigem := aDados[nX, 2]
			Case aDados[nX, 1] == "UFDEST"
				cUfDest   := aDados[nX, 2]
			Case aDados[nX, 1] == "TPCOMP"
				cTpComp   := aDados[nX, 2]
			Case aDados[nX, 1] == "INSCR"
				cInscri   := aDados[nX, 2]
				lInscrito := !(Empty(cInscri).Or."ISENT" $ cInscri)
			Case aDados[nX, 1] == "CONTR"
				cContr    := aDados[nX, 2]
		EndCase
	Next nX
	If Len(aDados)> 5
		If SF4->F4_VENPRES == "1" .And. aDados[2][2] == "F" .And. aDados[1][2] == "S" .And. aDados[6][2] == "S" 
			cUfDest := cUfOrigem
		EndIf 
	EndIf
	
	//Verifica a indicacao de contribuinte ou nao do ICMS pelo cadastro do Cliente
	If !Empty(cContr)
		// Contribuinte
		If cContr == "1"
			lInscrito := .T.
			// Nao Contribuinte
		ElseIf cContr == "2"
			lInscrito := .F.
		Endif
	Endif
Else
	If aNFCab[NF_TIPONF] <> "B"
		cUfOrigem := aNfCab[NF_UFORIGEM]
	Else
		If (aTes[TS_PODER3] == "D" .Or. aTes[TS_PODER3] == "R" .Or. aTes[TS_PODER3] == "N") .And. aNfCab[NF_OPERNF] == "E"
			cUfOrigem := aNfCab[NF_UFORIGEM]
		EndiF
	EndIf
	cOperNf  := aNfCab[NF_OPERNF]
	cTpCliFor:= aNfCab[NF_TPCLIFOR]
	cUfDest  := aNfCab[NF_UFDEST]
	cTpComp  := aNfCab[NF_TPCOMP]
	lInscrito:= !aNfCab[NF_LINSCR]
EndIf

cRestoCfo := SubStr(cCfo,2,Len(cCfo)-1)

IF aTes[TS_VENPRES] == "1" .And. aNfCab[NF_TPCLIFOR] == "F" .And. aNfCab[NF_OPERNF] == "S" .And. aNfCab[NF_TPFRETE] == "S"
	aNfCab[NF_UFDEST] := aNfCab[NF_UFORIGEM]  
	cUfDest := cUfOrigem
EndIf    
If cPaisLoc == "BRA"
	If SubStr(cCfo,1,3) == "999" .Or. SubStr(cCfo,1,3) == "000" .Or. SubStr(cCfo,1,4) $ "1601#1602#5601#5602"
		cRetCF := cCfo
	Else
		If cOperNf == "E"
			If cUfOrigem == "EX" .Or. cTpCliFor == "X"
				cRetCF := "3"
			Else
				If cUfOrigem == cMVEstado
					cRetCF := "1"
				Else
					cRetCF := "2"
				EndIf
			EndIf
		Else
			If Iif(nModulo <> 43, cUfDest == cUfOrigem .And. cTpCliFor <> "X", cUfDest == cUfOrigem)
				cRetCF := "5"
				If cConvCfo == "1"
					// Caso seja operacao com consumidor final troca a terminacao
					// do CFOP
					If (cTpCliFor == "F" .Or. !lInscrito) .And. AllTrim( cRestoCfo ) == "655"
						cRestoCfo := "656" + Space( Len( cRestoCfo ) - 3 )
					EndIf
					If (cTpCliFor == "F" .Or. !lInscrito) .And. AllTrim( cRestoCfo ) == "107"
						cRestoCfo := "101" + Space( Len( cRestoCfo ) - 3 )
					EndIf
					If (cTpCliFor == "F" .Or. !lInscrito) .And. AllTrim( cRestoCfo ) == "108"
						cRestoCfo := "102" + Space( Len( cRestoCfo ) - 3 )
					EndIf
				EndIf
			ElseIf (cUfDest <> "EX" .And. cTpCliFor == "X") .Or. cTpCliFor <> "X"
				// Conversao do CFO interestadual
				cRetCF := "6"
				If cConvCfo == "1"
					If !lInscrito
						If AllTrim( cRestoCfo ) == "102"
							// Caso seja operacao interestadual para nao inscritos
							// altera o final do CFO de 102 para 108
							cRestoCfo := "108" + Space( Len( cRestoCfo ) - 3 )
						ElseIf AllTrim( cRestoCfo ) == "101"
							// Caso seja operacao interestadual para nao inscritos
							// altera o final do CFO de 101 para 107
							cRestoCfo := "107" + Space( Len( cRestoCfo ) - 3 )
						ElseIf AllTrim( cRestoCfo ) == "106"
							// Caso seja operacao interestadual para nao inscritos
							// altera o final do CFO de 106 para 108
							cRestoCfo := "108" + Space( Len( cRestoCfo ) - 3 )
						EndIf
					EndIf
					// Caso seja operacao com consumidor final troca a terminacao
					// do CFOP
					If (cTpCliFor == "F" .Or. !lInscrito) .And. AllTrim( cRestoCfo ) == "655"
						cRestoCfo := "656" + Space( Len( cRestoCfo ) - 3 )
					EndIf
				EndIf
			Else
				cRetCF := "7"
			EndIf
		EndIf
		// Tratamento para Complemento de Frete
		If cTpComp == "F" .And. cConvCfo=="1"
			cRetCF += IIf(SubStr(cCfo,2,3)$"931/932/933/949/351/352/353/354/355/356/360",SubStr(cCfo,2,3),"352")
		Else
			cRetCF += cRestoCfo
		EndIf
	EndIf
	// Ajuste do CFO para fora do estado quando for 4 digitos
	If Left(cRetCf,4) == "6405" .And. cConvCfo == "1"
		cRetCf := "6404"+SubStr(cRetCf,5)
	EndIf
	If lUsaCfps .And. Left(LTrim(cCfo),1)=="9"
		cRetCf := "9"+cRestoCfo
	EndIf
	// Verifica os CFOPS de Importacao e Exportacao.
	If SubStr(cRetCF,1,2) == "79"
		SX5->(dbSetOrder(1))
		If !SX5->(MsSeek(xFilial("SX5")+"13"+cRetCF))
			cRetCf := "7949"
		EndIf
	EndIf
	
Else
	cRetCF:=Alltrim(cCfo)
EndIf

If ValType( aDados ) <> "A"
	aNfItem[nItem][IT_CF] := PadR(cRetCF,Len(SF4->F4_CF))
Endif

Return ( cRetCF )

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaExcecao ³ Autor ³Eduardo/Edson          ³ Data ³09.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Calculo das Excecoes fiscais                                ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaExcecao( nItem , cCampo )

Local aArea	     := GetArea()
Local aAreaSF7   := SF7->(GetArea())
Local aExcecao   := {}
Local aExceFat	 := {}
Local cGRTrib    := ""
Local cUfOriDes  := ""
Local cChave     := ""
Local cHistSF7   := ""
Local cAls		 := "SF7"
Local cOrigem	 := ""
Local cSiTrib	 := ""
Local nScan      := 0 
Local lAchouSS1  := .F.
Local lClasFis	 := Len( Alltrim( aNfItem[nItem][IT_CLASFIS] ) ) == 3
Local bCompareF7 := Nil
Default cCampo	:=	""

// Estrutura do Array aExcecao
// [01] - Aliq. de ICMS Interna
// [02] - Aliq. de ICMS Externa
// [03] - Margem de Lucro Presumida
// [04] - Grupo de Tributacao
// [05] - "S"
// [06] - Aliq. de ICMS Destino
// [07] - Refere-se ao ISS "S/N"
// [08] - Valor do Solidario de Pauta
// [09] - Valor do IPI de Pauta
// [10] - Valor do PIS
// [11] - Valor Cofins
// [12] - Aliquota do PIS
// [13] - Aliquota do Cofins                           
// [14] - Reducao da base de calculo do ICMS 
// [15] - Reducao da base de calculo do IPI 
// [16] - Icms Pauta
// [17] - Aliquota de IPI
// [18] - Reducao da base de calculo do PIS
// [19] - Reducao da base de calculo da COFINS
// [20] - Pauta Produto "S/N"      
// [21] - Tab. Natureza da Receita 	
// [22] - Codigo Natureza da Receita
// [23] - Grupo Natureza da Receita
// [24] - Data Final Nat. Receita
// [25] - Preço Unitário de Cigarro para cálculo da Substituição tributária de Cigarros para PIS e COFINS
// [26] - Reducao da base de calculo do ICMS ST 
// [27] - ID do Historico das alteracoes
// [28] - Codigo de Origem
// [29] - Codigo de Situacao Tributaria

If Empty( cGrTrib := aNFItem[nItem,IT_GRPTRIB] ) 
	cGrTrib := PadR( aNfItem[nItem][IT_PRD][SB_GRTRIB] ,Len(SF7->F7_GRTRIB))
EndIf 	

If !Empty(cGRTrib)
    
    If aFieldPos[FP_F7_ORIGEM] .And. aFieldPos[FP_F7_SITTRIB]
    	
    	/* --------------------------------------------------------------------------
		   O trecho abaixo foi copiado da funcao MaFisPreCalc(), pois as pilhas de recalculo possuem a chamada da MaExcecao() antes
		   da MaFisPreCalc() - onde eh definida a Classificacao Fiscal. Por este motivo, preciso garantir que a informacao do
		   IT_CLASFIS esteja correta para utilizar nas comparacoes da Excecao Fiscal.
		   Essa alteracao foi feita para que nao se faca necessario alterar todas as pilhas de recalculo, considerando a chamada da
		   MaFisPreCalc() antes da MaExcecao(). Essa mudanca sera feita na re-estruturacao das pilhas da MATXFIS.
		   --------------------------------------------------------------------------- */
    	If  cCampo $ "IT_PRODUTO/IT_TES" .Or. !lClasFis
			If aParSX6[MV_STFRETE] .And. ( AllTrim( aNFCab[NF_ESPECIE] ) $ "CTR/CTE/CTA/CTF" .Or. "NFST"$AllTrim( aNFCab[NF_ESPECIE] ) )
				aNfitem[nItem][IT_CLASFIS] := "0" + aTes[TS_SITTRIB]
			Else
				aNfitem[nItem][IT_CLASFIS] := aNfItem[nItem][IT_PRD][SB_ORIGEM] + aTes[TS_SITTRIB]
			EndIf
		Endif
    
		/* --------------------------------------------------------------------------
		   Verifico a necessidade de utilizar os codigos de origem e situacao tributaria
		   na comparacao junto ao Grupo Tributario, e que a cada item ocorra essa
		   verificacao para consistir a utilizacao do correto registro da SF7 
		   --------------------------------------------------------------------------- */
		cOrigem		:= Iif( lClasFis , SubStr(aNfItem[nItem][IT_CLASFIS],1,1) , aNfItem[nItem][IT_PRD][SB_ORIGEM] )
		cSitTrib	:= Iif( lClasFis , SubStr(aNfItem[nItem][IT_CLASFIS],2,2) , aTes[TS_SITTRIB] )
		
	
		bCompareF7	:= {|x| !Empty(x[IT_EXCECAO]) .And. x[IT_EXCECAO,4]+x[IT_EXCECAO,28]+x[IT_EXCECAO,29] == cGRTrib+cOrigem+cSitTrib }
	Else
		bCompareF7	:= {|x| !Empty(x[IT_EXCECAO]) .And. x[IT_EXCECAO,4]==cGRTrib}
	Endif
 
	nScan := aScan( aNfItem , bCompareF7 )
	If nScan == 0 
		dbSelectArea("SF7")
		SF7->(dbSetOrder(1))
		SF7->(MsSeek(xFilial("SF7")+avKey(cGRTrib,"F7_GRTRIB")+avKey(aNFCab[NF_GRPCLI],"F7_GRPCLI")))
		cChave := "SF7->F7_FILIAL == xFilial('SF7') .AND. SF7->F7_GRTRIB == '" + cGRTrib + "' .AND. SF7->F7_GRPCLI == '"+aNFCab[NF_GRPCLI] + "'" 
			
		If lHistorico
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Se for reprocessamento,  e tiver habilitado para buscar os Historico Fiscais,      ³
			//³verifico se o ID do historico da Excecao e igual ao que foi gravado na Nota. Se for³
			//³igual é porque nao teve alterações na Excecao após a emissão. Se for diferente,    ³
			//³é porque teve alterações no cadastro, e entao os dados são carregados da tabela de ³
			//³Historico(SS1).                                                                    ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			
			If( aNfCab[NF_CLIFOR]=="C" .And. aNfCab[NF_TIPONF]<>"D") .Or.( aNfCab[NF_CLIFOR]=="F" .And. aNfCab[NF_TIPONF]$"D|B")
				cHistSF7 :=  (cAlsItem)->D2_IDSF7 
			Else
				cHistSF7 :=  (cAlsItem)->D1_IDSF7 
			End 
			
			If  Alltrim(SF7->F7_IDHIST) <> Alltrim(cHistSF7)
				dbSelectArea("SS1")
				dbSetOrder(1)
				MsSeek(xFilial("SS1")+cHistSF7+avKey(cGRTrib,"S1_GRTRIB")+avKey(aNFCab[NF_GRPCLI],"F7_GRPCLI"))
				cAls   := "SS1"
				cChave := "SS1->S1_FILIAL == xFilial('SS1') .AND. SS1->S1_IDHIST == '" + cHistSF7  + "' .And. SS1->S1_GRTRIB == '" + cGRTrib + "' .AND. SS1->S1_GRPCLI == '" + aNFCab[NF_GRPCLI] + "'"
				lAchouSS1 := .T.
			EndIf
		EndIf
				
		cChave := &('{||'+cChave+'}')
		While !(cAls)->(Eof()) .AND. Eval(cChave)		

			If aFieldPos[FP_F7_UFBUSCA] .And. (aNfCab[NF_OPERNF] == "E" .Or. (aNfCab[NF_OPERNF] == "S" .And. aNFCab[NF_TIPONF] == "D"))
				cUfOriDes := IIf(IIf(lAchouSS1,  SS1->S1_UFBUSCA == "2", SF7->F7_UFBUSCA == "2") , aNFCab[NF_UFDEST] , aNFCab[NF_UFORIGEM] )
			ElseIf aFieldPos[FP_F7_UFBUSCA] .And. IntTms() .And. nModulo == 43 //SIGATMS
				cUfOriDes := IIf(IIf(lAchouSS1,  SS1->S1_UFBUSCA == "2", SF7->F7_UFBUSCA == "2"), aNFCab[NF_UFDEST] , aNFCab[NF_UFORIGEM])
			Else
				cUfOriDes := aNFCab[NF_UFORIGEM]
			EndIf
			
			/* ----------------------------------------------------------------------------------------------------
			   Abaixo eh feita a validacao dos campos utilizados como chave de combinacao da Excecao Fiscal
			   Campos utilizados:
			   	- F7_EST (conforme campo F7_UFBUSCA, a comparacao sera com Uf Destino ou Uf Origem)
			   	- F7_TIPOCLI (compara com o tipo do cliente definido pelos cadastros A1/A2)
			   	- F7_ORIGEM (origem do pruduto, que esta definida no primeiro caracter dos campos D1/D2_CLASFIS)
			   	- F7_SITTRIB(situacao tributaria do produto, que esta definida no segundo e terceiro caracter 
			   	  dos campos D1/D2_CLASFIS) 
			   --------------------------------------------------------------------------------------------------- */
			If	aNFCab[NF_TIPONF] == "D" .And.;
				IIf(lAchouSS1, ( cUfOriDes == SS1->S1_EST .Or. SS1->S1_EST == "**" ), ( cUfOriDes == SF7->F7_EST .Or. SF7->F7_EST == "**" )) .And.;
			 	IIf(lAchouSS1, ( aNfCab[NF_TPCLIFOR] == SS1->S1_TIPOCLI .Or. SS1->S1_TIPOCLI == "*" ), (aNfCab[NF_TPCLIFOR] == SF7->F7_TIPOCLI .Or. SF7->F7_TIPOCLI == "*" )) .And.;
				Iif(lAchouSS1 .And. aFieldPos[FP_S1_ORIGEM], ( cOrigem == SS1->S1_ORIGEM .Or. Empty(SS1->S1_ORIGEM) ) , Iif( aFieldPos[FP_F7_ORIGEM] , ( cOrigem == SF7->F7_ORIGEM .Or. Empty(SF7->F7_ORIGEM) ) , .T. ) ) .And.;
				Iif(lAchouSS1 .And. aFieldPos[FP_S1_SITTRIB], ( cSitTrib == SS1->S1_SITTRIB .Or. Empty(SS1->S1_SITTRIB) ) , Iif( aFieldPos[FP_F7_SITTRIB] , ( cSitTrib == SF7->F7_SITTRIB .Or. Empty(SF7->F7_SITTRIB) ) , .T. ) )
				
				aadd(aExcecao,IIf(lAchouSS1, SS1->S1_ALIQINT, SF7->F7_ALIQINT))
				aadd(aExcecao,IIf(lAchouSS1, SS1->S1_ALIQEXT, SF7->F7_ALIQEXT))
				aadd(aExcecao,IIf(lAchouSS1, SS1->S1_MARGEM, SF7->F7_MARGEM))
				aadd(aExcecao,IIf(lAchouSS1, SS1->S1_GRTRIB, SF7->F7_GRTRIB))
				aadd(aExcecao,"S")
				aadd(aExcecao,IIf(lAchouSS1, SS1->S1_ALIQDST, SF7->F7_ALIQDST))
				aadd(aExcecao,IIf(lAchouSS1, SS1->S1_ISS, SF7->F7_ISS))
				If cPaisLoc == "BRA"
					aadd(aExcecao,IIf(lAchouSS1, SS1->S1_VLR_ICM, SF7->F7_VLR_ICM))
					aadd(aExcecao,IIf(lAchouSS1, SS1->S1_VLR_IPI, SF7->F7_VLR_IPI))
					aadd(aExcecao,IIf(lAchouSS1, SS1->S1_VLR_PIS, SF7->F7_VLR_PIS))
					aadd(aExcecao,IIf(lAchouSS1, SS1->S1_VLR_COF, SF7->F7_VLR_COF))
					aadd(aExcecao,IIf(lAchouSS1, SS1->S1_ALIQPIS, SF7->F7_ALIQPIS))
					aadd(aExcecao,IIf(lAchouSS1, SS1->S1_ALIQCOF, SF7->F7_ALIQCOF))
					aadd(aExcecao,IIf(lAchouSS1, SS1->S1_BASEICM, SF7->F7_BASEICM))
					aadd(aExcecao,IIf(lAchouSS1, SS1->S1_BASEIPI, SF7->F7_BASEIPI))
					aadd(aExcecao,IIf(lAchouSS1, SS1->S1_VLRICMP, SF7->F7_VLRICMP))						
					aadd(aExcecao,IIf(lAchouSS1, SS1->S1_ALIQIPI, SF7->F7_ALIQIPI))
					aadd(aExcecao,IIf(lAchouSS1, SS1->S1_REDPIS,  SF7->F7_REDPIS))
					aadd(aExcecao,IIf(lAchouSS1, SS1->S1_REDCOF,  SF7->F7_REDCOF))
					aadd(aExcecao,IIf(lAchouSS1, SS1->S1_ICMPAUT, SF7->F7_ICMPAUT))
					aadd(aExcecao,Iif(aFieldPos[FP_F7_TNATREC], IIf(lAchouSS1, SS1->S1_TNATREC, SF7->F7_TNATREC),""))
					aadd(aExcecao,Iif(aFieldPos[FP_F7_CNATREC], IIf(lAchouSS1, SS1->S1_CNATREC, SF7->F7_CNATREC),""))      
					aadd(aExcecao,Iif(aFieldPos[FP_F7_GRUPONC], IIf(lAchouSS1, SS1->S1_GRUPONC, SF7->F7_GRUPONC),""))
					aadd(aExcecao,Iif(aFieldPos[FP_F7_DTFIMNT], IIf(lAchouSS1, SS1->S1_DTFIMNT, SF7->F7_DTFIMNT),CtoD("")))
					aadd(aExcecao,Iif(aFieldPos[FP_F7_PRCUNIC], IIf(lAchouSS1, SS1->S1_PRCUNIC, SF7->F7_PRCUNIC),0))
					aadd(aExcecao,Iif(aFieldPos[FP_F7_BSICMST], IIf(lAchouSS1, SS1->S1_BSICMST, SF7->F7_BSICMST),0))
					aadd(aExcecao,Iif(aFieldPos[FP_F7_IDHIST],  IIf(lAchouSS1, SS1->S1_IDHIST,  SF7->F7_IDHIST), ""))
					aadd(aExcecao,Iif(aFieldPos[FP_F7_ORIGEM],  IIf(lAchouSS1, SS1->S1_ORIGEM,  cOrigem ), ""))
					aadd(aExcecao,Iif(aFieldPos[FP_F7_SITTRIB], IIf(lAchouSS1, SS1->S1_SITTRIB, cSitTrib), ""))
				Else
					aadd(aExcecao,0)
					aadd(aExcecao,0)
					aadd(aExcecao,0)
					aadd(aExcecao,0)
					aadd(aExcecao,0)
					aadd(aExcecao,0)
					aadd(aExcecao,0)
					aadd(aExcecao,0)
					aadd(aExcecao,0)
					aadd(aExcecao,0)
					aadd(aExcecao,0)
					aadd(aExcecao,0)
					aadd(aExcecao,0)
					aadd(aExcecao,"")
					aadd(aExcecao,"")
					aadd(aExcecao,"")						
					aadd(aExcecao,CToD(""))
					aadd(aExcecao,0)
					aadd(aExcecao,0)					
 					aadd(aExcecao,"")
 					aadd(aExcecao,"")
 					aadd(aExcecao,"")						
				EndIf

			Else

				If aFieldPos[FP_F7_UFBUSCA] .And. aNfCab[NF_OPERNF] == "E"
					cUfOriDes := IIf(IIf(lAchouSS1,  SS1->S1_UFBUSCA == "2", SF7->F7_UFBUSCA == "2") , aNFCab[NF_UFORIGEM] , aNFCab[NF_UFDEST] )
				ElseIf aFieldPos[FP_F7_UFBUSCA] .And. IntTms() .And. nModulo == 43 //SIGATMS
					cUfOriDes := IIf(IIf(lAchouSS1,  SS1->S1_UFBUSCA == "2", SF7->F7_UFBUSCA == "2")  , aNFCab[NF_UFORIGEM] , aNFCab[NF_UFDEST] )
				Else
					cUfOriDes := aNFCab[NF_UFDEST]
				EndIf
				
				/* ----------------------------------------------------------------------------------------------------
				   Abaixo eh feita a validacao dos campos utilizados como chave de combinacao da Excecao Fiscal
				   Campos utilizados:
				   	- F7_EST (conforme campo F7_UFBUSCA, a comparacao sera com Uf Destino ou Uf Origem)
				   	- F7_TIPOCLI (compara com o tipo do cliente definido pelos cadastros A1/A2)
				   	- F7_ORIGEM (origem do pruduto, que esta definida no primeiro caracter dos campos D1/D2_CLASFIS)
				   	- F7_SITTRIB(situacao tributaria do produto, que esta definida no segundo e terceiro caracter 
				   	  dos campos D1/D2_CLASFIS) 
				   --------------------------------------------------------------------------------------------------- */
				If	aNFCab[NF_TIPONF] != "D" .And.;
					IIf(lAchouSS1, ( cUfOriDes == SS1->S1_EST .Or. SS1->S1_EST == "**"), ( cUfOriDes == SF7->F7_EST .Or. SF7->F7_EST == "**")) .And.;
					IIf(lAchouSS1, ( aNfCab[NF_TPCLIFOR] == SS1->S1_TIPOCLI .Or. SS1->S1_TIPOCLI == "*" ), (aNfCab[NF_TPCLIFOR] == SF7->F7_TIPOCLI .Or. SF7->F7_TIPOCLI == "*" )) .And.;
					Iif(lAchouSS1, ( cOrigem == SS1->S1_ORIGEM .Or. Empty(SS1->S1_ORIGEM) ) , Iif( aFieldPos[FP_F7_ORIGEM] , ( cOrigem == SF7->F7_ORIGEM .Or. Empty(SF7->F7_ORIGEM) ) , .T. ) ) .And.;
					Iif(lAchouSS1, ( cSitTrib == SS1->S1_SITTRIB .Or. Empty(SS1->S1_SITTRIB) ) , Iif( aFieldPos[FP_F7_SITTRIB] , ( cSitTrib == SF7->F7_SITTRIB .Or. Empty(SF7->F7_SITTRIB) ) , .T. ) )
				
					aadd(aExcecao, IIf(lAchouSS1, SS1->S1_ALIQINT, SF7->F7_ALIQINT))
 					aadd(aExcecao, IIf(lAchouSS1, SS1->S1_ALIQEXT, SF7->F7_ALIQEXT))
					aadd(aExcecao, IIf(lAchouSS1, SS1->S1_MARGEM, SF7->F7_MARGEM))
					aadd(aExcecao, IIf(lAchouSS1, SS1->S1_GRTRIB, SF7->F7_GRTRIB))
					aadd(aExcecao, "S")
					aadd(aExcecao, IIf(lAchouSS1, SS1->S1_ALIQDST, SF7->F7_ALIQDST))
					aadd(aExcecao, IIf(lAchouSS1, SS1->S1_ISS, SF7->F7_ISS))
					If cPaisLoc == "BRA"
						aadd(aExcecao, IIf(lAchouSS1, SS1->S1_VLR_ICM, SF7->F7_VLR_ICM))
						aadd(aExcecao, IIf(lAchouSS1, SS1->S1_VLR_IPI, SF7->F7_VLR_IPI))
						aadd(aExcecao, IIf(lAchouSS1, SS1->S1_VLR_PIS, SF7->F7_VLR_PIS))
						aadd(aExcecao, IIf(lAchouSS1, SS1->S1_VLR_COF, SF7->F7_VLR_COF))				
						aadd(aExcecao, IIf(lAchouSS1, SS1->S1_ALIQPIS, SF7->F7_ALIQPIS))
						aadd(aExcecao, IIf(lAchouSS1, SS1->S1_ALIQCOF, SF7->F7_ALIQCOF))				
						aadd(aExcecao, IIf(lAchouSS1, SS1->S1_BASEICM, SF7->F7_BASEICM))
						aadd(aExcecao, IIf(lAchouSS1, SS1->S1_BASEIPI, SF7->F7_BASEIPI))
						aadd(aExcecao, IIf(lAchouSS1, SS1->S1_VLRICMP, SF7->F7_VLRICMP))						
						aadd(aExcecao, IIf(lAchouSS1, SS1->S1_ALIQIPI, SF7->F7_ALIQIPI))
						aadd(aExcecao, IIf(lAchouSS1, SS1->S1_REDPIS, SF7->F7_REDPIS))
						aadd(aExcecao, IIf(lAchouSS1, SS1->S1_REDCOF, SF7->F7_REDCOF))
						aadd(aExcecao, IIf(lAchouSS1, SS1->S1_ICMPAUT, SF7->F7_ICMPAUT))	 
						aadd(aExcecao, Iif(aFieldPos[FP_F7_TNATREC],IIf(lAchouSS1, SS1->S1_TNATREC, SF7->F7_TNATREC),""))
						aadd(aExcecao, Iif(aFieldPos[FP_F7_CNATREC],IIf(lAchouSS1, SS1->S1_CNATREC, SF7->F7_CNATREC),""))      
						aadd(aExcecao, Iif(aFieldPos[FP_F7_GRUPONC],IIf(lAchouSS1, SS1->S1_GRUPONC, SF7->F7_GRUPONC),""))
						aadd(aExcecao, Iif(aFieldPos[FP_F7_DTFIMNT],IIf(lAchouSS1, SS1->S1_DTFIMNT, SF7->F7_DTFIMNT),CtoD("")))			
						aadd(aExcecao, Iif(aFieldPos[FP_F7_PRCUNIC],IIf(lAchouSS1, SS1->S1_PRCUNIC, SF7->F7_PRCUNIC),0))
						aadd(aExcecao, Iif(aFieldPos[FP_F7_BSICMST],IIf(lAchouSS1, SS1->S1_BSICMST, SF7->F7_BSICMST),0))
						aadd(aExcecao, Iif(aFieldPos[FP_F7_IDHIST], IIf(lAchouSS1, SS1->S1_IDHIST,  SF7->F7_IDHIST), ""))
						aadd(aExcecao, Iif(aFieldPos[FP_F7_ORIGEM], IIf(lAchouSS1, SS1->S1_ORIGEM,  cOrigem), ""))
						aadd(aExcecao, Iif(aFieldPos[FP_F7_SITTRIB],IIf(lAchouSS1, SS1->S1_SITTRIB, cSitTrib),""))
					Else
						aadd(aExcecao,0)
						aadd(aExcecao,0)
						aadd(aExcecao,0)
						aadd(aExcecao,0)
						aadd(aExcecao,0)
						aadd(aExcecao,0)
						aadd(aExcecao,0)
						aadd(aExcecao,0)
						aadd(aExcecao,0)
						aadd(aExcecao,0)
						aadd(aExcecao,0)
						aadd(aExcecao,0)						
						aadd(aExcecao,0) 
						aadd(aExcecao,"")
						aadd(aExcecao,"")
						aadd(aExcecao,"")						
						aadd(aExcecao,CToD(""))	
						aadd(aExcecao,0)
						aadd(aExcecao,0)				
						aadd(aExcecao,"")
						aadd(aExcecao,"")
						aadd(aExcecao,"")			
					EndIf

					Exit

				EndIf

			EndIf

			(cAls)->(dbSkip())

		EndDo

	Else
		aExcecao := aNfItem[nScan][IT_EXCECAO]
	EndIf

	If cPaisLoc == "BRA" .And. aNFCab[NF_OPERNF]=="S" .And. !Empty(aNFCab[NF_CLIEFAT])

		nScan := aScan(aNfItem,{|x| !Empty(x[IT_EXCEFAT]) .And. x[IT_EXCEFAT,4] == cGRTrib })

		If nScan == 0 

			If SF7->(dbSeek(xFilial("SF7") + avKey(cGRTrib,"F7_GRTRIB") + avKey(aNFCab[NF_GRPFAT],"F7_GRPCLI") ) )

				While !SF7->(Eof()).And.SF7->F7_FILIAL==xFilial("SF7") .And. SF7->F7_GRTRIB == cGRTrib .And. SF7->F7_GRPCLI == aNFCab[NF_GRPFAT]
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³Para o tratamento da exceção do cliente do faturamento,          ³
					//³por ser utilizado apenas para PIS e COFINS, não irá considerar o ³
					//³o tratamento  de destino e origem.                               ³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					If 	( aNfCab[NF_TIPOFAT] == SF7->F7_TIPOCLI .Or. SF7->F7_TIPOCLI == "*" )
						aadd(aExceFat,SF7->F7_ALIQINT)
						aadd(aExceFat,SF7->F7_ALIQEXT)
						aadd(aExceFat,SF7->F7_MARGEM)
						aadd(aExceFat,SF7->F7_GRTRIB)
						aadd(aExceFat,"S")
						aadd(aExceFat,SF7->F7_ALIQDST)
						aadd(aExceFat,SF7->F7_ISS)
						aadd(aExceFat,SF7->F7_VLR_ICM)
						aadd(aExceFat,SF7->F7_VLR_IPI)
						aadd(aExceFat,SF7->F7_VLR_PIS)
						aadd(aExceFat,SF7->F7_VLR_COF)
						aadd(aExceFat,SF7->F7_ALIQPIS)
						aadd(aExceFat,SF7->F7_ALIQCOF)
						aadd(aExceFat,SF7->F7_BASEICM)
						aadd(aExceFat,SF7->F7_BASEIPI)
						aadd(aExceFat,SF7->F7_VLRICMP)
						aadd(aExceFat,SF7->F7_ALIQIPI)
						aadd(aExceFat,SF7->F7_REDPIS)
						aadd(aExceFat,SF7->F7_REDCOF)
						aadd(aExceFat,SF7->F7_ICMPAUT)
						aadd(aExceFat,Iif(aFieldPos[FP_F7_TNATREC],SF7->F7_TNATREC,""))
						aadd(aExceFat,Iif(aFieldPos[FP_F7_CNATREC],SF7->F7_CNATREC,""))
						aadd(aExceFat,Iif(aFieldPos[FP_F7_GRUPONC],SF7->F7_GRUPONC,""))
						aadd(aExceFat,Iif(aFieldPos[FP_F7_DTFIMNT],SF7->F7_DTFIMNT,CtoD("")))
						aadd(aExceFat,Iif(aFieldPos[FP_F7_PRCUNIC],SF7->F7_PRCUNIC,0))
						aadd(aExceFat,Iif(aFieldPos[FP_F7_BSICMST],SF7->F7_BSICMST,0))
						aadd(aExceFat,"") //IDHIST
						aadd(aExceFat,Iif(aFieldPos[FP_F7_ORIGEM],cOrigem,""))
						aadd(aExceFat,Iif(aFieldPos[FP_F7_SITTRIB],cSitTrib,""))
						Exit
			        EndIf
			    	SF7->(dbSkip())
			    EndDo
		    EndIf
		Else
			aExceFat := aNfItem[nScan][IT_EXCEFAT]
		EndIf
	EndIf
	
EndIf

aNfItem[nItem][IT_EXCECAO] := aExcecao
aNfItem[nItem][IT_EXCEFAT] := aExceFat

If Len(aExcecao) > 0
	aNfItem[nItem][IT_IDSF7] := aExcecao[27]
EndIf	               

RestArea(aAreaSF7)
RestArea(aArea)

Return(aExcecao)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³ MaFisAjIt³ Autor ³ Gustavo Rueda         ³ Data ³13/12/2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Funcao de consistencias dos ajustes dos documentos fiscais. ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³nXX -> Numero do item.                                      ³±±
±±³          ³nTipo -> Tipo de processamento. 1=Item a item, 2=Todos Items³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisAjIt(nXX,nTipo)
Local aArea		:= SB1->(GetArea())
Local aGrava	:= {}
Local aBkpaCls	:= {}
Local cItem		:= Iif("E"$aNfCab[NF_OPERNF],"0001", "01")
Local cSeq		:= "001"
Local cUfLanc	:= ""
Local cPrdImp	:= ""
Local cIFCOMP	:= ""
Local cBase		:= ""
Local cAliq		:= ""
Local cValor	:= ""
Local cTpLanc	:= ""
Local nI		:= 0
Local nPosSeq	:= 0
Local nII		:= 0
Local nIF		:= 0
Local nZ		:= 0
Local nAliqVal	:= 0
Local nValor	:= 0
Local nBase		:= 0
Local nAliq		:= 0
Local lGerou	:= .F.
Local lHasRefl	:= .F.

Default	nXX	  := 1
Default	nTipo := 1

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Define se a funcao sera executada para todos os itens (aNfItem) ou para o item corrente ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nII := Iif(nTipo==1,nXX,1)
nIF	:= Iif(nTipo==1,nXX,Len(aNfItem))

If Len(aNfItem)>0
	For nZ := nII To nIF
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Verifica se a linha do item foi deletada ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If aNfItem[nZ,IT_DELETED]
			Loop
		EndIf
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Inicializa o TES correspondente ao item corrente ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		MaFisTes(aNfItem[nZ,IT_TES])
		
		For nI := 1 To Len(aTes[TS_LANCFIS])
			lHasRefl	:=	.F.
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Captura o proximos codigo de sequencia a ser utilizado ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If Len(aGrava) > 0
				nPosSeq	 :=	7
				aBkpaCls :=	aClone(aGrava)
				aSort(aBkpaCls,,,{|aX,aY| aX[nPosSeq]<aY[nPosSeq]})
				cSeq :=	aBkpaCls[Len(aBkpaCls),nPosSeq]
			EndIf
			If lGerou
				cSeq  := Soma1(cSeq)
				lGerou:= .F.
			EndIf
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Verifica qual eh a UF do codigo de ajuste corrente 	  ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			cUfLanc := Substr(aTes[TS_LANCFIS,nI,1],1,2)
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Informacao Complementar do Codigo de Ajuste		 	  ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			cIFCOMP	:=	aTes[TS_LANCFIS,nI,2]
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Produto Importado: exclusivo para o codigo SC10000018  ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If aNfCab[NF_OPERNF] == "S" .And. aFieldPos[FP_B1_IMPORT]
				dbSelectArea("SD2")
				dbGoTo(aNfItem[nZ,IT_RECNOSB1])
				cPrdImp := SB1->B1_IMPORT
		  	Endif
		  	
		  	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Verifica se a UF do codigo de ajuste corresponde a UF do MV_ESTADO  ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		  	If cUfLanc $ aParSX6[MV_ESTADO]
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Campo que determina se o lancamento eh de Apuracao (1) ou de NF (2)																	³
				//³																																		³
				//³ Alguns codigos de ajuste sao validados pelo proprio MATXFIS, ou seja, as regras sao pre-estabelecidas no codigo fonte, porem		³
				//³foi criado o mecanismo para configuracao dos Codigos de Ajuste utilizando o Cadastro de Reflexo (CE0) junto ao Cadastro de 			³
				//³Lancamentos (CC7). Desta forma as regras serao configuradas pelo proprio usuario, que definira Base, Aliquota e Valor do Codigo		³
				//³atraves da tabela CE0.																												³
				//³ Os codigos que ja eram validadas no MATXFIS foram mantidos por questao de legado. Os demais alem desses codigos deverao ser			³
				//³configurados conforme explicacao acima. 																								³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				cTpLanc := Iif( Len( aTes[ TS_LANCFIS , nI , 1 ] ) == 10 , "2" , "1" )
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³Apenas verifico os codigos do MATXFIS caso seja Ajuste de Documento Fiscal e nao possua um Codigo de Reflexo relacionado ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If cTpLanc == "2" .And. Empty( aTes[TS_LANCFIS,nI,3] )
					lGerou := .T.
					cItem  := aNfItem[nZ,IT_ITEM]
					//000 - OPERACAO NORMAL
					If Right(aTes[TS_LANCFIS,nI,1],TamSx3("CC8_CODIGO")[1])=="000"	.And.;
						cUfLanc $ ("MG/MA/MS/PB/SE") .And. aNfItem[nZ,IT_VALICM]>0 .And. aNfItem[nZ,IT_VALISS]==0 .and. aNfItem[nZ][IT_VALSOL]==0 .and. aNfItem[nZ][IT_VALFECP]==0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALICM],cSeq,cIFCOMP,cTpLanc})
				   		// Outros créditos; Op.Própria; Resp.: Informativo;Apur.: Informativo; Mercadoria;Simples Nacional
					//Tratamento do FECP de SE
					ElseIf cUfLanc$("SE") .AND. aTes[TS_LANCFIS,nI,1]$"SE70010000" .And. aNfItem[nZ][IT_VALFECP]>0 
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQFECP], aNfItem[nZ,IT_VALFECP],cSeq,cIFCOMP,cTpLanc})
					//Tratamento do FECP ST de SE
					ElseIf cUfLanc$("SE") .AND. aTes[TS_LANCFIS,nI,1]$"SE71010000" .And. aNfItem[nZ][IT_VFECPST]>0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASESOL], aNfItem[nZ,IT_ALIQFECP], aNfItem[nZ][IT_VFECPST],cSeq,cIFCOMP,cTpLanc})
					ElseIf cUfLanc=="MG" .And. aNfCab[NF_OPERNF]=="E"  .And. aNFCab[NF_SIMPNAC] == "1" .And. aTes[TS_LFICM] == "T" .And. (aTes[TS_LANCFIS,nI,1]$"MG10990505") 
						aAdd(aGrava, {aNfItem[nZ,IT_ITEM], aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALICM],cSeq,cIFCOMP,cTpLanc})
				   		//Informativo; Op.ST; Resp.: Informativo; Apur.: Informativo; Mercadoria; Op. Normal.
					ElseIf cUfLanc=="MG" .And. aNfCab[NF_OPERNF]=="E"  .And. aNFCab[NF_SIMPNAC] == "1" .And. aTes[TS_LFICM] == "T"  .And. (aTes[TS_LANCFIS,nI,1]$"MG91990000") .And. aNfItem[nZ,IT_VALSOL] >0
						aAdd(aGrava, {aNfItem[nZ,IT_ITEM], aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASESOL], aNfItem[nZ,IT_ALIQSOL], aNfItem[nZ,IT_VALSOL],cSeq,cIFCOMP,cTpLanc})
						// Lançamentos de Sub-apuração de ICMS.
					ElseIf Alltrim(cUfLanc)$"ES/PA" .And. SubStr(aTes[TS_LANCFIS,nI,1],4,1)$"3/4/5" .And. aNfItem[nZ,IT_VALICM] >0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALICM],cSeq,cIFCOMP,cTpLanc})
						//001 - DIFERENCIAL ALIQUOTA (SC=002 e 003)
						//001 - ESTORNO DE CREDITO
					ElseIf ( Right(aTes[TS_LANCFIS,nI,1],TamSx3("CC8_CODIGO")[1])=="001" .And.;
						cUfLanc $ ("GO") .And. (aTes[TS_LANCFIS,nI,1]$"GO50009001") .And. aNFCab[NF_SIMPNAC] == "1") .And. aNfItem[nZ,IT_VALICM] >0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALICM],cSeq,cIFCOMP,cTpLanc})
						//005 - ST - DIF ALIQUOTA
					ElseIf aNfItem[nZ,IT_VALCMP]>0 .And.;
						(((Right(aTes[TS_LANCFIS,nI,1],TamSx3("CC8_CODIGO")[1])$"001/005" .And. cUfLanc $ ("MG/MS/PB/SE")) .Or.;
						(AllTrim(aTes[TS_LANCFIS,nI,1])$"SC40000002/SC40000003")) .Or. (AllTrim(aTes[TS_LANCFIS,nI,1])$"RJ70000002"))	//Tratamento conforme codigos da tabela tb54, tb55 e tb129.
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQCMP]-aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALCMP],cSeq,cIFCOMP,cTpLanc})
						//002 - TRANSFERENCIA DE CREDITO
					ElseIf Right(aTes[TS_LANCFIS,nI,1],TamSx3("CC8_CODIGO")[1])=="002" .And.;
						cUfLanc $ ("MG/MS/PB/SE") .And. aTes[TS_TRFICM]=="1".And. aNfItem[nZ,IT_VALMERC] >0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALMERC],cSeq,cIFCOMP,cTpLanc})
					ElseIf cUfLanc $ ("RS")  .And. (aTes[TS_LANCFIS,nI,1]$"RS10009029") .And. aNfCab[NF_OPERNF]=="E" .And. aTes[TS_TRFICM]=="1" 	
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALMERC],cSeq,cIFCOMP,cTpLanc}) 	       
					ElseIf cUfLanc $ ("GO")  .And. (aTes[TS_LANCFIS,nI,1]$"GO71003005|GO71003006") .And. aNfCab[NF_OPERNF]=="E"  .And. aNfItem[nZ][IT_VALSOL] >0		  
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1",aNfItem[nZ,IT_BASESOL], aNfItem[nZ,IT_ALIQSOL], aNfItem[nZ][IT_VALSOL],cSeq,cIFCOMP,cTpLanc})
								//004 - ANTECIPACAO TRIBUTARIA
					ElseIf Right(aTes[TS_LANCFIS,nI,1],TamSx3("CC8_CODIGO")[1])=="004" .And.;
						cUfLanc $ ("MA/MS/MG/PB/SE") .And. aTes[TS_ANTICMS]=="1" .And. aNfItem[nZ,IT_VALANTI] > 0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALANTI],cSeq,cIFCOMP,cTpLanc})
						//008 - ATIVO PERMANENTE
					ElseIf ( (Right(aTes[TS_LANCFIS,nI,1],TamSx3("CC8_CODIGO")[1])=="008" .And.;
						cUfLanc $ ("MG/MS/PB/SE")) .Or. aTes[TS_LANCFIS,nI,1]$"PA40000001/SC40000002/AL00000004") .And. aNfItem[nZ,IT_VALCMP]>0 .And.;
						(SubStr(aNfItem[nZ,IT_CF],2,3)$"91 " .Or. SubStr(aNfItem[nZ,IT_CF],2,3)$"551")
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALCMP],cSeq,cIFCOMP,cTpLanc})
					ElseIf cUfLanc $ ("MG") .And. (aTes[TS_LANCFIS,nI,1]$"MG10000503") .And. aNfCab[NF_OPERNF]=="E" .And.  aNfItem[nZ,IT_BASNDES] > 0  .And. aNfItem[nZ,IT_ICMNDES] > 0
					  	aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASNDES], 0, aNfItem[nZ,IT_ICMNDES],cSeq,cIFCOMP,cTpLanc}) 
						//009 - CREDITO PRESUMIDO				
					ElseIf !Empty(aTes[TS_TPCPRES]) .And. aNfItem[nZ][IT_LIVRO][LF_CRDPRES] > 0 .And. aTes[TS_LANCFIS,nI,1]$"ES10000100"
						If aTes[TS_TPCPRES] =="C"
							aAdd(aGrava, {aNfItem[nZ,IT_ITEM], aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ][IT_LIVRO][LF_VALCONT], aTes[TS_CRDPRES], aNfItem[nZ][IT_LIVRO][LF_CRDPRES],cSeq,cIFCOMP,cTpLanc})
						ElseIf aTes[TS_TPCPRES] =="R"
							aAdd(aGrava, {aNfItem[nZ,IT_ITEM], aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aTes[TS_CRDPRES], aNfItem[nZ][IT_LIVRO][LF_CRDPRES],cSeq,cIFCOMP,cTpLanc})
						EndIf
					ElseIf ( (Right(aTes[TS_LANCFIS,nI,1],TamSx3("CC8_CODIGO")[1])=="009" .And.;
						cUfLanc $ ("MA/MS/SE")) .Or. aTes[TS_LANCFIS,nI,1]$"PA10000997" ) .And. aNfItem[nZ][IT_LIVRO][LF_CRDPRES] > 0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ][IT_LIVRO][LF_VALCONT], aTes[TS_CRDPRES], aNfItem[nZ][IT_LIVRO][LF_CRDPRES],cSeq,cIFCOMP,cTpLanc})
						lGerou	:=	.T.
						//003 - COMPENSACAO DE SALDO
						//004 - ANTECIPACAO TRIBUTARIA
						//006 - REEMBOLSO COMERCIAL
						//007 - DESCONTO PELO ICMS
						//010 - LANCAMENTO EXTEMPORANEO
						//011 - RESTITUICAOO DE ICMS/ST - RESSARCIMENTO
						//012 - RESTITUICAOO DE ICMS/ST - ABATIMENTO
						//013 - RESTITUICAOO DE ICMS/ST - CREDITAMENTO
						//014 - ST - TRANSPORTE
					ElseIf(Right(aTes[TS_LANCFIS,nI,1],TamSx3("CC8_CODIGO")[1])=="014" .And.;
						cUfLanc == "MG".And. aTes[TS_LANCFIS,nI,1]$"MG10001014/MG71091014/MG91001014/MG91011014/MG91021014" .And. aNfItem[nZ,IT_VALSOL]>0)
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASESOL], aNfItem[nZ,IT_ALIQSOL], aNfItem[nZ,IT_VALSOL],cSeq,cIFCOMP,cTpLanc})
						//015 - ORIGEM EM AUTUACOES
						//016 - ICMS - IMPORTACAO (COMBUSTIVEIS)
						//017 - IMPORTACAO
						//018 - CRÉDITO PRESUMIDO NAS SAÍDAS DE MERCADORIAS SUBSEQUENTES À IMPORTAÇÃO
					Elseif (Right(aTes[TS_LANCFIS,nI,1],TamSx3("CC8_CODIGO")[1])=="018" .And.;
						cUfLanc $ ("SC") .Or. aTes[TS_LANCFIS,nI,1]$"SC10000018") .And. aNfCab[NF_OPERNF]=="S" .And. cPrdImp == "S".And. aNfItem[nZ,IT_BASEICM] >0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], 3, aNfItem[nZ,IT_BASEICM]*3/100,cSeq,cIFCOMP,cTpLanc})
						//019 - CREDITO PRESUMIDO NAS SAIDAS DE PEIXES CRUSTACEOS E MOLUSCOS
					ElseIf ( (Right(aTes[TS_LANCFIS,nI,1],TamSx3("CC8_CODIGO")[1])=="019" .And.;
						cUfLanc $ ("SC")) .Or. aTes[TS_LANCFIS,nI,1]$"SC10000019" ) .And. aNfItem[nZ][IT_LIVRO][LF_CRDPRES] > 0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ][IT_LIVRO][LF_VALCONT], aTes[TS_CRDPRES], aNfItem[nZ][IT_LIVRO][LF_CRDPRES],cSeq,cIFCOMP,cTpLanc})
					ElseIf cUfLanc $ ("SC") .And. aTes[TS_LANCFIS,nI,1]$"SC10000033" .And. aNfItem[nZ][IT_LIVRO][LF_CRDPRES] > 0 .And. aNfCab[NF_OPERNF]=="S"
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ][IT_LIVRO][LF_VALCONT], aTes[TS_CRDPRES], aNfItem[nZ][IT_LIVRO][LF_CRDPRES],cSeq,cIFCOMP,cTpLanc})		
						//023 - TRANSFERENCIA DE CREDITO ACUMULADO
					ElseIf ( Right(aTes[TS_LANCFIS,nI,1],TamSx3("CC8_CODIGO")[1])=="023" .And.;
						cUfLanc $ ("GO") .And. aTes[TS_LANCFIS,nI,1]$"GO40999023") .And. aNfItem[nZ,IT_VALICM] >0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALICM],cSeq,cIFCOMP,cTpLanc})
						//027 - RECEBIDO EM TRANSFERENCIA
					ElseIf ( Right(aTes[TS_LANCFIS,nI,1],TamSx3("CC8_CODIGO")[1])=="027" .And.;
						cUfLanc $ ("GO") .And. aTes[TS_LANCFIS,nI,1]$"GO10990027") .And. aNfItem[nZ,IT_VALICM] >0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALICM],cSeq,cIFCOMP,cTpLanc})
						//029 - CREDITO DE ICMS EMITIDO NA ENTRADA DE MERCADORIA ADQUIRIDA DE FORNECEDORES ENQUADRADOS NO SIMPLES NACIONAL
					ElseIf ( Right(aTes[TS_LANCFIS,nI,1],TamSx3("CC8_CODIGO")[1])=="029" .And.;
						cUfLanc $ ("GO") .And. (aTes[TS_LANCFIS,nI,1]$"GO10009029") .And. aNFCab[NF_SIMPNAC] == "1") .And. aNfItem[nZ,IT_VALICM]>0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALICM],cSeq,cIFCOMP,cTpLanc})
					ElseIf cUfLanc $ ("PA")  .And. (aTes[TS_LANCFIS,nI,1]$"PA00000999") .And. aNfCab[NF_OPERNF]=="E" .And. aNFCab[NF_SIMPNAC] == "1" .And. aNfItem[nZ,IT_VALICM]>0	
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALICM],cSeq,cIFCOMP,cTpLanc}) 	     
						//034 - CREDITO PRESUMIDO NA ENTRADA DE MERCADORIA ADQUIRIDA DE FORNECEDORES ENQUADRADOS NO SIMPLES NACIONAL
					ElseIf (Right(aTes[TS_LANCFIS,nI,1],TamSx3("CC8_CODIGO")[1])=="034" .And.; 
						(cUfLanc $ ("SC") .Or. aTes[TS_LANCFIS,nI,1]$"SC10000034") .And. aNfCab[NF_OPERNF]=="E"  .And. aNFCab[NF_SIMPNAC] == "1" .And. aNfItem[nZ,IT_VALICM] >0)
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALICM],cSeq,cIFCOMP,cTpLanc})
						//999 - OUTROS AJUSTES
						//DIFERENCIAL DE ALIQUOTA SOBRE MATERIAL DE USO/CONSUMO
					ElseIf (aTes[TS_LANCFIS,nI,1]$"MG10000504/MG20000504/PA40000002/PA70000017/PB90990018/SC40000003/ES70009702") .And. ;
						aNfItem[nZ,IT_VALCMP]>0 .And. (SubStr(aNfItem[nZ,IT_CF],2,3)$"97 " .Or. SubStr(aNfItem[nZ,IT_CF],2,3)$"556")
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALCMP],cSeq,cIFCOMP,cTpLanc})
						//ESTORNO DE CREDITO
					ElseIf (aTes[TS_LANCFIS,nI,1]$"MA50000000/MS50000000/MS40000000/MS40000999/MS50000999/PA50000999/SC50000999/SC51000999") ;
						.And. aTes[TS_ESTCRED]>0 .And. aNfItem[nZ,IT_ESTCRED]>0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_VALICM], aTes[TS_ESTCRED], aNfItem[nZ,IT_ESTCRED],cSeq,cIFCOMP,cTpLanc})
						//ICMS DIFERIDO
					ElseIf (aTes[TS_LANCFIS,nI,1]$"AL99999323/AL99999324/AL99999325/AL99999326/AL99999327") .And.;
						aTES[TS_PICMDIF]>0 .And. aTES[TS_PICMDIF]<>100 .And. aNfItem[nZ,IT_ICMSDIF]>0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_ICMSDIF],cSeq,cIFCOMP,cTpLanc})
						//FECOP RN
					Elseif (aTes[TS_LANCFIS,nI,1]$"RN10000002") .And.;
						cUfLanc $ ("RN") .And. aTes[TS_ISEFERN]=="2" .And. aNfItem[nZ,IT_VFECPRN] > 0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALFECRN], aNfItem[nZ,IT_VFECPRN], cSeq,cIFCOMP,cTpLanc})
					Elseif (aTes[TS_LANCFIS,nI,1]$"RN11000001") .And.;
						cUfLanc $ ("RN") .And. aTes[TS_ISEFERN]=="2" .And. aNfItem[nZ,IT_VFESTRN] > 0 .And. Substr(aNfItem[nZ,IT_CF],1,1)=="5"
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASESOL], aNfItem[nZ,IT_ALFECRN], aNfItem[nZ,IT_VFESTRN], cSeq,cIFCOMP,cTpLanc})
					Elseif (aTes[TS_LANCFIS,nI,1]$"RN11000002") .And.;
						cUfLanc $ ("RN") .And. aTes[TS_ISEFERN]=="2" .And. aNfItem[nZ,IT_VFESTRN] > 0 .And. Substr(aNfItem[nZ,IT_CF],1,1)=="2"
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASESOL], aNfItem[nZ,IT_ALFECRN], aNfItem[nZ,IT_VFESTRN], cSeq,cIFCOMP,cTpLanc})
					Elseif (aTes[TS_LANCFIS,nI,1]$"RN70000001") .And.;
						cUfLanc $ ("RN") .And. aTes[TS_ISEFERN]=="2" .And. aNfItem[nZ,IT_VFECPRN] > 0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALFECRN], aNfItem[nZ,IT_VFECPRN], cSeq,cIFCOMP,cTpLanc})
					Elseif (aTes[TS_LANCFIS,nI,1]$"RN71000001") .And.;
						cUfLanc $ ("RN") .And. aTes[TS_ISEFERN]=="2" .And. aNfItem[nZ,IT_VFESTRN] > 0 .And. Substr(aNfItem[nZ,IT_CF],1,1)=="5"
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASESOL], aNfItem[nZ,IT_ALFECRN], aNfItem[nZ,IT_VFESTRN], cSeq,cIFCOMP,cTpLanc})
					Elseif (aTes[TS_LANCFIS,nI,1]$"RN71000002") .And.;
						cUfLanc $ ("RN") .And. aTes[TS_ISEFERN]=="2" .And. aNfItem[nZ,IT_VFESTRN] > 0 .And. Substr(aNfItem[nZ,IT_CF],1,1)=="2"
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASESOL], aNfItem[nZ,IT_ALFECRN], aNfItem[nZ,IT_VFESTRN], cSeq,cIFCOMP,cTpLanc})
					Elseif (aTes[TS_LANCFIS,nI,1]$"RN00000002") .And.;
						cUfLanc $ ("RN") .And. aTes[TS_ANTICMS]=="1" .And. aNfItem[nZ,IT_VALANTI] > 0 .And. ;
						Substr(aNfItem[nZ,IT_CF],1,1)=="2"
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASESOL], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALANTI],cSeq,cIFCOMP,cTpLanc})
					Elseif (aTes[TS_LANCFIS,nI,1]$"RN70000003") .And.;
						cUfLanc $ ("RN") .And. aTes[TS_ANTICMS]=="1" .And. aNfItem[nZ,IT_VALANTI] > 0 .And. ;
						Substr(aNfItem[nZ,IT_CF],1,1)=="2"
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASESOL], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALANTI],cSeq,cIFCOMP,cTpLanc})              
	                              //Crédito
	                Elseif (aTes[TS_LANCFIS,nI,1]$"RN00000010") .And. cUfLanc $ ("RN") .And. aNfCab[NF_OPERNF]=="E" .And. 	aTes[TS_CREDST]<>"3" .And. ;
						Substr(aNfItem[nZ,IT_CF],1,1)=="2" .And.  aNfItem[nZ,IT_VALSOL]>0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASESOL], aNfItem[nZ,IT_ALIQSOL], aNfItem[nZ,IT_VALSOL],cSeq,cIFCOMP,cTpLanc})
	
	                //Débitos Especiais
					Elseif (aTes[TS_LANCFIS,nI,1]$"RN70000005") .And. cUfLanc $ ("RN") .And. aNfCab[NF_OPERNF]=="E" .And. Substr(aNfItem[nZ,IT_CF],1,1)=="2" .And. aNfItem[nZ,IT_VALSOL] >0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASESOL], aNfItem[nZ,IT_ALIQSOL], aNfItem[nZ,IT_VALSOL],cSeq,cIFCOMP,cTpLanc})					
					
					//Còdigo informativo não leva antecipação
					Elseif (aTes[TS_LANCFIS,nI,1]$"RN99990004") .And. cUfLanc $ ("RN").And. aNfItem[nZ,IT_VALSOL]>0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASESOL], aNfItem[nZ,IT_ALIQSOL], aNfItem[nZ][IT_VALSOL],cSeq,cIFCOMP,cTpLanc})
					   			
						//Diferencia de alíquota de Ativo Permanente
					Elseif (aTes[TS_LANCFIS,nI,1]$"RN70009002") .And. cUfLanc $ ("RN") .And. aNfCab[NF_OPERNF]=="E" .And. SubStr(aNfItem[nZ,IT_CF],2,3)$"551|552|352" .And. aNfItem[nZ][IT_VALCMP] > 0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASESOL], aNfItem[nZ][IT_ALIQSOL], aNfItem[nZ][IT_VALSOL],cSeq,cIFCOMP,cTpLanc})								
						
					//Diferencia de alíquota de Serv. de Transporte
					ElseIf aTes[TS_LANCFIS,nI,1]$"RN70001004" .And. aNfCab[NF_OPERNF]=="E"  .And. (AllTrim(aNFCab[NF_ESPECIE]) $ "CTR/CTE" .Or. "NFST"$AllTrim(aNFCab[NF_ESPECIE])) .And. aNfItem[nZ,IT_VALCMP]>0         
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASESOL], aNfItem[nZ][IT_ALIQSOL], aNfItem[nZ][IT_VALSOL],cSeq,cIFCOMP,cTpLanc})					
	
					//Diferencia de alíquota de Ativo Permanente
					Elseif (aTes[TS_LANCFIS,nI,1]$"RN70009005") .And.	cUfLanc $ ("RN") .And. aNfCab[NF_OPERNF]=="E" .And. SubStr(aNfItem[nZ,IT_CF],2,3)$"551|552|352" .And. aNfItem[nZ][IT_VALCMP] > 0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ][IT_ALIQICM], aNfItem[nZ][IT_VALCMP],cSeq,cIFCOMP,cTpLanc})												   
							
					//Diferencia de alíquota Uso e Consumo
					Elseif (aTes[TS_LANCFIS,nI,1]$"RN70009006") .And.	cUfLanc $ ("RN") .And. aNfCab[NF_OPERNF]=="E" .And. SubStr(aNfItem[nZ,IT_CF],2,3)$"556|557|352" .And. aNfItem[nZ][IT_VALCMP] > 0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ][IT_ALIQICM], aNfItem[nZ][IT_VALCMP],cSeq,cIFCOMP,cTpLanc})			
																
						//CRÉDITO PRESUMIDO NA SAÍDA RONDÔNIA
					Elseif (aTes[TS_LANCFIS,nI,1]$"RO10000012/RO10000006/RO10000007/RO10000003") .And.	cUfLanc $ ("RO") .And. aNfCab[NF_OPERNF]=="S" .And. aNfItem[nZ][IT_LIVRO][LF_CRPRERO] > 0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_VALICM], aTes[TS_CRPRERO], aNfItem[nZ][IT_LIVRO][LF_CRPRERO],cSeq,cIFCOMP,cTpLanc})
						//Notas Fiscais de saídas com isenção - Rondônia
					Elseif (Right(aTes[TS_LANCFIS,nI,1],TamSx3("CC8_CODIGO")[1])$"009/016/017/068/078/083/130/021/022/037/086/116") .And.	cUfLanc $ ("RO") .And. aNfCab[NF_OPERNF]=="S" .And. aTes[TS_LFICM] $"I".And. aNfItem[nZ,IT_VALICM] >0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1",aNfItem[nZ,IT_BASEICM], aNfItem[nZ][IT_ALIQICM], aNfItem[nZ][IT_VALICM],cSeq,cIFCOMP,cTpLanc})
						//Diferencia de alíquota de Ativo Permanente
					Elseif (aTes[TS_LANCFIS,nI,1]$"RO40000001/ES70009701") .And.	cUfLanc $ ("RO/ES") .And. aNfCab[NF_OPERNF]=="E" .And. SubStr(aNfItem[nZ,IT_CF],2,3)$"551|552|352" .And. aNfItem[nZ][IT_VALCMP] > 0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ][IT_ALIQICM], aNfItem[nZ][IT_VALCMP],cSeq,cIFCOMP,cTpLanc})
			 	       //Redução de Base de Calculo
			 	   	Elseif (Right(aTes[TS_LANCFIS,nI,1],TamSx3("CC8_CODIGO")[1])$"165/166/170/175/183/195") .And. cUfLanc $ ("RO") .And. aNfCab[NF_OPERNF]=="S" .And. aTes[TS_BASEICM]>0 .And. aTes[TS_LFICM] $"IO" .And. aTes[TS_CONSUMO]$"SO"
				  		aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM],aNfItem[nZ,IT_ALIQICM],aTes[TS_BASEICM],cSeq,cIFCOMP,cTpLanc})
					//Diferencial de alíquota de transporte
					ElseIf aTes[TS_LANCFIS,nI,1]$"ES70009703" .And. aNfCab[NF_OPERNF]=="E"  .And. (AllTrim(aNFCab[NF_ESPECIE]) $ "CTR/CTE" .Or. "NFST"$AllTrim(aNFCab[NF_ESPECIE])) .And. aNfItem[nZ,IT_VALCMP]>0         
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ][IT_ALIQICM], aNfItem[nZ][IT_VALCMP],cSeq,cIFCOMP,cTpLanc})
						//Diferencia de alíquota Uso e consumo
					Elseif (aTes[TS_LANCFIS,nI,1]$"RO40000002") .And.	cUfLanc $ ("RO") .And. aNfCab[NF_OPERNF]=="E" .And. SubStr(aNfItem[nZ,IT_CF],2,3)$"556|557|352" .And. aNfItem[nZ,IT_VALCMP]>0 
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ][IT_ALIQICM], aNfItem[nZ][IT_VALCMP],cSeq,cIFCOMP,cTpLanc})
						//DEBITO POR TRANSFERENCIA DE SALDO CREDOR
					ElseIf Alltrim(aNFItem[nZ][IT_CF]) $ "5601/5602" .And. aTes[TS_LANCFIS,nI,1]$"RS40009193" .And. aNfItem[nZ,IT_VALICM]>0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALICM],cSeq,cIFCOMP,cTpLanc})
		            //CÓDIGOS DO ESTADO RIO GRANDE DO SUL
		            //Antecipação de ICMS Rio Grande do Sul
					ElseIf aTes[TS_LANCFIS,nI,1]$"RS10000106/RS40000313" .And. aTes[TS_ANTICMS]=="1" .And. aNfItem[nZ,IT_VALANTI] > 0 .And. aNFCab[NF_UFDEST] == "RS" .And. aNFCab[NF_UFORIGEM] <> "RS"
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALANTI],cSeq,cIFCOMP,cTpLanc})
		            //Devolução de Mercadoria recebida pra uso e consumo
					ElseIf aTes[TS_LANCFIS,nI,1]$"RS10000206" .And. aNfCab[NF_OPERNF]=="S" .And. aNFCab[NF_TIPONF] $ "D" .And. SubStr(aNfItem[nZ,IT_CF],2,3)$"556" .And. aNfItem[nZ][IT_VALICM] >0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1",aNfItem[nZ,IT_BASEICM], aNfItem[nZ][IT_ALIQICM], aNfItem[nZ][IT_VALICM],cSeq,cIFCOMP,cTpLanc})				
					//Créditos presumidos - LIVRO I, ART. 32, LXIII - LEITE FLUIDO
					ElseIf aTes[TS_LANCFIS,nI,1]$"RS10009269" .And. aNfCab[NF_OPERNF]=="S" .And. aNFCab[NF_UFORIGEM] == "RS" .And. aNFCab[NF_UFDEST] <> "RS" .AND. aNfItem[nZ][IT_LIVRO][LF_CRDPRES] > 0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1",aNfItem[nZ,IT_VALICM], aTes[TS_CRDPRES], aNfItem[nZ][IT_LIVRO][LF_CRDPRES],cSeq,cIFCOMP,cTpLanc})
					//Créditos presumidos - LIVRO I, ART. 32, CVII.LEITE DE PROD.PROP.PROD.RUR
					ElseIf aTes[TS_LANCFIS,nI,1]$"RS10009314" .And. aNfCab[NF_OPERNF]=="E" .And. SubStr(aNfItem[nZ,IT_CF],1,1)$"1" .And. aNfItem[nZ][IT_LIVRO][LF_CRDPRES] > 0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1",aNfItem[nZ,IT_VALICM], aTes[TS_CRDPRES], aNfItem[nZ][IT_LIVRO][LF_CRDPRES],cSeq,cIFCOMP,cTpLanc})
					ElseIf aTes[TS_LANCFIS,nI,1]$"RS10009906" .And. aNfCab[NF_OPERNF]=="E" .AND. cUfLanc $ ("RS") .And. !aTes[TS_LFICM]=="Z" .And. aNfItem[nZ][IT_VALICM]
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1",aNfItem[nZ,IT_BASEICM], aNfItem[nZ][IT_ALIQICM], aNfItem[nZ][IT_VALICM],cSeq,cIFCOMP,cTpLanc})
					//DÉBITOS POR RESPONSABILIDADE - ICMS DIFERIDO DO DOCUMENTO DE SAÍDA
					ElseIf aTes[TS_LANCFIS,nI,1]$"RS40000010" .And. aNfCab[NF_OPERNF]=="S" .AND. cUfLanc $ ("RS") .And. aNfItem[nZ][IT_ICMSDIF] >0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1",0, 0, aNfItem[nZ][IT_ICMSDIF],cSeq,cIFCOMP,cTpLanc})
						//Diferencial de Aliquota calculado na Entrada de Outros Débitos
					ElseIf (aTes[TS_LANCFIS,nI,1]$"RS40000113") .And. aNfItem[nZ,IT_VALCMP]>0 .And. aNfCab[NF_OPERNF]=="E" .And. aNfCab[NF_UFORIGEM] <> "RS"
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALCMP],cSeq,cIFCOMP,cTpLanc})																			
						//Diferencial de Aliquota calculado na Entrada de Débitos Especiais
					ElseIf (aTes[TS_LANCFIS,nI,1]$"MG70001001") .And. aNfItem[nZ,IT_VALCMP]>0 .And. aNfCab[NF_OPERNF]=="E" .And. aNfCab[NF_UFORIGEM] <> "MG"
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALCMP],cSeq,cIFCOMP,cTpLanc})																			
						//Outros Débitos
					ElseIf aTes[TS_LANCFIS,nI,1]$"ES40000400" .And.  aNfItem[nZ,IT_VALICM] >0              
		           	   	aAdd(aGrava, {aNfItem[nZ,IT_ITEM], aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALICM],cSeq,cIFCOMP,cTpLanc})
					// Códigos do RS onde o débito se dá por uma nota fiscal emitida no final do período
					ElseIf aTes[TS_LANCFIS,nI,1]$"RS40000213/RS40001010/RS40009913/RS40000010/RS41009705" .And. aNfCab[NF_OPERNF]=="S" .And. aTes[TS_LFICM]=="Z" .And. aNfItem[nZ,IT_VALMERC]>0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1",0, 0, aNfItem[nZ][IT_VALMERC],cSeq,cIFCOMP,cTpLanc})
					// Códigos do RS onde o crédito se dá por uma nota fiscal emitida no final do período
					ElseIf aTes[TS_LANCFIS,nI,1]$"RS10009906/RS10009269/RS10000106/RS10009314/RS10000206/" .And. aNfCab[NF_OPERNF]=="E" .And. aTes[TS_LFICM]=="Z" .And. aNfItem[nZ,IT_VALMERC]>0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1",0, 0, aNfItem[nZ][IT_VALMERC],cSeq,cIFCOMP,cTpLanc})
		   	   		//Debitos Especiais; Op.ST; Resp.:propria; Apur.:Recolhimento espontaneo; Mercadoria;ST interna
		   	   	    //Débitos especiais; Op. ST; Resp. Solidária, Apur.; Recolhimento Espontâneo. Mercadoria; Op. Normal.
					ElseIf cUfLanc=="MG" .And. (aTes[TS_LANCFIS,nI,1]$"MG71010501/MG71110000")  .And. aNfItem[nZ][IT_VALSOL] >0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1",0, 0, aNfItem[nZ][IT_VALSOL],cSeq,cIFCOMP,cTpLanc})
					ElseIf 	cUfLanc=="ES".And. aNfCab[NF_OPERNF]=="E" .And. aNfCab[NF_UFORIGEM] <> "ES" .And. (aTes[TS_LANCFIS,nI,1]$"ES71000712") .And. aTes[TS_ANTICMS]=="1" .And. aNfItem[nZ,IT_VALANTI] > 0 
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALANTI],cSeq,cIFCOMP,cTpLanc})	
					//"Créditos por Transferência" - LIVRO I,ART.59,I,"A" -ESTABELECIMENTO MESMA EMPRESA - Saída
					ElseIf cUfLanc$("RS") .AND. aTes[TS_LANCFIS,nI,1]$"RS10009004" .And. aNfCab[NF_OPERNF]=="S"
						aAdd(aGrava, {aNfItem[nZ,IT_ITEM], aTes[TS_LANCFIS,nI,1], "1", 0, 0, aNfItem[nZ,IT_VALMERC], cSeq, cIFCOMP, cTpLanc})
					//"Créditos por Transferência" - LIVRO I, ART.58, II, NOTA01, B, E ART.58, II, "A" do RICMS/RS - Entrada
					ElseIf cUfLanc$("RS") .AND. aTes[TS_LANCFIS,nI,1]$"RS10009031" .And. aNfCab[NF_OPERNF]=="E"
						aAdd(aGrava, {aNfItem[nZ,IT_ITEM], aTes[TS_LANCFIS,nI,1], "1", 0, 0, aNfItem[nZ,IT_VALMERC], cSeq, cIFCOMP, cTpLanc})
		  			//"Ressarcimento de ICMS ST decorrente da venda para contribuinte localizado em outra unidade da fereção
					ElseIf cUfLanc$("SC") .AND. aTes[TS_LANCFIS,nI,1]$"SC11000002" .And. aNfCab[NF_OPERNF]=="S" .And. SubStr(aNfItem[nZ,IT_CF],1,1)$"6" .And. aNfItem[nZ,IT_VALSOL]>0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASESOL], aNfItem[nZ,IT_ALIQSOL], aNfItem[nZ,IT_VALSOL],cSeq,cIFCOMP,cTpLanc})											
					//Crédito proporcional a mercadoria recebida com ST quando efetuada nova retenção   	
					ElseIf cUfLanc$("SC") .AND. aTes[TS_LANCFIS,nI,1]$"SC10000030" .And. aNfCab[NF_OPERNF]=="E"  .And. aTes[TS_SITTRIB]=="60" .And. aNfItem[nZ,IT_VALICM] >0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALICM],cSeq,cIFCOMP,cTpLanc})					
					//ICMS devido na importação 
					ElseIf cUfLanc$("SC") .AND. aTes[TS_LANCFIS,nI,1]$"SC70000005" .And. aNfCab[NF_OPERNF]=="E" .And. SubStr(aNfItem[nZ,IT_CF],1,1)$"3" .And. aNfItem[nZ,IT_VALICM] >0 
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALICM],cSeq,cIFCOMP,cTpLanc})
					//Crédito presumido na saída de mercadorias importadas do exterior
					ElseIf cUfLanc$("SC") .AND. aTes[TS_LANCFIS,nI,1]$"SC10000013" .And. aNfCab[NF_OPERNF]=="S" .And. aNfItem[nZ][IT_LIVRO][LF_CRDPRES] > 0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aTes[TS_CRDPRES], aNfItem[nZ][IT_LIVRO][LF_CRDPRES],cSeq,cIFCOMP,cTpLanc})
				    //Estorno de Débito - Produtos Primários - ICMS recolhido antecipadamente
					ElseIf cUfLanc$("RO") .AND. aTes[TS_LANCFIS,nI,1]$"RO20000002" .And. aNfCab[NF_UFORIGEM]=="RO" .And. aNfCab[NF_OPERNF]=="S" .And. aTes[TS_SITTRIB]$"10/60" .And. aNfItem[nZ,IT_VALICM] >0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALICM],cSeq,cIFCOMP,cTpLanc})
					//ICMS devido pelo remetente relativo ao servico de transportadora de outra UF, RICM - art. 220, I
					ElseIf cUfLanc$("ES") .AND. aTes[TS_LANCFIS,nI,1]$"ES70001706" .And. aNfCab[NF_UFORIGEM]=="ES" .And. aNfCab[NF_OPERNF]=="S" .And. SubStr(aNfItem[nZ,IT_CF],1,1)$"6" .And. aNfItem[nZ,IT_AUTONOMO] > 0 
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICA], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALICA],cSeq,cIFCOMP,cTpLanc})
				   	//Débito de ICMS devido pela entrada de mercadorias sujeitas ao regime de substituição tributária
					ElseIf aTes[TS_LANCFIS,nI,1]$"SC41000002" .AND. aNFCab[NF_OPERNF] == "E" .AND. aTes[TS_ANTICMS] == "1" .AND. SubStr(aNfItem[nZ,IT_CF],1,1)$"2" .And. aNfItem[nZ,IT_VALANTI] > 0 
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALANTI],cSeq,cIFCOMP,cTpLanc})
	
					//"Outros débitos" do ICMS ST, tais os débitos do RICMS, Livro III, arts. 53-A e 53-C
					ElseIf aTes[TS_LANCFIS,nI,1]$"RS41009705" .AND. aNFCab[NF_OPERNF] == "E" .AND. aTes[TS_ANTICMS] == "1" .AND. SubStr(aNfItem[nZ,IT_CF],1,1)$"2/3" .And. aNfItem[nZ,IT_VALANTI] > 0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALANTI],cSeq,cIFCOMP,cTpLanc})				
					ElseIf aTes[TS_LANCFIS,nI,1]$"RS41009705" .AND. aNFCab[NF_OPERNF] == "E" .AND. aTes[TS_COMPL]=="S" .AND. SubStr(aNfItem[nZ,IT_CF],1,1)$"2/3" .And. aNfItem[nZ,IT_VALCMP] > 0
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM], aNfItem[nZ,IT_VALCMP],cSeq,cIFCOMP,cTpLanc})
		
					//Diferencial de alíquota FECP Rio de Janeiro
					ElseIf cUfLanc$("RJ") .AND. aTes[TS_LANCFIS,nI,1]$"RJ70000006" .AND. aNFCab[NF_OPERNF] == "E" .And. aNfItem[nZ][IT_VALFECP]>0 .AND. aNfItem[nZ,IT_VALCMP]>0  
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQFECP], aNfItem[nZ,IT_VALFECP],cSeq,cIFCOMP,cTpLanc})
	
					//Fecp na Importação para o Rio de Janeiro
					ElseIf cUfLanc$("RJ") .AND. aTes[TS_LANCFIS,nI,1]$"RJ70000005".AND. aNFCab[NF_OPERNF] == "E" .And. aNfItem[nZ][IT_VALFECP]>0 .AND. SubStr(aNfItem[nZ,IT_CF],1,1)$"3"   
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQFECP], aNfItem[nZ,IT_VALFECP],cSeq,cIFCOMP,cTpLanc})
	
					//Valor de ICMS na operação de importação para o Estado do Rio de Janeiro.
					ElseIf cUfLanc$("RJ") .AND. aTes[TS_LANCFIS,nI,1]$"RJ70000001".AND. aNFCab[NF_OPERNF] == "E" .And. aNfItem[nZ][IT_VALICM]>0 .AND. SubStr(aNfItem[nZ,IT_CF],1,1)$"3"   
						aAdd(aGrava, {cItem, aTes[TS_LANCFIS,nI,1], "1", aNfItem[nZ,IT_BASEICM], aNfItem[nZ,IT_ALIQICM]-aNfItem[nZ,IT_ALIQFECP], aNfItem[nZ,IT_VALICM]-aNfItem[nZ,IT_VALFECP],cSeq,cIFCOMP,cTpLanc})
	
					//Deducoes do FECOMP - MS
					ElseIf cUfLanc$("MS") .And. aTes[TS_LANCFIS,nI,1]$"MS60000011" .And. aNfItem[nZ][IT_VALICM]>0 .And. aNfItem[nZ][IT_VALFECP]>0
						aAdd(aGrava, { cItem , aTes[TS_LANCFIS,nI,1] , "1" , aNfItem[nZ,IT_BASEICM] , aNfItem[nZ,IT_ALIQFECP] , aNfItem[nZ,IT_VALFECP] , cSeq , cIFCOMP , cTpLanc } )
					
					Else
						lGerou	:= .F.
					EndIf
				Else
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³Tratamento para:														³
					//³		Estados sem a publicação de tabela de ajustes de ICMS ou;		³
					//³		Codigos de Ajuste de Apuracao com Reflexo relacionado ou;		³
					//³		Novo mecanismo de configuracao para Codigos de Ajuste de NF 	³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					If aAliIndic[AI_CE0]
						CE0->(dbSetOrder(1))
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³O campo CC7_CODREF podera ser utilizado em qualquer tipo de Codigo (Apuracao ou de NF). Portanto, sempre que	³
						//³este campo for preenchido (posicao 3 do array TS_LANCFIS) devera ser priorizado na consulta a tabela CE0.	³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						If !Empty( aTes[TS_LANCFIS,nI,3] )
							If CE0->( MsSeek( xFilial( "CE0" ) + aTes[TS_LANCFIS,nI,3] ) )
								lHasRefl	:=	.T.
							Endif
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³Quando nao utilizar o campo CC7_CODREF, para os codigos de Apuracao ainda existe a possibilidade do reflexo	³
						//³ter sido associado atraves do campo CDO_CODREF (que esta no proprio cadastro do Ajuste).						³												³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						Elseif cTpLanc == '1'
							If aFieldPos[FP_CDO_CODREF]
								CDO->(dbSetOrder(1))
								If CDO->( MsSeek( xFilial( "CDO" ) + aTes[TS_LANCFIS,nI,1] ) )
									If CE0->( MsSeek( xFilial( "CE0" ) + CDO->CDO_CODREF ) )
										lHasRefl	:=	.T.
									Endif
								Endif
							Endif
						Endif
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³Se encontrar relacionamento com a tabela de Reflexo (CE0) nas validacoes acima, atribuo as variaveis abaixo	³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						If lHasRefl
							cBase		:= CE0->CE0_NFBASE
							cAliq		:= CE0->CE0_NFALIQ
							nAliqVal	:= CE0->CE0_NFALVA
							cValor		:= CE0->CE0_NFVALO
						EndIf
					Endif
						
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³Case para definir o valor da Base de Calculo do ajuste	³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					Do Case
						Case cBase == '1'	; nBase	:=	aNfItem[ nZ , IT_BASEICM ]
						Case cBase == '2'	; nBase	:=	aNfItem[ nZ , IT_LIVRO , LF_VALCONT ]
						Case cBase == '3'	; nBase	:=	aNfItem[ nZ , IT_VALICM ]
						Case cBase == '4'	; nBase	:=	aNfItem[ nZ , IT_BASESOL ]
						Case cBase == '5'	; nBase	:=	aNfItem[ nZ , IT_BASEICA ]
						Case cBase == 'Z'	; nBase	:=	0
					EndCase
					
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³Case para definir o valor do ajuste						³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					Do Case
						Case cValor == '1'	; nValor	:= aNfItem[ nZ , IT_VALICM ]
						Case cValor == '2'	; nValor	:= aNfItem[ nZ , IT_VALCMP ]
						Case cValor == '3'	; nValor	:= aNfItem[ nZ , IT_VALMERC ]
						Case cValor == '4'	; nValor	:= aNfItem[ nZ , IT_VALANTI ]
						Case cValor == '5'	; nValor	:= aNfItem[ nZ , IT_LIVRO , LF_CRDPRES ]
						Case cValor == '6'	; nValor	:= aNfItem[ nZ , IT_VALSOL ]
						Case cValor == '7'	; nValor	:= aNfItem[ nZ , IT_ESTCRED ]
						Case cValor == '8'	; nValor	:= aNfItem[ nZ , IT_ICMSDIF ]
						Case cValor == 'A'	; nValor	:= aNfItem[ nZ , IT_VALFECP ]
						Case cValor == 'B'	; nValor	:= aNfItem[ nZ , IT_VFECPST ]
						Case cValor == 'C'	; nValor	:= aNfItem[ nZ , IT_VALICA ]
						Case cValor == '9'	; nValor	:= nBase * nAliqVal / 100
					EndCase
					
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³Case para definir o valor da Aliquota do ajuste			³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					Do Case
						Case cAliq == '1'	; nAliq	:=	aNfItem[ nZ , IT_ALIQICM ]
						Case cAliq == '2'	; nAliq	:=	aTes[ TS_CRDPRES ]
						Case cAliq == '3'	; nAliq	:=	aNfItem[ nZ , IT_ALIQSOL ]
						Case cAliq == '4'	; nAliq	:=	aTes[ TS_ESTCRED ]
						Case cAliq == '5'	; nAliq	:=	aNfItem[ nZ , IT_ALIQCMP ]
						Case cAliq == '6'	; nAliq	:=	nAliqVal
						Case cAliq == '7'	; nAliq	:=	Iif( aNfItem[ nZ , IT_ALFCCMP ] > 0 , aNfItem[ nZ , IT_ALFCCMP ] , aNfItem[ nZ , IT_ALIQFECP ] )
						Case cAliq == '8'	; nAliq	:=	aNfItem[ nZ , IT_ALFCST ]
						Case cAliq == 'Z'	; nAliq :=	0
					EndCase
					
					If nValor > 0
						aAdd(	aGrava,	{	aNfItem[nZ,IT_ITEM]		,;		  //1 - Item
											aTes[TS_LANCFIS,nI,1]	,;		  //2 - Codigo de Lancamento
											"1"						,;		  //3 - Sistema
											nBase					,;		  //4 - Base de Calculo
											nAliq					,;		  //5 - Aliquota
											nValor					,;		  //6 - Valor Calculado
											cSeq					,;		  //7 - Sequencia
											cIFCOMP					,;		  //8 - Informacoes Complementares
											cTpLanc					})		  //9 - Tipo de Utilidade do Lancamento
						lGerou	:=	.T.
					EndIf
					
				EndIf
			EndIf
		Next nI
	Next nZ
EndIf
RestArea(aArea)

Return aGrava

/*_________________________________FUNCOES PARA CALCULO DE IMPOSTOS - LOCALIZADOS E IMPOSTOS VARIAVEIS (BRASIL)___________________________________*/

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisBSIV³ Autor ³ Edson Maricate         ³ Data ³02.02.2000³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Executa o calculo da Base dos Impostos Variaveis            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1: Numero do Imposto ( 1 a X )                          ³±±
±±³          ³ExpN2: Item a ser calculado                                 ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisBSIV(nImposto,nItem)

Local nBaseRet
Local nImp     := Len(aTes[TS_SFC])
Local nImpde   := IIF(nImposto==Nil,1,nImposto)
Local nImpAte  := IIF(nImposto==Nil,nImp,nImposto)

Private aInfo   //Definida como private pois é usada numa macro    := {}
// Verifica se a TES possui tratamento para Impostos Variaveis
If !Empty(aTes[TS_SFC])
	If nImpde>0 .And. nImpAte>0
		For nImposto := nImpDe to nImpAte
			// Executa o calculo atraves da Funcao cadastrada no SFB
			aInfo := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],RIGHT(Alltrim(aTes[TS_SFC][nImposto][SFB_CPOVREI]),1)}
			nImp:=NumCpoImpVar(aInfo[2])
			If aNfCab[NF_OPERNF] == "E"
				If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
					If cPaisLoc <> "BRA"
						nBaseRet := &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("B",'+Str(nItem)+',aInfo)')
						If ValType(nBaseRet) == "N"
							aNfItem[nItem][IT_BASEIMP][nImp]:= nBaseRet
						EndIf
					Else
						aNfItem[nItem][IT_BASEIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMENT],.F.,.F.,{"B",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
					EndIf
					aNfItem[nItem][IT_DESCIV][nImp] := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],aTes[TS_SFC][nImposto][SFB_DESCR],aTes[TS_SFC][nImposto][SFC_CALCULO]}
				EndIf
			Else
				If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
					If cPaisLoc <> "BRA"
						nBaseRet :=  &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("B",'+Str(nItem)+',aInfo)')
						If ValType(nBaseRet) == "N"
							aNfItem[nItem][IT_BASEIMP][nImp]:= nBaseRet
						EndIf
					Else
						aNfItem[nItem][IT_BASEIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMSAI],.F.,.F.,{"B",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
					EndIf
					aNfItem[nItem][IT_DESCIV][nImp] := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],aTes[TS_SFC][nImposto][SFB_DESCR],aTes[TS_SFC][nImposto][SFC_CALCULO]}
				EndIf
			EndIf
		Next nImposto
	Endif
Else
	// Zera todas as aliquotas.
	For nImposto := 1 to NMAXIV
		aNFItem[nItem][IT_BASEIMP][nImposto]:= 0
		aNfItem[nItem][IT_DESCIV][nImposto] := {"","",""}
	Next nImposto
EndIf

Return Nil

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisAliqIV³ Autor ³ Edson Maricate       ³ Data ³02.02.2000³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Executa o calculo da Aliquota dos Impostos Variaveis        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1: Numero do Imposto ( 1 a 6 )                          ³±±
±±³          ³ExpN2: Item a ser calculado                                 ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function MaFisAliqIV(nImposto,nItem)

Local nAliqImp
Local nImp	  :=Len(aTes[TS_SFC])
Local nImpde  :=IIF(nImposto==Nil,1,nImposto)
Local nImpAte :=IIF(nImposto==Nil,nImp,nImposto)
Local nMv_ALQIPM	:= aParSX6[MV_ALQIPM]
Local cMV_AGENTE    := aParSX6[MV_AGENTE]
Local alAreaX
Local alAreaY
Local alAreaZ
Local nlTotal := 0
Local nlCont  := 0
Local nlMinDIG := aParSX6[MV_MINDETR]
Private aInfo 									  //Definida como private pois é usada numa macro
// Verifica se a TES possui tratamento para Impostos Variaveis
If cPaisLoc=="PER"  .And. aFieldPos[FP_B1_VMINDET]
	nlMinDIG := Iif( aNfItem[nItem][IT_PRD][SB_VMINDET] > 0 , aNfItem[nItem][IT_PRD][SB_VMINDET] , nlMinDIG )
EndIf

If !Empty(aTes[TS_SFC])
	If nImpde>0 .And. nImpAte>0
		For nImposto := nImpDe to nImpAte
			//       Tratamento especifico para localizado PERU
			// Abaixo estão as aliquotas dos impostos variáveis de acordo
			// com as regras de ISC, IGV, PIV e DIG. Caso não seja nenhum
			// desses executa normalmente como se fosse não localizado
			
			//Caso nao seja localizado Peru, executa o padrão
			If cPaisLoc $ "PER"
				alAreaX := SFC->(GetArea())
				alAreaY := SF4->(GetArea())
				alAreaZ := GetArea()
				
				If aTes[TS_SFC][nImposto][SFC_IMPOSTO] $ "IGV"
					DbSelectArea("SF4")
					DbSetOrder(1)
					If MsSeek(xFilial("SF4")+aTes[TS_CODIGO])
						If (SF4->F4_CALCIGV <> "2" .And. SF4->F4_CALCIGV <> "3")
							
							// Executa o calculo atraves da Funcao cadastrada no SFB
							aInfo := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],RIGHT(Alltrim(aTes[TS_SFC][nImposto][SFB_CPOVREI]),1)}
							nImp:=NumCpoImpVar(aInfo[2])
							If aNfCab[NF_OPERNF] == "E"
								If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
									If cPaisLoc <> "BRA"
										nAliqImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("A",'+Str(nItem)+',aInfo)')
										If ValType(nAliqImp) == "N"
											aNfItem[nItem][IT_ALIQIMP][nImp]:= nAliqImp
											
											//          TRATAMENTO EXPECIFICO PARA LOCALIZADO PERU
											// Quando o TES for referente ao imposto do IGV, o valor do IPM, o
											// qual é uma porcentagem do IGV,o valor da base, aliquota e valor do
											// imposto é gravado nos campos _BASIMP3, _ALQIMP3 e VALIMP3.
											// O valor da base é a mesma utilizada para o cálculo do IGV.
											// O valor da alíqutoa é proveniente de um paramêtro chamado
											// MV_ALQIPM.
											// O valor do imposto é a multiplicação da base pelo valor da aliquota
											// NO CASO ABAIXO APENAS A ALIQUOTA DO IMPOSTO é PREENCHIDA PARA ENTRA-
											// DA.
											
											aNfItem[nItem][IT_ALIQIMP][3]:= nMv_ALQIPM
										EndIf
									Else
										aNfItem[nItem][IT_ALIQIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMENT],.F.,.F.,{"A",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
									EndIf
								EndIf
							Else
								If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
									If cPaisLoc <>"BRA"
										
										nAliqImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("A",'+Str(nItem)+',aInfo)')
										
										If ValType(nAliqImp) == "N"
											aNfItem[nItem][IT_ALIQIMP][nImp]:= nAliqImp
											
											//          TRATAMENTO EXPECIFICO PARA LOCALIZADO PERU
											// NO CASO ABAIXO APENAS A ALIQUOTA DO IMPOSTO é PREENCHIDA PARA SAIDA.
											
											aNfItem[nItem][IT_ALIQIMP][3]:= nMv_ALQIPM
											
										EndIf
									Else
										aNfItem[nItem][IT_ALIQIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMSAI],.F.,.F.,{"A",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
									EndIf
								EndIf
							EndIf
						EndIf
					EndIf
				ElseIf aTes[TS_SFC][nImposto][SFC_IMPOSTO] $ "PIV"
					
					// Executa o calculo atraves da Funcao cadastrada no SFB
					aInfo := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],RIGHT(Alltrim(aTes[TS_SFC][nImposto][SFB_CPOVREI]),1)}
					nImp:=NumCpoImpVar(aInfo[2])
					If aNfCab[NF_OPERNF] == "E"
						
						
						If aNfCab[NF_CLIFOR] $ "F"
							
							If SubStr(cMV_AGENTE,2,1) == "S" .And.  SA2->A2_AGENRET <> "1"
								
								
								If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
									If cPaisLoc <> "BRA"
										
										nAliqImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("A",'+Str(nItem)+',aInfo)')
										
										If ValType(nAliqImp) == "N"
											aNfItem[nItem][IT_ALIQIMP][nImp]:= nAliqImp
										EndIf
									Else
										aNfItem[nItem][IT_ALIQIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMENT],.F.,.F.,{"A",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
									EndIf
								EndIf
								
							EndIf
							
						ElseIf aNfCab[NF_CLIFOR] $ "C"
							
							If SA1->A1_AGENTE == "2"
								
								If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
									If cPaisLoc <> "BRA"
										
										nAliqImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("A",'+Str(nItem)+',aInfo)')
										
										If ValType(nAliqImp) == "N"
											aNfItem[nItem][IT_ALIQIMP][nImp]:= nAliqImp
										EndIf
									Else
										aNfItem[nItem][IT_ALIQIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMENT],.F.,.F.,{"A",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
									EndIf
								EndIf
								
							EndIf
							
						EndIf
						
					Else
						
						If aNfCab[NF_CLIFOR] $ "C"
							
							If SA1->A1_AGENTE == "2"
								
								If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
									If cPaisLoc <>"BRA"
										
										nAliqImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("A",'+Str(nItem)+',aInfo)')
										
										If ValType(nAliqImp) == "N"
											aNfItem[nItem][IT_ALIQIMP][nImp]:= nAliqImp
											
										EndIf
									Else
										aNfItem[nItem][IT_ALIQIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMSAI],.F.,.F.,{"A",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
									EndIf
								EndIf
								
							EndIf
							
						ElseIf aNfCab[NF_CLIFOR] $ "F"
							
							If SubStr(cMV_AGENTE,2,1) == "S" .And.  SA2->A2_AGENRET <> "1"
								
								If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
									If cPaisLoc <>"BRA"
										
										nAliqImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("A",'+Str(nItem)+',aInfo)')
										
										If ValType(nAliqImp) == "N"
											aNfItem[nItem][IT_ALIQIMP][nImp]:= nAliqImp
											
										EndIf
									Else
										aNfItem[nItem][IT_ALIQIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMSAI],.F.,.F.,{"A",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
									EndIf
								EndIf
								
							EndIf
							
						EndIf
						
					EndIf
					
				ElseIf aTes[TS_SFC][nImposto][SFC_IMPOSTO] $ "DIG"
					
					nlTotal := MaRetBasT(,,,.T.)
					
					nlTOtal += aNfCab[NF_FRETE] + aNfCab[NF_DESPESA] + aNfCab[NF_SEGURO] - (aNfCab[NF_DESCONTO]+aNfCab[NF_DESCTOT]) + aNfCab[NF_ACRESCI]
					
					If AllTrim(Upper(FunName())) $ "MATA465N/MATA466N/MATA467N/MATA101N/MATA121" .And. aNFCab[NF_TXMOEDA] <> 0
						
						nlTotal := nlTotal * aNFCab[NF_TXMOEDA]
						
					ElseIf AllTrim(Upper(FunName())) $ "MATA410"
						
						nlTotal := xMoeda(nlTotal,M->C5_MOEDA,1,dDataBase)
						
					EndIf
					If nlTotal > nlMinDIG
						
						//³ Executa o calculo atraves da Funcao cadastrada no SFB        ³
						MaFisTes(aNfItem[nItem][IT_TES],aNfItem[nItem][IT_RECNOSF4],nItem)
						aInfo := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],RIGHT(Alltrim(aTes[TS_SFC][nImposto][SFB_CPOVREI]),1)}
						nImp:=NumCpoImpVar(aInfo[2])
						If aNfCab[NF_OPERNF] == "E"
							
							If aNfCab[NF_CLIFOR] $ "F"
								
								If SubStr(cMV_AGENTE,3,1) == "S" .And.  SA2->A2_AGENRET <> "1"
									
									If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
										If cPaisLoc <> "BRA"
											
											nAliqImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("A",'+Str(nItem)+',aInfo)')
											
											If ValType(nAliqImp) == "N"
												aNfItem[nItem][IT_ALIQIMP][nImp]:= nAliqImp
											EndIf
										Else
											aNfItem[nItem][IT_ALIQIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMENT],.F.,.F.,{"A",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
										EndIf
									EndIf
									
								EndIf
								
							ElseIf aNfCab[NF_CLIFOR] $ "C"
								
								If SubStr(cMV_AGENTE,1,1) == "N" .And.  SA1->A1_AGENTE == "3"
									
									If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
										If cPaisLoc <> "BRA"
											
											nAliqImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("A",'+Str(nItem)+',aInfo)')
											
											If ValType(nAliqImp) == "N"
												aNfItem[nItem][IT_ALIQIMP][nImp]:= nAliqImp
											EndIf
										Else
											aNfItem[nItem][IT_ALIQIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMENT],.F.,.F.,{"A",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
										EndIf
									EndIf
									
								EndIf
								
							EndIf
							
						Else
							
							If aNfCab[NF_CLIFOR] $ "C"
								
								If SubStr(cMV_AGENTE,1,1) == "N" .And.  SA1->A1_AGENTE == "3"
									
									If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
										If cPaisLoc <>"BRA"
											
											nAliqImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("A",'+Str(nItem)+',aInfo)')
											
											If ValType(nAliqImp) == "N"
												aNfItem[nItem][IT_ALIQIMP][nImp]:= nAliqImp
												
											EndIf
										Else
											aNfItem[nItem][IT_ALIQIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMSAI],.F.,.F.,{"A",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
										EndIf
									EndIf
									
								EndIf
								
							ElseIf aNfCab[NF_CLIFOR] $ "F"
								
								If SubStr(cMV_AGENTE,3,1) == "S" .And.  SA2->A2_AGENRET <> "1"
									
									If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
										If cPaisLoc <>"BRA"
											
											nAliqImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("A",'+Str(nItem)+',aInfo)')
											
											If ValType(nAliqImp) == "N"
												aNfItem[nItem][IT_ALIQIMP][nImp]:= nAliqImp
												
											EndIf
										Else
											aNfItem[nItem][IT_ALIQIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMSAI],.F.,.F.,{"A",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
										EndIf
									EndIf
									
								EndIf
								
							EndIf
							
						EndIf
					EndIf
				Else
					// Executa o calculo atraves da Funcao cadastrada no SFB
					aInfo := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],RIGHT(Alltrim(aTes[TS_SFC][nImposto][SFB_CPOVREI]),1)}
					nImp:=NumCpoImpVar(aInfo[2])
					If aNfCab[NF_OPERNF] == "E"
						If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
							If cPaisLoc <> "BRA"
								
								nAliqImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("A",'+Str(nItem)+',aInfo)')
								If ValType(nAliqImp) == "N"
									aNfItem[nItem][IT_ALIQIMP][nImp]:= nAliqImp
								EndIf
							Else
								aNfItem[nItem][IT_ALIQIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMENT],.F.,.F.,{"A",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
							EndIf
						EndIf
					Else
						If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
							If cPaisLoc <>"BRA"
								nAliqImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("A",'+Str(nItem)+',aInfo)')
								If ValType(nAliqImp) == "N"
									aNfItem[nItem][IT_ALIQIMP][nImp]:= nAliqImp
								EndIf
							Else
								aNfItem[nItem][IT_ALIQIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMSAI],.F.,.F.,{"A",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
							EndIf
						EndIf
					EndIf
				EndIf
				RestArea(alAreaX)
				RestArea(alAreaY)
				RestArea(alAreaZ)
			Else
				// Executa o calculo atraves da Funcao cadastrada no SFB
				aInfo := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],RIGHT(Alltrim(aTes[TS_SFC][nImposto][SFB_CPOVREI]),1)}
				nImp:=NumCpoImpVar(aInfo[2])
				If aNfCab[NF_OPERNF] == "E"
					If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
						If cPaisLoc <> "BRA"
							
							nAliqImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("A",'+Str(nItem)+',aInfo)')
							
							If ValType(nAliqImp) == "N"
								aNfItem[nItem][IT_ALIQIMP][nImp]:= nAliqImp
							EndIf
						Else
							aNfItem[nItem][IT_ALIQIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMENT],.F.,.F.,{"A",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
						EndIf
					EndIf
				Else
					If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
						If cPaisLoc <>"BRA"
							
							nAliqImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("A",'+Str(nItem)+',aInfo)')
							
							If ValType(nAliqImp) == "N"
								aNfItem[nItem][IT_ALIQIMP][nImp]:= nAliqImp
								
							EndIf
						Else
							aNfItem[nItem][IT_ALIQIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMSAI],.F.,.F.,{"A",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
						EndIf
					EndIf
				EndIf
			EndIf
		Next nImposto
	Endif
Else
	// Zera todas as aliquotas.
	For nImposto := 1 to NMAXIV
		aNFItem[nItem][IT_ALIQIMP][nImposto]:= 0
	Next nImposto
EndIf
Return Nil

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisVLIV³ Autor ³ Edson Maricate         ³ Data ³02.02.2000³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Executa o calculo do Valor dos Impostos Variaveis           ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1: Numero do Imposto ( 1 a X )                          ³±±
±±³          ³ExpN2: Item a ser calculado                                 ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisVLIV(nImposto,nItem)

Local nValImp  := 0
Local nImp		:=Len(aTes[TS_SFC])
Local nImpde 	:=IIF(nImposto==Nil,1,nImposto)
Local nImpAte	:=IIF(nImposto==Nil,nImp,nImposto)
Local cMV_AGENTE  	:= aParSX6[MV_AGENTE]
Local alAreaX
Local alAreaY
Local alAreaZ
Local nlCont := 0
Local nlTotal := 0
Local nlMinDIG 		:= aParSX6[MV_MINDETR]
Local nlTxMoeda := 0
Private aInfo   									//Definida como private pois é usada numa macro
// Verifica se a TES possui tratamento para Impostos Variaveis
If cPaisLoc=="PER"  .And. aFieldPos[FP_B1_VMINDET]
	nlMinDIG := Iif(aNfItem[nItem][IT_PRD][SB_VMINDET] > 0 , aNfItem[nItem][IT_PRD][SB_VMINDET] , nlMinDIG)
EndIf

If !Empty(aTes[TS_SFC])
	If nImpde>0 .And. nImpAte>0
		For nImposto := nImpDe to nImpAte
			//       Tratamento especifico para localizado PERU
			// Abaixo estão os cálculos dos impostos variáveis de acordo
			// com as regras de ISC,IGV, PIV e DIG. Caso não seja nenhum
			// desses executa normalmente como se fosse não localizado
			
			//Caso seja não seja localizado Peru, executa padrão
			If cPaisLoc $ "PER"
				alAreaX := SFC->(GetArea())
				alAreaY := SF4->(GetArea())
				alAreaZ := GetArea()
				
				If aTes[TS_SFC][nImposto][SFC_IMPOSTO] $ "IGV"
					DbSelectArea("SF4")
					DbSetOrder(1)
					If MsSeek(xFilial("SF4")+aTes[TS_CODIGO])
						If (SF4->F4_CALCIGV <> "2" .And. SF4->F4_CALCIGV <> "3")
							
							// Executa o calculo atraves da Funcao cadastrada no SFB
							aInfo := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],RIGHT(Alltrim(aTes[TS_SFC][nImposto][SFB_CPOVREI]),1)}
							nImp:=NumCpoImpVar(aInfo[2])
							If aNfCab[NF_OPERNF] == "E"
								If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
									If cPaisLoc <> "BRA"
										nValImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("V",'+Str(nItem)+',aInfo)')
										If ValType(nValImp) == "N"
											aNfItem[nItem][IT_VALIMP][nImp]:= nValImp
											//          TRATAMENTO EXPECIFICO PARA LOCALIZADO PERU
											// Quando o TES for referente ao imposto do IGV, o valor do IPM, o
											// qual é uma porcentagem do IGV,o valor da base, aliquota e valor do
											// imposto é gravado nos campos _BASIMP3, _ALQIMP3 e VALIMP3.
											// O valor da base é a mesma utilizada para o cálculo do IGV.
											// O valor da alíqutoa é proveniente de um paramêtro chamado
											// MV_ALQIPM.
											// O valor do imposto é a multiplicação da base pelo valor da aliquota
											// NO CASO ABAIXO APENAS O VALOR DO IMPOSTO é PREENCHIDO PARA ENTRADA,
											// SENDO QUE OS VALORRES DA BASE E DA ALIQUOTA Já FORAM PREENCHIDOS AN-
											// TERIORMENTE.
											
											aNfItem[nItem][IT_VALIMP][3]:= aNfItem[nItem][IT_BASEIMP][3] * (aNfItem[nItem][IT_ALIQIMP][3]/100)
										EndIf
									Else
										aNfItem[nItem][IT_VALIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMENT],.F.,.F.,{"V",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
									EndIf
								EndIf
							Else
								If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
									If cPaisLoc <>"BRA"
										nValImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("V",'+Str(nItem)+',aInfo)')
										If ValType(nValImp) == "N"
											aNfItem[nItem][IT_VALIMP][nImp]:= nValImp
											//          TRATAMENTO EXPECIFICO PARA LOCALIZADO PERU
											// NO CASO ABAIXO APENAS O VALOR DO IMPOSTO é PREENCHIDO PARA SáIDA,
											// SENDO QUE OS VALORRES DA BASE E DA ALIQUOTA Já FORAM PREENCHIDOS AN-
											// TERIORMENTE.
											
											aNfItem[nItem][IT_VALIMP][3]:= aNfItem[nItem][IT_BASEIMP][3] * (aNfItem[nItem][IT_ALIQIMP][3]/100)
										EndIf
									Else
										aNfItem[nItem][IT_VALIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMSAI],.F.,.F.,{"V",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
									EndIf
								EndIf
							EndIf
							// Verifica as Propriedades do Imposto
							Do Case
								Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="1"
									nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
								Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="2"
									nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
								Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="3"
									nValImp:=0
							EndCase
							aNfItem[nItem][IT_BASEDUP] += nValImp
							Do Case
								Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="1"
									nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
								Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="2"
									nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
								Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="3"
									nValImp:=0
							EndCase
							aNfItem[nItem][IT_TOTAL] += nValImp
						EndIf
					EndIf
					
				ElseIf aTes[TS_SFC][nImposto][SFC_IMPOSTO] $ "PIV"
					
					// Executa o calculo atraves da Funcao cadastrada no SFB
					aInfo := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],RIGHT(Alltrim(aTes[TS_SFC][nImposto][SFB_CPOVREI]),1)}
					nImp:=NumCpoImpVar(aInfo[2])
					If aNfCab[NF_OPERNF] == "E"
						
						If aNfCab[NF_CLIFOR] $ "F"
							
							If SubStr(cMV_AGENTE,2,1) == "S" .And.  SA2->A2_AGENRET <> "1"
								
								If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
									If cPaisLoc <> "BRA"
										
										nValImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("V",'+Str(nItem)+',aInfo)')
										
										If ValType(nValImp) == "N"
											aNfItem[nItem][IT_VALIMP][nImp]:= nValImp
										EndIf
									Else
										aNfItem[nItem][IT_VALIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMENT],.F.,.F.,{"V",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
									EndIf
								EndIf
								
							EndIf
							
						ElseIf aNfCab[NF_CLIFOR] $ "C"
							
							If SA1->A1_AGENTE == "2"
								
								If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
									If cPaisLoc <> "BRA"
										
										nValImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("V",'+Str(nItem)+',aInfo)')
										
										If ValType(nValImp) == "N"
											aNfItem[nItem][IT_VALIMP][nImp]:= nValImp
										EndIf
									Else
										aNfItem[nItem][IT_VALIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMENT],.F.,.F.,{"V",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
									EndIf
								EndIf
								
							EndIf
							
						EndIf
						
					Else
						
						If aNfCab[NF_CLIFOR] $ "C"
							
							If SA1->A1_AGENTE == "2"
								
								If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
									If cPaisLoc <>"BRA"
										
										nValImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("V",'+Str(nItem)+',aInfo)')
										
										If ValType(nValImp) == "N"
											aNfItem[nItem][IT_VALIMP][nImp]:= nValImp
										EndIf
									Else
										aNfItem[nItem][IT_VALIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMSAI],.F.,.F.,{"V",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
									EndIf
									
								EndIf
								
							EndIf
							
						ElseIf aNfCab[NF_CLIFOR] $ "F"
							
							If SubStr(cMV_AGENTE,2,1) == "S" .And.  SA2->A2_AGENRET <> "1"
								
								If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
									If cPaisLoc <>"BRA"
										
										nValImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("V",'+Str(nItem)+',aInfo)')
										
										If ValType(nValImp) == "N"
											aNfItem[nItem][IT_VALIMP][nImp]:= nValImp
										EndIf
									Else
										aNfItem[nItem][IT_VALIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMSAI],.F.,.F.,{"V",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
									EndIf
									
								EndIf
								
							EndIf
							
						EndIf
						
					EndIf
					//³ Verifica as Propriedades do Imposto                          ³
					Do Case
						Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="1"
							nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
						Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="2"
							nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
						Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="3"
							nValImp:=0
					EndCase
					aNfItem[nItem][IT_BASEDUP] += nValImp
					Do Case
						Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="1"
							nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
						Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="2"
							nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
						Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="3"
							nValImp:=0
					EndCase
					aNfItem[nItem][IT_TOTAL] += nValImp
					
				ElseIf aTes[TS_SFC][nImposto][SFC_IMPOSTO] $ "DIG"
					
					nlTotal := MaRetBasT(,,,.T.)
					
					nlTOtal += aNfCab[NF_FRETE] + aNfCab[NF_DESPESA] + aNfCab[NF_SEGURO] - (aNfCab[NF_DESCONTO]+aNfCab[NF_DESCTOT]) + aNfCab[NF_ACRESCI]
					
					If AllTrim(Upper(FunName())) $ "MATA465N/MATA466N/MATA467N/MATA101N/MATA121" .And. aNFCab[NF_TXMOEDA] <> 0
						
						nlTotal := nlTotal * aNFCab[NF_TXMOEDA]
						
					ElseIf AllTrim(Upper(FunName())) $ "MATA410"
						
						nlTotal := xMoeda(nlTotal,M->C5_MOEDA,1,dDataBase)
						
					EndIf
					If nlTotal > nlMinDIG
						// Executa o calculo atraves da Funcao cadastrada no SFB
						MaFisTes(aNfItem[nItem][IT_TES],aNfItem[nItem][IT_RECNOSF4],nItem)
						aInfo := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],RIGHT(Alltrim(aTes[TS_SFC][nImposto][SFB_CPOVREI]),1)}
						nImp:=NumCpoImpVar(aInfo[2])
						If aNfCab[NF_OPERNF] == "E"
							
							If aNfCab[NF_CLIFOR] $ "F"
								
								If SubStr(cMV_AGENTE,3,1) == "S" .And.  SA2->A2_AGENRET <> "1"
									
									If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
										
										If cPaisLoc <> "BRA"
											
											nValImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("V",'+Str(nItem)+',aInfo)')
											
											If ValType(nValImp) == "N"
												aNfItem[nItem][IT_VALIMP][nImp]:= nValImp
											EndIf
										Else
											aNfItem[nItem][IT_VALIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMENT],.F.,.F.,{"V",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
										EndIf
										
									EndIf
									
								EndIf
								
							ElseIf aNfCab[NF_CLIFOR] $ "C"
								
								If SubStr(cMV_AGENTE,1,1) == "N" .And.  SA1->A1_AGENTE == "3"
									
									If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
										
										If cPaisLoc <> "BRA"
											
											nValImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("V",'+Str(nItem)+',aInfo)')
											
											If ValType(nValImp) == "N"
												aNfItem[nItem][IT_VALIMP][nImp]:= nValImp
											EndIf
										Else
											aNfItem[nItem][IT_VALIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMENT],.F.,.F.,{"V",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
										EndIf
										
									EndIf
									
								EndIf
								
							EndIf
							
						Else
							
							If aNfCab[NF_CLIFOR] $ "C"
								
								If SubStr(cMV_AGENTE,1,1) == "N" .And.  SA1->A1_AGENTE == "3"
									
									If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
										If cPaisLoc <>"BRA"
											
											nValImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("V",'+Str(nItem)+',aInfo)')
											
											If ValType(nValImp) == "N"
												aNfItem[nItem][IT_VALIMP][nImp]:= nValImp
											EndIf
										Else
											aNfItem[nItem][IT_VALIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMSAI],.F.,.F.,{"V",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
										EndIf
									EndIf
									
								EndIf
								
							ElseIf aNfCab[NF_CLIFOR] $ "F"
								
								If SubStr(cMV_AGENTE,3,1) == "S" .And.  SA2->A2_AGENRET <> "1"
									
									If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
										If cPaisLoc <>"BRA"
											
											nValImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("V",'+Str(nItem)+',aInfo)')
											
											If ValType(nValImp) == "N"
												aNfItem[nItem][IT_VALIMP][nImp]:= nValImp
											EndIf
										Else
											aNfItem[nItem][IT_VALIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMSAI],.F.,.F.,{"V",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
										EndIf
									EndIf
									
								EndIf
								
							EndIf
							
							
						EndIf
						//³ Verifica as Propriedades do Imposto                          ³
						Do Case
							Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="1"
								nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
							Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="2"
								nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
							Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="3"
								nValImp:=0
						EndCase
						aNfItem[nItem][IT_BASEDUP] += nValImp
						Do Case
							Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="1"
								nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
							Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="2"
								nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
							Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="3"
								nValImp:=0
						EndCase
						aNfItem[nItem][IT_TOTAL] += nValImp
					EndIf
				Else
					
					// Executa o calculo atraves da Funcao cadastrada no SFB
					aInfo := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],RIGHT(Alltrim(aTes[TS_SFC][nImposto][SFB_CPOVREI]),1)}
					nImp:=NumCpoImpVar(aInfo[2])
					If aNfCab[NF_OPERNF] == "E"
						If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
							If cPaisLoc <> "BRA"
								
								nValImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("V",'+Str(nItem)+',aInfo)')
								
								If ValType(nValImp) == "N"
									aNfItem[nItem][IT_VALIMP][nImp]:= nValImp
								EndIf
							Else
								aNfItem[nItem][IT_VALIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMENT],.F.,.F.,{"V",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
							EndIf
						EndIf
					Else
						If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
							If cPaisLoc <>"BRA"
								
								nValImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("V",'+Str(nItem)+',aInfo)')
								
								If ValType(nValImp) == "N"
									aNfItem[nItem][IT_VALIMP][nImp]:= nValImp
								EndIf
							Else
								aNfItem[nItem][IT_VALIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMSAI],.F.,.F.,{"V",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
							EndIf
						EndIf
					EndIf
					// Verifica as Propriedades do Imposto
					Do Case
						Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="1"
							nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
						Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="2"
							nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
						Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="3"
							nValImp:=0
					EndCase
					aNfItem[nItem][IT_BASEDUP] += nValImp
					Do Case
						Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="1"
							nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
						Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="2"
							nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
						Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="3"
							nValImp:=0
					EndCase
					aNfItem[nItem][IT_TOTAL] += nValImp
					
				EndIf
				
				RestArea(alAreaX)
				RestArea(alAreaY)
				RestArea(alAreaZ)
			Else
				
				// Executa o calculo atraves da Funcao cadastrada no SFB
				aInfo := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],RIGHT(Alltrim(aTes[TS_SFC][nImposto][SFB_CPOVREI]),1)}
				nImp:=NumCpoImpVar(aInfo[2])
				If aNfCab[NF_OPERNF] == "E"
					If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
						If cPaisLoc <> "BRA"
							
							nValImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("V",'+Str(nItem)+',aInfo)')
							
							If ValType(nValImp) == "N"
								aNfItem[nItem][IT_VALIMP][nImp]:= nValImp
							EndIf
						Else
							aNfItem[nItem][IT_VALIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMENT],.F.,.F.,{"V",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
						EndIf
					EndIf
				Else
					If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
						If cPaisLoc <>"BRA"
							
							nValImp :=  &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("V",'+Str(nItem)+',aInfo)')
							
							If ValType(nValImp) == "N"
								aNfItem[nItem][IT_VALIMP][nImp]:= nValImp
							EndIf
						Else
							aNfItem[nItem][IT_VALIMP][nImp]:= ExecBlock(aTes[TS_SFC][nImposto][SFB_FORMSAI],.F.,.F.,{"V",nItem,aInfo},(Left(aTes[TS_SFC][nImposto][SFB_FORMENT],2)=="U_"))
						EndIf
					EndIf
				EndIf
				// Verifica as Propriedades do Imposto
				Do Case
					Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="1"
						nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
					Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="2"
						nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
					Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="3"
						nValImp:=0
				EndCase
				aNfItem[nItem][IT_BASEDUP] += nValImp
				Do Case
					Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="1"
						nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
					Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="2"
						nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
					Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="3"
						nValImp:=0
				EndCase
				aNfItem[nItem][IT_TOTAL] += nValImp
				
			EndIf
		Next nImposto
	Endif
Else
	// Zera todas as aliquotas.
	For nImposto := 1 to NMAXIV
		aNFItem[nItem][IT_VALIMP][nImposto]:= 0
	Next nImposto
EndIf

Return Nil

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisNameIV³ Autor ³ Edson Maricate       ³ Data ³02.02.2000³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Preeche o nome dos impostos Variaveis                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1: Numero do Imposto ( 1 a 6 )                          ³±±
±±³          ³ExpN2: Item a ser calculado                                 ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisNameIV(nImposto,nItem)

Local nImpde  := IIf(nImposto==Nil,1,nImposto)
Local nImpAte := IIF(nImposto==Nil,Len(aTes[TS_SFC]),nImposto)

// Verifica se a TES possui tratamento para Impostos Variaveis
If !Empty(aTes[TS_SFC])
	If nImpde>0 .And. nImpAte>0
		For nImposto := nImpDe to nImpAte
			// Executa o calculo atraves da Funcao cadastrada no SFB
			If	aNfCab[NF_OPERNF] == "E"
				If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
					nImp:=NumCpoImpVar(RIGHT(Alltrim(aTes[TS_SFC][nImposto][SFB_CPOVREI]),1))
					aNfItem[nItem][IT_DESCIV][nImp] := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],aTes[TS_SFC][nImposto][SFB_DESCR],aTes[TS_SFC][nImposto][SFC_CALCULO]}
				EndIf
			Else
				If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
					nImp:=NumCpoImpVar(RIGHT(Alltrim(aTes[TS_SFC][nImposto][SFB_CPOVRSI]),1))
					aNfItem[nItem][IT_DESCIV][nImp] := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],aTes[TS_SFC][nImposto][SFB_DESCR],aTes[TS_SFC][nImposto][SFC_CALCULO]}
				EndIf
			EndIf
		Next nImposto
	Endif
Else
	For nImposto := 1 to NMAXIV
		aNfItem[nItem][IT_DESCIV][nImposto] := {"","",""}
	Next nImposto
EndIf

Return Nil

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisImpIV³ Autor ³ Alexandre Lemes        ³ Data ³27/11/2013³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Funcao que dispara o calculo dos impostos localizados.      ³±±
±±³          ³ A Funcao sofreu um refactory em 27/11/2013 em razao da      ³±±
±±³          ³ baixa performance ao calcular os impostos por Total do pais ³±±
±±³          ³ Argentina. O projeto de melhoria de performance do calculo  ³±±
±±³          ³ dos impostos localizados foi dividido por fases sendo que o ³±±
±±³          ³ refacture desta funcao foi a FASE I.                        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpN1: Item                                                 ³±±
±±³          ³ ExpC2: Referencia Fiscal vinda da MaFisRecal()              ³±±
±±³          ³ ExpL3: Flag ao editar os campos de despesas acessorias do   ³±±
±±³          ³        do documento fiscal serve para evitar o recalculo    ³±±
±±³          ³        desnecessario dos imposto por total                  ³±±
±±³          ³ ExpL4: Indica se a chamada da funcao vem da edicao de um    ³±±
±±³          ³ campo de cabecalho do documento fiscal (Despesas acessorias)³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function MaFisImpIV(nItem,cCampo,lExecuta,lDespesas)

Local aCposArred  := {"IT_DESCONTO","IT_FRETE","IT_DESPESA","IT_SEGURO","IT_VALEMB","IT_TOTAL","IT_VALMERC","IT_VNAGREG","IT_BASEDUP","IT_ADIANT","IT_DESCTOT","IT_ACRESCI","IT_VLR_FRT","IT_DESNTRB"}
Local aCalcular   := aClone( aTes[TS_SFC] )
Local cNumCpo     := ""
Local nX		  := 0
Local nY 		  := 0
Local nG          := 0
Local nZ          := 0
Local nIV         := 0
Local nBaseIV     := 0
Local nAliquota   := 0
Local nValorIV    := 0
Local nImpAnt     := 0
Local nPosImp     := 0
Local nVlrRateado := 0
Local nBseRateado := 0
Local nBseRateio  := 0
Local nFator      := 0
Local nPosItRef   := 0
Local nDecimais	  := IIf( cPaisLoc $ "ARG/PER" , MsDecimais(aNFCab[NF_MOEDA]) , 0 )
Local lRefazNFCab := .T.

DEFAULT cCampo := ""
DEFAULT lExecuta := .T.
DEFAULT lDespesas:= .F.

If cPaisLoc == "PER" .and. SF1->(FieldPos("F1_ADIANT")) > 0
	AADD(aCposArred,"IT_ADIANTTOT")
EndIf

If lNotRemito
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Tratamento para calculo do impostos variaveis localizados especifico para o SIGAEIC.³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If (Type("lFacImport")=="L" .And. lFacImport)
		PRIVATE aImposEIC := {}
		SD1->(MsSeek(xFilial("SD1")+SF1->F1_DOC+SF1->F1_SERIE+SF1->F1_FORNECE+SF1->F1_LOJA+aNfItem[nItem][IT_PRODUTO]+StrZero(nItem,TamSx3("D1_ITEM")[1])))
		A100IniImp(SD1->D1_SERIE,SD1->D1_DOC,SD1->D1_TEC,,,,,,,nItem)
		If Len(aImposEic) > 0
			For nX := 1 To Len(aImposEIC)
				nIV := NumCpoImpVar(Right(aImposEIC[nX,6],1))
				If nIV > 0
					SFB->(MsSeek(xFilial("SFB")+aImposEIC[nX,4]))
					aNFItem[nItem][IT_BASEIMP][nIV]	:=	aImposEIC[nX,7]
					aNfItem[nItem][IT_DESCIV][nIV]	:=	{aImposEIC[nX,4],SFB->FB_DESCR,Posicione("SFC",1,xFilial("SFC")+aImposEIC[nX][2]+aImposEIC[nX][3]+aImposEIC[nX][4],"FC_CALCULO")}
					aNFItem[nItem][IT_VALIMP][nIV]	:=	aImposEIC[nX,9]
					aNFItem[nItem][IT_ALIQIMP][nIV]	:=	aImposEIC[nX,5]
				Endif
			Next nX
		Endif
		
	Else
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Rotina que LIMPA os impostos calculados no Item,a TES pode ter sido alterada por outra.  ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		For nIV := 1 to NMAXIV
			If aNfItem[nItem][IT_DESCIV][nIV][3] == "T" .And. Ascan( aCalcular ,{ |x| Right(Alltrim(x[9]),1) == NumCpoImpVar( nIV ) } ) == 0
				Aadd(aCalcular,{"",aNfItem[nItem][IT_DESCIV][nIV][1],"","","","",0,aNfItem[nItem][IT_DESCIV][nIV][2],"D1_VALIMP"+NumCpoImpVar(nIV),"","","","","","","","","",aNfItem[nItem][IT_DESCIV][nIV][3],Nil,0,aNFItem[nItem][IT_ALIQIMP][nIV]} )
			Endif
			aNfItem[nItem][IT_DESCIV][nIV]	:=	{"","",""}
			aNFItem[nItem][IT_BASEIMP][nIV]	:=	0
			aNFItem[nItem][IT_VALIMP][nIV]	:=	0
			aNFItem[nItem][IT_ALIQIMP][nIV]	:=	0
			
			Aadd( aCposArred , "IT_BASEIV"+NumCpoImpVar(nIV) )
			Aadd( aCposArred , "IT_VALIV"+NumCpoImpVar(nIV)  )
			
		Next nIV
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Rotina principal que dispara o calculo de TODOS o impostos variaveis localizados.   ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If Len(aCalcular) > 0 .And. !aNfItem[nItem][IT_DELETED]
			
			For nIV := 1 To Len(aCalcular)
				
				If aCalcular[nIV][SFC_CALCULO] <> "T"
					MaFisCalcIV(nIV,nItem, .F. )
					MaFisAliqIV(nIV,nItem)
					MaFisVLIV(nIV,nItem)
				Else
					If Len(aCalcular[nIV]) < 22
						MaFisCalcIV(nIV,nItem, .T. )
						MaFisAliqIV(nIV,nItem)
					EndIf
					
					cNumCpo := Right(Alltrim(aCalcular[nIV][SFB_CPOVREI]),1)
					nNumCpo := NumCpoImpVar( cNumCpo )
					
					If Len(aCalcular[nIV]) < 22
						nImpAnt  := MaFisRet(nItem,"IT_VALIV" + cNumCpo)
						MaFisVLIV(nIV,nItem)
						nValorIV := MaFisRet(nItem,"IT_VALIV" + cNumCpo)
						nAliquota:= MaFisRet(nItem,"IT_ALIQIV"+ cNumCpo)
					Else
						If MaFisRet(,"NF_BASEIV"+cNumCpo) < MaFisRet(,"NF_MINIV"+cNumCpo)
							nBaseIV	 := 0
							nValorIV := 0
						Else
							nBaseIV  := MaFisRet(,"NF_BASEIV"+cNumCpo)
							nValorIV :=	MaFisRet(,"NF_VALIV"+cNumCpo)
						Endif
						nAliquota := aCalcular[nIV][22]
					EndIf
					
					If lExecuta .And. !( Alltrim(cCampo) $  "PRODUTO|QUANT|PRCUNI" ) .And. aNfItem[nItem][IT_VALMERC] > 0 .And. ;
						( ( Len(aCalcular[nIV])  < 22 .And. ( Round(nValorIV,3) > 0 .Or. ;
						( nImpAnt > 0 .And. Round(nValorIV,3) == 0) ) ) .Or. ;
						( Len(aCalcular[nIV]) == 22 .And. nBaseIV > 0 ) )
						
						If nBaseIV > 0
							lRefazNFCab := .F.
						EndIf
						
						nBseRateio  := 0
						nBseRateado := 0
						nVlrRateado := 0
						
						aEval(aNfItem,{|x| nBseRateio += IIf( !x[IT_DELETED] .And. x[IT_ALIQIMP][nNumCpo] == nAliquota  , x[IT_BASEIMP][nNumCpo] , 0 ) } )
						
						For nX := 1 to Len(aNfItem)
							If !aNfItem[nX][IT_DELETED]
								
								If aNfItem[nX][IT_TES] <> aTes[TS_CODIGO]
									MaFisTes(aNfItem[nX][IT_TES],aNfItem[nX][IT_RECNOSF4],nX)
								EndIf
								
								nFator := aNFItem[nX][IT_BASEIMP][nNumCpo] / nBseRateio
								
								If aNFItem[nX][IT_ALIQIMP][nNumCpo] == nAliquota
									
									If nX <> nItem // nItemNao
										
										aNfCab[NF_DESCONTO]	-= aNfItem[nX][IT_DESCONTO]
										aNfCab[NF_FRETE]	-= aNfItem[nX][IT_FRETE]
										aNfCab[NF_DESPESA]	-= aNfItem[nX][IT_DESPESA]
										aNfCab[NF_SEGURO]	-= aNfItem[nX][IT_SEGURO]
										aNfCab[NF_VALEMB]	-= aNfItem[nX][IT_VALEMB]
										aNfCab[NF_TOTAL]	-= aNfItem[nX][IT_TOTAL]
										aNfCab[NF_VALMERC]	-= aNfItem[nX][IT_VALMERC]-aNfItem[nX][IT_VNAGREG]
										aNfCab[NF_VNAGREG] 	-= aNfItem[nX][IT_VNAGREG]
										aNfCab[NF_BASEDUP]	-= aNfItem[nX][IT_BASEDUP]
										aNfCab[NF_PESO]		-= aNfItem[nX][IT_PESO]
										aNFCab[NF_ADIANT]	-= aNfItem[nX][IT_ADIANT]
										aNfCab[NF_DESCTOT]  -= aNfItem[nX][IT_DESCTOT]
										aNfCab[NF_ACRESCI]	-= aNfItem[nX][IT_ACRESCI]
										aNfCab[NF_VLR_FRT]	-= aNfItem[nX][IT_VLR_FRT]
										aNfCab[NF_DESNTRB]	-= aNfItem[nX][IT_DESNTRB]
										aNfCab[NF_TARA]		-= aNfItem[nX][IT_TARA]
										
										If cPaisLoc == "PER" .and. SF1->(FieldPos("F1_ADIANT")) > 0
											aNfCab[NF_ADIANTTOT]	-= aNfItem[nX][IT_ADIANTTOT]
										EndIf
										
										For nG := 1 To NMAXIV
											aNfCab[NF_BASEIMP][nG] -= aNfItem[nX][IT_BASEIMP][nG]
											aNfCab[NF_VALIMP][nG]  -= aNfItem[nX][IT_VALIMP][nG]
											aNfCab[NF_VLRORIG][nG] -= aNfItem[nX][IT_VALIMP][nG]
											If aNfItem[nX][IT_BASEIMP][nG]<>0 .Or. aNfItem[nX][IT_VALIMP][nG] <> 0
												MaFisResumo(aNfItem[nX][IT_BASEIMP][nG],aNfItem[nX][IT_ALIQIMP][nG],aNfItem[nX][IT_VALIMP][nG],aNfItem[nX][IT_DESCIV][nG][1],aNfItem[nX][IT_DESCIV][nG][2],"IV"+NumCpoImpVar(nG),,,.F.)
											EndIf
										Next nG
										
										If nIV == Len(aCalcular)
											
											MaFisLFToLivro(nX,@aAuxOri,.F.)
											
											For nZ := 1 to Len(aCposArred)  // Executa a correcao nos arredondamentos.
												
												nY := aScan( aItemRef , {|x| x[1] == aCposArred[nZ]} )
												
												If aItemRef[nY][4]
													If !aItemRef[nY][5]
														If ValType(aItemRef[nY][2]) == "A"
															aNfItem[nX][aItemRef[nY][2][1]][aItemRef[nY][2][2]] += aItemDec[nX][2][nY]
															aNfItem[nX][aItemRef[nY][2][1]][aItemRef[nY][2][2]] -= aItemDec[nX][1][nY]
														Else
															aNfItem[nX][Val(aItemRef[nY][2])] += aItemDec[nX][2][nY]
															aNfItem[nX][Val(aItemRef[nY][2])] -= aItemDec[nX][1][nY]
														EndIf
														aSaveDec[nY] += aItemDec[nX][1][nY]
														aSaveDec[nY] -= aItemDec[nX][2][nY]
													Else
														If ValType(aItemRef[nY][2]) == "A"
															aNfItem[nX][aItemRef[nY][2][1]][aItemRef[nY][2][2]] -= aItemDec[nX][2][nY]
															aNfItem[nX][aItemRef[nY][2][1]][aItemRef[nY][2][2]] += aItemDec[nX][1][nY]
														Else
															aNfItem[nX][Val(aItemRef[nY][2])] -= aItemDec[nX][2][nY]
															aNfItem[nX][Val(aItemRef[nY][2])] += aItemDec[nX][1][nY]
														EndIf
													EndIf
													aItemDec[nX][1][nY]:= 0
													aItemDec[nX][2][nY]:= 0
												EndIf
												
											Next nZ
											
										EndIf
										
									Endif
									
									If nBaseIV > 0
										nPosItRef   := Ascan(aItemRef,{|x| x[1] == "IT_BASEIV"+cNumCpo })
										nBseRateado += aNFItem[nX][IT_BASEIMP][nNumCpo] := IIf( aItemRef[nPosItRef][4] .And. aItemRef[nPosItRef][5] , NoRound( nFator * nBaseIV , 2 ) , IIf(cPaisLoc$"PAR/PER",NoRound(nFator*nBaseIV,nDecimais) , nFator * nBaseIV )  )
									EndIf
									
									nPosItRef   := Ascan(aItemRef,{|x| x[1] == "IT_VALIV"+cNumCpo })
									nVlrRateado += aNFItem[nX][IT_VALIMP][nNumCpo] := IIf( aItemRef[nPosItRef][4] .And. aItemRef[nPosItRef][5] , NoRound( nFator * nValorIV , 2 ) , IIf(cPaisLoc$"PAR/PER",NoRound(nFator*nValorIV,nDecimais) , nFator * nValorIV )  )
									
								EndIf
								
								If Len(aNfItem) == nX
									If nBaseIV > 0 .And. nBaseIV <> nBseRateado
										aNfItem[Len(aNfItem)][IT_BASEIMP][nNumCpo]+= (nBaseIV-nBseRateado)
									EndIf
									If nValorIV <> nVlrRateado
										aNfItem[Len(aNfItem)][IT_VALIMP][nNumCpo] += (nValorIV-nVlrRateado)
									EndIf
								EndIf
								
								If nX <> nItem // nItemNao
									
									If nBaseIV > 0
										MaFisVLIV(Ascan(aTes[TS_SFC],{|x| Substr(x[10],10,1) ==  cNumCpo }) , nX )
									EndIf
									
									If nIV == Len(aCalcular)
										MaFisVTot(nX)     // tem o len do aTES
										MaItArred(nX,aCposArred)
									EndIf
									
								EndIf
								
							EndIf
							
						Next nX
						
						If lRefazNFCab
							
							aAuxOri := {}
							
							aNfCab[NF_LIVRO]	:= {}
							aNfCab[NF_IMPOSTOS]	:= {}
							aNfCab[NF_IMPOSTOS2]:= {}
							aNfCab[NF_DESCONTO]	:= 0
							aNfCab[NF_DESCTOT]	:= 0
							aNfCab[NF_ACRESCI]	:= 0
							aNfCab[NF_FRETE]	:= 0
							aNfCab[NF_DESPESA]	:= 0
							aNfCab[NF_SEGURO]	:= 0
							aNfCab[NF_VALEMB]	:= 0
							aNfCab[NF_TOTAL]	:= 0
							aNfCab[NF_VALMERC]	:= 0
							aNfCab[NF_VNAGREG]  := 0
							aNfCab[NF_BASEDUP]	:= 0
							aNfCab[NF_PESO]		:= 0
							aNfCab[NF_VLR_FRT]  := 0
							aNfCab[NF_DESNTRB]  := 0
							aNfCab[NF_ADIANT]   := 0
							aNfCab[NF_BASEIMP]	:= Array(NMAXIV)
							aNfCab[NF_BASEIMP]	:= Afill(aNfCab[NF_BASEIMP],0)
							aNfCab[NF_VALIMP]	:= Array(NMAXIV)
							aNfCab[NF_VALIMP]	:= Afill(aNfCab[NF_VALIMP],0)
							aNfCab[NF_MINIMP]	:= Array(NMAXIV)
							aNfCab[NF_MINIMP]	:= Afill(aNfCab[NF_MINIMP],0)
							aNfCab[NF_VLRORIG]	:= Array(NMAXIV)
							aNfCab[NF_VLRORIG]	:= Afill(aNfCab[NF_VLRORIG],0)
							
							If cPaisLoc == "PER" .and. SF1->(FieldPos("F1_ADIANT")) > 0
								aNfCab[NF_ADIANTTOT]   := 0
							EndIf
							
							For nX := 1 to Len(aNfItem)
								If nItem <> nX  .Or. lDespesas // nItemNao
									If !aNfItem[nX][IT_DELETED]
										aNfCab[NF_DESCONTO]+= aNfItem[nX][IT_DESCONTO]
										aNfCab[NF_FRETE]   += aNfItem[nX][IT_FRETE]
										aNfCab[NF_DESPESA] += aNfItem[nX][IT_DESPESA]
										aNfCab[NF_SEGURO]  += aNfItem[nX][IT_SEGURO]
										aNfCab[NF_VALEMB]  += aNfItem[nX][IT_VALEMB]
										aNfCab[NF_TOTAL]   += aNfItem[nX][IT_TOTAL]
										aNfCab[NF_VALMERC] += aNfItem[nX][IT_VALMERC]-aNfItem[nX][IT_VNAGREG]
										aNfCab[NF_VNAGREG] += aNfItem[nX][IT_VNAGREG]
										aNfCab[NF_BASEDUP] += aNfItem[nX][IT_BASEDUP]
										aNfCab[NF_PESO]	   += aNfItem[nX][IT_PESO]
										aNfCab[NF_ADIANT]  += aNfItem[nX][IT_ADIANT]
										aNfCab[NF_DESCTOT] += aNfItem[nX][IT_DESCTOT]
										aNfCab[NF_ACRESCI] += aNfItem[nX][IT_ACRESCI]
										aNfCab[NF_VLR_FRT] += aNfItem[nX][IT_VLR_FRT]
										aNfCab[NF_DESNTRB] += aNfItem[nX][IT_DESNTRB]
										aNfCab[NF_TARA]	   += aNfItem[nX][IT_TARA]
										
										If cPaisLoc == "PER" .and. SF1->(FieldPos("F1_ADIANT")) > 0
											aNfCab[NF_ADIANTTOT]  += aNfItem[nX][IT_ADIANTTOT]
										EndIF
										
										
										For nG := 1 To NMAXIV
											aNfCab[NF_BASEIMP][nG]+= aNfItem[nX][IT_BASEIMP][nG]
											aNfCab[NF_VALIMP][nG] += aNfItem[nX][IT_VALIMP][nG]
											aNfCab[NF_VLRORIG][nG]+= aNfItem[nX][IT_VALIMP][nG]
											
											If aNfItem[nX][IT_BASEIMP][nG]<>0 .Or. aNfItem[nX][IT_VALIMP][nG] <> 0
												MaFisResumo(aNfItem[nX][IT_BASEIMP][nG],aNfItem[nX][IT_ALIQIMP][nG],aNfItem[nX][IT_VALIMP][nG],aNfItem[nX][IT_DESCIV][nG][1],aNfItem[nX][IT_DESCIV][nG][2],"IV"+NumCpoImpVar(nG),,,.T.)
											EndIf
										Next nG
										
										If nIV == Len(aCalcular)
											
											MaFisLFToLivro(nX,@aAuxOri,.T.)
											
										EndIf
										
									EndIf
								Endif
							Next nX
							
						EndIf
						
						If aNfItem[nItem][IT_TES] <> aTes[TS_CODIGO]
							MaFisTes(aNfItem[nItem][IT_TES],aNfItem[nItem][IT_RECNOSF4],nItem)
						EndIf
						
					Endif
					
				EndIf
				
			Next nIV
			
		EndIf
		
	EndIf
	
EndIf

Return

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±ºPrograma  ³MaRetIncIV    º Leandro C.G. ³Microsiga º Data ³  14/01/02  º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Retorna valores de impostos referentes a um item de NF que º±±
±±º          ³ incidem no custo, Duplicata, ou Nota                       º±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
/*Parametros
nItem		- Numero do item da Nota Fiscal
cOpc		- 1- Custo 2- Nota 3- Duplicata

Obs.: Considera que o arquivo de itens da Nota Fiscal ja esta posicionado no registro correto e que
as variaveis de calculo de impostos do programa MatxFis ja estao inicializadas
*/
Static Function MaRetIncIV(nItem,cOpc)

Local aDescImp 	:=	{}	//Descricao/Codigo de todos os impostos que incidem no item
Local aValImp	:=	{}	//Array com os valores de todos os impostos que incidem no item
Local nImposVar	:=	0	//Valor dos impostos variaveis que incidem no custo
Local aSFC		:=	{} //Array com as propriedades dos impostos do item
Local aRet 		:= {} //Array com os impostos e valores que sao somados ou subtraidos no custo
/*						[1] - Codigo do imposto
[2] - Valor positivio (quando imposto e creditado) e negativo (+/-)
*/
Local nI		:=	0	//controle de loop
//³Consistindo parametros³
If Empty(nItem)
	Return( 0 )
EndIf

If aNfItem[nItem][IT_TES] <> aTes[TS_CODIGO]
	MaFisTes(aNfItem[nItem][IT_TES],aNfItem[nItem][IT_RECNOSF4],nItem)
EndIf
aSFC	 :=	aClone(aTes[TS_SFC])

aDescImp :=	aNFItem[nItem,IT_DESCIV]		//Descricao/Codigo dos impostos
aValImp  :=	aNFItem[nItem,IT_VALIMP]		//Valor dos Impostos

//³Buscando valores referentes aos impostos³
For nI := 1 to Len(aSFC)
	nPosImp	:=	Ascan(aDescImp,{|x| x[1] == aSFC[nI][SFC_IMPOSTO]})
	If nPosImp > 0
		Do Case
			Case cOpc == '1'
				If aSFC[nI][SFC_CREDITA] <> '3'
					nImposVar	:=	aValImp[nPosImp] * If(aSFC[nI][SFC_CREDITA] == '1', 1 , -1)
					Aadd(aRet, {aSFC[nI][SFC_IMPOSTO], nImposVar})
				Endif
			Case cOpc == '2'
				If aSFC[nI][SFC_INCNOTA] <> '3'
					nImposVar	+=	aValImp[nPosImp] * If(aSFC[nI][SFC_INCNOTA] == '1', 1 , -1)
				Endif
			Case cOpc == '3'
				If aSFC[nI][SFC_INCDUPL] <> '3'
					nImposVar	+=	aValImp[nPosImp] * If(aSFC[nI][SFC_INCDUPL] == '1', 1 , -1)
				Endif
		EndCase
	Endif
Next nI

Return(IIf(cOpc=="1",aRet,nImposVar))

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisCalcIV³ Autor ³                        ³ Data ³03.04.2009³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Executa o calculo do Valor dos Impostos Variaveis             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1: Numero do Imposto ( 1 a X )                            ³±±
±±³          ³ExpN2: Item a ser calculado                                   ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function MaFisCalcIV(nImposto,nItem,lImpTot)

Local lRet		:= .T.
Local nValImp	:= 0
Local nImp		:=Len(aTes[TS_SFC])
Local nImpde	:=IIF(nImposto==Nil,1,nImposto)
Local nImpAte	:=IIF(nImposto==Nil,nImp,nImposto)
Local xImposto
Local nMv_ALQIPM	:= aParSX6[MV_ALQIPM]
Local cMV_AGENTE  	:= aParSX6[MV_AGENTE]
Local alAreaX
Local alAreaY
Local alAreaZ
Local nlTotal    := 0
Local nlCont     := 0
Local nlMinDIG   	:= aParSX6[MV_MINDETR]
Local nlBaseDIG  := 0
Local nX		 := 0
Local nG		 := 0

Private aInfo  //Definida como private pois é usada numa macro
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifica se a TES possui tratamento para Impostos Variaveis  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If cPaisLoc=="PER"  .And. aFieldPos[FP_B1_VMINDET]
	nlMinDIG := Iif( aNfItem[nItem][IT_PRD][SB_VMINDET] > 0 , aNfItem[nItem][IT_PRD][SB_VMINDET] , nlMinDIG )
EndIf

If cPaisLoc == "BRA" .Or. lNotRemito
	If !Empty(aTes[TS_SFC])
		If nImpde>0 .And. nImpAte>0
			nImposto := nImpDe
			While (nImposto <= nImpAte) .And. lRet
				//³       Tratamento especifico para localizado PERU             ³
				//³ Abaixo estão os cálculo dos impostos variáveis de acordo     ³
				//³ com as regras de ISC, IGV, PIV e DIG. Caso não seja nenhum   ³
				//³ desses executa normalmente como se fosse não localizado      ³
				//Caso nao seja localizado Peru, executa o padrão
				If cPaisLoc $ "PER"
					alAreaX := SFC->(GetArea())
					alAreaY := SF4->(GetArea())
					alAreaZ := GetArea()
					
					If aTes[TS_SFC][nImposto][SFC_IMPOSTO] $ "IGV"
						DbSelectArea("SF4")
						DbSetOrder(1)
						// VERIFICAR A NECESSIDADE DESTE SEEK -> POIS AQUI UTILIZA A REFERENCIA aTes[TS_CODIGO] para posicionar na SF4
						If MsSeek(xFilial("SF4")+aTes[TS_CODIGO])
							If (SF4->F4_CALCIGV <> "2" .And. SF4->F4_CALCIGV <> "3")
								//³ Executa o calculo atraves da Funcao cadastrada no SFB        ³
								aInfo := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],RIGHT(Alltrim(aTes[TS_SFC][nImposto][SFB_CPOVREI]),1)}
								nImp:=NumCpoImpVar(aInfo[2])
								If aNfCab[NF_OPERNF] == "E"
									If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
										If lImpTot
											xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("B",'+Str(nItem)+',aInfo,"BA")')
										Else
											xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("B",'+Str(nItem)+',aInfo,"BAV")')
										Endif
										If ValType(xImposto) == "A"
											aNfItem[nItem][IT_BASEIMP][nImp] := xImposto[1]
											aNfItem[nItem][IT_ALIQIMP][nImp] := xImposto[2]
											aNfItem[nItem][IT_VALIMP][nImp]	 := xImposto[3]
											
											//³          TRATAMENTO EXPECIFICO PARA LOCALIZADO PERU                     ³
											//³ Quando o TES for referente ao imposto do IGV, o valor do IPM, o         ³
											//³ qual é uma porcentagem do IGV,o valor da base, aliquota e valor do      ³
											//³ imposto é gravado nos campos _BASIMP3, _ALQIMP3 e VALIMP3 para entrada. ³
											//³ O VALOR DA BASE é A MESMA UTILIZADA PARA O CáLCULO DO IGV.              ³
											//³ O VALOR DA ALíQUTOA é PROVENIENTE DE UM PARAMêTRO CHAMADO               ³
											//³ MV_ALQIPM.                                                              ³
											
											aNfItem[nItem][IT_BASEIMP][3] := xImposto[1]
											aNfItem[nItem][IT_ALIQIMP][3] := nMv_ALQIPM
											aNfItem[nItem][IT_VALIMP][3]  := xImposto[1]*(nMv_ALQIPM/100)
										Else
											aNfItem[nItem][IT_BASEIMP][nImp] := xImposto
											lRet := .F.
											//³          TRATAMENTO EXPECIFICO PARA LOCALIZADO PERU                 ³
											//³ NO CASO ABAIXO, APENAS O VALOR DA BASE É SALVA NA REFERÊNCIA.       ³
											
											aNfItem[nItem][IT_BASEIMP][3] := xImposto
										EndIf
										aNfItem[nItem][IT_DESCIV][nImp] := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],aTes[TS_SFC][nImposto][SFB_DESCR],aTes[TS_SFC][nImposto][SFC_CALCULO]}
									EndIf
								Else
									If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
										If lImpTot
											xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("B",'+Str(nItem)+',aInfo,"BA")')
										Else
											xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("B",'+Str(nItem)+',aInfo,"BAV")')
										Endif
										If ValType(xImposto) == "A"
											aNfItem[nItem][IT_BASEIMP][nImp] := xImposto[1]
											aNfItem[nItem][IT_ALIQIMP][nImp] := xImposto[2]
											aNfItem[nItem][IT_VALIMP][nImp]	 := xImposto[3]
											//³          TRATAMENTO EXPECIFICO PARA LOCALIZADO PERU                     ³
											//³ O VALOR DA BASE é A MESMA UTILIZADA PARA O CáLCULO DO IGV.              ³
											//³ O VALOR DA ALíQUTOA é PROVENIENTE DE UM PARAMêTRO CHAMADO               ³
											//³ MV_ALQIPM.                                                              ³
											
											aNfItem[nItem][IT_BASEIMP][3] := xImposto[1]
											aNfItem[nItem][IT_ALIQIMP][3] := nMv_ALQIPM
											aNfItem[nItem][IT_VALIMP][3]  := xImposto[1]*(nMv_ALQIPM/100)
										Else
											aNfItem[nItem][IT_BASEIMP][nImp]:= xImposto
											lRet := .F.
											//³          TRATAMENTO EXPECIFICO PARA LOCALIZADO PERU                 ³
											//³ NO CASO ABAIXO, APENAS O VALOR DA BASE É SALVA NA REFERÊNCIA.       ³
											
											aNfItem[nItem][IT_BASEIMP][3] := xImposto
										EndIf
										aNfItem[nItem][IT_DESCIV][nImp] := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],aTes[TS_SFC][nImposto][SFB_DESCR],aTes[TS_SFC][nImposto][SFC_CALCULO]}
									EndIf
								EndIf
								If lRet
									//³ Verifica as Propriedades do Imposto                          ³
									Do Case
										Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="1"
											nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
										Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="2"
											nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
										Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="3"
											nValImp:=0
									EndCase
									aNfItem[nItem][IT_BASEDUP] += nValImp
									Do Case
										Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="1"
											nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
										Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="2"
											nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
										Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="3"
											nValImp:=0
									EndCase
									aNfItem[nItem][IT_TOTAL] += nValImp
								Endif
							EndIf
						EndIf
						
					ElseIf aTes[TS_SFC][nImposto][SFC_IMPOSTO] $ "PIV"
						
						//³ Executa o calculo atraves da Funcao cadastrada no SFB        ³
						aInfo := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],RIGHT(Alltrim(aTes[TS_SFC][nImposto][SFB_CPOVREI]),1)}
						nImp:=NumCpoImpVar(aInfo[2])
						If aNfCab[NF_OPERNF] == "E"
							
							If aNfCab[NF_CLIFOR] $ "F"
								If SubStr(cMV_AGENTE,2,1) == "S" .And.  SA2->A2_AGENRET <> "1"
									If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
										If lImpTot
											xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("B",'+Str(nItem)+',aInfo,"BA")')
										Else
											xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("B",'+Str(nItem)+',aInfo,"BAV")')
										Endif
										If ValType(xImposto) == "A"
											aNfItem[nItem][IT_BASEIMP][nImp] := xImposto[1]
											aNfItem[nItem][IT_ALIQIMP][nImp] := xImposto[2]
											aNfItem[nItem][IT_VALIMP][nImp]	 := xImposto[3]
										Else
											aNfItem[nItem][IT_BASEIMP][nImp] := xImposto
											lRet := .F.
										EndIf
										aNfItem[nItem][IT_DESCIV][nImp] := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],aTes[TS_SFC][nImposto][SFB_DESCR],aTes[TS_SFC][nImposto][SFC_CALCULO]}
									EndIf
								EndIf
							ElseIf aNfCab[NF_CLIFOR] $ "C"
								
								If  SA1->A1_AGENTE == "2"
									
									If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
										If lImpTot
											xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("B",'+Str(nItem)+',aInfo,"BA")')
										Else
											xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("B",'+Str(nItem)+',aInfo,"BAV")')
										Endif
										If ValType(xImposto) == "A"
											aNfItem[nItem][IT_BASEIMP][nImp] := xImposto[1]
											aNfItem[nItem][IT_ALIQIMP][nImp] := xImposto[2]
											aNfItem[nItem][IT_VALIMP][nImp]	 := xImposto[3]
										Else
											aNfItem[nItem][IT_BASEIMP][nImp] := xImposto
											lRet := .F.
										EndIf
										aNfItem[nItem][IT_DESCIV][nImp] := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],aTes[TS_SFC][nImposto][SFB_DESCR],aTes[TS_SFC][nImposto][SFC_CALCULO]}
										
									EndIf
								EndIf
							EndIf
							
						Else
							If aNfCab[NF_CLIFOR] $ "C"
								If SA1->A1_AGENTE == "2"
									If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
										If lImpTot
											xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("B",'+Str(nItem)+',aInfo,"BA")')
										Else
											xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("B",'+Str(nItem)+',aInfo,"BAV")')
										Endif
										
									
										
										If ValType(xImposto) == "A"
											aNfItem[nItem][IT_BASEIMP][nImp] := xImposto[1]
											aNfItem[nItem][IT_ALIQIMP][nImp] := xImposto[2]
											aNfItem[nItem][IT_VALIMP][nImp]	 := xImposto[3]
										Else
											aNfItem[nItem][IT_BASEIMP][nImp]:= xImposto
											lRet := .F.
										EndIf
										aNfItem[nItem][IT_DESCIV][nImp] := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],aTes[TS_SFC][nImposto][SFB_DESCR],aTes[TS_SFC][nImposto][SFC_CALCULO]}
									EndIf
									
								EndIf
							ElseIf aNfCab[NF_CLIFOR] $ "F"
								If SubStr(cMV_AGENTE,2,1) == "S" .And.  SA2->A2_AGENRET <> "1"
									
									If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
										If lImpTot
											xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("B",'+Str(nItem)+',aInfo,"BA")')
										Else
											xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("B",'+Str(nItem)+',aInfo,"BAV")')
										Endif
										If ValType(xImposto) == "A"
											aNfItem[nItem][IT_BASEIMP][nImp] := xImposto[1]
											aNfItem[nItem][IT_ALIQIMP][nImp] := xImposto[2]
											aNfItem[nItem][IT_VALIMP][nImp]	 := xImposto[3]
										Else
											aNfItem[nItem][IT_BASEIMP][nImp]:= xImposto
											lRet := .F.
										EndIf
										aNfItem[nItem][IT_DESCIV][nImp] := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],aTes[TS_SFC][nImposto][SFB_DESCR],aTes[TS_SFC][nImposto][SFC_CALCULO]}
									EndIf
								EndIf
							EndIf
							
						EndIf
						If lRet
							//³ Verifica as Propriedades do Imposto                          ³
							Do Case
								Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="1"
									nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
								Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="2"
									nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
								Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="3"
									nValImp:=0
							EndCase
							aNfItem[nItem][IT_BASEDUP] += nValImp
							Do Case
								Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="1"
									nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
								Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="2"
									nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
								Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="3"
									nValImp:=0
							EndCase
							aNfItem[nItem][IT_TOTAL] += nValImp
						Endif
						
					ElseIf aTes[TS_SFC][nImposto][SFC_IMPOSTO] $ "DIG"
						
						nlTotal := MaRetBasT(,,,.T.)
						
						nlTOtal += aNfCab[NF_FRETE] + aNfCab[NF_DESPESA] + aNfCab[NF_SEGURO] - (aNfCab[NF_DESCONTO]+aNfCab[NF_DESCTOT]) + aNfCab[NF_ACRESCI]
						
						If AllTrim(Upper(FunName())) $ "MATA465N/MATA466N/MATA467N/MATA101N/MATA121" .And. aNFCab[NF_TXMOEDA] <> 0
							
							nlTotal := nlTotal * aNFCab[NF_TXMOEDA]
							
						ElseIf AllTrim(Upper(FunName())) $ "MATA410"
							
							nlTotal := xMoeda(nlTotal,M->C5_MOEDA,1,dDataBase)
							
						EndIf
						If nlTotal > nlMinDIG
							
							If aNfCab[NF_RECIV]
								aNfCab[NF_RECIV] := .F.
								MaRecurDIG(.T.)   
							EndIf   
							MaFisTes(aNfItem[nItem][IT_TES],aNfItem[nItem][IT_RECNOSF4],nItem)
							
							//³ Executa o calculo atraves da Funcao cadastrada no SFB        ³
							aInfo := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],RIGHT(Alltrim(aTes[TS_SFC][nImposto][SFB_CPOVREI]),1)}
							nImp:=NumCpoImpVar(aInfo[2])
							If aNfCab[NF_OPERNF] == "E"
								
								If aNfCab[NF_CLIFOR] $ "F"
									
									If SubStr(cMV_AGENTE,3,1) == "S" .And.  SA2->A2_AGENRET <> "1"
										
										If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
											If lImpTot
												xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("B",'+Str(nItem)+',aInfo,"BA")')
											Else
												xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("B",'+Str(nItem)+',aInfo,"BAV")')
											Endif
											If ValType(xImposto) == "A"
												aNfItem[nItem][IT_BASEIMP][nImp] := xImposto[1]
												aNfItem[nItem][IT_ALIQIMP][nImp] := xImposto[2]
												aNfItem[nItem][IT_VALIMP][nImp]	 := xImposto[3]
											Else
												aNfItem[nItem][IT_BASEIMP][nImp] := xImposto
												lRet := .F.
											EndIf
											aNfItem[nItem][IT_DESCIV][nImp] := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],aTes[TS_SFC][nImposto][SFB_DESCR],aTes[TS_SFC][nImposto][SFC_CALCULO]}
										EndIf
										
									EndIf
									
								ElseIf aNfCab[NF_CLIFOR] $ "C"
									
									If SubStr(cMV_AGENTE,1,1) == "N" .And.  SA1->A1_AGENTE == "3"
										
										If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
											If lImpTot
												xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("B",'+Str(nItem)+',aInfo,"BA")')
											Else
												xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("B",'+Str(nItem)+',aInfo,"BAV")')
											Endif
											If ValType(xImposto) == "A"
												aNfItem[nItem][IT_BASEIMP][nImp] := xImposto[1]
												aNfItem[nItem][IT_ALIQIMP][nImp] := xImposto[2]
												aNfItem[nItem][IT_VALIMP][nImp]	 := xImposto[3]
											Else
												aNfItem[nItem][IT_BASEIMP][nImp] := xImposto
												lRet := .F.
											EndIf
											aNfItem[nItem][IT_DESCIV][nImp] := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],aTes[TS_SFC][nImposto][SFB_DESCR],aTes[TS_SFC][nImposto][SFC_CALCULO]}
										EndIf
										
									EndIf
									
								EndIf
							Else
								If aNfCab[NF_CLIFOR] $ "C"
									
									If SubStr(cMV_AGENTE,1,1) == "N" .And.  SA1->A1_AGENTE == "3"
										
										If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
											If lImpTot
												xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("B",'+Str(nItem)+',aInfo,"BA")')
											Else
												xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("B",'+Str(nItem)+',aInfo,"BAV")')
											Endif
											If ValType(xImposto) == "A"
												aNfItem[nItem][IT_BASEIMP][nImp] := xImposto[1]
												aNfItem[nItem][IT_ALIQIMP][nImp] := xImposto[2]
												aNfItem[nItem][IT_VALIMP][nImp]	 := xImposto[3]
											Else
												aNfItem[nItem][IT_BASEIMP][nImp]:= xImposto
												lRet := .F.
											EndIf
											aNfItem[nItem][IT_DESCIV][nImp] := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],aTes[TS_SFC][nImposto][SFB_DESCR],aTes[TS_SFC][nImposto][SFC_CALCULO]}
										EndIf
										
									EndIf
									
								ElseIf aNfCab[NF_CLIFOR] $ "F"
									If SubStr(cMV_AGENTE,3,1) == "S" .And.  SA2->A2_AGENRET <> "1"
										
										If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
											If lImpTot
												xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("B",'+Str(nItem)+',aInfo,"BA")')
											Else
												xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("B",'+Str(nItem)+',aInfo,"BAV")')
											Endif
											If ValType(xImposto) == "A"
												aNfItem[nItem][IT_BASEIMP][nImp] := xImposto[1]
												aNfItem[nItem][IT_ALIQIMP][nImp] := xImposto[2]
												aNfItem[nItem][IT_VALIMP][nImp]	 := xImposto[3]
											Else
												aNfItem[nItem][IT_BASEIMP][nImp]:= xImposto
												lRet := .F.
											EndIf
											aNfItem[nItem][IT_DESCIV][nImp] := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],aTes[TS_SFC][nImposto][SFB_DESCR],aTes[TS_SFC][nImposto][SFC_CALCULO]}
										EndIf
									EndIf
								EndIf
							EndIf
							If lRet
								// Verifica as Propriedades do Imposto
								Do Case
									Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="1"
										nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
									Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="2"
										nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
									Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="3"
										nValImp:=0
								EndCase
								aNfItem[nItem][IT_BASEDUP] += nValImp
								Do Case
									Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="1"
										nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
									Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="2"
										nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
									Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="3"
										nValImp:=0
								EndCase
								aNfItem[nItem][IT_TOTAL] += nValImp
							Endif
						Else
							aNfCab[NF_RECIV] := .T.
							MaRecurDIG(.F.)
						EndIf
					Else
						
						// Executa o calculo atraves da Funcao cadastrada no SFB
						aInfo := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],RIGHT(Alltrim(aTes[TS_SFC][nImposto][SFB_CPOVREI]),1)}
						nImp:=NumCpoImpVar(aInfo[2])
						If aNfCab[NF_OPERNF] == "E"
							If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
								If lImpTot
									xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("B",'+Str(nItem)+',aInfo,"BA")')
								Else
									xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("B",'+Str(nItem)+',aInfo,"BAV")')
								Endif
								If ValType(xImposto) == "A"
									aNfItem[nItem][IT_BASEIMP][nImp] := xImposto[1]
									aNfItem[nItem][IT_ALIQIMP][nImp] := xImposto[2]
									aNfItem[nItem][IT_VALIMP][nImp]	 := xImposto[3]
								Else
									aNfItem[nItem][IT_BASEIMP][nImp] := xImposto
									lRet := .F.
								EndIf
								aNfItem[nItem][IT_DESCIV][nImp] := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],aTes[TS_SFC][nImposto][SFB_DESCR],aTes[TS_SFC][nImposto][SFC_CALCULO]}
							EndIf
						Else
							If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
								If lImpTot
									xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("B",'+Str(nItem)+',aInfo,"BA")')
								Else
									xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("B",'+Str(nItem)+',aInfo,"BAV")')
								Endif
								If ValType(xImposto) == "A"
									aNfItem[nItem][IT_BASEIMP][nImp] := xImposto[1]
									aNfItem[nItem][IT_ALIQIMP][nImp] := xImposto[2]
									aNfItem[nItem][IT_VALIMP][nImp]	 := xImposto[3]
								Else
									aNfItem[nItem][IT_BASEIMP][nImp]:= xImposto
									lRet := .F.
								EndIf
								aNfItem[nItem][IT_DESCIV][nImp] := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],aTes[TS_SFC][nImposto][SFB_DESCR],aTes[TS_SFC][nImposto][SFC_CALCULO]}
							EndIf
						EndIf
						If lRet
							// Verifica as Propriedades do Imposto
							Do Case
								Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="1"
									nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
								Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="2"
									nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
								Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="3"
									nValImp:=0
							EndCase
							aNfItem[nItem][IT_BASEDUP] += nValImp
							Do Case
								Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="1"
									nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
								Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="2"
									nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
								Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="3"
									nValImp:=0
							EndCase
							aNfItem[nItem][IT_TOTAL] += nValImp
						Endif
						
					EndIf
					RestArea(alAreaX)
					RestArea(alAreaY)
					RestArea(alAreaZ)
				Else
					
					// Executa o calculo atraves da Funcao cadastrada no SFB
					aInfo := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],RIGHT(Alltrim(aTes[TS_SFC][nImposto][SFB_CPOVREI]),1)}
					nImp:=NumCpoImpVar(aInfo[2])
					If aNfCab[NF_OPERNF] == "E"
						If !Empty(aTes[TS_SFC][nImposto][SFB_FORMENT])
							If lImpTot
								xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("B",'+Str(nItem)+',aInfo,"BA")')
							Else
								xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMENT]+'("B",'+Str(nItem)+',aInfo,"BAV")')
							Endif  
							
							IF aNFitem[nItem][IT_TIPONF]$"DB" .AND. cPaisLoc == "PAR" .AND. aParSX6[MV_DESCSAI]=='1' .AND. Alltrim(cFunName) == "MATA465N" .AND. ( aNFitem[nItem][IT_DESCONTO]>0  .OR.  aNFitem[nItem][IT_DESCTOT]>0 )
								xImposto += (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT])
							EndIf
							
							If ValType(xImposto) == "A"
								aNfItem[nItem][IT_BASEIMP][nImp] := xImposto[1]
								aNfItem[nItem][IT_ALIQIMP][nImp] := xImposto[2]
								aNfItem[nItem][IT_VALIMP][nImp]	 := xImposto[3]
							Else
								aNfItem[nItem][IT_BASEIMP][nImp] := xImposto
								lRet := .F.
							EndIf
							aNfItem[nItem][IT_DESCIV][nImp] := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],aTes[TS_SFC][nImposto][SFB_DESCR],aTes[TS_SFC][nImposto][SFC_CALCULO]}
						EndIf
					Else
						If !Empty(aTes[TS_SFC][nImposto][SFB_FORMSAI])
							If lImpTot
								xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("B",'+Str(nItem)+',aInfo,"BA")')
							Else
								xImposto := &(aTes[TS_SFC][nImposto][SFB_FORMSAI]+'("B",'+Str(nItem)+',aInfo,"BAV")')
							Endif
							If ValType(xImposto) == "A"
								aNfItem[nItem][IT_BASEIMP][nImp] := xImposto[1]
								aNfItem[nItem][IT_ALIQIMP][nImp] := xImposto[2]
								aNfItem[nItem][IT_VALIMP][nImp]	 := xImposto[3]
							Else
								aNfItem[nItem][IT_BASEIMP][nImp]:= xImposto
								lRet := .F.
							EndIf
							aNfItem[nItem][IT_DESCIV][nImp] := {aTes[TS_SFC][nImposto][SFC_IMPOSTO],aTes[TS_SFC][nImposto][SFB_DESCR],aTes[TS_SFC][nImposto][SFC_CALCULO]}
						EndIf
					EndIf
					If lRet
						// Verifica as Propriedades do Imposto
						Do Case
							Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="1"
								nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
							Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="2"
								nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
							Case aTes[TS_SFC][nImposto][SFC_INCDUPL]=="3"
								nValImp:=0
						EndCase
						aNfItem[nItem][IT_BASEDUP] += nValImp
						Do Case
							Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="1"
								nValImp:=aNfItem[nItem][IT_VALIMP][nImp]
							Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="2"
								nValImp:=-aNfItem[nItem][IT_VALIMP][nImp]
							Case aTes[TS_SFC][nImposto][SFC_INCNOTA]=="3"
								nValImp:=0
						EndCase
						aNfItem[nItem][IT_TOTAL] += nValImp
					Endif
					
				EndIf
				nImposto++
			Enddo
		Endif
	Else
		//³ Zera todas as aliquotas.                                     ³
		For nImposto := 1 to NMAXIV
			aNFItem[nItem][IT_BASEIMP][nImposto] := 0
			aNfItem[nItem][IT_DESCIV][nImposto]	 := {"","",""}
			aNFItem[nItem][IT_VALIMP][nImposto]	 := 0
			aNFItem[nItem][IT_ALIQIMP][nImposto] := 0
		Next nImposto
	EndIf
EndIf
Return(lRet)

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±ºPrograma  ³MaRetIncIV    º Leandro C.G. ³Microsiga º Data ³  14/01/02  º±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºDesc.     ³ Retorna valores de impostos referentes a um item de NF que º±±
±±º          ³ incidem no custo, Duplicata, ou Nota                       º±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Static Function NumCpoImpVar(xCpoLiv)
Local cCpo,xRet
cCpo:="123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"
xRet:=0
If !Empty(xCpoLiv)
	If ValType(xCpoLiv)=="C"
		xRet:=At(xCpoLiv,cCpo)
	ElseIf ValType(xCpoLiv)=="N"
		If xCpoLiv>0
			xRet:=Substr(cCpo,xCpoLiv,1)
		Endif
	Endif
Endif
Return(xRet)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisCalAl ³ Autor ³ Bruno Sobieski       ³ Data ³29.08.2003³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Executa o calculo da Aliquota dos Impostos Variaveis        ³±±
±±³          ³Esta funcao foi criada para nao tirar a propriedade de      ³±±
±±³          ³STATIC da funcao MAFISAliqIV                                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN1: Numero do Imposto ( 1 a 6 )                          ³±±
±±³          ³ExpN2: Item a ser calculado                                 ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisCalAl(nImposto,nItem)

MaFisAliqIV(nImposto,nItem)

Return

Static Function MAFisZero()
Return 0.0001

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³ MaRetBasT³ Autor ³ Bruno Sobieski        ³ Data ³21.10.2004³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Retorna a base total de um imposto, dependendo da aliquota  ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaRetBasT(cNumImp,nItem,nAliq,llTot)
Local nBase	  :=	0
Local nX	  :=	0	//controle de loop
Local nY	  :=  0
Default llTot := .F.
//Local nPosImp	:=	aScan(aNfCab[NF_IMPOSTOS],{|x| x[IMP_COD] ==aDesc[1] .And.	x[IMP_ALIQ]==nAliq })

//nBase		:=	MaFisRet(nItem,'IT_BASEIV'	+cNumImp)
If cPaisLoc == "BRA" .Or. lNotRemito
	For nX := 1 To Len(aNFItem)
		If !aNfItem[nX][IT_DELETED]
			/*Calcula o valor total da nota fiscal com os impostos de todos itens "PER"*/
			If llTot
				nBase += aNFItem[nX,IT_VALMERC]
				
				If aNfItem[nX][IT_TES] <> aTes[TS_CODIGO]
					MaFisTes(aNfItem[nX][IT_TES],aNfItem[nX][IT_RECNOSF4],nX)
				EndIf 
				
				For nY := 1 to Len(aTes[TS_SFC])
					If aTes[TS_SFC][nY][SFC_IMPOSTO] <> "DIG"
						
						nBase += MaFisRet(nX,'IT_VALIV'+ RIGHT(Alltrim(aTes[TS_SFC][nY][SFB_CPOVREI]),1))
						
					EndIf
				Next nY
				
			Else
				If MaFisRet(nX,'IT_ALIQIV'+cNumImp) == nAliq
					nBase += MaFisRet(nX,'IT_BASEIV'+cNumImp)
				Endif
			EndIf
			
		Endif
	Next nX
EndIf
Return nBase

/*
±±³Funcao    ³MaRecurDIG³ Autor ³ FELIPE V. NAMBARA     ³ Data ³25/11/2009³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Calcula os valores dos impostos variaveis dos itens anterio-³±±
±±³          ³res no caso da DETRAÇÃO DIG no localizado PERU              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³llFlag - Identifica se haverá ou não a recursão             ³±±
*/
Static Function MaRecurDIG(llFlag)
Local nlCont    := 1
Local nlCont2   := 1
Local nlCont3	:= 1
Local nlCont4   := 1
Local nG        := 0
Local nRs		:= 0
Local nRs2		:= 0
Local _IdxF3a   := 0
Local _IdxF3b   := 0
Local _IdxF3c   := 0
Local _IdxF3d   := 0
Local _IdxF3e   := 0
Local _IdxF3f   := 0
Local nlItens   := 0
Local nContador := 0

For nlCont4 := 1 To Len(aNfItem)
	If !aNfItem[nlCont4][IT_DELETED]
		nlItens++
	EndIf
Next nlCont4

If llFlag
	
	For nlCont := 1 To Len(aNfItem) -1
		If !aNfItem[nlCont][IT_DELETED]  .And. nlItens > 1
			
			MaFisTes(aNfItem[nlCont][IT_TES],aNfItem[nlCont][IT_RECNOSF4],nlCont)
			
			If Len(aTes[TS_SFC]) > 0
				
				For nlCont2 := 1 To Len(aTes[TS_SFC])
					If aTes[TS_SFC][nlCont2][SFC_IMPOSTO] $ "DIG"
						nG := 0
						nImp:=NumCpoImpVar(RIGHT(Alltrim(aTes[TS_SFC][nlCont2][SFB_CPOVREI]) ,1))
			                		                
					    aNfCab[NF_BASEIMP][nImp] -= aNfItem[nlCont][IT_BASEIMP][nImp]
						aNfCab[NF_VALIMP][nImp]  -= aNfItem[nlCont][IT_VALIMP][nImp]
						aNfCab[NF_VLRORIG][nImp]  -= aNfItem[nlCont][IT_VALIMP][nImp]  
						       
						If aTes[TS_SFC][nlCont2][SFC_INCNOTA] $ "1"																																		
							aNfCab[NF_TOTAL]      -= aNfItem[nlCont][IT_BASEIMP][nImp]*(1 + aNfItem[nlCont][IT_ALIQIMP][nImp]/100)								
						ElseIf aTes[TS_SFC][nlCont2][SFC_INCNOTA] $ "2"                                    							
							aNfCab[NF_TOTAL]      += aNfItem[nlCont][IT_BASEIMP][nImp]*(1 + aNfItem[nlCont][IT_ALIQIMP][nImp]/100)								
						EndIf                
							
						If aTes[TS_SFC][nlCont2][SFC_INCDUPL] $ "1"							
							aNfCab[NF_BASEDUP]    -= aNfItem[nlCont][IT_BASEIMP][1]*(1 + aNfItem[nlCont][IT_ALIQIMP][1]/100)								
						ElseIf aTes[TS_SFC][nlCont2][SFC_INCDUPL] $ "2"                                                     							
							aNfCab[NF_BASEDUP]    -= aNfItem[nlCont][IT_BASEIMP][1]*(1 + aNfItem[nlCont][IT_ALIQIMP][1]/100)								
						EndIf
								
						aNfCab[NF_VALMERC]    -= aNfItem[nlCont][IT_VALMERC]
								
						nRS	 := aScan(aNfCab[NF_IMPOSTOS],{|x| x[IMP_COD] == "DIG" .AND. x[IMP_ALIQ] == aNfItem[nlCont][IT_ALIQIMP][nImp] })
						nRS2 := aScan(aNfCab[NF_IMPOSTOS2],{|x| x[IMP_COD] == "DIG" })							
								
						If nRs > 0 
							aNfCab[NF_IMPOSTOS][nRS][IMP_BASE] 	-= aNfItem[nlCont][IT_BASEIMP][nImp]
							aNfCab[NF_IMPOSTOS][nRS][IMP_VAL]  	-= aNfItem[nlCont][IT_VALIMP][nImp]																
						EndIf
													
						If nRs2 > 0 
							aNfCab[NF_IMPOSTOS2][nRS2][3] 	-= aNfItem[nlCont][IT_BASEIMP][nImp]
							aNfCab[NF_IMPOSTOS2][nRS2][4]  	-= aNfItem[nlCont][IT_VALIMP][nImp]
						EndIf
								
						_IdxF3a := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_VALCONT" } )
						_IdxF3b := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_BASIMP"+Alltrim(Str(nImp)) } )
						_IdxF3c := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_VALIMP"+Alltrim(Str(nImp)) } )
						_IdxF3f := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_TES" } )
															
						nContador:=nlCont3 
						For nContador := 2 To Len(aNFCab[NF_LIVRO])
						     nlCont3:=nContador
							If aNfCab[NF_LIVRO][nlCont3][_IdxF3f] $ aNfItem[nlCont][IT_TES]
								Exit
							EndIf
						Next                                             
								
						If ValType(aNfItem[nlCont][IT_BASEIMP][nImp]) == "N" .And. ValType(aNfItem[nlCont][IT_ALIQIMP][nImp]) == "N"
								
							aNfCab[NF_LIVRO][nlCont3][_IdxF3a] -= aNfItem[nlCont][IT_BASEIMP][nImp]*(1 + aNfItem[nlCont][IT_ALIQIMP][nImp]/100)
							aNfCab[NF_LIVRO][nlCont3][_IdxF3b] -= aNfItem[nlCont][IT_BASEIMP][nImp]
							aNfCab[NF_LIVRO][nlCont3][_IdxF3c] -= aNfItem[nlCont][IT_VALIMP][nImp]
						EndIf
						//Recalcula o imposto DIG para todos os itens anteriores
						If !MaFisCalcIV(nlCont2,nlCont,(nG>0))
							
							MaFisAliqIV(nlCont2,nlCont)
							
							If nG == 0
								MaFisVLIV(nlCont2,nlCont)
							Endif
						Endif
					ElseIf aTes[TS_SFC][nlCont2][SFC_IMPOSTO] $ "ISC"
						
						nImp:=NumCpoImpVar(RIGHT(Alltrim(aTes[TS_SFC][nlCont2][SFB_CPOVREI]),1 ))
						
						aNfCab[NF_BASEIMP][nImp] -= aNfItem[nlCont][IT_BASEIMP][nImp]
						aNfCab[NF_VALIMP][nImp]  -= aNfItem[nlCont][IT_VALIMP][nImp]
						aNfCab[NF_VLRORIG][nImp]  -= aNfItem[nlCont][IT_VALIMP][nImp]
						
						If aTes[TS_SFC][nlCont2][SFC_INCNOTA] $ "1"
							aNfCab[NF_TOTAL]      -= aNfItem[nlCont][IT_BASEIMP][nImp]*(1 + aNfItem[nlCont][IT_ALIQIMP][nImp]/100)
						ElseIf aTes[TS_SFC][nlCont2][SFC_INCNOTA] $ "2"
							aNfCab[NF_TOTAL]      += aNfItem[nlCont][IT_BASEIMP][nImp]*(1 + aNfItem[nlCont][IT_ALIQIMP][nImp]/100)
						EndIf
						
						If aTes[TS_SFC][nlCont2][SFC_INCDUPL] $ "1"
							aNfCab[NF_BASEDUP]    -= aNfItem[nlCont][IT_BASEIMP][1]*(1 + aNfItem[nlCont][IT_ALIQIMP][nImp]/100)
						ElseIf aTes[TS_SFC][nlCont2][SFC_INCDUPL] $ "2"
							aNfCab[NF_BASEDUP]    += aNfItem[nlCont][IT_BASEIMP][1]*(1 + aNfItem[nlCont][IT_ALIQIMP][nImp]/100)
						EndIf
						
						aNfCab[NF_VALMERC]    -= aNfItem[nlCont][IT_VALMERC]
						
						nRS	 := aScan(aNfCab[NF_IMPOSTOS],{|x| x[IMP_COD] == "ISC" .And. x[IMP_ALIQ] == aNfItem[nlCont][IT_ALIQIMP][nImp] })
						nRS2 := aScan(aNfCab[NF_IMPOSTOS2],{|x| x[IMP_COD] == "ISC" })
						
						If nRs > 0
							aNfCab[NF_IMPOSTOS][nRS][IMP_BASE] 	-= aNfItem[nlCont][IT_BASEIMP][nImp]
							aNfCab[NF_IMPOSTOS][nRS][IMP_VAL]  	-= aNfItem[nlCont][IT_VALIMP][nImp]
						EndIf
						
						If nRs2 > 0
							aNfCab[NF_IMPOSTOS2][nRS2][3] 	-= aNfItem[nlCont][IT_BASEIMP][nImp]
							aNfCab[NF_IMPOSTOS2][nRS2][4]  	-= aNfItem[nlCont][IT_VALIMP][nImp]
						EndIf
						
						_IdxF3a := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_VALCONT" } )
						_IdxF3b := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_BASIMP"+Alltrim(Str(nImp)) } )
						_IdxF3c := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_VALIMP"+Alltrim(Str(nImp)) } )
						_IdxF3f := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_TES" } )
						
						nContador:=nlCont3							
						For nContador := 2 To Len(aNFCab[NF_LIVRO])
						nlCont3:=nContador
							If aNfCab[NF_LIVRO][nlCont3][_IdxF3f] $ aNfItem[nlCont][IT_TES]
								Exit
							EndIf
						Next     
						
						If ValType(aNfItem[nlCont][IT_BASEIMP][nImp]) == "N" .And. ValType(aNfItem[nlCont][IT_ALIQIMP][nImp]) == "N"
							
							aNfCab[NF_LIVRO][nlCont3][_IdxF3a] -= aNfItem[nlCont][IT_BASEIMP][nImp]*(1 + aNfItem[nlCont][IT_ALIQIMP][nImp]/100)
							aNfCab[NF_LIVRO][nlCont3][_IdxF3b] -= aNfItem[nlCont][IT_BASEIMP][nImp]
							aNfCab[NF_LIVRO][nlCont3][_IdxF3c] -= aNfItem[nlCont][IT_VALIMP][nImp]
							
						EndIf
						
					ElseIf aTes[TS_SFC][nlCont2][SFC_IMPOSTO] $ "IGV"
						
						nImp:=NumCpoImpVar( RIGHT ( Alltrim(aTes[TS_SFC][nlCont2][SFB_CPOVREI] ),1 ))
						
						aNfCab[NF_BASEIMP][nImp] -= aNfItem[nlCont][IT_BASEIMP][nImp]
						aNfCab[NF_VALIMP][nImp]  -= aNfItem[nlCont][IT_VALIMP][nImp]
						aNfCab[NF_VLRORIG][nImp]  -= aNfItem[nlCont][IT_VALIMP][nImp]
						
						aNfCab[NF_BASEIMP][3] -= aNfItem[nlCont][IT_BASEIMP][3]
						aNfCab[NF_VALIMP][3]  -= aNfItem[nlCont][IT_VALIMP][3]
						aNfCab[NF_VLRORIG][3]  -= aNfItem[nlCont][IT_VALIMP][3]
						
						If aTes[TS_SFC][nlCont2][SFC_INCNOTA] $ "1"
							aNfCab[NF_TOTAL]      -= aNfItem[nlCont][IT_BASEIMP][nImp]*(1 + aNfItem[nlCont][IT_ALIQIMP][nImp]/100)
						ElseIf aTes[TS_SFC][nlCont2][SFC_INCNOTA] $ "2"
							aNfCab[NF_TOTAL]      += aNfItem[nlCont][IT_BASEIMP][nImp]*(1 + aNfItem[nlCont][IT_ALIQIMP][nImp]/100)
						EndIf
						
						If aTes[TS_SFC][nlCont2][SFC_INCDUPL] $ "1"
							aNfCab[NF_BASEDUP]    -= aNfItem[nlCont][IT_BASEIMP][1]*(1 + aNfItem[nlCont][IT_ALIQIMP][1]/100)
						ElseIf aTes[TS_SFC][nlCont2][SFC_INCDUPL] $ "2"
							aNfCab[NF_BASEDUP]    -= aNfItem[nlCont][IT_BASEIMP][1]*(1 + aNfItem[nlCont][IT_ALIQIMP][1]/100)
						EndIf
						
						aNfCab[NF_VALMERC]    -= aNfItem[nlCont][IT_VALMERC]
						
						nRS	 := aScan(aNfCab[NF_IMPOSTOS],{|x| x[IMP_COD] == "IGV" .And. x[IMP_ALIQ] == aNfItem[nlCont][IT_ALIQIMP][nImp] })
						nRS2 := aScan(aNfCab[NF_IMPOSTOS2],{|x| x[IMP_COD] == "IGV" })
						
						If nRs > 0
							aNfCab[NF_IMPOSTOS][nRS][IMP_BASE] 	-= aNfItem[nlCont][IT_BASEIMP][nImp]
							aNfCab[NF_IMPOSTOS][nRS][IMP_VAL]  	-= aNfItem[nlCont][IT_VALIMP][nImp]
						EndIf
						
						If nRs2 > 0
							aNfCab[NF_IMPOSTOS2][nRS2][3] 	-= aNfItem[nlCont][IT_BASEIMP][nImp]
							aNfCab[NF_IMPOSTOS2][nRS2][4]  	-= aNfItem[nlCont][IT_VALIMP][nImp]
						EndIf
						
						_IdxF3a := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_VALCONT" } )
						_IdxF3b := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_BASIMP"+Alltrim(Str(nImp)) } )
						_IdxF3c := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_VALIMP"+Alltrim(Str(nImp)) } )
						_IdxF3d := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_BASIMP3" } )
						_IdxF3e := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_VALIMP3" } )
						_IdxF3f := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_TES" } )
					   
					   nContador:=nlCont3
						For nContador := 2 To Len(aNFCab[NF_LIVRO])  
							nlCont3:=nContador
								If aNfCab[NF_LIVRO][nlCont3][_IdxF3f] $ aNfItem[nlCont][IT_TES]
									Exit
								EndIf
						Next    
						
						If ValType(aNfItem[nlCont][IT_BASEIMP][nImp]) == "N" .And. ValType(aNfItem[nlCont][IT_ALIQIMP][nImp]) == "N"
							
							aNfCab[NF_LIVRO][nlCont3][_IdxF3a] -= aNfItem[nlCont][IT_BASEIMP][nImp]*(1 + aNfItem[nlCont][IT_ALIQIMP][nImp]/100)
							aNfCab[NF_LIVRO][nlCont3][_IdxF3b] -= aNfItem[nlCont][IT_BASEIMP][nImp]
							aNfCab[NF_LIVRO][nlCont3][_IdxF3c] -= aNfItem[nlCont][IT_VALIMP][nImp]
							aNfCab[NF_LIVRO][nlCont3][_IdxF3d] -= aNfItem[nlCont][IT_BASEIMP][3]
							aNfCab[NF_LIVRO][nlCont3][_IdxF3e] -= aNfItem[nlCont][IT_VALIMP][3]
							
						EndIf
						
					ElseIf aTes[TS_SFC][nlCont2][SFC_IMPOSTO] $ "PIV"
						
						nImp:=NumCpoImpVar(RIGHT(Alltrim(aTes[TS_SFC][nlCont2][SFB_CPOVREI]) ,1))
						
						aNfCab[NF_BASEIMP][nImp] -= aNfItem[nlCont][IT_BASEIMP][nImp]
						aNfCab[NF_VALIMP][nImp]  -= aNfItem[nlCont][IT_VALIMP][nImp]
						aNfCab[NF_VLRORIG][nImp]  -= aNfItem[nlCont][IT_VALIMP][nImp]
						
						If aTes[TS_SFC][nlCont2][SFC_INCNOTA] $ "1"
							aNfCab[NF_TOTAL]      -= aNfItem[nlCont][IT_BASEIMP][nImp]*(1 + aNfItem[nlCont][IT_ALIQIMP][nImp]/100)
						ElseIf aTes[TS_SFC][nlCont2][SFC_INCNOTA] $ "2"
							aNfCab[NF_TOTAL]      += aNfItem[nlCont][IT_BASEIMP][nImp]*(1 + aNfItem[nlCont][IT_ALIQIMP][nImp]/100)
						EndIf
						
						If aTes[TS_SFC][nlCont2][SFC_INCDUPL] $ "1"
							aNfCab[NF_BASEDUP]    -= aNfItem[nlCont][IT_BASEIMP][1]*(1 + aNfItem[nlCont][IT_ALIQIMP][nImp]/100)
						ElseIf aTes[TS_SFC][nlCont2][SFC_INCDUPL] $ "2"
							aNfCab[NF_BASEDUP]    -= aNfItem[nlCont][IT_BASEIMP][1]*(1 + aNfItem[nlCont][IT_ALIQIMP][nImp]/100)
						EndIf
						
						aNfCab[NF_VALMERC]    -= aNfItem[nlCont][IT_VALMERC]
						
						nRS	 := aScan(aNfCab[NF_IMPOSTOS],{|x| x[IMP_COD] == "PIV" .And. x[IMP_ALIQ] == aNfItem[nlCont][IT_ALIQIMP][nImp] })
						nRS2 := aScan(aNfCab[NF_IMPOSTOS2],{|x| x[IMP_COD] == "PIV" })
						
						If nRs > 0
							aNfCab[NF_IMPOSTOS][nRS][IMP_BASE] 	-= aNfItem[nlCont][IT_BASEIMP][nImp]
							aNfCab[NF_IMPOSTOS][nRS][IMP_VAL]  	-= aNfItem[nlCont][IT_VALIMP][nImp]
						EndIf
						
						If nRs2 > 0
							aNfCab[NF_IMPOSTOS2][nRS2][3] 	-= aNfItem[nlCont][IT_BASEIMP][nImp]
							aNfCab[NF_IMPOSTOS2][nRS2][4]  	-= aNfItem[nlCont][IT_VALIMP][nImp]
						EndIf
						
						_IdxF3a := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_VALCONT" } )
						_IdxF3b := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_BASIMP"+Alltrim(Str(nImp)) } )
						_IdxF3c := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_VALIMP"+Alltrim(Str(nImp)) } )
						_IdxF3f := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_TES" } )
						
					    nContador:=nlCont3
						For nContador := 2 To Len(aNFCab[NF_LIVRO])
							nlCont3:=nContador
							If aNfCab[NF_LIVRO][nlCont3][_IdxF3f] $ aNfItem[nlCont][IT_TES]
								Exit
					    	EndIf
						Next  
						
						If ValType(aNfItem[nlCont][IT_BASEIMP][nImp]) == "N" .And. ValType(aNfItem[nlCont][IT_ALIQIMP][nImp]) == "N"
							
							aNfCab[NF_LIVRO][nlCont3][_IdxF3a] -= aNfItem[nlCont][IT_BASEIMP][nImp]*(1 + aNfItem[nlCont][IT_ALIQIMP][nImp]/100)
							aNfCab[NF_LIVRO][nlCont3][_IdxF3b] -= aNfItem[nlCont][IT_BASEIMP][nImp]
							aNfCab[NF_LIVRO][nlCont3][_IdxF3c] -= aNfItem[nlCont][IT_VALIMP][nImp]
							
						EndIf
						
					EndIf
				Next nlCont2
				
				aNfCab[NF_RECIV] := .F.
				
			EndIf
			MaFisSomaIt(nlCont,.T.)
		EndIf
		
	Next nlCont
Else
	For nlCont := 1 To Len(aNfItem)
		
		If !aNfItem[nlCont][IT_DELETED] .And. aNfCab[NF_VALIMP][5] > 0
			
			nRS	 := aScan(aNfCab[NF_IMPOSTOS],{|x| x[IMP_COD] == "DIG" .And. x[IMP_ALIQ] == aNfItem[nlCont][IT_ALIQIMP][5] })
			nRS2 := aScan(aNfCab[NF_IMPOSTOS2],{|x| x[IMP_COD] == "DIG" })
			
			If nRs > 0
				aDel(aNfCab[NF_IMPOSTOS],nRS)
				aSize(aNfCab[NF_IMPOSTOS],Len(aNfCab[NF_IMPOSTOS]) -1)
			EndIf
			
			If nRs2 > 0
				aDel(aNfCab[NF_IMPOSTOS2],nRS2)
				aSize(aNfCab[NF_IMPOSTOS2],Len(aNfCab[NF_IMPOSTOS2]) -1)
			EndIf
			
			_IdxF3a := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_VALCONT" } )
			_IdxF3b := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_BASIMP5" } )
			_IdxF3c := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_VALIMP5" } )
			_IdxF3f := AScan( aNfCab[NF_LIVRO][1],{|x| x == "F3_TES" } )
			
		    nContador:=nlCont3
			For nContador := 2 To Len(aNFCab[NF_LIVRO])   
			nlCont3:=nContador
				If aNfCab[NF_LIVRO][nlCont3][_IdxF3f] $ aNfItem[nlCont][IT_TES]
						Exit
				EndIf
			Next
			
			aNfCab[NF_LIVRO][nlCont3][_IdxF3b] -= aNfItem[nlCont][IT_BASEIMP][5]
			aNfCab[NF_LIVRO][nlCont3][_IdxF3c] -= aNfItem[nlCont][IT_VALIMP][5]
			
			aNfItem[nlCont][IT_BASEIMP][5] := 0
			aNfItem[nlCont][IT_VALIMP][5]  := 0
			aNfItem[nlCont][IT_ALIQIMP][5] := 0
			
		EndIf
	Next nlCont
	
	aNfCab[NF_BASEIMP][5] := 0
	aNfCab[NF_VALIMP][5]  := 0
	aNfCab[NF_VLRORIG][5]  := 0
EndIf

Return()

/*______________________________________________FUNCOES PARA CALCULO DE IMPOSTOS - BRASIL_________________________________________________________*/

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisBSICM³ Autor ³ Edson Maricate        ³ Data ³08.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Executa o calculo da Base do ICMS do Item.                  ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisBSICM( nItem , lReproc , lZF , lICDif , cCampo )

Local nSalvaBase  := 0
Local lIncide     := .F.
Local nReduzICMS  := 0
Local nDespOri    := 0
Local nBsFrete    := 0
Local nAliqAgr	  := 0
Local lRet        := .F.
Local lVlr_Frt    := .F.
Local lDevTot     := aParSX6[MV_DEVTOT]
Local lRedBIcm	  := aParSX6[MV_REBICM]
Local nAuxBicms   := 0
Local nRed43080   := 0
Local nIncLeitMG  := 0
Local aMaICMVeic  := {} //usado no PE MaICMVeic
Local aMaCalcICMS := {}
Local aPautICMS   := {}
Local aAreaSC6    := {}
Local nPautaICMS  := aNfItem[nItem][IT_PRD][SB_INT_ICM]
Local aMvUfirce	  := {}
Default lZF	:=	.F.
Default lICDif	:=	.F.
Default cCampo	:=	""

//Abaixo grava no item se a NF foi emitida sob norma específica e se deva indicar dessa forma na geração do SpedFiscal
aNfItem[nItem][IT_NORESPE] := aTes[TS_NORESPE]

//O bloco a seguir providencia para que em operações de devolução e ou beneficiamento quando o parametro MV_DEVTOT = .T.
//o valor da BASE do ICMS seja igual a Base do Imposto do documento Original quando a devolução e ou beneficiamento for
//igual a do documento original, se houverem despesas acessorias inclusas na base do documento original (Frete, Despesas e Seguro)
//as mesmas deverão ser digitadas manualmente no documento de devolução.
If ( aNFCab[NF_TIPONF] $ "DB" .Or. aTes[TS_PODER3] =="D" ) .And. !Empty(aNFItem[nItem][IT_RECORI]) .And. !RetComp(aNFCab[NF_CLIFOR], aNFItem[nItem][IT_RECORI])
	If aNFCab[NF_TIPONF] $ "DB"
		If ( aNFCab[NF_CLIFOR] == "C")
			dbSelectArea("SD2")
			MsGoto(aNFItem[nItem][IT_RECORI])
			If aNfItem[nItem][IT_QUANT] == SD2->D2_QUANT  .And. Iif(!lDevTot ,SD2->D2_VALFRE+SD2->D2_SEGURO+SD2->D2_DESPESA==0 , SD2->D2_BASEICM >0) .Or. ;
				(!aNfCab[NF_CALCSUF]$'IN '.And. aParSX6[MV_DESCZF] .And. aParSX6[MV_DESZFPC] )
				
				aNfItem[nItem][IT_BASEICM] := SD2->D2_BASEICM
				aNfItem[nItem][IT_DEDICM]  := IIF(aTes[TS_AGREG]=="D" .Or. aTes[TS_AGREG]=="R" .Or. aTes[TS_AGREG]=="E",SD2->D2_DESCICM,0)
				aNfItem[nItem][IT_PREDIC]	:= aTes[TS_BASEICM]
				lRet := .T.  
			ElseIf aNfItem[nItem][IT_QUANT] <> SD2->D2_QUANT .And. aTes[TS_DEVPARC]$"1S"
				aNfItem[nItem][IT_BASEICM] := (aNfItem[nItem][IT_QUANT] * SD2->D2_BASEICM)/SD2->D2_QUANT  
				lRet := .T. 
			EndIf
		Else
			dbSelectArea("SD1")
			MsGoto(aNFItem[nItem][IT_RECORI])
			If aNfItem[nItem][IT_QUANT] == SD1->D1_QUANT .And. Iif(!lDevTot , SD1->D1_VALFRE+SD1->D1_SEGURO+SD1->D1_DESPESA==0 ,SD1->D1_BASEICM > 0)
				aNfItem[nItem][IT_BASEICM] := SD1->D1_BASEICM
				aNfItem[nItem][IT_DEDICM]  := IIF(aTes[TS_AGREG]=="D" .Or. aTes[TS_AGREG]=="R" .Or. aTes[TS_AGREG]=="E",SD1->D1_DESCICM,0)
				aNfItem[nItem][IT_PREDIC]	:= aTes[TS_BASEICM]
				lRet := .T.
			ElseIf aNfItem[nItem][IT_QUANT] <> SD1->D1_QUANT .AND. aTes[TS_DEVPARC]$"1S"
				aNfItem[nItem][IT_BASEICM] := (aNfItem[nItem][IT_QUANT] * SD1->D1_BASEICM)/SD1->D1_QUANT  
				lRet := .T. 
			EndIf
		EndIf
	Else
		If ( aNFCab[NF_CLIFOR] == "C")
			dbSelectArea("SD1")
			MsGoto(aNFItem[nItem][IT_RECORI])
			If aNfItem[nItem][IT_QUANT] == SD1->D1_QUANT .And. Iif(!lDevTot , SD1->D1_VALFRE+SD1->D1_SEGURO+SD1->D1_DESPESA==0 ,SD1->D1_BASEICM > 0)
				aNfItem[nItem][IT_BASEICM] := SD1->D1_BASEICM
				aNfItem[nItem][IT_DEDICM]  := IIF(aTes[TS_AGREG]=="D" .Or. aTes[TS_AGREG]=="R" .Or. aTes[TS_AGREG]=="E",SD1->D1_DESCICM,0)
				aNfItem[nItem][IT_PREDIC]	:= aTes[TS_BASEICM]
				If aTes[TS_OPERSUC] == "1"  .And. SD1->D1_BASEICM <= 0
					lRet := .F.
				Else
					lRet := .T.
				EndIf   
			ElseIf aNfItem[nItem][IT_QUANT] <> SD1->D1_QUANT .AND. aTes[TS_DEVPARC]$"1S" 
				aNfItem[nItem][IT_BASEICM] := (aNfItem[nItem][IT_QUANT] * SD1->D1_BASEICM)/SD1->D1_QUANT  
				lRet := .T.	
			EndIf
		Else
			dbSelectArea("SD2")
			MsGoto(aNFItem[nItem][IT_RECORI])
			If aNfItem[nItem][IT_QUANT] == SD2->D2_QUANT .And. Iif(!lDevTot ,SD2->D2_VALFRE+SD2->D2_SEGURO+SD2->D2_DESPESA==0 , SD2->D2_BASEICM >0)
				aNfItem[nItem][IT_BASEICM] := SD2->D2_BASEICM
				aNfItem[nItem][IT_DEDICM]  := IIF(aTes[TS_AGREG]=="D" .Or. aTes[TS_AGREG]=="R" .Or. aTes[TS_AGREG]=="E",SD2->D2_DESCICM,0)
				aNfItem[nItem][IT_PREDIC]	:= aTes[TS_BASEICM]
				lRet := .T. 
			ElseIf aNfItem[nItem][IT_QUANT] <> SD2->D2_QUANT 
				aNfItem[nItem][IT_BASEICM] := (aNfItem[nItem][IT_QUANT] * SD2->D2_BASEICM)/SD2->D2_QUANT  
				lRet := .T. 		
			EndIf
		EndIf
	EndIf
EndIf

// Carrega a reducao da base do ICMS
If !Empty(aNFitem[nItem,IT_EXCECAO]) .And. aNfItem[nItem,IT_EXCECAO,14] > 0
	nReduzICMS := aNfItem[nItem,IT_EXCECAO,14]
Else
	nReduzICMS := aTes[TS_BASEICM]
EndIf
aNfItem[nItem,IT_PREDIC] := nReduzICMS

//Tratamento para Convênio 139/06, irá verificar CFOP e Campo no TES
IF aLLTRIM(aNfItem[nItem][IT_CF]) $ aParSX6[MV_C13906] .AND. aTes[TS_CV139] == "1"
	aNfItem[nItem][IT_CV139] := "1"
Else
	aNfItem[nItem][IT_CV139] := ""
EndIF

If !lRet
	aNfItem[nItem][IT_DEDICM]:= 0
	
	lReproc := IIf(lReproc==Nil,.F.,lReproc)
	
	// Salva  a base do ICMS no reprocessamento.
	nSalvaBase	:= aNfItem[nItem][IT_BASEICM]
	
	//Operacoes com Sucata - Valor do Pis e Cofins integra a base de calculo do ICMS
	If aTes[TS_OPERSUC] <> "1"
		If !Empty(aNfItem[nItem][IT_VALPS2]) .And. aTes[TS_INTBSIC]$"13"
			aNfItem[nItem][IT_BASEICM] := aNfItem[nItem][IT_BICMORI]
			aNfItem[nItem][IT_BASEICM] += aNfItem[nItem][IT_VALPS2]
		EndIf
		
		If !Empty(aNfItem[nItem][IT_VALCF2]) .And. aTes[TS_INTBSIC]$"23"
			If aNfItem[nItem][IT_BASEICM] <> (aNfItem[nItem][IT_BICMORI]+aNfItem[nItem][IT_VALPS2])
				aNfItem[nItem][IT_BASEICM] := aNfItem[nItem][IT_BICMORI]
			EndIf
			aNfItem[nItem][IT_BASEICM] += aNfItem[nItem][IT_VALCF2]
		EndIf
	EndIf
	
	// Calculo da base de ICMS - Valor da Mercadoria
	If aTes[TS_AGREG]<>"F"
		//Alteracao realizada caso o produto tenha o TES configurado
		//para aplicacao de Deducao ICM
		If FunName() == "FRTA010" .And. (aTes[TS_AGREG] == "D" .Or. aTes[TS_AGREG] == "R")
			aNfItem[nItem][IT_BICMORI]	:= aNfItem[nItem][IT_VALMERC] + IIf(!lZF,aNfItem[nItem][IT_DESCZF],0)
		Else
			aNfItem[nItem][IT_BICMORI]	:= aNfItem[nItem][IT_VALMERC] - (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT]) + IIf(!lZF,aNfItem[nItem][IT_DESCZF],0) +  aNfItem[nItem][IT_ACRESCI] 
		Endif
	EndIf
	
	//Conforme parecer de nossa Consultora Tributaria:
	//Recomendo que a configuração quanto ao DESCONTO CONDICIONAL OU INCONDICIONAL no cadastro do TES, seja
	//tambem aplicado ao calculo do ICMS nas operacoes com a ZFM, de tal forma que quando
	//haja o desconto do PIS e da COFINS e o calculo do ICMS, que este seja feito segundo a
	//configuracao e interpretacao do cliente. 
	If aTes[TS_DESCOND] == "1" 
		aNfItem[nItem][IT_BICMORI] += (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT])
	EndIf
  
	If aTes[TS_DESCOND] == "1" .And. lZF
		aNfItem[nItem][IT_BICMORI] += aNfItem[nItem][IT_DESCZFPIS] + aNfItem[nItem][IT_DESCZFCOF]
	EndIf	
	
	If aExistPE[PE_PAUTICMS]  //PE para tratamento de pauta de ICMS
		aPautICMS := ExecBlock( "PAUTICMS" , .F. , .F. , { cAliasPROD , Right(cAliasPROD,2)+"_INT_ICM" , nPautaICMS } )
		If aPautICMS[1] == "S"
			nPautaICMS := aPautICMS[2]
		EndIf
	EndIf
	
	// Calculo da base de ICMS - Pauta fiscal
	If ( nPautaICMS<>Nil .And.  nPautaICMS<>0 ) .Or. (!Empty(aNFitem[nItem][IT_EXCECAO]) .And. aNfItem[nItem][IT_EXCECAO][16]<>0)
		If Len (aNfItem[nItem][IT_EXCECAO])>0 .And. aNfItem[nItem][IT_EXCECAO][16]<>0
			If aTes[TS_PAUTICM] $ " 1"
				If Max(aNfItem[nItem][IT_QUANT]*aNfItem[nItem][IT_EXCECAO][16],aNfItem[nItem][IT_BICMORI]) <> aNfItem[nItem][IT_BICMORI]
					aNfItem[nItem][IT_BICMORI] := aNfItem[nItem][IT_QUANT]*aNfItem[nItem][IT_EXCECAO][16]
					aNfItem[nItem][IT_PAUTIC]  := aNfItem[nItem][IT_EXCECAO][16]
				EndIf
			Else
				aNfItem[nItem][IT_BICMORI] := aNfItem[nItem][IT_QUANT]*aNfItem[nItem][IT_EXCECAO][16]
				aNfItem[nItem][IT_PAUTIC]  := aNfItem[nItem][IT_EXCECAO][16]
			EndIf
		Else
			If !Empty(aNFItem[nItem][IT_VLR_FRT])
				If (aNfItem[nItem][IT_BICMORI]+aNfItem[nItem][IT_FRETE]) < (aNfItem[nItem][IT_QUANT]*nPautaICMS+aNfItem[nItem][IT_VLR_FRT])
					aNfItem[nItem][IT_BICMORI] := aNfItem[nItem][IT_QUANT]*nPautaICMS
					aNfItem[nItem][IT_PAUTIC]  := nPautaICMS
					lVlr_Frt := .T.
				EndIf
			Else
				If aTes[TS_PAUTICM] $ " 1"
					If Max(aNfItem[nItem][IT_QUANT]*nPautaICMS,aNfItem[nItem][IT_BICMORI]) <> aNfItem[nItem][IT_BICMORI]
						aNfItem[nItem][IT_BICMORI] := aNfItem[nItem][IT_QUANT]*nPautaICMS
						aNfItem[nItem][IT_PAUTIC]  := nPautaICMS
					EndIf
				Else
					aNfItem[nItem][IT_BICMORI] := aNfItem[nItem][IT_QUANT]*nPautaICMS
					aNfItem[nItem][IT_PAUTIC]  := nPautaICMS
				EndIf
			EndIf
		EndIf
		If !Empty( aParSX6[MV_ICMPFAT] )
			aNfItem[nItem][IT_BICMORI] *= aNfItem[nItem][IT_PRD][SB_ICMPFAT]
		EndIf
		If aParSX6[MV_ICPAUTA]=="2"
			If aTES[TS_DESPRDIC] $ " 1"
				If lVlr_Frt
					aNfItem[nItem][IT_BICMORI]	+= aNfItem[nItem][IT_VLR_FRT]
				Else
					aNfItem[nItem][IT_BICMORI]	+= aNfItem[nItem][IT_FRETE]
				EndIf
				aNfItem[nItem][IT_BSFRETE]	:= aNfItem[nItem][IT_FRETE]
				If aTes[TS_DESPICM] <> "2" .And. aTes[TS_DESPICM] <> "3"
					aNfItem[nItem][IT_BICMORI]	+= aNfItem[nItem][IT_DESPESA]
					aNfItem[nItem][IT_BICMORI]	+= aNfItem[nItem][IT_SEGURO]
				EndIf
			Else
				If lVlr_Frt
					nDespOri += aNfItem[nItem][IT_VLR_FRT]
				Else
					nDespOri += aNfItem[nItem][IT_FRETE]
				EndIf
				nBsFrete += aNfItem[nItem][IT_FRETE]
				If aTes[TS_DESPICM] <> "2" .And. aTes[TS_DESPICM] <> "3"
					nDespOri += aNfItem[nItem][IT_DESPESA]
					nDespOri += aNfItem[nItem][IT_SEGURO]
				EndIf
			EndIf
		EndIf
	Else
		If aTES[TS_DESPRDIC] $ "1 "
			aNfItem[nItem][IT_BICMORI]	+= aNfItem[nItem][IT_FRETE]
			aNfItem[nItem][IT_BSFRETE]	:= aNfItem[nItem][IT_FRETE]
			If aTes[TS_DESPICM] <> "2" .And. aTes[TS_DESPICM] <> "3"
				aNfItem[nItem][IT_BICMORI]	+= aNfItem[nItem][IT_DESPESA]
				aNfItem[nItem][IT_BICMORI]	+= aNfItem[nItem][IT_SEGURO]
			EndIf
		Else
			nDespOri += aNfItem[nItem][IT_FRETE]
			nBsFrete += aNfItem[nItem][IT_FRETE]
			If aTes[TS_DESPICM] <> "2" .And. aTes[TS_DESPICM] <> "3"
				nDespOri += aNfItem[nItem][IT_DESPESA]
				nDespOri += aNfItem[nItem][IT_SEGURO]
			EndIf
		EndIf
		
		// A base do ICMS sera somente as despesas acessorias FRETE/SEGURO/DESPESAS usado para tributar o ICMS somente das despesas
		If aTes[TS_DESPICM] == "5" // Somente Despesas Acessorias
			aNfItem[nItem][IT_BICMORI]	:= aNfItem[nItem][IT_FRETE] + aNfItem[nItem][IT_SEGURO] + aNfItem[nItem][IT_DESPESA]
		EndIf
		
	EndIf
	If (aTes[TS_INCIDE] == "S" .Or. (aTes[TS_INCIDE] == "F" .And. aNFCab[NF_TPCLIFOR] =="F" .And. aNFCab[NF_CLIFOR] =="C")) .And.;
		aTes[TS_IPI] <> "R"
		lIncide := .T.
		If aNFitem[nItem][IT_TIPONF ] <> "P"
			aNfItem[nItem][IT_BICMORI]	+= aNfItem[nItem][IT_VALIPI]
		Else
			aNfItem[nItem][IT_BICMORI]	:= aNfItem[nItem][IT_VALIPI]
		EndIf
		If aNfItem[nItem][IT_BSFRETE] <> 0
			aNfItem[nItem][IT_BSFRETE]	+= aNfItem[nItem][IT_VALIPI]
		EndIf
		If aTes[TS_IPILICM] <> "1"
			aNfItem[nItem][IT_VIPIBICM]:= (aNfItem[nItem][IT_VALIPI])
		Else
			aNfItem[nItem][IT_VIPIBICM]:= 0
		EndIf
	EndIf
	If ((aTes[TS_ICM] <> "N" .Or. lICDif) .And. !aNFitem[nItem][IT_TIPONF ]$"IP") .Or. (aNFitem[nItem][IT_TIPONF ]=="P".And.lIncide) .Or. (aNFCab[NF_SIMPNAC] =="1" .And. aTes[TS_COMPL] == "S" .And. aTes[TS_CIAP] == "S")
		
		nAliqAgr := 0
		If aTes[TS_AGRPIS]=="P" .And. !aTes[TS_INTBSIC]$"123"
			nAliqAgr += aNfItem[nItem][IT_ALIQPS2]
		Endif
		If aTes[TS_AGRCOF]=="C" .And. !aTes[TS_INTBSIC]$"123"
			nAliqAgr += aNfItem[nItem][IT_ALIQCF2]
		Endif
		
		If (aTes[TS_AGREG]=="I" .Or. aTes[TS_AGREG]=="A") .And. !aTes[TS_INTBSIC]$"123"
			
			nAliqAgr += aNfItem[nItem][IT_ALIQICM]
			
			If lRedBIcm
				aNfItem[nItem][IT_BICMORI]	:= Round(aNfItem[nItem][IT_BICMORI]/( 1 - (nAliqAgr/100)),2)
			Else
				aNfItem[nItem][IT_BICMORI]	:= Round(aNfItem[nItem][IT_BICMORI]/( 1 - (nAliqAgr/100*IIF(nReduzICMS==0,1,nReduzICMS/100))),2)
			EndIf
			aNfItem[nItem][IT_BSFRETE]	:= Round(aNfItem[nItem][IT_BSFRETE]/( 1 - (nAliqAgr/100*IIF(nReduzICMS==0,1,nReduzICMS/100))),2)
			nDespOri := nDespOri/( 1 - (nAliqAgr/100))
			nBsFrete := nBsFrete/( 1 - (nAliqAgr/100))
		EndIf
		If ( aTes[TS_AGREG]=="D" .Or. aTes[TS_AGREG]=="R" )
			If (nReduzICMS > 0)
				If aParSX6[MV_DBRDIF]
					aNfItem[nItem][IT_DEDICM] := Round(aNfItem[nItem][IT_BICMORI]*aNfItem[nItem][IT_ALIQICM]/100*(1-(nReduzICMS/100)),2)
				Else
					aNfItem[nItem][IT_DEDICM] := Round(aNfItem[nItem][IT_BICMORI]*aNfItem[nItem][IT_ALIQICM]/100*(nReduzICMS/100),2)
				EndIf
			Else
				aNfItem[nItem][IT_DEDICM] := aNfItem [nItem][IT_BICMORI]-Round(aNfItem[nItem][IT_BICMORI]*(1-(aNfItem[nItem][IT_ALIQICM]/100*IIF(nReduzICMS==0,1,nReduzICMS/100))),2)
			EndIf
		EndIf
		If (aTes[TS_AGREG]=="E" )
			aNfItem[nItem][IT_DEDICM]	:= aNfItem[nItem][IT_BICMORI]-Round(aNfItem[nItem][IT_BICMORI]*( 1 - (aNfItem[nItem][IT_ALIQICM]/100*IIF(nReduzICMS==0,1,nReduzICMS/100))),2)
		EndIf
		// Salva a base de ICMS original e aplica a reducao.
		If aTes[TS_OPERSUC]<>"1"
			If !(!Empty(aNfItem[nItem][IT_VALPS2]) .And. aTes[TS_INTBSIC]$"13") .And. !(!Empty(aNfItem[nItem][IT_VALCF2]) .And. aTes[TS_INTBSIC]$"23")
				aNfItem[nItem][IT_BASEICM]	:= aNfItem[nItem][IT_BICMORI]
			EndIf
		ElseIf aTes[TS_OPERSUC] == "1"
			aNfItem[nItem][IT_BASEICM]	:= aNfItem[nItem][IT_BICMORI]
			aNfItem[nItem][IT_BASEICM] += (aNfItem[nItem][IT_VALPS2]+aNfItem[nItem][IT_VALCF2])
		ElseIf aTes[TS_PODER3] =="D" .And. aNfItem[nItem][IT_BASEICM] <= 0
			aNfItem[nItem][IT_BASEICM]	:= aNfItem[nItem][IT_BICMORI]
		Endif
		
		If nReduzICMS > 0
			//Ao dobrar a base do ICMS(campo F4_BASEICM =200%)o valor do IPI NAO deve ser dobrado quando compor a base do ICMS para operacoes de venda de software
			//aTes[TS_VDASOFT] == "1" (SIM).
			If aTes[TS_VDASOFT] == "1" .And. nReduzICMS >= 100  .And. (aTes[TS_INCIDE] == "S" .Or. (aTes[TS_INCIDE] == "F" .And. aNFCab[NF_TPCLIFOR] =="F" .And. aNFCab[NF_CLIFOR] =="C")) .And. aTes[TS_IPI] <> "R"
				aNfItem[nItem][IT_BASEICM]	:= (aNfItem[nItem][IT_BASEICM] * nReduzICMS /100 ) - aNfItem[nItem][IT_VALIPI]
			Else
				If aTes[TS_BSRDICM] == "2"
					//a base de calculo da reducao sera composta apenas pelo valor da mercadoria sem o valor das
					//despesas acessorias.
					//apos aplicar o percentual de reducao, o valor das despesas acessorias (frete, seguro, despesas) e somado
					nAuxBicms := aNfItem[nItem][IT_VALMERC]
					nAuxBicms := ( nAuxBicms * nReduzICMS / 100 ) + (aNfItem[nItem][IT_FRETE] + aNfItem[nItem][IT_SEGURO] + aNfItem[nItem][IT_DESPESA] + Iif(lIncide,aNfItem[nItem][IT_VALIPI],0) )
					aNfItem[nItem][IT_BASEICM]	:= nAuxBicms
				Else
					aNfItem[nItem][IT_BASEICM]	:= aNfItem[nItem][IT_BASEICM] * nReduzICMS /100
				EndIf
			Endif
			MaItArred(nItem,{"IT_BASEICM"})
			aNfItem[nItem][IT_BSFRETE]	:= aNfItem[nItem][IT_BSFRETE] * nReduzICMS /100
			MaItArred(nItem,{"IT_BSFRETE"})
			If (aTes[TS_INCIDE] == "S"  .Or. (aTes[TS_INCIDE] == "F" .And. aNFCab[NF_TPCLIFOR] =="F" .And. aNFCab[NF_CLIFOR] =="C")) .And.;
				aTes[TS_IPI] <> "R"
				aNfItem[nItem][IT_VIPIBICM]	:= NoRound(aNfItem[nItem][IT_VIPIBICM]* nReduzICMS /100,2)
			Else
				aNfItem[nItem][IT_VIPIBICM]	:= 0
			EndIf
		EndIf
		If aTES[TS_DESPRDIC] == "2"
			aNfItem[nItem][IT_BASEICM] += nDespOri
			aNfItem[nItem][IT_BICMORI] += nDespOri
			aNfItem[nItem][IT_BSFRETE] += nBsFrete
		EndIf
                                                                
		//retorna o valor para Unidade Fiscal Referencia do Ceará (UFIRCE)  		
		If 	(aNFCab[NF_UFORIGEM] <> aNFCab[NF_UFDEST] .And. aNFCab[NF_UFDEST] == "CE" .And. aNFCab[NF_LINSCR] .And. anfcab[NF_OPERNF] == "S" .And. aTes[TS_VENPRES] == "2")		
			aMvUfirce := &(aParSX6[MV_UFIRCE])
			If (aMvUfirce <> Nil .And. Len(aMvUfirce) == 2 .And. !Empty(aMvUfirce[01]) .And. !Empty(aMvUfirce[02]))
				If aNfItem[nItem][IT_VALMERC] > (aMvUfirce[1] * aMvUfirce[2])                                                                                                         
					aNfItem[nItem][IT_BASEICM] := aNfItem[nItem][IT_VALMERC] - (aMvUfirce[1] * aMvUfirce[2])   
				EndIf
			EndIf			
		EndIf

	Else
		aNfItem[nItem][IT_BASEICM]	:= 0
		aNfItem[nItem][IT_BSFRETE]	:= 0
	EndIf
	If lReproc
		aNfItem[nItem][IT_BASEICM]	:= nSalvaBase
	EndIf
Else
	If !((aTes[TS_ICM] <> "N" .Or. lICDif) .And. !aNFitem[nItem][IT_TIPONF ]$"IP") .Or. (aNFitem[nItem][IT_TIPONF ]=="P".And.lIncide)
		aNfItem[nItem][IT_BASEICM]	:= 0
		aNfItem[nItem][IT_BSFRETE]	:= 0
	EndIf
EndIf

//verificacao da reducao da base de calculo do icms conforme decreto RICMS-MG numero 43.080/2002
If aNfItem[nItem][IT_BASEICM] > 0 .And. aNFCab[NF_UFDEST] == "MG" .And. aNFCab[NF_UFORIGEM] == "MG"
	nRed43080 := aNfItem[nItem][IT_PRD][SB_PR43080]
	If !Empty(nRed43080)
		If aNFCab[NF_TIPONF] $ "DB" .Or. aTes[TS_PODER3] =="D"
			If aNfItem[nItem][IT_BASEICM] <  aNfItem[nItem][IT_VALMERC]
				aNfItem[nItem][IT_BSSEMDS] := aNfItem[nItem][IT_BASEICM] + ((aNfItem[nItem][IT_VALMERC]*nRed43080)/100) //para guardar a base sem desconto
				aNfItem[nItem][IT_BASEICM]	:= aNfItem[nItem][IT_BSSEMDS] - ((aNfItem[nItem][IT_BSSEMDS]*nRed43080)/100)
			Else
				aNfItem[nItem][IT_BSSEMDS] := aNfItem[nItem][IT_BASEICM] //para guardar a base sem desconto
				aNfItem[nItem][IT_BASEICM]	:= aNfItem[nItem][IT_BSSEMDS] - ((aNfItem[nItem][IT_BSSEMDS]*nRed43080)/100)
			Endif
		Else
			aNfItem[nItem][IT_BSSEMDS] := aNfItem[nItem][IT_BASEICM] //para guardar a base sem desconto
			aNfItem[nItem][IT_BASEICM]	:= aNfItem[nItem][IT_BASEICM] - ((aNfItem[nItem][IT_BASEICM]*nRed43080)/100) 
		EndIf
		aNfItem[nItem][IT_PR43080]	:= nRed43080
		MaItArred(nItem,{"IT_BASEICM"})
	EndIf
EndIf

//verificacao do incentivo prod.leite artigo 207-B RICMS-MG
If (aNfItem[nItem][IT_VALMERC]>0 .And. aNFCab[NF_UFORIGEM]=="MG" .And. aNFCab[NF_OPERNF]=="E") .Or.;
	(aNfItem[nItem][IT_VALMERC]>0 .And. aNFCab[NF_UFDEST]  =="MG" .And. aNFCab[NF_OPERNF]=="S" .And. aNFCab[NF_TIPONF]$"D")
	If aFieldPos[FP_A2_INCLTMG]
		nIncLeitMG := aNfItem[nItem][IT_PRD][SB_PRINCMG]
		If !Empty(nIncLeitMG) .And. SA2->A2_INCLTMG=="1"
			aNfItem[nItem][IT_PRINCMG]	:= nIncLeitMG
			aNfItem[nItem][IT_VLINCMG]	:= aNfItem[nItem][IT_VALMERC]*(nIncLeitMG/100)
		EndIf
	EndIf
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Especifico para VEICULOS³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If aParSX6[MV_VEICICM] .And. Substr(aNfItem[nItem][IT_CF],1,1)=="5" .And. aNfCab[NF_OPERNF] == "S" .And. aFieldPos[FP_B1_CHASSI] .And. !Empty( aNfItem[nItem][IT_PRD][SB_CHASSI] ) // Alteracao de base para veiculos usados
	If aNfItem[nItem][IT_BASVEIC] == 0
		aAreaSC6 := SC6->(GetArea())
		SC6->(dbSetOrder(1))
		If SC6->( MsSeek(xFilial("SC6")+aNfCab[NF_PEDIDO]+aNfItem[nItem][IT_ITEM]+aNfItem[nItem][IT_PRODUTO]) )
			aNfItem[nItem][IT_BASVEIC] := SC6->C6_BASVEIC
		EndIf
		RestArea(aAreaSC6)
	EndIf
	If nReduzICMS > 0
		aNfItem[nItem][IT_BASEICM] := Round((aNfItem[nItem][IT_BICMORI] - aNfItem[nItem][IT_BASVEIC])*(nReduzICMS/100),2)
	Else
		aNfItem[nItem][IT_BASEICM] -= aNfItem[nItem][IT_BASVEIC]			
	EndIf
	If aNfItem[nItem][IT_BASEICM] < 0
		aNfItem[nItem][IT_BASEICM] := 0
	EndIF
EndIf 

//ATENCAO!!! Ponto de entrada para uso exclusivo da TOTVS, nao sugerir o uso do mesmo a clientes - GDP FISCAL
If aExistPE[PE_MAICMVEIC]  
	aMaICMVeic := ExecBlock("MaICMVeic",.f.,.f.,{nItem,aNfItem[nItem][IT_BASEICM],aNfItem[nItem][IT_ALIQICM],aNfItem[nItem][IT_VALICM]})
	aNfItem[nItem][IT_BASEICM] := aMaICMVeic[1]
	aNfItem[nItem][IT_ALIQICM] := aMaICMVeic[2]
	aNfItem[nItem][IT_VALICM]  := aMaICMVeic[3]
EndIf

If aExistPE[PE_MACALCICMS]  
	aMaCalcICMS             := ExecBlock("MACALCICMS",.f.,.f.,{aNfCab[NF_OPERNF],nItem,aNfItem[nItem][IT_BASEICM],aNfItem[nItem][IT_ALIQICM],aNfItem[nItem][IT_VALICM]})
	aNfItem[nItem][IT_BASEICM] := aMaCalcICMS[1]
	aNfItem[nItem][IT_ALIQICM] := aMaCalcICMS[2]
	aNfItem[nItem][IT_VALICM]  := aMaCalcICMS[3]
Endif

IF aNfCab[NF_SUFRAMA] .And. aParSX6[MV_RPCBIZF] .And. (aNfItem[nItem][IT_DESCZFPIS] + aNfItem[nItem][IT_DESCZFCOF]) > 0 .And. aNfItem[nItem][IT_DESCZF] > 0	//MV_RPCBIZF
		aNfItem[nItem][IT_BASEICM] += aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFPIS] + aNfItem[nItem][IT_DESCZFCOF]) 
		aNfItem[nItem][IT_BASEICM]-=(aNfItem[nItem][IT_DESCZFPIS] + aNfItem[nItem][IT_DESCZFCOF])//aNfItem[nItem][IT_BICMORI] 
EndIf	
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Para o calculo do FECP de cada ESTADO e necessario as BASES DE CALCULO do ICMS e do ICMS SOLIDARIO  ³
//³afim de majorar as aliquotas dos mesmos, por este motivo a chamada GERAL da funcao de calulo do FECP³
//³deve estar no fim das funcoes de BASE do ICMS e ICMS SOLIDARIO e em nenhum outro ponto da MATXFIS.  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
MaFisFECP( nItem , cCampo, lReproc )

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaAliqICM ³ Autor ³Eduardo/Edson          ³ Data ³08.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Calculo da Aliquota para operacoes de ICMS                  ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaAliqIcms(nItem,lSolidario,lICDif)
Local nAliquota		:=	IIf( aNfItem[nItem][IT_PRD][SB_PICM] == 0 ,  aParSX6[MV_ICMPAD]  ,  aNfItem[nItem][IT_PRD][SB_PICM] )
Local nAlqFecop		:=	IIf( aNfItem[nItem][IT_PRD][SB_FECOP] == "1" , aNfItem[nItem][IT_PRD][SB_ALFECOP] , 0 )
Local cTipoNF		:=	aNfCab[NF_TIPONF]
Local cSimpNac		:=	aParSX6[MV_CODREG]
Local cAliqDifST	:=	"2"
Local lFreteAut		:=	aTes[TS_LFICM] <> "N" .And. aTes[TS_FRETAUT] <> "2" .And. aTes[TS_FRETAUT] <> "3" .And. aNfItem[nItem][IT_AUTONOMO]>0
Local cExceRes13	:=	"6107|6108|6929"
Default lSolidario	:=	.F.
Default lICDif		:=	.F.

If (aTes[TS_ICM] <> "N" .Or. lICDif) .Or. lSolidario .Or. (aNFCab[NF_SIMPNAC] =="1" .And. aTes[TS_COMPL] == "S" .And. aTes[TS_CIAP] == "S") .Or. lFreteAut

	// Verifica se a nota fiscal eh de Conhecimento de Frete
	If !lSolidario .And. (AllTrim(aNFCab[NF_ESPECIE]) $ "CTR/CTE" .Or. "NFST"$AllTrim(aNFCab[NF_ESPECIE]))
		nAliquota := Val(Substr(aParSX6[MV_FRETEST],(AT(aNfCab[NF_UFORIGEM],aParSX6[MV_FRETEST])+2),3))
		nAliquota := IIf(nAliquota>0,NoRound(nAliquota,2),12)
	EndIf
	
	Do Case
		// Verifica se a nota fiscal eh de Conhecimento de Frete
		Case aNfCab[NF_TPCOMP] == "F"
			// Verifica o Parametro MV_FRETEST que contem as Aliq. de ICMS/Frete
			If Empty(aParSX6[MV_FRETEST])
				If aNfCab[NF_UFDEST]$aParSX6[MV_NORTE] .And.!(aNfCab[NF_UFORIGEM]$aParSX6[MV_NORTE] )
					nAliquota := 7
				Else
					nALiquota := 12 // Aliquota de Frete Fixa em 12%
				EndIf
			Else
				nAliquota := Val(Substr(aParSX6[MV_FRETEST],(AT(aNfCab[NF_UFORIGEM],aParSX6[MV_FRETEST])+2),3))
				nAliquota := IIf(nAliquota>0,NoRound(nAliquota,2),12)
			EndIf
		Case AllTrim(aNFCab[NF_ESPECIE])$"CA"
			// Verifica o Parametro MV_FRETEST que contem as Aliq. de ICMS/Frete
			If aNFCab[NF_LINSCR]
				If aNfCab[NF_UFDEST]$aParSX6[MV_NORTE] .And. !(aNfCab[NF_UFORIGEM]$aParSX6[MV_NORTE] )
					nAliquota := 7
				Else
					nAliquota := 12 // Aliquota de Frete Fixa em 12%
				EndIf
			EndIf
			// Verifica se a nota fiscal eh de Servicos
		Case ( aTes[TS_ISS] == "S" )
			// Calcula a aliquota do ISS
			If !lSolidario
				nAliquota := If ( aNfItem[nItem][IT_PRD][SB_ALIQISS] == 0 , aParSX6[MV_ALIQISS] , aNfItem[nItem][IT_PRD][SB_ALIQISS] )
				// Verifica as Excecoes fiscais
				If ( !Empty(aNFitem[nItem][IT_EXCECAO]) )
					If ( aNFCab[NF_UFORIGEM]==aNFCab[NF_UFDEST])
						If (aNfItem[nItem][IT_EXCECAO][1] > 0)
							nAliquota := aNfItem[nItem][IT_EXCECAO][1] //Aliquota Interna
						EndIf
					Else
						If aNfItem[nItem][IT_EXCECAO][2] > 0
							nAliquota := aNfItem[nItem][IT_EXCECAO][2] //Aliquota Externa
						EndIf
					EndIf
				EndIf
			Else
				nAliquota := 0
			EndIf
		Case ( aTes[TS_PODER3] =="D" )  .And. !Empty(aNFItem[nItem][IT_RECORI]) //Devolucao de Poder de Terceiros			
				If aNFCab[NF_OPERNF] == "E"
					dbSelectArea("SD2")
					MsGoto( aNFItem[nItem][IT_RECORI] )
					nAliquota  := SD2->D2_PICM
					cTipoNF    := IIf(SD2->D2_TIPO$"IP",SD2->D2_TIPO,cTipoNF)
				Else
					dbSelectArea("SD1")
					MsGoto( aNFItem[nItem][IT_RECORI] )
					//1-no caso da devolucao de sucata preciso pegar a aliquota original para fazer o calulo do icms
					//2-caso em que eh feito o retorno de demonstracao e excede os 60 dias para SP e eh feita NF Compl ICMS
					If (aTes[TS_OPERSUC] <> "1") .And. !( cTipoNF == "B" .And. SD1->D1_TIPO == "N" .And. aParSX6[MV_ESTADO] == "SP" .And. (dDataBase-SD1->D1_EMISSAO) > 60 )
						nAliquota  := SD1->D1_PICM
					EndIF
					cTipoNF    := IIf(SD1->D1_TIPO$"IP",SD1->D1_TIPO,cTipoNF)
				EndIf	


			// Nas devolucoes sempre pega a aliquota da NF original.
		Case ( aNFCab[NF_TIPONF] == "D" .And. !Empty(aNFItem[nItem][IT_RECORI]) .And. !RetComp(aNFCab[NF_CLIFOR], aNFItem[nItem][IT_RECORI]))
			If aNFCab[NF_TIPONF] == "D"
				If ( aNFCab[NF_CLIFOR] == "C" )
					dbSelectArea("SD2")
					MsGoto( aNFItem[nItem][IT_RECORI] )
	 				If !Empty(SD2->D2_PICM)
						nAliquota  := SD2->D2_PICM
			 		EndIf
					cTipoNF    := IIf(SD2->D2_TIPO$"IP",SD2->D2_TIPO,cTipoNF)
					If SD2->D2_DESCZFR > 0 .And. aNfItem[nItem][IT_PRD][SB_IMPZFRC] == "N"  //  So zera a aliquota se o item nao for importado, pois se for ele mantem a aliquota de icms da saida
						nAliquota := 0
					EndIf
				Else
					dbSelectArea("SD1")
					MsGoto( aNFItem[nItem][IT_RECORI] )
					nAliquota  := SD1->D1_PICM
					cTipoNF    := IIf(SD1->D1_TIPO$"IP",SD1->D1_TIPO,cTipoNF)
				EndIf
			Else
				If ( aNFCab[NF_CLIFOR] == "C" )
					dbSelectArea("SD1")
					MsGoto( aNFItem[nItem][IT_RECORI] )
					nAliquota  := SD1->D1_PICM
					cTipoNF    := IIf(SD1->D1_TIPO$"IP",SD1->D1_TIPO,cTipoNF)
				Else
					dbSelectArea("SD2")
					MsGoto( aNFItem[nItem][IT_RECORI] )
					nAliquota  := SD2->D2_PICM
					cTipoNF    := IIf(SD2->D2_TIPO$"IP",SD2->D2_TIPO,cTipoNF)
				EndIf
			EndIf

			
			// Tratamento para Exportacao
		Case ( aNFCab[NF_TPCLIFOR] == "X" )
			If nModulo == 43
				If ( aNFCab[NF_CLIFOR]== "C" ) .And. ( aNFCab[NF_UFDEST]<> "X" )
					// Calculo da Aliquota de ICMS para Exportacao
					nAliquota := 12
				EndIf
			ElseIf ( aNFCab[NF_CLIFOR]=="C" )
				// Calculo da Aliquota de ICMS para Exportacao
				nAliquota := 13  
			EndIf
			// Verifica as Excecoes fiscais
			If ( !Empty(aNFitem[nItem][IT_EXCECAO]) .And. aNFItem[nItem][IT_EXCECAO][1] > 0 )
				nAliquota := aNFItem[nItem][IT_EXCECAO][1] //Aliquota Interna
			EndIf
			
			// Tratamento para Nao Inscritos e Consumidores Finais
		Case ( aNFCab[NF_LINSCR] )
			If ( aNFCab[NF_CLIFOR]=="F" )
				nAliquota := IIf(!Empty( aNfItem[nItem][IT_PRD][SB_PICM] ) , aNfItem[nItem][IT_PRD][SB_PICM] , MaAliqOrig(nItem) )
			EndIf
			
			// Tratamento para calculo do FECP
			
			// Verifica as Excecoes fiscais
			If ( !Empty(aNFItem[nItem][IT_EXCECAO]) )
				If ( aNFCab[NF_UFORIGEM] == aNFCab[NF_UFDEST] )
					If ( aNFItem[nItem][IT_EXCECAO][1] ) <> 0
						nAliquota := aNFItem[nItem][IT_EXCECAO][1]  //Aliq. de ICMS Interna
					EndIf
				Else
					If (aNFItem[nItem][IT_EXCECAO][2] > 0)
						nAliquota :=  aNFItem[nItem][IT_EXCECAO][2]   //Aliq. de ICMS Externa
					EndIf
				EndIf
			EndIf
			
			// Tratamento para Operacoes internas com ICMS
		Case ( aNFCab[NF_UFORIGEM] == aNFCab[NF_UFDEST] )
			// Tratamento para calculo do FECP
			
			// Verifica as Excecoes fiscais
			If ( !Empty(aNFItem[nItem][IT_EXCECAO]) )
				If ( aNFItem[nItem][IT_EXCECAO][1] ) <> 0
					nAliquota :=  aNFItem[nItem][IT_EXCECAO][1]   //Aliq. de ICMS Interna
				EndIf
			EndIf
	
			// Tratamento para Operacaoes InterEstaduais com ICMS
		Case ( aNFCab[NF_UFORIGEM] <> aNFCab[NF_UFDEST] )
			If ( aNFCab[NF_TIPONF] <> "D" )
				// Calculo da Aliquota de ICMS
				If ( aNFCab[NF_UFORIGEM] $ aParSX6[MV_NORTE] )
					nAliquota := 12 //MV_ICMTRF
				Else
					nAliquota := IIf( aNFCab[NF_UFDEST] $ aParSX6[MV_NORTE] , 7 , 12 ) //MV_ICMTRF
				EndIf
				
				// Tratamento para ser levado em consideracao a aliquota de destino
				//	para os cfops 5118/5119/6118/6119
				If aParSX6[MV_ESTADO]== 'SP' .And. aNFCab[NF_UFORIGEM]==aParSX6[MV_ESTADO] .And. (aNFItem[nItem][IT_CF] $ aParSX6[MV_TESVEND]) .And. aNFCab[NF_UFDEST] == aNFCab[NF_UFORIGEM]
					nAliquota := IIf(!Empty( aNfItem[nItem][IT_PRD][SB_PICM] ) , aNfItem[nItem][IT_PRD][SB_PICM] , MaAliqOrig(nItem))
				EndIf
				
				//Pego a aliquota interestadual antes da execao fiscal para os casos do diferencial de aliquota do simples para material de uso e consumo
				If aNFCab[NF_SIMPNAC] =="1" .And. aNFCab[NF_CLIFOR] =="F"
					aNFitem[nItem][IT_ALIQDIF] := nAliquota
				EndIf
			Else
				// Calculo da Aliquota de ICMS
				If ( aNFCab[NF_UFORIGEM] $ aParSX6[MV_NORTE] )
					nAliquota := IIf( aNFCab[NF_UFORIGEM] $ aParSX6[MV_NORTE] , 12 , 7 ) //MV_ICMTRF
				Else
					nAliquota := 12 //MV_ICMTRF
				Endif
			EndIf 
						
			// ----------------------------------------------------------------------------------------
			//
			// 			Abaixo tratamento solicitado pela Resolucao do Senado Federal 13/2012
			//							 --	Aliquota Interestadual de 4% --   caio
			// Parecer da Consultoria tributaria: http://tdn.totvs.com/pages/viewpage.action?pageId=82477729
			//
			// ----------------------------------------------------------------------------------------
			//   Regras para aplicacao da Aliquota de 4%
			// - Operacao Interestadual
			// - Contribuinte do ICMS
			// - Operacao apos 01/01/2013
			// - Origem do item = 1,2,3,8
			// ----------------------------------------------------------------------------------------
			// - Excecao 1: CFOP's de Venda destinada a Nao Contribuinte, ainda que possua IE (6107;6108) 	(cExceRes13)
			// - Excecao 2: CFOP de operacao registrada em Cupom Fiscal (6929)								(cExceRes13)
			// ----------------------------------------------------------------------------------------
			If  Year( aNfCab[NF_DTEMISS] ) >= 2013							.And.	;
				SubStr( aNfItem[nItem][IT_CLASFIS] , 1 , 1 ) $ "1|2|3|8"	.And.	;
				!Alltrim( aNfItem[nItem][IT_CF]) $cExceRes13
				
					nAliquota :=  4
			EndIf
			           
			//Alimento com alíquota interestadual para que possa efetuar o cálculo da Antecipação tributária para Simples Nacional
			If aNFCab[NF_SIMPNAC] =="1" .AND. aNFCab[NF_CLIFOR] =="F" .AND. aTes[TS_ANTICMS] == "1"
				aNFitem[nItem][IT_ALIQDIF] := nAliquota
			EndIF
			
 			If !(aNFCab[NF_OPERNF]  == "E" .AND. aNFCab[NF_CLIFOR] == "F" .And. aNFCab[NF_UFORIGEM] <> aNFCab[NF_UFDEST]  .And.;
 			     aNFCab[NF_SIMPNAC] == "1" .And. aTes[TS_LFICM]    == "T")
			    // Verifica as Excecoes fiscais
				If ( !Empty(aNFItem[nItem][IT_EXCECAO]) )
					If ( aNFItem[nItem][IT_EXCECAO][2] ) <> 0
						nAliquota :=  aNFItem[nItem][IT_EXCECAO][2]   //Aliq. de ICMS Externa
					EndIf
				EndIf
			EndIf	
	EndCase
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ FECOP - CEARA - Caso no SB1 seja configurado para calcular FECOP a aliquota do Solidario sera Majorada em 2% - opcoes informadas no SB1 de 19 % ou  27% ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If (nAlqFecop == 19 .Or. nAlqFecop == 27) .And. aParSX6[MV_ESTADO] == "CE" .And. aNFCab[NF_UFDEST] == "CE" .And. aNfCab[NF_OPERNF] == "S"
		nAliquota := nAlqFecop
	EndIf
	
Else
	nAliquota := 0
EndIf

	// --> Calculo atraves da tabela CFC para FECP (todas as regras foram estabelecidas na MaFisFecp)
	If aNfItem[nItem][IT_UFXPROD][UFP_ALIQFECP] == 0 .And. (aParSX6[MV_ESTADO] <> "RJ" .And. aNFCab[NF_OPERNF] == "S" .And. aNFCab[NF_UFDEST] == "RJ") .And. aNFCab[NF_TIPONF] <> "D"
		nAliquota	+=	aNfItem[nItem][IT_ALIQFECP]
				//Irá majorar alíquota do ICMS se houver valor de FECP referente ao ICMS próprio.
				//Verifico se está calculando ICMS complementar, pois se estiver, não deverá majorar a alíquota do próprio, somente alíquota do ICMS complementar.
	Else
		If (aNfItem[nItem][IT_VALFECP]>0 .And. (aNFCab[NF_TIPONF] <> "D" .Or. (aNFCab[NF_TIPONF] == "D" .And. Empty(aNFItem[nItem][IT_RECORI]))) .And. aTes[TS_COMPL] <> "S")
			nAliquota += aNfItem[nItem][IT_ALIQFECP]
		Endif
	Endif
	
				
	nAliquota += aNfItem[nItem][IT_ALFECMT]
	nAliquota += aNfItem[nItem][IT_ALFECRN]
	nAliquota += aNfItem[nItem][IT_ALFECMG]
	
				
If ((aTes[TS_ICM] <> "N" .Or. lICDif) .Or. (aNFCab[NF_SIMPNAC] =="1" .And. aTes[TS_COMPL] == "S" .And. aTes[TS_CIAP] == "S")) .Or. lFreteAut ;
	.Or. (IntTms() .And. nModulo == 43 .And. aTes[TS_ICM]=="N" .And. aTes[TS_LFICM]=="T")
	If !lSolidario 
		aNFitem[nItem][IT_ALIQICM] := nAliquota
	EndIf	
	aNFitem[nItem][IT_TIPONF ] := cTipoNF
Else
	aNFitem[nItem][IT_ALIQICM] := 0
	aNFitem[nItem][IT_TIPONF ] := cTipoNF
EndIf

//Simples Nacional - Aliquota ICMS solidario.
If cSimpNac $ "1/2" .And. lSolidario .And. aNFCab[NF_OPERNF] == "S"
	//Busca RecNo do Produto para verificar campo que trata a aliquota interna
	//a ser tributada para o Simples Nacional através de Exceção Fiscal.
	//O campo deve ser informado no parâmetro MV_ALQDFB1.
	If aNFCab[NF_UFORIGEM] == aNFCab[NF_UFDEST]
		If aFieldPos[FP_MV_ALQDFB1]
			cAliqDifST := aNfItem[nItem][IT_PRD][SB_ALQDFB1]
		Endif
		If cAliqDifST $ "2 "
			aNFitem[nItem][IT_ALIQSOL] := Val(Subs(aParSX6[MV_ESTICM] ,AT(aNFCab[NF_UFDEST],aParSX6[MV_ESTICM])+2,2))
		EndIf
	Endif
EndIf     

//Entrada de Conhecimento de Frete - Aliquota ICMS 4%.
If (aNFCab[NF_OPERNF] == "E")           .And.;
   ((AllTrim(aNFCab[NF_ESPECIE])=="CA"  .And. (aNFCab[NF_UFORIGEM] <> aNFCab[NF_UFDEST] .Or. aNFCab[NF_UFORIGEM]=="BA")) .Or. ;
    (AllTrim(aNFCab[NF_ESPECIE])=="CTE" .And.  aNFCab[NF_UFORIGEM]=="BA" .And. ((aNFCab[NF_MODAL])=="02" .Or. Empty(aNFCab[NF_MODAL]))))   
   	aNFitem[nItem][IT_ALIQICM] := 4
		// Verifica as Excecoes fiscais
		If ( !Empty(aNFItem[nItem][IT_EXCECAO]) )
			If ( aNFCab[NF_UFORIGEM] == aNFCab[NF_UFDEST] )
            	If ( aNFItem[nItem][IT_EXCECAO][1] ) <> 0
            		nAliquota := aNFItem[nItem][IT_EXCECAO][1]  //Aliq. de ICMS Interna
            	EndIf
   			Else
                If (aNFItem[nItem][IT_EXCECAO][2] > 0)
                	nAliquota :=  aNFItem[nItem][IT_EXCECAO][2]   //Aliq. de ICMS Externa
                EndIf
			EndIf
		Else
			nAliquota := 4
		Endif
EndIf

Return(nAliquota)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaAliqOrig³ Autor ³ Edson Maricate        ³ Data ³13.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Calculo da Aliquota para operacoes de ICMS                  ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaAliqOrig(nItem)

Local nPerIcm
Local cOrig := aNFCab[NF_UFORIGEM]
Local cMVEstIcm := aParSX6[MV_ESTICM]

nPerIcm := Val(Subs(cMVEstIcm,AT(cOrig,cMVEstIcm)+2,2))

Return(nPerIcm)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaAliqDest³ Autor ³Eduardo/Edson          ³ Data ³13.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Calculo da Aliquota para operacoes de ICMS                  ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaAliqDest(nItem)

Local nPerIcm
Local cDestino := aNFCab[NF_UFDEST]

nPerIcm := Val(Subs(aParSX6[MV_ESTICM],AT(cDestino,aParSX6[MV_ESTICM])+2,2))

If !Empty(aParSX6[MV_FRETEST]) .And. (aNfCab[NF_TPCOMP] == "F"  .Or. (("/"+AllTrim(aNFCab[NF_ESPECIE])+"/") $"/CTR/CTE/NFST/"))
	nPerICM := Val(Substr(aParSX6[MV_FRETEST],(AT(aNfCab[NF_UFDEST],aParSX6[MV_FRETEST])+2),3))
	nPerICM := IIf(nPerICM>0,NoRound(nPerICM,2),Val(Subs(aParSX6[MV_ESTICM],AT(cDestino,aParSX6[MV_ESTICM])+2,2)) /*12*/ )
EndIf
If ( !Empty(aNFItem[nItem][IT_EXCECAO]) )
	If ( aNFItem[nItem][IT_EXCECAO][6] ) <> 0
		nPerIcm := aNfItem[nItem][IT_EXCECAO][6]
	EndIf
EndIf

Return(nPerIcm)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisVICMS³ Autor ³ Edson Maricate        ³ Data ³08.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Executa o calculo do Valor do ICMS  do Item.                ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisVICMS(nItem,lReproc)

Local nSavValICM  := 0
Local nSValICMFR  := 0
Local lCalcDif	  :=	.F.
Local lDevTotal	  := .F.
Local aMaICMVeic  := {} //usado no PE MaICMVeic
Local aMaCalcICMS := {}
Local lDevTot     := aParSX6[MV_DEVTOT]
Local lExecDevol := .T.	

DEFAULT lReproc   := .F.

//Salva o valor do ICMS no reprocessamento.
nSavValICM := aNfItem[nItem][IT_VALICM]
nSValICMFR := aNfItem[nItem][IT_ICMFRETE]

//DIAT - SC
aNFitem[nItem][IT_B1DIAT]:= aNfItem[nItem][IT_PRD][SB_PRDDIAT]

If aTes[TS_ICM] <> "N" .Or. (aNFCab[NF_SIMPNAC] =="1" .And. aTes[TS_COMPL] == "S" .And. aTes[TS_CIAP] == "S")
	//Calculo do valor do ICMS do item.
	If aNFitem[nItem][IT_TIPONF ] == "I"
		If aTes[TS_AGREG]<>"F"
			aNfItem[nItem][IT_VALICM]	:= aNfItem[nItem][IT_VALMERC]
		EndIf
		aNfItem[nItem][IT_ICMFRETE]	:= 0
	Else
		If !aParSX6[MV_RNDICM] 
			IF aNfItem[nItem][IT_UFXPROD][UFP_RDCTIMP] > 0 .And. aNFCab[NF_OPERNF] == "E" .And. aNFCab[NF_CLIFOR] =="F" .And. aNFCab[NF_TPCLIFOR] =="X" .And. Substr(aNfItem[nItem][IT_CF],1,1)=="3" .And. aTes[TS_INTBSIC]$"123"
				aNfItem[nItem][IT_VALICM]  	:= aNfItem[nItem][IT_BASEICM]*aNfItem[nItem][IT_UFXPROD][UFP_RDCTIMP]/100
			Else		
				aNfItem[nItem][IT_VALICM]  	:= aNfItem[nItem][IT_BASEICM]*aNfItem[nItem][IT_ALIQICM]/100
			EndIf	
			aNfItem[nItem][IT_ICMFRETE]	:= aNfItem[nItem][IT_BSFRETE]*aNfItem[nItem][IT_ALIQICM]/100
		Else
			IF aNfItem[nItem][IT_UFXPROD][UFP_RDCTIMP] > 0 .And. aNFCab[NF_OPERNF] == "E" .And. aNFCab[NF_CLIFOR] =="F" .And. aNFCab[NF_TPCLIFOR] =="X" .And. Substr(aNfItem[nItem][IT_CF],1,1)=="3" .And. aTes[TS_INTBSIC]$"123"
				aNfItem[nItem][IT_VALICM]  := Round(aNfItem[nItem][IT_BASEICM]*aNfItem[nItem][IT_UFXPROD][UFP_RDCTIMP]/100,2)
			Else	
				aNfItem[nItem][IT_VALICM]  := Round(aNfItem[nItem][IT_BASEICM]*aNfItem[nItem][IT_ALIQICM]/100,2)
			EndIf	
			aNfItem[nItem][IT_ICMFRETE]:= Round(aNfItem[nItem][IT_BSFRETE]*aNfItem[nItem][IT_ALIQICM]/100,2)
		EndIf
        
		// Ajuste para NAO pegar aliq original ICMS das NFs de 2012, este ajuste deve ser retirado em 01/01/2014
		If aNFitem[nItem][IT_ALIQICM] == 4
		   lExecDevol := .F.	
		EndIf
		
		If ( aNFCab[NF_TIPONF] $ "DB" .Or. aTes[TS_PODER3] =="D" ) .And. lExecDevol
			If !Empty(aNFItem[nItem][IT_RECORI]) .And. !RetComp(aNFCab[NF_CLIFOR], aNFItem[nItem][IT_RECORI])
				If aNFCab[NF_TIPONF] $ "DB"
					If ( aNFCab[NF_CLIFOR] == "C")
						dbSelectArea("SD2")
						MsGoto(aNFItem[nItem][IT_RECORI])
						If (SD2->D2_VALICM > 0 .Or. Abs(aNfItem[nItem][IT_VALICM]-SD2->D2_VALICM)<=1) .And. aNfItem[nItem][IT_QUANT] = SD2->D2_QUANT .And. Iif(!lDevTot , SD2->D2_VALFRE+SD2->D2_SEGURO+SD2->D2_DESPESA==0 , SD2->D2_VALICM >0)
							aNfItem[nItem][IT_VALICM]  := SD2->D2_VALICM
							aNfItem[nItem][IT_ICMSDIF] := Iif(aFieldPos[FP_D2_ICMSDIF],SD2->D2_ICMSDIF,0)
							lDevTotal	:=	.T.
						Else
							lCalcDif	:=	.T.
						EndIf
					Else
						dbSelectArea("SD1")
						MsGoto(aNFItem[nItem][IT_RECORI])
						If (SD1->D1_VALICM > 0 .Or. Abs(aNfItem[nItem][IT_VALICM]-SD1->D1_VALICM)<=1) .And. aNfItem[nItem][IT_QUANT] = SD1->D1_QUANT .And. Iif(!lDevTot , SD1->D1_VALFRE+SD1->D1_SEGURO+SD1->D1_DESPESA==0 , SD1->D1_VALICM >0)
							aNfItem[nItem][IT_VALICM] := SD1->D1_VALICM
							aNfItem[nItem][IT_ICMSDIF] := If( aFieldPos[FP_D1_ICMSDIF] ,SD1->D1_ICMSDIF,0)
							lDevTotal	:=	.T.
						Elseif(SD1->D1_VALICM > 0 .Or. Abs(aNfItem[nItem][IT_VALICM]-SD1->D1_VALICM)<=1) .And. aNfItem[nItem][IT_QUANT] <> SD1->D1_QUANT .And. Iif(!lDevTot , SD1->D1_VALFRE+SD1->D1_SEGURO+SD1->D1_DESPESA==0 , SD1->D1_VALICM >0)
							aNfItem[nItem][IT_VALICM] := SD1->D1_VALICM / SD1->D1_QUANT * aNfItem[nItem][IT_QUANT]
							aNfItem[nItem][IT_ICMSDIF] := If( aFieldPos[FP_D1_ICMSDIF] ,SD1->D1_ICMSDIF / SD1->D1_QUANT * aNfItem[nItem][IT_QUANT],0)
						Else
							lCalcDif	:=	.T.
						EndIf
					EndIf
				Else
					If ( aNFCab[NF_CLIFOR] == "C")
						dbSelectArea("SD1")
						MsGoto(aNFItem[nItem][IT_RECORI])
						If (SD1->D1_VALICM > 0 .Or. Abs(aNfItem[nItem][IT_VALICM]-SD1->D1_VALICM)<=1) .And. aNfItem[nItem][IT_QUANT] = SD1->D1_QUANT .And. Iif(!lDevTot , SD1->D1_VALFRE+SD1->D1_SEGURO+SD1->D1_DESPESA==0 , SD1->D1_VALICM >0)
							aNfItem[nItem][IT_VALICM] := SD1->D1_VALICM
							lDevTotal	:=	.T.
						Else
							lCalcDif	:=	.T.
						EndIf
					Else
						dbSelectArea("SD2")
						MsGoto(aNFItem[nItem][IT_RECORI])
						If (SD2->D2_VALICM > 0 .Or. Abs(aNfItem[nItem][IT_VALICM]-SD2->D2_VALICM)<=1) .And. aNfItem[nItem][IT_QUANT] = SD2->D2_QUANT .And. Iif(!lDevTot , SD2->D2_VALFRE+SD2->D2_SEGURO+SD2->D2_DESPESA==0 , SD2->D2_VALICM >0)
							aNfItem[nItem][IT_VALICM] := SD2->D2_VALICM
							lDevTotal	:=	.T.
						Else
							lCalcDif	:=	.T.
						EndIf
					EndIf
				EndIf
			EndIf
		EndIf
	EndIf
Else
	aNfItem[nItem][IT_VALICM]	 := 0
	aNfItem[nItem][IT_ICMFRETE] := 0
EndIf

//Retorna o valor do ICMS no reprocessamento para calcular ICMS Diferido.
If !lReproc
	If lCalcDif .Or. (!lCalcDif .And. aNFCab[NF_TIPONF] $ "DB" .And. !lDevTotal) .Or. !(aNFCab[NF_TIPONF] $ "DB")
		If lReproc
			aNfItem[nItem][IT_VALICM]   := nSavValICM
		EndIf
		aNfItem[nItem][IT_ICMSDIF] := 0
		If aTes[TS_ICMSDIF]=="1"
			aNfItem[nItem][IT_ICMSDIF] := aNfItem[nItem][IT_VALICM]
		EndIf
		If  aTES[TS_PICMDIF]<>0 .And. aTES[TS_PICMDIF]<>100
			aNfItem[nItem][IT_ICMSDIF] := aNfItem[nItem][IT_VALICM]*aTes[TS_PICMDIF]/100
			MaItArred(nItem,{"IT_ICMSDIF"})
		EndIf
		If aTes[TS_ICMSDIF]=="1" .And. aTES[TS_PICMDIF]==100 .And. aTES[TS_ICM] == "N"
			aNfItem[nItem][IT_ICMSDIF] :=	MaFisICDif(nItem)
		Endif
		If aTes[TS_ICMSDIF]=="3" .Or. aTes[TS_ICMSDIF]=="4"
			aNfItem[nItem][IT_VALICM] -= aNfItem[nItem][IT_ICMSDIF]
		EndIf
		MaItArred(nItem,{"IT_VALICM"})
	EndIf
	//Retorna o valor do ICMS no reprocessamento.                 ³
Else
	aNfItem[nItem][IT_VALICM]   := nSavValICM
	aNfItem[nItem][IT_ICMFRETE] := nSValICMFR
EndIf
//Identifica um valor a ser lancado como estorno de credito/debito na apuracao do ICMS. Este valor
//  eh obtido quando se tem um percentual de estorno definido no cadastro de TES.
//
// Observacao mais completa pode ser encontrada mais adiante na gravacao do Livro Fiscal.
If aTes[TS_ESTCRED]<>0
	aNfItem[nItem][IT_ESTCRED] := NoRound(aNfItem[nItem][IT_VALICM]*aTes[TS_ESTCRED]/100,2)
Endif

If !Empty(aNfItem[nItem][IT_PR43080])
	aNfItem[nItem][IT_ICSEMDS] := aNfItem[nItem][IT_BSSEMDS]*aNfItem[nItem][IT_ALIQICM]/100
	MaItArred(nItem,{"IT_ICSEMDS"})
EndIf
//ATENCAO!!! Ponto de entrada para uso exclusivo da TOTVS, nao sugerir o uso do mesmo a clientes - GDP FISCAL
If aExistPE[PE_MAICMVEIC]  
	aMaICMVeic := ExecBlock("MaICMVeic",.f.,.f.,{nItem,aNfItem[nItem][IT_BASEICM],aNfItem[nItem][IT_ALIQICM],aNfItem[nItem][IT_VALICM]})
	aNfItem[nItem][IT_BASEICM] := aMaICMVeic[1]
	aNfItem[nItem][IT_ALIQICM] := aMaICMVeic[2]
	aNfItem[nItem][IT_VALICM]  := aMaICMVeic[3]
EndIf

If aExistPE[PE_MACALCICMS]  
	aMaCalcICMS             := ExecBlock("MACALCICMS",.f.,.f.,{aNfCab[NF_OPERNF],nItem,aNfItem[nItem][IT_BASEICM],aNfItem[nItem][IT_ALIQICM],aNfItem[nItem][IT_VALICM]})
	aNfItem[nItem][IT_BASEICM] := aMaCalcICMS[1]
	aNfItem[nItem][IT_ALIQICM] := aMaCalcICMS[2]
	aNfItem[nItem][IT_VALICM]  := aMaCalcICMS[3]
Endif

Return

/*/
±±³Funcao    ³MaFisICDif³ Autor ³Luccas Curcio          ³ Data ³26.12.2011³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Calculo do ICMS Diferido para os casos em que o valor de di-³±±
±±³			 ³ferimento de ICM eh o valor total do imposto(F4_PICMDIF=100)³±±
/*/
Static Function MaFisICDif(nItem)
Local	nBaseICM	:=	0
Local	nAliqICM	:=	0
Local	nICMSDif	:=	0

Local	aReseta		:=	{aNfItem[nItem][IT_BASEICM],;
aNfItem[nItem][IT_ALIQICM],;
aNfitem[nItem][IT_TIPONF],;
aNfItem[nItem][IT_BICMORI],;
aNfItem[nItem][IT_BSFRETE],;
aNfItem[nItem][IT_DEDICM],;
aNfItem[nItem][IT_VIPIBICM],;
aNFitem[nItem][IT_ALIQDIF],;
aNFitem[nItem][IT_ALIQSOL]}

// Calcula a aliquota e base de ICMS apenas para verificar o valor do ICMS Diferido
// Os valores da base e da aliquota serao posteriormente zerados novamente, pois essa
// situacao acontece apenas quando o campo F4_ICM = Nao, ou seja, todos os valores de
// ICMS da nota deverao estar zerados.

// Chama funcao que calcula base de ICMS

MaFisBSICM(nItem,.F.,,.T.)

// Atribui o valor da base para a variavel que ira calcular o ICMS Diferido

nBaseICM				:=	aNfItem[nItem][IT_BASEICM]

// Reseta variaveis

aNfItem[nItem][IT_BASEICM]		:=	aReseta[1]
aNfItem[nItem][IT_BICMORI]		:=	aReseta[4]
aNfItem[nItem][IT_BSFRETE]		:=	aReseta[5]
aNfItem[nItem][IT_DEDICM]		:=	aReseta[6]
aNfItem[nItem][IT_VIPIBICM]	:=	aReseta[7]

// Chama funcao que calcula aliquota de ICMS
MaAliqIcms(nItem,,.T.)
// Atribui o valor da aliquota para a variavel que ira calcular o ICMS Diferido
nAliqICM				:=	aNfItem[nItem][IT_ALIQICM]
// Reseta variaveis³
aNfItem[nItem][IT_ALIQICM]		:=	aReseta[2]
aNfitem[nItem][IT_TIPONF]		:=	aReseta[3]
aNFitem[nItem][IT_ALIQDIF]		:=	aReseta[8]
aNFitem[nItem][IT_ALIQSOL]		:=	aReseta[9]
// Calcula o valor do ICMS Diferido, com base e aliquota 'virtuais'
nICMSDif	:=	nBaseICM * nAliqICM / 100

Return nICMSDif

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³ MaMargem ³ Autor ³ Edson Maricate        ³ Data ³08.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Calculo da Margem de lucro para calculo do ICMS Solidario.  ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaMargem(nItem)

Local nMargem  := If ( aNfCab[NF_CLIFOR] =='F'  , aNfItem[nItem][IT_PRD][SB_PICMENT] , aNfItem[nItem][IT_PRD][SB_PICMRET] )
Local lSTD2      := aFieldPos[FP_D2_MARGEM]
Local lSTD1      := aFieldPos[FP_D1_MARGEM]
Local lNotDevol := .T.
Local nAliquota := 0
Local nAlqInter := 0
Local nMargem1  := 0
Local nMargemOri:= 0
Local nX		:= 0
Local lUFOri	:= .F.
Local lIVAAju   := .F.
Local lRastro	 := aExistPE[PE_MAFISRASTRO]  
Local lRastroLot := .F.

If aNFCab[NF_TIPONF] == "D"
	If !Empty(aNFItem[nItem][IT_RECORI])
		If ( aNFCab[NF_CLIFOR] == "C" )
			If lSTD2
				dbSelectArea("SD2")
				MsGoto( aNFItem[nItem][IT_RECORI] )
				nMargem	:=	SD2->D2_MARGEM
				lNotDevol	:= .F.
			Endif
		Else
			If lSTD1
				dbSelectArea("SD1")
				MsGoto( aNFItem[nItem][IT_RECORI] )
				nMargem  := SD1->D1_MARGEM
				lNotDevol	:= .F.
			Endif
		Endif
	EndIf
EndIf

If lNotDevol
	
	// Aplica a formula padrao do MVA para encontrar o MVA Ajustado, considerando as aliquotas e a Margem preenchida no Cadastro do Produto
	If aParSX6[MV_FISXMVA] .And. aNFCab[NF_UFORIGEM] <> aNFCab[NF_UFDEST] .And. !aTes[TS_CONSUMO]$"SO" .And. nMargem > 0
		nAlqInter	:=	Iif( aNfItem[nItem,IT_ALIQICM] > 0 , aNFItem[nItem,IT_ALIQICM] , MaAliqIcms( nItem ) )
		nAliquota	:=	Iif( aNfItem[nItem,IT_ALIQSOL] > 0 , aNFItem[nItem,IT_ALIQSOL] , MaAliqSoli( nItem ) )
		
		nMargem		:=	( ( ( ( 1 + nMargem / 100 ) * ( 1 - nAlqInter / 100 ) ) / ( 1 - nAliquota / 100 ) ) - 1 ) * 100
	Endif
		
	// Utiliza o MVA preenchido na tabela CFC (Regras de tributos na esfera estadual)
	If aNfItem[nItem][IT_UFXPROD][UFP_MARGEM] > 0
		nMargem	:=	aNfItem[nItem][IT_UFXPROD][UFP_MARGEM]
	Endif
	
	// Verifica as Excecoes Fiscais
	If ( !Empty(aNFItem[nItem][IT_EXCECAO]) )
		If ( aNFItem[nItem][IT_EXCECAO][3] ) <> 0
			nMargem :=  aNFItem[nItem][IT_EXCECAO][3]   //Margem de Lucro Presumida
		EndIf
	EndIf

EndIf

//Tratamento do calculo do IVA Ajustado
//ATENCAO !!! Este tratamento so e relaizado quando o produto possui controle de rastreabilidade por Sub-Lote
IF !Empty(aNfItem[nItem][IT_ANFORI2]) .And. Len(aNfItem[nItem][IT_ANFORI2][1][1]) > 0
	If ( aNfItem[nItem][IT_PRD][SB_IVAAJU] == "1" .And. (Iif(lRastro,lRastroLot := ExecBlock("MAFISRASTRO",.F.,.F.),aNfItem[nItem][IT_PRD][SB_RASTRO]=="S"))  )
		nMargemOri := nMargem
		For nX := 1 to Len (aNfItem[nItem][IT_ANFORI2])
			nAliquota := Iif(aNFItem[nItem,IT_ALIQICM]==0, MaAliqIcms(nItem),aNFItem[nItem,IT_ALIQICM])
			nAlqInter := aNFItem[nItem][IT_ANFORI2][nX][02]
			If !Empty(aNFItem[nItem][IT_ANFORI2][nX][01]) .And. aNFItem[nItem][IT_ANFORI2][nX][01]<>aParSX6[MV_ESTADO]
				lUFOri := .T.
			EndIf
			If aParSX6[MV_ESTADO] $ 'SP/SC/MG' .And. lUFOri .And. aNFCab[NF_UFDEST] == aParSX6[MV_ESTADO] .And. (lRastroLot .Or. aNfItem[nItem][IT_PRD][SB_RASTRO] $ 'S')
				lIVAAju := .T.
			EndIf
			If nAliquota > 12 .And. lIVAAju
				nMargem  := ((((1+nMargem/100)*(1-nAlqInter/100))/(1-nAliquota/100))-1)*100
				nMargem1 += nMargem*(aNFItem[nItem][IT_ANFORI2][nX][3]/100)
				aNFItem[nItem][IT_ANFORI2][nX][4] := nMargem1
				nMargem1 := 0
			EndIf
			If !lIVAAju
				aNFItem[nItem][IT_ANFORI2][nX][4] := nMargemOri
			EndIf
			lUFOri := .F.
			lIVAAju := .F.
		Next nX
	EndIf
EndIf

//Tratamento Antecipacao ICMS - Margem Solidário IVA Ajustado
If aTes[TS_ANTICMS] == "1"
	If ( aNfItem[nItem][IT_PRD][SB_IVAAJU] == "1") .And. (aNFCab[NF_UFORIGEM] <> aNFCab[NF_UFDEST] ) .And. aParSX6[MV_ESTADO] $ "SP/SC/MG" .And. aNFCab[NF_TPCLIFOR] <> "X"//Somente entrada usando IVA Ajustado e Antecipacao de ICMS e Estado de São Paulo
		nAliquota := If ( aNfItem[nItem][IT_PRD][SB_PICM] == 0 , aParSX6[MV_ICMPAD] ,  aNfItem[nItem][IT_PRD][SB_PICM] )//Alíquota Interna
		//³ Verifica as Excecoes fiscais                                ³
		If ( !Empty(aNFItem[nItem][IT_EXCECAO]) )
			If ( aNFItem[nItem][IT_EXCECAO][1] ) <> 0
				nAliquota :=  aNFItem[nItem][IT_EXCECAO][1]   //Aliq. de ICMS Interna
			EndIf
		EndIf
		nAlqInter := Iif(aNFItem[nItem,IT_ALIQICM]==0, MaAliqIcms(nItem),aNFItem[nItem,IT_ALIQICM])//Alíquota interestadual
		If nAliquota > 12 //Aliquota Interna superior a 12%
			nMargem  := ((((1+nMargem/100)*(1-nAlqInter/100))/(1-nAliquota/100))-1)*100 //IVA Ajustado
		EndIf
	EndIf
EndIf

aNFitem[nItem][IT_MARGEM] := nMargem

Return(nMargem)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡„o    ³MaFisBSSol³ Autor ³Edson Maricate         ³ Data ³08.12.1999 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo calcular a base do retido/Solid³±±
±±³          ³conforme definido no regulamento de ICMS.                    ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisBSSOL(nItem, cCampo)

Local nBsICMSt    := 0
Local nMargem     := 0
Local nBase 	  := 0
Local nBaseAux	  := 0
Local nBaseOri	  := 0
Local nY		  := 0
Local lValido     := .T.
Local nReduzICMS  := 0
Local lTipoCliFor := .F.
Local cTipoCliFor := ""
Local nVlMercR    := 0
Local cMvEstado	  := aParSX6[MV_ESTADO]
Local lSTAtacVar  := IIf( aTes[TS_ATACVAR] == "1" .And. aNfItem[nItem][IT_PRD][SB_PICMENT] == 0 .And. cMvEstado == "CE" .And. aNFCab[NF_OPERNF] == "E" , .T. , .F.)
Local lSTConfCE   := IIf( aTes[TS_STCONF] == "1" .And. aNfItem[nItem][IT_PRD][SB_PICMRET] == 0 .And. cMvEstado == "CE" .And. aNFCab[NF_OPERNF] == "S" , .T. , .F.)
Local lDevTot     := aParSX6[MV_DEVTOT]  // Indica se na devolucao total da mercadoria sera considerado no valor da base o valor do frete + despesa + seguro
Local lSomaIpi	  := aParSX6[MV_SOMAIPI]
Local lIpiICST    := IIf(aTes[TS_SOMAIPI] == "2" .And. aNFCab[NF_OPERNF] == "E" .And. aNfItem[nItem][IT_TIPONF]=="N" , .F. , .T.)
// Controle Regime de Estimativa MT.
Local lRegESim	  := aParSX6[MV_REGESIM]
Local lRet		  := .F.
Local nBaseICM	  := 0
Local nPerCaTM    := Iif( aTes[TS_PERCATM]>0 , aTes[TS_PERCATM]  , IIf( aNFCab[NF_PERCATM] > 0 , aNFCab[NF_PERCATM] , aParSX6[MV_PERCATM] )   )
Local cMV_UFPST	  := aParSX6[MV_UFPST21]
Local lSTPTPer	  := .F.
Local nValPER     := 0
Local lCalSTPe	  := .F.
Local nRedBaST	  := Iif(Len(aNFItem[nItem][IT_EXCECAO]) > 0 .And. aNFItem[nItem][IT_EXCECAO][26] > 0,aNFItem[nItem][IT_EXCECAO][26],aTes[TS_BSICMST])
Local nVlrPTST	  := 0
Local cMVSTPTPER  := aParSX6[MV_STPTPER]
Local cMvTpSolCF  := aParSX6[MV_TPSOLCF]
Local lMVStrEdu	  := aParSX6[MV_STREDU]
Local lMvSolBrut  := aParSX6[MV_SOLBRUT]
Local cMVMkpIcPT  := aParSX6[MV_MKPICPT]
Local lF4ApliIVA  := aFieldPos[FP_F4_APLIIVA]
Local cCFOPTran   := "5351/5352/5353/5354/5355/5356/5357/5359/5360/6351/6352/6353/6354/6355/6356/6357/6359/6360/6932/5932/7358"
//Tratamento específico de PB para ignorar o tratamento para venda não presencial
Local lNConf21	  := Iif( aNfCab[NF_UFDEST]=="PB" .And. aNfCab[NF_VTOTPED]>0 .And. aNfCab[NF_VTOTPED]<500, .T. ,.F. )
// RICMS Amapa Convenio 55/2011 Zona Franca Manaus
Local nDifZFAmapa := IIf( aNfItem[nItem][IT_DESCZF] > 0 .And. aNfCab[NF_UFDEST] == "AP" .And. aTes[TS_BASEICM] > 0 , ( aNfItem[nItem][IT_BICMORI] * ( aNfItem[nItem][IT_ALIQICM] / 100 ) ) - aNfItem[nItem][IT_DESCZF] , 0 )
Local nAliqAgr	  := 0
Local lAgreg	  := .F.

DEFAULT cCampo		:= ""
//³ Carrega o tipo do cliente pagador ou destinario    ³
If !Empty(aNfCab[NF_PNF_TPCLIFOR])
	lTipoCliFor := aNfCab[NF_PNF_TPCLIFOR]$cMvTpSolCF
	cTipoCliFor := aNfCab[NF_PNF_TPCLIFOR]
Else
	lTipoCliFor := aNfCab[NF_TPCLIFOR]$cMvTpSolCF
	cTipoCliFor := aNfCab[NF_TPCLIFOR]
EndIf

// Carrega a reducao da base do ICMS
If !Empty(aNFitem[nItem,IT_EXCECAO]) .And. aNfItem[nItem,IT_EXCECAO,14] > 0
	nReduzICMS := aNfItem[nItem,IT_EXCECAO,14]
Else
	nReduzICMS := aTes[TS_BASEICM]
EndIf

MaFisTes(aNfItem[nItem][IT_TES],aNfItem[nItem][IT_RECNOSF4],nItem)

// Controle automatico para utilizacao de Pauta ou Calculo ST por percentual PAUTA x Valor Operacao.
nVlrPTST 	:= IIf(aTes[TS_AGREG]<>"F",aNfItem[nItem][IT_VALMERC]-IIf(aTes[TS_AGREG]$"DR",aNfItem[nItem][IT_DEDICM],0),0) + Iif(aTes[TS_INCIDE] == "N", aNfItem[nItem][IT_VALIPI], 0) + aNfItem[nItem][IT_DESPESA]
If Empty(aParSX6[MV_B1PTST])
	lSTPTPer	:= Iif(aNfCab[NF_UFDEST] $ cMVSTPTPER,.T.,.F.)
	nValPER		:= Val(Transform(Substr(cMVSTPTPER,At(aNfCab[NF_UFDEST],cMVSTPTPER)+2,4),"@E 99.99"))
Else
	lSTPTPer	:= aNfItem[nItem][IT_PRD][SB_B1PTST] > 0
	nValPER		:= aNfItem[nItem][IT_PRD][SB_B1PTST]
Endif

If lSTPTPer .And. nValPER > 0 .And. nVlrPTST > 0
	If !Empty(aNFitem[nItem][IT_EXCECAO]) .And. (nVlrPTST/aNfItem[nItem][IT_EXCECAO][8]) >= nValPER .Or. ;
		aNfItem[nItem][IT_PRD][SB_VLR_ICM] <> 0 .And.( nVlrPTST / aNfItem[nItem][IT_PRD][SB_VLR_ICM] ) >= nValPER
		lCalSTPe := .T.
	EndIf
EndIf

// Verifica se deve-se calcular o ICMS solidario
If aTES[TS_MKPCMP]<>"1" .And. !(aNFitem[nItem][IT_TIPONF ]$'IP') .And. IIf(aNfCab[NF_OPERNF]=="S".And.aNFCab[NF_CLIFOR] == "C",lTipoCliFor,.T.)
	If aNFCab[NF_TIPONF]$"DB"
		If !Empty(aNFItem[nItem][IT_RECORI])
			If ( aNFCab[NF_CLIFOR] == "C")
				dbSelectArea("SD2")
				MsGoto( aNFItem[nItem][IT_RECORI] )
				dbSelectArea("SF2")
				dbSetOrder(1)
				If MsSeek(xFilial("SF2")+(SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA))
					If aNfItem[nItem][IT_QUANT] == SD2->D2_QUANT  .And.  Iif(!lDevTot, aFieldPos[FP_D2_ALIQSOL] .And. SD2->D2_VALFRE+SD2->D2_SEGURO+SD2->D2_DESPESA==0,aFieldPos[FP_D2_ALIQSOL])
						aNfItem[nItem][IT_BASESOL] := SD2->D2_BRICMS
						lValido := .F.
					ElseIf  aNfItem[nItem][IT_QUANT] <> SD2->D2_QUANT  .And.  Iif(!lDevTot, aFieldPos[FP_D2_ALIQSOL] .And. SD2->D2_VALFRE+SD2->D2_SEGURO+SD2->D2_DESPESA==0,aFieldPos[FP_D2_ALIQSOL])
 
						aNfItem[nItem][IT_BASESOL] := (SD2->D2_BRICMS/SD2->D2_QUANT)* aNfItem[nItem][IT_QUANT]
				   		lValido := .F.
				   	Else
						If SF2->F2_TIPOCLI$cMvTpSolCF
							lValido := .T.
						Else
							lValido := .F.
						EndIf
					EndIf
				EndIf
			Else
				dbSelectArea("SD1")
				MsGoto( aNFItem[nItem][IT_RECORI] )
				dbSelectArea("SF1")
				dbSetOrder(1)
				If MsSeek(xFilial("SF1")+(SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA))
					If aNfItem[nItem][IT_QUANT] == SD1->D1_QUANT .And. Iif(!lDevTot, aFieldPos[FP_D1_ALIQSOL]  .And. SD1->D1_VALFRE+SD1->D1_SEGURO+SD1->D1_DESPESA==0 , aFieldPos[FP_D1_ALIQSOL])
						// Tratamento de ICMS-ST conforme decreto 29.560/2008 para o estado do Ceara.
						// Conforme o decreto que visa atender atacadista e varejistas do ceara atraves de aliquot
						// a especificas de ICMS-ST.estas sao utilizadas conforme o anexo III do decreto que e com
						// posta de varias caracteristicas tais como operação(somente)de entrada, origem do forne
						// cedor, se e optante do simples nacional, aliquota interna do produto, se o destinatario
						// e atacadista ou varejista. Segundo consulta realizada ao JIRA para tratamento de
						// devolucao.Neste caso emitiu parecer que ao devolver compras realizadas com este calculo
						// o ICMS-ST nao devera ser calculado para a nota de devolucao de compras.
						If aNfItem[nItem][IT_PRD][SB_PICMENT] == 0 .And. cMvEstado == "CE" .And. ( Substr(SM0->M0_CNAE,1,2) == "46" .Or. Substr(SM0->M0_CNAE,1,2) == "47" )
							aNfItem[nItem][IT_BASESOL] := 0
						Else
							aNfItem[nItem][IT_BASESOL] := SD1->D1_BRICMS
						EndIf
						lValido := .F.
					ElseIf SF1->F1_BRICMS > 0 
						lValido := .T.
					Else
						lValido := .F.
					EndIf
				Endif
			Endif
		ElseIf !lTipoCliFor
			lValido := .F.
		EndIf
	EndIf
	If lValido
		// Calculo do Solidario pela Margem de lucro
		If aNfItem[nItem][IT_PRD][SB_VLR_ICM] == 0 .And. (Empty(aNFitem[nItem][IT_EXCECAO]) .Or. aNfItem[nItem][IT_EXCECAO][8]==0) .Or.;
			(!Empty(aNFitem[nItem][IT_EXCECAO]) .And. aNfItem[nItem][IT_EXCECAO][20] == "2" .And. aNfItem[nItem][IT_EXCECAO][8] == 0) .Or.;
			IiF(lSTPTPer,IiF(lCalSTPe,.T.,.F.),.F.)
			If (aNfItem[nItem][IT_MARGEM] > 0 .And. aTes[TS_APLREDP]<> "1") .Or. ( lSTAtacVar .And. aTes[TS_APLREDP]<> "1").Or. ( lSTConfCE .And. aTes[TS_APLREDP]<> "1")
				
				nMargem := aNfItem[nItem][IT_MARGEM]
				If lSomaIpi
					If lMVStrEdu == .F.
						aNfItem[nItem][IT_BASESOL] := IIf(aTes[TS_AGREG]<>"F",(aNfItem[nItem][IT_VALMERC]+ nDifZFAmapa)-IIf(aTes[TS_AGREG]$"D",aNfItem[nItem][IT_DEDICM],0),0)
					Else
						If nRedBaST > 0 .And. aTes[TS_INCSOL]<>'A'
							nVlMercR := ((aNfItem[nItem][IT_VALMERC]+ nDifZFAmapa)*nRedBaST)/100
						Else
							nVlMercR := (aNfItem[nItem][IT_VALMERC]+ nDifZFAmapa)
						Endif
						aNfItem[nItem][IT_BASESOL] := IIf(aTes[TS_AGREG]<>"F",nVlMercR-IIf(aTes[TS_AGREG]$"DR",aNfItem[nItem][IT_DEDICM],0),0)
					Endif
				Else
					If lMVStrEdu == .F.
						aNfItem[nItem][IT_BASESOL] := IIf(aTes[TS_AGREG]<>"F",(aNfItem[nItem][IT_VALMERC]+ nDifZFAmapa)-IIf(aTes[TS_AGREG]$"DR",aNfItem[nItem][IT_DEDICM],0),0)+Iif(!lIpiICST, 0, aNfItem[nItem][IT_VALIPI])
					Else
						If nRedBaST > 0 .And. aTes[TS_INCSOL]<>'A'
							nVlMercR := ((aNfItem[nItem][IT_VALMERC]+ nDifZFAmapa)*nRedBaST)/100
						Else
							nVlMercR := (aNfItem[nItem][IT_VALMERC]+ nDifZFAmapa)
						Endif
						aNfItem[nItem][IT_BASESOL] := IIf(aTes[TS_AGREG]<>"F",nVlMercR-IIf(aTes[TS_AGREG]$"DR",aNfItem[nItem][IT_DEDICM],0),0)+Iif(!lIpiICST, 0, aNfItem[nItem][IT_VALIPI])
					Endif
				Endif
				
				If ((aTes[TS_DESPICM] <> "2" .And. aTes[TS_DESPICM] <> "4") .OR. aParSX6[MV_DESPICM])
					aNfItem[nItem][IT_BASESOL] += 	aNfItem[nItem][IT_SEGURO]+aNfItem[nItem][IT_DESPESA]+aNfItem[nItem][IT_FRETE]
				EndIf
				If aTes[TS_FRETAUT] == "2"
					aNfItem[nItem][IT_BASESOL] += aNfItem[nItem][IT_AUTONOMO]
				EndIf
				
				If aTes[TS_AGREG]<>"F"
					If !lMvSolBrut .Or. aTes[TS_STDESC] == "1"
						aNfItem[nItem][IT_BASESOL] -=  (aNfItem[nItem][IT_DESCONTO] + aNfItem[nItem][IT_DESCTOT] )
					EndIf
				EndIf

				// Se nao calcular o ICMS Normal soma-lo na base de ICMS ST
				
				If ((aNfItem[nItem][IT_VALICM] == 0 .And. aNfItem[nItem][IT_DESCZF] == 0) .Or.; 
				    (aParSX6[MV_ESTADO] == "AM" .And. aNFCab[NF_OPERNF] == "S" .And. aTes[TS_AGREG] == "I" .And.; 
				    (AllTrim(aNFCab[NF_ESPECIE]) $ "CTR/CTE" .Or. "NFST"$AllTrim(aNFCab[NF_ESPECIE]))))
					If aTES[TS_ICMSST] <> "2"					
						If aNfItem[nItem][IT_VALICM] == 0
							nAliqAgr += MaAliqIcms(nItem,.T.)
						Else
							nAliqAgr += aNfItem[nItem][IT_ALIQICM]							
						EndIf
						lAgreg := .T.
					EndIf
					If aTes[TS_AGRPIS]=="P"
						nAliqAgr += aNfItem[nItem][IT_ALIQPS2]
						lAgreg := .T.
					EndIf
					If aTes[TS_AGRCOF]=="C"
						nAliqAgr += aNfItem[nItem][IT_ALIQCF2]
						lAgreg := .T.
					EndIf
				EndIf

				If lAgreg
					aNfItem[nItem][IT_BASESOL] := Round(aNfItem[nItem][IT_BASESOL] / (1-(nAliqAgr /100)), 2)
				EndIf
				
				If !aParSX6[MV_DSZFSOL]
					aNfItem[nItem][IT_BASESOL] += aNfItem[nItem][IT_DESCZF]
				EndIf
				
				If aTes[TS_BCPCST] == "1"
					aNfItem[nItem][IT_BASESOL] += aNfItem[nItem][IT_VALPS3] + aNfItem[nItem][IT_VALCF3]
				EndIf
				// Operacoes de venda para consumidor final nao podem ter
				// margem de lucro se o destino for para uso e consumo.
				If (( aTes[TS_CONSUMO]$"SO" .And.;
					(	( cTipoCliFor=="F" .And. aNfCab[NF_CLIFOR]=="C" ) .Or. ( aNfCab[NF_CLIFOR]=="F" ) ) .And.;
					aNFCab[NF_UFORIGEM] <> aNFCab[NF_UFDEST] ) .Or. aTes[TS_MKPSOL]=="1") .And. aTES[TS_MKPSOL]<>"3"
					nMargem := 0
				EndIf
				
				// Para Calulo ICMS-ST Importacao SIGAEIC na classificacao da NFE, neste caso a base a ser considerada e a base do ICMS original
				// enviada pelo SIGAEIC que contem demais contribuicoes e impostos que compoem o valor total da importacao para se obter o ICMST
				If (aTes[TS_AGREG]$"B") .And. nMargem > 0
					aNfItem[nItem][IT_BASESOL] := aNfItem[nItem][IT_BASEICM]
				EndIf
				
				//Essa validacao foi implementada verificando apenas as referencias: NF_OPERNF, TS_MKPSOL, TS_INCSOL e TS_AGREG.
				//Porem, isso estava causando inconsistencias no calculo de ICMS Solidario originado do TMS.
				//Foi adicionada a validacao da referencia TS_CREDST ,pois conforme chamado da primeira implementacao - TFZGYC, esse campo
				//tambem deve ser verificado.
				If aNfCab[NF_OPERNF]=="S" .And. aTes[TS_MKPSOL] == "1" .And. aTes[TS_INCSOL] == "D" .And. aTes[TS_AGREG] == "I" .And. aTes[TS_CREDST] == "3" .And. AllTrim(aNfItem[nItem][IT_CF])$ cCFOPTran;
			       .And. aNfItem[nItem][IT_BASEICM]>0
  				      aNfItem[nItem][IT_BASESOL] := aNfItem[nItem][IT_BASEICM]
				EndIf
				
				//Verifica se irá somar o valor do PIS e da COFINS na base de cálculo do ICMS ST.
				//Após somar irá incluir o valor do ICMS na base: (base de cálculo / (1-percentual da alíquota do ICMS))
				IF aNfCab[NF_OPERNF]=="E" .And. aNFCab[NF_CLIFOR] =="F" .And. aNFCab[NF_TPCLIFOR] =="X" .And. aTes[TS_INTBSIC]$"123" .AND. Substr(aNfItem[nItem][IT_CF],1,1)=="3"
					aNfItem[nItem][IT_BASESOL] += aNfItem[nItem][IT_VALPS2] + aNfItem[nItem][IT_VALCF2]				
					aNfItem[nItem][IT_BASESOL] := (aNfItem[nItem][IT_BASESOL] / (1-(aNFItem[nItem,IT_ALIQICM]/100)))
				EndIF
				If aTes[TS_INCSOL] <> "A"
					//Tratamento para o IVA Ajustado somente quando a informacao
					//e solicitada do pedido de vendas - planilha financeira
					If (FunName()=="MATA410" .Or. FunName()=="MATC090" .Or.(FunName()=="MATA460A" .And. inclui==.F. .And. altera==.F.));
						.And. aNfItem[nItem][IT_PRD][SB_IVAAJU] == "1" .And. Len(aNfItem[nItem][IT_ANFORI2][1][1]) > 0
						nBaseOri := aNfItem[nItem][IT_BASESOL] //salvo a base original para efetuar o calculo da nova base com o IVA Ajustado
						For nY := 1 To Len (aNfItem[nItem][IT_ANFORI2])//Neste momento verifico se existe a proporcionalidade para calcular a base, pois pode existir quantidades de varios lotes
							If aNfItem[nItem][IT_ANFORI2][nY][3] < aNfItem[nItem][IT_QUANT]
								nBase := ((nBaseOri/aNfItem[nItem][IT_QUANT])*aNfItem[nItem][IT_ANFORI2][nY][3])
								nBase *= (1+(aNfItem[nItem][IT_ANFORI2][nY][4]/100))
								nBaseAux	+=	nBase
								aNfItem[nItem][IT_BASESOL]	:= nBaseAux
							Else
								aNfItem[nItem][IT_BASESOL] := aNfItem[nItem][IT_BASESOL]*(1+(nMargem/100))
							EndIf
						next
					Else
						aNfItem[nItem][IT_BASESOL] := aNfItem[nItem][IT_BASESOL]*(1+(nMargem/100))
					EndIf
				EndIf
				If nReduzICMS > 0 .And. aParSX6[MV_BASERET]=="S"
					aNfItem[nItem][IT_BASESOL] := (aNfItem[nItem][IT_BASESOL]*nReduzICMS)/100
					aNfItem[nItem][IT_PREDST]  := nReduzICMS
					
					If aTes[TS_VDASOFT] == "1" .And. nReduzICMS >= 100 .And. !lSomaIpi
						aNfItem[nItem][IT_BASESOL] -= aNfItem[nItem][IT_VALIPI]*(1+(nMargem/100))
					EndIf
					
				EndIf
				If nRedBaST > 0 .And. aTes[TS_INCSOL]<>'A' .And. lMVStrEdu == .F.
					If nRedBaST == 100
						aNfItem[nItem][IT_BASESOL] := 0
					Else
						aNfItem[nItem][IT_BASESOL] := (aNfItem[nItem][IT_BASESOL]*nRedBaST)/100
						aNfItem[nItem][IT_PREDST]  :=	nRedBaST
					EndIf
				EndIf
				//Tratamento para Confaz 21/2011. As condicoes para o calculo do ICMS-ST sao para as UF's contidas no parametro
				//MV_UFPST21, para clientes do tipo Consumidor Final e para Vendas nao presenciais, verificado pelo campo F4_VENPRES.
				If (aTes[TS_VENPRES] == "2" .And. aNFCab[NF_UFDEST] $ cMV_UFPST .And. cTipoCliFor == "F" .And. ;
					(aNFCab[NF_LINSCR] .Or. SA1->A1_CONTRIB == "2") .And. aTes[TS_MKPSOL]=="1" ) .And. !lNConf21
					
					aNfItem[nItem][IT_BASESOL]	:= Iif( nReduzICMS > 0 .And. aParSX6[MV_BASERET] == "S" , aNfItem[nItem][IT_BASEICM] , aNfItem[nItem][IT_BICMORI] )
				Endif
			ElseIf (aTes[TS_VENPRES] == "2" .And. aNFCab[NF_UFDEST] $ cMV_UFPST .And. cTipoCliFor == "F" .And. ;
				(aNFCab[NF_LINSCR] .Or. SA1->A1_CONTRIB == "2") .And. aTes[TS_MKPSOL]=="1" ) .And. !lNConf21
					aNfItem[nItem][IT_BASESOL]	:= Iif( nReduzICMS > 0 .And. aParSX6[MV_BASERET] == "S" , aNfItem[nItem][IT_BASEICM] , aNfItem[nItem][IT_BICMORI] )
				//Verifico se devo usar a base de calculo do ICMS Proprio quando reduzida, como base para o ICMS ST.
			ElseIf (aNfItem[nItem][IT_MARGEM] > 0 .And. aTes[TS_APLREDP]=="1") .Or. ( lSTAtacVar .And. aTes[TS_APLREDP]=="1") .Or. ( lSTConfCE .And. aTes[TS_APLREDP]=="1")
				
				aNfItem[nItem][IT_BASESOL]	:= Iif( nReduzICMS > 0 .And. aParSX6[MV_BASERET] == "S" , aNfItem[nItem][IT_BASEICM] , aNfItem[nItem][IT_BICMORI] ) + aNfItem[nItem][IT_VALIPI]
				//Caso Despesa não tenham entrado na base do ICMS Proprio deve ser colocada.
				If aTes[TS_DESPICM] == "2" .Or. aTes[TS_DESPICM] == "3";
					.Or. (aTes[TS_DESPICM]$"14" .And. aTes[TS_DESPRDIC] == "3")
					aNfItem[nItem][IT_BASESOL]	 += aNfItem[nItem][IT_DESPESA]
					aNfItem[nItem][IT_BASESOL] += aNfItem[nItem][IT_SEGURO]
				EndIf
				If aTes[TS_DESPRDIC] $ "3"
					aNfItem[nItem][IT_BASESOL]	 += aNfItem[nItem][IT_FRETE]
				EndIf
				aNfItem[nItem][IT_BASESOL] := aNfItem[nItem][IT_BASESOL] * (1+(aNfItem[nItem][IT_MARGEM]/100))
			Elseif aNfItem[nItem][IT_MARGEM] == 0
				If aNFCab[NF_UFDEST] == aNFCab[NF_UFORIGEM] .And. aTes[TS_OBSSOL]=="5" .And. aTes[TS_LFICM]=="Z"
					aNfItem[nItem][IT_BASESOL]	:= aNfItem[nItem][IT_VALMERC]
				Else
					aNfItem[nItem][IT_BASESOL]	:= 0
				Endif
			Else
				aNfItem[nItem][IT_BASESOL]	:= 0
			EndIf
		Else
			If !Empty(aNFitem[nItem][IT_EXCECAO]) .And. (aNfItem[nItem][IT_EXCECAO][8]<>0 .Or. aNfItem[nItem][IT_EXCECAO][20]=="2")
				aNfItem[nItem][IT_BASESOL] := aNfItem[nItem][IT_QUANT]*aNfItem[nItem][IT_EXCECAO][8]
				aNfItem[nItem][IT_PAUTST]  := aNfItem[nItem][IT_EXCECAO][8]
			Else
				aNfItem[nItem][IT_BASESOL] := aNfItem[nItem][IT_QUANT] * aNfItem[nItem][IT_PRD][SB_VLR_ICM]
				aNfItem[nItem][IT_PAUTST]  := aNfItem[nItem][IT_PRD][SB_VLR_ICM]
			EndIf
			If !Empty( aParSX6[MV_ICMPFAT] )
				aNfItem[nItem][IT_BASESOL] *= aNfItem[nItem][IT_PRD][SB_ICMPFAT]
			EndIf
			If aParSX6[MV_ICPAUTA]=="2" //1=Sem Frete/Despesa/Seguro - 2=Com Frete/Despesa/Seguro
				If !Empty(aNFItem[nItem][IT_VLR_FRT])
					aNfItem[nItem][IT_BASESOL] += aNfItem[nItem][IT_VLR_FRT]+aNfItem[nItem][IT_SEGURO]+aNfItem[nItem][IT_DESPESA]
				Else
					aNfItem[nItem][IT_BASESOL] += aNfItem[nItem][IT_FRETE]+aNfItem[nItem][IT_SEGURO]+aNfItem[nItem][IT_DESPESA]
				EndIf
			EndIf
			nBsICMSt := IIf(aTes[TS_AGREG]<>"F",aNfItem[nItem][IT_VALMERC]-IIf(aTes[TS_AGREG]$"DR",aNfItem[nItem][IT_DEDICM],0),0)+aNfItem[nItem][IT_VALIPI]+aNfItem[nItem][IT_FRETE]+aNfItem[nItem][IT_SEGURO]+aNfItem[nItem][IT_DESPESA]
			If aTes[TS_FRETAUT] == "2"
				nBSICMSt += aNfItem[nItem][IT_AUTONOMO]
			EndIf
			If !lMvSolBrut .Or. aTes[TS_STDESC] == "1"
				nBsICMSt -= (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT])
			EndIf
			If !aParSX6[MV_DSZFSOL]
				nBsICMSt += aNfItem[nItem][IT_DESCZF]
				aNfItem[nItem][IT_BASESOL] += aNfItem[nItem][IT_DESCZF]
			EndIf
			If nReduzICMS > 0 .And. aParSX6[MV_BASERET] =="S"
				nBsICMSt := (aNfItem[nItem][IT_BASESOL]*nReduzICMS)/100
				aNfItem[nItem][IT_BASESOL] := (aNfItem[nItem][IT_BASESOL]*nReduzICMS)/100
				aNfItem[nItem][IT_PREDST]  := nReduzICMS
				
				If aTes[TS_VDASOFT] == "1" .And. nReduzICMS >= 100
					aNfItem[nItem][IT_BASESOL] -= aNfItem[nItem][IT_VALIPI]
				EndIf
				
			EndIf
			If nRedBaST > 0 .And. aTes[TS_INCSOL]<>'A' .And. lMVStrEdu == .F.
				aNfItem[nItem][IT_PREDST]  :=	nRedBaST
			EndIf
			If nRedBaST > 0
				If nRedBaST == 100
					nBSICMSt := 0
					aNfItem[nItem][IT_BASESOL] := 0
				Else
					nBsICMSt := (nBsICMSt*nRedBaST)/100
					aNfItem[nItem][IT_BASESOL] := (aNfItem[nItem][IT_BASESOL]*nRedBaST)/100
				EndIf
			EndIf

			//Verifica se irá somar o valor do PIS e da COFINS na base de cálculo do ICMS ST.
			//Após somar irá incluir o valor do ICMS na base: (base de cálculo / (1-percentual da alíquota do ICMS))
			IF aNfCab[NF_OPERNF]=="E" .And. aNFCab[NF_CLIFOR] =="F" .And. aNFCab[NF_TPCLIFOR] =="X" .And. aTes[TS_INTBSIC]$"123" .AND. Substr(aNfItem[nItem][IT_CF],1,1)=="3"
				aNfItem[nItem][IT_BASESOL] += aNfItem[nItem][IT_VALPS2] + aNfItem[nItem][IT_VALCF2]				
				aNfItem[nItem][IT_BASESOL] := (aNfItem[nItem][IT_BASESOL] / (1-(aNFItem[nItem,IT_ALIQICM]/100)))
			EndIF
			If ( aNfItem[nItem][IT_MARGEM] > 0 .And. cMVMkpIcPT=="2") .Or. ( lSTAtacVar .And. cMVMkpIcPT=="2") .Or. ( lSTConfCE .And. cMVMkpIcPT=="2")
				nMargem := aNfItem[nItem][IT_MARGEM]
				// Operacoes de venda para consumidor final nao podem ter
				// margem de lucro se o destino for para uso e consumo.
				If (( aTes[TS_CONSUMO]$"SO" .And.;
					(	( cTipoCliFor=="F" .And. aNfCab[NF_CLIFOR]=="C" ) .Or. ( aNfCab[NF_CLIFOR]=="F" ) ) .And.;
					aNFCab[NF_UFORIGEM] <> aNFCab[NF_UFDEST] ) .Or. aTes[TS_MKPSOL]=="1") .And. aTes[TS_MKPSOL]<>"3"
					nMargem := 0
				EndIf
				If aTes[TS_INCSOL] <> "A"
					aNfItem[nItem][IT_BASESOL] := aNfItem[nItem][IT_BASESOL]*(1+(nMargem/100))
					nBsICMSt                 := nBsICMSt*(1+(nMargem/100))
				EndIf
			EndIf
			// Calculo do valor da base do ICMS Solidario quando o valor da
			// pauta for menor do que o valor do item.
			If (lF4ApliIVA .And. aTes[TS_APLIIVA]$"1/3/4" .And. aNfItem[nItem][IT_MARGEM] > 0 ) .Or. ;
				(lF4ApliIVA .And. aTes[TS_APLIIVA]$"1/3" .And. lSTAtacVar) .Or. ;
				(lF4ApliIVA .And. aTes[TS_APLIIVA]$"1/3" .And. lSTConfCE)
				
				IF  aTes[TS_APLIIVA] == "4" .And. aNFCab[NF_UFDEST]$aParSX6[MV_UFPAUTA].And. nBsICMSt>(aNfItem[nItem][IT_BASESOL] * (75/100))
				    aNfItem[nItem][IT_BASESOL] := aNfItem[nItem][IT_BASESOL]*(1+(aNfItem[nItem][IT_MARGEM]/100))
					aNfItem[nItem][IT_PAUTST]  := 0	
				ElseIF aTes[TS_APLIIVA]$"1/3" .And. ( nBsICMSt >= aNfItem[nItem][IT_BASESOL] )
					aNfItem[nItem][IT_BASESOL] := nBsICMSt*(1+(aNfItem[nItem][IT_MARGEM]/100))
					aNfItem[nItem][IT_PAUTST]  := 0					
				ElseIF aTes[TS_APLIIVA] == "3"
					aNfItem[nItem][IT_BASESOL] := aNfItem[nItem][IT_BASESOL]*(1+(aNfItem[nItem][IT_MARGEM]/100))				
					aNfItem[nItem][IT_PAUTST]  := 0
				EndIf
			EndIf
			// Calculo do valor total para acertar o ICMS de Pauta
			// A pauta nao pode ser menor que o valor comercializado
			If !aParSX6[MV_ICMPAUT]
				If ( nBsICMSt > aNfItem[nItem][IT_BASESOL] )
					aNfItem[nItem][IT_BASESOL] := nBsICMSt
					aNfItem[nItem][IT_PAUTST]  := 0
				EndIf
			EndIf
			//Tratamento para Confaz 21/2011. As condicoes para o calculo do ICMS-ST sao para as UF's contidas no parametro
			//MV_UFPST21, para clientes do tipo Consumidor Final e para Vendas nao presenciais, verificado pelo campo F4_VENPRES.
			If (aTes[TS_VENPRES] == "2" .And. aNFCab[NF_UFDEST] $ cMV_UFPST .And. cTipoCliFor == "F" .And. ;
				(aNFCab[NF_LINSCR] .Or. SA1->A1_CONTRIB == "2") .And. aTes[TS_MKPSOL]=="1" ) .And. !lNConf21
				aNfItem[nItem][IT_BASESOL]	:= Iif( nReduzICMS > 0 .And. aParSX6[MV_BASERET] == "S" , aNfItem[nItem][IT_BASEICM] , aNfItem[nItem][IT_BICMORI] )
			Endif
		EndIf
	Else
		If 	!aNFCab[NF_TIPONF]$"DB"
			aNfItem[nItem][IT_BASESOL]	:= 0
		EndIf
	EndIf
Else
	aNfItem[nItem][IT_BASESOL]	:= 0
EndIf
//Cálculo de ICMS ST com carga líquida
IF aTes[TS_F4_STLIQ] == "1"	.AND. aNfItem[nItem][IT_UFXPROD][UFP_MARGSTLIQ] > 0 .AND. aNfItem[nItem][IT_UFXPROD][UFP_ALIQSTLIQ] >0 
	aNfItem[nItem][IT_BASESOL]	:=  (aNfItem[nItem][IT_BASEICM] +  Iif(aTes[TS_INCIDE] == "N", aNfItem[nItem][IT_VALIPI],0))  * ( 1 + ( aNfItem[nItem][IT_UFXPROD][UFP_MARGSTLIQ]/100 ))
EndIF
// Tratamento para o calculo diferenciado de Base para o Estado
// de RN Artigo 944-I.
If aParSX6[MV_ALRN944] .And. aFieldPos[FP_B1_PRN944I]
	If aNfItem[nItem][IT_PRD][SB_PRN944I] == "S"
		nBsICMSt := IIf(aTes[TS_AGREG]<>"F",aNfItem[nItem][IT_VALMERC]-IIf(aTes[TS_AGREG]$"DR",aNfItem[nItem][IT_DEDICM],0),0)+aNfItem[nItem][IT_VALIPI]+aNfItem[nItem][IT_FRETE]+aNfItem[nItem][IT_SEGURO]+aNfItem[nItem][IT_DESPESA]
		aNfItem[nItem][IT_BASESOL]	:= nBsICMSt
	EndIf
EndIf
//Base de Calculo do ICMS ST nas operacoes substituidos do MT,
//com base no CNAE do Anexo XI e XVI do RICMS/MT de acordo com
//os art. 87-J-6 ao art. 87-J-16 do RICMS/MT e decreto 392/2011

If lRegESim .And. aFieldPos[FP_A1_REGESIM] .And. aFieldPos[FP_A2_REGESIM] .And. aFieldPos[FP_A1_PERCATM];
	.And. aFieldPos[FP_B1_REGESIM] .And. aTES[TS_MKPCMP]<>"1"
	//Base Original de ICMS.
	nBaseICM := aNfItem[nItem][IT_BASEICM] + Iif(aTes[TS_INCIDE] == "N", aNfItem[nItem][IT_VALIPI], 0)
	nBaseOri := aNfItem[nItem][IT_BICMORI] + Iif(aTes[TS_INCIDE] == "N", aNfItem[nItem][IT_VALIPI], 0)
	If ( aNfCab[NF_OPERNF]=="S" .And. !aNFCab[NF_TIPONF] $ "DB" ) .Or. ( aNfCab[NF_OPERNF]=="E" .And. aNFCab[NF_TIPONF] $ "DB" )
		If aNfCab[NF_REGESIM]=="1" .And. aNfItem[nItem][IT_PRD][SB_REGESIM] == "1"
			lRet :=  .T.
		EndIf
	ElseIf ( aNfCab[NF_OPERNF]=="E" .And. !aNFCab[NF_TIPONF] $ "DB" ) .Or. ( aNfCab[NF_OPERNF]=="S" .And. aNFCab[NF_TIPONF] $ "DB" )
		If aNfCab[NF_REGESIM] == "1" .And. aNfItem[nItem][IT_PRD][SB_REGESIM] == "1"
			lRet :=  .T.
		EndIf
	EndIf
	
	Do Case
		//Saida fora de MT
		Case aNFCab[NF_UFORIGEM] <> "MT" .And. aNFCab[NF_UFDEST] == "MT" .And. lRet
        	If aNfCab[NF_OPERNF]=="S" .And. !aNFCab[NF_TIPONF] $ "DB"
        		aNfItem[nItem][IT_BASRESI] := aNfItem[nItem][IT_VALICM]+((nBaseOri*nPerCaTM)/100)
           		aNfItem[nItem][IT_VALRESI] := nBaseOri*(nPerCaTM/100)
        	Else
           		aNfItem[nItem][IT_BASRESI] := aNfItem[nItem][IT_VALICM]+((nBaseICM*nPerCaTM)/100)
            	aNfItem[nItem][IT_VALRESI] := nBaseICM*(nPerCaTM/100)
        	EndIf
		//Entrada fora MT
		Case aNFCab[NF_UFORIGEM] == "MT" .And. aNFCab[NF_UFDEST] <> "MT" .And. lRet
			If aNfCab[NF_OPERNF]=="E" .Or. (aNfCab[NF_OPERNF]=="S" .And. aNFCab[NF_TIPONF]$"DB") 
				nPerCaTM 						:= IIf(aNFCab[NF_TIPONF]$"DB" .And. aNFCab[NF_PERCATM] > 0, Iif( aTes[TS_PERCATM]>0 , aTes[TS_PERCATM] , aNfCab[NF_PERCATM] ), nPerCaTM)
				aNfItem[nItem][IT_BASRESI]	:= aNfItem[nItem][IT_VALICM]+((nBaseICM*nPerCaTM)/100)
				aNfItem[nItem][IT_VALRESI]	:= nBaseICM*(nPerCaTM/100)
			EndIf
		//Saida/Entrada MT
		Case aNFCab[NF_UFORIGEM] == "MT" .And. aNFCab[NF_UFDEST] == "MT" .And. lRet
			If aNfCab[NF_OPERNF]=="S"
				aNfItem[nItem][IT_BASRESI] := aNfItem[nItem][IT_VALICM] + ( nBaseOri * (aNfItem[nItem][IT_MARGEM]/100) ) * (Iif(aTes[TS_PERCATM]>0,aTes[TS_PERCATM],aNfCab[NF_PERCATM])/100)
				aNfItem[nItem][IT_VALRESI] := ( nBaseOri * (aNfItem[nItem][IT_MARGEM]/100) ) * (Iif(aTes[TS_PERCATM]>0,aTes[TS_PERCATM],aNfCab[NF_PERCATM])/100)
			Else
				aNfItem[nItem][IT_BASRESI] := aNfItem[nItem][IT_VALICM]+(nBaseICM*(aNfItem[nItem][IT_MARGEM]/100))*(nPerCaTM/100)  // /(MV_ICMPAD/100)
				aNfItem[nItem][IT_VALRESI] := (nBaseICM*(aNfItem[nItem][IT_MARGEM]/100) ) * (nPerCaTM/100)
			EndIf
	EndCase
		
EndIf
MaItArred(nItem,{"IT_BASESOL"})

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Para o calculo do FECP de cada ESTADO e necessario as BASES DE CALCULO do ICMS e do ICMS SOLIDARIO  ³
//³afim de majorar as aliquotas dos mesmos, por este motivo a chamada GERAL da funcao de calulo do FECP³
//³deve estar no fim das funcoes de BASE do ICMS e ICMS SOLIDARIO e em nenhum outro ponto da MATXFIS.  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
MaFisFECP(nItem, cCampo)

Return(Nil)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaAliqSol ³ Autor ³ Edson Maricate        ³ Data ³08.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Calculo da Aliquota para operacoes de ICMS Solidario.       ³±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±/*/
Static Function MaAliqSoli(nItem)

Local nMvIcmPad		:= aParSX6[MV_ICMPAD]
Local nAliquota 	:= If ( aNfItem[nItem][IT_PRD][SB_PICM] == 0 , IIf(aTES[TS_ICM]<>"N" .Or. (aTes[TS_AGREG]$"B") ,aNfItem[nItem][IT_ALIQICM],MaAliqIcms(nItem,.T.)) ,  aNfItem[nItem][IT_PRD][SB_PICM] )
Local nAliqInt 		:= If ( aNfItem[nItem][IT_PRD][SB_PICM] == 0 , nMvIcmPad ,  aNfItem[nItem][IT_PRD][SB_PICM] )//Alíquota Interna
Local nAlqFecopST   := Iif( aNfItem[nItem][IT_PRD][SB_FECOP] == "1" , aNfItem[nItem][IT_PRD][SB_ALFECST] , 0 )
Local lSTD2			:= aFieldPos[FP_D2_ALIQSOL]
Local lSTD1			:= aFieldPos[FP_D1_ALIQSOL]
Local lVerExc   	:= .T.
Local cMvEstado		:= aParSX6[MV_ESTADO]
Local lSTAtacVar	:= IIf( aTes[TS_ATACVAR] == "1" .And. aNfItem[nItem][IT_PRD][SB_PICMENT] == 0 .And. cMvEstado == "CE" .And. aNFCab[NF_OPERNF] == "E" , .T. , .F.)
Local lSTConfCE 	:= IIf( aTes[TS_STCONF] == "1" .And. aNfItem[nItem][IT_PRD][SB_PICMRET] == 0 .And. cMvEstado == "CE" .And. aNFCab[NF_OPERNF] == "S" , .T. , .F.)
Local lAliqExc      := .F.
Local cDestino  	:= aNFCab[NF_UFDEST]
Local cSimpNac		:= aParSX6[MV_CODREG]
Local cAliqDifST   	:= "2"
Local cMvEstIcm		:= aParSX6[MV_ESTICM]
Local lAlFecp		:= .F.

If !Empty( ANFCab[NF_PNF_UF] ) .And. (AllTrim(aNFCab[NF_ESPECIE]) $ "CTR/CTE".Or. "NFST"$AllTrim(aNFCab[NF_ESPECIE])) .And. aNFCab[NF_OPERNF] == "S"
	nAliquota 	:= MaAliqIcms(nItem,.T.)
Else
	If ( aNFCab[NF_UFORIGEM] <> aNFCab[NF_UFDEST] )
		If aNFCab[NF_TIPONF] == "D"
			nAliquota 	:= MaAliqOrig(nItem)
			If !Empty(aNFItem[nItem][IT_RECORI])
				If ( aNFCab[NF_CLIFOR] == "C" )
					If lSTD2
						dbSelectArea("SD2")
						MsGoto( aNFItem[nItem][IT_RECORI] )
						nAliquota  	:= SD2->D2_ALIQSOL
						lVerExc 	:= .F.
					Endif
				Else
					If lSTD1
						dbSelectArea("SD1")
						MsGoto( aNFItem[nItem][IT_RECORI] )
						nAliquota  := SD1->D1_ALIQSOL
						lVerExc 	:= .F.
					Endif
				Endif
			EndIf
		Else
			nAliquota 	:= MaAliqDest(nItem)
		EndIf
	EndIf
EndIf

If lVerExc
	If ( !Empty(aNFItem[nItem][IT_EXCECAO]) )
		If ( aNFItem[nItem][IT_EXCECAO][6] ) <> 0
			nAliquota 	:= aNfItem[nItem][IT_EXCECAO][6]
		EndIf
	EndIf
EndIf

//Tratamento Antecipacao ICMS  - Aliquota interna deve ser aplicada ao cálculo do ICMS ST
If aTes[TS_ANTICMS] == "1"
	If ( aNFCab[NF_UFORIGEM] <> aNFCab[NF_UFDEST] ) .And. aNFCab[NF_TPCLIFOR] <> "X"
		nAliquota 	:= If ( aNfItem[nItem][IT_PRD][SB_PICM] == 0 , nMvIcmPad ,  aNfItem[nItem][IT_PRD][SB_PICM] )//Alíquota Interna
		// Verifica as Excecoes fiscais
		If ( !Empty(aNFItem[nItem][IT_EXCECAO]) )
			If ( aNFItem[nItem][IT_EXCECAO][1] ) <> 0
				nAliquota :=  aNFItem[nItem][IT_EXCECAO][1]   //Aliq. de ICMS Interna
			EndIf
		EndIf
	EndIf
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³  Calculo atraves da tabela CFC para FECP (todas as regras foram estabelecidas na MaFisFecp)					³
//³  Para operacoes dentro do estado nao acrescento,pois na declaracao da variavel nAliquota a funcao MaAliqIcms³
//³ja trouxe a aliquota majorada(quando houver majoracao do ICMS Proprio, por isso preciso verificar tambem a 	³
//³referencia IT_ALIQFECP); quando interestadual as funcoes MaAliqOrig e MaAliqDest anulam a MaAliqIcms			³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If aNfItem[nItem][IT_UFXPROD][UFP_ALIQFECP] > 0 .And. !(aNfItem[nItem][IT_ALIQFECP] > 0 .And. aNfCab[NF_UFORIGEM] == aNfCab[NF_UFDEST])
	nAliquota	+=	aNfItem[nItem][IT_ALFCST]
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³  Acrescenta a Aliquota dos FECPs a aliquota do ICMS Solidario quando operacao interestadual					³
//³  Para operacoes dentro do estado nao acrescento,pois na declaracao da variavel nAliquota a funcao MaAliqIcms³
//³ja trouxe a aliquota majorada, quando interestadual as funcoes MaAliqOrig e MaAliqDest anulam a MaAliqIcms	³
//³  Tambem verifico se a aliquota nao foi informada no proprio produto, pois neste caso a aliquota nao eh		³
//³definida pela funcao MaAliqIcms(), a aliquota eh o exatamente o que foi definido na referencia SB_PICM, e 	³
//³neste caso preciso majorar manualmente o FECP. 																³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Else
	If (aNFCab[NF_TIPONF] == "D")
		lAlFecp := .F.
	ElseIf ( ( aNFCab[NF_UFORIGEM] <> aNFCab[NF_UFDEST] ) .And. !(aNFCab[NF_TIPONF] == "D") ) .Or. ( aNfItem[nItem][IT_PRD][SB_PICM] > 0 .OR. aNfItem[nItem][IT_VALFECP] == 0 )
		lAlFecp := .T.
	EndIf
	
	If lAlFecp
		nAliquota += aNfItem[nItem][IT_ALIQFECP]
		nAliquota += aNfItem[nItem][IT_ALFECMT]
		nAliquota += aNfItem[nItem][IT_ALFECRN]
		nAliquota += aNfItem[nItem][IT_ALFECMG]
	Endif
Endif
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Tratamento de aliquotas de ICMS-ST conforme decreto 29.560/2008 para o estado do Ceara³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If lSTAtacVar
	If Substr(SM0->M0_CNAE,1,2) == "46" // Atacadistas
		If nAliqInt == 7
			If aNFCab[NF_UFORIGEM] == "CE" // Ceara
				nAliquota := 2.70
			ElseIf aNFCab[NF_UFORIGEM] $ "SP|RJ|MG|PR|SC|RS" // Sul e Sudeste exceto ES
				nAliquota := 6.80
			Else
				nAliquota := 4.70 // Norte, Nordeste e Centro Oeste e ES
			EndIf
		ElseIf nAliqInt == 12
			If aNFCab[NF_UFORIGEM] == "CE" // Ceara
				nAliquota := 4.60
			ElseIf aNFCab[NF_UFORIGEM] $ "SP|RJ|MG|PR|SC|RS" // Sul e Sudeste exceto ES
				nAliquota := 11.60
			Else
				nAliquota := 8.10 // Norte, Nordeste e Centro Oeste e ES
			EndIf
		ElseIf nAliqInt == 17
			If aNFCab[NF_UFORIGEM] == "CE" // Ceara
				nAliquota := 6.50
			ElseIf aNFCab[NF_UFORIGEM] $ "SP|RJ|MG|PR|SC|RS" // Sul e Sudeste exceto ES
				nAliquota := 16.50
			Else
				nAliquota := 11.50 // Norte, Nordeste e Centro Oeste e ES
			EndIf
		ElseIf nAliqInt == 25
			If aNFCab[NF_UFORIGEM] == "CE" // Ceara
				nAliquota := 7.26
			ElseIf aNFCab[NF_UFORIGEM] $ "SP|RJ|MG|PR|SC|RS" // Sul e Sudeste exceto ES
				nAliquota := 33
			Else
				nAliquota := 25.85 // Norte, Nordeste e Centro Oeste e ES
			EndIf
		Else
			nAliquota := 0
		EndIf
	ElseIf Substr(SM0->M0_CNAE,1,2) == "47" // Varejistas
		If nAliqInt == 7
			If aNFCab[NF_UFORIGEM] == "CE" // Ceara
				nAliquota := 1.05
			ElseIf aNFCab[NF_UFORIGEM] $ "SP|RJ|MG|PR|SC|RS" // Sul e Sudeste exceto ES
				nAliquota := 5.52
			Else
				nAliquota := 3.46 // Norte, Nordeste e Centro Oeste e ES
			EndIf
		ElseIf nAliqInt == 12
			If aNFCab[NF_UFORIGEM] == "CE" // Ceara
				nAliquota := 1.80
			ElseIf aNFCab[NF_UFORIGEM] $ "SP|RJ|MG|PR|SC|RS" // Sul e Sudeste exceto ES
				nAliquota := 9.46
			Else
				nAliquota := 5.93 // Norte, Nordeste e Centro Oeste e ES
			EndIf
		ElseIf nAliqInt == 17
			If aNFCab[NF_UFORIGEM] == "CE" // Ceara
				nAliquota := 2.60
			ElseIf aNFCab[NF_UFORIGEM] $ "SP|RJ|MG|PR|SC|RS" // Sul e Sudeste exceto ES
				nAliquota := 13.40
			Else
				nAliquota := 8.40 // Norte, Nordeste e Centro Oeste e ES
			EndIf
		ElseIf nAliqInt == 25
			If aNFCab[NF_UFORIGEM] == "CE" // Ceara
				nAliquota := 7.26
			ElseIf aNFCab[NF_UFORIGEM] $ "SP|RJ|MG|PR|SC|RS" // Sul e Sudeste exceto ES
				nAliquota := 33
			Else
				nAliquota := 25.85 // Norte, Nordeste e Centro Oeste e ES
			EndIf
		Else
			nAliquota := 0
		EndIf
	EndIf
	
	If aNFCab[NF_SIMPNAC] =="1"
		If aNFCab[NF_UFORIGEM] == "CE" // Ceara
			nAliquota += 5
		ElseIf aNFCab[NF_UFORIGEM] $ "SP|RJ|MG|PR|SC|RS" // Sul e Sudeste exceto ES
			nAliquota += 7
		Else
			nAliquota += 12
		EndIf
	EndIf
EndIf

// Tratamento de aliquotas de ICMS-ST conforme decreto 28.443/2006 para o estado do Ceara
// Conforme o decreto que visa atender operacoes internas de comercio, atacado, varejo e
// industria do estado do Ceará atraves de aliquotas especificas de ICMS-ST.
If lSTConfCE
	If aNFCab[NF_UFDEST] == "CE" //Ceara
		nAliquota := 3
	EndIf
EndIf
// Tratamento para o calculo diferenciado de aliquota para o
// estado de RN Artigo 944-I.

If aParSX6[MV_ALRN944] .And. aFieldPos[FP_B1_PRN944I]
	If aNFCab[NF_UFORIGEM] == "RN" .And. aNfItem[nItem][IT_PRD][SB_PRN944I] == "S"
		nAliquota:= aParSX6[MV_ASRN944]
	Else
		If aNfItem[nItem][IT_PRD][SB_PRN944I] == "S"
			nAliquota:= aParSX6[MV_AERN944]
		EndIf
	EndIf
EndIF

aNFitem[nItem][IT_ALIQSOL] := nAliquota

//Simples Nacional - Aliquota ICMS solidario.
If cSimpNac $ "1/2" .And. aNFCab[NF_OPERNF] == "S"
	//Busca RecNo do Produto para verificar campo que trata a aliquota interna
	//a ser tributada para o Simples Nacional através de Exceção Fiscal.
	//O campo deve ser informado no parâmetro MV_ALQDFB1.
	If aNFCab[NF_UFORIGEM] == aNFCab[NF_UFDEST]
		If aFieldPos[FP_MV_ALQDFB1]
			cAliqDifST := aNfItem[nItem][IT_PRD][SB_ALQDFB1]
		Endif
		
		//Se houver aliquota na excecao fiscal esta deve prevalecer a aliquota do simples nacional.
		If lVerExc .And. !Empty(aNFItem[nItem][IT_EXCECAO])
			If aNFItem[nItem][IT_EXCECAO][6] <> 0
				lAliqExc := .T.
			EndIf
		EndIf
		//If !lAliqExc .And. aNFitem[nItem][IT_CPDIFST]$"2 "
		If !lAliqExc .And. cAliqDifST $ "2 "
			aNFitem[nItem][IT_ALIQSOL] := Val(Subs(cMvEstIcm,AT(cDestino,cMvEstIcm)+2,2))
		EndIf
	Endif
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ FECOP - CEARA - Caso no SB1 seja configurado para calcular FECOP a aliquota do Solidario sera Majorada em 2% - opcoes informadas no SB1 de 19 % ou  27% ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If (nAlqFecopST == 19 .Or. nAlqFecopST == 27) .And. aParSX6[MV_ESTADO] == "CE" .And. aNFCab[NF_UFDEST] == "CE" .And. aNfCab[NF_OPERNF] == "S"
	nAliquota := nAlqFecopST
	aNFitem[nItem][IT_ALIQSOL] := nAliquota
EndIf

Return(nAliquota)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡„o    ³MaFisVSol ³ Autor ³Edson Maricate         ³ Data ³08.12.1999 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo calcular o valor do ICMS retido³±±
±±³          ³/solidario conforme definido do regulamento de ICMS.         ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisVSOL(nItem)

Local lDevolRet 	:= aParSX6[MV_DEVRET]
Local cMVEstado		:= aParSX6[MV_ESTADO]
Local lSTAtacVar	:= IIf( aTes[TS_ATACVAR] == "1" .And. aNfItem[nItem][IT_PRD][SB_PICMENT] == 0 .And. cMVEstado == "CE" .And. aNFCab[NF_OPERNF] == "E" , .T. , .F.)
Local lSTConfCE 	:= IIf( aTes[TS_STCONF] == "1" .And. aNfItem[nItem][IT_PRD][SB_PICMRET] == 0 .And. cMVEstado == "CE" .And. aNFCab[NF_OPERNF] == "S" , .T. , .F.)
Local nRedDec35701 	:= 0
Local cSimpNac		:= aParSX6[MV_CODREG]
Local nAliIter  	:= 0                                       
Local nRedICCE		:= 0
Local nRedSTCE		:= 0
Local lRegESim	    := aParSX6[MV_REGESIM]
Local cMV_UFPST	    := aParSX6[MV_UFPST21]
Local cTipoCliFor   := IIf( !Empty(aNfCab[NF_PNF_TPCLIFOR]) , aNfCab[NF_PNF_TPCLIFOR] , aNfCab[NF_TPCLIFOR] )
Local nRedBaST	  	:= Iif(Len(aNFItem[nItem][IT_EXCECAO]) > 0 .And. aNFItem[nItem][IT_EXCECAO][26] > 0,aNFItem[nItem][IT_EXCECAO][26],aTes[TS_BSICMST])
// Abaixo necessitamos saber qual seria a alíquota do ST sem a possível diferenciação, por causa de uma exceção fiscal por exemplo.
Local nAliqDest 	:=	Val(Subs(aParSX6[MV_ESTICM],AT(aNFCab[NF_UFDEST],aParSX6[MV_ESTICM])+2,2))
// Compado o que seria a alíquota com a que está sendo utilizada e encontro a proporção de redução da alíquota
Local nRedAlqST		:= Iif(aNfItem[nItem][IT_ALIQSOL]>0 .And. aNfItem[nItem][IT_ALIQSOL] < nAliqDest, aNfItem[nItem][IT_ALIQSOL]/nAliqDest,1)
//Tratamento específico de PB para ignorar o tratamento para venda não presencial
Local lNConf21	  := Iif( aNfCab[NF_UFDEST]=="PB" .And. aNfCab[NF_VTOTPED]>0 .And. aNfCab[NF_VTOTPED]<500, .T. ,.F. )
Local nReduzICMS  := 0

// Carrega a reducao da base do ICMS
If !Empty(aNFitem[nItem,IT_EXCECAO]) .And. aNfItem[nItem,IT_EXCECAO,14] > 0
	nReduzICMS := aNfItem[nItem,IT_EXCECAO,14]
Else
	nReduzICMS := aTes[TS_BASEICM]
EndIf

If !(aNFitem[nItem][IT_TIPONF ]$'IP')
	If aNfItem[nItem][IT_BASESOL] <> 0
		MaFisTes(aNfItem[nItem][IT_TES],aNfItem[nItem][IT_RECNOSF4],nItem)
		If aTES[TS_INCSOL]=="A"
			aNfItem[nItem][IT_VALSOL] := ( aNfItem[nItem][IT_BASESOL]*(aNfItem[nItem][IT_MARGEM]/100) )
			aNfItem[nItem][IT_VALSOL] := ( aNfItem[nItem][IT_VALSOL] * aNfItem[nItem][IT_ALIQSOL]/100 )
			If nRedBaST > 0
				aNfItem[nItem][IT_VALSOL] := (aNfItem[nItem][IT_VALSOL]*nRedBaST)/100
			EndIf
			MaItArred(nItem,{"IT_VALSOL"})
			aNfItem[nItem][IT_VALICM] -= Max(0,NoRound(aNfItem[nItem][IT_VALSOL]*aNfItem[nItem][IT_ALIQICM]/100,2))
			MaItArred(nItem,{"IT_VALICM"})
		Else
			aNfItem[nItem][IT_VALSOL] := ( aNfItem[nItem][IT_BASESOL] * aNfItem[nItem][IT_ALIQSOL]/100 )
			If aTes[TS_CRPRST] == 0
				MaItArred(nItem,{"IT_VALSOL"})
			EndIf
			//Tratamento implementado para os estados de MG e AM referente ao credito presumido do contratante do servico de transporte.
			//    Este tratamento deve refletir o calculo do ICMS Normal de direito do contratante e o ICMS Retido como debito na apuracao
			//    jah deduzindo o Credito presumido.
			//    Ex: Em uma operacao interna, a entrada do CTR no valor de R$1.000,00 deverah ficar da seguinte forma:
			//
			//    ICMS Normal
			//    BC = 1000, Aliq = 18, VL ICMS = 180
			//
			//    ICMS Retido
			//    BC = 1000, Aliq = 18, VL ICMS Ret = 144, CRED PRES = 36
			//
			//    OBS: Este valor retido de 144 eh lancado automaticamente na Apuracao de ICMS/ST em outros debitos devido a configuracao
			//         da TES(F4_CREDST=3)
			//³         da TES(F4_CREDST=3)                                                                                                |
			If	!(cMVEstado$"MG/AM" .And.;
				aTes[TS_CRPRST]<>0 .And.;
				(AllTrim(aNFCab[NF_ESPECIE]) $ "CTR/CTE" .Or. "NFST"$AllTrim(aNFCab[NF_ESPECIE])))
				
				If !lSTAtacVar .And. !lSTConfCE
					
					//  Reduz o valor do ICMS conforme margem de reducao do ST, para subtrair do valor do ICMS-ST calculado.
					//  Tanto nos casos do campo TS_APLIRED = 1 ou TS_APLIRED = 3, o ICMS só é reduzido para o cálculo do ST
					//	o ICMS prórpio da operação não terá nenhuma alteração.
					If aTes[TS_APLIRED]=="1" .And. nRedBaST > 0
						aNfItem[nItem][IT_VALSOL] -= ((aNfItem[nItem][IT_BASEICM] * nRedBaST/100)* aNfItem[nItem][IT_ALIQSOL]/100)
						// Neste caso iremos reduzir o valor do ICMS conforme foi a redução de BC da ST e/ou conforme a diferença da alíquota
						// vide Help do campo F4_APLIRED para mais detalhes
					ElseIf aTes[TS_APLIRED]=="3" .And. ( nRedBaST > 0 .Or. nRedAlqST <> 1 )
						aNfItem[nItem][IT_VALSOL] -= ((aNfItem[nItem][IT_BASEICM] * Iif(nRedBaST==0,100,nRedBaST)/100)* ((aNfItem[nItem][IT_ALIQICM]/100)*nRedAlqST ) )
						MaItArred(nItem,{"IT_VALSOL"})
					ElseIf aTes[TS_APLIRED]=="4"
						aNfItem[nItem][IT_VALSOL] -= (aNfItem[nItem][IT_BASEICM] * (aNfItem[nItem][IT_ALIQSOL]/100))
					Else
						//Conforme a legislação Lei 9.480 de 17.12.2010 para o Estado de Mato Grosso,
						//Nao deduzir o valor do ICMS proprio no valor de ICMS ST.
						If  aTes[TS_ICMSTMT]=="1"
							aNfItem[nItem][IT_VALSOL] -= (aNfItem[nItem][IT_VALICM] + aNfItem[nItem][IT_DESCZF]  - aNfItem[nItem][IT_DESCZFPIS] - aNfItem[nItem][IT_DESCZFCOF])
						Endif
					EndIf
					//Decreto 35.701 de 19/10/2010 para vendas para o estado de Pernambuco
					If aTes[TS_PR35701]<>0 .And. aNFCab[NF_OPERNF]=='S' .And. aNFCab[NF_UFDEST]=="PE"
						If aNfItem[nItem][IT_PAUTST] <> 0
							nRedDec35701 := aNfItem[nItem][IT_VALICM] - ((aNfItem[nItem][IT_VALICM])* aTes[TS_PR35701]/100)
							aNfItem[nItem][IT_VALSOL] := ( aNfItem[nItem][IT_BASESOL] * aNfItem[nItem][IT_ALIQSOL]/100 ) - nRedDec35701
						Else
							nRedDec35701 :=((aNfItem[nItem][IT_BASEICM] * aNfItem[nItem][IT_ALIQICM]/100)* aTes[TS_PR35701]/100)
							aNfItem[nItem][IT_VALSOL] := ( aNfItem[nItem][IT_BASESOL] * aNfItem[nItem][IT_ALIQSOL]/100 ) - nRedDec35701
						Endif
						MaItArred(nItem,{"IT_VALSOL"})
					EndIf
					
					//PROTOCOLO ICMS 12/96:  Nas operações interestaduais originárias dos Estados signatários (São Paulo,
					//Rio de Janeiro, Minas Gerais, Rio Grande do Sul, Goiás, Paraná, Tocantins, Espírito Santo, Pernambuco, Bahia e Ceará),
					//destinados aos estabelecimentos situados no Estado do Ceará, fica atribuída ao estabelecimento remetente, na qualidade
					// de sujeito passivo por substituição, a responsabilidade pela retenção e recolhimento do ICMS conforme cálculo abaixo
					If aNFCab[NF_UFORIGEM] $ "SP|RJ|GO|RS|MG|BA|PR|ES|TO|PE|CE" .And. aNFCab[NF_UFDEST] == "CE" .And. aTes[TS_REDBCCE] <> 0
						nRedICCE := ((aNfItem[nItem][IT_BASEICM] * aNfItem[nItem][IT_ALIQICM]/100)* aTes[TS_REDBCCE]/100)
						//
						nRedSTCE := (aNfItem[nItem][IT_BASESOL] * aTes[TS_REDBCCE]/100)
						nRedSTCE := (nRedSTCE * aNfItem[nItem][IT_ALIQSOL]/100)
						//
						aNfItem[nItem][IT_VALSOL] := nRedSTCE - nRedICCE
						MaItArred(nItem,{"IT_VALSOL"})
					Endif
					
					// Credito Outorgado concedido  no calculo do ICMS Retido nas
					// operacoes Interestaduais com o Estado de MG.
					If aTes[TS_CROUTGO] > 0
						If aNfItem[nItem][IT_DESCZF] > 0
							aNfItem[nItem][IT_VALSOL] += (((aNfItem[nItem][IT_DESCZF]/aNfItem[nItem][IT_ALIQICM]) * 100) * aTes[TS_CROUTGO]/100)
						Else
							aNfItem[nItem][IT_VALSOL] += (aNfItem[nItem][IT_BASEICM] * aTes[TS_CROUTGO]/100)
						EndIf
					Endif
				EndIf
			EndIf
		EndIf
		//Credito Presumido(20%) sobre prestacao servico de transporte com ICMS/ST devido ao alienante/remetente
		//  da operacao - Decreto 44.147/2005 (MG)
		//- Esta sendo considerado a entrada deste credito como 100% do valor, sem a deducao (20%).Portanto devo
		//  subtrair do ICMS/ST Retido o valor de credito (20%), gravar na referencia LF_CRPRST que devera ser
		//  tratado na apresentacao das informacoes complementares da apuracao.
		If aTes[TS_CRPRST]<>0
			aNfItem[nItem][IT_VLCSOL]	:=	aNfItem[nItem][IT_VALSOL]
			aNfItem[nItem][IT_VALSOL]	-=	(aNfItem[nItem][IT_VALSOL]/100)*aTes[TS_CRPRST]
			MaItArred(nItem,{"IT_VALSOL"})
		EndIf
		//Cálculo de ICMS ST com carga líquida
		IF aTes[TS_F4_STLIQ] == "1"	.AND. aNfItem[nItem][IT_UFXPROD][UFP_MARGSTLIQ] > 0 .AND. aNfItem[nItem][IT_UFXPROD][UFP_ALIQSTLIQ] >0			
			aNfItem[nItem][IT_ALIQSOL]	:=	aNfItem[nItem][IT_UFXPROD][UFP_ALIQSTLIQ]
			aNfItem[nItem][IT_VALSOL] 	:= 	(aNfItem[nItem][IT_BASESOL] * aNfItem[nItem][IT_ALIQSOL]) / 100								
		EndIF 
		If aNFCab[NF_TIPONF] $ "DB" .Or. aTes[TS_PODER3] =="D"
			If !Empty(aNFItem[nItem][IT_RECORI])
				If aNFCab[NF_TIPONF] $ "DB"
					If ( aNFCab[NF_CLIFOR] == "C")
						dbSelectArea("SD2")
						MsGoto(aNFItem[nItem][IT_RECORI])
						If (SD2->D2_ICMSRET > 0 .Or. Abs(aNfItem[nItem][IT_VALSOL]-SD2->D2_ICMSRET)<=1 .Or. lDevolRet) .And. aNfItem[nItem][IT_QUANT] = SD2->D2_QUANT .And. SD2->D2_VALFRE+SD2->D2_SEGURO+SD2->D2_DESPESA==0
							aNfItem[nItem][IT_VALSOL] := SD2->D2_ICMSRET
						Else
							If !aNfCab[NF_CALCSUF]$'IN '.And. aParSX6[MV_DESCZF] .And. aParSX6[MV_DESZFPC]
								aNfItem[nItem][IT_VALSOL] := (SD2->D2_ICMSRET / SD2->D2_QUANT) * aNfItem[nItem][IT_QUANT]
							EndIf
						EndIf
					Else
						dbSelectArea("SD1")
						MsGoto(aNFItem[nItem][IT_RECORI])
						If (SD1->D1_ICMSRET > 0 .Or. Abs(aNfItem[nItem][IT_VALSOL]-SD1->D1_ICMSRET)<=1 .Or. lDevolRet) .And. aNfItem[nItem][IT_QUANT] = SD1->D1_QUANT .And. SD1->D1_VALFRE+SD1->D1_SEGURO+SD1->D1_DESPESA==0
							aNfItem[nItem][IT_VALSOL] := SD1->D1_ICMSRET
						EndIf
					EndIf
				Else
					If ( aNFCab[NF_CLIFOR] == "C")
						dbSelectArea("SD1")
						MsGoto(aNFItem[nItem][IT_RECORI])
						If (SD1->D1_ICMSRET > 0 .Or. Abs(aNfItem[nItem][IT_VALSOL]-SD1->D1_ICMSRET)<=1) .And. aNfItem[nItem][IT_QUANT] = SD1->D1_QUANT .And. SD1->D1_VALFRE+SD1->D1_SEGURO+SD1->D1_DESPESA==0
							// 29.02.2012 - FNC 00000004584/2012-00
							// Independente do valor encontrado (via excecao fiscal ou nao), o valor da base
							// e o valor do imposto deve ser o mesmo da nota original
							aNfItem[nItem][IT_VALSOL] := SD1->D1_ICMSRET
							aNfItem[nItem][IT_BASESOL]:= SD1->D1_BRICMS
						EndIf
					Else
						dbSelectArea("SD2")
						MsGoto(aNFItem[nItem][IT_RECORI])
						If (SD2->D2_ICMSRET > 0 .Or. Abs(aNfItem[nItem][IT_VALSOL]-SD2->D2_ICMSRET)<=1) .And. aNfItem[nItem][IT_QUANT] = SD2->D2_QUANT .And. SD2->D2_VALFRE+SD2->D2_SEGURO+SD2->D2_DESPESA==0
							aNfItem[nItem][IT_VALSOL] := SD2->D2_ICMSRET
							aNfItem[nItem][IT_BASESOL]:= SD2->D2_BRICMS
						EndIf
					EndIf
				EndIf
			EndIf
		EndIf
		If (aNfItem[nItem][IT_VALSOL]<0 .And. aNfItem[nItem][IT_BASESOL]>0) .Or. (aNfItem[nItem][IT_VALSOL]<0 .And. aNfItem[nItem][IT_BASESOL]<0)
			aNfItem[nItem][IT_VALSOL]	:= 	0  
			aNfItem[nItem][IT_BASESOL]  := 0
			aNfItem[nItem][IT_ALIQSOL]  := 0
		EndIf
	Else
		aNfItem[nItem][IT_VALSOL]	:= 	0
	EndIf
EndIf

//³Simples Nacional - ICMS solidario.
If ( cSimpNac $ "1/2" .And. aNFCab[NF_OPERNF] == "S" .And. aNfItem[nItem][IT_VALSOL] > 0 .And. cTipoCliFor == "F" ) .Or. ;
   (( aTes[TS_VENPRES] == "2" .And. aNFCab[NF_UFDEST] $ cMV_UFPST .And. cTipoCliFor == "F" .And. ;
   (aNFCab[NF_LINSCR] .Or. SA1->A1_CONTRIB == "2") .And. aTes[TS_MKPSOL]=="1" .AND. aNfItem[nItem][IT_BASESOL]>0  ) .And. !lNConf21 ) .Or. ;
   (aNFCab[NF_OPERNF] == "E" .And. aTes[TS_ICM] == "N" .And. aNfItem[nItem][IT_BASESOL] > 0 .And. aNFCab[NF_SIMPNAC] == "1")
	
	If aNFCab[NF_UFORIGEM] <> aNFCab[NF_UFDEST]
		nAliIter := IIf(aNFCab[NF_UFORIGEM] $ "SP|RJ|MG|RS|PR|SC" .And. (aNFCab[NF_UFDEST] $ aParSX6[MV_NORTE] .Or. aNFCab[NF_UFDEST] $ cMV_UFPST),7,12)
	Else
		nAliIter := aNfItem[nItem][IT_ALIQSOL]
	EndIF
	If aTes[TS_ICMSTMT]=="1"
		aNfItem[nItem][IT_VALSOL] := (aNfItem[nItem][IT_BASESOL]*(aNfItem[nItem][IT_ALIQSOL]/100)) - (Iif(nReduzICMS > 0 .And. aParSX6[MV_BASERET] == "S",aNfItem[nItem][IT_BASEICM], aNfItem[nItem][IT_BICMORI] )*(nAliIter/100))
	EndIf	
EndIf

// ------------------------------------------------------------------------------------------------------
// ------- >>
// Caso nao haja valor de ICMS solidario deve-se zerar a base
// de calculo do ICMS-ST
// ------- >>
//
// Essa alteracao foi comentada devido a uma consulta feita pelo cliente Nestle a Sefaz de Sao Paulo
// onde a Sefaz informa que, mesmo que o valor de ICMS Retido seja zerado, caso exista um valor de Base
// de Calculo, este devera ser informado no documento fiscal e posteriormente no XML (Tag - vBCST).
// Alteracao feita atraves do chamado TGQDW4.
// Foi feito um teste com a transmissao da nota fiscal e nao houve erro de validacao/transmissao.
//Tags:
//	<modBCST>0</modBCST>
//	<vBCST>5.36</vBCST>
//	<pICMSST>18.00</pICMSST>
//	<vICMSST>0</vICMSST>

//If aNfItem[nItem][IT_VALSOL] == 0
//	aNfItem[nItem][IT_BASESOL]	:= 0
//EndIf

// ------------------------------------------------------------------------------------------------------ 

//Base de Calculo do ICMS ST nas operacoes substituidos do MT,
//com base no CNAE do Anexo XI e XVI do RICMS/MT de acordo com
//os art. 87-J-6 ao art. 87-J-16 do RICMS/MT e decreto 392/2011
If lRegESim .And. aNfItem[nItem][IT_BASRESI] > 0 .And. aTES[TS_MKPCMP]<>"1"
	
	If Len(aNfItem[nItem][IT_EXCECAO]) > 0 .And. aNfItem[nItem][IT_EXCECAO][1] > 0 .And. !aNFCab[NF_TIPONF] $ "DB"
		nAliIter := aNfItem[nItem][IT_EXCECAO][1]
	Else
		nAliIter := aNfItem[nItem][IT_ALIQSOL]
	EndIf
	
	MaItArred(nItem,{"IT_BASRESI"})
	aNfItem[nItem][IT_BASESOL] := aNfItem[nItem][IT_BASRESI]/(nAliIter/100)
	aNfItem[nItem][IT_VALSOL]  := aNfItem[nItem][IT_VALRESI]
	aNfItem[nItem][IT_ALIQSOL] := nAliIter
	
EndIf
Return(Nil)
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaALIQCMP ³ Autor ³ Edson Maricate        ³ Data ³08.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Executa o calculo da aliquota do ICMS complementar.         ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaALIQCMP(nItem)

Local nAliquota	:= aNfItem[nItem][IT_ALIQICM]

//MaFisFECP(nItem)

If !(aNFCab[NF_UFORIGEM]$"EX") .And. aNFCab[NF_UFORIGEM] <> aNFCab[NF_UFDEST]
	
	nAliquota := aNfItem[nItem][IT_PRD][SB_PICM]
	
	If aNFCab[NF_TIPONF] == "D"  // devolucao
		nAliquota := Iif( nAliquota <> 0 , nAliquota , MaAliqOrig(nItem) )
	Else
		nAliquota := Iif( nAliquota <> 0 , nAliquota , MaAliqDest(nItem) )
	EndIf
	
	// --> Calculo atraves da tabela CFC para FECP (todas as regras foram estabelecidas na MaFisFecp)
	If aNfItem[nItem][IT_UFXPROD][UFP_ALIQFECP] > 0
		nAliquota	+=	aNfItem[nItem][IT_ALFCCMP]
	
	// --> Calculo atraves do FECP Legado
	Else
		If nAliquota > 0 .And. aNFCab[NF_OPERNF] == "E" .And. !aNFCab[NF_LINSCR]
			If aParSX6[MV_ESTADO] == "RJ"
				nAliquota += aNfItem[nItem][IT_ALIQFECP]
			ElseIf aParSX6[MV_ESTADO] == "BA"
				nAliquota += aNfItem[nItem][IT_ALIQFECP]
			ElseIf aParSX6[MV_ESTADO] == "MT"
				nAliquota += aNfItem[nItem][IT_ALFECMT]
			ElseIf aParSX6[MV_ESTADO] == "RN"
				nAliquota += aNfItem[nItem][IT_ALFECRN]
			EndIf
		EndIf
		
		If nAliquota > 0 .And. aNFCab[NF_OPERNF] == "S" .And. !aNFCab[NF_LINSCR] .And. aNFCab[NF_TIPONF] == "D"
			If aParSX6[MV_ESTADO] == "RJ"
				nAliquota += aNfItem[nItem][IT_ALIQFECP]
			ElseIf aParSX6[MV_ESTADO] == "BA"
				nAliquota += aNfItem[nItem][IT_ALIQFECP] 
			ElseIf aParSX6[MV_ESTADO] == "MT"
				nAliquota += aNfItem[nItem][IT_ALFECMT]
			ElseIf aParSX6[MV_ESTADO] == "RN"
				nAliquota += aNfItem[nItem][IT_ALFECRN]
			EndIf
		EndIf
	Endif
EndIf

aNfItem[nItem][IT_ALIQCMP]	:= nAliquota

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisVComp³ Autor ³ Edson Maricate        ³ Data ³08.12.1999³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Executa o calculo do ICMS Complementar / Antecipacao ICMS   ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisVComp(nItem)
Local nMargem 		:= 0
Local nBase   		:= 0
Local nReduzICMS 	:= 0
Local nVlIcmOri		:= 0
Local nRedAntec 	:= 0
Local cSimpNac		:= aParSX6[MV_CODREG]

// Reducao no Valor de Antecipação de ICMS
nRedAntec 	:= aTes[TS_REDANT]

//Valor do ICMS original, sem a reducao na base de calculo.
nVlIcmOri := aNfItem[nItem][IT_BICMORI] * (aNfItem[nItem][IT_ALIQICM]/100)

// Carrega a reducao da base do ICMS
If !Empty(aNFitem[nItem,IT_EXCECAO]) .And. aNfItem[nItem,IT_EXCECAO,14] > 0
	nReduzICMS := aNfItem[nItem,IT_EXCECAO,14]
Else
	nReduzICMS := aTes[TS_BASEICM]
EndIf

aNfItem[nItem][IT_VALCMP] := 0
aNfItem[nItem][IT_VALANTI] := 0

If aTes[TS_COMPL] == "S" .And.(aTes[TS_ICM] $ "S/N" .Or. cSimpNac $ "1")
	If ( aNFCab[NF_UFORIGEM] <> aNFCab[NF_UFDEST] ) .And. aTes[TS_MKPCMP]=="2"
		// Calculo do ICMS Complementar por margem de lucro
		nMargem := aNfItem[nItem][IT_MARGEM]              
		//Tratamento efetuado para que o IPI NÃO seja considerado na Base de Cálculo do ICC, conforme solicitado na Portaria CAT 75 de 2008, Artigo 2º do
		//Regulamento de ICMS do Estado de São Paulo orienta sobre o assunto, na qual preve fato gerador do ICMS, quando ocorrer a entrada em estabelecimento do
		//Simples Nacional de mercadorias oriundas de outros Estados.
		nBase   := IIf(aTes[TS_AGREG]<>"F",aNfItem[nItem][IT_VALMERC]-IIf(aTes[TS_AGREG]$"DR",aNfItem[nItem][IT_DEDICM],0),0)+;  
		Iif(aNfCab[NF_TPCLIFOR]=="R" .And. cSimpNac $ "1" .And. aParSX6[MV_ESTADO] == "SP" .And. aNFCab[NF_UFORIGEM] <> aNFCab[NF_UFDEST],0,aNfItem[nItem][IT_VALIPI])+;
		aNfItem[nItem][IT_FRETE]+aNfItem[nItem][IT_SEGURO]+aNfItem[nItem][IT_DESPESA]
		If aTes[TS_AGREG]<>"F"
			nBase   -= (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT])
		EndIf
		// Operacoes de venda para consumidor final nao podem ter
		// margem de lucro se o destino for para uso e consumo.
		If aTes[TS_CONSUMO]$"SO" .And.;
			(	( aNfCab[NF_TPCLIFOR]=="F" .And. aNfCab[NF_CLIFOR]=="C" ) .Or.;
			( aNfCab[NF_CLIFOR]=="F" ) ) .And.;
			aNFCab[NF_UFORIGEM] <> aNFCab[NF_UFDEST]
			nMargem := 0
		EndIf
		If nReduzICMS > 0 .And. aParSX6[MV_BICMCMP]
			nBase := (nBase*nReduzICMS)/100
			aNfItem[nItem][IT_PREDCMP]	:= nReduzICMS
		EndIf
		If nMargem > 0
			nBase := nBase*(1+(nMargem/100))
			aNfItem[nItem][IT_MVACMP]	:= nMargem
		EndIf
	
		aNfItem[nItem][IT_VALCMP] := (IIf(aParSX6[MV_BICMCMP],aNfItem[nItem][IT_BASEICM],nBase)*(aNfItem[nItem][IT_ALIQCMP]/100)) - Iif( aTes[TS_COMPRED] $ " 1", aNfItem[nItem][IT_VALICM], nVlIcmOri )
		if aTes[TS_COMPL] == "S" .And. aTes[TS_ICM] == "N" .and. aNFCab[NF_SIMPNAC] =="1" .and. aTes[TS_CIAP] == "S"
			aNfItem[nItem][IT_VALICM] := 0	
		endif	
		/* ------------------------------------------------------------------------------------------------------------------
		  Foi criado o parametro MV_DIFALIQ para que o usuario informe uma aliquota especifica a ser utilizada no calculo
		   do ICMS Complementar.
		  Ao aplicar esta aliquota, ira ignorar as regras utilizadas no calculo de diferenciacao entre aliquota interna e
		   aliquota interestadual.
		---------------------------------------------------------------------------------------------------------------------- */
		If aParSX6[MV_DIFALIQ] <> 0
			aNfItem[nItem][IT_VALCMP] := ( nBase * aParSX6[MV_DIFALIQ] ) / 100
		Endif
	
	Else
		If ( aNFCab[NF_UFORIGEM] <> aNFCab[NF_UFDEST] ) .And. aNFCab[NF_TPCLIFOR] <> "X"
		
			/* ------------------------------------------------------------------------------------------------------------------
			  O diferencial de alíquotas, na aquisição interestadual de material de uso e consumo ou ativo imobilizado,
			   o contribuinte, mesmo que optante pelo Simples Nacional, estará sujeito ao recolhimento do diferencial de alíquotas
			   fora do regime simplificado
			---------------------------------------------------------------------------------------------------------------------- */
			If aNFCab[NF_SIMPNAC] =="1" .And. aTes[TS_COMPL] == "S" .And. aTes[TS_CONSUMO]$"S" .And. aNFCab[NF_CLIFOR] =="F" .And. aNfItem[nItem][IT_ALIQCMP] >aNfItem[nItem][IT_ALIQDIF]
				aNfItem[nItem][IT_VALCMP] := (aNfItem[nItem][IT_BASEICM]*((aNfItem[nItem][IT_ALIQCMP] - aNfItem[nItem][IT_ALIQDIF]) /100))
			Else
				If aParSX6[MV_BICMCMP]
					aNfItem[nItem][IT_VALCMP] := (aNfItem[nItem][IT_BASEICM]*(aNfItem[nItem][IT_ALIQCMP]/100)) - Iif( aTes[TS_COMPRED] $ " 1", aNfItem[nItem][IT_VALICM], nVlIcmOri )
				Else
					aNfItem[nItem][IT_VALCMP] := (aNfItem[nItem][IT_BICMORI]*(aNfItem[nItem][IT_ALIQCMP]/100)) - Iif( aTes[TS_COMPRED] $ " 1", aNfItem[nItem][IT_VALICM], nVlIcmOri )
				Endif
			EndIf
			
			If aNFCab[NF_SIMPNAC] == "1" .And. aTes[TS_COMPL] == "S" .And. aTes[TS_CIAP] == "S"
				aNfItem[nItem][IT_BASEICM] := 0
				aNfItem[nItem][IT_VALICM]  := 0
			Endif
			
			If aParSX6[MV_BICMCMP]
				aNfItem[nItem][IT_PREDCMP]	:= nReduzICMS
			Else
				aNfItem[nItem][IT_PREDCMP]	:= 0
			Endif
			
			/* ------------------------------------------------------------------------------------------------------------------
			  Foi criado o parametro MV_DIFALIQ para que o usuario informe uma aliquota especifica a ser utilizada no calculo
			   do ICMS Complementar.
			  Ao aplicar esta aliquota, ira ignorar as regras utilizadas no calculo de diferenciacao entre aliquota interna e
			   aliquota interestadual.
			---------------------------------------------------------------------------------------------------------------------- */
			If aParSX6[MV_DIFALIQ] <> 0
				If aParSX6[MV_BICMCMP]
					aNfItem[nItem][IT_VALCMP] := ( aNfItem[nItem][IT_BASEICM] * aParSX6[MV_DIFALIQ] ) / 100
				Else
					aNfItem[nItem][IT_VALCMP] := ( aNfItem[nItem][IT_BICMORI] * aParSX6[MV_DIFALIQ] ) / 100
				Endif
			Endif
			
		EndIf
	EndIf
EndIf

//Antecipacao ICMS - Mesma Regra do ICMS Complementar
If aTes[TS_ANTICMS] == "1"
	If ( aNFCab[NF_UFORIGEM] <> aNFCab[NF_UFDEST] ) .And. aNFCab[NF_TPCLIFOR] <> "X"
		IF aNFCab[NF_SIMPNAC] == "1"
			//A Antecipação tributária para Fornecedor optante pelo Simples Nacional será calculado com alíquota interestadual normal, aplicando a
			//Alíquota que se aplicaria a operação caso o fornecedor não fosse optante pelo SN e não a que foi utiliza e destacada na nota fiscal.
			aNfItem[nItem][IT_VALANTI]:= (aNfItem[nItem][IT_BICMORI]*((aNfItem[nItem][IT_ALIQCMP]-aNFitem[nItem][IT_ALIQDIF])/100)) 		
		ElseIf aTes[TS_INCIDE] == "N" .And. aTes[TS_IPIANTE] == "1"
			aNfItem[nItem][IT_VALANTI]:= ((aNfItem[nItem][IT_BICMORI]+aNfItem[nItem][IT_VALIPI])*(aNfItem[nItem][IT_ALIQCMP]/100)) -;
			(nVlIcmOri + (aNfItem[nItem][IT_VALIPI] *(aNfItem[nItem][IT_ALIQICM]/100) )   )
		ElseIf aTes[TS_INCIDE] == "N" .And. (aParSX6[MV_ESTADO] $ "BA|MA|CE")
			aNfItem[nItem][IT_VALANTI]:= ((aNfItem[nItem][IT_BICMORI]+aNfItem[nItem][IT_VALIPI])*(aNfItem[nItem][IT_ALIQCMP]/100)) - nVlIcmOri
		Else
			aNfItem[nItem][IT_VALANTI]:= (aNfItem[nItem][IT_BICMORI]*(aNfItem[nItem][IT_ALIQCMP]/100)) - nVlIcmOri
		Endif

		//Reducao Antecipação ICMS
		//Decreto  6.284 de 14/03/1997, Art. 352-A § 4º. do Regulame  o do ICMS do Estado da Bahia
		If nRedAntec > 0
			aNfItem[nItem][IT_VALANTI]	:= aNfItem[nItem][IT_VALANTI] * nRedAntec /100
		EndIf
		
	EndIf
EndIf

aNfItem[nItem][IT_VALCMP] := Max(0,aNfItem[nItem][IT_VALCMP])
aNfItem[nItem][IT_VALANTI]:= Max(0,aNfItem[nItem][IT_VALANTI])

Return(.T.)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡„o    ³MaFisIPI  ³ Autor ³Alexandre Lemes        ³ Data ³21/11/2012 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³ Calculo do imposto sobre produtos industrializacos ( IPI ). ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisIPI(nItem,cExecuta,lNoProces)

Local aRastItem	 := {}
Local nQuantPed  := 0
Local nReduzIPI  := 0
Local nSalvaBase := aNfItem[nItem][IT_BASEIPI]
Local lExistNF   := .F.
Local lDevolBSE  := .F.
Local lDevolALQ  := .F.
Local lDevolVLR  := .F.
Local nQuantida  :=  0
Local lRndrne    := aParSX6[MV_RNDIPI]
Local lSobra 	 := aParSX6[MV_RNDSOBR] 

DEFAULT cExecuta  := "BSE|ALQ|VLR"
DEFAULT lNoProces := .F.

MaFisTes(aNfItem[nItem][IT_TES],aNfItem[nItem][IT_RECNOSF4],nItem)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³O bloco a seguir providencia para que em operações de devolução e ou beneficiamento quando o parametro MV_DEVTOT = .T.          ³
//³o valor da BASE do IPI seja igual a  Base do Imposto do documento Original quando a devolução e ou beneficiamento for           ³
//³igual a do documento original, se houverem despesas acessorias inclusas na base do documento original (Frete, Despesas e Seguro)³
//³as mesmas deverão ser digitadas manualmente no documento de devolução.                                                          ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If !Empty(aNFItem[nItem][IT_RECORI]) .And. ( aNFCab[NF_TIPONF] $ "DB" .Or. aTes[TS_PODER3] == "D" )
	
	lExistNF := RetComp( aNFCab[NF_CLIFOR] , aNFItem[nItem][IT_RECORI] )
	
	If aNFCab[NF_TIPONF] $ "DB"
		If aNFCab[NF_CLIFOR] == "C"
			SD2->(MsGoto(aNFItem[nItem][IT_RECORI]))
			If !lExistNF .And. aNfItem[nItem][IT_QUANT] == SD2->D2_QUANT  .And. Iif(!aParSX6[MV_DEVTOT] ,SD2->D2_VALFRE+SD2->D2_SEGURO+SD2->D2_DESPESA==0 , SD2->D2_BASEIPI >0) .Or. ;
				(!aNfCab[NF_CALCSUF]$"IN " .And. aParSX6[MV_DESCZF] .And. aParSX6[MV_DESZFPC] )
				aNfItem[nItem][IT_BASEIPI] := SD2->D2_BASEIPI
				aNfItem[nItem][IT_PREDIPI]	:= aTes[TS_BASEIPI]
				lDevolBSE := .T.
			EndIf
			aNFitem[nItem][IT_ALIQIPI] := SD2->D2_IPI
			aNFitem[nItem][IT_TIPONF ] := IIf( SD2->D2_TIPO$"IP" , SD2->D2_TIPO , aNfCab[NF_TIPONF] )
			lDevolALQ := .T.
			If (SD2->D2_VALIPI > 0 .Or. Abs( aNfItem[nItem][IT_VALIPI] - SD2->D2_VALIPI) <= 1 ) .And. aNfItem[nItem][IT_QUANT] == SD2->D2_QUANT .And. Iif(!aParSX6[MV_DEVTOT] , SD2->D2_VALFRE+SD2->D2_SEGURO+SD2->D2_DESPESA == 0 , SD2->D2_VALIPI > 0)
				aNfItem[nItem][IT_VALIPI] := SD2->D2_VALIPI
				lDevolVLR := .T.
			EndIf
		Elseif aTes[TS_IPI] <> "R"
			SD1->(MsGoto(aNFItem[nItem][IT_RECORI]))
			If !lExistNF .And. aNfItem[nItem][IT_QUANT] == SD1->D1_QUANT .And. Iif(!aParSX6[MV_DEVTOT] , SD1->D1_VALFRE+SD1->D1_SEGURO+SD1->D1_DESPESA==0 ,SD1->D1_BASEIPI > 0)
				aNfItem[nItem][IT_BASEIPI] := SD1->D1_BASEIPI
				aNfItem[nItem][IT_PREDIPI]	:= aTes[TS_BASEIPI]
				lDevolBSE := .T.
			EndIf
			aNFitem[nItem][IT_ALIQIPI] := SD1->D1_IPI
			aNFitem[nItem][IT_TIPONF ] := IIf( SD1->D1_TIPO$"IP" , SD1->D1_TIPO , aNfCab[NF_TIPONF] )
			lDevolALQ := .T.
			If (SD1->D1_VALIPI > 0 .Or. Abs( aNfItem[nItem][IT_VALIPI] - SD1->D1_VALIPI) <= 1 ) .And. aNfItem[nItem][IT_QUANT] == SD1->D1_QUANT .And. Iif(!aParSX6[MV_DEVTOT] , SD1->D1_VALFRE+SD1->D1_SEGURO+SD1->D1_DESPESA == 0 , SD1->D1_VALIPI > 0)
				aNfItem[nItem][IT_VALIPI] := SD1->D1_VALIPI
				lDevolVLR := .T.
			EndIf
		EndIf
	Else
		If aNFCab[NF_CLIFOR] == "C"
			SD1->(MsGoto(aNFItem[nItem][IT_RECORI]))
			If !lExistNF .And. aNfItem[nItem][IT_QUANT] == SD1->D1_QUANT .And. Iif(!aParSX6[MV_DEVTOT] , SD1->D1_VALFRE+SD1->D1_SEGURO+SD1->D1_DESPESA==0 ,SD1->D1_BASEIPI > 0)
				aNfItem[nItem][IT_BASEIPI] := SD1->D1_BASEIPI
				aNfItem[nItem][IT_PREDIPI]	:= aTes[TS_BASEIPI]
				lDevolBSE := .T.
			EndIf
			aNFitem[nItem][IT_ALIQIPI] := SD1->D1_IPI
			aNFitem[nItem][IT_TIPONF ] := IIf( SD1->D1_TIPO$"IP" , SD1->D1_TIPO , aNfCab[NF_TIPONF] )
			lDevolALQ := .T.
			If (SD1->D1_VALIPI > 0 .Or. Abs(aNfItem[nItem][IT_VALIPI] - SD1->D1_VALIPI) <= 1 ) .And. aNfItem[nItem][IT_QUANT] == SD1->D1_QUANT .And. Iif(!aParSX6[MV_DEVTOT] , SD1->D1_VALFRE+SD1->D1_SEGURO+SD1->D1_DESPESA == 0 , SD1->D1_VALIPI > 0)
				aNfItem[nItem][IT_VALIPI] := SD1->D1_VALIPI
				lDevolVLR := .T.
			EndIf
		Else
			SD2->(MsGoto(aNFItem[nItem][IT_RECORI]))
			If !lExistNF .And. aNfItem[nItem][IT_QUANT] == SD2->D2_QUANT .And. Iif(!aParSX6[MV_DEVTOT] ,SD2->D2_VALFRE+SD2->D2_SEGURO+SD2->D2_DESPESA==0 , SD2->D2_BASEIPI >0)
				aNfItem[nItem][IT_BASEIPI] := SD2->D2_BASEIPI
				aNfItem[nItem][IT_PREDIPI]	:= aTes[TS_BASEIPI]
				lDevolBSE := .T.
			EndIf
			aNFitem[nItem][IT_ALIQIPI] := SD2->D2_IPI
			aNFitem[nItem][IT_TIPONF ] := IIf( SD2->D2_TIPO$"IP" , SD2->D2_TIPO , aNfCab[NF_TIPONF] )
			lDevolALQ := .T.
			If (SD2->D2_VALIPI > 0 .Or. Abs(aNfItem[nItem][IT_VALIPI] - SD2->D2_VALIPI) <= 1 ) .And. aNfItem[nItem][IT_QUANT] == SD2->D2_QUANT .And. Iif(!aParSX6[MV_DEVTOT] , SD2->D2_VALFRE+SD2->D2_SEGURO+SD2->D2_DESPESA == 0 , SD2->D2_VALIPI > 0)
				aNfItem[nItem][IT_VALIPI] := SD2->D2_VALIPI
				lDevolVLR := .T.
			EndIf
		EndIf
	EndIf
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Define BASE do IPI - IT_BASEIPI  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If "BSE" $ cExecuta
	
	If !lDevolBSE
		
		aNfItem[nItem][IT_BASEIPI]	:= 0
		
		If (aTes[TS_IPI] <> "N" .And. !(aTes[TS_IPI]$"R" .And. aNFCab[NF_TIPONF]$"DB")) .And. !aNFitem[nItem][IT_TIPONF ] $ "PI" .And. aNFCab[NF_LJCIPI]
			
			// Calculo da base de IPI.
			If aTes[TS_AGREG]<>"F"
				aNfItem[nItem][IT_BASEIPI]:= aNfItem[nItem][IT_VALMERC] - (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT]) - IIf(aTes[TS_AGREG]$"DR" .And. !aNfCab[NF_ROTINA] == "MATA461" , aNfItem[nItem][IT_DEDICM] , 0 )
			EndIf
			//Deduz PIS/Cofins Zona Franca de Manaus da base de calculo do IPI
			If aParSX6[MV_IPIZFM] .And. ( aNfCab[NF_ROTINA] == "MATA461" .Or. FunName() == "MATA920" )
				aNfItem[nItem][IT_BASEIPI] := aNfItem[nItem][IT_BASEIPI] + aNfItem[nItem][IT_DESCZFPIS] + aNfItem[nItem][IT_DESCZFCOF]
			Endif
			
			//	Cálculo da base de imposto IPI, com o valor do imposto do ICMS próprio.
			If aParSX6[MV_SOMAICM]
				MaFisBSICM(nItem)
				If aTes[TS_AGREG] == "I" .And. aNFCab[NF_OPERNF] == "S"
					MaFisVICMS(nItem)
					aNfItem[nItem][IT_BASEIPI] += aNfItem[nItem][IT_VALICM]
				Endif
			Endif
			
			If aTes[TS_DESPIPI] == "S"
				aNfItem[nItem][IT_BASEIPI] += aNfItem[nItem][IT_DESPESA]
				aNfItem[nItem][IT_BASEIPI] += aNfItem[nItem][IT_SEGURO]
			EndIf
			
			If aTes[TS_IPIFRET] == "S"
				aNfItem[nItem][IT_BASEIPI] += aNfItem[nItem][IT_FRETE]
			EndIf
			
			If aTes[TS_AGREG] <> "F"
				If aTes[TS_TPIPI] == "B" .Or. ( aParSX6[MV_IPIBRUT] == "S" .And. aTes[TS_TPIPI] == " " )
					aNfItem[nItem][IT_BASEIPI] += (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT]) + aNfItem[nItem][IT_DESCZF]
				EndIf
			EndIf
						
			// Salva a base de IPI original e aplica a reducao.
			aNfItem[nItem][IT_BIPIORI]	:= NoRound(aNfItem[nItem][IT_BASEIPI],2)
		
			nReduzIPI := IIf( !Empty(aNFitem[nItem,IT_EXCECAO]) .And. aNfItem[nItem,IT_EXCECAO,15] > 0 , aNfItem[nItem,IT_EXCECAO,15] , aTes[TS_BASEIPI] )
			
			If nReduzIPI <> 0
				If lRndrne .Or. lSobra				
					aNfItem[nItem][IT_BASEIPI] := Round(aNfItem[nItem][IT_BASEIPI] * nReduzIPI / 100 , 2 )
				Else	
					aNfItem[nItem][IT_BASEIPI] := NoRound(aNfItem[nItem][IT_BASEIPI] * nReduzIPI / 100 , 2 )
				EndIf	
								
				aNfItem[nItem][IT_PREDIPI] := nReduzIPI			
			EndIf   	
			
			If aTes[TS_IPI] == "R"
				aNfItem[nItem][IT_BASEIPI] := aNfItem[nItem][IT_BASEIPI] / 2
			EndIf
		EndIf
		
	Else
		If !((aTes[TS_IPI] <> "N" .And. !(aTes[TS_IPI]$"R" .And. aNFCab[NF_TIPONF]$"DB")) .And. !aNFitem[nItem][IT_TIPONF ]$"IP")
			aNfItem[nItem][IT_BASEICM]	:= 0
			aNfItem[nItem][IT_BSFRETE]	:= 0
		EndIf
	EndIf
	
	If lNoProces
		aNfItem[nItem][IT_BASEIPI] := nSalvaBase
	EndIf
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Rastro de Ativo para primeira saida, nao calcula IPI ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If aParSX6[MV_RASTRO] == "S" .And. aParSX6[MV_RSATIVO] .And. aNfCab[NF_OPERNF] == "S" .And. aNfItem[nItem][IT_PRD][SB_RSATIVO] == "1"
		aRastItem := RastroItem(aNfItem[nItem][IT_PRODUTO],aNfItem[nItem][IT_LOTE],Iif(Empty(aNfItem[nItem][IT_SUBLOTE]),AllTrim(aNfItem[nItem][IT_SUBLOTE]),aNfItem[nItem][IT_SUBLOTE]))
		If Len(aRastItem) > 0
			If !aRastItem[1] .And. aRastItem[2] == 0
				aNfItem[nItem][IT_BASEIPI] := 0
			Else
				//TOTALIZA ITENS DO PEDIDO DE VENDA.
				aEval( aNfItem , {|x| nQuantPed += IIf(!x[IT_DELETED] .And. x[IT_PRODUTO] == aNfItem[nItem][IT_PRODUTO] .And. x[IT_LOTE] == aNfItem[nItem][IT_LOTE] .And. x[IT_SUBLOTE] == aNfItem[nItem][IT_SUBLOTE] , x[IT_QUANT] , 0 )} )
				
				If nQuantPed > aRastItem[2]
					//MENSAGEM PARA QUEBRA DOS ITENS.
					If  aRastItem[1] .And. aNfItem[nItem][IT_QUANT] > aRastItem[2] .And. lRastItem
						MsgInfo(STR0033+CRLF+;  //"Para controle correto da geração do IPI, será necessário quebrar em dois Itens:"
						STR0034+aNfItem[nItem][IT_ITEM]+; //Item:
						STR0035+aNfItem[nItem][IT_PRODUTO]+;// Produto:
						STR0036+aNfItem[nItem][IT_LOTE]+; // Lote:
						STR0037+aNfItem[nItem][IT_SUBLOTE]+CRLF+; // Sub-Lote:
						STR0038+Str(aRastItem[2])+CRLF+;//"1- Quantidade Tributada:"
						STR0039+Str(aNfItem[nItem][IT_QUANT]-aRastItem[2])+CRLF+;//"2- Quantidade Não Tributada:"
						STR0040,;//"Não houve alteração do calculo do IPI"
						STR0032) //"Quebra Item, Tributado x Não Tributado"
						If ValType(lPlanRaAtv) <> "U"
							lPlanRaAtv := .F.
							lRastItem := .F.
						EndIf
					Else
						aNfItem[nItem][IT_BASEIPI] := 0
					EndIf
				EndIf
			EndIf
		EndIf
	EndIf

	MaItArred(nItem,{"IT_BASEIPI"})
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Define ALIQUOTA DO IPI IT_ALIQIPI³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If "ALQ" $ cExecuta .And. !lDevolALQ
	
	aNFitem[nItem][IT_ALIQIPI] := 0
	aNFitem[nItem][IT_TIPONF ] := aNfCab[NF_TIPONF]
	
	If (aTes[TS_IPI] <> "N" .And. !(aTes[TS_IPI]$"R" .And. aNFCab[NF_TIPONF]$"DB"))
		
		aNFitem[nItem][IT_ALIQIPI] := aNfItem[nItem][IT_PRD][SB_IPI]
		
		If !Empty(aNFitem[nItem,IT_EXCECAO]) .And. aNFItem[nItem,IT_EXCECAO,17] <> 0 	// Verifica as Excecoes fiscais
			aNFitem[nItem][IT_ALIQIPI] := aNFItem[nItem,IT_EXCECAO,17]
		Endif
		
	EndIf
	
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Define VALOR do IPI    IT_VALIPI ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If "VLR" $ cExecuta .And. !lDevolVLR
	
	aNfItem[nItem][IT_VALIPI]  := 0
	aNfItem[nItem][IT_PAUTIPI] := 0
	
	If (aTes[TS_IPI] <> "N" .And. !(aTes[TS_IPI]$"R" .And. aNFCab[NF_TIPONF]$"DB")) .And. aNFitem[nItem][IT_TIPONF ] <> "I"
		
		If aNFitem[nItem][IT_TIPONF ] == "P"
			If aTes[TS_AGREG] <> "F"
				aNfItem[nItem][IT_VALIPI] := aNfItem[nItem][IT_VALMERC]
			EndIf
		Else
			aNfItem[nItem][IT_VALIPI] := ( aNfItem[nItem][IT_BASEIPI] * aNfItem[nItem][IT_ALIQIPI] / 100 )
			
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Calculo do IPI de Pauta³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If !Empty( aNfItem[nItem][IT_PRD][SB_VLR_IPI] ) .Or. ( !Empty(aNFitem[nItem][IT_EXCECAO]) .And. aNfItem[nItem][IT_EXCECAO][9] <> 0 )
				
				If !Empty(aNFitem[nItem][IT_EXCECAO]) .And. aNfItem[nItem][IT_EXCECAO][9] <> 0
					aNfItem[nItem][IT_VALIPI]  := aNfItem[nItem][IT_QUANT] * aNfItem[nItem][IT_EXCECAO][9]
					aNfItem[nItem][IT_PAUTIPI] := aNfItem[nItem][IT_EXCECAO][9]
				Else
					aNfItem[nItem][IT_VALIPI]  := aNfItem[nItem][IT_QUANT] * aNfItem[nItem][IT_PRD][SB_VLR_IPI]
					aNfItem[nItem][IT_PAUTIPI] := aNfItem[nItem][IT_PRD][SB_VLR_IPI]
				EndIf
				If !Empty(aParSX6[MV_IPIPFAT])
					aNfItem[nItem][IT_VALIPI] *= aNfItem[nItem][IT_PRD][SB_IPIPFAT]
				EndIf	
			EndIf
		EndIf
		
		MaItArred(nItem,{"IT_VALIPI"})
		
	EndIf
	
EndIf

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisISS  ³ Autor ³Alexandre Lemes        ³ Data ³05/11/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Calculo do ISS                                             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisISS(nItem,cExecuta)

Local aIssPrg    := {}
Local cSBCodISS  := aNfItem[nItem][IT_PRD][SB_CODISS]
Local cSBRegrISS := ""
Local cBuffer    := ""
Local cUfPresISS := ""
Local cCodMunISS := ""
Local cCdMunic	 := Iif(Len(Alltrim(SM0->M0_CODMUN))<=5,UfCodIBGE(SM0->M0_ESTENT),"")+SM0->M0_CODMUN
Local nTotalISS  := 0
Local nItValidos := 0
Local nX         := 0
Local nY         := 0
Local nBseISS    := 0
Local nAliqISS   := 0
Local nAliqTMS   := 0
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Abaixo é realizado o tratamento de desconto referente ao ISS    ³
//³nas operações de prestação de serviço para órgão público.       ³
//³                                                                ³
//³Nessa situação, a TES está configurada para NÃO calcular o ISS, ³
//³pois não deve gravar valor de ISS em lugar algum, nem em SD2.   ³
//³E o livro está configurado como Isento.                         ³
//³                                                                ³
//³Neste caso, preciso calcular o que seria o ISS, caso houvesse e ³
//³tratá-lo como desconto, no campo IT_DEDICM.                     ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ  
Local lDescISS	 := (aTes[TS_ISS] == "N" .And. aTes[TS_LFISS] == "I" .And. aNfCab[NF_OPIRRF] == "EP"  .And. aTes[TS_AGREG] == "D")

DEFAULT cExecuta := "BSE|ALQ|VLR"

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Define o Codigo ISS. ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If ("COD" $ cExecuta)
	aNfItem[nItem][IT_PRD][SB_CODISS] := aNfItem[nItem][IT_CODISS]
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Define Aliquota ISS. ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If ("ALQ" $ cExecuta) .Or. (lDescISS)
	
	If aTes[TS_ISS] == "S" .And. aNfCab[NF_OPERNF] == "E" .And. cSBCodISS <> aNfItem[nItem][IT_CODISS]
		aNfItem[nItem][IT_CODISS]	:= cSBCodISS
	EndIf
	
	If ( aNfCab[NF_OPERNF] == "S" .And. (lDescISS .Or. aTes[TS_ISS] == "S") ) .Or.;
		(aNfCab[NF_OPERNF] == "E" .And. !Empty(aNfItem[nItem][IT_CODISS]) .And. (aTes[TS_ISS] == "S" .Or. lDescISS ) ) .Or.;
		( !Empty(aNfCab[NF_NATUREZA]) .And. aInfNat[NT_CALCISS] == "S" .And. aTes[TS_ICM] == "N" .And. aNfCab[NF_OPERNF]$aParSX6[MV_TPNFISS])
		
		aNfItem[nItem][IT_CALCISS] := "S"
		
		nAliqISS := IIf( aNfItem[nItem][IT_ALIQISS] > 0 , aNfItem[nItem][IT_ALIQISS] , IIf( aNfItem[nItem][IT_PRD][SB_ALIQISS] == 0 , aParSX6[MV_ALIQISS] , aNfItem[nItem][IT_PRD][SB_ALIQISS] ) )
		
		If IntTms() .And. nModulo == 43 //TMS
			If aExistPE[PE_TM200ISS]
				nAliqTMS := ExecBlock("TM200ISS",.F.,.F.,{DTC->DTC_SERVIC, DTC->DTC_TIPTRA, DTC->DTC_LOTNFC, DTC->DTC_CLICAL, DTC->DTC_LOJCAL, DTC->DTC_CLIREM, DTC->DTC_LOJREM, DTC->DTC_CLIDES, DTC->DTC_LOJDES})
				If ValType(nAliqTMS) == "N"
					nAliqISS := nAliqTMS
				EndIf
			Else
				If aFieldPos[FP_DUY_ALQISS] // Verifica se foi informada a aliquota do ISS para regiao
					DUY->(dbSetOrder(1))
					DUY->(MsSeek(xFilial("DUY")+aNfCab[NF_CDRDES]))
					If DUY->DUY_ALQISS > 0
						nAliqISS := DUY->DUY_ALQISS
					EndIf
				EndIf
			EndIf
		EndIf
		
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Define a Aliquota do ISS por Excecao Fiscal.³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If ( !Empty(aNFitem[nItem][IT_EXCECAO]) ) .And. aNfItem[nItem][IT_EXCECAO][7] == "S"
			If aNFCab[NF_UFORIGEM] == aNFCab[NF_UFDEST]
				If aNFItem[nItem][IT_EXCECAO][1] > 0
					nAliqISS := aNfItem[nItem][IT_EXCECAO][1] //Aliquota Interna
				EndIf
			Else
				If aNFItem[nItem][IT_EXCECAO][2] > 0
					nAliqISS := aNfItem[nItem][IT_EXCECAO][2] //Aliquota Externa
				EndIf
			EndIf
		EndIf
	Else
		aNfItem[nItem][IT_CALCISS] := "N"
	EndIf
	
	If aNfItem[nItem][IT_ALIQISS] <= 0 //Manter a Aliquota digitada pelo usuario
		aNfItem[nItem][IT_RATEIOISS]:= aTes[TS_ISS]
		aNfItem[nItem][IT_ALIQISS]  := nAliqISS
	EndIf
	
	aNfItem[nItem][IT_CNAE]	:= aNfItem[nItem][IT_PRD][SB_CNAE]
	aNfItem[nItem][IT_CFPS]	:= aTes[TS_CFPS]
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Tratamento para Controle de Aliquota atraves da tabela CE1 - Aliquotas do ISS.³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If aParSX6[MV_ISSXMUN] .And. aTes[TS_ISS] == "S" .And. ((aNfCab[NF_OPERNF] == "E" .And. !aNFCab[NF_TIPONF] $ "DB") .Or. (aNfCab[NF_OPERNF] == "S")) .And. aAliIndic[AI_CE1] 
 
		cUfPresISS := IIf( aNfItem[1][IT_PRD][SB_MEPLES] == "2" , aNFCab[NF_UFPREISS] , aNFCab[NF_UFORIGEM] )
		cCodMunISS := IIf( aNfItem[1][IT_PRD][SB_MEPLES] == "2" , aNfCab[NF_CODMUN]   , IIf( aNfCab[NF_OPERNF] == "S" , Substr(Alltrim(cCdMunic),3,5) , cMunForISS ) )

		cFornCE1   := Space(Len(SA2->A2_COD))
		cLojaCE1   := Space(Len(SA2->A2_LOJA))
		cRecIssCE1 := Iif( aNfCab[NF_OPERNF] == "S" .And. !aNFCab[NF_TIPONF] $ "DB" , "1" , aNFCab[NF_RECISS] )

		CE1->(dbSetOrder(1)) //Cod.Prest.Servico sempre segue o Municipio do cadastro da filial sigamat.emp no caso de operacoes de saida.
		If aNfCab[NF_OPERNF] == "S" .And. CE1->(msSeek(xFilial("CE1")+cSBCodISS+SM0->M0_ESTENT+Substr(Alltrim(cCdMunic),3,5)+aNfItem[nItem][IT_PRODUTO]))
			aNfItem[nItem][IT_CODISS]:= CE1->CE1_CPRISS
		EndIf
			
		If CE1->(msSeek(xFilial("CE1")+cSBCodISS+cUfPresISS+cCodMunISS+aNfItem[nItem][IT_PRODUTO]))
			//ALTERACAO DO MUNICIPIO
			If aNfCab[NF_OPERNF] == "E"
				aNfItem[nItem][IT_CODISS]:= CE1->CE1_CTOISS
			EndIf
			nAliqISS := CE1->CE1_ALQISS
			aNfItem[nItem][IT_ALIQISS]:= nAliqISS
			aNfItem[nItem][IT_CFPS]   := CE1->CE1_CODISS

			If CE1->CE1_RETISS == "1" //Retem ISS 1=SIM / 2=NAO
            	If aNfItem[1][IT_PRD][SB_MEPLES] == "1" // Produto "EP"
					If ( CE1->CE1_RMUISS == "1" .And. Substr(Alltrim(cCdMunic),3,5) == cMunForISS ) .Or.; //cMunForIss e o Municipio Original do Fornecedor
					   ( CE1->CE1_RMUISS == "2" .And. Substr(Alltrim(cCdMunic),3,5) <> cMunForISS ) .Or.;
					   ( CE1->CE1_RMUISS == "3" )

						cFornCE1    := CE1->CE1_FORISS
						cLojaCE1    := CE1->CE1_LOJISS
						cRecIssCE1  := "2"
                    EndIf
            	ElseIf aNfItem[1][IT_PRD][SB_MEPLES] == "2" // Produto "LES"
					If ( CE1->CE1_RMUISS == "1" .And. cCodMunISS == cMunForISS ) .Or.; //cMunForIss e o Municipio Original do Fornecedor
					   ( CE1->CE1_RMUISS == "2" .And. cCodMunISS <> cMunForISS ) .Or.;
					   ( CE1->CE1_RMUISS == "3" )

						cFornCE1    := CE1->CE1_FORISS
						cLojaCE1    := CE1->CE1_LOJISS
						cRecIssCE1  := "2"
                    EndIf
            	EndIf
            EndIf
			aNFCab[NF_RECISS] := Iif( aNfCab[NF_OPERNF] == "S" .And. !aNFCab[NF_TIPONF] $ "DB" , aNFCab[NF_RECISS] , cRecISSCE1 ) 
		Else
			nAliqISS := IIf( aNfItem[nItem][IT_PRD][SB_ALIQISS] == 0 , aParSX6[MV_ALIQISS] , aNfItem[nItem][IT_PRD][SB_ALIQISS] ) 
			aNfItem[nItem][IT_ALIQISS]:= nAliqISS
		EndIf
	EndIf
	
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Define a Base do ISS.³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If ("BSE" $ cExecuta) .Or. (lDescISS)
	
	aNfItem[nItem][IT_BASEISS]:= 0
	
	If (aNfItem[nItem][IT_CALCISS] == "S" .Or. lDescISS ) .And. (aNfCab[NF_OPERNF] == "E" .Or. ;
		((aNfCab[NF_RECISS] == "1" .And. aNfCab[NF_OPERNF] == "S" .And. aParSX6[MV_DESCISS] ) .Or. (aNfCab[NF_RECISS] <> "1" .And. aNfCab[NF_OPERNF] == "S") ) )
		
		nBseISS := aNfItem[nItem][IT_VALMERC] - IIf( aTes[TS_DESCOND] == "2"  , (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT]) , 0 ) //Caso o desconto INCONDICIONAL aTes[TS_DESCOND] == "2" abater o desconto da base de ISS.
		
		If aTes[TS_BASEISS] > 0 // Reducao padrao da base do ISS ( TES )
			nBseISS := ( nBseISS * aTes[TS_BASEISS] ) / 100
			aNfItem[nItem][IT_PREDISS] := aTes[TS_BASEISS]
		EndIf
		
		If aNfItem[nItem,IT_REDISS] > 0 // Reducao opcional da base do ISS ( TES )
			nBseISS := ( nBseISS * aNfItem[nItem,IT_REDISS] ) / 100
			aNfItem[nItem][IT_PREDISS] := aNfItem[nItem,IT_REDISS]
		EndIf
		
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Tratamento de Controle de Deducoes atraves do cadastro CC2 - Municipios. ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If aParSX6[MV_ISSXMUN] .And. aFieldPos[FP_CC2_PERMAT] .And. aFieldPos[FP_CC2_PERSER] .And. aFieldPos[FP_CC2_MDEDMA] .And. aFieldPos[FP_CC2_MDEDSR]
			If aTes[TS_ISS] == "S" .And. ( (aNfCab[NF_OPERNF] == "E" .And. !aNFCab[NF_TIPONF] $ "DB") .Or. (aNfCab[NF_OPERNF] == "S" .And. aNFCab[NF_TIPONF] $ "DB") )
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³Muncio Arbitra o Valor da Deducao 1=SIM e 2=NAO e foi Informado o percentual a Arbitrar. ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				CC2->(dbSetOrder(1))
				If CC2->(MsSeek(xFilial("CC2") + aNFCab[NF_UFORIGEM] + aNfCab[NF_CODMUN]))
					If CC2->CC2_PERMAT > 0 //Municipio Arbitra Deducoes de Materiais.
						aNfItem[nItem,IT_ABMATISS]	:=	nBseISS * (CC2->CC2_PERMAT/100)
					EndIf
					If CC2->CC2_PERSER > 0  //Municipio Arbitra Deducoes de Servicos.
						aNfItem[nItem,IT_ABVLISS]	:=  nBseISS * (CC2->CC2_PERSER/100)
					EndIf
					If CC2->CC2_MDEDMA == "2"
						aNfItem[nItem,IT_ABMATISS]	:= 0
					EndIf
					If CC2->CC2_MDEDSR == "2"
						aNfItem[nItem,IT_ABVLISS]	:= 0
					EndIf
				EndIf
			EndIf
		EndIf
		
		//Utilizada condicao de FunName() para o If abaixo (tabela SC6) pois eh necessario mapear a real necessidade deste calculo
		//no preenchimento da referencia IT_ABMATISS. Foram levantadas as possibilidades de utilizar MaFisLoad ou MaFisAlt nos fontes
		//MATA410 e MATA461 para que este If nao exista mais.
		If FunName()=="MATA410" .Or. aNfCab[NF_ROTINA] == "MATA461"
			If SC6->C6_ABATMAT > 0 //Incluido tratamento para que o Valor a ser descontado seja proporcional a quantidade faturada
				aNfItem[nItem,IT_ABMATISS] := ((aNfItem[nItem][IT_QUANT] * SC6->C6_ABATMAT) / SC6->C6_QTDVEN)
			EndIf
		Endif
		
		nBseISS -= aNfItem[nItem,IT_ABVLISS]
		nBseISS -= aNfItem[nItem,IT_ABMATISS]

       // Alteracao da base de calculo do ISS para o municipio de Barueri, conforme Lei Complementar 185 de 25 de julho de 2007
       // Só alterar a base se tratar-se de uma operação interna. 
		If cCdMunic == '3505708' .And. aNfCab[NF_OPERNF] == "S"
			
			If AllTrim(SubStr(cCdMunic, 3, 5)) == aNfCab[NF_CODMUN]
				nBseISS := nBseISS - aNfItem[nItem][IT_VALPIS] - aNfItem[nItem][IT_VALCOF] - aNfItem[nItem][IT_VALCSL] - aNfItem[nItem][IT_VALIRR]				
			EndIf
						
		EndIf
		
		aNfItem[nItem][IT_BASEISS] := nBseISS
		
	EndIf
	
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Define o Valor do ISS.³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If ("VLR" $ cExecuta) .Or. (lDescISS)
	
	aNfItem[nItem][IT_VALISS] := 0
	
	If aNfItem[nItem][IT_CALCISS] == "S" .Or. lDescISS
		
		aNfItem[nItem][IT_VALISS] := aNfItem[nItem][IT_BASEISS] * aNfItem[nItem][IT_ALIQISS] / 100
		
		If aTes[TS_AGREG] == "D" .Or. aTes[TS_AGREG] == "R"
			If lDescISS
				aNfItem[nItem][IT_DEDICM] := aNfItem[nItem][IT_VALISS]
			Else
				If aTes[TS_BASEISS] > 0
					If aParSX6[MV_DBRDIF]
						aNfItem[nItem][IT_DEDICM] := Round(aNfItem[nItem][IT_BICMORI] * aNfItem[nItem][IT_ALIQISS] / 100 * (1-(aTes[TS_BASEISS]/100)),2)
					Else
						aNfItem[nItem][IT_DEDICM] := Round(aNfItem[nItem][IT_BICMORI] * aNfItem[nItem][IT_ALIQISS] / 100 * (aTes[TS_BASEISS]/100),2)
					EndIf
				Else
					aNfItem[nItem][IT_DEDICM] := aNfItem [nItem][IT_BICMORI] - Round(aNfItem[nItem][IT_BICMORI] * (1-(aNfItem[nItem][IT_ALIQISS]/100*IIf(aTes[TS_BASEISS]==0,1,aTes[TS_BASEISS]/100))),2)
				EndIf
			EndIf
		EndIf
		
		If aNFCab[NF_TIPONF] $ "DB"
			If !Empty(aNFItem[nItem][IT_RECORI])
				If ( aNFCab[NF_CLIFOR] == "C")
					SD2->(MsGoto(aNFItem[nItem][IT_RECORI]))
					If (SD2->D2_VALISS > 0 .Or. Abs(aNfItem[nItem][IT_VALISS]-SD2->D2_VALISS)<=1) .And. aNfItem[nItem][IT_QUANT] == SD2->D2_QUANT .And. SD2->D2_VALFRE + SD2->D2_SEGURO + SD2->D2_DESPESA == 0
						aNfItem[nItem][IT_VALISS] := SD2->D2_VALISS
						aNfItem[nItem][IT_DEDICM] := IIf(aTes[TS_AGREG] == "D" .Or. aTes[TS_AGREG] == "R" , SD2->D2_DESCICM , 0 )
					EndIf
				Else
					SD1->(MsGoto(aNFItem[nItem][IT_RECORI]))
					If (SD1->D1_VALISS > 0 .Or. Abs(aNfItem[nItem][IT_VALISS]-SD1->D1_VALISS)<=1) .And. aNfItem[nItem][IT_QUANT] == SD1->D1_QUANT .And. SD1->D1_VALFRE + SD1->D1_SEGURO + SD1->D1_DESPESA == 0
						aNfItem[nItem][IT_VALISS] := SD1->D1_VALISS
						aNfItem[nItem][IT_DEDICM] := IIf(aTes[TS_AGREG] == "D" .Or. aTes[TS_AGREG] == "R" , SD1->D2_DESCICM , 0 )
					EndIf
				EndIf
			EndIf
		Else
			MaItArred(nItem,{"IT_VALISS"})
		EndIf
	EndIf
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Abaixo é realizado o tratamento de desconto referente ao ISS       ³
	//³nas operações de prestação de serviço para órgão público.          ³
	//³                                                                   ³
	//³Acima já utilizei o que seria o ISS como um desconto, no IT_DEDICM ³
	//³portanto abaixo, volto a zerar o ISS, pois não há ISS no documento ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ  
	If lDescISS
		aNfItem[nItem][IT_VALISS] 	:= 0
		aNfItem[nItem][IT_ALIQISS]	:= 0
		aNfItem[nItem][IT_BASEISS]	:= 0
	EndIf
	
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ISS PROGRESSIVO -  Aplica a Aliquota e o Valor do ISS conforme arquivo Texto ³
//³CALCPROG.ISS localizado no \SYSTEM, sobrepondo o calculo Normal feito acima. ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If aNfItem[nItem][IT_CALCISS] == "S" .And. aParSX6[MV_ISSPRG] == "S" .And. aFieldPos[FP_B1_REGRISS]
	
	If File("calcprog.iss")
		cSBRegrISS := aNfItem[nItem][IT_PRD][SB_REGRISS]
		FT_FUse("calcprog.iss")
		FT_FGotop()
		While ( !FT_FEof() )
			cBuffer := FT_FReadLn()
			
			If ( (AllTrim(SubStr(cBuffer,01,05)) == Substr(Alltrim(SM0->M0_CODMUN),3,5)  ) ;
				.Or.  (AllTrim(SubStr(cBuffer,01,05)) == Alltrim(aNfCab[NF_CODMUN]) ));
				.And.  AllTrim(SubStr(cBuffer,06,02)) == cSBRegrISS
				
				aadd(aIssPrg,{SubStr(cBuffer,01 ,05 )  ,; // 01 Codigo do Municipio
				SubStr(cBuffer,06 ,02 )  ,; // 02 Codigo da regra referente ao B1_REGRISS
				Val(SubStr(cBuffer,08 ,17 )) ,; // 03 Valor inicial da faixa
				Val(SubStr(cBuffer,25 ,17 )) ,; // 04 Valor final da faixa
				Val(SubStr(cBuffer,42 ,06 )) ,; // 05 Aliquota
				Val(SubStr(cBuffer,48 ,09 )) }) // 06 Valor de desconto
			EndIf
			FT_FSkip()
		EndDo
		FT_FUse()
	Else
		Alert("Tabela de configuração não encontrada!")
	EndIf
	
	If !Empty(aIssPrg)  ;
		.And. (( aIssPrg[1][1] == Substr(Alltrim(SM0->M0_CODMUN),3,5) .And. aIssPrg[1][1] == Alltrim(aNfCab[NF_CODMUN]) .And. aNFCab[NF_OPERNF] == "S" ) ; //Se for Saida e Cod Mun Estiver no Sigamat
		.Or. ( aIssPrg[1][1] == Alltrim(aNfCab[NF_CODMUN]) .And. aNFCab[NF_OPERNF] == "E" ) )
		
		For nY:= 1 to Len(aNfItem)
			If !aNfItem[nY][IT_DELETED]
				nTotalISS += aNfItem[nY][IT_VALMERC] - (aNfItem[nY][IT_DESCONTO]+aNfItem[nY][IT_DESCTOT])
				nItValidos += 1
			EndIf
		Next nY
		
		For nX := 1 to Len(aIssPrg)
			If 	( nTotalISS >= aIssPrg[nX][3] .And. nTotalISS <= aIssPrg[nX][4] )
				nAliqISS := aIssPrg[nX][5]
				If "ALQ" $ cExecuta
					For nY:= 1 to Len(aNfItem)
						aNfItem[nItem][IT_ALIQISS] := nAliqISS
						If nY <> nItem
							MaFisAlt("IT_ALIQISS",nAliqISS,nY)
						EndIf
					Next nY
				EndIf
				aNfItem[nItem][IT_VALISS] := ( aNfItem[nItem][IT_BASEISS] * ( nAliqISS / 100 ) ) - ( aIssPrg[nX][6] / nItValidos )
				aNfCab[NF_DESCISS] := aIssPrg[nX][6]
				MaItArred(nItem,{"IT_VALISS"})
				Exit
			EndIf
		Next nX
		
	EndIf
EndIf

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaAliqISS ³ Autor ³ Alexandre Lemes       ³ Data ³05/11/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³A funcao MaAliqISS foi mantida apenas por motivo de compati ³±±
±±³          ³bilidade, pois devido a mesma nao ser STATIC ela foi utiliza³±±
±±³          ³da em varios programas do PROTHEUS para obter a aliquota ISS³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaAliqISS(nItem)
MaExcecao(nItem)
MaFisISS(nItem,"ALQ")
Return(aNfItem[nItem][IT_ALIQISS])

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisINSS ³ Autor ³ Alexandre Lemes       ³ Data ³29/10/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Calcula o INSS.                                            ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisINSS(nItem,cExecuta)

Local nInssAcum  := 0
Local nValMaxIns := 0
Local nI		 := 0
Local nTotInss	 := 0
Local nValInss	 := 0
Local nInssAnt	 := 0

DEFAULT cExecuta := "BSE|ALQ|VLR|RED"

If "RED" $ cExecuta
	
	aNfItem[nItem][IT_REDINSS] := aNfItem[nItem][IT_PRD][SB_REDINSS]
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³O parametro MV_CTRAUTO define se para notas fiscais de complemento de frete deve ser considerado as informacoes de IRRF e INSS  ³
	//³(calculo e reducao) da natureza financeira ou do cadastro de produtos. .T. = Natureza  .F. = Produto  (DEFAULT .F.)             ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If Empty(aNfItem[nItem][IT_REDINSS]) .Or. ( aParSX6[MV_CTRAUTO] .And. aNfCab[NF_TIPONF]=="C" .And. aNfCab[NF_TPCOMP] == "F" )
		If !Empty(aNfCab[NF_NATUREZA])
			aNfItem[nItem][IT_REDINSS] := aInfNat[NT_BASEINS]
		EndIf
	EndIf
	
EndIf

If "BSE" $ cExecuta
	
	aNfItem[nItem][IT_BASEINS] := 0
	
	If aNfItem[nItem][IT_PRD][SB_INSS] == "S" .Or. ( aParSX6[MV_CTRAUTO] .And. aNfCab[NF_TIPONF] == "C" .And. aNfCab[NF_TPCOMP] == "F" .And. !Empty(aNfCab[NF_NATUREZA]) .And. aInfNat[NT_CALCINS] == "S" )
		If aNfItem[nItem][IT_PRD][SB_INSS] == "S" .And. aTES[TS_DUPLIC] == "S"
		
			If aNfCab[NF_RECINSS] == "S" .Or.;
				(aNfCab[NF_RECINSS]=="N" .And. aNFCab[NF_OPERNF]=="S" .And. aInfNat[NT_DEDINSS] == "2")
				
				aNfItem[nItem][IT_BASEINS] := (aNfItem[nItem][IT_TOTAL] + IIf( aParSX6[MV_INSSDES] == "1" , aNfItem[nItem,IT_DESCONTO] , 0 ) ) * ;
				IIf(aNfItem[nItem][IT_REDINSS] > 0 , aNfItem[nItem][IT_REDINSS]/100 , 1 )
			
				aNfItem[nItem][IT_BASEINS] -= aNfItem[nItem,IT_ABVLINSS] // Abatimento da base de calculo do INSS
			EndIf
			
		EndIf
	EndIf  
	
	aNfItem[nItem][IT_BASEINA]	:=	aNfItem[nItem][IT_BASEINS]
	
EndIf

If "ALQ" $ cExecuta
	
	aNfItem[nItem][IT_ALIQINS] := IIf( !Empty(aNfCab[NF_NATUREZA]) , aInfNat[NT_PERCINS] , 0 )
	
	If !Empty(aParSX6[MV_ALINSB1]) 
		dbSelectArea(cAliasPROD)
		If &(aParSX6[MV_ALINSB1]) > 0
			aNfItem[nItem][IT_ALIQINA]	:=	aNfItem[nItem][IT_ALIQINS] + &(aParSX6[MV_ALINSB1])
		EndIf
	Endif
	
EndIf

If "VLR" $ cExecuta
	
	If aNfItem[nItem][IT_ALIQINA] > 0
		aNfItem[nItem][IT_VALINS] := aNfItem[nItem][IT_BASEINA] * aNfItem[nItem][IT_ALIQINA] /100
	Else
		aNfItem[nItem][IT_VALINS] := aNfItem[nItem][IT_BASEINS] * aNfItem[nItem][IT_ALIQINS] /100
	Endif
	
	If aParSX6[MV_LIMINSS] > 0 .And. aNFCab[NF_OPERNF] == "E" .And. aNFCab[NF_CLIFOR] == "F" .And. Len(AllTrim(aNFCab[NF_CNPJ])) < 14 .And. Len(AllTrim(aNFCab[NF_CNPJ])) > 1
		
		aNfItem[nItem][IT_ACINSS] := 0
		
		nTotInss := 0
		nInssAnt := 0
		
		For nI := 1 to nItem
			If aNfItem[nItem][IT_ACINSS] == 0
				aNfItem[nItem][IT_ACINSS] := aNfItem[nItem][IT_VALINS]
			EndIf
			If !aNfItem[nI][IT_DELETED]
				nTotInss += aNfItem[nI][IT_ACINSS]
				If nItem <> nI
					nInssAnt += aNfItem[nI][IT_ACINSS]
				Endif
			Endif
		Next nI
		
		nInssAcum  	:= VerInssAcm(aNfCab[NF_CODCLIFOR],aNfCab[NF_LOJA],aNfCab[NF_NREDUZ],dDataBase)
		nValMaxIns 	:= ( aParSX6[MV_LIMINSS] - nInssAcum )
		nValInss    := ( nValMaxIns - nInssAnt )
		
		Do Case
			Case nValMaxIns <= 0
				aNfItem[nItem][IT_VALINS] := 0
				lLimInss := .T.
			Case ( nValMaxIns < nTotInss )
				aNfItem[nItem][IT_VALINS] := Iif( nValInss < 0 , 0 , nValInss )
				lLimInss := .T.
		EndCase
		
		If lLimInss
			MaFisToCols(aHeader,aCols,,"MT100")
		Endif
		
	Endif
	
	// Abatimento da valor do INSS em valor - Subcontratada
	//Faturamento
	If aNfItem[nItem][IT_VALINS] >= aNfItem[nItem][IT_ABSCINS] .And. aNfItem[nItem][IT_ABSCINS] > 0
		aNfItem[nItem][IT_VALINS] -= aNfItem[nItem][IT_ABSCINS]
	Endif
	//Movimento de entrada
	If aNfItem[nItem][IT_VALINS] >= aNfItem[nItem][IT_AVLINSS] .And. aNfItem[nItem][IT_AVLINSS] > 0
		aNfItem[nItem][IT_VALINS] -= aNfItem[nItem][IT_AVLINSS]
	Endif
	
	If aNfItem[nItem][IT_ALIQINA] > 0
		aNfItem[nItem][IT_VALINA]	:=	aNfItem[nItem][IT_VALINS]
		aNfItem[nItem][IT_VALINS]	:=	0
		aNfItem[nItem][IT_BASEINS]	:=	0
	Else
		aNfItem[nItem][IT_BASEINA]	:=	0
	Endif
	
EndIf

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³ MaFisIR  ³ Autor ³Alexandre Lemes        ³ Data ³06/11/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Calculo do IR pessoa Fisica e Juridica                     ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisIR(nItem,cExecuta,dVencReal,lVisual)

Local aArea     := {}
Local aIRprg    := {}
Local cPessoa	:= Iif(Len(Alltrim(aNfCab[NF_CNPJ]))< 14,"F","J")
Local cWhere    := ""
Local cCliFor   := aNfCab[NF_CODCLIFOR]
Local cLoja     := aNfCab[NF_LOJA]
Local nAliquota	:= aNfCab[NF_ALIQIR]
Local nSomaIRF  := 0
Local nX        := 0
Local nDebDep   := 0
Local nSldDep   := 0
Local lUsaTbPrg := .F.
Local lVldBseIR := .T.
Local lCtrAuto  := aParSX6[MV_CTRAUTO] .And. aNfCab[NF_TIPONF] == "C" .And. aNfCab[NF_TPCOMP] == "F" .And. !Empty(aNfCab[NF_NATUREZA])

#IFNDEF TOP
	Local dDtSeek
	Local bDataImp
#ENDIF

DEFAULT dVencReal := dDataBase
DEFAULT cExecuta  := "BSE|ALQ|VLR" 
DEFAULT lVisual	  := .F.

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Define BASE do IRRF - IT_BASEIRR ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If "BSE" $ cExecuta
	
	aNfItem[nItem][IT_BASEIRR] := 0
	
	If aExistPE[PE_MAFISBIR]
		lVldBseIR := ExecBlock( "MAFISBIR",.F.,.F.,{aNfItem[nItem,IT_TES],aNfItem[nItem,IT_PRODUTO],aNfCab[NF_CLIFOR],aNfCab[NF_OPERNF],aNfCab[NF_CODCLIFOR],aNfCab[NF_LOJA]})
	EndIf
	
	If lVldBseIR .And. aTES[TS_DUPLIC] == "S" .And. !Empty(aInfNat[NT_CODIGO]) .And. ( aInfNat[NT_CALCIRF] == "S" .Or. aParSX6[MV_IRSEMNT] )
		
		If aNfItem[nItem][IT_PRD][SB_IRRF] == "S" .Or. aNFCab[NF_OPIRRF] == "EP" .Or. lCtrAuto
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³O parametro MV_CTRAUTO define se para notas fiscais de complemento de frete deve ser considerado as informacoes  ³
			//³de IRRF e INSS (calculo e reducao) da natureza ou do cad de produtos. .T.= Natureza - .F.= Produto (DEFAULT)     ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			aNfItem[nItem][IT_REDIR] := aNfItem[nItem][IT_PRD][SB_REDIRRF]
			If lCtrAuto .Or. ( Empty(aNfItem[nItem][IT_REDIR]) .And. !Empty(aNfCab[NF_NATUREZA]) )
				aNfItem[nItem][IT_REDIR] := aInfNat[NT_BASEIRF]
			EndIf
			
			aNfItem[nItem][IT_BASEIRR] := aNfItem[nItem][IT_TOTAL]
			
			If aTes[TS_DESCOND] == "1"	//Incluir o valor do desconto na base de IRRF
				aNfItem[nItem][IT_BASEIRR] := aNfItem[nItem][IT_BASEIRR] +aNfItem[nItem][IT_DESCONTO]
			EndIf
			
			//Indica se o valor do IPI deve compor a base de calculo do PIS/COFINS de ST.
			//1=Sim (Compoe) e 2=Nao(Nao Compoe)
			If aTes[TS_IPIPC]=="2"
				aNfItem[nItem][IT_BASEIRR] -= aNfItem[nItem][IT_VALIPI]
			Endif
			
			//Verifica se o valor do ICMS Solidario esta agregado ao valor total
			If !(aTes[TS_INCSOL]$"A,N,D")
				aNfItem[nItem][IT_BASEIRR] -= aNfItem[nItem][IT_VALSOL]
			Endif
			
			//Agrega o Valor do ICMS Retido - Somente para Empresa Publica
			If aTes[TS_DBSTIRR] == "1" .And. aNFCab[NF_OPIRRF] == "EP"
				aNfItem[nItem][IT_BASEIRR] += aNfItem[nItem][IT_VALSOL]
			Endif
			
			//O INSS devera ser deduzido da base do IR e nao do valor dos
			//servicos. Portanto, quando ha reducao na base de calculo, primeiro
			//efetua-se a reducao e depois a deducao do INSS.
			aNfItem[nItem][IT_BASEIRR] := aNfItem[nItem][IT_BASEIRR] * IIf( aNfItem[nItem][IT_REDIR] > 0 , aNfItem[nItem][IT_REDIR] / 100 , 1 )
			If !Len(AllTrim(aNFCAB[NF_CNPJ])) == 14
				aNfItem[nItem][IT_BASEIRR] := IIf(( aParSX6[MV_INSIRF]=="1") .And. aNfCab[NF_MODIRF]<>"2",aNfItem[nItem][IT_BASEIRR]-aNfItem[nItem][IT_VALINS],aNfItem[nItem][IT_BASEIRR])
			Endif
			
			// Verificar se Fornecedor eh Pessoa Fisica
			// - Se Nao possui tratamento de base redutora IRPF
			// 	* Para este caso, nao calcular ou gravar o IRPF
			// - Se possui tratamento de base redutora IRPF
			// 	* Para este caso, nao zero a base de IRPF
			//Se nao possui tratamento de base redutora de IRRF
			If  aNfCab[NF_TPCLIFOR] == "F" .And. aFieldPos[FP_E5_BASEIRF] .And. aFieldPos[FP_E2_BASEIRF] .And. aNfCab[NF_MODIRF] == "2" // IR na Baixa NAO calcula IR na MATXFIS
				aNfItem[nItem][IT_BASEIRR] := 0
			Endif
			
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Calculo da Base do IR com desconto de DEPENDENTES por item Chamado SCHLLN 29/12/2009 ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If  aNfCab[NF_TPCLIFOR] == "F" .And. aNfItem[nItem][IT_BASEIRR] > 0 .And. cPessoa == "F"  .And. aNfCab[NF_NUMDEP] > 0 .And. aFieldPos[FP_D1_SLDDEP]
				
				dbSelectArea("SD1")
				nSldDep  := ( aParSX6[MV_TMSVDEP] * aNfCab[NF_NUMDEP])
				#IFDEF TOP
					cWhere := ""
					If aParSX6[MV_ACMIRPF] == "2" //1 = Emissao 2= Vencimento Real 3=Data Contabilizacao
						cWhere += "%SE2.E2_VENCREA  BETWEEN '"+Dtos(FirstDay(dDataBase))+"' AND '"+Dtos(LastDay(dDataBase))+"' AND%"
					ElseIf aParSX6[MV_ACMIRPF] == "1"
						cWhere += "%SE2.E2_EMISSAO  BETWEEN '"+Dtos(FirstDay(dDataBase))+"' AND '"+Dtos(LastDay(dDataBase))+"' AND%"
					Else
						cWhere += "%SE2.E2_EMIS1  BETWEEN '"+Dtos(FirstDay(dDataBase))+"' AND '"+Dtos(LastDay(dDataBase))+"' AND%"
					EndIf
					
					BeginSql Alias "MaTbDepPF"
						SELECT	SUM(D1_SLDDEP) SLDDEP
						FROM %Table:SE2% SE2,%Table:SD1% SD1
						WHERE
						SE2.E2_FILIAL  = %xFilial:SE2% AND
						SE2.E2_FORNECE = %Exp:cCliFor% AND
						SE2.E2_LOJA    = %Exp:cLoja% AND
						SE2.E2_FILIAL  = SD1.D1_FILIAL AND
						SE2.E2_PREFIXO = SD1.D1_SERIE AND
						SE2.E2_NUM     = SD1.D1_DOC AND
						SE2.E2_FORNECE = SD1.D1_FORNECE AND
						SE2.E2_LOJA    = SD1.D1_LOJA AND
						SE2.E2_EMISSAO = SD1.D1_EMISSAO AND
						%exp:cWhere%
						SD1.D1_FILIAL = %xFilial:SD1% AND
						SD1.D1_SLDDEP > 0  AND
						SE2.%notdel% AND
						SD1.%notdel%
					EndSql
					
					dbSelectArea("MaTbDepPF")
					While !(MaTbDepPF->(Eof()))
						nDebDep  += SLDDEP
						MaTbDepPF->(dbSkip())
					EndDo
					MaTbDepPF->(dbCloseArea())
				#ELSE
					aArea := GetArea()
					For nX := 1 to Day(LastDay(dDataBase))
						dbSelectArea("SE2")
						If aParSX6[MV_ACMIRPF] == "2"
							dDtSeek  := Dtos(Ctod(StrZero(nX)+"/"+SubStr(Dtoc(dVencReal),4,Iif(Len(Dtoc(dVencReal)) == 10, 7, 5))))
							bDataImp := {||SE2->E2_VENCREA}
							SE2->(dbSetOrder(3))
						Else
							dDtSeek := Dtos(Ctod(StrZero(nX)+"/"+SubStr(Dtoc(dDataBase),4,Iif(Len(Dtoc(dDataBase)) == 10, 7, 5))))
							bDataImp := Iif( aParSX6[MV_ACMIRPF] == "1"  ,  {||SE2->E2_EMISSAO} , {||SE2->E2_EMIS1} )
							SE2->(dbSetOrder(5))
						EndIf
						If SE2->( MsSeek(xFilial("SE2") + dDtSeek + aNfCab[NF_NREDUZ] , .T. ) )
							Do While SE2->(!Eof()) .And. xFilial("SE2") == SE2->E2_FILIAL .And. Dtos(Eval(bDataImp))==dDtSeek .And. SE2->E2_NOMFOR == aNfCab[NF_NREDUZ]
								DbSelectArea("SD1")
								SD1->(dbSetOrder(1))//D1_FILIAL+D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA+D1_COD+D1_ITEM
								If SD1->(MsSeek(xFilial("SD1")+SE2->E2_NUM+SE2->E2_PREFIXO+SE2->E2_FORNECE+SE2->E2_LOJA))
									Do While SD1->(!Eof())
										If SD1->D1_SLDDEP > 0
											nDebDep  += SD1->D1_SLDDEP
										Endif
										SD1->(dbSkip())
									EndDo
								Endif
								SE2->(dbSkip())
							EndDo
						EndIf
					Next nX
					RestArea(aArea)
				#ENDIF
				
				If GdFieldPos("D1_SLDDEP") > 0  // Alemes refazer, retirar acols Chamado SCHLLN 29/12/2009
					nSldDep:=nSldDep-nDebDep
					aCols[nItem][GdFieldPos("D1_SLDDEP")]:= 0
					If aNfItem[nItem][IT_BASEIRR]>0
						For nX :=1 To Len(aCols)
							If !aCols[nX][Len(aCols[nX])]//Somente linhas nao deletadas
								nSldDep -= aCols[nX][GdFieldPos("D1_SLDDEP")]
							Endif
						Next nX
						If nSldDep > 0
							If aNfItem[nItem][IT_BASEIRR] > nSldDep
								aNfItem[nItem][IT_BASEIRR] -= nSldDep
								If GdFieldPos("D1_SLDDEP") > 0
									aCols[nItem][GdFieldPos("D1_SLDDEP")]:= nSldDep
								EndIf
							Else
								aCols[nItem][GdFieldPos("D1_SLDDEP")]:= aNfItem[nItem][IT_BASEIRR]
								aNfItem[nItem][IT_BASEIRR] := 0
							Endif
						Endif
					Endif
				EndIf
				
			Endif
		EndIf
		
	EndIf
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Define ALIQUOTA IRRF - IT_ALIQIRR³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If "ALQ" $ cExecuta
	If !Empty(aNfCab[NF_NATUREZA]) .And. aNfCab[NF_MODIRF] <> "3"
		If aNfCab[NF_CLIFOR] == "C"
			Do Case
				Case aNfCab[NF_ALIQIR] > 0
					If aParSX6[MV_IRSEMNT] // Parametro = .T. deixa gerar o IR mesmo que a natureza esteja para NAO calcular
						nAliquota := aNfCab[NF_ALIQIR]
					Else
						If aInfNat[NT_CALCIRF] == "S"
							nAliquota := aNfCab[NF_ALIQIR]
						EndIf
					EndIf
				Case aInfNat[NT_CALCIRF] == "S" .And. (Len(AllTrim(aNFCAB[NF_CNPJ])) == 14 .Or. aNfCab[NF_MODIRF] == "2" )
					nAliquota := IIf( aInfNat[NT_PERCIRF] > 0 , aInfNat[NT_PERCIRF] , aParSX6[MV_ALIQIRF] )
				Case aInfNat[NT_CALCIRF] == "S" .And. Len(AllTrim(aNFCAB[NF_CNPJ])) <> 14
					If aNfCab[NF_MODIRF] == "4" .Or. ( aNFCab[NF_TPCLIFOR] == "X" .And. aNFCab[NF_PESSOA] == "J" )   //aNfCab[NF_MODIRF] == "4" --> Empresa Individual
						nAliquota := IIf( aInfNat[NT_PERCIRF] > 0 , aInfNat[NT_PERCIRF] , aParSX6[MV_ALIQIRF] )
					Else
						lUsaTbPrg := .T.
					EndIf
			EndCase
		Else
			If aInfNat[NT_CALCIRF] == "S"
				If aNfCab[NF_TPCLIFOR] == "F" .And. aNfCab[NF_MODIRF] <> "2" .And. aNfCab[NF_IRPROG] <> "1"
					If aNfCab[NF_MODIRF] == "4" //--Empresa Individual
						nAliquota := IIf( aInfNat[NT_PERCIRF] > 0 , aInfNat[NT_PERCIRF] , aParSX6[MV_ALIQIRF] )
					Else
						lUsaTbPrg := .T.
					EndIf
				ElseIf aNfCab[NF_IRPROG] == "1" .And. cPessoa == "J"
					lUsaTbPrg := .T.
				Else
					// Verificar se Fornecedor utiliza MP232
					// Para este caso, nao calcular ou gravar o IRPF
					If aFieldPos[FP_A2_CALCIRF] .And. aFieldPos[FP_E2_VRETIRF] .And. aFieldPos[FP_E2_PRETIRF] .And. aFieldPos[FP_E5_VRETIRF] .And. ;
						aFieldPos[FP_E5_PRETIRF] .And. aNfCab[NF_MODIRF] == "2"
						nAliquota := 0
					Else
						nAliquota := IIf( aInfNat[NT_PERCIRF] > 0 , aInfNat[NT_PERCIRF] , aParSX6[MV_ALIQIRF] )
					EndIf
				EndIf
			EndIf
		EndIf
		
		If lUsaTbPrg
			aEval(aNfItem,{|x| nSomaIRF += IIf(!x[IT_DELETED],x[IT_BASEIRR],0)})
			aIRprg := MaTbIrfPF(aNfItem[nItem][IT_BASEIRR],nSomaIRF-aNfItem[nItem][IT_BASEIRR],Iif(lVisual,.F.,.T.),aNfCab[NF_CODCLIFOR],aNfCab[NF_LOJA],dVencReal,cPessoa)
			nAliquota := aIRprg[2]
		EndIf
		
		// Verificar se Fornecedor pessoa juridica realiza calculo do IRR no momento da baixa.
		If aInfNat[NT_CALCIRF] == "S" .And. cPessoa == "J" .And. aNfCab[NF_MODIRF] == "2"
			nAliquota := IIf( aInfNat[NT_PERCIRF] > 0 , aInfNat[NT_PERCIRF] , aParSX6[MV_ALIQIRF] )
		EndIf
	EndIf
	
	aNfItem[nItem][IT_ALIQIRR]	:= nAliquota
	
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Define VALOR do IRRF - IT_VALIRR ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If "VLR" $ cExecuta
	
	aNfItem[nItem][IT_VALIRR] := 0
	
	If aNfItem[nItem][IT_ALIQIRR] <> 0 .And. ( cPessoa == "F" .Or. aNfCab[NF_IRPROG] == "1" ) .And. ;
		(aNfCab[NF_CLIFOR] == "F" .Or. ( aNfCab[NF_CLIFOR] == "C" .And. aNfCab[NF_ALIQIR] == 0 ) .Or. aNfCab[NF_IRPROG] == "1" )
		lUsaTbPrg := .T.
	EndIf
	
	If (aNfCab[NF_CLIFOR] == "C" .And. aNFCab[NF_TPCLIFOR] == "X" .And. aNFCab[NF_PESSOA] == "J" ) .Or. ;
		(aNfCab[NF_CLIFOR] == "F" .And. aNfCab[NF_IRPROG] <> "1" .And.   aNFCab[NF_TPCLIFOR] == "X" ) //retenção de IR para operação de importação [artigos  706 e 719 do Decreto nº3000, de março de 1999 (http://www.receita.fazenda.gov.br/Legislacao/rir/Livro3.htm) 	
		lUsaTbPrg := .F.
	EndIf
	
	If lUsaTbPrg
		If nSomaIRF == 0
			aEval(aNfItem,{|x| nSomaIRF += IIf(!x[IT_DELETED],x[IT_BASEIRR],0)})
			aIRprg := MaTbIrfPF(aNfItem[nItem][IT_BASEIRR],nSomaIRF-aNfItem[nItem][IT_BASEIRR],.T.,aNfCab[NF_CODCLIFOR],aNfCab[NF_LOJA],dVencReal,cPessoa)
		EndIf
		If aNfCab[NF_MODIRF] <> "2"
			For nX := 1 To Len(aNFItem)
				aNFItem[nX][IT_ALIQIRR] := aIRprg[2]
			Next nX
			If aIRprg[1] > 0 
				MaFisRatRes("IT_VALIRR",aIRprg[1],aIRprg[2],"IT_ALIQIRR","IT_BASEIRR",nItem)
				MaIt2Cab(nItem)
			EndIf
		Else
			If aNfItem[nItem][IT_BASEIRR]- aIRprg[4] > 0
				If aFieldPos[FP_A2_CALCIRF] .And. aFieldPos[FP_E2_VRETIRF] .And. aFieldPos[FP_E2_PRETIRF] .And. aFieldPos[FP_E5_VRETIRF] .And. ;
					aFieldPos[FP_E5_PRETIRF] .And. aNfCab[NF_MODIRF] == "2" // Se Fornecedor utiliza MP232 NAO calcular ou gravar IRPF
					aNfItem[nItem][IT_VALIRR] := 0
				Else
					aNfItem[nItem][IT_VALIRR] := aNfItem[nItem][IT_BASEIRR] * aNfItem[nItem][IT_ALIQIRR] /100
				Endif
			Else
				aNfItem[nItem][IT_VALIRR] := 0
			EndIf
		EndIf
	Else
		aNfItem[nItem][IT_VALIRR] := aNfItem[nItem][IT_BASEIRR] * aNfItem[nItem][IT_ALIQIRR] / 100
		aNfItem[nItem][IT_VALIRR] := IIf(aParSX6[MV_RNDIRF], Round( aNfItem[nItem][IT_VALIRR],TamSX3( "D1_VALIRR")[2] ), NoRound( aNfItem[nItem][IT_VALIRR],TamSX3( "D1_VALIRR")[2]))   		
	EndIf
	
EndIf

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaTbIrfPF ³ Autor ³Eduardo/Edson          ³ Data ³31.01.2004³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Inicializa o Calculo das operacoes Fiscais                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpA: [1] Valor do IRPF                                     ³±±
±±³          ³      [2] Aliquota do IRPF                                  ³±±
±±³          ³      [3] Dedução  do IRPF                                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpN1 : Valor do IRPF                                      ³±±
±±³          ³ ExpN2 : Valor acumulado do IRPF                            ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaTbIrfPF(nBaseIRF,nTotIrf,lSE2,cFornece,cLoja,dVencReal,cPessoa)

Local aArea     := GetArea()
Local aTabela   := {}
Local cAddWhere := ""
Local cBuffer   := ""
Local nX        := 0
Local nBase     := 0
Local nAliq     := 0
Local nValor    := 0
Local nDed      := 0
Local nIsento   := 0
Local nTotTit 	:= 0
Local nTotInss	:= 0
Local nTotIrrf	:= 0
Local nVenctoPF := aParSX6[MV_ACMIRPF]
Local nVenctoPJ := aParSX6[MV_ACMIRPJ]   //1 = Emissao    2= Vencimento Real	3=Data Contabilizacao
Local lContrRet := aFieldPos[FP_E2_VRETPIS] .And. aFieldPos[FP_E2_VRETCOF] .And. aFieldPos[FP_E2_VRETCSL] .And. aFieldPos[FP_E2_PRETPIS] .And. aFieldPos[FP_E2_PRETCOF] .And. aFieldPos[FP_E2_PRETCSL]
Local lPCCBaixa := aParSX6[MV_BX10925]== "1" .And. aFieldPos[FP_E5_VRETPIS] .And. aFieldPos[FP_E5_VRETCOF] .And. aFieldPos[FP_E5_VRETCSL] .And. aFieldPos[FP_E5_PRETPIS] .And. aFieldPos[FP_E5_PRETCOF] .And. aFieldPos[FP_E5_PRETCSL] .And. aFieldPos[FP_E2_SEQBX] .And. aFieldPos[FP_FQ_SEQDES]
Local dDataEmi	:=	dDataBase

#IFNDEF TOP
	Local nLastDay:= Day(LastDay(dDataBase))
	Local dDtSeek
	Local bDataImp
#ELSE
	Local cWhere    := ""
	Local cSepNeg   := If("|"$MV_CPNEG,"|",",")
	Local cSepProv  := If("|"$MVPROVIS,"|",",")
	Local cSepRec   := If("|"$MVPAGANT,"|",",")
#ENDIF

DEFAULT nTotIrf   := 0
DEFAULT lSE2      := .F.
DEFAULT dVencReal := dDataBase

//dDataEmi para respeitar os parametros MV_ACMIRPF e  MV_ACMIRPJ
If Type("dDEmissao") == "D" .And. !Empty(dDEmissao)
	dDataEmi	:=	dDEmissao
Endif

If aUltPesq == Nil
	STATIC aUltPesq := {ctod(""),"","",0,0}
EndIf

//³ Calcula o valor do IRF ocorrido no mes                      ³
If lSE2 .And. ( !(aUltPesq[1] == dDataBase .And. aUltPesq[2] == cFornece .And. aUltPesq[3] == cLoja))
	#IFDEF TOP
		cWhere := ""
		
		If cPessoa == "F" .Or. aNfCab[NF_IRPROG] == "1"
			If nVenctoPF == "2"
				//Se for no mesmo mês uso a DataBase senão uso a Data do Vencimento Real
				If Dtos(FirstDay(dVencReal))<= Dtos(dDataBase) .And. Dtos(LastDay(dVencReal))>= Dtos(dDataBase)
					cWhere += "%SE2.E2_VENCREA  BETWEEN '"+Dtos(FirstDay(dDataBase))+"' AND '"+Dtos(LastDay(dDataBase))+"' AND "
				Else
					cWhere += "%SE2.E2_VENCREA  BETWEEN '"+Dtos(FirstDay(dVencReal))+"' AND '"+Dtos(LastDay(dVencReal))+"' AND "
				EndIf
			ElseIf nVenctoPF == "1"
				cWhere += "%SE2.E2_EMISSAO  BETWEEN '"+Dtos(FirstDay(dDataEmi))+"' AND '"+Dtos(LastDay(dDataEmi))+"' AND "
			Else
				cWhere += "%SE2.E2_EMIS1  BETWEEN '"+Dtos(FirstDay(dDataBase))+"' AND '"+Dtos(LastDay(dDataBase))+"' AND "
			EndIf
		Else
			If nVenctoPJ == "2"
				If Dtos(dDataBase)==Dtos(dVencReal)
					cWhere += "%SE2.E2_VENCREA  = '" + Dtos(dDataBase) + "' AND "
				Else
					cWhere += "%SE2.E2_VENCREA  = '" + Dtos(dVencReal) + "' AND "	//Totaliza pelo vencimento real
				EndIf
			ElseIf nVenctoPJ == "1"
				cWhere += "%SE2.E2_EMISSAO  = '" + Dtos(dDataEmi) + "' AND "
			Else
				cWhere += "%SE2.E2_EMIS1  = '" + Dtos(dDataBase) + "' AND "
			EndIf
		EndIf
		
		cWhere += "SE2.E2_TIPO NOT IN "+FormatIn(MVABATIM,"|")+" AND "
		cWhere += "SE2.E2_TIPO NOT IN "+FormatIn(MV_CPNEG,cSepNeg)+" AND "
		cWhere += "SE2.E2_TIPO NOT IN "+FormatIn(MVPROVIS,cSepProv)+" AND "
		cWhere += "SE2.E2_TIPO NOT IN "+FormatIn(MVPAGANT,cSepRec)+" AND "
		cWhere += "SE2.E2_FATURA NOT IN ('NOTFAT') "
		
		If aExistPE[PE_MACALIRRF]
			cAddWhere := ExecBlock("MACALIRRF",.F.,.F., {cWhere} )
			If ValType(cAddWhere) == "C" .And. !Empty(cAddWhere)
				cWhere += " AND " + cAddWhere
			EndIf                                       	
		EndIf
				
		cWhere += " AND %"
		
		BeginSql Alias "MaTbIrfPF"
			SELECT	E2_VALOR,E2_IRRF,E2_INSS,E2_ISS,E2_SEST,E2_PRETPIS,E2_PRETCOF,E2_PRETCSL,E2_VRETPIS,E2_VRETCOF,E2_VRETCSL,
			E2_TIPO,E2_NUM,E2_PREFIXO,E2_FORNECE,E2_LOJA,E2_ORIGEM,E2_FATURA
			FROM %Table:SE2% SE2,%Table:SED% SED
			WHERE
			SE2.E2_FILIAL = %xFilial:SE2% AND
			SE2.E2_FORNECE = %Exp:cFornece% AND
			SE2.E2_LOJA = %Exp:cLoja% AND
			%exp:cWhere%
			SE2.E2_NATUREZ = SED.ED_CODIGO AND
			SED.ED_FILIAL = %xFilial:SED% AND
			SED.ED_CALCIRF = 'S' AND
			SE2.%notdel% AND
			SED.%notdel%
		EndSql
		dbSelectArea("MaTbIrfPF")
		While !(MaTbIrfPF->(Eof()))
			If 	MaTbIrfPF->(E2_TIPO) == MVNOTAFIS .And. Alltrim(MaTbIrfPF->(E2_ORIGEM)) == "MATA100"
				BeginSql Alias "TMPSD1"
					SELECT SUM(D1_BASEIRR) BASEIRR, SUM(D1_VALINS) VALINS
					FROM %Table:SD1% SD1
					WHERE
					SD1.D1_FILIAL = %xFilial:SD1% AND
					SD1.D1_DOC = %Exp:MaTbIrfPF->(E2_NUM)% AND
					SD1.D1_SERIE = %Exp:MaTbIrfPF->(E2_PREFIXO)% AND
					SD1.D1_FORNECE = %Exp:MaTbIrfPF->(E2_FORNECE)% AND
					SD1.D1_LOJA = %Exp:MaTbIrfPF->(E2_LOJA)% AND
					SD1.%notdel%
				EndSql
				nTotTit	+= (BASEIRR + VALINS)
				dbCloseArea()
			Else
				nTotTit	+= E2_VALOR+E2_IRRF+E2_INSS+E2_ISS+E2_SEST
			EndIf
			dbSelectArea("MaTbIrfPF")
			If lContrRet .And. !lPccBaixa .And. (E2_PRETPIS == " " .And. E2_PRETCOF == " " .And. E2_PRETCSL == " ")
				nTotTit	+= E2_VRETPIS+E2_VRETCOF+E2_VRETCSL
			Endif
			nTotInss += E2_INSS
			nTotIrrf += E2_IRRF
			dbSkip()
		EndDo
		MaTbIrfPF->(dbCloseArea())
		dbSelectArea("SA2")
	#ELSE
		dbSelectArea("SA2")
		dbSetOrder(1)
		MsSeek(xFilial("SA2")+cFornece+cLoja)
		
		dbSelectArea("SE2")
		If cPessoa == "F" .Or. aNfCab[NF_IRPROG]=="1"
			If nVenctoPF == "2"
				//Se for no mesmo mês uso a DataBase senão uso a Data do Vencimento Real
				If Dtos(FirstDay(dVencReal))<= Dtos(dDataBase) .And. Dtos(LastDay(dVencReal))>= Dtos(dDataBase)
					nLastDay := Day(LastDay(dDataBase))
				Else
					nLastDay := Day(LastDay(dVencReal))
				EndIf
				bDataImp := {||SE2->E2_VENCREA}
				dbSetOrder(3)
			ElseIf nVenctoPF == "1"
				bDataImp := {||SE2->E2_EMISSAO}
				dbSetOrder(5)
			Else// nVenctoPF == "3"
				bDataImp := {||SE2->E2_EMIS1}
				dbSetOrder(5)
			EndIf
			nStart:= 1
		Else
			If nVenctoPJ == "2"
				//Se for no mesmo dia uso a DataBase senão uso a Data do Vencimento Real
				If Dtos(dDataBase)==Dtos(dVencReal)
					nLastDay := Day(dDataBase)
				Else
					nLastDay := Day(dVencReal)
				EndIf
				nStart	:= nLastDay
				bDataImp := {||SE2->E2_VENCREA}
				dbSetOrder(3)
			ElseIf nVenctoPJ == "1"
				bDataImp := {||SE2->E2_EMISSAO}
				nLastDay := Day(dDataBase)
				nStart	:= nLastDay
				dbSetOrder(5)
			Else// nVenctoPJ == "3"
				bDataImp := {||SE2->E2_EMIS1}
				nLastDay := Day(dDataBase)
				nStart	:= nLastDay
				dbSetOrder(5)
			EndIf
		EndIf
		
		For nX := nStart to nLastDay
			If nVenctoPF == "2" .Or. nVenctoPJ == "2"
				dDtSeek := Dtos(Ctod(StrZero(nX)+"/"+SubStr(Dtoc(dVencReal),4,Iif(Len(Dtoc(dVencReal)) == 10, 7, 5))))
			Else
				dDtSeek := Dtos(Ctod(StrZero(nX)+"/"+SubStr(Dtoc(dDataBase),4,Iif(Len(Dtoc(dDataBase)) == 10, 7, 5))))
			EndIf
			If MsSeek(xFilial("SE2")+dDtSeek+SA2->A2_NREDUZ,.T.)
				While !Eof() .And. xFilial("SE2") == E2_FILIAL .And. Dtos(Eval(bDataImp))==dDtSeek .And. E2_NOMFOR == SA2->A2_NREDUZ
					SED->(MsSeek(xFilial("SED")+SE2->E2_NATUREZ))
					If E2_FORNECE+E2_LOJA == SA2->A2_COD+SA2->A2_LOJA .And. !(E2_TIPO $ MVABATIM+"/"+MV_CPNEG+"/"+MVPAGANT+"/"+MVPROVIS) .And. SED->ED_CALCIRF=="S" .And. !(E2_FATURA == "NOTFAT")
						nTotTit	+= E2_VALOR+E2_IRRF+E2_INSS+E2_ISS+E2_SEST
						If lContrRet .And. !lPccBaixa .And. (E2_PRETPIS == " " .And. E2_PRETCOF == " " .And. E2_PRETCSL == " ")
							nTotTit	+= E2_VRETPIS+E2_VRETCOF+E2_VRETCSL
						Endif
						nTotInss += E2_INSS
						nTotIrrf += E2_IRRF
					Endif
					dbSkip()
				EndDo
			EndIf
		Next nX
	#ENDIF
	aUltPesq:= {dDataBase,cFornece,cLoja,IIF((aParSX6[MV_INSIRF]=="1"), nTotTit - nTotInss , nTotTit ),nTotIRRF}
EndIf
nBaseIRF += aUltPesq[4]
//³ Aplica a tabela progressiva                                 ³
If File("SIGAADV.IRF")
	FT_FUse("SIGAADV.IRF")
	FT_FGotop()
	While ( !FT_FEof() )
		cBuffer := FT_FReadLn()
		aadd(aTabela,{Val(SubStr(cBuffer,1,15)),Val(SubStr(cBuffer,17,6)),Val(SubStr(cBuffer,24,15))})
		FT_FSkip()
	EndDo
	FT_FUse()
	
	For nX := 1 To Len(aTabela)
		nBase := aTabela[nX,1]
		nAliq := aTabela[nX,2]
		nDed  := aTabela[nX,3]
		If nAliq == 0
			nIsento := nBase
		EndIf
		If nBaseIRF+nTotIrf <= aTabela[nX][1]
			Exit
		EndIf
	Next nX
	
	nValor := NoRound(((nBaseIRF+nTotIrf)*nAliq/100),3)-nDed-aUltPesq[5]
	nValor := Max(nValor,0)
	
EndIf

RestArea(aArea)

Return({nValor,nAliq,nDed,nIsento})

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao   ³MaFisPIS   ³ Autor ³Alexandre Lemes        ³ Data ³28/09/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o³Calculo do PIS - Apuracao / Retencao e ST                    ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisPIS(nItem,cTipo,cExecuta)

Local aExcecao	 := {}
Local aAreaSA1   := {}
Local aAreaSC6   := {}
Local aMaPISVeic := {}
Local aMaPISDif  := {}
Local aMaCalcPIS := IIf( aExistPE[PE_MACALCPIS] , ExecBlock("MaCalcPIS") , Array(2) )
Local cNatureza  := ""
Local nDescISS	 := 0
Local nVlUnitCig := 0
Local nFatRedPIS := 1
Local nAliqAgr	 := 0
Local nBasePIS   := 0
Local nBasePS2	 := 0
Local nBasePS3	 := 0
Local nPautaSB1  := aNfItem[nItem][IT_PRD][SB_VLR_PIS]
Local nRedBsPIS	 := aNfItem[nItem][IT_PRD][SB_REDPIS]
Local nAliqSB1   := aNfItem[nItem][IT_PRD][SB_PPIS]
Local nAliqBase  := IIf( !Empty(aNFitem[nItem,IT_EXCECAO]) .And. aNFItem[nItem,IT_EXCECAO,12] <> 0 , aNFItem[nItem,IT_EXCECAO,12] , IIf(Empty(nAliqSB1) , aParSX6[MV_TXPIS] , nAliqSB1) )
Local nAliqPIS   := nAliqBase // Retencao
Local nAliqPS2   := nAliqBase // Apuracao
Local nAliqPS3   := nAliqBase // Substituicao Tributaria ST
Local lRecalPS2  := .T.
Local lAgreg     := .F.
Local lDc5602	 := .F.
Local lSegUndPau := aParSX6[MV_PISCOFP] //utiliza ou nao segunda unidade quando for pauta	

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Reducao de BASE PIS pesquisa pelo PRODUTO / TES ou EXCECAO³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
DEFAULT nRedBsPIS := 0
DEFAULT cExecuta  := "BSE|ALQ|VLR"

If aParSX6[MV_PCFATPC] .And. aNfCab[NF_OPERNF] == "S" .And. !Empty(aNfCab[NF_CLIEFAT])
	aExcecao	:= aNFitem[nItem][IT_EXCECAO]
	aNFitem[nItem][IT_EXCECAO] := aNFitem[nItem][IT_EXCEFAT]
	cNatureza	:= aNfCab[NF_NATUREZA]
	aNfCab[NF_NATUREZA]	:= aNfCab[NF_NATUFAT]
EndIf

nRedBsPIS := IIf( aTES[TS_BASEPIS] > 0 , aTES[TS_BASEPIS] , nRedBsPIS )
nRedBsPIS := IIf( !Empty(aNFitem[nItem][IT_EXCECAO]) .And. aNfItem[nItem,IT_EXCECAO,18] > 0 , aNfItem[nItem,IT_EXCECAO,18] , nRedBsPIS )
If nRedBsPIS <> 0
	nFatRedPIS	:= IIf( nRedBsPIS>0,1-nRedBsPIS/100,1)
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³PIS APURACAO - IT_BASEPS2 / IT_ALIQPS2 / IT_VALPS2 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If "PS2" $ cTipo
	lDc5602:=.F.
	If aNfItem[nItem][IT_TABNTRE] == "4313" .AND. aNfCab[NF_OPERNF]=="S"
		lDc5602:=Decret5602((aNfItem[nItem][IT_VALMERC]/ aNfItem[nItem][IT_QUANT]),aNfItem[nItem][IT_POSIPI],aNfItem[nItem][IT_CODNTRE])				
	EndIF
	aNfItem[nItem][IT_ALQPMAJ] := aTes[TS_ALQPMAJ] //Alimenta a referencia de aliquota majorada do PIS APURACAO
	aNfItem[nItem][IT_VALPMAJ] := 0 						// garante a limpeza da referencia caso o produto seja trocado na edicao da NF.	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Devolucao de importacao, mantem os valores do PIS APURACAO do documento Original³
	//³If aNFCab[NF_TPCLIFOR]=="X" .And. Substr(aNfItem[nItem][IT_CF],1,1)$"37"        ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If ( aNFCab[NF_TIPONF] $"DB" .Or. aTes[TS_PODER3] == "D" ) .And. !Empty(aNFItem[nItem][IT_RECORI]) .And. aTes[TS_OPERGAR] <> '1'
		If aNFCab[NF_TIPONF] $ "DB"
			If aNFCab[NF_CLIFOR] == "C"
				SD2->(MsGoto(aNFItem[nItem][IT_RECORI]) )
				If aNfItem[nItem][IT_QUANT] == SD2->D2_QUANT
					aNfItem[nItem][IT_ALIQPS2] := SD2->D2_ALQIMP6
					aNfItem[nItem][IT_BASEPS2] := SD2->D2_BASIMP6
					aNfItem[nItem][IT_VALPS2]  := SD2->D2_VALIMP6
					lRecalPS2 := .F.
				ElseIf aNfItem[nItem][IT_QUANT] <> SD2->D2_QUANT .And. aTes[TS_DEVPARC]$"1S"
					aNfItem[nItem][IT_ALIQPS2] := SD2->D2_ALQIMP6
					aNfItem[nItem][IT_BASEPS2] := (aNfItem[nItem][IT_QUANT] * SD2->D2_BASIMP6)/SD2->D2_QUANT
					aNfItem[nItem][IT_VALPS2]  := (aNfItem[nItem][IT_QUANT] * SD2->D2_VALIMP6)/SD2->D2_QUANT
					lRecalPS2 := .F. 
				EndIf
			Else
				SD1->(MsGoto( aNFItem[nItem][IT_RECORI]) )
				If aNfItem[nItem][IT_QUANT] == SD1->D1_QUANT
					aNfItem[nItem][IT_ALIQPS2] := SD1->D1_ALQIMP6
					aNfItem[nItem][IT_BASEPS2] := SD1->D1_BASIMP6
					aNfItem[nItem][IT_VALPS2]  := SD1->D1_VALIMP6
					If aTes[TS_ALQPMAJ] > 0
						aNfItem[nItem][IT_VALPMAJ] := aNfItem[nItem][IT_BASEPS2] * (aTes[TS_ALQPMAJ]/100)
					EndIf					
					lRecalPS2 := .F.
				EndIf
			EndIf
		Else
			If aNFCab[NF_CLIFOR] == "C"
				SD1->(MsGoto( aNFItem[nItem][IT_RECORI]) )
				If aNfItem[nItem][IT_QUANT] == SD1->D1_QUANT
					aNfItem[nItem][IT_ALIQPS2] := SD1->D1_ALQIMP6
					aNfItem[nItem][IT_BASEPS2] := SD1->D1_BASIMP6
					aNfItem[nItem][IT_VALPS2]  := SD1->D1_VALIMP6
					lRecalPS2 := .F.
				EndIf
			Else
				SD2->(MsGoto(aNFItem[nItem][IT_RECORI]) )
				If aNfItem[nItem][IT_QUANT] == SD2->D2_QUANT
					aNfItem[nItem][IT_ALIQPS2] := SD2->D2_ALQIMP6
					aNfItem[nItem][IT_BASEPS2] := SD2->D2_BASIMP6
					aNfItem[nItem][IT_VALPS2]  := SD2->D2_VALIMP6
					lRecalPS2 := .F.
				ElseIf aNfItem[nItem][IT_QUANT] <> SD2->D2_QUANT .And. aTes[TS_DEVPARC]$"1S"
					aNfItem[nItem][IT_ALIQPS2] := SD2->D2_ALQIMP6
					aNfItem[nItem][IT_BASEPS2] := (aNfItem[nItem][IT_QUANT] * SD2->D2_BASIMP6)/SD2->D2_QUANT
					aNfItem[nItem][IT_VALPS2]  := (aNfItem[nItem][IT_QUANT] * SD2->D2_VALIMP6)/SD2->D2_QUANT
					lRecalPS2 := .F.
				EndIf
			EndIf
		EndIf
	EndIf
		
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³PIS APURACAO - CALCULO                        ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If lRecalPS2
		If aTes[TS_PISCOF]$"1|3" .And. !aTes[TS_PISCRED]$"3"
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Define a Aliquota do PIS APURACAO - IT_ALIQPS2³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If ( aTES[TS_PISCRED] == "3" .Or. Empty(aTES[TS_PISCRED]) ) .And. aNfItem[nItem][IT_PRD][SB_PIS] == "2"
				nAliqPS2 := 0
			Endif
			
			If ( aExistPE[PE_MACSTPICO] .And. ExecBlock("MaCstPiCo",.F.,.F.,{nItem,aNfItem[nItem][IT_PRODUTO],aNfItem[nItem][IT_TES],aNfCab[NF_CLIFOR],aNfCab[NF_CODCLIFOR],aNfCab[NF_LOJA],aNfCab[NF_OPERNF]})[2]$"04#06#73") .Or. (!aExistPE[PE_MACSTPICO] .And. (aTES[TS_CSTPIS] $"04#06#73" .Or. aTes[TS_PSCFST]== "3")) 
				nAliqPS2:=0
			EndIF
			
			aNfItem[nItem][IT_ALIQPS2]	:= IIf( aParSX6[MV_APURPIS] , aParSX6[MV_TXPIS] , nAliqPS2 )// MV_APURPIS = .T. pegar aliquota do MV_TXPIS
			
			If aExistPE[PE_MAPISDIF] // //Ponto de Entrada para calculo de PIS Apuracao com Aliquota Diferenciada
				aMaPISDif := ExecBlock("MAPISDIF",.F.,.F.,{nItem,nAliqPS2})
				If aMaPISDif[1] == "S"
					aNfItem[nItem][IT_ALIQPS2] := aMaPISDif[2]
				EndIf
			EndIf
		
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Aliquota Majorada do PIS, Majora a Aliquota do PIS APURACAO qunado for Importacao. MaFisII    ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If aTes[TS_ALQPMAJ] > 0 .And. aNFCab[NF_OPERNF] == "E" .And. aNFCab[NF_CLIFOR] =="F" .And. aNFCab[NF_TPCLIFOR] =="X" .And. Substr(aNfItem[nItem][IT_CF],1,1)=="3" .And. aTes[TS_INTBSIC]$"123" 
				aNfitem[nItem][IT_ALIQPS2] := aNFitem[nItem][IT_ALIQPS2] + aTes[TS_ALQPMAJ]
			EndIf
	
			IF lDc5602
				aNfitem[nItem][IT_ALIQPS2]:= 0
			EndIF	
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³PIS APURACAO - BASE - IT_BASEPS2          ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If "BSE" $ cExecuta
				If !aTES[TS_PISCRED] $ "5" .AND. !aNfItem[nItem][IT_TIPONF]$"I"  
					
					If ( nPautaSB1 == 0 .And. (Empty(aNFitem[nItem][IT_EXCECAO]) .Or. (!Empty(aNFitem[nItem][IT_EXCECAO]) .And. Empty(aNfItem[nItem][IT_EXCECAO][10])))) .Or.;
						(!Empty(aNFitem[nItem][IT_EXCECAO]) .And. Empty(aNfItem[nItem][IT_EXCECAO][10])) .Or.;
						aNfItem[nItem,IT_QUANT]==0 .Or. aParSX6[MV_PISPAUT]
						
						If ( nPautaSB1 == 0 .And. (Empty(aNFitem[nItem][IT_EXCECAO]) .Or. (!Empty(aNFitem[nItem][IT_EXCECAO]) .And. Empty(aNfItem[nItem][IT_EXCECAO][10])))) .Or.;
							(!Empty(aNFitem[nItem][IT_EXCECAO]) .And. Empty(aNfItem[nItem][IT_EXCECAO][10]) .And. nPautaSB1 == 0) .Or.;
							aNfItem[nItem,IT_QUANT]==0
							nBasePS2 := aNfItem[nItem][IT_VALMERC]-IIf(aTes[TS_AGREG]$"DR",aNfItem[nItem][IT_DEDICM],0)
							
							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//³Tratamento do Agrega Valor - PIS / COF / ICMS ³
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							nAliqAgr := 0
							If aTes[TS_AGREG]=="I"
								If aTes[TS_ICM] == "N"
									nAliqAgr += aNfItem[nItem][IT_ALIQSOL]
									lAgreg	 := .T.
								Else
									nAliqAgr += aNfItem[nItem][IT_ALIQICM]
									lAgreg	 := .T.
								EndIf
							EndIf
							
							If aTes[TS_AGRPIS]=="P"
								nAliqAgr += aNfItem[nItem][IT_ALIQPS2]
								lAgreg	 := .T.
								If aTes[TS_AGRCOF]=="C"
									nAliqAgr += aNfItem[nItem][IT_ALIQCF2]
								Endif
							Endif
							
							If lAgreg
								nBasePS2 := Round(nBasePS2 / ( 1 - (nAliqAgr/100)) , 2 )
							Endif
							
							If aTes[TS_AGREG] == "I" .And. !lAgreg
								nBasePS2 += If(aNFitem[nItem][IT_TIPONF ]<>"I",aNfItem[nItem][IT_VALICM],0)
							EndIf
							
							nBasePS2 := ( nBasePS2 - IIf( aTes[TS_PISBRUT] == "1" , 0 , (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT]) ) + aNfItem[nItem][IT_DESCZFCOF] + aNfItem[nItem][IT_DESCZFPIS] + IIf(aNfItem[nItem][IT_DESCZFPIS]<>0,0,IIF(aTes[TS_CRPRST]<>0 .And. IntTms(),aNfItem[nitem][IT_VLCSOL],aNfItem[nitem][IT_VALSOL])) )
							
							If ( !(aNfCab[NF_CLIFOR]=="C" .And. aNfCab[NF_CALCSUF]$"SI" .And. !aNFitem[nItem][IT_TIPONF ]$"BD" .And. ;
								aTes[TS_ISS] <> "S" .And. aParSX6[MV_DESCZF] .And. aParSX6[MV_DESZFPC] ) .And. aParSX6[MV_FRTBASE] ) .Or. aParSX6[MV_FRTBASE]
								nBasePS2 += IIf(aTes[TS_DESPPIS] <> "2",aNfItem[nItem][IT_DESPESA],0) + IIF(aTes[TS_DESPPIS] <> "2",aNfItem[nItem][IT_SEGURO],0) + IIF(aTes[TS_DESPPIS] <> "2",aNfItem[nItem][IT_FRETE],0)
							EndIf
							
							If aNFitem[nItem][IT_TIPONF ] == "P"
								nBasePS2 := 0
							EndIf
							
							If aTes[TS_CREDICM] == "S" .And. aParSX6[MV_DEDBPIS]$"S,I"	// Caso seja comerciante atacadista, o valor do IPI deve ser retirado da base de calculo do PIS pois esta embutido no valor da mercadoria
								nBasePS2 -= aNfItem[nItem][IT_VALICM]
							EndIf
							
							If aTes[TS_CREDIPI] == "N" .AND. aParSX6[MV_DEDBPIS]$"S,P" .AND. aTes[TS_IPI]<>"R"
								nBasePS2 += aNfItem[nItem][IT_VALIPI]
							EndIf
							If aTes[TS_CREDIPI] $ "S" .And. aParSX6[MV_DEDBPIS]$"S,P" .And. aTes[TS_IPI] == "R"
								nBasePS2 -= aNfItem[nItem][IT_VALIPI]
							EndIf
							
							If aParSX6[MV_CRDBPIS] $ "S" .And. Substr(aNfItem[nItem][IT_CF],1,1)=="3"
								nBasePS2 += aNfItem[nItem][IT_VALICM]
							EndIf
							
							If aNFitem[nItem][IT_TIPONF ] == "P" .And. nBasePS2 < 0
								nBasePS2 := 0
							EndIf
							
							If aTes[TS_PISDSZF] == "2"
								nBasePS2 += aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFCOF] + aNfItem[nItem][IT_DESCZFPIS])
							Endif
							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//³ Indica o tratamento para retirada do valor do ICMS solidario na base do PIS apurado    ³
							//³ 1 - Nunca retira                                                                       ³
							//³ 2 - Retira se houver credito do ICMS ST                                                ³
							//³ 3 - Retira se nao houver credito do ICMS ST                                            ³
							//³ 4 - Retira se houver credito do ICMS normal                                            ³
							//³ 5 - Retira se nao houver credito do ICMS normal                                        ³
							//³ 6 - Sempre retira                                                                      ³
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							If (aParSX6[MV_DBSTPIS] == "6" .Or. (aParSX6[MV_RPCBIZF] .And. aNfCab[NF_SUFRAMA]) .Or.;
								( aTes[TS_CREDST]  == "1" .And. aParSX6[MV_DBSTPIS] == "2" ) .Or. ;
								( aTes[TS_CREDST]  == "2" .And. aParSX6[MV_DBSTPIS] == "3" ) .Or. ;
								( aTes[TS_CREDICM] == "S" .And. aParSX6[MV_DBSTPIS] == "4" ) .Or. ;
								( aTes[TS_CREDICM] == "N" .And. aParSX6[MV_DBSTPIS] == "5" ) ) .And. aNfItem[nItem][IT_DESCZFPIS] == 0
								nBasePS2 -= IIF(aTes[TS_CRPRST]<>0 .And. IntTms(),aNfItem[nitem][IT_VLCSOL],aNfItem[nitem][IT_VALSOL])
							Endif
						Else
							nBasePS2 := IIF(lSegUndPau,ConvUm(aNfItem[nItem][IT_PRODUTO],aNfItem[nItem][IT_QUANT],0,2),aNfItem[nItem,IT_QUANT])
						EndIf
						
						nBasePS2 *= nFatRedPIS
						aNfItem[nItem][IT_BASEPS2] := nBasePS2
						
						If aTes[TS_OPERSUC] == "1" // Operacoes com Sucata
							nBasePS2 := (aNFitem[nItem][IT_VALICM] / ( (100-(aNFitem[nItem][IT_ALIQICM]+aNFitem[nItem][IT_ALIQPS2]+aNFitem[nItem][IT_ALIQCF2]))/100 ) )
							aNfItem[nItem][IT_BASEPS2] := nBasePS2
						Endif
					Else
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³Calculo da BASE PIS APURACAO pela PAUTA do SB1 ou EXCECAO³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						If (Empty(aNFitem[nItem,IT_EXCECAO]) .Or. Empty(aNFItem[nItem,IT_EXCECAO,10]))						
							nBasePS2 := IIF(lSegUndPau,ConvUm(aNfItem[nItem][IT_PRODUTO],aNfItem[nItem][IT_QUANT],0,2),aNfItem[nItem,IT_QUANT]) * nPautaSB1
							aNfItem[nItem][IT_PAUTPIS]	:= nPautaSB1
						Else
							nBasePS2 := aNfItem[nItem,IT_QUANT] * aNFItem[nItem,IT_EXCECAO,10]
							aNfItem[nItem][IT_PAUTPIS]	:= aNFItem[nItem,IT_EXCECAO,10]
						EndIf
						aNfItem[nItem][IT_BASEPS2] := nBasePS2
					EndIf
					
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³Zera a BASE do PIS APURACAO somente quando a aliquota for = 0 e o CSTPIS  NAO for = "04#06#73"³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					If Empty( aNfItem[nItem][IT_ALIQPS2] ) .And. ((aExistPE[PE_MACSTPICO] .And. !ExecBlock("MaCstPiCo",.F.,.F.,{nItem,aNfItem[nItem][IT_PRODUTO],aNfItem[nItem][IT_TES],aNfCab[NF_CLIFOR],aNfCab[NF_CODCLIFOR],aNfCab[NF_LOJA],aNfCab[NF_OPERNF]})[2]$"04#06#73") .Or. (!aExistPE[PE_MACSTPICO] .And. !aTES[TS_CSTPIS] $"04#06#73")) .AND. !lDc5602
						aNfItem[nItem][IT_BASEPS2] := 0
					EndIf
					
				Else
					aNfItem[nItem][IT_BASEPS2] := 0
				EndIf
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³Especifico para VEICULOS³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If aParSX6[MV_CALCVEI] .And. "PS2" $ cTipo .And. aNfCab[NF_OPERNF] == "S" .And. aFieldPos[FP_B1_CHASSI] .And. !Empty( aNfItem[nItem][IT_PRD][SB_CHASSI] ) // Alteracao de base para veiculos usados
					If aNfItem[nItem][IT_BASVEIC] == 0
						aAreaSC6 := SC6->(GetArea())
						SC6->(dbSetOrder(1))
						If SC6->( MsSeek(xFilial("SC6")+aNfCab[NF_PEDIDO]+aNfItem[nItem][IT_ITEM]+aNfItem[nItem][IT_PRODUTO]) )
							aNfItem[nItem][IT_BASVEIC] := SC6->C6_BASVEIC
						EndIf
						RestArea(aAreaSC6)
					EndIf
					aNfItem[nItem][IT_BASEPS2] -= aNfItem[nItem][IT_BASVEIC]
					If aNfItem[nItem][IT_BASEPS2] < 0
						aNfItem[nItem][IT_BASEPS2] := 0
					EndIF
				EndIf
				
			EndIf
			
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Define o Valor do PIS MAJORADO conforme aliquota informada na TES.    ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If aTes[TS_ALQPMAJ] > 0
				aNfItem[nItem][IT_VALPMAJ] := aNfItem[nItem][IT_BASEPS2] * (aTes[TS_ALQPMAJ]/100)
			EndIf				
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³PIS APURACAO - VALOR - IT_VALPS2          ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If "VLR" $ cExecuta
			
				If (nPautaSB1 == 0 .And. (Empty(aNFitem[nItem][IT_EXCECAO]) .Or. (!Empty(aNFitem[nItem][IT_EXCECAO]) .And. Empty(aNfItem[nItem][IT_EXCECAO][10])))) .Or.;
					aNfItem[nItem,IT_QUANT]==0 .Or. !aParSX6[MV_PISPAUT]					
					
					aNfItem[nItem][IT_VALPS2] := aNfItem[nItem][IT_BASEPS2]*aNfItem[nItem][IT_ALIQPS2]/100
					
				Else
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³PIS APURACAO - Aplica PAUTA SB1 ou Excecao³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					If aNfItem[nItem][IT_BASEPS2] <> 0
						If Empty(aNFitem[nItem,IT_EXCECAO]) .Or. Empty(aNFItem[nItem,IT_EXCECAO,10])
							aNfItem[nItem][IT_VALPS2]  := IIF(lSegUndPau,ConvUm(aNfItem[nItem][IT_PRODUTO],aNfItem[nItem][IT_QUANT],0,2),aNfItem[nItem,IT_QUANT]) * nPautaSB1	
							aNfItem[nItem][IT_PAUTPIS] := nPautaSB1
						Else
							aNfItem[nItem][IT_VALPS2]  := aNfItem[nItem,IT_QUANT] * aNFItem[nItem,IT_EXCECAO,10]
							aNfItem[nItem][IT_PAUTPIS] := aNFItem[nItem,IT_EXCECAO,10]
						EndIf
					EndIf
				EndIf
				
				If aTes[TS_AGRPIS]=="P"
					aNfItem[nItem][IT_VALPS2] := Round(aNfItem[nItem][IT_VALPS2],2)
				EndIf
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³DESCONTO SUFRAMA - PIS APURACAO ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If aNfCab[NF_CLIFOR]=="C" .And. !aNfCab[NF_CALCSUF]$"IN " .And. !aNFitem[nItem][IT_TIPONF ]$"BD" .And. ;
					aTes[TS_ISS] <> "S" .And. aParSX6[MV_DESCZF] .And. aParSX6[MV_DESZFPC] .And. ( aTES[TS_PISCRED]$"134" )
					
					If ( aExistPE[PE_MACSTPICO] .And. ExecBlock("MaCstPiCo",.f.,.f.,{nItem,aNfItem[nItem][IT_PRODUTO],aNfItem[nItem][IT_TES],aNfCab[NF_CLIFOR],aNfCab[NF_CODCLIFOR],aNfCab[NF_LOJA],aNfCab[NF_OPERNF]})[2]$"04#06#73") .Or. ( !aExistPE[PE_MACSTPICO] .And. aTES[TS_CSTPIS] $"04#06#73")
						If aNfItem[nItem][IT_PAUTPIS] == 0
							If aNfItem[nItem][IT_DESCZFPIS] == 0
								aNfItem[nItem][IT_VALPS2]:= aNfItem[nItem][IT_BASEPS2] * nAliqBase / 100
							Else
								aNfItem[nItem][IT_VALPS2]:= aNfItem[nItem][IT_DESCZFPIS]
							Endif
						Else
							aNfItem[nItem][IT_VALPS2] := aNfItem[nItem][IT_BASEPS2]
						EndIf
					Endif
					
					MaItArred(nItem,{"IT_DESCZFPIS"})
					aNfItem[nItem][IT_DESCZF] -= aNfItem[nItem][IT_DESCZFPIS]
					
					If aNfCab[NF_ROTINA] == "MATA461" .Or. FunName()=="MATA920"
						MaItArred(nItem,{"IT_VALPS2"})
						aNfItem[nItem][IT_VALMERC]+= aNfItem[nItem][IT_DESCZFPIS]
						aNfItem[nItem][IT_VALMERC]-= aNfItem[nItem][IT_VALPS2]
						If ( aNfCab[NF_TIPONF] $"CPI") .And. FunName()=="MATA920"
							aNfItem[nItem][IT_PRCUNI] := (aNfItem[nItem][IT_VALMERC]- (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT])) + aNfItem[nItem][IT_ACRESCI] 
						Else
							aNfItem[nItem][IT_PRCUNI] := (aNfItem[nItem][IT_VALMERC]-(aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT]) + aNfItem[nItem][IT_ACRESCI] )/aNfItem[nItem][IT_QUANT]
						EndIf
					EndIf
					aNfItem[nItem][IT_DESCZFPIS]:= aNfItem[nItem][IT_VALPS2]
					MaItArred(nItem,{"IT_DESCZFPIS"})
					aNfItem[nItem][IT_DESCZF]   += aNfItem[nItem][IT_DESCZFPIS]
					aNfItem[nItem][IT_VALPS2]   := 0
					If aTES[TS_PSCFST] == "1" .And. !aTES[TS_CSTPIS] $"04#06#73"
						aNfItem[nItem][IT_BASEPS2]  := 0
					EndIf
				EndIf
				
				MaItArred(nItem,{"IT_VALPS2"})
			Endif
			
			If "PS2" $ cTipo
				If aExistPE[PE_MAPISVEIC] // ATENCAO!!! Ponto de entrada para uso exclusivo da TOTVS, nao sugerir o uso do mesmo a clientes - GDP FISCAL
					aMaPISVeic := ExecBlock("MaPISVeic",.F.,.F.,{nItem,aNfItem[nItem][IT_BASEPS2],aNfItem[nItem][IT_ALIQPS2],aNfItem[nItem][IT_VALPS2]})
					aNfItem[nItem][IT_BASEPS2] := aMaPISVeic[1]
					aNfItem[nItem][IT_ALIQPS2] := aMaPISVeic[2]
					aNfItem[nItem][IT_VALPS2]  := aMaPISVeic[3]
				EndIf
			Endif
		Else
			If "BSE" $ cExecuta
				aNfItem[nItem][IT_BASEPS2]:= 0
			EndIf
			If "VLR" $ cExecuta
				aNfItem[nItem][IT_VALPS2] := 0
			EndIf			
		EndIf	
	EndIf
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³PIS RETENCAO - IT_BASEPIS / IT_ALIQPIS / IT_VALPIS ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If "PIS" $ cTipo
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Define a Aliquota do PIS RETENCAO - IT_ALIQPIS³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If "ALQ" $ cExecuta
		If Empty(nAliqSB1) .Or. aParSX6[MV_TPALPIS] == "1"
			If !Empty(aNfCab[NF_NATUREZA]) .And. aInfNat[NT_CALCPIS] == "S" .And. !Empty(aInfNat[NT_PERCPIS])
				
				nAliqPIS :=  aInfNat[NT_PERCPIS]
				
				If nModulo == 43 .And. SA1->A1_TPESSOA == "EP" // Para o Tipo de Cliente 'Empresa Publica',quando transporte for Internacional,nao gerar a retencao de PIS/COFINS -- BOPS 153148
					aAreaSA1 := SA1->(GetArea())
					SA1->(dbSetOrder(1))
					If SA1->(msSeek(xFilial("SA1")+SF2->F2_CLIENT+SF2->F2_LOJENT)) .And. SA1->A1_EST == "EX"
						nAliqPIS := 0
					EndIf
					RestArea(aAreaSA1)
				EndIf
				
			EndIf
			
			If aExistPE[PE_MACALCPIS]
				If aMaCalcPIS[1] == "S" .And. !Empty(aMaCalcPIS[2])
					nAliqPIS := aMaCalcPIS[2]
				EndIf
			EndIf
			
		EndIf
		
		aNfItem[nItem][IT_ALIQPIS]	:= nAliqPIS
	Endif
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Calculo de BASE e VALOR do PIS RETENCAO - IT_BASEPIS e IT_VALPIS ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If "BSE" $ cExecuta .Or. "VLR" $ cExecuta
		If ( aExistPE[PE_MACALCPIS] .And. aMaCalcPIS[1]=="S" ) .Or. ( !Empty(aNfCab[NF_NATUREZA]) .And. aInfNat[NT_CALCPIS]=="S" ;
			.And. aNfCab[NF_RECPIS] $ "S|P" .And. ( aNfItem[nItem][IT_PRD][SB_PIS] == "1" .Or. aNfCab[NF_RECPIS] == "P" ) )
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ A base de calculo da retencao eh o valor da duplicata       ³
			//³ porem de acordo com a Cons. Trib. Liz, o valor do ISS nao   ³
			//³ devera ser deduzido da base do PIS/COF/CSL retencao. Para   ³
			//³ isso foi criado o parametro MV_DEISSBS que se estiver como  ³
			//³ .T. nao sera descontado e se estiver como .F. - default sera³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			nDescISS := Iif( aParSX6[MV_DEISSBS] .And. aNfCab[NF_RECISS]=="1" .And. aParSX6[MV_DESCISS] .And. aNfCab[NF_OPERNF]=="S" .And. aParSX6[MV_TPABISS]=="1",aNfItem[nItem][IT_VALISS],0)
			nBasePIS := aNfItem[nItem,IT_BASEDUP] + IIf( aParSX6[MV_PISBRU] == "1" , (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT]) , 0 ) + nDescISS
			nBasePIS *= nFatRedPIS
			//Tratamento extraido da funcao MaFisVTot para saber se foi contemplado o VALOR DE IPI na base da duplicata para que eu possa subtrair
			If (aTes[TS_IPIPC]=="2") .And. (aNFitem[nItem][IT_TIPONF]=="P" .Or. aTes[TS_IPI]<>'R')
				nBasePIS -= aNfItem[nItem][IT_VALIPI]
			EndIf
			If aParSX6[MV_CRDBPIS] $ "S" .And. Substr(aNfItem[nItem][IT_CF],1,1)=="3"
				nBasePIS += aNfItem[nItem][IT_VALICM]
			EndIf
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Indica o tratamento para retirada do valor do ICMS solidario na base do PIS Retencao   ³
			//³ 1 - Nunca retira                                                                       ³
			//³ 2 - Retira se houver credito do ICMS ST                                                ³
			//³ 3 - Retira se nao houver credito do ICMS ST                                            ³
			//³ 4 - Retira se houver credito do ICMS normal                                            ³
			//³ 5 - Retira se nao houver credito do ICMS normal                                        ³
			//³ 6 - Sempre retira                                                                      ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If (aParSX6[MV_DBSTPSR] == "6" .Or. ;
				( aTes[TS_CREDST]  == "1" .And. aParSX6[MV_DBSTPSR] == "2" ) .Or. ;
				( aTes[TS_CREDST]  == "2" .And. aParSX6[MV_DBSTPSR] == "3" ) .Or. ;
				( aTes[TS_CREDICM] == "S" .And. aParSX6[MV_DBSTPSR] == "4" ) .Or. ;
				( aTes[TS_CREDICM] == "N" .And. aParSX6[MV_DBSTPSR] == "5" ) ) .And. aNfItem[nItem][IT_DESCZFPIS] == 0
				nBasePIS -= aNfItem[nitem][IT_VALSOL]
			Endif
			
			If "BSE" $ cExecuta
				aNfItem[nItem][IT_BASEPIS]:= nBasePIS
            Endif
            If "VLR" $ cExecuta
		   		aNfItem[nItem][IT_VALPIS] := aNfItem[nItem][IT_BASEPIS] * aNfItem[nItem][IT_ALIQPIS] / 100
			Endif 
			
			If aNfItem[nItem][IT_PRD][SB_RETOPER] == "1" .And. !aNfCab[NF_RECPIS] == "N" //Item classificado na Medida Provisoria 252 Junho/2005 e nao aguardar o limite imposto pela Lei 10.925 (R$ 5.000,00) autopecas
				aNfItem[nItem][IT_PIS252] := aNfItem[nItem][IT_VALPIS]
			Endif	
		Else
			If "BSE" $ cExecuta
				aNfItem[nItem][IT_BASEPIS]:= 0
            EndIf
            If "VLR" $ cExecuta
				aNfItem[nItem][IT_VALPIS] := 0
            EndIf
		EndIf
	EndIf		
	MaItArred(nItem,{"IT_VALPIS"})
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Calcula PIS-ST   Base  Aliquota e Valor - IT_BASEPS3 - IT_ALIQPS3 - IT_VALPS3       ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If "PS3" $ cTipo
	If aTES[TS_PSCFST] $ "1/3"
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Conforme IN SRF 594 de 2005, nao devem integrar a base de calculo do PIS/COFINS ST:³
		//³- Receitas isentas e as decorrentes de vendas a aliquota 0                         ³
		//³- Vendas canceladas                                                                ³
		//³- Descontos incondicionais                                                         ³
		//³- IPI                                                                              ³
		//³- ICMS ST                                                                          ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If aTes[TS_IPIPC] == "2" //Somente retiro aqui o valor do PS3 e CF3 caso o campo IPIPC estiver como 2, pois se estiver como 1 já estou retirando os valores no momento de compor o IT_TOTAL
			nBasePS3 := aNfItem[nItem][IT_TOTAL] - ((aNfItem[nItem][IT_VALPS3]) + aNfItem[nItem][IT_VALCF3])
			nBasePS3 -= aNfItem[nItem][IT_VALIPI] //Conforme IN SRF546/2005 o valor do IPI deve integrar a base calculo PIS/COFINS ST-Zona Franca de Manaus
			
			If !(aTes[TS_INCSOL]$"A,N,D") // Verifica se o valor do ICMS Solidario esta agregado ao valor total
				nBasePS3 -= aNfItem[nItem][IT_VALSOL]
			Endif
			
		Else
			nBasePS3 := aNfItem[nItem][IT_VALMERC] + aNfItem[nItem][IT_VALIPI]
		Endif
		
		If aNFCab[NF_CLIFOR] == "C" .And. aNFCab[NF_TIPONF] $ "DB" .And. !aNfItem[nItem][IT_TIPONF]$"I|P" .And. aParSX6[MV_DESCZF] .And. aParSX6[MV_DESZFPC]
			If aTES[TS_PISCRED] <> "3" .And. aTES[TS_PISCOF]$"13" .And. !aNfCab[NF_CALCSUF]$"IN "
				nBasePS3 -= (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT])
			ElseIf aTES[TS_PISCRED] == "3" .And. aTES[TS_PISCOF]$"4" .And. aNfCab[NF_CALCSUF]$"I"
				nBasePS3 -= (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT])
			EndIf
		EndIf
		
		If aTes[TS_PISDSZF] == "2"
			nBasePS3 += aNfItem[nItem][IT_DESCZF]
		EndIf
		
		nBasePS3 *= nFatRedPIS
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Se usuario informou percentual de Substituicao Tributaria de cigarro, ira multiplicar a base de calculo pelo percentual³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If Len(Alltrim(aParSX6[MV_PUPCCST])) > 0 .And. aFieldPos[FP_B1_PUPCCST]
			nVlUnitCig := aNfItem[nItem][IT_PRD][SB_PUPCCST] // Campo onde e informado o valor unitario para calcular valor de PIS ST.
		EndIF
		
		If !Empty(aNFitem[nItem][IT_EXCECAO])
			If aNfItem[nItem,IT_EXCECAO,25] > 0
				nVlUnitCig	:= aNfItem[nItem,IT_EXCECAO,25]
				aNfItem[nItem][IT_PRCUNIC] := nVlUnitCig
			Endif
		Endif
		
		If Len(AllTrim(aParSX6[MV_B1CPSST])) > 0 .And. aFieldPos[FP_B1_B1CPSST]
			aNfItem[nItem][IT_COEPSST] := aNfItem[nItem][IT_PRD][SB_B1CPSST] // Campo onde e informado o % de Substituição tributaria do PIS para fabrincante de cigarros.
		EndIf
		
		If nVlUnitCig > 0
			If aNfItem[nItem][IT_COEPSST] > 0
				nBasePS3 := ( aNfItem[nItem][IT_QUANT] * nVlUnitCig ) * aNfItem[nItem][IT_COEPSST]
			Else
				nBasePS3 := aNfItem[nItem][IT_QUANT] * nVlUnitCig
			EndIf
		EndIF
		
		If aNFCab[NF_TIPONF]$"D" .And. !Empty(aNFItem[nItem][IT_RECORI]) .And. aNFCab[NF_CLIFOR] == "C"
			SD2->( MsGoto( aNFItem[nItem][IT_RECORI] ) )
			nBasePS3 := aNfItem[nItem][IT_QUANT] * SD2->D2_BASEPS3 / SD2->D2_QUANT
		EndIF
		
		If "BSE" $ cExecuta
			aNfItem[nItem][IT_BASEPS3] := nBasePS3
		Endif
		If "ALQ" $ cExecuta
	   		aNfItem[nItem][IT_ALIQPS3] := Iif(aTES[TS_PSCFST] == "3",0,nAliqPS3)
		Endif
		If "VLR" $ cExecuta
			aNfItem[nItem][IT_VALPS3]  := aNfItem[nItem][IT_BASEPS3]*aNfItem[nItem][IT_ALIQPS3]/100
		Endif	
	Else
		If "BSE" $ cExecuta
			aNfItem[nItem][IT_BASEPS3] := 0
		EndIf
		If "ALQ" $ cExecuta
			aNfItem[nItem][IT_ALIQPS3] := 0
		EndIf
		If "VLR" $ cExecuta
			aNfItem[nItem][IT_VALPS3]  := 0
		EndIf
	EndIf
	MaItArred(nItem,{"IT_VALPS3"})
EndIf

If aParSX6[MV_PCFATPC] .And. aNfCab[NF_OPERNF] == "S" .And. !Empty(aNfCab[NF_CLIEFAT])
	aNFitem[nItem][IT_EXCECAO] 	:= aExcecao
	aNfCab[NF_NATUREZA] 		:= cNatureza
EndIf

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao   ³MaFisCOFINS³ Autor ³Alexandre Lemes        ³ Data ³28/09/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o³Calculo do COFINS - Apuracao / Retencao e ST                 ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisCOFINS(nItem,cTipo,cExecuta)

Local aExcecao	 := {}
Local aAreaSA1   := {}
Local aAreaSC6   := {}
Local aMaCOFVeic := {}
Local aMaCOFDif  := {}
Local aMaCalcCOF := IIf( aExistPE[PE_MACALCCOF] , ExecBlock("MaCalcCOF") , Array(2) )

Local cNatureza	 := ""

Local nDescISS	 := 0
Local nVlUnitCig := 0
Local nFatRedCOF := 1
Local nAliqAgr	 := 0
Local nBaseCOF   := 0
Local nBaseCF2	 := 0
Local nBaseCF3	 := 0
Local nPautaSB1  := aNfItem[nItem][IT_PRD][SB_VLR_COF]
Local nRedBsCOF	 := aNfItem[nItem][IT_PRD][SB_REDCOF]
Local nAliqSB1   := aNfItem[nItem][IT_PRD][SB_PCOFINS]     
Local nAliqBase  := IIf( !Empty(aNFitem[nItem,IT_EXCECAO]) .And. aNFItem[nItem,IT_EXCECAO,13] <> 0 , aNFItem[nItem,IT_EXCECAO,13] , IIf(Empty(nAliqSB1) , aParSX6[MV_TXCOFIN] , nAliqSB1) )
Local nAliqCOF   := nAliqBase // Retencao
Local nAliqCF2   := nAliqBase // Apuracao
Local nAliqCF3   := nAliqBase // Substituicao Tributaria ST
Local lRecalCF2  := .T.
Local lAgreg     := .F.
Local lDc5602	 := .F.
Local lSegUndPau := aParSX6[MV_PISCOFP] //utiliza ou nao segunda unidade quando for pauta	
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Reducao de BASE COFINS pesquisa pelo PRODUTO / TES ou EXCECAO³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
DEFAULT nRedBsCOF := 0
DEFAULT cExecuta  := "BSE|ALQ|VLR"

If aParSX6[MV_PCFATPC] .And. aNfCab[NF_OPERNF] == "S" .And. !Empty(aNfCab[NF_CLIEFAT])
	aExcecao	:= aNFitem[nItem][IT_EXCECAO]
	aNFitem[nItem][IT_EXCECAO] := aNFitem[nItem][IT_EXCEFAT]
	cNatureza	:= aNfCab[NF_NATUREZA]
	aNfCab[NF_NATUREZA]	:= aNfCab[NF_NATUFAT]
EndIf

nRedBsCOF := IIf( aTES[TS_BASECOF] > 0 , aTES[TS_BASECOF] , nRedBsCOF )
nRedBsCOF := IIf( !Empty(aNFitem[nItem][IT_EXCECAO]) .And. aNfItem[nItem,IT_EXCECAO,19] > 0 , aNfItem[nItem,IT_EXCECAO,19] , nRedBsCOF )
If nRedBsCOF <> 0
	nFatRedCOF	:= IIf( nRedBsCOF>0,1-nRedBsCOF/100,1)
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³COFINS APURACAO - IT_BASECF2 / IT_ALIQCF2 / IT_VALCF2 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If "CF2" $ cTipo
	
	lDc5602:=.F.
	If aNfItem[nItem][IT_TABNTRE] == "4313" .AND. aNfCab[NF_OPERNF]=="S"
		lDc5602:=Decret5602((aNfItem[nItem][IT_VALMERC]/ aNfItem[nItem][IT_QUANT]),aNfItem[nItem][IT_POSIPI],aNfItem[nItem][IT_CODNTRE])		
	EndIF
	aNfItem[nItem][IT_ALQCMAJ] := aTes[TS_ALQCMAJ] //Alimenta a referencia de aliquota majorada do COFINS APURACAO
	aNfItem[nItem][IT_VALCMAJ] := 0 // garante a limpeza da referencia caso o produto seja trocado na edicao da NF.
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Devolucao de importacao, mantem os valores do COFINS APURACAO do documento Original³
	//³If aNFCab[NF_TPCLIFOR]=="X" .And. Substr(aNfItem[nItem][IT_CF],1,1)$"37"           ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If ( aNFCab[NF_TIPONF] $"DB" .Or. aTes[TS_PODER3] == "D" ) .And. !Empty(aNFItem[nItem][IT_RECORI]) .And. aTes[TS_OPERGAR] <> '1'
		If aNFCab[NF_TIPONF] $ "DB"
			If aNFCab[NF_CLIFOR] == "C"
				SD2->(MsGoto(aNFItem[nItem][IT_RECORI]) )
				If aNfItem[nItem][IT_QUANT] == SD2->D2_QUANT
					aNfItem[nItem][IT_ALIQCF2] := SD2->D2_ALQIMP5
					aNfItem[nItem][IT_BASECF2] := SD2->D2_BASIMP5
					aNfItem[nItem][IT_VALCF2]  := SD2->D2_VALIMP5
					lRecalCF2 := .F.
				ElseIf aNfItem[nItem][IT_QUANT] <> SD2->D2_QUANT .And. aTes[TS_DEVPARC]$"1S"
					aNfItem[nItem][IT_ALIQCF2] := SD2->D2_ALQIMP5
					aNfItem[nItem][IT_BASECF2] := (aNfItem[nItem][IT_QUANT] * SD2->D2_BASIMP5)/SD2->D2_QUANT
					aNfItem[nItem][IT_VALCF2]  := (aNfItem[nItem][IT_QUANT] * SD2->D2_VALIMP5)/SD2->D2_QUANT
					lRecalCF2 := .F. 
				EndIf
			Else
				SD1->(MsGoto( aNFItem[nItem][IT_RECORI]) )
				If aNfItem[nItem][IT_QUANT] == SD1->D1_QUANT
					aNfItem[nItem][IT_ALIQCF2] := SD1->D1_ALQIMP5
					aNfItem[nItem][IT_BASECF2] := SD1->D1_BASIMP5
					aNfItem[nItem][IT_VALCF2]  := SD1->D1_VALIMP5
					If aTes[TS_ALQCMAJ] > 0
						aNfItem[nItem][IT_VALCMAJ] := aNfItem[nItem][IT_BASECF2] * (aTes[TS_ALQCMAJ]/100)
					EndIf
					lRecalCF2 := .F.
				EndIf
			EndIf
		Else
			If aNFCab[NF_CLIFOR] == "C"
				SD1->(MsGoto( aNFItem[nItem][IT_RECORI]) )
				If aNfItem[nItem][IT_QUANT] == SD1->D1_QUANT
					aNfItem[nItem][IT_ALIQCF2] := SD1->D1_ALQIMP5
					aNfItem[nItem][IT_BASECF2] := SD1->D1_BASIMP5
					aNfItem[nItem][IT_VALCF2]  := SD1->D1_VALIMP5
					lRecalCF2 := .F.
				EndIf
			Else
				SD2->(MsGoto(aNFItem[nItem][IT_RECORI]) )
				If aNfItem[nItem][IT_QUANT] == SD2->D2_QUANT
					aNfItem[nItem][IT_ALIQCF2] := SD2->D2_ALQIMP5
					aNfItem[nItem][IT_BASECF2] := SD2->D2_BASIMP5
					aNfItem[nItem][IT_VALCF2]  := SD2->D2_VALIMP5
					lRecalCF2 := .F.
				ElseIf aNfItem[nItem][IT_QUANT] <> SD2->D2_QUANT .And. aTes[TS_DEVPARC]$"1S"
					aNfItem[nItem][IT_ALIQCF2] := SD2->D2_ALQIMP5
					aNfItem[nItem][IT_BASECF2] := (aNfItem[nItem][IT_QUANT] * SD2->D2_BASIMP5)/SD2->D2_QUANT
					aNfItem[nItem][IT_VALCF2]  := (aNfItem[nItem][IT_QUANT] * SD2->D2_VALIMP5)/SD2->D2_QUANT
					lRecalCF2 := .F. 
				EndIf
			EndIf
		EndIf
	EndIf

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³COFINS APURACAO - CALCULO                        ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If lRecalCF2
		If aTes[TS_PISCOF]$"2|3" .And. !aTes[TS_PISCRED]$"3"
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Define a Aliquota do COFINS APURACAO - IT_ALIQCF2³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If ( aTES[TS_PISCRED] == "3" .Or. Empty(aTES[TS_PISCRED]) ) .And. aNfItem[nItem][IT_PRD][SB_COFINS] == "2"
				nAliqCF2 := 0
			Endif
			
			If ( aExistPE[PE_MACSTPICO] .And. ExecBlock("MaCstPiCo",.F.,.F.,{nItem,aNfItem[nItem][IT_PRODUTO],aNfItem[nItem][IT_TES],aNfCab[NF_CLIFOR],aNfCab[NF_CODCLIFOR],aNfCab[NF_LOJA],aNfCab[NF_OPERNF]})[2]$"04#06#73") .Or. (!aExistPE[PE_MACSTPICO] .And. (aTES[TS_CSTCOF] $"04#06#73" .Or. aTes[TS_PSCFST]== "3"))
				nAliqCF2:=0
			EndIF
			
			aNfItem[nItem][IT_ALIQCF2]	:= IIf( aParSX6[MV_APURCOF] , aParSX6[MV_TXCOFIN] , nAliqCF2 ) // MV_APURCOF = .T. pegar aliquota do MV_TXCOFIN
			
			If aExistPE[PE_MaCofDif] // //Ponto de Entrada para calculo de Cofins Apuracao com Aliquota Diferenciada
				aMaCOFDif := ExecBlock("MaCofDif",.F.,.F.,{nItem,nAliqCF2})
				If aMaCOFDif[1] == "S"
					aNfItem[nItem][IT_ALIQCF2] := aMaCOFDif[2]
				EndIf
			EndIf
		
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Aliquota Majorada do COFINS, Majora a Aliquota do COFINS APURACAO qunado for Importacao. MaFisII ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If aTes[TS_ALQCMAJ] > 0 .And. aNFCab[NF_OPERNF] == "E" .And. aNFCab[NF_CLIFOR] =="F" .And. ((aNFCab[NF_TPCLIFOR] =="X" .And. Substr(aNfItem[nItem][IT_CF],1,1)=="3") .Or. aTes[TS_IMPIND] == "1") .And. aTes[TS_INTBSIC]$"123" 
				aNfitem[nItem][IT_ALIQCF2] := aNFitem[nItem][IT_ALIQCF2] + aTes[TS_ALQCMAJ]
			EndIf
			
			IF lDc5602
				aNfitem[nItem][IT_ALIQCF2]:= 0
			EndIF
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³COFINS APURACAO - BASE - IT_BASECF2          ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If "BSE" $ cExecuta
				If !aTES[TS_PISCRED] $ "5" .AND. !aNfItem[nItem][IT_TIPONF]$"I"
					
					If ( nPautaSB1 == 0 .And. (Empty(aNFitem[nItem][IT_EXCECAO]) .Or. (!Empty(aNFitem[nItem][IT_EXCECAO]) .And. Empty(aNfItem[nItem][IT_EXCECAO][11])))) .Or.;
						(!Empty(aNFitem[nItem][IT_EXCECAO]) .And. Empty(aNfItem[nItem][IT_EXCECAO][11])) .Or.;
						aNfItem[nItem,IT_QUANT]==0 .Or. aParSX6[MV_COFPAUT]
						
						If ( nPautaSB1 == 0 .And. (Empty(aNFitem[nItem][IT_EXCECAO]) .Or. (!Empty(aNFitem[nItem][IT_EXCECAO]) .And. Empty(aNfItem[nItem][IT_EXCECAO][11])))) .Or.;
							(!Empty(aNFitem[nItem][IT_EXCECAO]) .And. Empty(aNfItem[nItem][IT_EXCECAO][11]) .And. nPautaSB1 == 0) .Or.;
							aNfItem[nItem,IT_QUANT]==0
							nBaseCF2 := aNfItem[nItem][IT_VALMERC]-IIf(aTes[TS_AGREG]$"DR",aNfItem[nItem][IT_DEDICM],0)
							
							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//³Tratamento do Agrega Valor - PIS / COF / ICMS ³
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							nAliqAgr := 0
							If aTes[TS_AGREG]=="I"
								If aTes[TS_ICM] == "N"
									nAliqAgr += aNfItem[nItem][IT_ALIQSOL]
									lAgreg	 := .T.
								Else
									nAliqAgr += aNfItem[nItem][IT_ALIQICM]
									lAgreg	 := .T.
								EndIf
							EndIf
							
							If aTes[TS_AGRCOF]=="C"
								nAliqAgr += aNfItem[nItem][IT_ALIQCF2]
								lAgreg	 := .T.
								If aTes[TS_AGRPIS]=="P"
									nAliqAgr += aNfItem[nItem][IT_ALIQPS2]
								Endif
							Endif
							
							If lAgreg
								nBaseCF2 := Round(nBaseCF2 / ( 1 - (nAliqAgr/100)) , 2 )
							Endif
							
							If aTes[TS_AGREG] == "I" .And. !lAgreg
								nBaseCF2 += If(aNFitem[nItem][IT_TIPONF ]<>"I",aNfItem[nItem][IT_VALICM],0)
							EndIf
							
							nBaseCF2 := ( nBaseCF2 - IIf( aTes[TS_COFBRUT] == "1" , 0 , (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT]) ) + aNfItem[nItem][IT_DESCZFCOF] + aNfItem[nItem][IT_DESCZFPIS] + IIf(aNfItem[nItem][IT_DESCZFCOF]<>0,0,IIF(aTes[TS_CRPRST]<>0 .And. IntTms(),aNfItem[nitem][IT_VLCSOL],aNfItem[nitem][IT_VALSOL])) )
							
							If ( !(aNfCab[NF_CLIFOR]=="C" .And. aNfCab[NF_CALCSUF]$"SI" .And. !aNFitem[nItem][IT_TIPONF ]$"BD" .And. ;
								aTes[TS_ISS] <> "S" .And. aParSX6[MV_DESCZF] .And. aParSX6[MV_DESZFPC] ) .And. aParSX6[MV_FRTBASE] ) .Or. aParSX6[MV_FRTBASE]
								nBaseCF2 += IIf(aTes[TS_DESPCOF] <> "2",aNfItem[nItem][IT_DESPESA],0) + IIF(aTes[TS_DESPCOF] <> "2",aNfItem[nItem][IT_SEGURO],0) + IIF(aTes[TS_DESPCOF] <> "2",aNfItem[nItem][IT_FRETE],0)
							EndIf
							
							If aNFitem[nItem][IT_TIPONF ] == "P"
								nBaseCF2 := 0
							EndIf
							
							If aTes[TS_CREDICM] == "S" .And. aParSX6[MV_DEDBCOF]$"S,I"	// Caso seja comerciante atacadista, o valor do IPI deve ser retirado da base de calculo do COFINS pois esta embutido no valor da mercadoria
								nBaseCF2 -= aNfItem[nItem][IT_VALICM]
							EndIf
	
							If aTes[TS_CREDIPI] == "N" .And. aParSX6[MV_DEDBCOF]$"S,P" .AND. aTes[TS_IPI] <> "R"
								nBaseCF2 += aNfItem[nItem][IT_VALIPI]
							EndIf
							If aTes[TS_CREDIPI] $ "S" .And. aParSX6[MV_DEDBCOF]$"S,P" .And. aTes[TS_IPI] == "R"
								nBaseCF2 -= aNfItem[nItem][IT_VALIPI]
							EndIf
							
							If aParSX6[MV_CRDBCOF] $ "S" .And. Substr(aNfItem[nItem][IT_CF],1,1)=="3"
								nBaseCF2 += aNfItem[nItem][IT_VALICM]
							EndIf
							
							If aNFitem[nItem][IT_TIPONF ] == "P" .And. nBaseCF2 < 0
								nBaseCF2 := 0
							EndIf
							
							If aTes[TS_COFDSZF] == "2"
								nBaseCF2 += aNfItem[nItem][IT_DESCZF] - (aNfItem[nItem][IT_DESCZFCOF] + aNfItem[nItem][IT_DESCZFPIS])
							Endif
							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//³ Indica o tratamento para retirada do valor do ICMS solidario na base do PIS apurado    ³
							//³ 1 - Nunca retira                                                                       ³
							//³ 2 - Retira se houver credito do ICMS ST                                                ³
							//³ 3 - Retira se nao houver credito do ICMS ST                                            ³
							//³ 4 - Retira se houver credito do ICMS normal                                            ³
							//³ 5 - Retira se nao houver credito do ICMS normal                                        ³
							//³ 6 - Sempre retira                                                                      ³
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							If (aParSX6[MV_DBSTCOF] == "6" .Or. (aParSX6[MV_RPCBIZF] .And. aNfCab[NF_SUFRAMA]) .Or.;
								( aTes[TS_CREDST]  == "1" .And. aParSX6[MV_DBSTCOF] == "2" ) .Or. ;
								( aTes[TS_CREDST]  == "2" .And. aParSX6[MV_DBSTCOF] == "3" ) .Or. ;
								( aTes[TS_CREDICM] == "S" .And. aParSX6[MV_DBSTCOF] == "4" ) .Or. ;
								( aTes[TS_CREDICM] == "N" .And. aParSX6[MV_DBSTCOF] == "5" ) ) .And. aNfItem[nItem][IT_DESCZFCOF] == 0
								nBaseCF2 -= IIF(aTes[TS_CRPRST]<>0 .And. IntTms(),aNfItem[nitem][IT_VLCSOL],aNfItem[nitem][IT_VALSOL])
							Endif
						Else
							nBaseCF2 := IIF(lSegUndPau,ConvUm(aNfItem[nItem][IT_PRODUTO],aNfItem[nItem][IT_QUANT],0,2),aNfItem[nItem,IT_QUANT])
						EndIf
						
						nBaseCF2 *= nFatRedCOF
						aNfItem[nItem][IT_BASECF2] := nBaseCF2
						
						If aTes[TS_OPERSUC] == "1" // Operacoes com Sucata
							nBaseCF2 := (aNFitem[nItem][IT_VALICM] / ( (100-(aNFitem[nItem][IT_ALIQICM]+aNFitem[nItem][IT_ALIQPS2]+aNFitem[nItem][IT_ALIQCF2]))/100 ) )
							aNfItem[nItem][IT_BASECF2] := nBaseCF2
						Endif
					Else
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³Calculo da BASE COFINS APURACAO pela PAUTA do SB1 ou EXCECAO³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						If (Empty(aNFitem[nItem,IT_EXCECAO]) .Or. Empty(aNFItem[nItem,IT_EXCECAO,11]))
							nBaseCF2 := IIF(lSegUndPau,ConvUm(aNfItem[nItem][IT_PRODUTO],aNfItem[nItem][IT_QUANT],0,2),aNfItem[nItem,IT_QUANT]) * nPautaSB1
							aNfItem[nItem][IT_PAUTCOF]	:= nPautaSB1
						Else
							nBaseCF2 := aNfItem[nItem,IT_QUANT] * aNFItem[nItem,IT_EXCECAO,11]
							aNfItem[nItem][IT_PAUTCOF]	:= aNFItem[nItem,IT_EXCECAO,11]
						EndIf
						aNfItem[nItem][IT_BASECF2] := nBaseCF2
					EndIf
					
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³Zera a BASE do COFINS APURACAO somente quando a aliquota for = 0 e o CSTCOF  NAO for = "04#06#73"³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					If Empty( aNfItem[nItem][IT_ALIQCF2] ) .And. ((aExistPE[PE_MACSTPICO] .And. !ExecBlock("MaCstPiCo",.F.,.F.,{nItem,aNfItem[nItem][IT_PRODUTO],aNfItem[nItem][IT_TES],aNfCab[NF_CLIFOR],aNfCab[NF_CODCLIFOR],aNfCab[NF_LOJA],aNfCab[NF_OPERNF]})[2]$"04#06#73") .Or. (!aExistPE[PE_MACSTPICO] .And. !aTES[TS_CSTCOF] $"04#06#73")) .AND. !lDc5602
						aNfItem[nItem][IT_BASECF2] := 0
					EndIf
					
				Else
					aNfItem[nItem][IT_BASECF2] := 0
				EndIf
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³Especifico para VEICULOS³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If aParSX6[MV_CALCVEI] .And. "CF2" $ cTipo .And. aNfCab[NF_OPERNF] == "S" .And. aFieldPos[FP_B1_CHASSI] .And. !Empty( aNfItem[nItem][IT_PRD][SB_CHASSI] ) // Alteracao de base para veiculos usados
					If aNfItem[nItem][IT_BASVEIC] == 0
						aAreaSC6 := SC6->(GetArea())
						SC6->(dbSetOrder(1))
						If SC6->( MsSeek(xFilial("SC6")+aNfCab[NF_PEDIDO]+aNfItem[nItem][IT_ITEM]+aNfItem[nItem][IT_PRODUTO]) )
							aNfItem[nItem][IT_BASVEIC] := SC6->C6_BASVEIC
						EndIf
						RestArea(aAreaSC6)
					EndIf
					aNfItem[nItem][IT_BASECF2] -= aNfItem[nItem][IT_BASVEIC]
					If aNfItem[nItem][IT_BASECF2] < 0
						aNfItem[nItem][IT_BASECF2] := 0
					EndIF
				EndIf
				
			EndIf
			
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Define o Valor do COFINS MAJORADO conforme aliquota informada na TES. ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If aTes[TS_ALQCMAJ] > 0
				aNfItem[nItem][IT_VALCMAJ] := aNfItem[nItem][IT_BASECF2] * (aTes[TS_ALQCMAJ]/100)
			EndIf
			
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³COFINS APURACAO - VALOR - IT_VALCF2          ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If "VLR" $ cExecuta
				If (nPautaSB1 == 0 .And. (Empty(aNFitem[nItem][IT_EXCECAO]) .Or. (!Empty(aNFitem[nItem][IT_EXCECAO]) .And. Empty(aNfItem[nItem][IT_EXCECAO][11])))) .Or.;
					aNfItem[nItem,IT_QUANT]==0 .Or. !aParSX6[MV_PISPAUT]
					
					aNfItem[nItem][IT_VALCF2] := aNfItem[nItem][IT_BASECF2]*aNfItem[nItem][IT_ALIQCF2]/100
					
				Else
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³COFINS APURACAO - Aplica PAUTA SB1 ou Excecao³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					If aNfItem[nItem][IT_BASECF2] <> 0
						If Empty(aNFitem[nItem,IT_EXCECAO]) .Or. Empty(aNFItem[nItem,IT_EXCECAO,11])
							aNfItem[nItem][IT_VALCF2]  := IIF(lSegUndPau,ConvUm(aNfItem[nItem][IT_PRODUTO],aNfItem[nItem][IT_QUANT],0,2),aNfItem[nItem,IT_QUANT]) * nPautaSB1
							aNfItem[nItem][IT_PAUTCOF] := nPautaSB1
						Else
							aNfItem[nItem][IT_VALCF2]  := aNfItem[nItem,IT_QUANT] * aNFItem[nItem,IT_EXCECAO,11]
							aNfItem[nItem][IT_PAUTCOF] := aNFItem[nItem,IT_EXCECAO,11]
						EndIf
					EndIf
				EndIf
			
				If aTes[TS_AGRCOF]=="C"
					aNfItem[nItem][IT_VALCF2] := Round(aNfItem[nItem][IT_VALCF2],2)
				EndIf
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³DESCONTO SUFRAMA - COFINS APURACAO ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If aNfCab[NF_CLIFOR]=="C" .And. !aNfCab[NF_CALCSUF]$"IN " .And. !aNFitem[nItem][IT_TIPONF ]$"BD" .And. ;
					aTes[TS_ISS] <> "S" .And. aParSX6[MV_DESCZF] .And. aParSX6[MV_DESZFPC] .And. ( aTES[TS_PISCRED]$"134" )
					
					If ( aExistPE[PE_MACSTPICO] .And. ExecBlock("MaCstPiCo",.f.,.f.,{nItem,aNfItem[nItem][IT_PRODUTO],aNfItem[nItem][IT_TES],aNfCab[NF_CLIFOR],aNfCab[NF_CODCLIFOR],aNfCab[NF_LOJA],aNfCab[NF_OPERNF]})[2]$"04#06#73") .Or. ( !aExistPE[PE_MACSTPICO] .And. aTES[TS_CSTCOF] $"04#06#73")
						If aNfItem[nItem][IT_PAUTCOF] == 0
							If aNfItem[nItem][IT_DESCZFCOF] == 0
								aNfItem[nItem][IT_VALCF2]:= aNfItem[nItem][IT_BASECF2] *  nAliqBase  / 100
							Else
								aNfItem[nItem][IT_VALCF2]:= aNfItem[nItem][IT_DESCZFCOF]
							Endif
						Else
							aNfItem[nItem][IT_VALCF2] := aNfItem[nItem][IT_BASECF2]
						EndIf
					Endif
					
					MaItArred(nItem,{"IT_DESCZFCOF"})
					aNfItem[nItem][IT_DESCZF] -= aNfItem[nItem][IT_DESCZFCOF]
					
					If aNfCab[NF_ROTINA] == "MATA461" .Or. FunName()=="MATA920"
						MaItArred(nItem,{"IT_VALCF2"})
						aNfItem[nItem][IT_VALMERC]+= aNfItem[nItem][IT_DESCZFCOF]
						aNfItem[nItem][IT_VALMERC]-= aNfItem[nItem][IT_VALCF2]
						If ( aNfCab[NF_TIPONF] $"CPI") .And. FunName()=="MATA920"
							aNfItem[nItem][IT_PRCUNI] := (aNfItem[nItem][IT_VALMERC]-(aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT]) ) + aNfItem[nItem][IT_ACRESCI] 
						Else
							aNfItem[nItem][IT_PRCUNI] := (aNfItem[nItem][IT_VALMERC]- (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT]) + aNfItem[nItem][IT_ACRESCI] )/aNfItem[nItem][IT_QUANT]
						EndIf
					EndIf
					aNfItem[nItem][IT_DESCZFCOF]:= aNfItem[nItem][IT_VALCF2]
					MaItArred(nItem,{"IT_DESCZFCOF"})
					aNfItem[nItem][IT_DESCZF]   += aNfItem[nItem][IT_DESCZFCOF]
					aNfItem[nItem][IT_VALCF2]   := 0
					If aTES[TS_PSCFST] == "1" .And. !aTES[TS_CSTCOF] $"04#06#73"
						aNfItem[nItem][IT_BASECF2]  := 0
					EndIf
				EndIf
				
				MaItArred(nItem,{"IT_VALCF2"})
			Endif
			If "CF2" $ cTipo
				If aExistPE[PE_MACOFVEIC] // ATENCAO!!! Ponto de entrada para uso exclusivo da TOTVS, nao sugerir o uso do mesmo a clientes - GDP FISCAL
					aMaCOFVeic := ExecBlock("MaCOFVeic",.F.,.F.,{nItem,aNfItem[nItem][IT_BASECF2],aNfItem[nItem][IT_ALIQCF2],aNfItem[nItem][IT_VALCF2]})
					aNfItem[nItem][IT_BASECF2] := aMaCOFVeic[1]
					aNfItem[nItem][IT_ALIQCF2] := aMaCOFVeic[2]
					aNfItem[nItem][IT_VALCF2]  := aMaCOFVeic[3]
				EndIf
			Endif
		Else
			If "BSE" $ cExecuta
				aNfItem[nItem][IT_BASECF2]:= 0
			EndIf
			If "VLR" $ cExecuta
				aNfItem[nItem][IT_VALCF2] := 0
			EndIf
		EndIf	
	EndIf
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³COFINS RETENCAO - IT_BASECOF / IT_ALIQCOF / IT_VALCOF ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If "COF" $ cTipo
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Define a Aliquota do COFINS RETENCAO - IT_ALIQCOF³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If "ALQ" $ cExecuta 
		If Empty(nAliqSB1) .Or. aParSX6[MV_TPALCOF] == "1"
			If !Empty(aNfCab[NF_NATUREZA]) .And. aInfNat[NT_CALCCOF] == "S" .And. !Empty(aInfNat[NT_PERCCOF])
				
				nAliqCOF :=  aInfNat[NT_PERCCOF]
				
				If nModulo == 43 .And. SA1->A1_TPESSOA == "EP" // Para o Tipo de Cliente 'Empresa Publica',quando transporte for Internacional,nao gerar a retencao de PIS/COFINS -- BOPS 153148
					aAreaSA1 := SA1->(GetArea())
					SA1->(dbSetOrder(1))
					If SA1->(msSeek(xFilial("SA1")+SF2->F2_CLIENT+SF2->F2_LOJENT)) .And. SA1->A1_EST == "EX"
						nAliqCOF := 0
					EndIf
					RestArea(aAreaSA1)
				EndIf
				
			EndIf
			
			If aExistPE[PE_MACALCCOF]
				If aMaCalcCOF[1] == "S" .And. !Empty(aMaCalcCOF[2])
					nAliqCOF := aMaCalcCOF[2]
				EndIf
			EndIf
			
		EndIf
		
		aNfItem[nItem][IT_ALIQCOF]	:= nAliqCOF
	Endif	
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Calculo de BASE e VALOR do COFINS RETENCAO - IT_BASECOF e IT_VALCOF ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If "BSE" $ cExecuta .Or. "VLR" $ cExecuta
		If ( aExistPE[PE_MACALCCOF] .And. aMaCalcCOF[1]=="S" ) .Or. ( !Empty(aNfCab[NF_NATUREZA]) .And. aInfNat[NT_CALCCOF]=="S" ;
			.And. aNfCab[NF_RECCOFI] $ "S|P" .And. ( aNfItem[nItem][IT_PRD][SB_COFINS] == "1" .Or. aNfCab[NF_RECCOFI] == "P" ) )
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ A base de calculo da retencao eh o valor da duplicata       ³
			//³ porem de acordo com a Cons. Trib. Liz, o valor do ISS nao   ³
			//³ devera ser deduzido da base do PIS/COF/CSL retencao. Para   ³
			//³ isso foi criado o parametro MV_DEISSBS que se estiver como  ³
			//³ .T. nao sera descontado e se estiver como .F. - default sera³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			nDescISS := Iif( aParSX6[MV_DEISSBS] .And. aNfCab[NF_RECISS]=="1" .And. aParSX6[MV_DESCISS] .And. aNfCab[NF_OPERNF]=="S" .And. aParSX6[MV_TPABISS]=="1",aNfItem[nItem][IT_VALISS],0)
			nBaseCOF := aNfItem[nItem,IT_BASEDUP] + IIf( aParSX6[MV_COFBRU] == "1" , (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT]) , 0 ) + nDescISS
			nBaseCOF *= nFatRedCOF
			//Tratamento extraido da funcao MaFisVTot para saber se foi contemplado o VALOR DE IPI na base da duplicata para que eu possa subtrair
			If (aTes[TS_IPIPC]=="2") .And. (aNFitem[nItem][IT_TIPONF]=="P" .Or. aTes[TS_IPI]<>'R')
				nBaseCOF -= aNfItem[nItem][IT_VALIPI]
			EndIf
			If aParSX6[MV_CRDBCOF] $ "S" .And. Substr(aNfItem[nItem][IT_CF],1,1)=="3"
				nBaseCOF += aNfItem[nItem][IT_VALICM]
			EndIf
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Indica o tratamento para retirada do valor do ICMS solidario na base do COFINS retencao³
			//³ 1 - Nunca retira                                                                       ³
			//³ 2 - Retira se houver credito do ICMS ST                                                ³
			//³ 3 - Retira se nao houver credito do ICMS ST                                            ³
			//³ 4 - Retira se houver credito do ICMS normal                                            ³
			//³ 5 - Retira se nao houver credito do ICMS normal                                        ³
			//³ 6 - Sempre retira                                                                      ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If (aParSX6[MV_DBSTCFR] == "6" .Or.;
				( aTes[TS_CREDST]  == "1" .And. aParSX6[MV_DBSTCFR] == "2" ) .Or. ;
				( aTes[TS_CREDST]  == "2" .And. aParSX6[MV_DBSTCFR] == "3" ) .Or. ;
				( aTes[TS_CREDICM] == "S" .And. aParSX6[MV_DBSTCFR] == "4" ) .Or. ;
				( aTes[TS_CREDICM] == "N" .And. aParSX6[MV_DBSTCFR] == "5" ) ) .And. aNfItem[nItem][IT_DESCZFCOF] == 0
				nBaseCOF -= aNfItem[nitem][IT_VALSOL]
			Endif
			
			If "BSE" $ cExecuta 
				aNfItem[nItem][IT_BASECOF]:= nBaseCOF
			Endif
			If  "VLR" $ cExecuta
		   		aNfItem[nItem][IT_VALCOF] := aNfItem[nItem][IT_BASECOF] * aNfItem[nItem][IT_ALIQCOF] / 100
			Endif
			If aNfItem[nItem][IT_PRD][SB_RETOPER] == "1" .And. !aNfCab[NF_RECCOFI] == "N" //Item classificado na Medida Provisoria 252 Junho/2005 e nao aguardar o limite imposto pela Lei 10.925 (R$ 5.000,00) autopecas
				aNfItem[nItem][IT_COF252] := aNfItem[nItem][IT_VALCOF]
			Endif
			
		Else
			If "BSE" $ cExecuta
				aNfItem[nItem][IT_BASECOF]:= 0
            EndIf
            If "VLR" $ cExecuta
				aNfItem[nItem][IT_VALCOF] := 0
            EndIf
		EndIf
	EndIf
	MaItArred(nItem,{"IT_VALCOF"})
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Calcula COFINS-ST   Base  Aliquota e Valor - IT_BASECF3 - IT_ALIQCF3 - IT_VALCF3       ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If "CF3" $ cTipo
	If aTES[TS_PSCFST] $ "1/3"
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Conforme IN SRF 594 de 2005, nao devem integrar a base de calculo do PIS/COFINS ST:³
		//³- Receitas isentas e as decorrentes de vendas a aliquota 0                         ³
		//³- Vendas canceladas                                                                ³
		//³- Descontos incondicionais                                                         ³
		//³- IPI                                                                              ³
		//³- ICMS ST                                                                          ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If aTes[TS_IPIPC] == "2" //Somente retiro aqui o valor do PS3 e CF3 caso o campo IPIPC estiver como 2, pois se estiver como 1 já estou retirando os valores no momento de compor o IT_TOTAL
			nBaseCF3 := aNfItem[nItem][IT_TOTAL] - ((aNfItem[nItem][IT_VALPS3]) + aNfItem[nItem][IT_VALCF3])
			nBaseCF3 -= aNfItem[nItem][IT_VALIPI] //Conforme IN SRF546/2005 o valor do IPI deve integrar a base calculo PIS/COFINS ST-Zona Franca de Manaus
			
			If !(aTes[TS_INCSOL]$"A,N,D") // Verifica se o valor do ICMS Solidario esta agregado ao valor total
				nBaseCF3 -= aNfItem[nItem][IT_VALSOL]
			Endif
			
		Else
			nBaseCF3 := aNfItem[nItem][IT_VALMERC] + aNfItem[nItem][IT_VALIPI]
		Endif
		
		If aNFCab[NF_CLIFOR] == "C" .And. aNFCab[NF_TIPONF] $ "DB" .And. !aNfItem[nItem][IT_TIPONF]$"I|P" .And. aParSX6[MV_DESCZF] .And. aParSX6[MV_DESZFPC]
			If aTES[TS_PISCRED] <> "3" .And. aTES[TS_PISCOF]$"13" .And. !aNfCab[NF_CALCSUF]$"IN "
				nBaseCF3 -= (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT])
			ElseIf aTES[TS_PISCRED] == "3" .And. aTES[TS_PISCOF]$"4" .And. aNfCab[NF_CALCSUF]$"I"
				nBaseCF3 -= (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT])
			EndIf
		EndIf
		
		If aTes[TS_COFDSZF] == "2"
			nBaseCF3 += aNfItem[nItem][IT_DESCZF]
		EndIf
		
		nBaseCF3 *= nFatRedCOF
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Se usuario informou percentual de Substituicao Tributaria de cigarro, ira multiplicar a base de calculo pelo percentual³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If Len(Alltrim(aParSX6[MV_PUPCCST])) > 0 .And. aFieldPos[FP_B1_PUPCCST]
			nVlUnitCig := aNfItem[nItem][IT_PRD][SB_PUPCCST] // Campo onde e informado o valor unitario para calcular valor de PIS ST.
		EndIF
		
		If !Empty(aNFitem[nItem][IT_EXCECAO])
			If aNfItem[nItem,IT_EXCECAO,25] > 0
				nVlUnitCig	:= aNfItem[nItem,IT_EXCECAO,25]
				aNfItem[nItem][IT_PRCUNIC] := nVlUnitCig
			Endif
		Endif
		
		If Len(AllTrim(aParSX6[MV_B1CCFST])) > 0 .And. aFieldPos[FP_B1_B1CCFST]
			aNfItem[nItem][IT_COECFST] := aNfItem[nItem][IT_PRD][SB_B1CCFST] // Campo onde e informado o % de Substituição tributaria da COFINS para fabrincante de cigarros.
		EndIf
		
		If nVlUnitCig > 0
			If aNfItem[nItem][IT_COECFST] > 0
				nBaseCF3 := ( aNfItem[nItem][IT_QUANT] * nVlUnitCig ) * aNfItem[nItem][IT_COECFST]
			Else
				nBaseCF3 := aNfItem[nItem][IT_QUANT] * nVlUnitCig
			EndIf
		EndIF
		
		If aNFCab[NF_TIPONF]$"D" .And. !Empty(aNFItem[nItem][IT_RECORI]) .And. aNFCab[NF_CLIFOR] == "C"
			SD2->( MsGoto( aNFItem[nItem][IT_RECORI] ) )
			nBaseCF3 := aNfItem[nItem][IT_QUANT] * SD2->D2_BASECF3 / SD2->D2_QUANT
		EndIF
		If "BSE" $ cExecuta
			aNfItem[nItem][IT_BASECF3] := nBaseCF3
		Endif
		If "ALQ" $ cExecuta
			aNfItem[nItem][IT_ALIQCF3] := Iif( aTES[TS_PSCFST] == "3", 0,nAliqCF3) 
		Endif
		If "VLR" $ cExecuta
			aNfItem[nItem][IT_VALCF3]  := aNfItem[nItem][IT_BASECF3]*aNfItem[nItem][IT_ALIQCF3]/100  
		Endif	
	Else
		If "BSE" $ cExecuta
			aNfItem[nItem][IT_BASECF3] := 0
		EndIf
		If "ALQ" $ cExecuta
			aNfItem[nItem][IT_ALIQCF3] := 0
		EndIf
		If "VLR" $ cExecuta
			aNfItem[nItem][IT_VALCF3]  := 0
		EndIf
	EndIf
	MaItArred(nItem,{"IT_VALCF3"})
EndIf

If aParSX6[MV_PCFATPC] .And. aNfCab[NF_OPERNF] == "S" .And. !Empty(aNfCab[NF_CLIEFAT])
	aNFitem[nItem][IT_EXCECAO] 	:= aExcecao
	aNfCab[NF_NATUREZA] 		:= cNatureza
EndIf

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisCSLL ³ Autor ³Alexandre Lemes        ³ Data ³01/10/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Calculo do CSLL                                             ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisCSLL(nItem,cExecuta)

Local aMaCalcCSL := IIf( aExistPE[PE_MACALCCSL] , ExecBlock("MaCalcCSL") , Array(2) )
Local nAliqSB1   := aNfItem[nItem][IT_PRD][SB_PCSLL]
Local nAliquota  := IIf(Empty(nAliqSB1),aParSX6[MV_TXCSLL],nAliqSB1)
Local nDesconto  := 0
Local nDescISS	 := 0

DEFAULT cExecuta  := "BSE|ALQ|VLR"
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Define Base CSLL³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If "BSE" $ cExecuta
	If (( aExistPE[PE_MACALCCSL] .And. aMaCalcCSL[1]=="S" ) .Or. ( !Empty(aNfCab[NF_NATUREZA]) .And. aInfNat[NT_CALCCSL]=="S" )) .And.;
		( aNfCab[NF_RECCSLL] $ "S|P" ) .And. ( aNfItem[nItem][IT_PRD][SB_CSLL] == " " .Or. aNfItem[nItem][IT_PRD][SB_CSLL] == "1" .Or. aNfCab[NF_RECCSLL] == "P" )
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ A base de calculo da retencao eh o valor da duplicata       ³
		//³ porem de acordo com a Cons. Trib. Liz, o valor do ISS nao   ³
		//³ devera ser deduzido da base do PIS/COF/CSL retencao. Para   ³
		//³ isso foi criado o parametro MV_DEISSBS que se estiver como  ³
		//³ .T. nao sera descontado e se estiver como .F. - default sera³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		nDescISS := IIf(aParSX6[MV_DEISSBS] .And. aNfCab[NF_RECISS]=="1" .And. aParSX6[MV_DESCISS] .And. aNfCab[NF_OPERNF]=="S" .And. aParSX6[MV_TPABISS]=="1", aNfItem[nItem][IT_VALISS] , 0 )
		nDesconto:= IIf(aParSX6[MV_CSLLBRU] == "1" , (aNfItem[nItem][IT_DESCONTO]+aNfItem[nItem][IT_DESCTOT]) , 0) // Caso o parametro indique a base de calculo pelo valor bruto da nota fiscal somar o valor do desconto concedido ao total da duplicata.                 ³
		
		aNfItem[nItem][IT_BASECSL] := aNfItem[nItem,IT_BASEDUP] + IIf( aNfItem[nItem,IT_BASEDUP] > 0 , nDesconto , 0 ) + nDescISS
		
		If aTes[TS_IPIPC]=="2" 	// Indica se o valor do IPI deve compor a base de calculo. 1=Sim (Compoe) e 2=Nao(Nao Compoe)
			aNfItem[nItem][IT_BASECSL] -= aNfItem[nItem][IT_VALIPI]
		Endif
		If !(aTes[TS_INCSOL]$"A,N,D") // Verifica se o valor do ICMS Solidario esta agregado ao valor total
			aNfItem[nItem][IT_BASECSL] -= aNfItem[nItem][IT_VALSOL]
		Endif
		If aTes[TS_DBSTCSL] == "1" .And. aNFCab[NF_OPIRRF] == "EP" // Agrega o Valor do ICMS Retido - Somente para Empresa Publica
			aNfItem[nItem][IT_BASECSL] += aNfItem[nItem][IT_VALSOL]
		Endif
		
	Else
		aNfItem[nItem][IT_BASECSL] := 0
	EndIf
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Define Aliquota CSLL³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If "ALQ" $ cExecuta
	If Empty(nAliqSB1) .Or. aParSX6[MV_TPALCSL]== "1"
		If !Empty(aNfCab[NF_NATUREZA]) .And. aInfNat[NT_CALCCSL]=="S" .And. !Empty(aInfNat[NT_PERCCSL])
			nAliquota :=  aInfNat[NT_PERCCSL]
		EndIf
		
		If aExistPE[PE_MACALCCSL]
			If aMaCalcCSL[1]=="S" .And. !Empty(aMaCalcCSL[2])
				nAliquota := aMaCalcCSL[2]
			EndIf
		EndIf
	EndIf
	aNfItem[nItem][IT_ALIQCSL]	:= nAliquota
EndIf
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Define Valor CSLL³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If "VLR" $ cExecuta
	If ( aExistPE[PE_MACALCCSL] .And. aMaCalcCSL[1] == "S" ) .Or. ( !Empty(aNfCab[NF_NATUREZA]) .And. aInfNat[NT_CALCCSL] == "S" )
		aNfItem[nItem][IT_VALCSL] := aNfItem[nItem][IT_BASECSL]*aNfItem[nItem][IT_ALIQCSL]/100
	Else
		aNfItem[nItem][IT_VALCSL] := 0
	EndIf
	
	MaItArred(nItem,{"IT_VALCSL"})
EndIf

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisII   ³ Autor ³ Cleber Stenio Santos  ³ Data ³23.03.2009³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Calcula PIS/COFINS Importação conforme fórmula IN SRF 572/05³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisII(nItem,cCampo)  
Local nBsICMFic := 0 //Base ICMS Ficticio para calculo do PIS/COFINS
Local nVlICMFic := 0 //ICMS Ficticio para calculo do PIS/COFINS
Local nIN572x   := 0 //Fórmula x para o cálculo da IN572 considerando IPI Percentual
Local nAliqII   := 0 //Aliquota Imposto Importacao
Local nAliqIPI  := 0 //Aliquota IPI
Local nAliqPIS  := 0 //Aliquota PIS
Local nAliqCOF  := 0 //Aliquota Cofins
Local nAliqICM  := 0 //Aliquota ICMS
Local nBsPISImp := 0 //Base PIS Importacao
Local nBsCOFImp := 0 //Base COFINS Importacao
Local nVlPISImp := 0 //Valor PIS Importacao                               	
Local nVlCOFImp := 0 //Valor COFINS Importacao
Local nVlAduan  := 0 //Valor Aduaneiro
Local nIN572y   := 0 //Fórmula y para o cálculo da IN572 considerando IPI Pauta
Local nIN572w   := 0 //Fórmula w para o cálculo da IN572 considerando IPI Pauta
Local nIN572s   := 0 // Formula de Calculo de Importação de servico
Local nAliqICMNF:= 0 //Aliquota original do ICMS da NF
Local cImpServ	:= "N"
Local nValMaj   := 0
Local nDifVal   := 0

DEFAULT cCampo := ""

If aNFCab[NF_OPERNF] == "E" .And. aNFCab[NF_CLIFOR] =="F" .And. aNFCab[NF_TPCLIFOR] =="X" .And. Substr(aNfItem[nItem][IT_CF],1,1)=="3" .And. aTes[TS_INTBSIC]$"123"
 IF !Empty(aNfItem[nItem][IT_CODISS]) .And. (aTes[TS_ICM]=="N") .And. (aTes[TS_LFICM] == "N") .And. (aTes[TS_IPI]=="N") .And. (aTes[TS_LFIPI]=="N")  .And. (aTes[TS_ISS] == "S")
	cImpServ := "S"
 EndIf 
	
	nAliqII   := aNfItem[nItem][IT_ALIQII]/100
	nAliqIPI  := aNFitem[nItem][IT_ALIQIPI]/100
	
	If aTes[TS_PISCOF] == "1"
		nAliqPIS  := aNFitem[nItem][IT_ALIQPS2]/100
	ElseIf aTes[TS_PISCOF] == "2"
		nAliqCOF  := aNFitem[nItem][IT_ALIQCF2]/100
	ElseIf aTes[TS_PISCOF] == "3"
		nAliqPIS  := aNFitem[nItem][IT_ALIQPS2]/100
		nAliqCOF  := aNFitem[nItem][IT_ALIQCF2]/100
	EndIf
	
	nAliqICMNF	:= aNFitem[nItem][IT_ALIQICM]/100 							//Salvo para usar no recalculo do ICMS
	nVlAduan	:= aNfItem[nItem][IT_VALMERC] - aNfItem[nItem][IT_VALII] 	//Valor da Mercadoria - Valor do II
	nVlAduan	+= Iif(aTes[TS_DESPPIS] <> "2" .And. aTes[TS_DESPCOF] <> "2", aNfItem[nItem][IT_DESPESA]+aNfItem[nItem][IT_SEGURO]+aNfItem[nItem][IT_FRETE], 0 )
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Se Reducao na base de ICMS (aTES[TS_BASEICM]>0)                            ³
	//³Aliquota ICMS * Aliquota de reducao TES                                    ³
	//³Aplicar a redução na aliquota e calcular PIS/COFINS com a aliquota reduzida³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	nAliqICM := IIf( aTES[TS_BASEICM] > 0 , ((aNFitem[nItem][IT_ALIQICM] * aTES[TS_BASEICM]) / 100) / 100 , aNFitem[nItem][IT_ALIQICM] / 100 )
	
	If !Empty(aNFItem[nItem][IT_EXCECAO]) .And. aNFItem[nItem][IT_EXCECAO][14] > 0
		nAliqICM := ((aNFitem[nItem][IT_ALIQICM] * aNfItem[nItem,IT_EXCECAO,14]) / 100) / 100 //Reducao na base de ICMS
	EndIf
	
	//Se não tiver IPI Pauta mas tiver Valor IPI calculado faço o cálculo considerando IPI Percentual
	If Empty(aNfItem[nItem][IT_PAUTIPI]) .And. !Empty(aNfItem[nItem][IT_VALIPI])
		//Fórmula x para o cálculo da IN572 considerando IPI Percentual
		
		nIN572x :=(1+nAliqICM * (nAliqII+nAliqIPI * (1+nAliqII))) / ((1-nAliqPIS-nAliqCOF)*(1-nAliqICM)) //Não é mais utilizado no cálculo de PIS/Cofins Importaçção, conforme a lei 12.865 de 09/10/2013.  
		
		//Se tiver valor da COFINS já calculado conforme as regras já existentes para a COFINS e
		//Tiver que calcular COFINS Importação eu cálculo considerando o valor da COFINS
		If !Empty(aNfItem[nItem][IT_VALCF2]) .And. aTes[TS_INTBSIC]$"23"
			//Valor do COFINS Importação
			nVlCOFImp:= nAliqCOF * (nVlAduan)
		EndIf
		//Se tiver valor do PIS já calculado conforme as regras já existentes para o PIS e
		//Tiver que calcular PIS Importação eu cálculo considerando o valor de PIS
		If !Empty(aNfItem[nItem][IT_VALPS2]) .And. aTes[TS_INTBSIC]$"13"
			//Valor do PIS Importação
			nVlPISImp:= nAliqPIS * (nVlAduan)
		EndIf
	Else //Se houver IPI Pauta ou Não tiver IPI faço o cálculo considerando IPI Pauta
		//Fórmula y para o cálculo da IN572 considerando IPI Pauta
		nIN572y :=(1+nAliqICM * nAliqII)/((1-nAliqPIS-nAliqCOF)*(1-nAliqICM)) //Não é mais utilizado no cálculo de PIS/Cofins Importaçção, conforme a lei 12.865 de 09/10/2013.
		//Fórmula w para o cálculo da IN572 considerando IPI Pauta
		nIN572w :=(nAliqICM * aNfItem[nItem][IT_PAUTIPI]) / ((1-nAliqPIS-nAliqCOF)*(1-nAliqICM)) //Não é mais utilizado no cálculo de PIS/Cofins Importaçção, conforme a lei 12.865 de 09/10/2013.
		//Se tiver valor da COFINS já calculado conforme as regras já existentes para a COFINS e
		//Tiver que calcular COFINS Importação eu cálculo considerando o valor da COFINS
		If !Empty(aNfItem[nItem][IT_VALCF2]) .And. aTes[TS_INTBSIC]$"23"
			//Valor do COFINS Importação
			nVlCOFImp:= nAliqCOF * (nVlAduan*aNfItem[nItem][IT_QUANT])
		EndIf
		//Se tiver valor do PIS já calculado conforme as regras já existentes para o PIS e
		//Tiver que calcular PIS Importação eu cálculo considerando o valor de PIS
		If !Empty(aNfItem[nItem][IT_VALPS2]) .And. aTes[TS_INTBSIC]$"13"
			//Valor do PIS Importação
			nVlPISImp:= nAliqPIS * (nVlAduan*aNfItem[nItem][IT_QUANT])
		EndIf
	EndIf
	
	//Base de cálculo ICMS Fictício = (Valor Aduaneiro+imposto importação+IPI)/(1-%ICMS)
	nBsICMFic:= ((nVlAduan+aNfItem[nItem][IT_VALII]) + aNfItem[nItem][IT_VALIPI])/(1-nAliqICM) 
	//Valor do ICMS Fictício = Base de cálculo do ICMS * %ICMS
	nVlICMFic:= nBsICMFic * nAliqICM
	
	 If cImpServ == "N"	
		//Conforme a lei 12.865 de 09/10/2013, a base de Calculo de PIS/Cofins será comporta apenas no Valor Aduaneiro
		//Base de Cálculo COFINS Importação
		nBsCOFImp := nVlAduan  
		//Base de Cálculo COFINS Importação
		nBsPISImp := nVlAduan 
	 Else
	 	/* Formula para calculo de Pis Cofins Importaçãp de Serviço      
        V = o valor pago, creditado, entregue, empregado ou remetido para o exterior, antes da retenção do imposto de renda
		C = alíquota da Contribuição para o Pis/Pasep-Importação
		D = alíquota da Cofins-Importação
		F = alíquota do Imposto sobre Serviços de qualquer Natureza

        Cofins Importação = D*V*Z
		Pis Importação	  = C*V*Z

        Z = (1+F)/(1-C-D)
	    Base de Cálculo COFINS/PIS Importação Serviço */
	     
	    nIN572s :=(1+(aNfItem[nItem][IT_ALIQISS]/100))/((1-nAliqPIS-nAliqCOF))  
		nBsCOFImp := aNfItem[nItem][IT_VALISS] * nIN572s
	    nBsPISImp := aNfItem[nItem][IT_VALISS] * nIN572s 
	 EndIf 	
	
	//Atualiza Valores
	If !Empty(aNfItem[nItem][IT_VALCF2]) .And. aTes[TS_INTBSIC]$"23"
		aNfItem[nItem][IT_BASECF2] := nBsCOFImp
		
		//Nessa situacao, atualizo valor da contribuicao
		/* Se o campo do valor do COFINS majorado (IT_VALCMAJ) for alterado, obtenho o valor original 
		   do cálculo (nValMaj) e somo a diferença entre o valor digitado e o valor obtido (nDifVal) no
		   valor do COFINS importacao (nVlCOFImp) */ 
	       
		If AllTrim(cCampo) == "IT_VALCMAJ"
			nValMaj := (aNfItem[nItem][IT_BASECF2] * (aTes[TS_ALQCMAJ]/100))
			nDifVal := aNfItem[nItem][IT_VALCMAJ] - nValMaj 
			
			nVlCOFImp	:=	((nBsCOFImp * nAliqCOF) + nDifVal)
		Else
			nVlCOFImp	:=	nBsCOFImp * nAliqCOF
		Endif
		
		aNfItem[nItem][IT_VALCF2]  := nVlCOFImp
		MaItArred(nItem, { "IT_BASECF2","IT_VALCF2" } )   // Ajusta os arredondamentos do item
	EndIf
	
	If aTes[TS_ALQCMAJ] > 0 .And. cCampo <> "IT_VALCMAJ" 
		aNfItem[nItem][IT_VALCMAJ] := aNfItem[nItem][IT_BASECF2] * (aTes[TS_ALQCMAJ]/100)
	EndIf 
	
	If aTes[TS_ALQPMAJ] > 0 
		aNfItem[nItem][IT_VALPMAJ] := aNfItem[nItem][IT_BASEPS2] * (aTes[TS_ALQPMAJ]/100)
	EndIf 
	If !Empty(aNfItem[nItem][IT_VALPS2]) .And. aTes[TS_INTBSIC]$"13"
		aNfItem[nItem][IT_BASEPS2] := nBsPISImp
		
		//Nessa situacao, atualizo valor da contribuicao
		nVlPISImp	:=	nBsPISImp * nAliqPIS
		
		aNfItem[nItem][IT_VALPS2]  := nVlPISImp
		MaItArred(nItem, { "IT_BASEPS2","IT_VALPS2" } )   // Ajusta os arredondamentos do item
	EndIf
	
	MaFisBSICM(nItem,,,,cCampo)
	If aTes[TS_AGRPIS] == "P" .Or. aTes[TS_AGRPIS] == "C"
		aNfItem[nItem][IT_BASEICM]:= aNfItem[nItem][IT_BASEICM]/(1-nAliqICM)
	Else
		aNfItem[nItem][IT_BASEICM]:= aNfItem[nItem][IT_BASEICM]/(1-nAliqICMNF)
	Endif
	MaFisVICMS(nItem) //Recalcula o valor do ICMS
	//Necessário processar a base de ICMS ST e valor de ICMS ST para que seja calculado considerando os valores atualizados de ICMS 
	//e PIS COFINS împortação que foram calculados acima, pois o ICMS ST deverá considerar estes valores atualizados.
	MaFisBSSol(nItem, cCampo)
	MaFisVSol(nItem, cCampo)	
	
EndIf

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisRURAL³ Autor ³Alexandre Lemes        ³ Data ³04/10/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Executa o calculo do FUNRURAL.                              ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisRURAL(nItem,cExecuta)

Local aPFunRur  := {}             
Local npRural   := aParSX6[MV_CONTSOC]
Local nY 		:= Len(npRural)
Local nAliquota	:= 0
Local nNewAlqRur:= 0
Local nPosAlqFun:= 1
DEFAULT cExecuta := "BSE|ALQ|VLR|"

If aNfItem[nItem][IT_PRD][SB_CONTSOC] == "S" .And. aTes[TS_DUPLIC] == "S" .And. aTes[TS_CONTSOC]=="1" .And. aNfCab[NF_TPCLIFOR] <> "X"
	IF  "ALQ" $ cExecuta
	
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Define Aliquota FUNRURAL³
		//³                        ³
		//³aPFunRur[1]  == "F"     ³
		//³aPFunRur[2]  == "L"     ³
		//³aPFunRur[3]  == "J"     ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		Do While nY > 0
			nY:=AT("/",npRural)
			AADD(aPFunRur,IIf(nY > 0,Substr(npRural,1,nY-1),npRural))
			npRural:=Substr(npRural,nY+1,Len(npRural))
		EndDo
		//Retidado o "J" passado na função AT, pois de acordo com o que foi visto pela nossa consultora tributária, na entrada não
		// deve haver a retenção quando o fornecedor for pessoa jurídica
		If aNfCab[NF_CLIFOR] == "F"
			nAliquota := IIf( AT(SA2->A2_TIPORUR,"FL") > 0 , Val(aPFunRur[ AT(SA2->A2_TIPORUR,"FL") ]) , 0 )
		Else // Este ajuste e necessario pois este campo grava FLJ no MP10 e 123 no MP11 e ainda no MP11 a ordem de FJL e invertida ao prametro que le FLJ 
			If SM0->M0_PRODRUR $ "F|1"  
				nPosAlqFun := 1
			ElseIf SM0->M0_PRODRUR $ "L|3" 
				nPosAlqFun := 2
			ElseIf SM0->M0_PRODRUR $ "J|2" 
				nPosAlqFun := 3
            EndIf
			nAliquota := IIf( Val(SM0->M0_PRODRUR) > 0 , Val(aPFunRur[nPosAlqFun]) , 0 )
		EndIf
		
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Ponto de Entrada para alterar a aliquota de Funrural de 2.3% para 0,02% conforme acoes    ³
		//³judiciarias movidas por alguns produtores e empregadores rurais cuja causa tem sido aceita³
		//³por inconstitucionalidade do art. 25 da Lei nº 8.212/91.                                  ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If aExistPE[PE_MAFISRUR]
			nNewAlqRur := ExecBlock( "MAFISRUR",.F.,.F.,{aNfItem[nItem,IT_TES],aNfItem[nItem,IT_PRODUTO],aNfCab[NF_CLIFOR],aNfCab[NF_OPERNF],aNfCab[NF_CODCLIFOR],aNfCab[NF_LOJA],IIf(aNfCab[NF_CLIFOR] == "F", SA2->A2_TIPORUR , SM0->M0_PRODRUR ) , nAliquota})
			If ValType(nNewAlqRur) == "N"
				nAliquota := nNewAlqRur
			EndIf
		EndIf	
	
		aNfItem[nItem][IT_PERFUN] := nAliquota
	
	EndIF
	
	IF "BSE" $ cExecuta
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Define a Base FUNRURAL³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		IF aNfItem[nItem][IT_PERFUN] > 0		
			If (aTes[TS_BSRURAL] == "1")
				aNfItem[nItem][IT_BASEFUN] := IIF(aTes[TS_DICMFUN] =="1" .And. aTes[TS_AGREG] == "D" .And. aNfItem[nItem][IT_DEDICM]>0 , (aNfItem[nItem][IT_VALMERC]-aNfItem[nItem][IT_DEDICM]) - aNfItem[nItem][IT_DESCONTO],;
				aNfItem[nItem][IT_VALMERC] - aNfItem[nItem][IT_DESCONTO])
			Else
				aNfItem[nItem][IT_BASEFUN] := IIF(aTes[TS_DICMFUN] =="1" .And. aTes[TS_AGREG] == "D" .And. aNfItem[nItem][IT_DEDICM]>0 ,(aNfItem[nItem][IT_VALMERC]-aNfItem[nItem][IT_DEDICM]) - aNfItem[nItem][IT_DESCONTO] + aNfItem[nItem][IT_FRETE] + aNfItem[nItem][IT_DESPESA] + aNfItem[nItem][IT_SEGURO],;
				aNfItem[nItem][IT_VALMERC] - aNfItem[nItem][IT_DESCONTO] + aNfItem[nItem][IT_FRETE] + aNfItem[nItem][IT_DESPESA] + aNfItem[nItem][IT_SEGURO])
			EndIf 
		Else
			aNfItem[nItem][IT_BASEFUN] := 0
		EndIF
	
	EndIF
	
	IF "VLR" $ cExecuta
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Define o Valor FUNRURAL³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		IF aNfItem[nItem][IT_PERFUN] > 0
			aNfItem[nItem][IT_FUNRURAL] := ( aNfItem[nItem][IT_BASEFUN] * aNfItem[nItem][IT_PERFUN] ) / 100
		Else
			aNfItem[nItem][IT_FUNRURAL]:= 0		
		EndIf
	EndIF
Else
	aNfItem[nItem][IT_BASEFUN] := 0
	aNfItem[nItem][IT_PERFUN]  := 0
	aNfItem[nItem][IT_FUNRURAL]:= 0
EndIf

Return

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Programa  ³ MaFisFFF ³ Autor ³ Alexandre Lemes       ³ Data ³28/09/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descricao ³Efetua calculo FETHAB, FACS, FABOV para o estado do Mato    ³±±
±±³          ³Grosso.                                                     ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisFFF(nItem)

Local cPrUm     := ""
Local cSgUm     := ""
Local nIndUpf	:= 0
Local nAliq     := 0
Local nQtd2Um   := 0

aNfItem[nItem][IT_BASEFAB] := 0
aNfItem[nItem][IT_ALIQFAB] := 0
aNfItem[nItem][IT_VALFAB]  := 0

aNfItem[nItem][IT_BASEFAC] := 0
aNfItem[nItem][IT_ALIQFAC] := 0
aNfItem[nItem][IT_VALFAC]  := 0

aNfItem[nItem][IT_BASEFET] := 0
aNfItem[nItem][IT_ALIQFET] := 0
aNfItem[nItem][IT_VALFET]  := 0

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Parametro "MV_INDUPF", utilizado para informar o campo    ³
//³da tabela SM2 (Moedas) que sera utilizado para informar o ³
//³indexador UPF/MT, com a finalidade de calcular os tributos³
//³FETHAB, FACS, FABOV                                       ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If SM2->(FieldPos(Alltrim(aParSX6[MV_INDUPF]))) > 0
	SM2->(dbSetOrder(1))
	If SM2->(MsSeek(dDataBase))
		nIndUpf := SM2->&(Alltrim(aParSX6[MV_INDUPF]))
	Endif
Endif

If nIndUpf > 0
	
	cPrUm     := If(!Empty(aNfItem[nItem][IT_B1UM]),aNfItem[nItem][IT_B1UM],"")
	cSgUm     := If(!Empty(aNfItem[nItem][IT_B1SEGUM]),aNfItem[nItem][IT_B1SEGUM],"")
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³FABOV - BASE / ALIQUOTA e VALOR³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If cPaisLoc == "BRA" .And. (aFieldPos[FP_B1_AFABOV] .And. aFieldPos[FP_A2_RFABOV] .And. aFieldPos[FP_A1_RFABOV] .And. aFieldPos[FP_F4_CFABOV] )
		If aNfItem[nItem][IT_AFABOV] > 0 .And. aTes[TS_CALCFAB] == "1"
			nAliq	  := aNfItem[nItem][IT_AFABOV]
			If Alltrim(cPrUm) == "UN" // E obrigatorio que a primeira ou a segunda unidade de medida seja "UN"
				aNfItem[nItem][IT_BASEFAB] := Round((nIndUpf * nAliq /100),2)
				aNfItem[nItem][IT_ALIQFAB] := nAliq
				aNfItem[nItem][IT_VALFAB]  := Round(((nIndUpf * nAliq /100) * aNfItem[nItem][IT_QUANT]),2)
			ElseIf Alltrim(cSgUm) == "UN"
				nQtd2Um:= ConvUm(aNfItem[nItem][IT_PRODUTO],aNfItem[nItem][IT_QUANT],0,2)
				If nQtd2Um > 0
					aNfItem[nItem][IT_BASEFAB] := Round((nIndUpf * nAliq /100),2)
					aNfItem[nItem][IT_ALIQFAB] := nAliq
					aNfItem[nItem][IT_VALFAB]  := Round(((nIndUpf * nAliq /100) * nQtd2Um),2)
				EndIf
			EndIf
		EndIf
	EndIf
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³FACS  - BASE / ALIQUOTA e VALOR³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If cPaisLoc == "BRA" .And. (aFieldPos[FP_B1_AFACS] .And. aFieldPos[FP_A2_RFACS] .And. aFieldPos[FP_A1_RFACS] .And. aFieldPos[FP_F4_CFACS] )
		If aNfItem[nItem][IT_AFACS] > 0 .And. aTes[TS_CALCFAC] == "1"
			nAliq	  := aNfItem[nItem][IT_AFACS]
			If Alltrim(cPrUm) == "TL" // E obrigatorio que a primeira ou a segunda unidade de medida seja "TL"
				aNfItem[nItem][IT_BASEFAC] := Round((nIndUpf * nAliq /100),2)
				aNfItem[nItem][IT_ALIQFAC] := nAliq
				aNfItem[nItem][IT_VALFAC]  := Round(((nIndUpf * nAliq /100) * aNfItem[nItem][IT_QUANT]),2)
			ElseIf Alltrim(cSgUm) == "TL"
				nQtd2Um:= ConvUm(aNfItem[nItem][IT_PRODUTO],aNfItem[nItem][IT_QUANT],0,2)
				If nQtd2Um > 0
					aNfItem[nItem][IT_BASEFAC] := Round((nIndUpf * nAliq /100),2)
					aNfItem[nItem][IT_ALIQFAC] := nAliq
					aNfItem[nItem][IT_VALFAC]  := Round(((nIndUpf * nAliq /100) * nQtd2Um),2)
				EndIf
			EndIf
		EndIf
	EndIf
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³FETHAB - BASE / ALIQUOTA e VALOR³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If cPaisLoc == "BRA" .And. (aFieldPos[FP_B1_AFETHAB]  .And. aFieldPos[FP_A2_RECFET]  .And. aFieldPos[FP_A1_RECFET] .And. aFieldPos[FP_F4_CALCFET] )
		If aNfItem[nItem][IT_AFETHAB]  > 0  .And. !Empty(aNfItem[nItem][IT_TFETHAB]) .And. aTes[TS_CALCFET] == "1"
			nAliq	  := aNfItem[nItem][IT_AFETHAB]
			If aNfItem[nItem][IT_TFETHAB] $ "12"  // 1 - Soja ou 2 - Algodao
				If Alltrim(cPrUm) == "TL" // E obrigatorio que a primeira ou a segunda unidade de medida seja "TL"
					aNfItem[nItem][IT_BASEFET] := Round((nIndUpf * nAliq /100),2)
					aNfItem[nItem][IT_ALIQFET] := nAliq
					aNfItem[nItem][IT_VALFET]  := Round(((nIndUpf * nAliq /100) * aNfItem[nItem][IT_QUANT]),2)
				ElseIf Alltrim(cSgUm) == "TL"
					nQtd2Um:= ConvUm(aNfItem[nItem][IT_PRODUTO],aNfItem[nItem][IT_QUANT],1,2)
					If nQtd2Um > 0
						aNfItem[nItem][IT_BASEFET] := Round((nIndUpf	 * nAliq /100),2)
						aNfItem[nItem][IT_ALIQFET] := nAliq
						aNfItem[nItem][IT_VALFET]  := Round(((nIndUpf * nAliq /100) * nQtd2Um),2)
					EndIf
				EndIf
				
				IF aNfCab[NF_RECFET] == "1"
					aNfItem[nItem][IT_VALFETR]	:= aNfItem[nItem][IT_VALFET]
				EndIF
				
				IF aNfItem[nItem][IT_TFETHAB] == "2"				
									
				 	IF aFieldPos[FP_F4_RFETALG] .AND. aTes[TS_RFETALG] == "1"// Algodão irá verificar retenção no cadastro de TES
						aNfItem[nItem][IT_VALFETR]:= 0 //Se no cadastro do TES estiver igual a SIM então não irá reter FETHAB, se estiver diferente irá considerar o padrão
					ElseIF aNfCab[NF_RECFET] == "1"
						aNfItem[nItem][IT_VALFETR]	:= aNfItem[nItem][IT_VALFET]					
					EndIF
				
				EndIF
				
			ElseIf aNfItem[nItem][IT_TFETHAB] == "3" //  3 - Gado
				If Alltrim(cPrUm) == "UN" // E obrigatorio que a primeira ou a segunda unidade de medida seja "UN"
					aNfItem[nItem][IT_BASEFET] := Round((nIndUpf * nAliq /100),2)
					aNfItem[nItem][IT_ALIQFET] := nAliq
					aNfItem[nItem][IT_VALFET]  := Round(((nIndUpf * nAliq /100) * aNfItem[nItem][IT_QUANT]),2)
				ElseIf Alltrim(cSgUm) == "UN"
					nQtd2Um:= ConvUm(aNfItem[nItem][IT_PRODUTO],aNfItem[nItem][IT_QUANT],0,2)
					If nQtd2Um > 0
						aNfItem[nItem][IT_BASEFET] := Round((nIndUpf * nAliq /100),2)
						aNfItem[nItem][IT_ALIQFET] := nAliq
						aNfItem[nItem][IT_VALFET]  := Round(((nIndUpf * nAliq /100) * nQtd2Um),2)
					EndIf
				EndIf
				
				IF aNfCab[NF_RECFET] == "1"
					aNfItem[nItem][IT_VALFETR]	:= aNfItem[nItem][IT_VALFET]
				EndIF
				
			EndIf
		EndIf
	EndIf
Endif

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisSEST ³ Autor ³Alexandre Lemes        ³ Data ³01/10/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Calculo do SEST                                             ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisSEST(nItem)

If !Empty(aNfCab[NF_NATUREZA]) .And. aNfCab[NF_RECSEST]=="1" .And. aTES[TS_DUPLIC]=="S" .And. aFieldPos[FP_ED_BASESES] .And. aFieldPos[FP_ED_PERCSES]
	aNfItem[nItem][IT_BASESES] := IIf( aInfNat[NT_BASESES] > 0,((aNfItem[nItem][IT_TOTAL]*aInfNat[NT_BASESES])/100) , aNfItem[nItem][IT_TOTAL] )
	aNfItem[nItem][IT_ALIQSES] := aInfNat[NT_PERCSES]
	aNfItem[nItem][IT_VALSES]  := IIf( aParSX6[MV_RNDSEST], Round((aNfItem[nItem][IT_BASESES] * (aNfItem[nItem][IT_ALIQSES]/100)),2) , (aNfItem[nItem][IT_BASESES] * (aNfItem[nItem][IT_ALIQSES]/100)) )
Else
	aNfItem[nItem][IT_BASESES] := 0
	aNfItem[nItem][IT_ALIQSES] := 0
	aNfItem[nItem][IT_VALSES]  := 0
Endif

Return

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Programa  ³MaFisSENAR³ Autor ³ Alexandre Lemes       ³ Data ³28/09/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descricao ³ Calculo do SENAR Lei 8.205, de 22 de dezembro de 2004      ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisSENAR(nItem)

Local lDev := Iif(Alltrim(aNfCab[NF_TIPONF]) $ "DB",.T.,.F.)

If aTes[TS_ALSENAR] > 0 .And. aTes[TS_DUPLIC] == "S" .And. aNfCab[NF_TPCLIFOR] <> "X"
	If ((SubStr(aNfItem[nItem][IT_CF],1,1) $ "5|6") .Or.(SubStr(aNfItem[nItem][IT_CF],1,1) $ "1|2" .And. lDev))
		aNfItem[nItem][IT_BSSENAR]:= aNfItem[nItem][IT_TOTAL]
		aNfItem[nItem][IT_ALSENAR]:= aTes[TS_ALSENAR]
		aNfItem[nItem][IT_VLSENAR]:= NoRound((aNfItem[nItem][IT_BSSENAR]*( aTes[TS_ALSENAR]/100)),2)
	ElseIf ((SubStr(aNfItem[nItem][IT_CF],1,1) $ "1|2") .Or.(SubStr(aNfItem[nItem][IT_CF],1,1) $ "5|6" .And. lDev)) .And. (aNfCab[NF_TPCLIFOR] == "F")
		aNfItem[nItem][IT_BSSENAR]:= aNfItem[nItem][IT_TOTAL]
		aNfItem[nItem][IT_ALSENAR]:= aTes[TS_ALSENAR]
		aNfItem[nItem][IT_VLSENAR]:= NoRound((aNfItem[nItem][IT_BSSENAR]*( aTes[TS_ALSENAR]/100)),2)
	Else	
		aNfItem[nItem][IT_BSSENAR]:= 0
		aNfItem[nItem][IT_ALSENAR]:= 0
		aNfItem[nItem][IT_VLSENAR]:= 0
	Endif
Else
	aNfItem[nItem][IT_BSSENAR]:= 0
	aNfItem[nItem][IT_ALSENAR]:= 0
	aNfItem[nItem][IT_VLSENAR]:= 0
Endif

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisAFRMM³ Autor ³Alexandre Lemes        ³ Data ³01/10/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Calculo do AFRMM                                            ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisAFRMM(nItem)

If aTes[TS_AFRMM] == "S"
	aNfItem[nItem][IT_BASEAFRMM] := IIf( aNfItem[nItem][IT_VALMERC] > 0 , aNfItem[nItem][IT_VALMERC] , 0 )
	aNfItem[nItem][IT_ALIQAFRMM] := IIf( !Empty( aParSX6[MV_TXAFRMM] )  , aParSX6[MV_TXAFRMM] , 0 )
	aNfItem[nItem][IT_VALAFRMM]  := (( aNfItem[nItem][IT_BASEAFRMM] * aNfItem[nItem][IT_ALIQAFRMM] ) / 100 )
	
	If aExistPE[PE_MAAFRMM]
		aNfItem[nItem][IT_VALAFRMM] := ExecBlock("MAAFRMM",.F.,.F.,{ aNfItem[nItem][IT_VALAFRMM] })
	Endif
Else
	aNfItem[nItem][IT_BASEAFRMM] := 0
	aNfItem[nItem][IT_ALIQAFRMM] := 0
	aNfItem[nItem][IT_VALAFRMM]  := 0
EndIf

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisVsul ³ Autor ³ Alexandre Lemes       ³ Data ³28/09/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Calcula o valor do Fundersul do item - Mato Grosso do Sul   ³±±
±±³          ³Este valor sera calculado apenas nas entradas do estado,    ³±±
±±³          ³sendo que o resultado sera deduzido da duplicata a pagar.   ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisVSul(nItem)

Local nUferms := 0

If aNfItem[nItem][IT_PRD][SB_PRFDSUL] > 0 .And. aTes[TS_DUPLIC] == "S" .And. aNfCab[NF_TPCLIFOR] <> "X" .And.;
	aTes[TS_CLFDSUL] == "1" .And. (SubStr(aNfItem[nItem][IT_CF],1,1) == "1" .Or. ;
	(SubStr(aNfItem[nItem][IT_CF],1,1)$"5/6")) //.And. aNFitem[nItem][IT_TIPONF] == "D"))
	
	If SM2->(FieldPos("M2_MOEDA"+ Alltrim(aParSX6[MV_UFERMS]) )) > 0
		SM2->(dbSetOrder(1))
		If SM2->(MsSeek(dDataBase))
			nUferms := SM2->&("M2_MOEDA"+Alltrim(aParSX6[MV_UFERMS]) )
		Endif
		
		If nUferms > 0
			aNfItem[nItem][IT_VALFDS] 	:= aNfItem[nItem][IT_QUANT] * (nUferms * aNfItem[nItem][IT_PRD][SB_PRFDSUL] / 100)
			aNfItem[nItem][IT_PRFDSUL] 	:= aNfItem[nItem][IT_PRD][SB_PRFDSUL]
			aNfItem[nItem][IT_UFERMS]  	:= nUferms
		Endif
	Endif
Else
	aNfItem[nItem][IT_VALFDS] 	:= 0
	aNfItem[nItem][IT_PRFDSUL] 	:= 0
	aNfItem[nItem][IT_UFERMS]  	:= 0
Endif

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisBSICA³ Autor ³ Alexandre Lemes       ³ Data ³24/09/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Executa o calculo da Base do ICMS do frete Autonomo.        ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisICA(nItem)

aNfItem[nItem][IT_BASEICA]:= IIf( aTes[TS_LFICM] <> "N" .And. aTes[TS_FRETAUT] <> "2" .And. aTes[TS_FRETAUT] <> "3", aNfItem[nItem][IT_AUTONOMO] , 0 )
aNfItem[nItem][IT_VALICA] := IIf( aTes[TS_LFICM] <> "N" , aNfItem[nItem][IT_BASEICA] * aNfItem[nItem][IT_ALIQICM] / 100 , 0 )

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³ MaFisTST ³ Autor ³ Alexandre Lemes       ³ Data ³24/09/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Verifica a base para calculo do ICMS sobre o frete  		  ³±±
±±³          ³quando o calculo e feito a parte do calculo do ICMS         ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisTST(nItem,cExecuta)

DEFAULT cExecuta  := "BSE|ALQ|VLR"

//Calcula o ICMS do frete embarcador quando:
//- a transportadora for do mesmo estado;
//- a transportadora for um autonomo;
//- a transportadora for de outro estado, mas nao inscrita no estado do contribuinte.
If aTes[TS_FRETAUT] == "3" .And. ( aNfCab[NF_TRANSUF] == aParSX6[MV_ESTADO] .Or. aNfCab[NF_TRANSIN] == "3" .Or.(aNfCab[NF_TRANSIN] == "2" .And. aNfCab[NF_TRANSUF] <> aParSX6[MV_ESTADO] ) )
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Define BASE do TST - IT_BASETST  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If "BSE" $ cExecuta
		aNfItem[nItem][IT_BASETST]:= aNfItem[nItem][IT_AUTONOMO]
	EndIf
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Define Aliquota do TST - IT_ALIQTST³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If "ALQ" $ cExecuta
		aNfItem[nItem][IT_ALIQTST]:= Val(Substr(aParSX6[MV_ALIQFRE],AT(aNFCab[NF_UFDEST],aParSX6[MV_ALIQFRE])+2,2))
	EndIf
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Define VLR  do TST - IT_VALTST   ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If "VLR" $ cExecuta
		aNfItem[nItem][IT_VALTST] := aNfItem[nItem][IT_BASETST]*aNfItem[nItem][IT_ALIQTST]/100
	EndIf
Else
	aNfItem[nItem][IT_BASETST]:= 0
	aNfItem[nItem][IT_ALIQTST]:= 0
	aNfItem[nItem][IT_VALTST] := 0
Endif

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisCIDE ³ Autor ³ Graziele Paro         ³ Data ³20/12/2013³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Efetua o cálculo do CIDE, para que seja definido no titulo  ³±±
±±³          ³campo E2_CIDE										          ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisCIDE(nItem)

IF aNfCab[NF_OPERNF] == "E" .And. aInfNat[19] == "S" .And. aNfCab[NF_RECCIDE] == "1" 
	IF !Empty(aInfNat[21]) .And. aInfNat[21] > 0
		aNfItem[nItem][IT_VALCIDE] := (aNfItem[nItem][IT_BASEDUP]*(aInfNat[21]/100))
	Else
		aNfItem[nItem][IT_VALCIDE] :=	aNfItem[nItem][IT_BASEDUP]
	EndIf
	aNfItem[nItem][IT_VALCIDE] := aNfItem[nItem][IT_VALCIDE] * (aInfNat[20]/100)
EndIf	
 

Return   
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³ MaFisTPDP³ Autor ³ Alexandre Lemes       ³ Data ³22/11/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Executa calculo do TPDP - Paraiba		                      ³±±
±±³          ³Taxa de Processamento de Despesas Publicas.                 ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisTPDP(nItem)

aNfItem[nItem][IT_BASTPDP]	:= 0
aNfItem[nItem][IT_ALITPDP]	:= 0
aNfItem[nItem][IT_VALTPDP]	:= 0

If aFieldPos[FP_A1_TPDP] .And. aFieldPos[FP_B1_TPDP] .And. aNfCab[NF_OPERNF] == "S" .And. SA1->A1_TPDP == "1" .And. ;
	aNfItem[nItem][IT_PRD][SB_TPDP] == "1" .And. aNfCab[NF_UFDEST]=="PB" .And. aTes[TS_DUPLIC] == "S" .And. aNfItem[nItem][IT_VALMERC] > 0
	
	aNfItem[nItem][IT_BASTPDP]	:= aNfItem[nItem][IT_VALMERC]
	aNfItem[nItem][IT_ALITPDP]	:= aParSX6[MV_ALITPDP]
	
	If ( aNfItem[nItem][IT_BASTPDP] * ( aParSX6[MV_ALITPDP] / 100 ) ) >= 30000
		aNfItem[nItem][IT_VALTPDP]	:= 30000
	Else
		aNfItem[nItem][IT_VALTPDP] := ( aNfItem[nItem][IT_BASTPDP] * ( aParSX6[MV_ALITPDP] / 100 ) )
	Endif
	
	MaItArred(nItem,{"IT_VALTPDP"})
EndIf

Return


/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³ MaFisFECP³ Autor ³ALexandre Lemes        ³ Data ³19/10/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Calcula  FECP de Todos os Estados e grava a aliquota a ser ³±±
±±³          ³ Majorada na aliquota do ICMS na referencia de Aliquota do  ³±±
±±³          ³ FECP de cada estado no array aNFItem                       ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisFECP( nItem , cCampo, lReproc )

Local cCfComTele	:= "1301/1302/1303/1304/1305/1306/2300/2301/2302/2303/2304/2305/2306/3301/5301/5302/5303/5304/5305/5306/5307/6302/6303/6304/6305/6306/6307/7301"
Local nAlqFecpRJ	:= 0
Local nAlqFecpBA	:= 0
Local nAlqFecpMT	:= 0
Local nAlqFecpRN	:= 0
Local nAlqFecpMG	:= 0
Local nAlqFecpMA	:= 0
Local nAlqAdicMT	:= 0
Local nBsFecpST		:= 0
Local nBsFumacop	:= 0
Local lFecp			:= aNfItem[nItem][IT_BASEICM] > 0
Local lFecpST		:= aNfItem[nItem][IT_BASESOL] > 0
Local lFecpOut		:= aTes[TS_ANTICMS] == "1" .Or. aTes[TS_CONSUMO]$"SO"
Default cCampo		:=	""
Default lReproc     := .F.

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³  Garante que ao se alterar o item por um outro que NAO calcula FECP as 			³
//³referencias sejam limpas, inclusive	retirando a majoracao da Aliquota de ICMS;	³
//³ICMS Complementar e ICMS Substituicao Tributaria.								³
//³  Criado o parametro 2 da funcao (cCampo) para que esse processo nao ocorra 		³
//³quando estiver alterando manualmente a aliquota de ICMS.							³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If aNfItem[nItem][IT_UFXPROD][UFP_ALIQFECP] > 0 .And. cCampo <> "IT_ALIQICM"
	aNfItem[nItem][IT_ALIQICM]	-= 	aNfItem[nItem,IT_ALIQFECP]
	aNfItem[nItem][IT_ALIQCMP]	-=	aNfItem[nItem,IT_ALFCCMP]
	aNfItem[nItem][IT_ALIQSOL]	-= 	aNfItem[nItem,IT_ALFCST]

Elseif cCampo <> "IT_ALIQICM"
	If aNfItem[nItem,IT_VALFECP] + aNfItem[nItem,IT_VFECPMT] + aNfItem[nItem,IT_VFECPRN] + aNfItem[nItem][IT_VFECPMG] + aNfItem[nItem][IT_VALFUM] > 0
		aNfItem[nItem][IT_ALIQICM]	-= 	aNfItem[nItem,IT_ALIQFECP] + aNfItem[nItem,IT_ALFECMT] + aNfItem[nItem,IT_ALFECRN] + aNfItem[nItem][IT_ALFECMG] + aNfItem[nItem,IT_ALIQFUM]
		If aNfItem[nItem][IT_VALCMP] > 0
			aNfItem[nItem][IT_ALIQCMP]	-=	aNfItem[nItem,IT_ALIQFECP] + aNfItem[nItem,IT_ALFECMT] + aNfItem[nItem,IT_ALFECRN] + aNfItem[nItem][IT_ALFECMG] + aNfItem[nItem,IT_ALIQFUM]
		Endif
	Endif
	If aNfItem[nItem,IT_VFECPST] + aNfItem[nItem,IT_VFESTMT] + aNfItem[nItem,IT_VFESTRN] + aNfItem[nItem][IT_VFESTMG] > 0
		aNfItem[nItem][IT_ALIQSOL]	-= 	aNfItem[nItem,IT_ALIQFECP] + aNfItem[nItem,IT_ALFECMT] + aNfItem[nItem,IT_ALFECRN] + aNfItem[nItem][IT_ALFECMG]
	Endif
Endif

aNfItem[nItem][IT_ALIQFECP]:= 0
aNfItem[nItem][IT_VALFECP] := 0
aNfItem[nItem][IT_VFECPST] := 0

aNfItem[nItem][IT_ALFECMT] := 0
aNfItem[nItem][IT_VFESTMT] := 0
aNfItem[nItem][IT_VFECPMT] := 0

aNfItem[nItem][IT_ALFECRN] := 0
aNfItem[nItem][IT_VFECPRN] := 0
aNfItem[nItem][IT_VFESTRN] := 0

aNfItem[nItem][IT_ALFECMG] := 0
aNfItem[nItem][IT_VFECPMG] := 0
aNfItem[nItem][IT_VFESTMG] := 0

aNfItem[nItem][IT_BASEFUM] := 0
aNfItem[nItem][IT_ALIQFUM] := 0
aNfItem[nItem][IT_VALFUM]  := 0

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Caso esteja calculando atraves da tabela CFC, realizo as validacoes de  acordo com as	³
//³novas regras do Fecp. Referencias -> IT_VALFECP ; IT_VFECPST ; IT_ALIQFECP   			³  
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ  
If aNfItem[nItem][IT_UFXPROD][UFP_ALIQFECP] > 0 .And. aTes[TS_ISEFECP] <> "1"

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Validacoes para ICMS Complementar/Antecipacao: 														³
	//³																										³
	//³-> Nao majorar em Operacoes Interestaduais de Entrada para Consumo quando o campo CFC_FCPXDA = Nao	³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If lFecpOut .And. ( aNfCab[NF_OPERNF] == "E" .And. aNfCab[NF_UFDEST] <> aNfCab[NF_UFORIGEM] .And. aTes[TS_CONSUMO]$"S" .And. aNfItem[nItem][IT_UFXPROD][UFP_FECPDIF] $ "2" )
		lFecpOut	:=	.F.
	Endif
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Validacoes para ICMS Proprio:				 														³
	//³																										³
	//³-> Nao majorar em Operacoes Internas quando o campo CFC_FCPINT = Nao									³
	//³-> Nao majorar em Devolucoes, pois a MATXFIS busca a aliquota do documento original					³
	//³-> Nao majorar em Operacoes Interestaduais de Entrada												³
	//³-> Nao majorar em Operacoes Interestaduais de Saida, exceto destinadas a Consumidor Final. 			³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If lFecp .And.		(;
							( aNfCab[NF_UFDEST] == aNfCab[NF_UFORIGEM] .And. aNfItem[nItem][IT_UFXPROD][UFP_FECPINT] $ "2" ) .Or.;
							( aNfCab[NF_TIPONF] $ "D" ) .Or.;
							( aNfCab[NF_UFDEST] <> aNfCab[NF_UFORIGEM] .And. aNfCab[NF_OPERNF] == "E" ) .Or.;
							( aNfCab[NF_UFDEST] <> aNfCab[NF_UFORIGEM] .And. aNfCab[NF_OPERNF] == "S" .And. aNfCab[NF_TPCLIFOR] <> "F" );
						)
		
		lFecp		:=	.F.
	Endif
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Validacoes para ICMS ST:					 														³
	//³																										³
	//³-> Nao majorar em Devolucoes, pois a MATXFIS busca a aliquota do documento original					³  
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If lFecpST .And. ( aNfCab[NF_TIPONF] $ "D" )
		lFecpST		:=	.F.
	Endif

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ 														ICMS Proprio			 												³
	//³Nas operacoes interestaduais destinadas a nao contribuintes, devo utilizar a majoracao com aliquota do estado de origem.			³  
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If lFecp
		If aNfCab[NF_OPERNF] == "S" .And. aNfCab[NF_UFDEST] <> aNfCab[NF_UFORIGEM] .And. aNfCab[NF_LINSCR]
			aNfItem[nItem][IT_ALIQFECP]	:= aNfItem[nItem][IT_UFXPROD][UFP_ALQFCPO]
		Else
			aNfItem[nItem][IT_ALIQFECP]	:= aNfItem[nItem][IT_UFXPROD][UFP_ALIQFECP]
		Endif
		aNfItem[nItem][IT_VALFECP]	:= aNfItem[nItem][IT_BASEICM] * ( aNfItem[nItem][IT_ALIQFECP] / 100 )
		
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Utiliza Indice Auxiliar para calculo do FECP	³  
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If aNfItem[nItem][IT_UFXPROD][UFP_FECPAUX] > 0
			aNfItem[nItem][IT_VALFECP]	:= aNfItem[nItem][IT_VALICM] * aNfItem[nItem][IT_UFXPROD][UFP_FECPAUX]
		Endif
	Endif
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ 												ICMS Substituicao Tributaria							 						³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If lFecpST
		aNfItem[nItem][IT_ALFCST]	:= aNfItem[nItem][IT_UFXPROD][UFP_ALIQFECP]
		aNfItem[nItem][IT_VFECPST]	:= aNfItem[nItem][IT_BASESOL] * ( aNfItem[nItem][IT_ALFCST] / 100 )
	Endif
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ 										ICMS Diferencial de Aliquotas ou Antecipacao de ICMS			 						³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If lFecpOut
		aNfItem[nItem][IT_ALFCCMP]	:= aNfItem[nItem][IT_UFXPROD][UFP_ALIQFECP]
		aNfItem[nItem][IT_VALFECP]	:= aNfItem[nItem][IT_BASEICM] * ( aNfItem[nItem][IT_ALFCCMP] / 100 )
	Endif
	
Else
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³FECP - RIO DE JANEIRO - Lei 14.264/07 - Decreto 1036 de 28/01/08   ³  
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ  
	If !aTes[TS_ISEFECP] == "1"
		
		nAlqFecpRJ := IIf( aNfItem[nItem][IT_PRD][SB_FECP] > 0 , aNfItem[nItem][IT_PRD][SB_FECP] , 1 )
		
		If ( aParSX6[MV_ESTADO] == "RJ" .And. aNFCab[NF_OPERNF] == "E" .And. aNFCab[NF_UFDEST] <> aNFCab[NF_UFORIGEM] .And. aTes[TS_COMPL] == "S"  ) .Or. ;
		   ( aParSX6[MV_ESTADO] == "RJ" .And. aNFCab[NF_UFDEST] == "RJ" .And. (aNFCab[NF_UFORIGEM] == "RJ" .Or. aNFCab[NF_UFORIGEM] == "EX") ) .Or. ;			
			( aParSX6[MV_ESTADO] == "RJ" .And. aNFCab[NF_OPERNF] == "S" .And. aNFCab[NF_UFDEST] <> aNFCab[NF_UFORIGEM] .And. aNFCab[NF_LINSCR] ) .Or. ;
			( aParSX6[MV_ESTADO] == "RJ" .And. aNFCab[NF_OPERNF] == "S" .And. aNFCab[NF_UFDEST] <> aNFCab[NF_UFORIGEM] .And. aNfCab[NF_TIPONF] =="D" )
			aNfItem[nItem][IT_VALFECP]	:= aNfItem[nItem][IT_BASEICM] * (nAlqFecpRJ/100) 
			aNfItem[nItem][IT_ALIQFECP] := nAlqFecpRJ		
		EndIf
		
		If aNfItem[nItem][IT_BASESOL] > 0
			If  ( aParSX6[MV_ESTADO] == "RJ" .And. aNFCab[NF_UFDEST] == "RJ" .And. aNFCab[NF_UFORIGEM] == "RJ" ) .Or. ;
				( aParSX6[MV_ESTADO] <> "RJ" .And. aNFCab[NF_OPERNF] == "S" .And.  aNFCab[NF_UFDEST] == "RJ"  ) .Or. ;
				( aParSX6[MV_ESTADO] == "RJ" .And. aNFCab[NF_UFDEST] == "RJ" )
				If ( aParSX6[MV_ESTADO] == "RJ" .And. aNFCab[NF_UFDEST] == "RJ" .And. aNFCab[NF_UFORIGEM] == "RJ" )
					aNfItem[nItem][IT_VFECPST]	:= ( aNfItem[nItem][IT_BASESOL] - aNfItem[nItem][IT_BASEICM] ) * (nAlqFecpRJ/100)
				Else
					aNfItem[nItem][IT_VFECPST]	:= aNfItem[nItem][IT_BASESOL] * (nAlqFecpRJ/100)
				EndIf
			ElseIF aNFCab[NF_TIPONF] == "D" .And. aNFCab[NF_OPERNF] == "E" .And. aNFCab[NF_UFORIGEM] == "RJ" .And. aParSX6[MV_ESTADO] <> "RJ"
				aNfItem[nItem][IT_VFECPST]	:= aNfItem[nItem][IT_BASESOL] * (nAlqFecpRJ/100)
			EndIf
		EndIf
		
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Somente irá atribuir alíquota no IT_ALIQFECP se realmente houve o cálculo do FECP ou FECPST³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		IF aNfItem[nItem][IT_VFECPST] > 0
			aNfItem[nItem][IT_ALIQFECP]  := nAlqFecpRJ
		EndIF
		
	EndIf
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³FECP - BAHIA                                                       ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If !aTes[TS_ISEFECP] == "1"
		
		nAlqFecpBA := Iif( aFieldPos[FP_B1_FECPBA] , aNfItem[nItem][IT_PRD][SB_FECPBA] , 0 )
		
		If nAlqFecpBA > 0
			
			If ( aParSX6[MV_ESTADO] == "BA" .And. aNFCab[NF_UFDEST] == "BA" .And. aNFCab[NF_UFORIGEM] == "BA" ) .Or. ;
				( aParSX6[MV_ESTADO] == "BA" .And. aNFCab[NF_OPERNF] == "S"  .And. aNFCab[NF_UFDEST] <> aNFCab[NF_UFORIGEM] .And. aNFCab[NF_LINSCR] )
				aNfItem[nItem][IT_VALFECP]	:= aNfItem[nItem][IT_BASEICM] * (nAlqFecpBA/100)
				aNfItem[nItem][IT_ALIQFECP]  := nAlqFecpBA
			EndIf
			
			If aNfItem[nItem][IT_BASESOL] > 0
				If ( aParSX6[MV_ESTADO] == "BA" .And. aNFCab[NF_UFDEST] == "BA" .And. aNFCab[NF_UFORIGEM] == "BA" ) .Or. ;
					( aParSX6[MV_ESTADO] <> "BA" .And. aNFCab[NF_OPERNF] == "S" .And. aNFCab[NF_UFDEST] == "BA" ) .Or. ;
					( aParSX6[MV_ESTADO] == "BA" .And. aNFCab[NF_UFDEST] == "BA" )
					If (aParSX6[MV_ESTADO] == "BA" .And. aNFCab[NF_UFDEST] == "BA" .And. aNFCab[NF_UFORIGEM] == "BA")
						aNfItem[nItem][IT_VFECPST]	:= ( aNfItem[nItem][IT_BASESOL] - aNfItem[nItem][IT_BASEICM] ) * (nAlqFecpBA/100)
					Else
						aNfItem[nItem][IT_VFECPST]	:= aNfItem[nItem][IT_BASESOL] * (nAlqFecpBA/100)
					EndIf
					aNfItem[nItem][IT_ALIQFECP]  := nAlqFecpBA
				ElseIF aNFCab[NF_TIPONF] == "D" .And. aNFCab[NF_OPERNF] == "E" .And. aNFCab[NF_UFORIGEM] == "BA" .And. aParSX6[MV_ESTADO] <> "BA"
					aNfItem[nItem][IT_VFECPST]	:= aNfItem[nItem][IT_BASESOL] * (nAlqFecpBA/100)
					aNfItem[nItem][IT_ALIQFECP]  := nAlqFecpBA
				EndIf
			EndIf
			
		EndIf
		
	EndIf
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³FECP - MATO GROSSO                                                 ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If aTes[TS_ISEFEMT] == "2" .And. !Empty( Alltrim(aParSX6[MV_FECPMT]) )
		
		nAlqFecpMT := Iif( aFieldPos[FP_B1_FECPMT]  , aNfItem[nItem][IT_PRD][SB_FECPMT]  , 0 )
		nAlqAdicMT := Iif( aFieldPos[FP_B1_ADIFECP] , aNfItem[nItem][IT_PRD][SB_ADIFECP] , 0 )
		
		If aParSX6[MV_ESTADO] == "MT" .And. aTes[TS_ICM] == "S"
			
			If ( aNFCab[NF_OPERNF]$"E/S" .And. Alltrim(aNfItem[nItem][IT_CF])$cCfComTele .And. aNFCab[NF_UFORIGEM] == "MT" ) .Or. ;
				( aNFCab[NF_OPERNF] == "S" .And. aNFCab[NF_LINSCR] .And. aNFCab[NF_UFDEST] <> aNFCab[NF_UFORIGEM] ) .Or. ;
				( aNFCab[NF_OPERNF]$"E/S" .And. !Alltrim(aNfItem[nItem][IT_CF])$cCfComTele .And. aNFCab[NF_UFORIGEM] == "MT" .And. aNFCab[NF_UFDEST] == "MT" ) .Or. ;
				( aNFCab[NF_OPERNF] == "E" .And. Substr(aNfItem[nItem][IT_CF],1,1) == "3" .And. !Alltrim(aNfItem[nItem][IT_CF])$cCfComTele ) .Or. ;
				( aNFCab[NF_OPERNF] == "E" .And. aTes[TS_ANTICMS] == "1" .And. aNFCab[NF_UFORIGEM] <> "MT" .And. aNFCab[NF_UFDEST] == "MT" )
				
				aNfItem[nItem][IT_ALFECMT] := nAlqFecpMT
				aNfItem[nItem][IT_VFECPMT] := aNfItem[nItem][IT_BASEICM] * ( ( nAlqFecpMT + nAlqAdicMT ) / 100 )
			EndIf
			
		EndIf
		
		If aNfItem[nItem][IT_BASESOL] > 0 .And. aNfItem[nItem][IT_BASRESI] > 0 .And. aNFCab[NF_UFDEST] == "MT"
			
			nBsFecpST := Iif(aTes[TS_INCIDE] == "N", aNfItem[nItem][IT_VALIPI], 0) + aNfItem[nItem][IT_BASEICM] + aNfItem[nItem][IT_DESPESA]
			aNfItem[nItem][IT_ALFECMT] := nAlqFecpMT
			aNfItem[nItem][IT_VFESTMT] := ( nBsFecpST ) * ( Iif( aNFCab[NF_OPERNF] == "S" .And. aFieldPos[FP_A1_PERFECP] , SA1->A1_PERFECP , aParSX6[MV_PERFECP] ) / 100 )
			
		EndIf
		
	EndIf
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³FECP - RIO GRANDE DO NORTE (FECOP)                                 ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If aTes[TS_ISEFERN] == "2" .And. aParSX6[MV_ESTADO] == "RN" .And. aTes[TS_ICM] == "S"
		
		nAlqFecpRN := Iif( aFieldPos[FP_B1_ALFECRN] , aNfItem[nItem][IT_PRD][SB_ALFECRN] , 0 )
		
		If nAlqFECPRN > 0
			
			If ( aNFCab[NF_OPERNF] == "S" .And. aTes[TS_CONSUMO] == "S" .And. aNFCab[NF_UFORIGEM] == "RN" ) .Or. ;
				( aNFCab[NF_OPERNF] == "E" .And. aNFCab[NF_UFORIGEM] == "RN" .And. aTes[TS_ANTICMS] <> "1" .And. aTes[TS_CONSUMO] == "S" ) .Or. ;
				( aNFCab[NF_OPERNF] == "E" .And. aTes[TS_ANTICMS] == "1" .And. aNFCab[NF_UFORIGEM] <> "RN" .And. aNFCab[NF_UFDEST] == "RN" ) .Or. ;
				( aNFCab[NF_OPERNF] == "E" .And. Substr(aNfItem[nItem][IT_CF],1,1) == "3" )
				
				aNfItem[nItem][IT_VFECPRN] := aNfItem[nItem][IT_BASEICM] * ( nAlqFECPRN / 100 )
				aNfItem[nItem][IT_ALFECRN] := nAlqFECPRN
			EndIf
			
			If aNfItem[nItem][IT_BASESOL] > 0
				
				If ( aNFCab[NF_OPERNF] == "S" .And. aNFCab[NF_UFDEST] == "RN" .And. aNFCab[NF_UFORIGEM] == "RN" ) .Or. ;
					( aNFCab[NF_OPERNF] == "E" .And. aNFCab[NF_UFDEST] == "RN" .And. aNFCab[NF_UFORIGEM] == "RN" .And. aTes[TS_ANTICMS] <> "1" ) .Or. ;
					( aNFCab[NF_OPERNF] == "E" .And. aNFCab[NF_UFDEST] == "RN" .And. aNFCab[NF_UFORIGEM] <> "RN" .And. aTes[TS_ANTICMS] == "1" )
					
					aNfItem[nItem][IT_VFESTRN] := aNfItem[nItem][IT_BASESOL] * (nAlqFECPRN/100)
					aNfItem[nItem][IT_ALFECRN] := nAlqFECPRN
				EndIf
			EndIf
			
		EndIf
		
	EndIf
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³FECP - MINAS GERAIS                                                ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If aTes[TS_ISEFEMG] == "2" .And. aParSX6[MV_ESTADO] == "MG" .And. !Empty( Alltrim(aParSX6[MV_ALFECMG]) )
		
		nAlqFecpMG := Iif( aFieldPos[FP_B1_ALFECMG] , aNfItem[nItem][IT_PRD][SB_ALFECMG] , 0 )
		
		If nAlqFecpMG > 0
			
			If ( aNFCab[NF_OPERNF] == "S" .And. aNFCab[NF_UFDEST] == "MG" .And. aNFCab[NF_UFORIGEM] == "MG" .And. aTes[TS_ICM] == "S" ) .Or.;
				( aNFCab[NF_OPERNF] == "E" .And. aNFCab[NF_TIPONF] == "D" .And. aNFCab[NF_UFDEST] == "MG" .And. aNFCab[NF_UFORIGEM] == "MG" .And. aTes[TS_ICM] == "S" )
				
				aNfItem[nItem][IT_ALFECMG] := nAlqFecpMG
	
				If aNfItem[nItem][IT_BASESOL] > 0
					aNfItem[nItem][IT_VFESTMG] := aNfItem[nItem][IT_BASESOL] * (nAlqFecpMG/100)
				Else
					aNfItem[nItem][IT_VFECPMG] := aNfItem[nItem][IT_BASEICM] * (nAlqFecpMG/100)
				EndIf
				
			EndIf
			
		EndIf
		
	EndIf
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³FECP - MARANHAO - Lei 8.205, de 22 de dezembro de 2004  (FUMACOP)  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If aParSX6[MV_ESTADO] == "MA" .And. aNfCab[NF_OPERNF] == "S" .And. ( SA1->A1_CONTRIB == "2" .Or. aNFCab[NF_TPCLIFOR] == "F" )
		
		nAlqFecpMA := Iif( aFieldPos[FP_B1_ALFUMAC] , aNfItem[nItem][IT_PRD][SB_ALFUMAC] , 0 )
		
		If nAlqFecpMA > 0
			nBsFumacop := aNfItem[nItem][IT_BASEICM]
			
			If aNfItem[nItem][IT_BASESOL] > 0 .And. aNfCab[NF_UFDEST] == "MA"
				nBsFumacop := nBsFumacop + aNfItem[nItem][IT_BASESOL]
			EndIf
			
			If nBsFumacop > 0
				aNfItem[nItem][IT_BASEFUM]	:= nBsFumacop
				aNfItem[nItem][IT_ALIQFUM]	:= nAlqFecpMA
				aNfItem[nItem][IT_VALFUM]	:= NoRound( (aNfItem[nItem][IT_BASEFUM] * ( nAlqFecpMA / 100) ) , 2 )
			Endif
		Endif	
					
	EndIf
EndIF

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Garante a Majoracao (Acrescimo) correto as aliquotas do ICMS e ICMS-SOLIDARIO. ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If	! aTes[TS_AGREG] $ "B|C" .And.	;
	cCampo <> "IT_ALIQICM"   .And.	;
	!lReproc                .And. ;
	( aNfItem[nItem][IT_ALIQFECP]+aNfItem[nItem][IT_ALFCST]+aNfItem[nItem][IT_ALFCCMP]+aNfItem[nItem][IT_ALFECMT]+aNfItem[nItem][IT_VFECPMT]+aNfItem[nItem][IT_ALFECRN]+aNfItem[nItem][IT_ALFECMG]+aNfItem[nItem][IT_ALIQFUM] > 0 )
	
	MaAliqIcms(nItem)
	MaAliqSoli(nItem)
	MaAliqCmp(nItem)
EndIf

Return


/*_______________________________________FUNCOES PARA FINS EXPECIFICOS E OU QUE PODEM SER MOVIDAS DA MATXFIS ______________________________________*/

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡…o    ³ MaSBCampo()  ³ Autor ³ Alexandre Lemes   ³ Data ³06/12/2012³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna o Conteudo do Campo Dependendo do Alias Informado. ³±±
±±³          ³ O Front Loja Utiliza o Arquivo SBI Como Arq. de Produtos.  ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Static Function MaSBCampo(cNome)

Local aArea      := GetArea()
Local nPosSB1    := 0
Local nPosSBI    := 0
Local nPosSBZ    := 0
Local xValor     := Nil
Local lExistSBZ  := .F.

If cAliasPROD == "SB1" .And. aParSX6[MV_ARQPROD] == "SBZ" // Se existir registro no SBZ (Indicadores de Produtos) busca as informacoes desta tabela
	SBZ->(dbSetOrder(1))
	lExistSBZ := SBZ->( MsSeek( xFilial("SBZ") + SB1->B1_COD ) )
	nPosSBZ   := SBZ->( FieldPos( "BZ_" + cNome ) )
	If lExistSBZ .And. cNome $ cCpoSBZ .And. nPosSBZ > 0 .And. IIf( aParSX6[MV_ARQPROP] , !Empty(SBZ->(FieldGet( nPosSBZ ))) , .T. )
		xValor := SBZ->( FieldGet( nPosSBZ ) )
	Else
		xValor := SB1->( FieldGet( FieldPos( "B1_"+cNome ) ) )
	EndIf
Else
	If cAliasPROD <> "SB1" .And. !Empty( nPosSBI := (cAliasPROD)->(FieldPos( Right(cAliasPROD,2) + "_" + cNome ) ) )
		xValor := (cAliasPROD)->( FieldGet( nPosSBI ) )
	ElseIf !Empty( nPosSB1 := SB1->(FieldPos( "B1_"+cNome ) ) )
		xValor := SB1->( FieldGet( nPosSB1 ) )
	EndIf
EndIf

Restarea(aArea)

Return(xValor)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao   ³ MaRecIR  ³ Autor ³ Cleber Stenio          ³ Data ³07.01.2009³±±
±±ÃÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o³Recalcula o Valor do IR qdo alterado a condicao de Pagamento ³±±
±±³ do Titulo no MATA103X.												  ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaRecIR(dVencReal)

Local nX  := 0
Local nAliquota := 0

DEFAULT dVencReal := dDataBase

aUltPesq := {ctod(""),"","",0,0}

aEval(aNfItem,{|x| nAliquota += IIf(!x[IT_DELETED],x[IT_ALIQIRR],0)}) // Para impedir o recalculo o IRRF quando o mesmo for informado Manualmente na NFE




If nAliquota > 0 

	For nX := 1 To Len(aNFItem)
		MaFisIR(nX,"VLR",dVencReal)
		MaItArred(nX)
	Next nX
	
	MaIt2Cab()
	
EndIf

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³MaFisAddIT³ Autor ³ Marcelo Alexandre     ³ Data ³01.03.2009³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Carrega os valores de impostos de bases e item.             ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisAddIT(cCampo,xValor,nItem,lZer)

Local aArea    := GetArea()
Local cPosCpo  := MaFisScan(cCampo)

DEFAULT	lZer	:=	.F.

If xValor <> Nil
	If Substr(cCampo,1,2) == "IT"
		If ValType(aNfItem[nItem][Val(cPosCpo)]) == "A"
			If lZer
				aNfItem[nItem][Val(cPosCpo)] := {}
			EndIf
			aAdd(aNfItem[nItem][Val(cPosCpo)],xValor)
		EndIf
	EndIf
EndIf

RestArea(aArea)

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    ³CodSitTri ³ Autor ³                       ³ Data ³          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³                                                            ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function CodSitTri()
Local	cProduto:=	""
Local	cOrigem :=	""
Local	cSitTrib:=	""
Local	nXProd	:=	0

If aParSX6[MV_FISAUCF] .And. IsInCallStack( "MATA410" ) .And. FindFunction( "XFciGetOrigem" )
	If SX7->X7_CAMPO $ "C6_PRODUTO"
		cProduto := M->C6_PRODUTO
	Elseif aCols <> Nil .And. aHeader <> Nil
		nXProd := aScan(aHeader,{|x| AllTrim(x[2])=="C6_PRODUTO"})
		cProduto := aCols[n,nXProd]
	Endif
	cOrigem  := XFciGetOrigem( cProduto , M->C5_EMISSAO )[1]
Endif

If Empty(cOrigem)
	If aParSX6[MV_ARQPROP] == .T.
		cOrigem := SB1->B1_ORIGEM
	Elseif aParSX6[MV_ARQPROD]=="SBZ"
		cOrigem := Iif( !Empty( SBZ->BZ_ORIGEM ) , SBZ->BZ_ORIGEM , SB1->B1_ORIGEM )
	Else
		cOrigem := SB1->B1_ORIGEM
	Endif
Endif

cSitTrib:= SF4->F4_SITTRIB

Return cOrigem + cSitTrib

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao    Decret5602 ³ Autor ³Erick G. Dias          ³ Data ³20/08/2013³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Função que irá verificar se o item terá ou não a isenção    ³±±
±±³          ³de PIS e COFINS conforme o decreto 5602,ou não a isenção    ³±±
±±³Descri‡…o ³Função que irá verificar se o item terá ou não a isenção    ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/

Static Function Decret5602(nVlItem,cNCM,cCodNat)

Local lRet			:= .F. 
Local clMVDRE5602	:=  aParSX6[MV_DC5602]
Local cConteud		:= ""
Local cCod			:= ""
Local nPosNCM		:= 0
Local nPosCod		:= 0
Local nVal			:= 0

nPosNCM	:= At(alltrim(cNCM),clMVDRE5602)
IF nPosNCM > 0
	//Procura o código desta NCM
	cConteud	:= substr(clMVDRE5602,nPosNCM,at("/",substr(clMVDRE5602,nPosNCM)))
	nPosCod	:= at(cCodNat,cConteud)
	If nPosCod > 1
		//Buscar o valor máximo para este código
		cCod 	:= substr(cConteud,nPosCod,at(",",substr(cConteud,nPosCod))-1)
		nVal    := val(SubStr(cCod,5))
		//Se o valor do item da nota fiscal for menor que o valor máximo para esta NCM e este código, então a alíquota será reduzida.
		IF nVlItem <= nVal 
			lRet:=.T.		
		EndIF
	EndIF
EndIF

Return lRet  

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Funcao     ³RetComp     ³ Autor ³ Luciana Pires        ³ Data ³ 09.04.2008 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descricao  ³Retorna os valores da nota fiscal de complemento de ICMS       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros ³cAlOri   - Defino Alias da tabela pelo tipo (se Cliente/Forn)  ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function RetComp(cAlOri,nRecOri)

Local aArea			:= GetArea()
Local cAlias      	:= If(cAlOri == "C","SD2","SD1")
Local cIndex      	:= ""
Local cQuery		:= ""
Local lQuery      	:= .F.   
Local lComplem		:= .F.   
Local lMvxfc    	:= aParSX6[MV_XFCOMP]

#IFDEF TOP
	Local nX       	:= 0
	Local aStru    	:= {}
#ELSE
	Local cChave	:= ""
#ENDIF

If !lMvxfc // Se .F. nao verificar notas complementares de ICMS.
	Return(lComplem)
Endif

dbSelectArea(cAlias)
(cAlias)->(DbSetOrder(1))
ProcRegua(LastRec())

#IFDEF TOP
	If ( TcSrvType()!="AS/400" )
		lQuery := .T.
		If !(Alltrim(cAlOri)=="C")
			cAlias := "SD1_COMP"
			aStru  := SD1->(dbStruct())
			cQuery := "SELECT D1_FILIAL, D1_NFORI, D1_SERIORI, D1_ITEMORI, D1_TIPO, "
			cQuery +=         "D1_PICM, D1_BASEICM, D1_VALICM, D1_TES "
			cQuery += "FROM "+RetSqlName("SD1")+" SD1 "
			cQuery += "WHERE D1_FILIAL='"+xFilial("SD1")+"' AND "
			cQuery +=        "D1_FORNECE = '"+SD1->D1_FORNECE+"' AND "
			cQuery +=        "D1_LOJA = '"+SD1->D1_LOJA+"' AND "
			cQuery +=        "D1_NFORI='"+SD1->D1_DOC+"' AND "
			cQuery +=        "D1_SERIORI='"+SD1->D1_SERIE+"' AND "
			cQuery +=        "D1_ITEMORI='"+SD1->D1_ITEM+"' AND "
			cQuery +=        "D1_TIPO='I' AND "
			cQuery +=        "D_E_L_E_T_=' ' "
			cQuery	:= ChangeQuery(cQuery)                       			
			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAlias,.T.,.T.)   
		Else
			cAlias := "SD2_COMP"
			aStru  := SD2->(dbStruct())
			cQuery := "SELECT D2_FILIAL, D2_NFORI, D2_SERIORI, D2_ITEMORI, D2_TIPO, "
			cQuery +=         "D2_PICM, D2_BASEICM, D2_VALICM, D2_TES "
			cQuery += "FROM "+RetSqlName("SD2")+" SD2 "
			cQuery += "WHERE D2_FILIAL='"+xFilial("SD2")+"' AND "
			cQuery +=        "D2_CLIENTE = '"+SD2->D2_CLIENTE+"' AND "
			cQuery +=        "D2_LOJA = '"+SD2->D2_LOJA+"' AND "
			cQuery +=        "D2_NFORI='"+SD2->D2_DOC+"' AND "
			cQuery +=        "D2_SERIORI='"+SD2->D2_SERIE+"' AND "
			cQuery +=        "D2_ITEMORI='"+SD2->D2_ITEM+"' AND "
			cQuery +=        "D2_TIPO='I' AND "
			cQuery +=        "D_E_L_E_T_=' ' "			
			cQuery	:= ChangeQuery(cQuery)                       			
			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAlias,.T.,.T.)   
		Endif
		For nX := 1 To Len(aStru)
			If aStru[nX][2] <> "C" .And. FieldPos(aStru[nX][1])<>0
				TcSetField(cAlias,aStru[nX][1],aStru[nX][2],aStru[nX][3],aStru[nX][4])
			EndIf                                                               		
		Next nX
		dbSelectArea(cAlias)	
	Else
#ENDIF
	cIndex := CriaTrab(NIL,.F.)  
    If !(Alltrim(cAlOri)=="C")
	    cChave := "D1_FILIAL+D1_NFORI+D1_SERIORI+D1_ITEMORI+D1_TIPO"
		cQuery := "D1_FILIAL=='"+xFilial("SD1")+"' .And. "
		cQuery += "D1_FORNECE=='"+SD1->D1_FORNECE+"' .And. "
		cQuery += "D1_LOJA=='"+SD1->D1_LOJA+"' .And. "
		cQuery += "D1_NFORI=='"+SD1->D1_DOC+"' .And. "
		cQuery += "D1_SERIORI=='"+SD1->D1_SERIE+"' .And. "
		cQuery += "D1_ITEMORI=='"+SD1->D1_ITEM+"' .And. "
		cQuery += "D1_TIPO=='I' "
	Else
	    cChave := "D2_FILIAL+D2_NFORI+D2_SERIORI+D2_ITEMORI+D2_TIPO"
		cQuery := "D2_FILIAL=='"+xFilial("SD2")+"' .And. "
		cQuery += "D2_CLIENTE=='"+SD2->D2_CLIENTE+"' .And. "
		cQuery += "D2_LOJA=='"+SD2->D2_LOJA+"' .And. "
		cQuery += "D2_NFORI=='"+SD2->D2_DOC+"' .And. "
		cQuery += "D2_SERIORI=='"+SD2->D2_SERIE+"' .And. "
		cQuery += "D2_ITEMORI=='"+SD2->D2_ITEM+"' .And. "
		cQuery += "D2_TIPO=='I' "
	Endif
    IndRegua(cAlias,cIndex,cChave,,cQuery)
    nIndex := RetIndex(cAlias)
		
	#IFNDEF TOP
		dbSetIndex(cIndex+OrdBagExt())
	#ENDIF    

	If !(Alltrim(cAlOri)=="C")
		dbSelectArea("SD1")
	Else
		dbSelectArea("SD2")
	Endif
	
    dbSetOrder(nIndex+1)
    dbSelectArea(cAlias)
    ProcRegua(LastRec())
   	dbGoTop()
#IFDEF TOP
	Endif                                           
#ENDIF

Do While !(cAlias)->(Eof())
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Se achei a nota de complemento ja       ³
	//³posso voltar para a funcao original     ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	lComplem := .T.	
	Exit
Enddo

If !lQuery
	If !(Alltrim(cAlOri)=="C")
		RetIndex("SD1")
	Else
		RetIndex("SD2")
	Endif
	dbClearFilter()
	Ferase(cIndex+OrdBagExt())
Else
	dbSelectArea(cAlias)
	dbCloseArea()
Endif

RestArea(aArea)

Return(lComplem)

/*/
±±³Fun‡…o    ³MaFisGet³ Autor ³ Edson Maricate          ³ Data ³ 01.02.99 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Funcao utilizada no Pedido de Vendas ( Exclusivamente ) para³±±
±±³          ³criar a referencia do campo no tratamento fiscal.           ³±±
±±³          ³Obs.: nao executa o calculo do imposto, apenas utiliza o    ³±±
±±³          ³      valor informado na preparacao da Nota Fiscal.         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA410,MATA461                                            ³±±
/*/
Static Function MaFisGet(cReferencia)
Return .T.

/*/
±±³Fun‡…o    ³MaFisOrdem³ Autor ³ Edson Maricate        ³ Data ³ 01.02.99 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Retorna a ordem utilizada pela rotina de calculo de impostos³±±
±±³          ³da referencia solicitada.                                   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³MATA461, Esta ordem e utilizada na rotina de Geracao de NF  ³±±
±±³          ³         de Saida permitindo que os impostos informados no  ³±±
±±³          ³         SC6 atraves da Funcao MaFisGet() nao sejam recal-  ³±±
±±³          ³         culados pela Funcao Fiscal.                        ³±±
/*/
Static Function MaFisOrdem(cReferencia)

Local nOrdem := 10000
Local nPos   := 0

If aItemRef == Nil
	MaIniRef()
EndIf

If Substr(cReferencia,1,2) == "IT"
	nPos := aScan( aItemRef , {|x|x[1] == cReferencia } )
	If nPos > 0 .And. aItemRef[nPos][3] <> Nil
		nOrdem := aItemRef[nPos][3]
	EndIf
EndIf

Return nOrdem

/*/
±±³Funcao    ³MaAvalTes³ Autor ³ Edson Maricate         ³ Data ³02.02.2000³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Verifica se o TES pode ser utilizada na operacao.           ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Tipo de movimentacao - E Entrada ou Saida            ³±±
±±³          ³ExpC2: Codigo da TES                                        ³±±
/*/
Static Function MaAvalTes(cOperacao,cTes)

Local lRet := .T.

Do Case
	Case cOperacao == "E"
		If SubStr(cTes,1,1) >= "5" .And. cTES <> "500"
			HELP("   ",1,"INV_TE")
			lRet := .F.
		EndIf
	Case cOperacao == "S"
		If !SubStr(cTes,1,1) >= "5" .Or. cTES == "500"
			HELP("   ",1,"INV_TS")
			lRet := .F.
		EndIf
EndCase

Return lRet

/*/
±±³Fun‡…o    ³MaFisReprocess³ Autor ³ Edson Maricate    ³ Data ³20.05.2000³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Efetua o reprocessamento e gera o livro da Nota Fiscal.     ³±±
/*/
Static Function MaFisReprocess(nOpc)

Local nItem := 	0

DEFAULT nOpc:= 1

If MaFisFound("NF")
	For nItem := 1 to Len(aNfItem)
		If nOpc == 1
			MaFisTes(aNfItem[nItem][IT_TES],aNfItem[nItem][IT_RECNOSF4],nItem)
			MaFisIPI(nItem,"BSE",.T.)
			MaFisBSICM(nItem,.T.)
			MaFisLF(nItem)
		Else
			MaFisRecal(,nItem)
		EndIf
	Next nItem
	MaIt2Cab()
EndIf

Return

/*/
±±³Funcao    ³MaFisRefLd³ Autor ³ Eduardo Riera         ³ Data ³20.08.2003³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Demonstra as referencias dos impostos de uma tabela         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpA1: Array com os impostos no formato:                    ³±±
±±³          ³       [1] Codigo do imposto                                ³±±
±±³          ³       [2] Campo da Base do imposto                         ³±±
±±³          ³       [3] Campo da Aliquota do imposto                     ³±±
±±³          ³       [4] Campo do Valor do imposto                        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Alias do arquivo                                     ³±±
±±³          ³ExpC2: Tipo de Imposto                                      ³±±
±±³          ³       "IT" - Por item                                      ³±±
±±³          ³       "NF" - Por documento                                 ³±±
/*/
Static Function MaFisRefLd(cAlias,cTipo)

Local aArea       := GetArea()
Local aReferencia := MaFisSXRef(cAlias)
Local aImposto    := {}
Local aCodImp     := {}
Local nX          := 0
Local nY          := 0

DEFAULT cTipo := "IT"

aadd(aCodImp,"ICM")
aadd(aCodImp,"IPI")
aadd(aCodImp,"ICA")
aadd(aCodImp,"SOL")
aadd(aCodImp,"CMP")
aadd(aCodImp,"ISS")
aadd(aCodImp,"IRR")
aadd(aCodImp,"INS")
aadd(aCodImp,"COF")
aadd(aCodImp,"CSL")
aadd(aCodImp,"PIS")
aadd(aCodImp,"PS2")
aadd(aCodImp,"CF2")
aadd(aCodImp,"RUR")
aadd(aCodImp,"FET")
aadd(aCodImp,"FAB")
aadd(aCodImp,"FAC")
aadd(aCodImp,"INA")

For nX := 1 To NMAXIV
	aadd(aCodImp,"IV"+StrZero(nX,1))
Next nX
aadd(aCodImp,"PS3")
aadd(aCodImp,"CF3")

For nX := 1 To Len(aCodImp)
	aadd(aImposto,{aCodImp[nX],0,0,0})
	nY := aScan(aReferencia,{|x| x[2]=cTipo+"_BASE"+aCodImp[nX]})
	If nY <> 0
		aImposto[nX][2] := aReferencia[nY][1]
	EndIf
	nY := aScan(aReferencia,{|x| x[2]=cTipo+"_ALIQ"+aCodImp[nX]})
	If nY <> 0
		aImposto[nX][3] := aReferencia[nY][1]
	EndIf
	nY := aScan(aReferencia,{|x| x[2]=cTipo+"_VAL"+aCodImp[nX]})
	If nY <> 0
		aImposto[nX][4] := aReferencia[nY][1]
	EndIf
Next nX
RestArea(aArea)

Return(aImposto)

/*/
±±³Funcao    ³MaFisLdImp³ Autor ³ Eduardo Riera         ³ Data ³20.08.2003³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Demonstra os impostos tratados pelo sistema                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpA1: Array com os impostos no formato:                    ³±±
±±³          ³       [1] Codigo do imposto                                ³±±
/*/
Static Function MaFisLdImp()

Local aCodImp := {}
Local nX      := 0

aadd(aCodImp,"ICM")
aadd(aCodImp,"IPI")
aadd(aCodImp,"ICA")
aadd(aCodImp,"SOL")
aadd(aCodImp,"CMP")
aadd(aCodImp,"ISS")
aadd(aCodImp,"IRR")
aadd(aCodImp,"INS")
aadd(aCodImp,"COF")
aadd(aCodImp,"CSL")
aadd(aCodImp,"PIS")
aadd(aCodImp,"PS2")
aadd(aCodImp,"CF2")
aadd(aCodImp,"RUR")

For nX := 1 To NMAXIV
	aadd(aCodImp,"IV"+StrZero(nX,1))
Next nX

Return(aCodImp)

/*/
±±³Funcao    ³MaFisImpLd³ Autor ³ Eduardo Riera         ³ Data ³11.08.2003³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Carregar os valores de impostos gravados em um arquivo      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpA1: Array com os impostos no formato:                    ³±±
±±³          ³       [1] Codigo do imposto                                ³±±
±±³          ³       [2] Base do imposto                                  ³±±
±±³          ³       [3] Aliquota do imposto                              ³±±
±±³          ³       [4] Valor do imposto                                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Alias do arquivo                                     ³±±
±±³          ³ExpC2: Tipo de Imposto                                      ³±±
±±³          ³       "IT" - Por item                                      ³±±
±±³          ³       "NF" - Por documento                                 ³±±
/*/
Static Function MaFisImpLd(cAlias,cTipo,cCursor)

Local aArea       := GetArea()
Local aReferencia := MaFisSXRef(cAlias)
Local aImposto    := {}
Local aCodImp     := {}
Local nX          := 0
Local nY          := 0

DEFAULT cTipo   := "IT"
DEFAULT cCursor := cAlias

aadd(aCodImp,"ICM")
aadd(aCodImp,"IPI")
aadd(aCodImp,"ICA")
aadd(aCodImp,"SOL")
aadd(aCodImp,"CMP")
aadd(aCodImp,"ISS")
aadd(aCodImp,"IRR")
aadd(aCodImp,"INS")
aadd(aCodImp,"COF")
aadd(aCodImp,"CSL")
aadd(aCodImp,"PIS")
aadd(aCodImp,"PS2")
aadd(aCodImp,"CF2")
aadd(aCodImp,"RUR")
aadd(aCodImp,"FET")
aadd(aCodImp,"FAB")
aadd(aCodImp,"FAC")
aadd(aCodImp,"INA")

For nX := 1 To NMAXIV
	aadd(aCodImp,"IV"+StrZero(nX,1))
Next nX

For nX := 1 To Len(aCodImp)
	aadd(aImposto,{aCodImp[nX],0,0,0})
	nY := aScan(aReferencia,{|x| x[2]=cTipo+"_BASE"+aCodImp[nX]})
	If nY <> 0
		aImposto[nX][2] := (cCursor)->(FieldGet(FieldPos(aReferencia[nY][1])))
	EndIf
	nY := aScan(aReferencia,{|x| x[2]=cTipo+"_ALIQ"+aCodImp[nX]})
	If nY <> 0
		aImposto[nX][3] := (cCursor)->(FieldGet(FieldPos(aReferencia[nY][1])))
	EndIf
	nY := aScan(aReferencia,{|x| x[2]=cTipo+"_VAL"+aCodImp[nX]})
	If nY <> 0
		aImposto[nX][4] := (cCursor)->(FieldGet(FieldPos(aReferencia[nY][1])))
	EndIf
Next nX
nY := 0
For nX := 1 To Len(aImposto)
	If !Empty(aImposto[nX])
		If aImposto[nX][4] == 0
			aImposto := aDel(aImposto,nX)
			nX--
		Else
			nY++
		EndIf
	EndIf
Next nX
aImposto := aSize(aImposto,nY)
RestArea(aArea)

Return(aImposto)

/*/
±±³Programa  ³MAFISCDA  ³ Autor ³ Gustavo G. Rueda      ³ Data ³13/12/2007³±±
±±³Descri‡…o ³Funcao de gravacao/exclusao das informacoes do documento    ³±±
±±³          ³ fiscal referente ao lancamento fiscal da apuracao de icms. ³±±
±±³Parametros³nItem -> Numero do item                                     ³±±
±±³          ³nTipo -> Tipo de processamento da funcao MaFisAjIt          ³±±
±±³          ³lExclui -> Flag de exclusao.                                ³±±
±±³          ³cChaveSF -> Chave para posicionamento do CDA                ³±±
±±³          ³cFormul -> Indicado de formulario proprio                   ³±±
±±³          ³cAlias -> Alias da tabela utilizada para gravar o CDA.      ³±±
/*/
Static Function MaFisCDA(nItem,nTipo,lExclui,cChaveSF,cFormul,cAlias)

Local	aGrava	:=	{}
Local	cTpMov	:=	"S"
Local	lRet	:=	.F.
Local	nI		:=	0

Default	nItem	:=	Nil
Default	lExclui	:=	.F.
Default	cChaveSF:=	SF2->("S"+F2_ESPECIE+"S"+F2_DOC+F2_SERIE+F2_CLIENTE+F2_LOJA)
Default	cFormul	:=	"S"
Default	cAlias	:=	"SF2"

If !aAliIndic[AI_CDA]
	Return lRet
EndIf

cTpMov := Left(cChaveSF,1)

If lExclui	//utilizado pelo reprocessamento
	If CDA->(MsSeek(xFilial("CDA")+cChaveSF))
		While !CDA->(Eof()) .And. xFilial("CDA")+cChaveSF == CDA->(CDA_FILIAL+CDA_TPMOVI+CDA_ESPECI+CDA_FORMUL+CDA_NUMERO+CDA_SERIE+CDA_CLIFOR+CDA_LOJA)
			RecLock("CDA",.F.)
			CDA->(dbDelete())
			MsUnLock()
			CDA->(FkCommit())
			CDA->(dbSkip())
		EndDo
	EndIf
Else
	aGrava	:=	MaFisAjIt(nItem,nTipo)
	
	For nI := 1 To Len(aGrava)
		If CDA->(MsSeek(xFilial("CDA")+cChaveSF+PadR(aGrava[nI,1],TamSx3("CDA_NUMITE")[1])+aGrava[nI,7]))
			RecLock("CDA",.F.)
		Else
			RecLock("CDA",.T.)
			CDA->CDA_FILIAL	:=	xFilial("CDA")
			CDA->CDA_TPMOVI	:=	cTpMov
			CDA->CDA_FORMUL	:=	cFormul
			If cTpMov=="S"
				CDA->CDA_ESPECI	:= (cAlias)->F2_ESPECIE
				CDA->CDA_NUMERO	:= (cAlias)->F2_DOC
				CDA->CDA_SERIE	:= (cAlias)->F2_SERIE
				CDA->CDA_CLIFOR	:= (cAlias)->F2_CLIENTE
				CDA->CDA_LOJA	:= (cAlias)->F2_LOJA
			Else
				CDA->CDA_ESPECI	:= (cAlias)->F1_ESPECIE
				CDA->CDA_NUMERO	:= (cAlias)->F1_DOC
				CDA->CDA_SERIE	:= (cAlias)->F1_SERIE
				CDA->CDA_CLIFOR	:= (cAlias)->F1_FORNECE
				CDA->CDA_LOJA	:= (cAlias)->F1_LOJA
			EndIf
			CDA->CDA_NUMITE	:=	PadR(aGrava[nI,1],TamSx3("CDA_NUMITE")[1])
			CDA->CDA_SEQ	:=	aGrava[nI,7]
		EndIf
		CDA->CDA_CODLAN	:=	aGrava[nI,2]
		CDA->CDA_CALPRO	:=	aGrava[nI,3]
		CDA->CDA_BASE	:=	aGrava[nI,4]
		CDA->CDA_ALIQ	:=	aGrava[nI,5]
		CDA->CDA_VALOR	:=	aGrava[nI,6]
		If aFieldPos[FP_CDA_IFCOMP]
			CDA->CDA_IFCOMP	:= aGrava[nI,8]
		EndIf
		If aFieldPos[FP_CDA_TPLANC]
			CDA->CDA_TPLANC	:= aGrava[nI,9]
		EndIf
		MsUnLock()
		CDA->(FkCommit())
	Next nI
	
	//Tratamento para deletar os registros que nao foram reaproveitados acima no caso de reutilizacao de numeracao de nota
	If CDA->(MsSeek(xFilial("CDA")+cChaveSF))
		While !CDA->(Eof()) .And. CDA->(CDA_FILIAL+CDA_TPMOVI+CDA_ESPECI+CDA_FORMUL+CDA_NUMERO+CDA_SERIE+CDA_CLIFOR+CDA_LOJA) == xFilial("CDA")+cChaveSF
			dbSelectArea("SFT")
			dbSetOrder(1)
			If !MsSeek(xFilial("SFT")+CDA->(CDA_TPMOVI+CDA_SERIE+CDA_NUMERO+CDA_CLIFOR+CDA_LOJA+CDA_NUMITE))
				RecLock("CDA",.F.)
				CDA->(dbDelete())
				MsUnLock()
				CDA->(FkCommit())
			EndIf
			CDA->(dbSkip())
		EndDo
	EndIf
EndIf

Return lRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±³Fun‡…o    ³MaFisIniPC³ Autor ³ Edson Maricate        ³ Data ³20.05.2000³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Inicializa as funcoes Fiscais com o Pedido de Compras      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ MaFisIniPC(ExpC1,ExpC2)                                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpC1 := Numero do Pedido                                  ³±±
±±³          ³ ExpC2 := Item do Pedido                                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATR110,MATR120,Fluxo de Caixa                             ³±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß/*/
Static Function MaFisIniPC(cPedido,cItem,cSequen,cFiltro)

Local aArea		:= GetArea()
Local aAreaSC7	:= SC7->(GetArea())
Local cValid	:= ""
Local nPosRef	:= 0
Local nItem		:= 0
Local cItemDe	:= IIf(cItem==Nil,'',cItem)
Local cItemAte	:= IIf(cItem==Nil,Repl('Z',Len(SC7->C7_ITEM)),cItem)
Local cRefCols	:= ''
DEFAULT cSequen:= ""
DEFAULT cFiltro:= ""

dbSelectArea("SC7")
dbSetOrder(1)
If	MsSeek(xFilial()+cPedido+cItemDe+Alltrim(cSequen))
	MaFisEnd()
	MaFisIni(SC7->C7_FORNECE,SC7->C7_LOJA,"F","N","R",{})
	While !Eof() .AND. SC7->C7_FILIAL+SC7->C7_NUM == xFilial()+cPedido .AND. ;
			SC7->C7_ITEM <= cItemAte .AND. (Empty(cSequen) .OR. cSequen == SC7->C7_SEQUEN)

		// Nao processar os Impostos se o item possuir residuo eliminado  
        If &cFiltro
			dbSelectArea('SC7')
			dbSkip()
            Loop
        EndIf
            
		// Inicia a Carga do item nas funcoes MATXFIS  
		nItem++
		MaFisIniLoad(nItem)
		dbSelectArea("SX3")
		dbSetOrder(1)
		MsSeek('SC7')
		While !EOF() .AND. (X3_ARQUIVO == 'SC7')
			cValid	:= StrTran(UPPER(SX3->X3_VALID)," ","")
			cValid	:= StrTran(cValid,"'",'"')
			If "MAFISREF"$cValid
				nPosRef := AT('MAFISREF("',cValid) + 10
				cRefCols:=Substr(cValid,nPosRef,AT('","MT120",',cValid)-nPosRef )
				// Carrega os valores direto do SC7.           
				MaFisLoad(cRefCols,&("SC7->"+ SX3->X3_CAMPO),nItem)
			EndIf
			dbSkip()
		End
		MaFisEndLoad(nItem,2)
		dbSelectArea('SC7')
		dbSkip()
	End
EndIf

RestArea(aAreaSC7)
RestArea(aArea)

Return .T.
